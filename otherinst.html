
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>Arithmetic and logic instructions &#8212; Tutorial: Creating an LLVM Backend for the Cpu0 Architecture</title>
    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="_static/haiku.css" />
    <link rel="stylesheet" type="text/css" href="_static/graphviz.css" />
    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="_static/doctools.js"></script>
    <link rel="author" title="About these documents" href="about.html" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Generating object files" href="genobj.html" />
    <link rel="prev" title="Backend structure" href="backendstructure.html" /> 
  </head><body>
      <div class="header" role="banner"><h1 class="heading"><a href="index.html">
          <span>Tutorial: Creating an LLVM Backend for the Cpu0 Architecture</span></a></h1>
        <h2 class="heading"><span>Arithmetic and logic instructions</span></h2>
      </div>
      <div class="topnav" role="navigation" aria-label="top navigation">
      
        <p>
        «&#160;&#160;<a href="backendstructure.html">Backend structure</a>
        &#160;&#160;::&#160;&#160;
        <a class="uplink" href="index.html">Contents</a>
        &#160;&#160;::&#160;&#160;
        <a href="genobj.html">Generating object files</a>&#160;&#160;»
        </p>

      </div>
      <div class="content" role="main">
        
        
  <section id="arithmetic-and-logic-instructions">
<span id="sec-addingmoresupport"></span><h1>Arithmetic and logic instructions<a class="headerlink" href="#arithmetic-and-logic-instructions" title="Permalink to this heading">¶</a></h1>
<nav class="contents local" id="contents">
<ul class="simple">
<li><p><a class="reference internal" href="#arithmetic" id="id21">Arithmetic</a></p>
<ul>
<li><p><a class="reference internal" href="#and" id="id22"><strong>+, -, *, &lt;&lt;,</strong> and <strong>&gt;&gt;</strong></a></p></li>
<li><p><a class="reference internal" href="#display-llvm-ir-nodes-with-graphviz" id="id23">Display llvm IR nodes with Graphviz</a></p></li>
<li><p><a class="reference internal" href="#operator-and" id="id24">Operator % and /</a></p>
<ul>
<li><p><a class="reference internal" href="#the-dag-of" id="id25">The DAG of %</a></p></li>
<li><p><a class="reference internal" href="#arm-solution" id="id26">Arm solution</a></p></li>
<li><p><a class="reference internal" href="#mips-solution" id="id27">Mips solution</a></p></li>
<li><p><a class="reference internal" href="#full-support-and" id="id28">Full support %, and /</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#rotate-instructions" id="id29">Rotate instructions</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#logic" id="id30">Logic</a></p></li>
<li><p><a class="reference internal" href="#summary" id="id31">Summary</a></p></li>
</ul>
</nav>
<p>This chapter adds more Cpu0 arithmetic instructions support first.
The <a class="reference external" href="http://jonathan2251.github.io/lbd/otherinst.html#display-llvm-ir-nodes-with-graphviz">section Display llvm IR nodes with Graphviz</a>
will show you the steps of DAG optimization and their corresponding <code class="docutils literal notranslate"><span class="pre">llc</span></code>
display options.
These DAGs translation existed in some steps of optimization can be displayed by
the graphic tool of Graphviz which supply useful information in graphic view.
Logic instructions support will come after arithmetic section.
In spite of that llvm backend handle the IR only, we get the IR from the
corresponding C operators with designed C example code.
Instead of focusing on classes relationship in this backend structure of last
chapter, readers should focus on the mapping of C operators to llvm IR and
how to define the mapping relationship of IR and instructions in td.
HILO and C0 register class are defined in this chapter.
Readers will know how to handle other register classes beside general
purpose register class, and why they are needed, from this chapter.</p>
<section id="arithmetic">
<h2><a class="toc-backref" href="#id21" role="doc-backlink">Arithmetic</a><a class="headerlink" href="#arithmetic" title="Permalink to this heading">¶</a></h2>
<p>The code added in Chapter4_1/ to support arithmetic instructions as follows,</p>
<p class="rubric">lbdex/chapters/Chapter4_1/Cpu0Subtarget.cpp</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">static</span> <span class="n">cl</span><span class="p">::</span><span class="n">opt</span><span class="o">&lt;</span><span class="nb">bool</span><span class="o">&gt;</span> <span class="n">EnableOverflowOpt</span>
                <span class="p">(</span><span class="s2">&quot;cpu0-enable-overflow&quot;</span><span class="p">,</span> <span class="n">cl</span><span class="p">::</span><span class="n">Hidden</span><span class="p">,</span> <span class="n">cl</span><span class="p">::</span><span class="n">init</span><span class="p">(</span><span class="n">false</span><span class="p">),</span>
                 <span class="n">cl</span><span class="p">::</span><span class="n">desc</span><span class="p">(</span><span class="s2">&quot;Use trigger overflow instructions add and sub </span><span class="se">\</span>
<span class="s2">                 instead of non-overflow instructions addu and subu&quot;</span><span class="p">));</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Cpu0Subtarget</span><span class="p">::</span><span class="n">Cpu0Subtarget</span><span class="p">(</span><span class="n">const</span> <span class="n">Triple</span> <span class="o">&amp;</span><span class="n">TT</span><span class="p">,</span> <span class="n">StringRef</span> <span class="n">CPU</span><span class="p">,</span>
                             <span class="n">StringRef</span> <span class="n">FS</span><span class="p">,</span> <span class="nb">bool</span> <span class="n">little</span><span class="p">,</span> 
                             <span class="n">const</span> <span class="n">Cpu0TargetMachine</span> <span class="o">&amp;</span><span class="n">_TM</span><span class="p">)</span> <span class="p">:</span>
</pre></div>
</div>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="p">...</span><span class="w"></span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>  <span class="n">EnableOverflow</span> <span class="o">=</span> <span class="n">EnableOverflowOpt</span><span class="p">;</span>
</pre></div>
</div>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="p">...</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter4_1/Cpu0InstrInfo.td</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//</span> <span class="n">Only</span> <span class="n">op</span> <span class="n">DAG</span> <span class="n">can</span> <span class="n">be</span> <span class="n">disabled</span> <span class="n">by</span> <span class="n">ch4_1</span><span class="p">,</span> <span class="n">data</span> <span class="n">DAG</span> <span class="n">cannot</span><span class="o">.</span>
<span class="k">def</span> <span class="nf">SDT_Cpu0DivRem</span>       <span class="p">:</span> <span class="n">SDTypeProfile</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span>
                                         <span class="p">[</span><span class="n">SDTCisInt</span><span class="o">&lt;</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span>
                                          <span class="n">SDTCisSameAs</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="o">&gt;</span><span class="p">]</span><span class="o">&gt;</span><span class="p">;</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//</span> <span class="n">DivRem</span><span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="n">nodes</span>
<span class="k">def</span> <span class="nf">Cpu0DivRem</span>    <span class="p">:</span> <span class="n">SDNode</span><span class="o">&lt;</span><span class="s2">&quot;Cpu0ISD::DivRem&quot;</span><span class="p">,</span> <span class="n">SDT_Cpu0DivRem</span><span class="p">,</span>
                           <span class="p">[</span><span class="n">SDNPOutGlue</span><span class="p">]</span><span class="o">&gt;</span><span class="p">;</span>
<span class="k">def</span> <span class="nf">Cpu0DivRemU</span>   <span class="p">:</span> <span class="n">SDNode</span><span class="o">&lt;</span><span class="s2">&quot;Cpu0ISD::DivRemU&quot;</span><span class="p">,</span> <span class="n">SDT_Cpu0DivRem</span><span class="p">,</span>
                           <span class="p">[</span><span class="n">SDNPOutGlue</span><span class="p">]</span><span class="o">&gt;</span><span class="p">;</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>let Predicates = [Ch4_1] in {
class shift_rotate_reg&lt;bits&lt;8&gt; op, bits&lt;4&gt; isRotate, string instr_asm,
                       SDNode OpNode, RegisterClass RC&gt;:
  FA&lt;op, (outs GPROut:$ra), (ins RC:$rb, RC:$rc),
     !strconcat(instr_asm, &quot;\t$ra, $rb, $rc&quot;),
     [(set GPROut:$ra, (OpNode RC:$rb, RC:$rc))], IIAlu&gt; {
  let shamt = 0;
}
}
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>let Predicates = [Ch4_1] in {
// Mul, Div
class Mult&lt;bits&lt;8&gt; op, string instr_asm, InstrItinClass itin,
           RegisterClass RC, list&lt;Register&gt; DefRegs&gt;:
  FA&lt;op, (outs), (ins RC:$ra, RC:$rb),
     !strconcat(instr_asm, &quot;\t$ra, $rb&quot;), [], itin&gt; {
  let rc = 0;
  let shamt = 0;
  let isCommutable = 1;
  let Defs = DefRegs;
  let hasSideEffects = 0;
}

class Mult32&lt;bits&lt;8&gt; op, string instr_asm, InstrItinClass itin&gt;:
  Mult&lt;op, instr_asm, itin, CPURegs, [HI, LO]&gt;;

class Div&lt;SDNode opNode, bits&lt;8&gt; op, string instr_asm, InstrItinClass itin,
          RegisterClass RC, list&lt;Register&gt; DefRegs&gt;:
  FA&lt;op, (outs), (ins RC:$ra, RC:$rb),
     !strconcat(instr_asm, &quot;\t$ra, $rb&quot;),
     [(opNode RC:$ra, RC:$rb)], itin&gt; {
  let rc = 0;
  let shamt = 0;
  let Defs = DefRegs;
}

class Div32&lt;SDNode opNode, bits&lt;8&gt; op, string instr_asm, InstrItinClass itin&gt;:
  Div&lt;opNode, op, instr_asm, itin, CPURegs, [HI, LO]&gt;;

// Move from Lo/Hi
class MoveFromLOHI&lt;bits&lt;8&gt; op, string instr_asm, RegisterClass RC,
                   list&lt;Register&gt; UseRegs&gt;:
  FA&lt;op, (outs RC:$ra), (ins),
     !strconcat(instr_asm, &quot;\t$ra&quot;), [], IIHiLo&gt; {
  let rb = 0;
  let rc = 0;
  let shamt = 0;
  let Uses = UseRegs;
  let hasSideEffects = 0;
}

// Move to Lo/Hi
class MoveToLOHI&lt;bits&lt;8&gt; op, string instr_asm, RegisterClass RC,
                 list&lt;Register&gt; DefRegs&gt;:
  FA&lt;op, (outs), (ins RC:$ra),
     !strconcat(instr_asm, &quot;\t$ra&quot;), [], IIHiLo&gt; {
  let rb = 0;
  let rc = 0;
  let shamt = 0;
  let Defs = DefRegs;
  let hasSideEffects = 0;
}

// Move from C0 (co-processor 0) Register
class MoveFromC0&lt;bits&lt;8&gt; op, string instr_asm, RegisterClass RC&gt;:
  FA&lt;op, (outs), (ins RC:$ra, C0Regs:$rb),
     !strconcat(instr_asm, &quot;\t$ra, $rb&quot;), [], IIAlu&gt; {
  let rc = 0;
  let shamt = 0;
  let hasSideEffects = 0;
}

// Move to C0 Register
class MoveToC0&lt;bits&lt;8&gt; op, string instr_asm, RegisterClass RC&gt;:
  FA&lt;op, (outs C0Regs:$ra), (ins RC:$rb),
     !strconcat(instr_asm, &quot;\t$ra, $rb&quot;), [], IIAlu&gt; {
  let rc = 0;
  let shamt = 0;
  let hasSideEffects = 0;
}

// Move from C0 register to C0 register
class C0Move&lt;bits&lt;8&gt; op, string instr_asm&gt;:
  FA&lt;op, (outs C0Regs:$ra), (ins C0Regs:$rb),
     !strconcat(instr_asm, &quot;\t$ra, $rb&quot;), [], IIAlu&gt; {
  let rc = 0;
  let shamt = 0;
  let hasSideEffects = 0;
}
} // let Predicates = [Ch4_1]
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">let</span> <span class="n">Predicates</span> <span class="o">=</span> <span class="p">[</span><span class="n">Ch4_1</span><span class="p">]</span> <span class="ow">in</span> <span class="p">{</span>
<span class="n">let</span> <span class="n">Predicates</span> <span class="o">=</span> <span class="p">[</span><span class="n">DisableOverflow</span><span class="p">]</span> <span class="ow">in</span> <span class="p">{</span>
<span class="k">def</span> <span class="nf">SUBu</span>    <span class="p">:</span> <span class="n">ArithLogicR</span><span class="o">&lt;</span><span class="mh">0x12</span><span class="p">,</span> <span class="s2">&quot;subu&quot;</span><span class="p">,</span> <span class="n">sub</span><span class="p">,</span> <span class="n">IIAlu</span><span class="p">,</span> <span class="n">CPURegs</span><span class="o">&gt;</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">let</span> <span class="n">Predicates</span> <span class="o">=</span> <span class="p">[</span><span class="n">EnableOverflow</span><span class="p">]</span> <span class="ow">in</span> <span class="p">{</span>
<span class="k">def</span> <span class="nf">ADD</span>     <span class="p">:</span> <span class="n">ArithLogicR</span><span class="o">&lt;</span><span class="mh">0x13</span><span class="p">,</span> <span class="s2">&quot;add&quot;</span><span class="p">,</span> <span class="n">add</span><span class="p">,</span> <span class="n">IIAlu</span><span class="p">,</span> <span class="n">CPURegs</span><span class="p">,</span> <span class="mi">1</span><span class="o">&gt;</span><span class="p">;</span>
<span class="k">def</span> <span class="nf">SUB</span>     <span class="p">:</span> <span class="n">ArithLogicR</span><span class="o">&lt;</span><span class="mh">0x14</span><span class="p">,</span> <span class="s2">&quot;sub&quot;</span><span class="p">,</span> <span class="n">sub</span><span class="p">,</span> <span class="n">IIAlu</span><span class="p">,</span> <span class="n">CPURegs</span><span class="o">&gt;</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">def</span> <span class="nf">MUL</span>     <span class="p">:</span> <span class="n">ArithLogicR</span><span class="o">&lt;</span><span class="mh">0x17</span><span class="p">,</span> <span class="s2">&quot;mul&quot;</span><span class="p">,</span> <span class="n">mul</span><span class="p">,</span> <span class="n">IIImul</span><span class="p">,</span> <span class="n">CPURegs</span><span class="p">,</span> <span class="mi">1</span><span class="o">&gt;</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">let</span> <span class="n">Predicates</span> <span class="o">=</span> <span class="p">[</span><span class="n">Ch4_1</span><span class="p">]</span> <span class="ow">in</span> <span class="p">{</span>
<span class="o">//</span> <span class="n">sra</span> <span class="ow">is</span> <span class="n">IR</span> <span class="n">node</span> <span class="k">for</span> <span class="n">ashr</span> <span class="n">llvm</span> <span class="n">IR</span> <span class="n">instruction</span> <span class="n">of</span> <span class="o">.</span><span class="n">bc</span>
<span class="k">def</span> <span class="nf">ROL</span>     <span class="p">:</span> <span class="n">shift_rotate_imm32</span><span class="o">&lt;</span><span class="mh">0x1c</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="s2">&quot;rol&quot;</span><span class="p">,</span> <span class="n">rotl</span><span class="o">&gt;</span><span class="p">;</span>
<span class="k">def</span> <span class="nf">ROR</span>     <span class="p">:</span> <span class="n">shift_rotate_imm32</span><span class="o">&lt;</span><span class="mh">0x1d</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="s2">&quot;ror&quot;</span><span class="p">,</span> <span class="n">rotr</span><span class="o">&gt;</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">let</span> <span class="n">Predicates</span> <span class="o">=</span> <span class="p">[</span><span class="n">Ch4_1</span><span class="p">]</span> <span class="ow">in</span> <span class="p">{</span>
<span class="o">//</span> <span class="n">srl</span> <span class="ow">is</span> <span class="n">IR</span> <span class="n">node</span> <span class="k">for</span> <span class="n">lshr</span> <span class="n">llvm</span> <span class="n">IR</span> <span class="n">instruction</span> <span class="n">of</span> <span class="o">.</span><span class="n">bc</span>
<span class="k">def</span> <span class="nf">SHR</span>     <span class="p">:</span> <span class="n">shift_rotate_imm32</span><span class="o">&lt;</span><span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="s2">&quot;shr&quot;</span><span class="p">,</span> <span class="n">srl</span><span class="o">&gt;</span><span class="p">;</span>
<span class="k">def</span> <span class="nf">SRA</span>     <span class="p">:</span> <span class="n">shift_rotate_imm32</span><span class="o">&lt;</span><span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="s2">&quot;sra&quot;</span><span class="p">,</span> <span class="n">sra</span><span class="o">&gt;</span><span class="p">;</span>
<span class="k">def</span> <span class="nf">SRAV</span>    <span class="p">:</span> <span class="n">shift_rotate_reg</span><span class="o">&lt;</span><span class="mh">0x21</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="s2">&quot;srav&quot;</span><span class="p">,</span> <span class="n">sra</span><span class="p">,</span> <span class="n">CPURegs</span><span class="o">&gt;</span><span class="p">;</span>
<span class="k">def</span> <span class="nf">SHLV</span>    <span class="p">:</span> <span class="n">shift_rotate_reg</span><span class="o">&lt;</span><span class="mh">0x22</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="s2">&quot;shlv&quot;</span><span class="p">,</span> <span class="n">shl</span><span class="p">,</span> <span class="n">CPURegs</span><span class="o">&gt;</span><span class="p">;</span>
<span class="k">def</span> <span class="nf">SHRV</span>    <span class="p">:</span> <span class="n">shift_rotate_reg</span><span class="o">&lt;</span><span class="mh">0x23</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="s2">&quot;shrv&quot;</span><span class="p">,</span> <span class="n">srl</span><span class="p">,</span> <span class="n">CPURegs</span><span class="o">&gt;</span><span class="p">;</span>
<span class="k">def</span> <span class="nf">ROLV</span>    <span class="p">:</span> <span class="n">shift_rotate_reg</span><span class="o">&lt;</span><span class="mh">0x24</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="s2">&quot;rolv&quot;</span><span class="p">,</span> <span class="n">rotl</span><span class="p">,</span> <span class="n">CPURegs</span><span class="o">&gt;</span><span class="p">;</span>
<span class="k">def</span> <span class="nf">RORV</span>    <span class="p">:</span> <span class="n">shift_rotate_reg</span><span class="o">&lt;</span><span class="mh">0x25</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="s2">&quot;rorv&quot;</span><span class="p">,</span> <span class="n">rotr</span><span class="p">,</span> <span class="n">CPURegs</span><span class="o">&gt;</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">let</span> <span class="n">Predicates</span> <span class="o">=</span> <span class="p">[</span><span class="n">Ch4_1</span><span class="p">]</span> <span class="ow">in</span> <span class="p">{</span>
<span class="o">///</span> <span class="n">Multiply</span> <span class="ow">and</span> <span class="n">Divide</span> <span class="n">Instructions</span><span class="o">.</span>
<span class="k">def</span> <span class="nf">MULT</span>    <span class="p">:</span> <span class="n">Mult32</span><span class="o">&lt;</span><span class="mh">0x41</span><span class="p">,</span> <span class="s2">&quot;mult&quot;</span><span class="p">,</span> <span class="n">IIImul</span><span class="o">&gt;</span><span class="p">;</span>
<span class="k">def</span> <span class="nf">MULTu</span>   <span class="p">:</span> <span class="n">Mult32</span><span class="o">&lt;</span><span class="mh">0x42</span><span class="p">,</span> <span class="s2">&quot;multu&quot;</span><span class="p">,</span> <span class="n">IIImul</span><span class="o">&gt;</span><span class="p">;</span>
<span class="k">def</span> <span class="nf">SDIV</span>    <span class="p">:</span> <span class="n">Div32</span><span class="o">&lt;</span><span class="n">Cpu0DivRem</span><span class="p">,</span> <span class="mh">0x43</span><span class="p">,</span> <span class="s2">&quot;div&quot;</span><span class="p">,</span> <span class="n">IIIdiv</span><span class="o">&gt;</span><span class="p">;</span>
<span class="k">def</span> <span class="nf">UDIV</span>    <span class="p">:</span> <span class="n">Div32</span><span class="o">&lt;</span><span class="n">Cpu0DivRemU</span><span class="p">,</span> <span class="mh">0x44</span><span class="p">,</span> <span class="s2">&quot;divu&quot;</span><span class="p">,</span> <span class="n">IIIdiv</span><span class="o">&gt;</span><span class="p">;</span>

<span class="k">def</span> <span class="nf">MFHI</span>    <span class="p">:</span> <span class="n">MoveFromLOHI</span><span class="o">&lt;</span><span class="mh">0x46</span><span class="p">,</span> <span class="s2">&quot;mfhi&quot;</span><span class="p">,</span> <span class="n">CPURegs</span><span class="p">,</span> <span class="p">[</span><span class="n">HI</span><span class="p">]</span><span class="o">&gt;</span><span class="p">;</span>
<span class="k">def</span> <span class="nf">MFLO</span>    <span class="p">:</span> <span class="n">MoveFromLOHI</span><span class="o">&lt;</span><span class="mh">0x47</span><span class="p">,</span> <span class="s2">&quot;mflo&quot;</span><span class="p">,</span> <span class="n">CPURegs</span><span class="p">,</span> <span class="p">[</span><span class="n">LO</span><span class="p">]</span><span class="o">&gt;</span><span class="p">;</span>
<span class="k">def</span> <span class="nf">MTHI</span>    <span class="p">:</span> <span class="n">MoveToLOHI</span><span class="o">&lt;</span><span class="mh">0x48</span><span class="p">,</span> <span class="s2">&quot;mthi&quot;</span><span class="p">,</span> <span class="n">CPURegs</span><span class="p">,</span> <span class="p">[</span><span class="n">HI</span><span class="p">]</span><span class="o">&gt;</span><span class="p">;</span>
<span class="k">def</span> <span class="nf">MTLO</span>    <span class="p">:</span> <span class="n">MoveToLOHI</span><span class="o">&lt;</span><span class="mh">0x49</span><span class="p">,</span> <span class="s2">&quot;mtlo&quot;</span><span class="p">,</span> <span class="n">CPURegs</span><span class="p">,</span> <span class="p">[</span><span class="n">LO</span><span class="p">]</span><span class="o">&gt;</span><span class="p">;</span>

<span class="k">def</span> <span class="nf">MFC0</span>    <span class="p">:</span> <span class="n">MoveFromC0</span><span class="o">&lt;</span><span class="mh">0x50</span><span class="p">,</span> <span class="s2">&quot;mfc0&quot;</span><span class="p">,</span> <span class="n">CPURegs</span><span class="o">&gt;</span><span class="p">;</span>
<span class="k">def</span> <span class="nf">MTC0</span>    <span class="p">:</span> <span class="n">MoveToC0</span><span class="o">&lt;</span><span class="mh">0x51</span><span class="p">,</span> <span class="s2">&quot;mtc0&quot;</span><span class="p">,</span> <span class="n">CPURegs</span><span class="o">&gt;</span><span class="p">;</span>

<span class="k">def</span> <span class="nf">C0MOVE</span>  <span class="p">:</span> <span class="n">C0Move</span><span class="o">&lt;</span><span class="mh">0x52</span><span class="p">,</span> <span class="s2">&quot;c0mov&quot;</span><span class="o">&gt;</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter4_1/Cpu0ISelLowering.h</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>    <span class="n">SDValue</span> <span class="n">PerformDAGCombine</span><span class="p">(</span><span class="n">SDNode</span> <span class="o">*</span><span class="n">N</span><span class="p">,</span> <span class="n">DAGCombinerInfo</span> <span class="o">&amp;</span><span class="n">DCI</span><span class="p">)</span> <span class="n">const</span> <span class="n">override</span><span class="p">;</span>
</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter4_1/Cpu0ISelLowering.cpp</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Cpu0TargetLowering</span><span class="p">::</span><span class="n">Cpu0TargetLowering</span><span class="p">(</span><span class="n">const</span> <span class="n">Cpu0TargetMachine</span> <span class="o">&amp;</span><span class="n">TM</span><span class="p">,</span>
                                       <span class="n">const</span> <span class="n">Cpu0Subtarget</span> <span class="o">&amp;</span><span class="n">STI</span><span class="p">)</span>
    <span class="p">:</span> <span class="n">TargetLowering</span><span class="p">(</span><span class="n">TM</span><span class="p">),</span> <span class="n">Subtarget</span><span class="p">(</span><span class="n">STI</span><span class="p">),</span> <span class="n">ABI</span><span class="p">(</span><span class="n">TM</span><span class="o">.</span><span class="n">getABI</span><span class="p">())</span> <span class="p">{</span>

</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>  <span class="n">setOperationAction</span><span class="p">(</span><span class="n">ISD</span><span class="p">::</span><span class="n">SDIV</span><span class="p">,</span> <span class="n">MVT</span><span class="p">::</span><span class="n">i32</span><span class="p">,</span> <span class="n">Expand</span><span class="p">);</span>
  <span class="n">setOperationAction</span><span class="p">(</span><span class="n">ISD</span><span class="p">::</span><span class="n">SREM</span><span class="p">,</span> <span class="n">MVT</span><span class="p">::</span><span class="n">i32</span><span class="p">,</span> <span class="n">Expand</span><span class="p">);</span>
  <span class="n">setOperationAction</span><span class="p">(</span><span class="n">ISD</span><span class="p">::</span><span class="n">UDIV</span><span class="p">,</span> <span class="n">MVT</span><span class="p">::</span><span class="n">i32</span><span class="p">,</span> <span class="n">Expand</span><span class="p">);</span>
  <span class="n">setOperationAction</span><span class="p">(</span><span class="n">ISD</span><span class="p">::</span><span class="n">UREM</span><span class="p">,</span> <span class="n">MVT</span><span class="p">::</span><span class="n">i32</span><span class="p">,</span> <span class="n">Expand</span><span class="p">);</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>  <span class="n">setTargetDAGCombine</span><span class="p">(</span><span class="n">ISD</span><span class="p">::</span><span class="n">SDIVREM</span><span class="p">);</span>
  <span class="n">setTargetDAGCombine</span><span class="p">(</span><span class="n">ISD</span><span class="p">::</span><span class="n">UDIVREM</span><span class="p">);</span>
</pre></div>
</div>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="p">...</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="p">...</span><span class="w"></span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>static SDValue performDivRemCombine(SDNode *N, SelectionDAG&amp; DAG,
                                    TargetLowering::DAGCombinerInfo &amp;DCI,
                                    const Cpu0Subtarget &amp;Subtarget) {
  if (DCI.isBeforeLegalizeOps())
    return SDValue();

  EVT Ty = N-&gt;getValueType(0);
  unsigned LO = Cpu0::LO;
  unsigned HI = Cpu0::HI;
  unsigned Opc = N-&gt;getOpcode() == ISD::SDIVREM ? Cpu0ISD::DivRem :
                                                  Cpu0ISD::DivRemU;
  SDLoc DL(N);

  SDValue DivRem = DAG.getNode(Opc, DL, MVT::Glue,
                               N-&gt;getOperand(0), N-&gt;getOperand(1));
  SDValue InChain = DAG.getEntryNode();
  SDValue InGlue = DivRem;

  // insert MFLO
  if (N-&gt;hasAnyUseOfValue(0)) {
    SDValue CopyFromLo = DAG.getCopyFromReg(InChain, DL, LO, Ty,
                                            InGlue);
    DAG.ReplaceAllUsesOfValueWith(SDValue(N, 0), CopyFromLo);
    InChain = CopyFromLo.getValue(1);
    InGlue = CopyFromLo.getValue(2);
  }

  // insert MFHI
  if (N-&gt;hasAnyUseOfValue(1)) {
    SDValue CopyFromHi = DAG.getCopyFromReg(InChain, DL,
                                            HI, Ty, InGlue);
    DAG.ReplaceAllUsesOfValueWith(SDValue(N, 1), CopyFromHi);
  }

  return SDValue();
}

SDValue Cpu0TargetLowering::PerformDAGCombine(SDNode *N, DAGCombinerInfo &amp;DCI)
  const {
  SelectionDAG &amp;DAG = DCI.DAG;
  unsigned Opc = N-&gt;getOpcode();

  switch (Opc) {
  default: break;
  case ISD::SDIVREM:
  case ISD::UDIVREM:
    return performDivRemCombine(N, DAG, DCI, Subtarget);
  }

  return SDValue();
}
</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter4_1/Cpu0RegisterInfo.td</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">let</span> <span class="n">Namespace</span> <span class="o">=</span> <span class="s2">&quot;Cpu0&quot;</span> <span class="ow">in</span> <span class="p">{</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>  <span class="o">//</span> <span class="n">Hi</span><span class="o">/</span><span class="n">Lo</span> <span class="n">registers</span> <span class="n">number</span> <span class="ow">and</span> <span class="n">name</span>
  <span class="k">def</span> <span class="nf">HI</span>   <span class="p">:</span> <span class="n">Cpu0Reg</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;ac0&quot;</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">DwarfRegNum</span><span class="o">&lt;</span><span class="p">[</span><span class="mi">18</span><span class="p">]</span><span class="o">&gt;</span><span class="p">;</span>
  <span class="k">def</span> <span class="nf">LO</span>   <span class="p">:</span> <span class="n">Cpu0Reg</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;ac0&quot;</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">DwarfRegNum</span><span class="o">&lt;</span><span class="p">[</span><span class="mi">19</span><span class="p">]</span><span class="o">&gt;</span><span class="p">;</span>
</pre></div>
</div>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="p">}</span><span class="w"></span>
<span class="p">...</span><span class="w"></span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//</span> <span class="n">Hi</span><span class="o">/</span><span class="n">Lo</span> <span class="n">Registers</span> <span class="k">class</span>
<span class="nc">def</span> <span class="n">HILO</span>   <span class="p">:</span> <span class="n">RegisterClass</span><span class="o">&lt;</span><span class="s2">&quot;Cpu0&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">i32</span><span class="p">],</span> <span class="mi">32</span><span class="p">,</span> <span class="p">(</span><span class="n">add</span> <span class="n">HI</span><span class="p">,</span> <span class="n">LO</span><span class="p">)</span><span class="o">&gt;</span><span class="p">;</span>
</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter4_1/Cpu0Schedule.td</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">IIHiLo</span>             <span class="p">:</span> <span class="n">InstrItinClass</span><span class="p">;</span>
<span class="k">def</span> <span class="nf">IIImul</span>             <span class="p">:</span> <span class="n">InstrItinClass</span><span class="p">;</span>
<span class="k">def</span> <span class="nf">IIIdiv</span>             <span class="p">:</span> <span class="n">InstrItinClass</span><span class="p">;</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">Cpu0GenericItineraries</span> <span class="p">:</span> <span class="n">ProcessorItineraries</span><span class="o">&lt;</span><span class="p">[</span><span class="n">ALU</span><span class="p">,</span> <span class="n">IMULDIV</span><span class="p">],</span> <span class="p">[],</span> <span class="p">[</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>  <span class="n">InstrItinData</span><span class="o">&lt;</span><span class="n">IIHiLo</span>             <span class="p">,</span> <span class="p">[</span><span class="n">InstrStage</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">,</span>  <span class="p">[</span><span class="n">IMULDIV</span><span class="p">]</span><span class="o">&gt;</span><span class="p">]</span><span class="o">&gt;</span><span class="p">,</span>
  <span class="n">InstrItinData</span><span class="o">&lt;</span><span class="n">IIImul</span>             <span class="p">,</span> <span class="p">[</span><span class="n">InstrStage</span><span class="o">&lt;</span><span class="mi">17</span><span class="p">,</span> <span class="p">[</span><span class="n">IMULDIV</span><span class="p">]</span><span class="o">&gt;</span><span class="p">]</span><span class="o">&gt;</span><span class="p">,</span>
  <span class="n">InstrItinData</span><span class="o">&lt;</span><span class="n">IIIdiv</span>             <span class="p">,</span> <span class="p">[</span><span class="n">InstrStage</span><span class="o">&lt;</span><span class="mi">38</span><span class="p">,</span> <span class="p">[</span><span class="n">IMULDIV</span><span class="p">]</span><span class="o">&gt;</span><span class="p">]</span><span class="o">&gt;</span><span class="p">,</span>
</pre></div>
</div>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="p">]</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>
</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter4_1/Cpu0SEISelDAGToDAG.h</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>  <span class="n">std</span><span class="p">::</span><span class="n">pair</span><span class="o">&lt;</span><span class="n">SDNode</span> <span class="o">*</span><span class="p">,</span> <span class="n">SDNode</span> <span class="o">*&gt;</span> <span class="n">selectMULT</span><span class="p">(</span><span class="n">SDNode</span> <span class="o">*</span><span class="n">N</span><span class="p">,</span> <span class="n">unsigned</span> <span class="n">Opc</span><span class="p">,</span>
                                           <span class="n">const</span> <span class="n">SDLoc</span> <span class="o">&amp;</span><span class="n">DL</span><span class="p">,</span> <span class="n">EVT</span> <span class="n">Ty</span><span class="p">,</span> <span class="nb">bool</span> <span class="n">HasLo</span><span class="p">,</span>
                                           <span class="nb">bool</span> <span class="n">HasHi</span><span class="p">);</span>
</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter4_1/Cpu0SEISelDAGToDAG.cpp</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">///</span> <span class="n">Select</span> <span class="n">multiply</span> <span class="n">instructions</span><span class="o">.</span>
<span class="n">std</span><span class="p">::</span><span class="n">pair</span><span class="o">&lt;</span><span class="n">SDNode</span> <span class="o">*</span><span class="p">,</span> <span class="n">SDNode</span> <span class="o">*&gt;</span>
<span class="n">Cpu0SEDAGToDAGISel</span><span class="p">::</span><span class="n">selectMULT</span><span class="p">(</span><span class="n">SDNode</span> <span class="o">*</span><span class="n">N</span><span class="p">,</span> <span class="n">unsigned</span> <span class="n">Opc</span><span class="p">,</span> <span class="n">const</span> <span class="n">SDLoc</span> <span class="o">&amp;</span><span class="n">DL</span><span class="p">,</span> <span class="n">EVT</span> <span class="n">Ty</span><span class="p">,</span>
                             <span class="nb">bool</span> <span class="n">HasLo</span><span class="p">,</span> <span class="nb">bool</span> <span class="n">HasHi</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">SDNode</span> <span class="o">*</span><span class="n">Lo</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="o">*</span><span class="n">Hi</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">SDNode</span> <span class="o">*</span><span class="n">Mul</span> <span class="o">=</span> <span class="n">CurDAG</span><span class="o">-&gt;</span><span class="n">getMachineNode</span><span class="p">(</span><span class="n">Opc</span><span class="p">,</span> <span class="n">DL</span><span class="p">,</span> <span class="n">MVT</span><span class="p">::</span><span class="n">Glue</span><span class="p">,</span> <span class="n">N</span><span class="o">-&gt;</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
                                       <span class="n">N</span><span class="o">-&gt;</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span>
  <span class="n">SDValue</span> <span class="n">InFlag</span> <span class="o">=</span> <span class="n">SDValue</span><span class="p">(</span><span class="n">Mul</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">HasLo</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">Lo</span> <span class="o">=</span> <span class="n">CurDAG</span><span class="o">-&gt;</span><span class="n">getMachineNode</span><span class="p">(</span><span class="n">Cpu0</span><span class="p">::</span><span class="n">MFLO</span><span class="p">,</span> <span class="n">DL</span><span class="p">,</span>
                                <span class="n">Ty</span><span class="p">,</span> <span class="n">MVT</span><span class="p">::</span><span class="n">Glue</span><span class="p">,</span> <span class="n">InFlag</span><span class="p">);</span>
    <span class="n">InFlag</span> <span class="o">=</span> <span class="n">SDValue</span><span class="p">(</span><span class="n">Lo</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">HasHi</span><span class="p">)</span>
    <span class="n">Hi</span> <span class="o">=</span> <span class="n">CurDAG</span><span class="o">-&gt;</span><span class="n">getMachineNode</span><span class="p">(</span><span class="n">Cpu0</span><span class="p">::</span><span class="n">MFHI</span><span class="p">,</span> <span class="n">DL</span><span class="p">,</span>
                                <span class="n">Ty</span><span class="p">,</span> <span class="n">InFlag</span><span class="p">);</span>

  <span class="k">return</span> <span class="n">std</span><span class="p">::</span><span class="n">make_pair</span><span class="p">(</span><span class="n">Lo</span><span class="p">,</span> <span class="n">Hi</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">bool</span> <span class="n">Cpu0SEDAGToDAGISel</span><span class="p">::</span><span class="n">trySelect</span><span class="p">(</span><span class="n">SDNode</span> <span class="o">*</span><span class="n">Node</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">unsigned</span> <span class="n">Opcode</span> <span class="o">=</span> <span class="n">Node</span><span class="o">-&gt;</span><span class="n">getOpcode</span><span class="p">();</span>
  <span class="n">SDLoc</span> <span class="n">DL</span><span class="p">(</span><span class="n">Node</span><span class="p">);</span>

  <span class="o">///</span>
  <span class="o">//</span> <span class="n">Instruction</span> <span class="n">Selection</span> <span class="ow">not</span> <span class="n">handled</span> <span class="n">by</span> <span class="n">the</span> <span class="n">auto</span><span class="o">-</span><span class="n">generated</span>
  <span class="o">//</span> <span class="n">tablegen</span> <span class="n">selection</span> <span class="n">should</span> <span class="n">be</span> <span class="n">handled</span> <span class="n">here</span><span class="o">.</span>
  <span class="o">///</span>

  <span class="o">///</span>
  <span class="o">//</span> <span class="n">Instruction</span> <span class="n">Selection</span> <span class="ow">not</span> <span class="n">handled</span> <span class="n">by</span> <span class="n">the</span> <span class="n">auto</span><span class="o">-</span><span class="n">generated</span>
  <span class="o">//</span> <span class="n">tablegen</span> <span class="n">selection</span> <span class="n">should</span> <span class="n">be</span> <span class="n">handled</span> <span class="n">here</span><span class="o">.</span>
  <span class="o">///</span>
  <span class="n">EVT</span> <span class="n">NodeTy</span> <span class="o">=</span> <span class="n">Node</span><span class="o">-&gt;</span><span class="n">getValueType</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
  <span class="n">unsigned</span> <span class="n">MultOpc</span><span class="p">;</span>

  <span class="n">switch</span><span class="p">(</span><span class="n">Opcode</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">default</span><span class="p">:</span> <span class="k">break</span><span class="p">;</span>

</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>  case ISD::MULHS:
  case ISD::MULHU: {
    MultOpc = (Opcode == ISD::MULHU ? Cpu0::MULTu : Cpu0::MULT);
    auto LoHi = selectMULT(Node, MultOpc, DL, NodeTy, false, true);
    ReplaceNode(Node, LoHi.second);
    return true;
  }

  case ISD::Constant: {
    const ConstantSDNode *CN = dyn_cast&lt;ConstantSDNode&gt;(Node);
    unsigned Size = CN-&gt;getValueSizeInBits(0);

    if (Size == 32)
      break;

    return true;
  }
</pre></div>
</div>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">...</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter4_1/Cpu0SEInstrInfo.h</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>  <span class="n">void</span> <span class="n">copyPhysReg</span><span class="p">(</span><span class="n">MachineBasicBlock</span> <span class="o">&amp;</span><span class="n">MBB</span><span class="p">,</span> <span class="n">MachineBasicBlock</span><span class="p">::</span><span class="n">iterator</span> <span class="n">MI</span><span class="p">,</span>
                   <span class="n">const</span> <span class="n">DebugLoc</span> <span class="o">&amp;</span><span class="n">DL</span><span class="p">,</span> <span class="n">MCRegister</span> <span class="n">DestReg</span><span class="p">,</span> <span class="n">MCRegister</span> <span class="n">SrcReg</span><span class="p">,</span>
                   <span class="nb">bool</span> <span class="n">KillSrc</span><span class="p">)</span> <span class="n">const</span> <span class="n">override</span><span class="p">;</span>
</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter4_1/Cpu0SEInstrInfo.cpp</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">void</span> <span class="n">Cpu0SEInstrInfo</span><span class="p">::</span><span class="n">copyPhysReg</span><span class="p">(</span><span class="n">MachineBasicBlock</span> <span class="o">&amp;</span><span class="n">MBB</span><span class="p">,</span>
                                  <span class="n">MachineBasicBlock</span><span class="p">::</span><span class="n">iterator</span> <span class="n">I</span><span class="p">,</span>
                                  <span class="n">const</span> <span class="n">DebugLoc</span> <span class="o">&amp;</span><span class="n">DL</span><span class="p">,</span> <span class="n">MCRegister</span> <span class="n">DestReg</span><span class="p">,</span>
                                  <span class="n">MCRegister</span> <span class="n">SrcReg</span><span class="p">,</span> <span class="nb">bool</span> <span class="n">KillSrc</span><span class="p">)</span> <span class="n">const</span> <span class="p">{</span>
  <span class="n">unsigned</span> <span class="n">Opc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ZeroReg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">Cpu0</span><span class="p">::</span><span class="n">CPURegsRegClass</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="n">DestReg</span><span class="p">))</span> <span class="p">{</span> <span class="o">//</span> <span class="n">Copy</span> <span class="n">to</span> <span class="n">CPU</span> <span class="n">Reg</span><span class="o">.</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">Cpu0</span><span class="p">::</span><span class="n">CPURegsRegClass</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="n">SrcReg</span><span class="p">))</span>
      <span class="n">Opc</span> <span class="o">=</span> <span class="n">Cpu0</span><span class="p">::</span><span class="n">ADDu</span><span class="p">,</span> <span class="n">ZeroReg</span> <span class="o">=</span> <span class="n">Cpu0</span><span class="p">::</span><span class="n">ZERO</span><span class="p">;</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">SrcReg</span> <span class="o">==</span> <span class="n">Cpu0</span><span class="p">::</span><span class="n">HI</span><span class="p">)</span>
      <span class="n">Opc</span> <span class="o">=</span> <span class="n">Cpu0</span><span class="p">::</span><span class="n">MFHI</span><span class="p">,</span> <span class="n">SrcReg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">SrcReg</span> <span class="o">==</span> <span class="n">Cpu0</span><span class="p">::</span><span class="n">LO</span><span class="p">)</span>
      <span class="n">Opc</span> <span class="o">=</span> <span class="n">Cpu0</span><span class="p">::</span><span class="n">MFLO</span><span class="p">,</span> <span class="n">SrcReg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">Cpu0</span><span class="p">::</span><span class="n">CPURegsRegClass</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="n">SrcReg</span><span class="p">))</span> <span class="p">{</span> <span class="o">//</span> <span class="n">Copy</span> <span class="kn">from</span> <span class="nn">CPU</span> <span class="n">Reg</span><span class="o">.</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">DestReg</span> <span class="o">==</span> <span class="n">Cpu0</span><span class="p">::</span><span class="n">HI</span><span class="p">)</span>
      <span class="n">Opc</span> <span class="o">=</span> <span class="n">Cpu0</span><span class="p">::</span><span class="n">MTHI</span><span class="p">,</span> <span class="n">DestReg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">DestReg</span> <span class="o">==</span> <span class="n">Cpu0</span><span class="p">::</span><span class="n">LO</span><span class="p">)</span>
      <span class="n">Opc</span> <span class="o">=</span> <span class="n">Cpu0</span><span class="p">::</span><span class="n">MTLO</span><span class="p">,</span> <span class="n">DestReg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">assert</span><span class="p">(</span><span class="n">Opc</span> <span class="o">&amp;&amp;</span> <span class="s2">&quot;Cannot copy registers&quot;</span><span class="p">);</span>

  <span class="n">MachineInstrBuilder</span> <span class="n">MIB</span> <span class="o">=</span> <span class="n">BuildMI</span><span class="p">(</span><span class="n">MBB</span><span class="p">,</span> <span class="n">I</span><span class="p">,</span> <span class="n">DL</span><span class="p">,</span> <span class="n">get</span><span class="p">(</span><span class="n">Opc</span><span class="p">));</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">DestReg</span><span class="p">)</span>
    <span class="n">MIB</span><span class="o">.</span><span class="n">addReg</span><span class="p">(</span><span class="n">DestReg</span><span class="p">,</span> <span class="n">RegState</span><span class="p">::</span><span class="n">Define</span><span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">ZeroReg</span><span class="p">)</span>
    <span class="n">MIB</span><span class="o">.</span><span class="n">addReg</span><span class="p">(</span><span class="n">ZeroReg</span><span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">SrcReg</span><span class="p">)</span>
    <span class="n">MIB</span><span class="o">.</span><span class="n">addReg</span><span class="p">(</span><span class="n">SrcReg</span><span class="p">,</span> <span class="n">getKillRegState</span><span class="p">(</span><span class="n">KillSrc</span><span class="p">));</span>
<span class="p">}</span>
</pre></div>
</div>
<section id="and">
<h3><a class="toc-backref" href="#id22" role="doc-backlink"><strong>+, -, *, &lt;&lt;,</strong> and <strong>&gt;&gt;</strong></a><a class="headerlink" href="#and" title="Permalink to this heading">¶</a></h3>
<p>The ADDu, ADD, SUBu, SUB and MUL defined in Chapter4_1/Cpu0InstrInfo.td are for
operators <strong>+, -, *</strong>.
SHL (defined before) and SHLV are for <strong>&lt;&lt;</strong>.
SRA, SRAV, SHR and SHRV are for <strong>&gt;&gt;</strong>.</p>
<p>In RISC CPU, such as Mips, the multiply/divide function unit and add/sub/logic
unit are designed from two different hardware circuits, and more, their data
path are separate.
Cpu0 is same, so these two function units can be executed at same time
(instruction level parallelism).
Reference <a class="footnote-reference brackets" href="#instrstage" id="id1" role="doc-noteref"><span class="fn-bracket">[</span>1<span class="fn-bracket">]</span></a> for instruction itineraries.</p>
<p>Chapter4_1/ can handle <strong>+, -, *, &lt;&lt;,</strong> and <strong>&gt;&gt;</strong> operators in C
language.
The corresponding llvm IR instructions are <strong>add, sub, mul, shl, ashr</strong>.
The <strong>‘ashr’</strong> instruction (arithmetic shift right) returns the first operand
shifted to the right a specified number of bits with sign extension.
In brief, we call <strong>ashr</strong> is “shift with sign extension fill”.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><strong>ashr</strong></p>
<dl>
<dt>Example:</dt><dd><p>&lt;result&gt; = ashr i32 4, 1   ; yields {i32}:result = 2</p>
<p>&lt;result&gt; = ashr i8 -2, 1   ; yields {i8}:result = -1</p>
<p>&lt;result&gt; = ashr i32 1, 32  ; undefined</p>
</dd>
</dl>
</div>
<p>The semantic of C operator <strong>&gt;&gt;</strong> for negative operand is dependent on
implementation.
Most compilers translate it into “shift with sign extension fill”, and
Mips <strong>sra</strong> is this instruction.
Following is the Micosoft web site’s explanation,</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><strong>&gt;&gt;</strong>, Microsoft Specific</p>
<p>The result of a right shift of a signed negative quantity is implementation
dependent.
Although Microsoft C++ propagates the most-significant bit to fill vacated
bit positions, there is no guarantee that other implementations will do
likewise.</p>
</div>
<p>In addition to <strong>ashr</strong>, the other instruction “shift with zero filled”
<strong>lshr</strong> in llvm (Mips implement lshr with instruction <strong>srl</strong>) has the
following meaning.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><strong>lshr</strong></p>
<p>Example:
&lt;result&gt; = lshr i8 -2, 1   ; yields {i8}:result = 0x7FFFFFFF</p>
</div>
<p>In llvm, IR node <strong>sra</strong> is defined for ashr IR instruction, and node <strong>srl</strong> is
defined for lshr instruction (We don’t know why it doesn’t use ashr and lshr as
the IR node name directly). Summary as the Table: C operator &gt;&gt; implementation.</p>
<table class="docutils align-default" id="id10">
<caption><span class="caption-number">Table 21 </span><span class="caption-text">C operator &gt;&gt; implementation</span><a class="headerlink" href="#id10" title="Permalink to this table">¶</a></caption>
<thead>
<tr class="row-odd"><th class="head"><p>Description</p></th>
<th class="head"><p>Shift with zero filled</p></th>
<th class="head"><p>Shift with signed extension filled</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>symbol in .bc</p></td>
<td><p>lshr</p></td>
<td><p>ashr</p></td>
</tr>
<tr class="row-odd"><td><p>symbol in IR node</p></td>
<td><p>srl</p></td>
<td><p>sra</p></td>
</tr>
<tr class="row-even"><td><p>Mips instruction</p></td>
<td><p>srl</p></td>
<td><p>sra</p></td>
</tr>
<tr class="row-odd"><td><p>Cpu0 instruction</p></td>
<td><p>shr</p></td>
<td><p>sra</p></td>
</tr>
<tr class="row-even"><td><p>signed example before x &gt;&gt; 1</p></td>
<td><p>0xfffffffe i.e. -2</p></td>
<td><p>0xfffffffe i.e. -2</p></td>
</tr>
<tr class="row-odd"><td><p>signed example after x &gt;&gt; 1</p></td>
<td><p>0x7fffffff i.e 2G-1</p></td>
<td><p>0xffffffff i.e. -1</p></td>
</tr>
<tr class="row-even"><td><p>unsigned example before x &gt;&gt; 1</p></td>
<td><p>0xfffffffe i.e. 4G-2</p></td>
<td><p>0xfffffffe i.e. 4G-2</p></td>
</tr>
<tr class="row-odd"><td><p>unsigned example after x &gt;&gt; 1</p></td>
<td><p>0x7fffffff i.e 2G-1</p></td>
<td><p>0xffffffff i.e. 4G-1</p></td>
</tr>
</tbody>
</table>
<p><strong>lshr:</strong> Logical SHift Right</p>
<p><strong>ashr:</strong> Arithmetic SHift right</p>
<p><strong>srl:</strong>  Shift Right Logically</p>
<p><strong>sra:</strong>  Shift Right Arithmetically</p>
<p><strong>shr:</strong>  SHift Right</p>
<p>If we consider the x &gt;&gt; 1 definition is x = x/2 for compiler implementation.
Then as you can see from Table: C operator &gt;&gt; implementation, <strong>lshr</strong> will fail
on some signed value (such as -2). In the same way, <strong>ashr</strong> will fail on some
unsigned value (such as 4G-2). So, in order to satisfy this definition in
both signed and unsigned integers of x, we need these two instructions,
<strong>lshr</strong> and <strong>ashr</strong>.</p>
<table class="docutils align-default" id="id11">
<caption><span class="caption-number">Table 22 </span><span class="caption-text">C operator &lt;&lt; implementation</span><a class="headerlink" href="#id11" title="Permalink to this table">¶</a></caption>
<thead>
<tr class="row-odd"><th class="head"><p>Description</p></th>
<th class="head"><p>Shift with zero filled</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>symbol in .bc</p></td>
<td><p>shl</p></td>
</tr>
<tr class="row-odd"><td><p>symbol in IR node</p></td>
<td><p>shl</p></td>
</tr>
<tr class="row-even"><td><p>Mips instruction</p></td>
<td><p>sll</p></td>
</tr>
<tr class="row-odd"><td><p>Cpu0 instruction</p></td>
<td><p>shl</p></td>
</tr>
<tr class="row-even"><td><p>signed example before x &lt;&lt; 1</p></td>
<td><p>0x40000000 i.e. 1G</p></td>
</tr>
<tr class="row-odd"><td><p>signed example after x &lt;&lt; 1</p></td>
<td><p>0x80000000 i.e -2G</p></td>
</tr>
<tr class="row-even"><td><p>unsigned example before x &lt;&lt; 1</p></td>
<td><p>0x40000000 i.e. 1G</p></td>
</tr>
<tr class="row-odd"><td><p>unsigned example after x &lt;&lt; 1</p></td>
<td><p>0x80000000 i.e 2G</p></td>
</tr>
</tbody>
</table>
<p>Again, consider the x &lt;&lt; 1 definition is x = x*2.
From Table: C operator &lt;&lt; implementation, we see <strong>lshr</strong> satisfy “unsigned
x=1G” but fails on signed x=1G.
It’s fine since 2G is out of 32 bits signed integer range (-2G ~ 2G-1).
For the overflow case, no way to keep the correct result in register. So, any
value in register is OK. You can check that <strong>lshr</strong> satisfy x = x*2, for all
x &lt;&lt; 1 and the x result is not out of range, no matter operand x is signed
or unsigned integer <a class="footnote-reference brackets" href="#arithmetic-shift" id="id2" role="doc-noteref"><span class="fn-bracket">[</span>2<span class="fn-bracket">]</span></a>.</p>
<p>The ‘ashr‘ Instruction” reference here <a class="footnote-reference brackets" href="#ashr" id="id3" role="doc-noteref"><span class="fn-bracket">[</span>3<span class="fn-bracket">]</span></a>, ‘lshr‘ reference here <a class="footnote-reference brackets" href="#lshr" id="id4" role="doc-noteref"><span class="fn-bracket">[</span>4<span class="fn-bracket">]</span></a>.</p>
<p>The srav, shlv and shrv are for two virtual input registers instructions while
the sra, … are for 1 virtual input registers and 1 constant input operands.</p>
<p>Now, let’s build Chapter4_1/ and run with input file ch4_math.ll as follows,</p>
<p class="rubric">lbdex/input/ch4_math.ll</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>
<span class="p">;</span> <span class="n">Function</span> <span class="n">Attrs</span><span class="p">:</span> <span class="n">nounwind</span>
<span class="n">define</span> <span class="n">i32</span> <span class="nd">@_Z9test_mathv</span><span class="p">()</span> <span class="c1">#0 {</span>
  <span class="o">%</span><span class="n">a</span> <span class="o">=</span> <span class="n">alloca</span> <span class="n">i32</span><span class="p">,</span> <span class="n">align</span> <span class="mi">4</span>
  <span class="o">%</span><span class="n">b</span> <span class="o">=</span> <span class="n">alloca</span> <span class="n">i32</span><span class="p">,</span> <span class="n">align</span> <span class="mi">4</span>
  <span class="o">%</span><span class="mi">1</span> <span class="o">=</span> <span class="n">load</span> <span class="n">i32</span><span class="p">,</span> <span class="n">i32</span><span class="o">*</span> <span class="o">%</span><span class="n">a</span><span class="p">,</span> <span class="n">align</span> <span class="mi">4</span>
  <span class="o">%</span><span class="mi">2</span> <span class="o">=</span> <span class="n">load</span> <span class="n">i32</span><span class="p">,</span> <span class="n">i32</span><span class="o">*</span> <span class="o">%</span><span class="n">b</span><span class="p">,</span> <span class="n">align</span> <span class="mi">4</span>

  <span class="o">%</span><span class="mi">3</span> <span class="o">=</span> <span class="n">add</span> <span class="n">nsw</span> <span class="n">i32</span> <span class="o">%</span><span class="mi">1</span><span class="p">,</span> <span class="o">%</span><span class="mi">2</span>
  <span class="o">%</span><span class="mi">4</span> <span class="o">=</span> <span class="n">sub</span> <span class="n">nsw</span> <span class="n">i32</span> <span class="o">%</span><span class="mi">1</span><span class="p">,</span> <span class="o">%</span><span class="mi">2</span>
  <span class="o">%</span><span class="mi">5</span> <span class="o">=</span> <span class="n">mul</span> <span class="n">nsw</span> <span class="n">i32</span> <span class="o">%</span><span class="mi">1</span><span class="p">,</span> <span class="o">%</span><span class="mi">2</span>
  <span class="o">%</span><span class="mi">6</span> <span class="o">=</span> <span class="n">shl</span> <span class="n">i32</span> <span class="o">%</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span>
  <span class="o">%</span><span class="mi">7</span> <span class="o">=</span> <span class="n">ashr</span> <span class="n">i32</span> <span class="o">%</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span>
  <span class="o">%</span><span class="mi">8</span> <span class="o">=</span> <span class="n">lshr</span> <span class="n">i32</span> <span class="o">%</span><span class="mi">1</span><span class="p">,</span> <span class="mi">30</span>
  <span class="o">%</span><span class="mi">9</span> <span class="o">=</span> <span class="n">shl</span> <span class="n">i32</span> <span class="mi">1</span><span class="p">,</span> <span class="o">%</span><span class="mi">2</span>
  <span class="o">%</span><span class="mi">10</span> <span class="o">=</span> <span class="n">ashr</span> <span class="n">i32</span> <span class="mi">128</span><span class="p">,</span> <span class="o">%</span><span class="mi">2</span>
  <span class="o">%</span><span class="mi">11</span> <span class="o">=</span> <span class="n">ashr</span> <span class="n">i32</span> <span class="o">%</span><span class="mi">1</span><span class="p">,</span> <span class="o">%</span><span class="mi">2</span>

  <span class="o">%</span><span class="mi">12</span> <span class="o">=</span> <span class="n">add</span> <span class="n">nsw</span> <span class="n">i32</span> <span class="o">%</span><span class="mi">3</span><span class="p">,</span> <span class="o">%</span><span class="mi">4</span>
  <span class="o">%</span><span class="mi">13</span> <span class="o">=</span> <span class="n">add</span> <span class="n">nsw</span> <span class="n">i32</span> <span class="o">%</span><span class="mi">12</span><span class="p">,</span> <span class="o">%</span><span class="mi">5</span>
  <span class="o">%</span><span class="mi">14</span> <span class="o">=</span> <span class="n">add</span> <span class="n">nsw</span> <span class="n">i32</span> <span class="o">%</span><span class="mi">13</span><span class="p">,</span> <span class="o">%</span><span class="mi">6</span>
  <span class="o">%</span><span class="mi">15</span> <span class="o">=</span> <span class="n">add</span> <span class="n">nsw</span> <span class="n">i32</span> <span class="o">%</span><span class="mi">14</span><span class="p">,</span> <span class="o">%</span><span class="mi">7</span>
  <span class="o">%</span><span class="mi">16</span> <span class="o">=</span> <span class="n">add</span> <span class="n">nsw</span> <span class="n">i32</span> <span class="o">%</span><span class="mi">15</span><span class="p">,</span> <span class="o">%</span><span class="mi">8</span>
  <span class="o">%</span><span class="mi">17</span> <span class="o">=</span> <span class="n">add</span> <span class="n">nsw</span> <span class="n">i32</span> <span class="o">%</span><span class="mi">16</span><span class="p">,</span> <span class="o">%</span><span class="mi">9</span>
  <span class="o">%</span><span class="mi">18</span> <span class="o">=</span> <span class="n">add</span> <span class="n">nsw</span> <span class="n">i32</span> <span class="o">%</span><span class="mi">17</span><span class="p">,</span> <span class="o">%</span><span class="mi">10</span>
  <span class="o">%</span><span class="mi">19</span> <span class="o">=</span> <span class="n">add</span> <span class="n">nsw</span> <span class="n">i32</span> <span class="o">%</span><span class="mi">18</span><span class="p">,</span> <span class="o">%</span><span class="mi">11</span>

  <span class="n">ret</span> <span class="n">i32</span> <span class="o">%</span><span class="mi">19</span>
<span class="p">}</span>

</pre></div>
</div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">118-165-78-12:input Jonathan$ </span>/Users/Jonathan/llvm/test/build/
<span class="go">bin/llc -march=cpu0 -relocation-model=pic -filetype=asm ch4_math.ll -o -</span>
<span class="go">  ...</span>
<span class="go">        ld    $2, 0($sp)</span>
<span class="go">        ld    $3, 4($sp)</span>
<span class="go">        subu  $4, $3, $2</span>
<span class="go">        addu  $5, $3, $2</span>
<span class="go">        addu  $4, $5, $4</span>
<span class="go">        mul   $5, $3, $2</span>
<span class="go">        addu  $4, $4, $5</span>
<span class="go">        shl   $5, $3, 2</span>
<span class="go">        addu  $4, $4, $5</span>
<span class="go">        sra   $5, $3, 2</span>
<span class="go">        addu  $4, $4, $5</span>
<span class="go">        addiu $5, $zero, 128</span>
<span class="go">        shrv  $5, $5, $2</span>
<span class="go">        addiu $t9, $zero, 1</span>
<span class="go">        shlv  $t9, $t9, $2</span>
<span class="go">        srav  $2, $3, $2</span>
<span class="go">        shr   $3, $3, 30</span>
<span class="go">        addu  $3, $4, $3</span>
<span class="go">        addu  $3, $3, $t9</span>
<span class="go">        addu  $3, $3, $5</span>
<span class="go">        addu  $2, $3, $2</span>
<span class="go">        addiu $sp, $sp, 8</span>
<span class="go">        ret   $lr</span>
</pre></div>
</div>
<p>Example input ch4_1_math.cpp as the following is the C file which include <strong>+, -,
*, &lt;&lt;,</strong> and <strong>&gt;&gt;</strong> operators.
It will generate corresponding llvm IR instructions,
<strong>add, sub, mul, shl, ashr</strong> by clang as Chapter 3 indicated.</p>
<p class="rubric">lbdex/input/ch4_1_math.cpp</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">int</span> <span class="n">test_math</span><span class="p">()</span>
<span class="p">{</span>
  <span class="nb">int</span> <span class="n">a</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
  <span class="nb">int</span> <span class="n">b</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
  <span class="n">unsigned</span> <span class="nb">int</span> <span class="n">a1</span> <span class="o">=</span> <span class="o">-</span><span class="mi">5</span><span class="p">;</span>
  <span class="nb">int</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
  <span class="nb">int</span> <span class="n">j</span><span class="p">;</span>
  <span class="n">unsigned</span> <span class="nb">int</span> <span class="n">f1</span><span class="p">,</span> <span class="n">g1</span><span class="p">,</span> <span class="n">h1</span><span class="p">,</span> <span class="n">i1</span><span class="p">;</span>

  <span class="n">c</span> <span class="o">=</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="p">;</span>      <span class="o">//</span> <span class="n">c</span> <span class="o">=</span> <span class="mi">7</span>
  <span class="n">d</span> <span class="o">=</span> <span class="n">a</span> <span class="o">-</span> <span class="n">b</span><span class="p">;</span>      <span class="o">//</span> <span class="n">d</span> <span class="o">=</span> <span class="mi">3</span>
  <span class="n">e</span> <span class="o">=</span> <span class="n">a</span> <span class="o">*</span> <span class="n">b</span><span class="p">;</span>      <span class="o">//</span> <span class="n">e</span> <span class="o">=</span> <span class="mi">10</span>
  <span class="n">f</span> <span class="o">=</span> <span class="p">(</span><span class="n">a</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">);</span>   <span class="o">//</span> <span class="n">f</span> <span class="o">=</span> <span class="mi">20</span>
  <span class="n">f1</span> <span class="o">=</span> <span class="p">(</span><span class="n">a1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span> <span class="o">//</span> <span class="n">f1</span> <span class="o">=</span> <span class="mh">0xfffffff6</span> <span class="o">=</span> <span class="o">-</span><span class="mi">10</span>
  <span class="n">g</span> <span class="o">=</span> <span class="p">(</span><span class="n">a</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">);</span>   <span class="o">//</span> <span class="n">g</span> <span class="o">=</span> <span class="mi">1</span>
  <span class="n">g1</span> <span class="o">=</span> <span class="p">(</span><span class="n">a1</span> <span class="o">&gt;&gt;</span> <span class="mi">30</span><span class="p">);</span> <span class="o">//</span> <span class="n">g1</span> <span class="o">=</span> <span class="mh">0x03</span> <span class="o">=</span> <span class="mi">3</span>
  <span class="n">h</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">a</span><span class="p">);</span>   <span class="o">//</span> <span class="n">h</span> <span class="o">=</span> <span class="mh">0x20</span> <span class="o">=</span> <span class="mi">32</span>
  <span class="n">h1</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">b</span><span class="p">);</span>  <span class="o">//</span> <span class="n">h1</span> <span class="o">=</span> <span class="mh">0x04</span>
  <span class="n">i</span> <span class="o">=</span> <span class="p">(</span><span class="mh">0x80</span> <span class="o">&gt;&gt;</span> <span class="n">a</span><span class="p">);</span> <span class="o">//</span> <span class="n">i</span> <span class="o">=</span> <span class="mh">0x04</span>
  <span class="n">i1</span> <span class="o">=</span> <span class="p">(</span><span class="n">b</span> <span class="o">&gt;&gt;</span> <span class="n">a</span><span class="p">);</span>  <span class="o">//</span> <span class="n">i1</span> <span class="o">=</span> <span class="mh">0x0</span>
  <span class="n">j</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">24</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">);</span>  <span class="o">//</span> <span class="n">j</span> <span class="o">=</span> <span class="o">-</span><span class="mi">6</span>

  <span class="k">return</span> <span class="p">(</span><span class="n">c</span><span class="o">+</span><span class="n">d</span><span class="o">+</span><span class="n">e</span><span class="o">+</span><span class="n">f</span><span class="o">+</span><span class="nb">int</span><span class="p">(</span><span class="n">f1</span><span class="p">)</span><span class="o">+</span><span class="n">g</span><span class="o">+</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span><span class="n">g1</span><span class="o">+</span><span class="n">h</span><span class="o">+</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span><span class="n">h1</span><span class="o">+</span><span class="n">i</span><span class="o">+</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span><span class="n">i1</span><span class="o">+</span><span class="n">j</span><span class="p">);</span>
<span class="o">//</span> <span class="mi">7</span><span class="o">+</span><span class="mi">3</span><span class="o">+</span><span class="mi">10</span><span class="o">+</span><span class="mi">20</span><span class="o">-</span><span class="mi">10</span><span class="o">+</span><span class="mi">1</span><span class="o">+</span><span class="mi">3</span><span class="o">+</span><span class="mi">32</span><span class="o">+</span><span class="mi">4</span><span class="o">+</span><span class="mi">4</span><span class="o">+</span><span class="mi">0</span><span class="o">-</span><span class="mi">6</span> <span class="o">=</span> <span class="mi">68</span>
<span class="p">}</span>

</pre></div>
</div>
<p>Cpu0 instructions add and sub will trigger overflow exception while addu and subu
truncate overflow value directly. Compile ch4_1_addsuboverflow.cpp with
<code class="docutils literal notranslate"><span class="pre">llc</span> <span class="pre">-cpu0-enable-overflow=true</span></code> will generate add and sub instructions as
follows,</p>
<p class="rubric">lbdex/input/ch4_1_addsuboverflow.cpp</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#include &quot;debug.h&quot;</span>

<span class="nb">int</span> <span class="n">test_add_overflow</span><span class="p">()</span>
<span class="p">{</span>
  <span class="nb">int</span> <span class="n">a</span> <span class="o">=</span> <span class="mh">0x70000000</span><span class="p">;</span>
  <span class="nb">int</span> <span class="n">b</span> <span class="o">=</span> <span class="mh">0x20000000</span><span class="p">;</span>
  <span class="nb">int</span> <span class="n">c</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

  <span class="n">c</span> <span class="o">=</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="p">;</span>
  
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="nb">int</span> <span class="n">test_sub_overflow</span><span class="p">()</span>
<span class="p">{</span>
  <span class="nb">int</span> <span class="n">a</span> <span class="o">=</span> <span class="o">-</span><span class="mh">0x70000000</span><span class="p">;</span>
  <span class="nb">int</span> <span class="n">b</span> <span class="o">=</span> <span class="mh">0x20000000</span><span class="p">;</span>
  <span class="nb">int</span> <span class="n">c</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

  <span class="n">c</span> <span class="o">=</span> <span class="n">a</span> <span class="o">-</span> <span class="n">b</span><span class="p">;</span>
  
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">118-165-78-12:input Jonathan$ </span>clang -target mips-unknown-linux-gnu -c
<span class="go">ch4_1_addsuboverflow.cpp -emit-llvm -o ch4_1_addsuboverflow.bc</span>
<span class="gp">118-165-78-12:input Jonathan$ </span>llvm-dis ch4_1_addsuboverflow.bc -o -
<span class="go">...</span>
<span class="go">; Function Attrs: nounwind</span>
<span class="go">define i32 @_Z13test_overflowv() #0 {</span>
<span class="go">  ...</span>
<span class="gp">  %</span><span class="nv">3</span> <span class="o">=</span> add nsw i32 %1, %2
<span class="go">  ...</span>
<span class="gp">  %</span><span class="nv">6</span> <span class="o">=</span> sub nsw i32 %4, %5
<span class="go">  ...</span>
<span class="go">}</span>

<span class="gp">118-165-78-12:input Jonathan$ </span>/Users/Jonathan/llvm/test/build/
<span class="go">bin/llc -march=cpu0 -relocation-model=pic -filetype=asm</span>
<span class="go">-cpu0-enable-overflow=true ch4_1_addsuboverflow.bc -o -</span>
<span class="go">      ...</span>
<span class="go">      add     $3, $4, $3</span>
<span class="go">      ...</span>
<span class="go">      sub     $3, $4, $3</span>
<span class="go">      ...</span>
</pre></div>
</div>
<p>In modern CPU, programmers are used to using truncate overflow instructions for
C operators + and -.
Anyway, through option -cpu0-enable-overflow=true, programmer get the
chance to compile program with overflow exception program. Usually, this option
used in debug purpose. Compile with this option can help to identify the bug and
fix it early.</p>
</section>
<section id="display-llvm-ir-nodes-with-graphviz">
<h3><a class="toc-backref" href="#id23" role="doc-backlink">Display llvm IR nodes with Graphviz</a><a class="headerlink" href="#display-llvm-ir-nodes-with-graphviz" title="Permalink to this heading">¶</a></h3>
<p>The previous section, display the DAG translation process in text on terminal
by option <code class="docutils literal notranslate"><span class="pre">llc</span> <span class="pre">-debug</span></code>.
The <code class="docutils literal notranslate"><span class="pre">llc</span></code> also supports the graphic displaying.
The <a class="reference external" href="http://jonathan2251.github.io/lbd/install.html#install-other-tools-on-imac">section Install other tools on iMac</a> include the download and installation
of tool Graphivz.
The <code class="docutils literal notranslate"><span class="pre">llc</span></code> graphic displaying with tool Graphviz is introduced in this section.
The graphic displaying is more readable by eyes than displaying text in terminal.
It’s not a must-have, but helps a lot especially when you are tired in tracking
the DAG translation process.
List the <code class="docutils literal notranslate"><span class="pre">llc</span></code> graphic support options from the sub-section “SelectionDAG
Instruction Selection Process” of web “The LLVM Target-Independent Code Generator”
<a class="footnote-reference brackets" href="#instructionsel" id="id5" role="doc-noteref"><span class="fn-bracket">[</span>5<span class="fn-bracket">]</span></a> as follows,</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The <code class="docutils literal notranslate"><span class="pre">llc</span></code> Graphviz DAG display options</p>
<p>-view-dag-combine1-dags displays the DAG after being built, before the
first optimization pass.</p>
<p>-view-legalize-dags displays the DAG before Legalization.</p>
<p>-view-dag-combine2-dags displays the DAG before the second optimization
pass.</p>
<p>-view-isel-dags displays the DAG before the Select phase.</p>
<p>-view-sched-dags displays the DAG before Scheduling.</p>
</div>
<p>By tracking <code class="docutils literal notranslate"><span class="pre">llc</span> <span class="pre">-debug</span></code>, you can see the steps of DAG translation as follows,</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">Initial selection DAG</span>
<span class="go">Optimized lowered selection DAG</span>
<span class="go">Type-legalized selection DAG</span>
<span class="go">Optimized type-legalized selection DAG</span>
<span class="go">Legalized selection DAG</span>
<span class="go">Optimized legalized selection DAG</span>
<span class="go">Instruction selection</span>
<span class="go">Selected selection DAG</span>
<span class="go">Scheduling</span>
<span class="go">...</span>
</pre></div>
</div>
<p>Let’s run <code class="docutils literal notranslate"><span class="pre">llc</span></code> with option -view-dag-combine1-dags, and open the output
result with Graphviz as follows,</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">118-165-12-177:input Jonathan$ </span>/Users/Jonathan/llvm/test/
<span class="go">build/bin/llc -view-dag-combine1-dags -march=cpu0</span>
<span class="go">-relocation-model=pic -filetype=asm ch4_1_mult.bc -o ch4_1_mult.cpu0.s</span>
<span class="go">Writing &#39;/tmp/llvm_84ibpm/dag.main.dot&#39;...  done.</span>
<span class="gp">118-165-12-177:input Jonathan$ </span>Graphviz /tmp/llvm_84ibpm/dag.main.dot
</pre></div>
</div>
<p>It will show the /tmp/llvm_84ibpm/dag.main.dot as <a class="reference internal" href="#otherinst-f1"><span class="std std-numref">Fig. 22</span></a>.</p>
<figure class="align-center" id="id12">
<span id="otherinst-f1"></span><a class="reference internal image-reference" href="_images/15.png"><img alt="_images/15.png" src="_images/15.png" style="width: 687.0px; height: 851.0px;" /></a>
<figcaption>
<p><span class="caption-number">Fig. 22 </span><span class="caption-text">llc option -view-dag-combine1-dags graphic view</span><a class="headerlink" href="#id12" title="Permalink to this image">¶</a></p>
</figcaption>
</figure>
<p><a class="reference internal" href="#otherinst-f1"><span class="std std-numref">Fig. 22</span></a> is the stage of “Initial selection DAG”.
List the other view options and their corresponding stages of DAG translation as
follows,</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><code class="docutils literal notranslate"><span class="pre">llc</span></code> Graphviz options and the corresponding stages of DAG translation</p>
<p>-view-dag-combine1-dags: Initial selection DAG</p>
<p>-view-legalize-dags: Optimized type-legalized selection DAG</p>
<p>-view-dag-combine2-dags: Legalized selection DAG</p>
<p>-view-isel-dags: Optimized legalized selection DAG</p>
<p>-view-sched-dags: Selected selection DAG</p>
</div>
<p>The -view-isel-dags is important and often used by an llvm backend writer
because it is the DAGs before instruction selection.
In order to writing the pattern match instruction in target description file
.td, backend programmer needs knowing what the DAG nodes are for a given C
operator.</p>
</section>
<section id="operator-and">
<h3><a class="toc-backref" href="#id24" role="doc-backlink">Operator % and /</a><a class="headerlink" href="#operator-and" title="Permalink to this heading">¶</a></h3>
<section id="the-dag-of">
<h4><a class="toc-backref" href="#id25" role="doc-backlink">The DAG of %</a><a class="headerlink" href="#the-dag-of" title="Permalink to this heading">¶</a></h4>
<p>Example input code ch4_1_mult.cpp which contains the C operator <strong>“%”</strong> and it’s
corresponding llvm IR, as follows,</p>
<p class="rubric">lbdex/input/ch4_1_mult.cpp</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">int</span> <span class="n">test_mult</span><span class="p">()</span>
<span class="p">{</span>
  <span class="nb">int</span> <span class="n">b</span> <span class="o">=</span> <span class="mi">11</span><span class="p">;</span>
<span class="o">//</span>  <span class="n">unsigned</span> <span class="nb">int</span> <span class="n">b</span> <span class="o">=</span> <span class="mi">11</span><span class="p">;</span>
  
  <span class="n">b</span> <span class="o">=</span> <span class="p">(</span><span class="n">b</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">%</span><span class="mi">12</span><span class="p">;</span>
  
  <span class="k">return</span> <span class="n">b</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">...</span>
<span class="go">define i32 @_Z8test_multv() #0 {</span>
<span class="gp">  %</span><span class="nv">b</span> <span class="o">=</span> alloca i32, align <span class="m">4</span>
<span class="go">  store i32 11, i32* %b, align 4</span>
<span class="gp">  %</span><span class="nv">1</span> <span class="o">=</span> load i32* %b, align <span class="m">4</span>
<span class="gp">  %</span><span class="nv">2</span> <span class="o">=</span> add nsw i32 %1, <span class="m">1</span>
<span class="gp">  %</span><span class="nv">3</span> <span class="o">=</span> srem i32 %2, <span class="m">12</span>
<span class="go">  store i32 %3, i32* %b, align 4</span>
<span class="gp">  %</span><span class="nv">4</span> <span class="o">=</span> load i32* %b, align <span class="m">4</span>
<span class="go">  ret i32 %4</span>
<span class="go">}</span>
</pre></div>
</div>
<p>LLVM <strong>srem</strong> is the IR of corresponding <strong>“%”</strong>, reference here <a class="footnote-reference brackets" href="#srem" id="id6" role="doc-noteref"><span class="fn-bracket">[</span>6<span class="fn-bracket">]</span></a>.
Copy the reference as follows,</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><strong>‘srem’</strong> Instruction</p>
<p>Syntax:
<strong>&lt;result&gt; = srem &lt;ty&gt; &lt;op1&gt;, &lt;op2&gt;   ; yields {ty}:result</strong></p>
<p>Overview:
The <strong>‘srem’</strong> instruction returns the remainder from the signed division of its
two operands. This instruction can also take vector versions of the values in
which case the elements must be integers.</p>
<p>Arguments:
The two arguments to the <strong>‘srem’</strong> instruction must be integer or vector of
integer values. Both arguments must have identical types.</p>
<p>Semantics:
This instruction returns the remainder of a division (where the result is
either zero or has the same sign as the dividend, op1), not the modulo operator
(where the result is either zero or has the same sign as the divisor, op2) of
a value. For more information about the difference, see The Math Forum. For a
table of how this is implemented in various languages, please see Wikipedia:
modulo operation.</p>
<p>Note that signed integer remainder and unsigned integer remainder are distinct
operations; for unsigned integer remainder, use <strong>‘urem’</strong>.</p>
<p>Taking the remainder of a division by zero leads to undefined behavior.
Overflow also leads to undefined behavior; this is a rare case, but can occur,
for example, by taking the remainder of a 32-bit division of -2147483648 by -1.
(The remainder doesn’t actually overflow, but this rule lets srem be
implemented using instructions that return both the result of the division and
the remainder.)</p>
<p>Example:
&lt;result&gt; = <strong>srem i32 4, %var</strong>      ; yields {i32}:result = 4 % %var</p>
</div>
<p>Run Chapter3_5/ with input file ch4_1_mult.bc via option <code class="docutils literal notranslate"><span class="pre">llc</span> <span class="pre">–view-isel-dags</span></code>,
will get the following error message and the llvm DAGs of
<a class="reference internal" href="#otherinst-f2"><span class="std std-numref">Fig. 23</span></a> below.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">118-165-79-37:input Jonathan$ </span>/Users/Jonathan/llvm/test/
<span class="go">build/bin/llc -march=cpu0 -view-isel-dags -relocation-model=</span>
<span class="go">pic -filetype=asm ch4_1_mult.bc -o -</span>
<span class="go">...</span>
<span class="go">LLVM ERROR: Cannot select: 0x7fa73a02ea10: i32 = mulhs 0x7fa73a02c610,</span>
<span class="go">0x7fa73a02e910 [ID=12]</span>
<span class="go">0x7fa73a02c610: i32 = Constant&lt;12&gt; [ORD=5] [ID=7]</span>
<span class="go">0x7fa73a02e910: i32 = Constant&lt;715827883&gt; [ID=9]</span>
</pre></div>
</div>
<figure class="align-center" id="id13">
<span id="otherinst-f2"></span><a class="reference internal image-reference" href="_images/23.png"><img alt="_images/23.png" src="_images/23.png" style="width: 580.0px; height: 629.0px;" /></a>
<figcaption>
<p><span class="caption-number">Fig. 23 </span><span class="caption-text">ch4_1_mult.bc DAG</span><a class="headerlink" href="#id13" title="Permalink to this image">¶</a></p>
</figcaption>
</figure>
<p>LLVM replaces srem divide operation with multiply operation in DAG optimization
because DIV operation costs more in time than MUL.
Example code <strong>“int b = 11; b=(b+1)%12;”</strong> is translated into DAGs as
<a class="reference internal" href="#otherinst-f2"><span class="std std-numref">Fig. 23</span></a>.
The DAGs of generated result is verified and explained by calculating the value
in each node.
The 0xC*0x2AAAAAAB=0x2,00000004, (mulhs 0xC, 0x2AAAAAAAB) meaning get the Signed
mul high word (32bits).
Multiply with 2 operands of 1 word size probably generate the 2 word size of
result (0x2, 0xAAAAAAAB).
The result of high word, in this case is 0x2.
The final result (sub 12, 12) is 0 which match the statement (11+1)%12.</p>
</section>
<section id="arm-solution">
<h4><a class="toc-backref" href="#id26" role="doc-backlink">Arm solution</a><a class="headerlink" href="#arm-solution" title="Permalink to this heading">¶</a></h4>
<p>To run with ARM solution, change Cpu0InstrInfo.td and Cpu0ISelDAGToDAG.cpp from
Chapter4_1/ as follows,</p>
<p class="rubric">lbdex/chapters/Chapter4_1/Cpu0InstrInfo.td</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="c1">/// Multiply and Divide Instructions.</span>
<span class="n">def</span><span class="w"> </span><span class="n">SMMUL</span><span class="w">   </span><span class="o">:</span><span class="w"> </span><span class="n">ArithLogicR</span><span class="o">&lt;</span><span class="mh">0x41</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;smmul&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">mulhs</span><span class="p">,</span><span class="w"> </span><span class="n">IIImul</span><span class="p">,</span><span class="w"> </span><span class="n">CPURegs</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>
<span class="n">def</span><span class="w"> </span><span class="n">UMMUL</span><span class="w">   </span><span class="o">:</span><span class="w"> </span><span class="n">ArithLogicR</span><span class="o">&lt;</span><span class="mh">0x42</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;ummul&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">mulhu</span><span class="p">,</span><span class="w"> </span><span class="n">IIImul</span><span class="p">,</span><span class="w"> </span><span class="n">CPURegs</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>
<span class="c1">//def MULT    : Mult32&lt;0x41, &quot;mult&quot;, IIImul&gt;;</span>
<span class="c1">//def MULTu   : Mult32&lt;0x42, &quot;multu&quot;, IIImul&gt;;</span>
</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter4_1/Cpu0ISelDAGToDAG.cpp</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="cp">#if 0</span><span class="c"></span>
<span class="c">/// Select multiply instructions.</span>
<span class="c">std::pair&lt;SDNode*, SDNode*&gt;</span>
<span class="c">Cpu0DAGToDAGISel::SelectMULT(SDNode *N, unsigned Opc, SDLoc DL, EVT Ty,</span>
<span class="c">                             bool HasLo, bool HasHi) {</span>
<span class="c">  SDNode *Lo = 0, *Hi = 0;</span>
<span class="c">  SDNode *Mul = CurDAG-&gt;getMachineNode(Opc, DL, MVT::Glue, N-&gt;getOperand(0),</span>
<span class="c">                                       N-&gt;getOperand(1));</span>
<span class="c">  SDValue InFlag = SDValue(Mul, 0);</span>

<span class="c">  if (HasLo) {</span>
<span class="c">    Lo = CurDAG-&gt;getMachineNode(Cpu0::MFLO, DL,</span>
<span class="c">                                Ty, MVT::Glue, InFlag);</span>
<span class="c">    InFlag = SDValue(Lo, 1);</span>
<span class="c">  }</span>
<span class="c">  if (HasHi)</span>
<span class="c">    Hi = CurDAG-&gt;getMachineNode(Cpu0::MFHI, DL,</span>
<span class="c">                                Ty, InFlag);</span>

<span class="c">  return std::make_pair(Lo, Hi);</span>
<span class="c">}</span>
<span class="cp">#endif</span>

<span class="c1">/// Select instructions not customized! Used for</span>
<span class="c1">/// expanded, promoted and normal instructions</span>
<span class="n">SDNode</span><span class="o">*</span><span class="w"> </span><span class="nf">Cpu0DAGToDAGISel::Select</span><span class="p">(</span><span class="n">SDNode</span><span class="w"> </span><span class="o">*</span><span class="n">Node</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="p">...</span><span class="w"></span>
<span class="w">  </span><span class="k">switch</span><span class="p">(</span><span class="n">Opcode</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">default</span><span class="o">:</span><span class="w"> </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">  case ISD::MULHS:</span>
<span class="c">  case ISD::MULHU: {</span>
<span class="c">    MultOpc = (Opcode == ISD::MULHU ? Cpu0::MULTu : Cpu0::MULT);</span>
<span class="c">    return SelectMULT(Node, MultOpc, DL, NodeTy, false, true).second;</span>
<span class="c">  }</span>
<span class="cp">#endif</span>
<span class="w"> </span><span class="p">...</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>Let’s run above changes with ch4_1_mult.cpp as well as <code class="docutils literal notranslate"><span class="pre">llc</span> <span class="pre">-view-sched-dags</span></code> option
to get <a class="reference internal" href="#otherinst-f3"><span class="std std-numref">Fig. 24</span></a>.
Instruction SMMUL will get the high word of multiply result.</p>
<figure class="align-center" id="id14">
<span id="otherinst-f3"></span><a class="reference internal image-reference" href="_images/31.png"><img alt="_images/31.png" src="_images/31.png" style="width: 684.0px; height: 743.0px;" /></a>
<figcaption>
<p><span class="caption-number">Fig. 24 </span><span class="caption-text">DAG for ch4_1_mult.bc with ARM style SMMUL</span><a class="headerlink" href="#id14" title="Permalink to this image">¶</a></p>
</figcaption>
</figure>
<p>The following is the result of run above changes with ch4_1_mult.bc.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">118-165-66-82:input Jonathan$ </span>/Users/Jonathan/llvm/test/build/bin/llc
<span class="go">-march=cpu0 -relocation-model=pic -filetype=asm</span>
<span class="go">ch4_1_mult.bc -o -</span>
<span class="go">  ...</span>
<span class="gp"># </span>BB#0:                                 <span class="c1"># %entry</span>
<span class="go">  addiu $sp, $sp, -8</span>
<span class="gp">$</span>tmp1:
<span class="go">  .cfi_def_cfa_offset 8</span>
<span class="go">  addiu $2, $zero, 0</span>
<span class="go">  st  $2, 4($fp)</span>
<span class="go">  addiu $2, $zero, 11</span>
<span class="go">  st  $2, 0($fp)</span>
<span class="go">  lui $2, 10922</span>
<span class="go">  ori $3, $2, 43691</span>
<span class="go">  addiu $2, $zero, 12</span>
<span class="go">  smmul $3, $2, $3</span>
<span class="go">  shr $4, $3, 31</span>
<span class="go">  sra $3, $3, 1</span>
<span class="go">  addu  $3, $3, $4</span>
<span class="go">  mul $3, $3, $2</span>
<span class="go">  subu  $2, $2, $3</span>
<span class="go">  st  $2, 0($fp)</span>
<span class="go">  addiu $sp, $sp, 8</span>
<span class="go">  ret $lr</span>
</pre></div>
</div>
<p>The other instruction UMMUL and llvm IR mulhu are unsigned int type for
operator %.
You can check it by unmark the <strong>“unsigned int b = 11;”</strong> in ch4_1_mult.cpp.</p>
<p>Using SMMUL instruction to get the high word of multiplication result is adopted
in ARM.</p>
</section>
<section id="mips-solution">
<h4><a class="toc-backref" href="#id27" role="doc-backlink">Mips solution</a><a class="headerlink" href="#mips-solution" title="Permalink to this heading">¶</a></h4>
<p>Mips uses MULT instruction and save the high &amp; low part to registers HI and LO,
respectively.
After that, uses mfhi/mflo to move register HI/LO to your general purpose
registers.
ARM SMMUL is fast if you only need the HI part of result (it ignores the LO part
of operation). ARM also provides SMULL (signed multiply long) to get the whole
64 bits result.
If you need the LO part of result, you can use Cpu0 MUL instruction to get the
LO part of result only.
Chapter4_1/ is implemented with Mips MULT style.
We choose it as the implementation of this book for adding instructions as less
as possible. This approach make Cpu0 better both as a tutorial architecture
for school teaching purpose material, and an engineer learning
materials in compiler design.
The MULT, MULTu, MFHI, MFLO, MTHI, MTLO added in Chapter4_1/Cpu0InstrInfo.td;
HI, LO registers in Chapter4_1/Cpu0RegisterInfo.td and Chapter4_1/MCTargetDesc/
Cpu0BaseInfo.h; IIHiLo, IIImul in Chapter4_1/Cpu0Schedule.td; SelectMULT() in
Chapter4_1/Cpu0ISelDAGToDAG.cpp are for Mips style implementation.</p>
<p>The related DAG nodes, mulhs and mulhu, both are used in Chapter4_1/, which
come from TargetSelectionDAG.td as follows,</p>
<p class="rubric">include/llvm/Target/TargetSelectionDAG.td</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="n">def</span><span class="w"> </span><span class="n">mulhs</span><span class="w">    </span><span class="o">:</span><span class="w"> </span><span class="n">SDNode</span><span class="o">&lt;</span><span class="s">&quot;ISD::MULHS&quot;</span><span class="w">     </span><span class="p">,</span><span class="w"> </span><span class="n">SDTIntBinOp</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">SDNPCommutative</span><span class="p">]</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>
<span class="n">def</span><span class="w"> </span><span class="n">mulhu</span><span class="w">    </span><span class="o">:</span><span class="w"> </span><span class="n">SDNode</span><span class="o">&lt;</span><span class="s">&quot;ISD::MULHU&quot;</span><span class="w">     </span><span class="p">,</span><span class="w"> </span><span class="n">SDTIntBinOp</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">SDNPCommutative</span><span class="p">]</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>
</pre></div>
</div>
<p>Except the custom type, llvm IR operations of type expand and promote will call
Cpu0DAGToDAGISel::Select() during instruction selection of DAG translation.
The SelectMULT() which called by Select() return the HI part of
multiplication result to HI register for IR operations of mulhs or mulhu.
After that, MFHI instruction moves the HI register to Cpu0 field “a” register,
$ra.
MFHI instruction is FL format and only use Cpu0 field “a” register, we set
the $rb and imm16 to 0.
<a class="reference internal" href="#otherinst-f4"><span class="std std-numref">Fig. 25</span></a> and ch4_1_mult.cpu0.s are the results of compile
ch4_1_mult.bc.</p>
<figure class="align-center" id="id15">
<span id="otherinst-f4"></span><a class="reference internal image-reference" href="_images/41.png"><img alt="_images/41.png" src="_images/41.png" style="width: 498.6px; height: 753.3000000000001px;" /></a>
<figcaption>
<p><span class="caption-number">Fig. 25 </span><span class="caption-text">DAG for ch4_1_mult.bc with Mips style MULT</span><a class="headerlink" href="#id15" title="Permalink to this image">¶</a></p>
</figcaption>
</figure>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">118-165-66-82:input Jonathan$ </span>cat ch4_1_mult.cpu0.s
<span class="go">  ...</span>
<span class="gp"># </span>BB#0:
<span class="go">  addiu $sp, $sp, -8</span>
<span class="go">  addiu $2, $zero, 11</span>
<span class="go">  st  $2, 4($sp)</span>
<span class="go">  lui $2, 10922</span>
<span class="go">  ori $3, $2, 43691</span>
<span class="go">  addiu $2, $zero, 12</span>
<span class="go">  mult  $2, $3</span>
<span class="go">  mfhi  $3</span>
<span class="go">  shr $4, $3, 31</span>
<span class="go">  sra $3, $3, 1</span>
<span class="go">  addu  $3, $3, $4</span>
<span class="go">  mul $3, $3, $2</span>
<span class="go">  subu  $2, $2, $3</span>
<span class="go">  st  $2, 4($sp)</span>
<span class="go">  addiu $sp, $sp, 8</span>
<span class="go">  ret $lr</span>
</pre></div>
</div>
</section>
<section id="full-support-and">
<h4><a class="toc-backref" href="#id28" role="doc-backlink">Full support %, and /</a><a class="headerlink" href="#full-support-and" title="Permalink to this heading">¶</a></h4>
<p>The sensitive readers may find llvm using <strong>“multiplication”</strong> instead
of <strong>“div”</strong> to get the <strong>“%”</strong> result just because our example uses
constant as divider, <strong>“(b+1)%12”</strong> in our example.
If programmer uses variable as the divider like <strong>“(b+1)%a”</strong>, then: what will
happen next?
The answer is our code will has error in handling this.</p>
<p>Cpu0 just like Mips uses LO and HI registers to hold the <strong>“quotient”</strong> and
<strong>“remainder”</strong>. And
uses instructions <strong>“mflo”</strong> and <strong>“mfhi”</strong> to get the result from LO or HI
registers furthermore.
With this solution, the <strong>“c = a / b”</strong> can be finished by <strong>“div a, b”</strong> and
<strong>“mflo c”</strong>; the <strong>“c = a % b”</strong> can be finished by <strong>“div a, b”</strong> and
<strong>“mfhi c”</strong>.</p>
<p>To supports operators <strong>“%”</strong> and <strong>“/”</strong>, the following code added in
Chapter4_1.</p>
<ol class="arabic simple">
<li><p>SDIV, UDIV and it’s reference class, nodes in Cpu0InstrInfo.td.</p></li>
<li><p>The copyPhysReg() declared and defined in Cpu0InstrInfo.h and
Cpu0InstrInfo.cpp.</p></li>
<li><p>The setOperationAction(ISD::SDIV, MVT::i32, Expand), …,
setTargetDAGCombine(ISD::SDIVREM) in constructore of Cpu0ISelLowering.cpp;
PerformDivRemCombine() and PerformDAGCombine() in Cpu0ISelLowering.cpp.</p></li>
</ol>
<p>The IR instruction <strong>sdiv</strong> stands for signed div while <strong>udiv</strong> stands for
unsigned div.</p>
<p class="rubric">lbdex/input/ch4_1_mult2.cpp</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">int</span> <span class="n">test_mult</span><span class="p">()</span>
<span class="p">{</span>
  <span class="nb">int</span> <span class="n">b</span> <span class="o">=</span> <span class="mi">11</span><span class="p">;</span>
  <span class="nb">int</span> <span class="n">a</span> <span class="o">=</span> <span class="mi">12</span><span class="p">;</span>

  <span class="n">b</span> <span class="o">=</span> <span class="p">(</span><span class="n">b</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">%</span><span class="n">a</span><span class="p">;</span>
  
  <span class="k">return</span> <span class="n">b</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>If we run with ch4_1_mult2.cpp, the <strong>“div”</strong> cannot be gotten for operator
<strong>“%”</strong>.
It still uses <strong>“multiplication”</strong> instead of <strong>“div”</strong> in ch4_1_mult2.cpp because
llvm do <strong>“Constant Propagation Optimization”</strong> in this.
The ch4_1_mod.cpp can get the <strong>“div”</strong> for <strong>“%”</strong> result since it makes
llvm <strong>“Constant Propagation Optimization”</strong> useless in it.</p>
<p class="rubric">lbdex/input/ch4_1_mod.cpp</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">int</span> <span class="n">test_mod</span><span class="p">()</span>
<span class="p">{</span>
  <span class="nb">int</span> <span class="n">b</span> <span class="o">=</span> <span class="mi">11</span><span class="p">;</span>
  <span class="n">volatile</span> <span class="nb">int</span> <span class="n">a</span> <span class="o">=</span> <span class="mi">12</span><span class="p">;</span>
  
  <span class="n">b</span> <span class="o">=</span> <span class="p">(</span><span class="n">b</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">%</span><span class="n">a</span><span class="p">;</span>
  
  <span class="k">return</span> <span class="n">b</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">118-165-77-79:input Jonathan$ </span>clang -target mips-unknown-linux-gnu -c
<span class="go">ch4_1_mod.cpp -emit-llvm -o ch4_1_mod.bc</span>
<span class="gp">118-165-77-79:input Jonathan$ </span>/Users/Jonathan/llvm/test/build/bin/llc
<span class="go">-march=cpu0 -relocation-model=pic -filetype=asm</span>
<span class="go">ch4_1_mod.bc -o -</span>
<span class="go">...</span>
<span class="go">div $zero, $3, $2</span>
<span class="go">mflo  $2</span>
<span class="go">...</span>
</pre></div>
</div>
<p>To explains how to work with <strong>“div”</strong>, let’s run ch4_1_mod.cpp with debug option
as follows,</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">118-165-83-58:input Jonathan$ </span>clang -target mips-unknown-linux-gnu -c
<span class="go">ch4_1_mod.cpp -I/Applications/Xcode.app/Contents/Developer/Platforms/</span>
<span class="go">MacOSX.platform/Developer/SDKs/MacOSX10.8.sdk/usr/include/ -emit-llvm -o</span>
<span class="go">ch4_1_mod.bc</span>
<span class="gp">118-165-83-58:input Jonathan$ </span>/Users/Jonathan/llvm/test/build/
<span class="go">bin/llc -march=cpu0 -relocation-model=pic -filetype=asm -debug</span>
<span class="go">ch4_1_mod.bc -o -</span>
<span class="go">...</span>
<span class="go">=== _Z8test_modi</span>
<span class="go">Initial selection DAG: BB#0 &#39;_Z8test_mod2i:&#39;</span>
<span class="go">SelectionDAG has 21 nodes:</span>
<span class="go">  ...</span>
<span class="go">    0x2447448: &lt;multiple use&gt;</span>
<span class="go">        0x24470d0: &lt;multiple use&gt;</span>
<span class="go">        0x24471f8: i32 = Constant&lt;1&gt;</span>

<span class="go">      0x2447320: i32 = add 0x24470d0, 0x24471f8 [ORD=7]</span>

<span class="go">      0x2447448: &lt;multiple use&gt;</span>
<span class="go">    0x2447570: i32 = srem 0x2447320, 0x2447448 [ORD=9]</span>

<span class="go">    0x24468b8: &lt;multiple use&gt;</span>
<span class="go">    0x2446b08: &lt;multiple use&gt;</span>
<span class="go">  0x2448fc0: ch = store 0x2447448:1, 0x2447570, 0x24468b8, ...</span>

<span class="go">  0x2449210: i32 = Register %V0</span>

<span class="go">    0x2448fc0: &lt;multiple use&gt;</span>
<span class="go">    0x2449210: &lt;multiple use&gt;</span>
<span class="go">      0x2448fc0: &lt;multiple use&gt;</span>
<span class="go">      0x24468b8: &lt;multiple use&gt;</span>
<span class="go">      0x2446b08: &lt;multiple use&gt;</span>
<span class="go">    0x24490e8: i32,ch = load 0x2448fc0, 0x24468b8, 0x2446b08&lt;LD4[%b]&gt; [ORD=11]</span>

<span class="go">  0x2449338: ch,glue = CopyToReg 0x2448fc0, 0x2449210, 0x24490e8 [ORD=12]</span>

<span class="go">    0x2449338: &lt;multiple use&gt;</span>
<span class="go">    0x2449210: &lt;multiple use&gt;</span>
<span class="go">    0x2449338: &lt;multiple use&gt;</span>
<span class="go">  0x2449460: ch = Cpu0ISD::Ret 0x2449338, 0x2449210, 0x2449338:1 [ORD=12]</span>

<span class="go">Replacing.1 0x24490e8: i32,ch = load 0x2448fc0, 0x24468b8, ...</span>

<span class="go">With: 0x2447570: i32 = srem 0x2447320, 0x2447448 [ORD=9]</span>
<span class="go"> and 1 other values</span>
<span class="go">...</span>

<span class="go">Optimized lowered selection DAG: BB#0 &#39;_Z8test_mod2i:&#39;</span>
<span class="go">...</span>
<span class="go">  0x2447570: i32 = srem 0x2447320, 0x2447448 [ORD=9]</span>
<span class="go">...</span>

<span class="go">Type-legalized selection DAG: BB#0 &#39;_Z8test_mod2i:&#39;</span>
<span class="go">SelectionDAG has 16 nodes:</span>
<span class="go">  ...</span>
<span class="go">  0x7fed6882d610: i32,ch = load 0x7fed6882d210, 0x7fed6882cd10,</span>
<span class="go">  0x7fed6882cb10&lt;LD4[%1]&gt; [ORD=5] [ID=-3]</span>

<span class="go">    0x7fed6882d810: i32 = Constant&lt;12&gt; [ID=-3]</span>

<span class="go">    0x7fed6882d610: &lt;multiple use&gt;</span>
<span class="go">  0x7fed6882d710: i32 = srem 0x7fed6882d810, 0x7fed6882d610 [ORD=6] [ID=-3]</span>
<span class="go">  ...</span>

<span class="go">Legalized selection DAG: BB#0 &#39;_Z8test_mod2i:&#39;</span>
<span class="go">  ...</span>
<span class="go">    ... i32 = srem 0x2447320, 0x2447448 [ORD=9] [ID=-3]</span>
<span class="go">  ...</span>
<span class="go"> ... replacing: ...: i32 = srem 0x2447320, 0x2447448 [ORD=9] [ID=13]</span>
<span class="go">     with:      ...: i32,i32 = sdivrem 0x2447320, 0x2447448 [ORD=9]</span>

<span class="go">Optimized legalized selection DAG: BB#0 &#39;_Z8test_mod2i:&#39;</span>
<span class="go">SelectionDAG has 18 nodes:</span>
<span class="go">  ...</span>
<span class="go">    0x2449588: i32 = Register %HI</span>

<span class="go">        0x24470d0: &lt;multiple use&gt;</span>
<span class="go">        0x24471f8: i32 = Constant&lt;1&gt; [ID=6]</span>

<span class="go">      0x2447320: i32 = add 0x24470d0, 0x24471f8 [ORD=7] [ID=12]</span>

<span class="go">      0x2447448: &lt;multiple use&gt;</span>
<span class="go">    0x24490e8: glue = Cpu0ISD::DivRem 0x2447320, 0x2447448 [ORD=9]</span>

<span class="go">  0x24496b0: i32,ch,glue = CopyFromReg 0x240d480, 0x2449588, 0x24490e8 [ORD=9]</span>

<span class="go">    0x2449338: &lt;multiple use&gt;</span>
<span class="go">    0x2449210: &lt;multiple use&gt;</span>
<span class="go">    0x2449338: &lt;multiple use&gt;</span>
<span class="go">  0x2449460: ch = Cpu0ISD::Ret 0x2449338, 0x2449210, ...</span>
<span class="go">  ...</span>

<span class="go">===== Instruction selection begins: BB#0 &#39;&#39;</span>
<span class="go">...</span>
<span class="go">Selecting: 0x24490e8: glue = Cpu0ISD::DivRem 0x2447320, 0x2447448 [ORD=9] [ID=14]</span>

<span class="go">ISEL: Starting pattern match on root node: 0x24490e8: glue = Cpu0ISD::DivRem</span>
<span class="go">0x2447320, 0x2447448 [ORD=9] [ID=14]</span>

<span class="go">  Initial Opcode index to 4044</span>
<span class="go">  Morphed node: 0x24490e8: i32,glue = SDIV 0x2447320, 0x2447448 [ORD=9]</span>

<span class="go">ISEL: Match complete!</span>
<span class="go">=&gt; 0x24490e8: i32,glue = SDIV 0x2447320, 0x2447448 [ORD=9]</span>
<span class="go">...</span>
</pre></div>
</div>
<p>Summary above DAGs translation messages into 4 steps:</p>
<ol class="arabic simple">
<li><p>Reduce DAG nodes in stage “Optimized lowered selection DAG” (Replacing …
displayed before “Optimized lowered selection DAG:”).
Since SSA form has some redundant nodes for store and load, they can be
removed.</p></li>
<li><p>Change DAG srem to sdivrem in stage “Legalized selection DAG”.</p></li>
<li><p>Change DAG sdivrem to Cpu0ISD::DivRem and in stage “Optimized legalized
selection DAG”.</p></li>
<li><p>Add DAG “i32 = Register %HI” and “CopyFromReg …” in stage “Optimized
legalized selection DAG”.</p></li>
</ol>
<p>Summary as Table: Stages for C operator % and Table: Functions handle the DAG
translation and pattern match for C operator %.</p>
<table class="docutils align-default" id="id16">
<caption><span class="caption-number">Table 23 </span><span class="caption-text">Stages for C operator %</span><a class="headerlink" href="#id16" title="Permalink to this table">¶</a></caption>
<thead>
<tr class="row-odd"><th class="head"><p>Stage</p></th>
<th class="head"><p>IR/DAG/instruction</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>.bc</p></td>
<td><p>srem</p></td>
</tr>
<tr class="row-odd"><td><p>Legalized selection DAG</p></td>
<td><p>sdivrem</p></td>
</tr>
<tr class="row-even"><td><p>Optimized legalized selection DAG</p></td>
<td><p>Cpu0ISD::DivRem, CopyFromReg xx, Hi, Cpu0ISD::DivRem</p></td>
</tr>
<tr class="row-odd"><td><p>pattern match</p></td>
<td><p>div, mfhi</p></td>
</tr>
</tbody>
</table>
<table class="docutils align-default" id="id17">
<caption><span class="caption-number">Table 24 </span><span class="caption-text">Functions handle the DAG translation and pattern match for C operator %</span><a class="headerlink" href="#id17" title="Permalink to this table">¶</a></caption>
<thead>
<tr class="row-odd"><th class="head"><p>Translation</p></th>
<th class="head"><p>Do by</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>srem =&gt; sdivrem</p></td>
<td><p>setOperationAction(ISD::SREM, MVT::i32, Expand);</p></td>
</tr>
<tr class="row-odd"><td><p>sdivrem =&gt; Cpu0ISD::DivRem</p></td>
<td><p>setTargetDAGCombine(ISD::SDIVREM);</p></td>
</tr>
<tr class="row-even"><td><p>sdivrem =&gt; CopyFromReg xx, Hi, xx</p></td>
<td><p>PerformDivRemCombine();</p></td>
</tr>
<tr class="row-odd"><td><p>Cpu0ISD::DivRem =&gt; div</p></td>
<td><p>SDIV (Cpu0InstrInfo.td)</p></td>
</tr>
<tr class="row-even"><td><p>CopyFromReg xx, Hi, xx =&gt; mfhi</p></td>
<td><p>MFLO (Cpu0InstrInfo.td)</p></td>
</tr>
</tbody>
</table>
<p>Step 2 as above, is triggered by code
“setOperationAction(ISD::SREM, MVT::i32, Expand);” in Cpu0ISelLowering.cpp.
About <strong>Expand</strong> please ref. <a class="footnote-reference brackets" href="#expand" id="id7" role="doc-noteref"><span class="fn-bracket">[</span>7<span class="fn-bracket">]</span></a> and <a class="footnote-reference brackets" href="#legalizetypes" id="id8" role="doc-noteref"><span class="fn-bracket">[</span>8<span class="fn-bracket">]</span></a>. Step 3 is
triggered by code “setTargetDAGCombine(ISD::SDIVREM);” in Cpu0ISelLowering.cpp.
Step 4 is did by PerformDivRemCombine() which called by performDAGCombine().
Since the <strong>%</strong> corresponding <strong>srem</strong> makes the “N-&gt;hasAnyUseOfValue(1)” to
true in PerformDivRemCombine(), it creates DAG of “CopyFromReg”.
When using <strong>“/”</strong> in C, it will make “N-&gt;hasAnyUseOfValue(0)” to ture.
For sdivrem, <strong>sdiv</strong> makes “N-&gt;hasAnyUseOfValue(0)” true while <strong>srem</strong> makes
“N-&gt;hasAnyUseOfValue(1)” ture.</p>
<p>Above steps will change the DAGs when <code class="docutils literal notranslate"><span class="pre">llc</span></code> is running. After that, the pattern
match defined in Chapter4_1/Cpu0InstrInfo.td will translate <strong>Cpu0ISD::DivRem</strong>
into <strong>div</strong>; and <strong>“CopyFromReg xxDAG, Register %H, Cpu0ISD::DivRem”</strong>
to <strong>mfhi</strong>.</p>
<p>The ch4_1_div.cpp is for <strong>/</strong> div operator test.</p>
</section>
</section>
<section id="rotate-instructions">
<h3><a class="toc-backref" href="#id29" role="doc-backlink">Rotate instructions</a><a class="headerlink" href="#rotate-instructions" title="Permalink to this heading">¶</a></h3>
<p>Chapter4_1 include the rotate operations translation. The instructions “rol”,
“ror”, “rolv” and “rorv” defined in Cpu0InstrInfo.td handle the translation.
Compile ch4_1_rotate.cpp will get Cpu0 “rol” instruction.</p>
<p class="rubric">lbdex/input/ch4_1_rotate.cpp</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>
<span class="o">//</span><span class="c1">#define TEST_ROXV</span>

<span class="nb">int</span> <span class="n">test_rotate_left</span><span class="p">()</span>
<span class="p">{</span>
  <span class="n">unsigned</span> <span class="nb">int</span> <span class="n">a</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
  <span class="nb">int</span> <span class="n">result</span> <span class="o">=</span> <span class="p">((</span><span class="n">a</span> <span class="o">&lt;&lt;</span> <span class="mi">30</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">a</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">));</span>
  
  <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">#ifdef TEST_ROXV</span>

<span class="nb">int</span> <span class="n">test_rotate_left1</span><span class="p">()</span>
<span class="p">{</span>
  <span class="n">volatile</span> <span class="n">unsigned</span> <span class="nb">int</span> <span class="n">a</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
  <span class="n">volatile</span> <span class="nb">int</span> <span class="n">n</span> <span class="o">=</span> <span class="mi">30</span><span class="p">;</span>
  <span class="nb">int</span> <span class="n">result</span> <span class="o">=</span> <span class="p">((</span><span class="n">a</span> <span class="o">&lt;&lt;</span> <span class="n">n</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">a</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="mi">32</span> <span class="o">-</span> <span class="n">n</span><span class="p">)));</span>
  
  <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="nb">int</span> <span class="n">test_rotate_right</span><span class="p">()</span>
<span class="p">{</span>
  <span class="n">volatile</span> <span class="n">unsigned</span> <span class="nb">int</span> <span class="n">a</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="n">volatile</span> <span class="nb">int</span> <span class="n">n</span> <span class="o">=</span> <span class="mi">30</span><span class="p">;</span>
  <span class="nb">int</span> <span class="n">result</span> <span class="o">=</span> <span class="p">((</span><span class="n">a</span> <span class="o">&gt;&gt;</span> <span class="n">n</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">a</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">32</span> <span class="o">-</span> <span class="n">n</span><span class="p">)));</span>
  
  <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">#endif</span>
</pre></div>
</div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">114-43-200-122:input Jonathan$ </span>clang -target mips-unknown-linux-gnu -c
<span class="go">ch4_1_rotate.cpp -emit-llvm -o ch4_1_rotate.bc</span>
<span class="gp">114-43-200-122:input Jonathan$ </span>llvm-dis ch4_1_rotate.bc -o -
</pre></div>
</div>
<div class="highlight-llvm notranslate"><div class="highlight"><pre><span></span><span class="k">define</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="vg">@_Z16test_rotate_leftv</span><span class="p">()</span><span class="w"> </span><span class="vg">#0</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nv">%a</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">alloca</span><span class="w"> </span><span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="k">align</span><span class="w"> </span><span class="m">4</span><span class="w"></span>
<span class="w">  </span><span class="nv">%result</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">alloca</span><span class="w"> </span><span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="k">align</span><span class="w"> </span><span class="m">4</span><span class="w"></span>
<span class="w">  </span><span class="k">store</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="m">8</span><span class="p">,</span><span class="w"> </span><span class="kt">i32</span><span class="p">*</span><span class="w"> </span><span class="nv">%a</span><span class="p">,</span><span class="w"> </span><span class="k">align</span><span class="w"> </span><span class="m">4</span><span class="w"></span>
<span class="w">  </span><span class="nv nv-Anonymous">%1</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">load</span><span class="w"> </span><span class="kt">i32</span><span class="p">*</span><span class="w"> </span><span class="nv">%a</span><span class="p">,</span><span class="w"> </span><span class="k">align</span><span class="w"> </span><span class="m">4</span><span class="w"></span>
<span class="w">  </span><span class="nv nv-Anonymous">%2</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">shl</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="nv nv-Anonymous">%1</span><span class="p">,</span><span class="w"> </span><span class="m">30</span><span class="w"></span>
<span class="w">  </span><span class="nv nv-Anonymous">%3</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">load</span><span class="w"> </span><span class="kt">i32</span><span class="p">*</span><span class="w"> </span><span class="nv">%a</span><span class="p">,</span><span class="w"> </span><span class="k">align</span><span class="w"> </span><span class="m">4</span><span class="w"></span>
<span class="w">  </span><span class="nv nv-Anonymous">%4</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">ashr</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="nv nv-Anonymous">%3</span><span class="p">,</span><span class="w"> </span><span class="m">2</span><span class="w"></span>
<span class="w">  </span><span class="nv nv-Anonymous">%5</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">or</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="nv nv-Anonymous">%2</span><span class="p">,</span><span class="w"> </span><span class="nv nv-Anonymous">%4</span><span class="w"></span>
<span class="w">  </span><span class="k">store</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="nv nv-Anonymous">%5</span><span class="p">,</span><span class="w"> </span><span class="kt">i32</span><span class="p">*</span><span class="w"> </span><span class="nv">%result</span><span class="p">,</span><span class="w"> </span><span class="k">align</span><span class="w"> </span><span class="m">4</span><span class="w"></span>
<span class="w">  </span><span class="nv nv-Anonymous">%6</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">load</span><span class="w"> </span><span class="kt">i32</span><span class="p">*</span><span class="w"> </span><span class="nv">%result</span><span class="p">,</span><span class="w"> </span><span class="k">align</span><span class="w"> </span><span class="m">4</span><span class="w"></span>
<span class="w">  </span><span class="k">ret</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="nv nv-Anonymous">%6</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">114-43-200-122:input Jonathan$ </span>/Users/Jonathan/llvm/test/build/
<span class="go">bin/llc -march=cpu0 -relocation-model=pic -filetype=asm ch4_1_rotate.bc -o -</span>
<span class="go">  ...</span>
<span class="go">  rol $2, $2, 30</span>
<span class="go">  ...</span>
</pre></div>
</div>
<p>Instructions “rolv” and “rorv” cannot be tested at this moment, they need
logic “or” implementation which supported at next section.
Like the previous subsection mentioned at this
chapter, some IRs in function &#64;_Z16test_rotate_leftv() will be combined into
one one IR <strong>rotl</strong> during DAGs translation.</p>
</section>
</section>
<section id="logic">
<h2><a class="toc-backref" href="#id30" role="doc-backlink">Logic</a><a class="headerlink" href="#logic" title="Permalink to this heading">¶</a></h2>
<p>Chapter4_2 supports logic operators <strong>&amp;, |, ^, !, ==, !=, &lt;, &lt;=, &gt; and &gt;=</strong>.
They are trivial and easy. Listing the added code with comments and table for
these operators IR, DAG and instructions as below. Please check them with the
run result of bc and asm instructions for ch4_2_logic.cpp as below.</p>
<p class="rubric">lbdex/chapters/Chapter4_2/Cpu0InstrInfo.td</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>let Predicates = [Ch4_2] in {
class CmpInstr&lt;bits&lt;8&gt; op, string instr_asm, 
               InstrItinClass itin, RegisterClass RC, RegisterClass RD, 
               bit isComm = 0&gt;:
  FA&lt;op, (outs RD:$ra), (ins RC:$rb, RC:$rc),
     !strconcat(instr_asm, &quot;\t$ra, $rb, $rc&quot;), [], itin&gt; {
  let shamt = 0;
  let isCommutable = isComm;
  let Predicates = [HasCmp];
}
}
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>//  Logical
class LogicNOR&lt;bits&lt;8&gt; op, string instr_asm, RegisterClass RC&gt;:
  FA&lt;op, (outs RC:$ra), (ins RC:$rb, RC:$rc),
     !strconcat(instr_asm, &quot;\t$ra, $rb, $rc&quot;),
     [(set RC:$ra, (not (or RC:$rb, RC:$rc)))], IIAlu&gt; {
  let shamt = 0;
  let isCommutable = 1;
}
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>// SetCC
let Predicates = [Ch4_2] in {
class SetCC_R&lt;bits&lt;8&gt; op, string instr_asm, PatFrag cond_op,
              RegisterClass RC&gt;:
  FA&lt;op, (outs GPROut:$ra), (ins RC:$rb, RC:$rc),
     !strconcat(instr_asm, &quot;\t$ra, $rb, $rc&quot;),
     [(set GPROut:$ra, (cond_op RC:$rb, RC:$rc))],
     IIAlu&gt;, Requires&lt;[HasSlt]&gt; {
  let shamt = 0;
}

class SetCC_I&lt;bits&lt;8&gt; op, string instr_asm, PatFrag cond_op, Operand Od,
              PatLeaf imm_type, RegisterClass RC&gt;:
  FL&lt;op, (outs GPROut:$ra), (ins RC:$rb, Od:$imm16),
     !strconcat(instr_asm, &quot;\t$ra, $rb, $imm16&quot;),
     [(set GPROut:$ra, (cond_op RC:$rb, imm_type:$imm16))],
     IIAlu&gt;, Requires&lt;[HasSlt]&gt; {
}
}
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">let</span> <span class="n">Predicates</span> <span class="o">=</span> <span class="p">[</span><span class="n">Ch4_2</span><span class="p">]</span> <span class="ow">in</span> <span class="p">{</span>
<span class="k">def</span> <span class="nf">ANDi</span>    <span class="p">:</span> <span class="n">ArithLogicI</span><span class="o">&lt;</span><span class="mh">0x0c</span><span class="p">,</span> <span class="s2">&quot;andi&quot;</span><span class="p">,</span> <span class="ow">and</span><span class="p">,</span> <span class="n">uimm16</span><span class="p">,</span> <span class="n">immZExt16</span><span class="p">,</span> <span class="n">CPURegs</span><span class="o">&gt;</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">let</span> <span class="n">Predicates</span> <span class="o">=</span> <span class="p">[</span><span class="n">Ch4_2</span><span class="p">]</span> <span class="ow">in</span> <span class="p">{</span>
<span class="k">def</span> <span class="nf">XORi</span>    <span class="p">:</span> <span class="n">ArithLogicI</span><span class="o">&lt;</span><span class="mh">0x0e</span><span class="p">,</span> <span class="s2">&quot;xori&quot;</span><span class="p">,</span> <span class="n">xor</span><span class="p">,</span> <span class="n">uimm16</span><span class="p">,</span> <span class="n">immZExt16</span><span class="p">,</span> <span class="n">CPURegs</span><span class="o">&gt;</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">let</span> <span class="n">Predicates</span> <span class="o">=</span> <span class="p">[</span><span class="n">Ch4_2</span><span class="p">]</span> <span class="ow">in</span> <span class="p">{</span>
<span class="n">let</span> <span class="n">Predicates</span> <span class="o">=</span> <span class="p">[</span><span class="n">HasCmp</span><span class="p">]</span> <span class="ow">in</span> <span class="p">{</span>
<span class="k">def</span> <span class="nf">CMP</span>     <span class="p">:</span> <span class="n">CmpInstr</span><span class="o">&lt;</span><span class="mh">0x2A</span><span class="p">,</span> <span class="s2">&quot;cmp&quot;</span><span class="p">,</span> <span class="n">IIAlu</span><span class="p">,</span> <span class="n">CPURegs</span><span class="p">,</span> <span class="n">SR</span><span class="p">,</span> <span class="mi">0</span><span class="o">&gt;</span><span class="p">;</span>
<span class="k">def</span> <span class="nf">CMPu</span>    <span class="p">:</span> <span class="n">CmpInstr</span><span class="o">&lt;</span><span class="mh">0x2B</span><span class="p">,</span> <span class="s2">&quot;cmpu&quot;</span><span class="p">,</span> <span class="n">IIAlu</span><span class="p">,</span> <span class="n">CPURegs</span><span class="p">,</span> <span class="n">SR</span><span class="p">,</span> <span class="mi">0</span><span class="o">&gt;</span><span class="p">;</span>
<span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">let</span> <span class="n">Predicates</span> <span class="o">=</span> <span class="p">[</span><span class="n">Ch4_2</span><span class="p">]</span> <span class="ow">in</span> <span class="p">{</span>
<span class="k">def</span> <span class="nf">AND</span>     <span class="p">:</span> <span class="n">ArithLogicR</span><span class="o">&lt;</span><span class="mh">0x18</span><span class="p">,</span> <span class="s2">&quot;and&quot;</span><span class="p">,</span> <span class="ow">and</span><span class="p">,</span> <span class="n">IIAlu</span><span class="p">,</span> <span class="n">CPURegs</span><span class="p">,</span> <span class="mi">1</span><span class="o">&gt;</span><span class="p">;</span>
<span class="k">def</span> <span class="nf">OR</span>      <span class="p">:</span> <span class="n">ArithLogicR</span><span class="o">&lt;</span><span class="mh">0x19</span><span class="p">,</span> <span class="s2">&quot;or&quot;</span><span class="p">,</span> <span class="ow">or</span><span class="p">,</span> <span class="n">IIAlu</span><span class="p">,</span> <span class="n">CPURegs</span><span class="p">,</span> <span class="mi">1</span><span class="o">&gt;</span><span class="p">;</span>
<span class="k">def</span> <span class="nf">XOR</span>     <span class="p">:</span> <span class="n">ArithLogicR</span><span class="o">&lt;</span><span class="mh">0x1a</span><span class="p">,</span> <span class="s2">&quot;xor&quot;</span><span class="p">,</span> <span class="n">xor</span><span class="p">,</span> <span class="n">IIAlu</span><span class="p">,</span> <span class="n">CPURegs</span><span class="p">,</span> <span class="mi">1</span><span class="o">&gt;</span><span class="p">;</span>
<span class="k">def</span> <span class="nf">NOR</span>     <span class="p">:</span> <span class="n">LogicNOR</span><span class="o">&lt;</span><span class="mh">0x1b</span><span class="p">,</span> <span class="s2">&quot;nor&quot;</span><span class="p">,</span> <span class="n">CPURegs</span><span class="o">&gt;</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">let</span> <span class="n">Predicates</span> <span class="o">=</span> <span class="p">[</span><span class="n">Ch4_2</span><span class="p">]</span> <span class="ow">in</span> <span class="p">{</span>
<span class="n">let</span> <span class="n">Predicates</span> <span class="o">=</span> <span class="p">[</span><span class="n">HasSlt</span><span class="p">]</span> <span class="ow">in</span> <span class="p">{</span>
<span class="k">def</span> <span class="nf">SLTi</span>    <span class="p">:</span> <span class="n">SetCC_I</span><span class="o">&lt;</span><span class="mh">0x26</span><span class="p">,</span> <span class="s2">&quot;slti&quot;</span><span class="p">,</span> <span class="n">setlt</span><span class="p">,</span> <span class="n">simm16</span><span class="p">,</span> <span class="n">immSExt16</span><span class="p">,</span> <span class="n">CPURegs</span><span class="o">&gt;</span><span class="p">;</span>
<span class="k">def</span> <span class="nf">SLTiu</span>   <span class="p">:</span> <span class="n">SetCC_I</span><span class="o">&lt;</span><span class="mh">0x27</span><span class="p">,</span> <span class="s2">&quot;sltiu&quot;</span><span class="p">,</span> <span class="n">setult</span><span class="p">,</span> <span class="n">simm16</span><span class="p">,</span> <span class="n">immSExt16</span><span class="p">,</span> <span class="n">CPURegs</span><span class="o">&gt;</span><span class="p">;</span>
<span class="k">def</span> <span class="nf">SLT</span>     <span class="p">:</span> <span class="n">SetCC_R</span><span class="o">&lt;</span><span class="mh">0x28</span><span class="p">,</span> <span class="s2">&quot;slt&quot;</span><span class="p">,</span> <span class="n">setlt</span><span class="p">,</span> <span class="n">CPURegs</span><span class="o">&gt;</span><span class="p">;</span>
<span class="k">def</span> <span class="nf">SLTu</span>    <span class="p">:</span> <span class="n">SetCC_R</span><span class="o">&lt;</span><span class="mh">0x29</span><span class="p">,</span> <span class="s2">&quot;sltu&quot;</span><span class="p">,</span> <span class="n">setult</span><span class="p">,</span> <span class="n">CPURegs</span><span class="o">&gt;</span><span class="p">;</span>
<span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>let Predicates = [Ch4_2] in {
def : Pat&lt;(not CPURegs:$in),
// 1&#39;s complement of in, ex. not(0xf000000f) == 0x0ffffff0
          (NOR CPURegs:$in, ZERO)&gt;;
}
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>// setcc patterns

let Predicates = [Ch4_2] in {
// setcc for cmp instruction
multiclass SeteqPatsCmp&lt;RegisterClass RC&gt; {
// a == b
  def : Pat&lt;(seteq RC:$lhs, RC:$rhs),
            (SHR (ANDi (CMP RC:$lhs, RC:$rhs), 2), 1)&gt;;
// a != b
  def : Pat&lt;(setne RC:$lhs, RC:$rhs),
            (XORi (SHR (ANDi (CMP RC:$lhs, RC:$rhs), 2), 1), 1)&gt;;
}

// a &lt; b
multiclass SetltPatsCmp&lt;RegisterClass RC&gt; {
  def : Pat&lt;(setlt RC:$lhs, RC:$rhs),
            (ANDi (CMP RC:$lhs, RC:$rhs), 1)&gt;;
// if cpu0  `define N    `SW[31]  instead of `SW[0] // Negative flag, then need
// 2 more instructions as follows,
//          (XORi (ANDi (SHR (CMP RC:$lhs, RC:$rhs), (LUi 0x8000), 31), 1), 1)&gt;;
  def : Pat&lt;(setult RC:$lhs, RC:$rhs),
            (ANDi (CMPu RC:$lhs, RC:$rhs), 1)&gt;;
}

// a &lt;= b
multiclass SetlePatsCmp&lt;RegisterClass RC&gt; {
  def : Pat&lt;(setle RC:$lhs, RC:$rhs),
// a &lt;= b is equal to (XORi (b &lt; a), 1)
            (XORi (ANDi (CMP RC:$rhs, RC:$lhs), 1), 1)&gt;;
  def : Pat&lt;(setule RC:$lhs, RC:$rhs),
            (XORi (ANDi (CMP RC:$rhs, RC:$lhs), 1), 1)&gt;;
}

// a &gt; b
multiclass SetgtPatsCmp&lt;RegisterClass RC&gt; {
  def : Pat&lt;(setgt RC:$lhs, RC:$rhs),
// a &gt; b is equal to b &lt; a is equal to setlt(b, a)
            (ANDi (CMP RC:$rhs, RC:$lhs), 1)&gt;;
  def : Pat&lt;(setugt RC:$lhs, RC:$rhs),
            (ANDi (CMPu RC:$rhs, RC:$lhs), 1)&gt;;
}

// a &gt;= b
multiclass SetgePatsCmp&lt;RegisterClass RC&gt; {
  def : Pat&lt;(setge RC:$lhs, RC:$rhs),
// a &gt;= b is equal to b &lt;= a
            (XORi (ANDi (CMP RC:$lhs, RC:$rhs), 1), 1)&gt;;
  def : Pat&lt;(setuge RC:$lhs, RC:$rhs),
            (XORi (ANDi (CMPu RC:$lhs, RC:$rhs), 1), 1)&gt;;
}

// setcc for slt instruction
multiclass SeteqPatsSlt&lt;RegisterClass RC, Instruction SLTiuOp, Instruction XOROp,
                     Instruction SLTuOp, Register ZEROReg&gt; {
// a == b
  def : Pat&lt;(seteq RC:$lhs, RC:$rhs),
                (SLTiuOp (XOROp RC:$lhs, RC:$rhs), 1)&gt;;
// a != b
  def : Pat&lt;(setne RC:$lhs, RC:$rhs),
                (SLTuOp ZEROReg, (XOROp RC:$lhs, RC:$rhs))&gt;;
}

// a &lt;= b
multiclass SetlePatsSlt&lt;RegisterClass RC, Instruction SLTOp, Instruction SLTuOp&gt; {
  def : Pat&lt;(setle RC:$lhs, RC:$rhs),
// a &lt;= b is equal to (XORi (b &lt; a), 1)
                (XORi (SLTOp RC:$rhs, RC:$lhs), 1)&gt;;
  def : Pat&lt;(setule RC:$lhs, RC:$rhs),
                (XORi (SLTuOp RC:$rhs, RC:$lhs), 1)&gt;;
}

// a &gt; b
multiclass SetgtPatsSlt&lt;RegisterClass RC, Instruction SLTOp, Instruction SLTuOp&gt; {
  def : Pat&lt;(setgt RC:$lhs, RC:$rhs),
// a &gt; b is equal to b &lt; a is equal to setlt(b, a)
                (SLTOp RC:$rhs, RC:$lhs)&gt;;
  def : Pat&lt;(setugt RC:$lhs, RC:$rhs),
                (SLTuOp RC:$rhs, RC:$lhs)&gt;;
}

// a &gt;= b
multiclass SetgePatsSlt&lt;RegisterClass RC, Instruction SLTOp, Instruction SLTuOp&gt; {
  def : Pat&lt;(setge RC:$lhs, RC:$rhs),
// a &gt;= b is equal to b &lt;= a
                (XORi (SLTOp RC:$lhs, RC:$rhs), 1)&gt;;
  def : Pat&lt;(setuge RC:$lhs, RC:$rhs),
                (XORi (SLTuOp RC:$lhs, RC:$rhs), 1)&gt;;
}

multiclass SetgeImmPatsSlt&lt;RegisterClass RC, Instruction SLTiOp,
                        Instruction SLTiuOp&gt; {
  def : Pat&lt;(setge RC:$lhs, immSExt16:$rhs),
                (XORi (SLTiOp RC:$lhs, immSExt16:$rhs), 1)&gt;;
  def : Pat&lt;(setuge RC:$lhs, immSExt16:$rhs),
                (XORi (SLTiuOp RC:$lhs, immSExt16:$rhs), 1)&gt;;
}

let Predicates = [HasSlt] in {
defm : SeteqPatsSlt&lt;CPURegs, SLTiu, XOR, SLTu, ZERO&gt;;
defm : SetlePatsSlt&lt;CPURegs, SLT, SLTu&gt;;
defm : SetgtPatsSlt&lt;CPURegs, SLT, SLTu&gt;;
defm : SetgePatsSlt&lt;CPURegs, SLT, SLTu&gt;;
defm : SetgeImmPatsSlt&lt;CPURegs, SLTi, SLTiu&gt;;
}

let Predicates = [HasCmp] in {
defm : SeteqPatsCmp&lt;CPURegs&gt;;
defm : SetltPatsCmp&lt;CPURegs&gt;;
defm : SetlePatsCmp&lt;CPURegs&gt;;
defm : SetgtPatsCmp&lt;CPURegs&gt;;
defm : SetgePatsCmp&lt;CPURegs&gt;;
}
} // let Predicates = [Ch4_2]
</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter4_2/Cpu0ISelLowering.cpp</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Cpu0TargetLowering</span><span class="p">::</span><span class="n">Cpu0TargetLowering</span><span class="p">(</span><span class="n">const</span> <span class="n">Cpu0TargetMachine</span> <span class="o">&amp;</span><span class="n">TM</span><span class="p">,</span>
                                       <span class="n">const</span> <span class="n">Cpu0Subtarget</span> <span class="o">&amp;</span><span class="n">STI</span><span class="p">)</span>
    <span class="p">:</span> <span class="n">TargetLowering</span><span class="p">(</span><span class="n">TM</span><span class="p">),</span> <span class="n">Subtarget</span><span class="p">(</span><span class="n">STI</span><span class="p">),</span> <span class="n">ABI</span><span class="p">(</span><span class="n">TM</span><span class="o">.</span><span class="n">getABI</span><span class="p">())</span> <span class="p">{</span>

</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>  <span class="o">//</span> <span class="n">Cpu0</span> <span class="n">doesn</span><span class="s1">&#39;t have sext_inreg, replace them with shl/sra.</span>
  <span class="n">setOperationAction</span><span class="p">(</span><span class="n">ISD</span><span class="p">::</span><span class="n">SIGN_EXTEND_INREG</span><span class="p">,</span> <span class="n">MVT</span><span class="p">::</span><span class="n">i1</span> <span class="p">,</span> <span class="n">Expand</span><span class="p">);</span>
  <span class="n">setOperationAction</span><span class="p">(</span><span class="n">ISD</span><span class="p">::</span><span class="n">SIGN_EXTEND_INREG</span><span class="p">,</span> <span class="n">MVT</span><span class="p">::</span><span class="n">i8</span> <span class="p">,</span> <span class="n">Expand</span><span class="p">);</span>
  <span class="n">setOperationAction</span><span class="p">(</span><span class="n">ISD</span><span class="p">::</span><span class="n">SIGN_EXTEND_INREG</span><span class="p">,</span> <span class="n">MVT</span><span class="p">::</span><span class="n">i16</span> <span class="p">,</span> <span class="n">Expand</span><span class="p">);</span>
  <span class="n">setOperationAction</span><span class="p">(</span><span class="n">ISD</span><span class="p">::</span><span class="n">SIGN_EXTEND_INREG</span><span class="p">,</span> <span class="n">MVT</span><span class="p">::</span><span class="n">i32</span> <span class="p">,</span> <span class="n">Expand</span><span class="p">);</span>
  <span class="n">setOperationAction</span><span class="p">(</span><span class="n">ISD</span><span class="p">::</span><span class="n">SIGN_EXTEND_INREG</span><span class="p">,</span> <span class="n">MVT</span><span class="p">::</span><span class="n">Other</span> <span class="p">,</span> <span class="n">Expand</span><span class="p">);</span>
</pre></div>
</div>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="p">...</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p class="rubric">lbdex/input/ch4_2_logic.cpp</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>int test_andorxornotcomplement()
{
  int a = 5;
  int b = 3;
  int c = 0, d = 0, e = 0, f = 0, g = 0;

  c = (a &amp; b);  // c = 1
  d = (a | b);  // d = 7
  e = (a ^ b);  // e = 6
  b = !a;       // b = 0
  g = ~f;       // 1&#39;s complement, ~0=(-1)=0xffffffff
  
  return (c+d+e+b+g); // 13
}

int test_setxx()
{
  int a = 5;
  int b = 3;
  int c, d, e, f, g, h;
  
  c = (a == b); // seq, c = 0
  d = (a != b); // sne, d = 1
  e = (a &lt; b);  // slt, e = 0
  f = (a &lt;= b); // sle, f = 0
  g = (a &gt; b);  // sgt, g = 1
  h = (a &gt;= b); // sge, g = 1
  
  return (c+d+e+f+g+h); // 3
}

</pre></div>
</div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">114-43-204-152:input Jonathan$ </span>clang -target mips-unknown-linux-gnu -c
<span class="go">ch4_2_logic.cpp -emit-llvm -o ch4_2_logic.bc</span>
<span class="gp">114-43-204-152:input Jonathan$ </span>llvm-dis ch4_2_logic.bc -o -
<span class="go">...</span>
<span class="go">; Function Attrs: nounwind uwtable</span>
<span class="go">define i32 @_Z16test_andorxornotv() #0 {</span>
<span class="go">entry:</span>
<span class="go">  ...</span>
<span class="gp">  %</span><span class="nv">and</span> <span class="o">=</span> and i32 %0, %1
<span class="go">  ...</span>
<span class="gp">  %</span><span class="nv">or</span> <span class="o">=</span> or i32 %2, %3
<span class="go">  ...</span>
<span class="gp">  %</span><span class="nv">xor</span> <span class="o">=</span> xor i32 %4, %5
<span class="go">  ...</span>
<span class="gp">  %</span><span class="nv">tobool</span> <span class="o">=</span> icmp ne i32 %6, <span class="m">0</span>
<span class="gp">  %</span><span class="nv">lnot</span> <span class="o">=</span> xor i1 %tobool, <span class="nb">true</span>
<span class="gp">  %</span><span class="nv">conv</span> <span class="o">=</span> zext i1 %lnot to i32
<span class="go">  ...</span>
<span class="go">}</span>

<span class="go">; Function Attrs: nounwind uwtable</span>
<span class="go">define i32 @_Z10test_setxxv() #0 {</span>
<span class="go">entry:</span>
<span class="go">  ...</span>
<span class="gp">  %</span><span class="nv">cmp</span> <span class="o">=</span> icmp eq i32 %0, %1
<span class="gp">  %</span><span class="nv">conv</span> <span class="o">=</span> zext i1 %cmp to i32
<span class="go">  store i32 %conv, i32* %c, align 4</span>
<span class="go">  ...</span>
<span class="gp">  %</span><span class="nv">cmp1</span> <span class="o">=</span> icmp ne i32 %2, %3
<span class="gp">  %</span><span class="nv">conv2</span> <span class="o">=</span> zext i1 %cmp1 to i32
<span class="go">  store i32 %conv2, i32* %d, align 4</span>
<span class="go">  ...</span>
<span class="gp">  %</span><span class="nv">cmp3</span> <span class="o">=</span> icmp slt i32 %4, %5
<span class="gp">  %</span><span class="nv">conv4</span> <span class="o">=</span> zext i1 %cmp3 to i32
<span class="go">  store i32 %conv4, i32* %e, align 4</span>
<span class="go">  ...</span>
<span class="gp">  %</span><span class="nv">cmp5</span> <span class="o">=</span> icmp sle i32 %6, %7
<span class="gp">  %</span><span class="nv">conv6</span> <span class="o">=</span> zext i1 %cmp5 to i32
<span class="go">  store i32 %conv6, i32* %f, align 4</span>
<span class="go">  ...</span>
<span class="gp">  %</span><span class="nv">cmp7</span> <span class="o">=</span> icmp sgt i32 %8, %9
<span class="gp">  %</span><span class="nv">conv8</span> <span class="o">=</span> zext i1 %cmp7 to i32
<span class="go">  store i32 %conv8, i32* %g, align 4</span>
<span class="go">  ...</span>
<span class="gp">  %</span><span class="nv">cmp9</span> <span class="o">=</span> icmp sge i32 %10, %11
<span class="gp">  %</span><span class="nv">conv10</span> <span class="o">=</span> zext i1 %cmp9 to i32
<span class="go">  store i32 %conv10, i32* %h, align 4</span>
<span class="go">  ...</span>
<span class="go">}</span>

<span class="gp">114-43-204-152:input Jonathan$ </span>/Users/Jonathan/llvm/test/build/
<span class="go">bin/llc -march=cpu0 -mcpu=cpu032I -relocation-model=pic -filetype=asm</span>
<span class="go">ch4_2_logic.bc -o -</span>

<span class="go">  .globl  _Z16test_andorxornotv</span>
<span class="go">  ...</span>
<span class="go">  and $3, $4, $3</span>
<span class="go">  ...</span>
<span class="go">  or  $3, $4, $3</span>
<span class="go">  ...</span>
<span class="go">  xor $3, $4, $3</span>
<span class="go">  ...</span>
<span class="go">  cmp $sw, $3, $2</span>
<span class="go">  andi  $2, $sw, 2</span>
<span class="go">  shr $2, $2, 1</span>
<span class="go">  ...</span>

<span class="go">  .globl  _Z10test_setxxv</span>
<span class="go">  ...</span>
<span class="go">  cmp $sw, $3, $2</span>
<span class="go">  andi  $2, $sw, 2</span>
<span class="go">  shr $2, $2, 1</span>
<span class="go">  ...</span>
<span class="go">  cmp $sw, $3, $2</span>
<span class="go">  andi  $2, $sw, 2</span>
<span class="go">  shr $2, $2, 1</span>
<span class="go">  xori  $2, $2, 1</span>
<span class="go">  ...</span>
<span class="go">  cmp $sw, $3, $2</span>
<span class="go">  andi  $2, $sw, 1</span>
<span class="go">  ...</span>
<span class="go">  cmp $sw, $3, $2</span>
<span class="go">  andi  $2, $sw, 1</span>
<span class="go">  xori  $2, $2, 1</span>
<span class="go">  ...</span>
<span class="go">  cmp $sw, $3, $2</span>
<span class="go">  andi  $2, $sw, 1</span>
<span class="go">  ...</span>
<span class="go">  cmp $sw, $3, $2</span>
<span class="go">  andi  $2, $sw, 1</span>
<span class="go">  xori  $2, $2, 1</span>
<span class="go">  ...</span>

<span class="gp">114-43-204-152:input Jonathan$ </span>/Users/Jonathan/llvm/test/build/
<span class="go">bin/llc -march=cpu0 -mcpu=cpu032II -relocation-model=pic -filetype=asm</span>
<span class="go">ch4_2_logic.bc -o -</span>
<span class="go">  ...</span>
<span class="go">      sltiu   $2, $2, 1</span>
<span class="go">      andi    $2, $2, 1</span>
<span class="go">      ...</span>
</pre></div>
</div>
<table class="docutils align-default" id="id18">
<caption><span class="caption-number">Table 25 </span><span class="caption-text">Logic operators for cpu032I</span><a class="headerlink" href="#id18" title="Permalink to this table">¶</a></caption>
<thead>
<tr class="row-odd"><th class="head"><p>C</p></th>
<th class="head"><p>.bc</p></th>
<th class="head"><p>Optimized legalized selection DAG</p></th>
<th class="head"><p>cpu032I</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>&amp;, &amp;&amp;</p></td>
<td><p>and</p></td>
<td><p>and</p></td>
<td><p>and</p></td>
</tr>
<tr class="row-odd"><td><p>|, ||</p></td>
<td><p>or</p></td>
<td><p>or</p></td>
<td><p>or</p></td>
</tr>
<tr class="row-even"><td><p>^</p></td>
<td><p>xor</p></td>
<td><p>xor</p></td>
<td><p>xor</p></td>
</tr>
<tr class="row-odd"><td><p>!</p></td>
<td><ul class="simple">
<li><p>%tobool = icmp ne i32 %6, 0</p></li>
<li><p>%lnot = xor i1 %tobool, true</p></li>
<li><p>%conv = zext i1 %lnot to i32</p></li>
</ul>
</td>
<td><ul class="simple">
<li><p>%lnot = (setcc %tobool, 0, seteq)</p></li>
<li><p>%conv = (and %lnot, 1)</p></li>
<li></li>
</ul>
</td>
<td><ul class="simple">
<li><p>xor $3, $4, $3</p></li>
</ul>
</td>
</tr>
<tr class="row-even"><td><p>==</p></td>
<td><ul class="simple">
<li><p>%cmp = icmp eq i32 %0, %1</p></li>
<li><p>%conv = zext i1 %cmp to i32</p></li>
</ul>
</td>
<td><ul class="simple">
<li><p>%cmp = (setcc %0, %1, seteq)</p></li>
<li><p>and %cmp, 1</p></li>
</ul>
</td>
<td><ul class="simple">
<li><p>cmp $sw, $3, $2</p></li>
<li><p>andi  $2, $sw, 2</p></li>
<li><p>shr $2, $2, 1</p></li>
<li><p>andi $2, $2, 1</p></li>
</ul>
</td>
</tr>
<tr class="row-odd"><td><p>!=</p></td>
<td><ul class="simple">
<li><p>%cmp = icmp ne i32 %0, %1</p></li>
<li><p>%conv = zext i1 %cmp to i32</p></li>
</ul>
</td>
<td><ul class="simple">
<li><p>%cmp = (setcc %0, %1, setne)</p></li>
<li><p>and %cmp, 1</p></li>
</ul>
</td>
<td><ul class="simple">
<li><p>cmp $sw, $3, $2</p></li>
<li><p>andi  $2, $sw, 2</p></li>
<li><p>shr $2, $2, 1</p></li>
<li><p>andi $2, $2, 1</p></li>
</ul>
</td>
</tr>
<tr class="row-even"><td><p>&lt;</p></td>
<td><ul class="simple">
<li><p>%cmp = icmp lt i32 %0, %1</p></li>
<li><p>%conv = zext i1 %cmp to i32</p></li>
</ul>
</td>
<td><ul class="simple">
<li><p>(setcc %0, %1, setlt)</p></li>
<li><p>and %cmp, 1</p></li>
</ul>
</td>
<td><ul class="simple">
<li><p>cmp $sw, $3, $2</p></li>
<li><p>andi  $2, $sw, 2</p></li>
<li><p>andi $2, $2, 1</p></li>
<li><p>andi $2, $2, 1</p></li>
</ul>
</td>
</tr>
<tr class="row-odd"><td><p>&lt;=</p></td>
<td><ul class="simple">
<li><p>%cmp = icmp le i32 %0, %1</p></li>
<li><p>%conv = zext i1 %cmp to i32</p></li>
</ul>
</td>
<td><ul class="simple">
<li><p>(setcc %0, %1, setle)</p></li>
<li><p>and %cmp, 1</p></li>
</ul>
</td>
<td><ul class="simple">
<li><p>cmp $sw, $2, $3</p></li>
<li><p>andi  $2, $sw, 1</p></li>
<li><p>xori  $2, $2, 1</p></li>
<li><p>andi $2, $2, 1</p></li>
</ul>
</td>
</tr>
<tr class="row-even"><td><p>&gt;</p></td>
<td><ul class="simple">
<li><p>%cmp = icmp gt i32 %0, %1</p></li>
<li><p>%conv = zext i1 %cmp to i32</p></li>
</ul>
</td>
<td><ul class="simple">
<li><p>(setcc %0, %1, setgt)</p></li>
<li><p>and %cmp, 1</p></li>
</ul>
</td>
<td><ul class="simple">
<li><p>cmp $sw, $2, $3</p></li>
<li><p>andi  $2, $sw, 2</p></li>
<li><p>andi $2, $2, 1</p></li>
</ul>
</td>
</tr>
<tr class="row-odd"><td><p>&gt;=</p></td>
<td><ul class="simple">
<li><p>%cmp = icmp le i32 %0, %1</p></li>
<li><p>%conv = zext i1 %cmp to i32</p></li>
</ul>
</td>
<td><ul class="simple">
<li><p>(setcc %0, %1, setle)</p></li>
<li><p>and %cmp, 1</p></li>
</ul>
</td>
<td><ul class="simple">
<li><p>cmp $sw, $3, $2</p></li>
<li><p>andi  $2, $sw, 1</p></li>
<li><p>xori  $2, $2, 1</p></li>
<li><p>andi $2, $2, 1</p></li>
</ul>
</td>
</tr>
</tbody>
</table>
<table class="docutils align-default" id="id19">
<caption><span class="caption-number">Table 26 </span><span class="caption-text">Logic operators for cpu032II</span><a class="headerlink" href="#id19" title="Permalink to this table">¶</a></caption>
<thead>
<tr class="row-odd"><th class="head"><p>C</p></th>
<th class="head"><p>.bc</p></th>
<th class="head"><p>Optimized legalized selection DAG</p></th>
<th class="head"><p>cpu032II</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>&amp;, &amp;&amp;</p></td>
<td><p>and</p></td>
<td><p>and</p></td>
<td><p>and</p></td>
</tr>
<tr class="row-odd"><td><p>|, ||</p></td>
<td><p>or</p></td>
<td><p>or</p></td>
<td><p>or</p></td>
</tr>
<tr class="row-even"><td><p>^</p></td>
<td><p>xor</p></td>
<td><p>xor</p></td>
<td><p>xor</p></td>
</tr>
<tr class="row-odd"><td><p>!</p></td>
<td><ul class="simple">
<li><p>%tobool = icmp ne i32 %6, 0</p></li>
<li><p>%lnot = xor i1 %tobool, true</p></li>
<li><p>%conv = zext i1 %lnot to i32</p></li>
</ul>
</td>
<td><ul class="simple">
<li><p>%lnot = (setcc %tobool, 0, seteq)</p></li>
<li><p>%conv = (and %lnot, 1)</p></li>
<li></li>
</ul>
</td>
<td><ul class="simple">
<li><p>xor $3, $4, $3</p></li>
</ul>
</td>
</tr>
<tr class="row-even"><td><p>==</p></td>
<td><ul class="simple">
<li><p>%cmp = icmp eq i32 %0, %1</p></li>
<li><p>%conv = zext i1 %cmp to i32</p></li>
</ul>
</td>
<td><ul class="simple">
<li><p>%cmp = (setcc %0, %1, seteq)</p></li>
<li><p>and %cmp, 1</p></li>
</ul>
</td>
<td><ul class="simple">
<li><p>xor $2, $3, $2</p></li>
<li><p>sltiu  $2, $2, 1</p></li>
<li><p>andi $2, $2, 1</p></li>
</ul>
</td>
</tr>
<tr class="row-odd"><td><p>!=</p></td>
<td><ul class="simple">
<li><p>%cmp = icmp ne i32 %0, %1</p></li>
<li><p>%conv = zext i1 %cmp to i32</p></li>
</ul>
</td>
<td><ul class="simple">
<li><p>%cmp = (setcc %0, %1, setne)</p></li>
<li><p>and %cmp, 1</p></li>
</ul>
</td>
<td><ul class="simple">
<li><p>xor $2, $3, $2</p></li>
<li><p>sltu  $2, $zero, 2</p></li>
<li><p>shr $2, $2, 1</p></li>
<li><p>andi $2, $2, 1</p></li>
</ul>
</td>
</tr>
<tr class="row-even"><td><p>&lt;</p></td>
<td><ul class="simple">
<li><p>%cmp = icmp lt i32 %0, %1</p></li>
<li><p>%conv = zext i1 %cmp to i32</p></li>
</ul>
</td>
<td><ul class="simple">
<li><p>(setcc %0, %1, setlt)</p></li>
<li><p>and %cmp, 1</p></li>
</ul>
</td>
<td><ul class="simple">
<li><p>slt $2, $3, $2</p></li>
<li><p>andi  $2, $2, 1</p></li>
</ul>
</td>
</tr>
<tr class="row-odd"><td><p>&lt;=</p></td>
<td><ul class="simple">
<li><p>%cmp = icmp le i32 %0, %1</p></li>
<li><p>%conv = zext i1 %cmp to i32</p></li>
</ul>
</td>
<td><ul class="simple">
<li><p>(setcc %0, %1, setle)</p></li>
<li><p>and %cmp, 1</p></li>
</ul>
</td>
<td><ul class="simple">
<li><p>slt $2, $3, $2</p></li>
<li><p>xori  $2, $2, 1</p></li>
<li><p>andi $2, $2, 1</p></li>
</ul>
</td>
</tr>
<tr class="row-even"><td><p>&gt;</p></td>
<td><ul class="simple">
<li><p>%cmp = icmp gt i32 %0, %1</p></li>
<li><p>%conv = zext i1 %cmp to i32</p></li>
</ul>
</td>
<td><ul class="simple">
<li><p>(setcc %0, %1, setgt)</p></li>
<li><p>and %cmp, 1</p></li>
</ul>
</td>
<td><ul class="simple">
<li><p>slt $2, $3, $2</p></li>
<li><p>andi  $2, $2, 1</p></li>
</ul>
</td>
</tr>
<tr class="row-odd"><td><p>&gt;=</p></td>
<td><ul class="simple">
<li><p>%cmp = icmp le i32 %0, %1</p></li>
<li><p>%conv = zext i1 %cmp to i32</p></li>
</ul>
</td>
<td><ul class="simple">
<li><p>(setcc %0, %1, setle)</p></li>
<li><p>and %cmp, 1</p></li>
</ul>
</td>
<td><ul class="simple">
<li><p>slt $2, $3, $2</p></li>
<li><p>xori  $2, $2, 1</p></li>
<li><p>andi $2, $2, 1</p></li>
</ul>
</td>
</tr>
</tbody>
</table>
<p>In relation operators ==, !=, …, %0 = $3 = 5, %1 = $2 = 3 for ch4_2_logic.cpp.</p>
<p>The “Optimized legalized selection DAG” is the last DAG stage just before the
“instruction selection” as the previous section mentioned in this chapter.
You can see the whole DAG stages by <code class="docutils literal notranslate"><span class="pre">llc</span> <span class="pre">-debug</span></code> option.</p>
<p>From above result, slt spend less instructions than cmp for relation
operators translation. Beyond that, slt uses general purpose register while
cmp uses $sw dedicated register.</p>
<p class="rubric">lbdex/input/ch4_2_slt_explain.cpp</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">int</span> <span class="n">test_OptSlt</span><span class="p">()</span>
<span class="p">{</span>
  <span class="nb">int</span> <span class="n">a</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="nb">int</span> <span class="n">d</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">e</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">f</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

  <span class="n">d</span> <span class="o">=</span> <span class="p">(</span><span class="n">a</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">);</span>
  <span class="n">e</span> <span class="o">=</span> <span class="p">(</span><span class="n">b</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">);</span>
  <span class="n">f</span> <span class="o">=</span> <span class="n">d</span> <span class="o">+</span> <span class="n">e</span><span class="p">;</span>

  <span class="k">return</span> <span class="p">(</span><span class="n">f</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">118-165-78-10:input Jonathan$ </span>clang -target mips-unknown-linux-gnu -O2
<span class="go">-c ch4_2_slt_explain.cpp -emit-llvm -o ch4_2_slt_explain.bc</span>
<span class="gp">118-165-78-10:input Jonathan$ </span>/Users/Jonathan/llvm/test/build/
<span class="go">bin/llc -march=cpu0 -mcpu=cpu032I -relocation-model=static -filetype=asm</span>
<span class="go">ch4_2_slt_explain.bc -o -</span>
<span class="go">  ...</span>
<span class="go">  ld  $3, 20($sp)</span>
<span class="go">  cmp $sw, $3, $2</span>
<span class="go">  andi  $2, $sw, 1</span>
<span class="go">  andi  $2, $2, 1</span>
<span class="go">  st  $2, 12($sp)</span>
<span class="go">  addiu $2, $zero, 2</span>
<span class="go">  ld  $3, 16($sp)</span>
<span class="go">  cmp $sw, $3, $2</span>
<span class="go">  andi  $2, $sw, 1</span>
<span class="go">  andi  $2, $2, 1</span>
<span class="go">  ...</span>
<span class="gp">118-165-78-10:input Jonathan$ </span>/Users/Jonathan/llvm/test/build/
<span class="go">bin/llc -march=cpu0 -mcpu=cpu032II -relocation-model=static -filetype=asm</span>
<span class="go">ch4_2_slt_explain.bc -o -</span>
<span class="go">  ...</span>
<span class="go">  ld  $2, 20($sp)</span>
<span class="go">  slti  $2, $2, 1</span>
<span class="go">  andi  $2, $2, 1</span>
<span class="go">  st  $2, 12($sp)</span>
<span class="go">  ld  $2, 16($sp)</span>
<span class="go">  slti  $2, $2, 2</span>
<span class="go">  andi  $2, $2, 1</span>
<span class="go">  st  $2, 8($sp)</span>
<span class="go">  ...</span>
</pre></div>
</div>
<p>Run these two <cite>llc -mcpu</cite> option for Chapter4_2 with ch4_2_slt_explain.cpp to get the
above result. Regardless of the move between $sw and general purpose register
in <cite>llc -mcpu=cpu032I</cite>, the two cmp instructions in it will has hazard in
instruction reorder since both of them use $sw register. The
<cite>llc -mcpu=cpu032II</cite> has not this problem because it uses slti <a class="footnote-reference brackets" href="#quantitative" id="id9" role="doc-noteref"><span class="fn-bracket">[</span>9<span class="fn-bracket">]</span></a>.
The slti version can reorder as follows,</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">...</span>
<span class="go">ld  $2, 16($sp)</span>
<span class="go">slti  $2, $2, 2</span>
<span class="go">andi  $2, $2, 1</span>
<span class="go">st  $2, 8($sp)</span>
<span class="go">ld  $2, 20($sp)</span>
<span class="go">slti  $2, $2, 1</span>
<span class="go">andi  $2, $2, 1</span>
<span class="go">st  $2, 12($sp)</span>
<span class="go">...</span>
</pre></div>
</div>
<p>Chapter4_2 include instructions cmp and slt. Though cpu032II include both of
these two instructions, the slt takes the priority since
“let Predicates = [HasSlt]” appeared before “let Predicates = [HasCmp]” in
Cpu0InstrInfo.td.</p>
</section>
<section id="summary">
<h2><a class="toc-backref" href="#id31" role="doc-backlink">Summary</a><a class="headerlink" href="#summary" title="Permalink to this heading">¶</a></h2>
<p>List C operators, IR of .bc, Optimized legalized selection DAG and Cpu0
instructions implemented in this chapter in Table: Chapter 4 mathmetic
operators. There are over 20 operators totally in mathmetic and logic support in
this chapter and spend 4xx lines of source code.</p>
<table class="docutils align-default" id="id20">
<caption><span class="caption-number">Table 27 </span><span class="caption-text">Chapter 4 mathmetic operators</span><a class="headerlink" href="#id20" title="Permalink to this table">¶</a></caption>
<thead>
<tr class="row-odd"><th class="head"><p>C</p></th>
<th class="head"><p>.bc</p></th>
<th class="head"><p>Optimized legalized selection DAG</p></th>
<th class="head"><p>Cpu0</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>+</p></td>
<td><p>add</p></td>
<td><p>add</p></td>
<td><p>addu</p></td>
</tr>
<tr class="row-odd"><td><p>-</p></td>
<td><p>sub</p></td>
<td><p>sub</p></td>
<td><p>subu</p></td>
</tr>
<tr class="row-even"><td><p>*</p></td>
<td><p>mul</p></td>
<td><p>mul</p></td>
<td><p>mul</p></td>
</tr>
<tr class="row-odd"><td><p>/</p></td>
<td><p>sdiv</p></td>
<td><p>Cpu0ISD::DivRem</p></td>
<td><p>div</p></td>
</tr>
<tr class="row-even"><td><ul class="simple">
<li></li>
</ul>
</td>
<td><p>udiv</p></td>
<td><p>Cpu0ISD::DivRemU</p></td>
<td><p>divu</p></td>
</tr>
<tr class="row-odd"><td><p>&lt;&lt;</p></td>
<td><p>shl</p></td>
<td><p>shl</p></td>
<td><p>shl</p></td>
</tr>
<tr class="row-even"><td><p>&gt;&gt;</p></td>
<td><ul class="simple">
<li><p>ashr</p></li>
<li><p>lshr</p></li>
</ul>
</td>
<td><ul class="simple">
<li><p>sra</p></li>
<li><p>srl</p></li>
</ul>
</td>
<td><ul class="simple">
<li><p>sra</p></li>
<li><p>shr</p></li>
</ul>
</td>
</tr>
<tr class="row-odd"><td><p>!</p></td>
<td><ul class="simple">
<li><p>%tobool = icmp ne i32 %0, 0</p></li>
<li><p>%lnot = xor i1 %tobool, true</p></li>
</ul>
</td>
<td><ul class="simple">
<li><p>%lnot = (setcc %tobool, 0, seteq)</p></li>
<li><p>%conv = (and %lnot, 1)</p></li>
</ul>
</td>
<td><ul class="simple">
<li><p>%1 = (xor %tobool, 0)</p></li>
<li><p>%true = (addiu $r0, 1)</p></li>
<li><p>%lnot = (xor %1, %true)</p></li>
</ul>
</td>
</tr>
<tr class="row-even"><td><ul class="simple">
<li></li>
</ul>
</td>
<td><ul class="simple">
<li><p>%conv = zext i1 %lnot to i32</p></li>
</ul>
</td>
<td><ul class="simple">
<li><p>%conv = (and %lnot, 1)</p></li>
</ul>
</td>
<td><ul class="simple">
<li><p>%conv = (and %lnot, 1)</p></li>
</ul>
</td>
</tr>
<tr class="row-odd"><td><p>%</p></td>
<td><ul class="simple">
<li><p>srem</p></li>
<li><p>sremu</p></li>
</ul>
</td>
<td><ul class="simple">
<li><p>Cpu0ISD::DivRem</p></li>
<li><p>Cpu0ISD::DivRemU</p></li>
</ul>
</td>
<td><ul class="simple">
<li><p>div</p></li>
<li><p>divu</p></li>
</ul>
</td>
</tr>
<tr class="row-even"><td><p>(x&lt;&lt;n)|(x&gt;&gt;32-n)</p></td>
<td><p>shl + lshr</p></td>
<td><p>rotl, rotr</p></td>
<td><p>rol, rolv, ror, rorv</p></td>
</tr>
</tbody>
</table>
<aside class="footnote brackets" id="instrstage" role="note">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id1">1</a><span class="fn-bracket">]</span></span>
<p><a class="reference external" href="http://llvm.org/docs/doxygen/html/structllvm_1_1InstrStage.html">http://llvm.org/docs/doxygen/html/structllvm_1_1InstrStage.html</a></p>
</aside>
<aside class="footnote brackets" id="arithmetic-shift" role="note">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id2">2</a><span class="fn-bracket">]</span></span>
<p><a class="reference external" href="https://open4tech.com/logical-vs-arithmetic-shift">https://open4tech.com/logical-vs-arithmetic-shift</a></p>
</aside>
<aside class="footnote brackets" id="ashr" role="note">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id3">3</a><span class="fn-bracket">]</span></span>
<p><a class="reference external" href="http://llvm.org/docs/LangRef.html#ashr-instruction">http://llvm.org/docs/LangRef.html#ashr-instruction</a></p>
</aside>
<aside class="footnote brackets" id="lshr" role="note">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id4">4</a><span class="fn-bracket">]</span></span>
<p><a class="reference external" href="http://llvm.org/docs/LangRef.html#lshr-instruction">http://llvm.org/docs/LangRef.html#lshr-instruction</a></p>
</aside>
<aside class="footnote brackets" id="instructionsel" role="note">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id5">5</a><span class="fn-bracket">]</span></span>
<p><a class="reference external" href="http://llvm.org/docs/CodeGenerator.html#selectiondag-instruction-selection-process">http://llvm.org/docs/CodeGenerator.html#selectiondag-instruction-selection-process</a></p>
</aside>
<aside class="footnote brackets" id="srem" role="note">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id6">6</a><span class="fn-bracket">]</span></span>
<p><a class="reference external" href="http://llvm.org/docs/LangRef.html#srem-instruction">http://llvm.org/docs/LangRef.html#srem-instruction</a></p>
</aside>
<aside class="footnote brackets" id="expand" role="note">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id7">7</a><span class="fn-bracket">]</span></span>
<p><a class="reference external" href="http://llvm.org/docs/WritingAnLLVMBackend.html#expand">http://llvm.org/docs/WritingAnLLVMBackend.html#expand</a></p>
</aside>
<aside class="footnote brackets" id="legalizetypes" role="note">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id8">8</a><span class="fn-bracket">]</span></span>
<p><a class="reference external" href="http://llvm.org/docs/CodeGenerator.html#selectiondag-legalizetypes-phase">http://llvm.org/docs/CodeGenerator.html#selectiondag-legalizetypes-phase</a></p>
</aside>
<aside class="footnote brackets" id="quantitative" role="note">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id9">9</a><span class="fn-bracket">]</span></span>
<p>See book Computer Architecture: A Quantitative Approach (The Morgan
Kaufmann Series in Computer Architecture and Design)</p>
</aside>
</section>
</section>


      </div>
      <div class="bottomnav" role="navigation" aria-label="bottom navigation">
      
        <p>
        «&#160;&#160;<a href="backendstructure.html">Backend structure</a>
        &#160;&#160;::&#160;&#160;
        <a class="uplink" href="index.html">Contents</a>
        &#160;&#160;::&#160;&#160;
        <a href="genobj.html">Generating object files</a>&#160;&#160;»
        </p>

      </div>

    <div class="footer" role="contentinfo">
        &#169; Copyright 2016, Chen Chung-Shu.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 5.0.2.
    </div>
  </body>
</html>