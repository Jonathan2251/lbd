
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

    <title>Generating object files &#8212; Tutorial: Creating an LLVM Backend for the Cpu0 Architecture</title>
    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="_static/haiku.css" />
    <link rel="stylesheet" type="text/css" href="_static/graphviz.css" />
    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/sphinx_highlight.js"></script>
    <link rel="author" title="About these documents" href="about.html" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Global variables" href="globalvar.html" />
    <link rel="prev" title="Arithmetic and logic instructions" href="otherinst.html" /> 
  </head><body>
      <div class="header" role="banner"><h1 class="heading"><a href="index.html">
          <span>Tutorial: Creating an LLVM Backend for the Cpu0 Architecture</span></a></h1>
        <h2 class="heading"><span>Generating object files</span></h2>
      </div>
      <div class="topnav" role="navigation" aria-label="top navigation">
      
        <p>
        «&#160;&#160;<a href="otherinst.html">Arithmetic and logic instructions</a>
        &#160;&#160;::&#160;&#160;
        <a class="uplink" href="index.html">Contents</a>
        &#160;&#160;::&#160;&#160;
        <a href="globalvar.html">Global variables</a>&#160;&#160;»
        </p>

      </div>
      <div class="content" role="main">
        
        
  <section id="generating-object-files">
<span id="sec-genobjfiles"></span><h1>Generating object files<a class="headerlink" href="#generating-object-files" title="Permalink to this heading">¶</a></h1>
<nav class="contents local" id="contents">
<ul class="simple">
<li><p><a class="reference internal" href="#translate-into-obj-file" id="id4">Translate into obj file</a></p></li>
<li><p><a class="reference internal" href="#elf-obj-related-code" id="id5">ELF obj related code</a></p></li>
<li><p><a class="reference internal" href="#work-flow" id="id6">Work flow</a></p></li>
<li><p><a class="reference internal" href="#backend-target-registration-structure" id="id7">Backend Target Registration Structure</a></p></li>
</ul>
</nav>
<p>The previous chapters introducing the assembly code generation only.
This chapter adding the elf obj support and verify the generated obj by
objdump utility. With LLVM support, the Cpu0 backend can generate both big
endian and little endian obj files with only a few code added.
The Target Registration mechanism and their structure are introduced in
this chapter.</p>
<section id="translate-into-obj-file">
<h2><a class="toc-backref" href="#id4" role="doc-backlink">Translate into obj file</a><a class="headerlink" href="#translate-into-obj-file" title="Permalink to this heading">¶</a></h2>
<p>Currently, we only support translation of llvm IR code into assembly code.
If you try running Chapter4_2/ to translate it into obj code will get the error
message as follows,</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">bin$ pwd</span>
<span class="gp">$</span>HOME/llvm/test/build/bin/
<span class="go">bin$ llc -march=cpu0 -relocation-model=pic -filetype=obj ch4_1_math_math.bc -o</span>
<span class="go">ch4_1_math.cpu0.o</span>
<span class="go">~/llvm/test/build/bin/llc: target does not</span>
<span class="go">support generation of this file type!</span>
</pre></div>
</div>
<p>Chapter5_1/ support obj file generation.
It produces obj files both for big endian and little endian with command
<code class="docutils literal notranslate"><span class="pre">llc</span> <span class="pre">-march=cpu0</span></code> and <code class="docutils literal notranslate"><span class="pre">llc</span> <span class="pre">-march=cpu0el</span></code>, respectively.
Run with them will get the obj files as follows,</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">input$ cat ch4_1_math.cpu0.s</span>
<span class="go">...</span>
<span class="go">  .set  nomacro</span>
<span class="gp"># </span>BB#0:<span class="w">                                 </span><span class="c1"># %entry</span>
<span class="go">  addiu $sp, $sp, -40</span>
<span class="gp">$</span>tmp1:
<span class="go">  .cfi_def_cfa_offset 40</span>
<span class="go">  addiu $2, $zero, 5</span>
<span class="go">  st  $2, 36($fp)</span>
<span class="go">  addiu $2, $zero, 2</span>
<span class="go">  st  $2, 32($fp)</span>
<span class="go">  addiu $2, $zero, 0</span>
<span class="go">  st  $2, 28($fp)</span>
<span class="go">...</span>

<span class="go">bin$ pwd</span>
<span class="gp">$</span>HOME/llvm/test/build/bin/
<span class="go">bin$ llc -march=cpu0 -relocation-model=pic -filetype=obj ch4_1_math.bc -o</span>
<span class="go">ch4_1_math.cpu0.o</span>
<span class="go">input$ objdump -s ch4_1_math.cpu0.o</span>

<span class="go">ch4_1_math.cpu0.o:     file format elf32-big</span>

<span class="go">Contents of section .text:</span>
<span class="go"> 0000 09ddffc8 09200005 022d0034 09200002  ..... ...-.4. ..</span>
<span class="go"> 0010 022d0030 0920fffb 022d002c 012d0030  .-.0. ...-.,.-.0</span>
<span class="go"> 0020 013d0034 11232000 022d0028 012d0030  .=.4.# ..-.(.-.0</span>
<span class="go"> 0030 013d0034 12232000 022d0024 012d0030  .=.4.# ..-.$.-.0</span>
<span class="go"> 0040 013d0034 17232000 022d0020 012d0034  .=.4.# ..-. .-.4</span>
<span class="go"> 0050 1e220002 022d001c 012d002c 1e220001  .&quot;...-...-.,.&quot;..</span>
<span class="go"> 0060 022d000c 012d0034 1d220002 022d0018  .-...-.4.&quot;...-..</span>
<span class="go"> 0070 012d002c 1f22001e 022d0008 09200001  .-.,.&quot;...-... ..</span>
<span class="go"> 0080 013d0034 21323000 023d0014 013d0030  .=.4!20..=...=.0</span>
<span class="go"> 0090 21223000 022d0004 09200080 013d0034  !&quot;0..-... ...=.4</span>
<span class="go"> 00a0 22223000 022d0010 012d0034 013d0030  &quot;&quot;0..-...-.4.=.0</span>
<span class="go"> 00b0 20232000 022d0000 09dd0038 3ce00000   # ..-.....8&lt;...</span>

<span class="go">input$ ~/llvm/test/</span>
<span class="go">build/bin/llc -march=cpu0el -relocation-model=pic -filetype=obj</span>
<span class="go">ch4_1_math.bc -o ch4_1_math.cpu0el.o</span>
<span class="go">input$ objdump -s ch4_1_math.cpu0el.o</span>

<span class="go">ch4_1_math.cpu0el.o:     file format elf32-little</span>

<span class="go">Contents of section .text:</span>
<span class="go"> 0000 c8ffdd09 05002009 34002d02 02002009  ...... .4.-... .</span>
<span class="go"> 0010 30002d02 fbff2009 2c002d02 30002d01  0.-... .,.-.0.-.</span>
<span class="go"> 0020 34003d01 00202311 28002d02 30002d01  4.=.. #.(.-.0.-.</span>
<span class="go"> 0030 34003d01 00202312 24002d02 30002d01  4.=.. #.$.-.0.-.</span>
<span class="go"> 0040 34003d01 00202317 20002d02 34002d01  4.=.. #. .-.4.-.</span>
<span class="go"> 0050 0200221e 1c002d02 2c002d01 0100221e  ..&quot;...-.,.-...&quot;.</span>
<span class="go"> 0060 0c002d02 34002d01 0200221d 18002d02  ..-.4.-...&quot;...-.</span>
<span class="go"> 0070 2c002d01 1e00221f 08002d02 01002009  ,.-...&quot;...-... .</span>
<span class="go"> 0080 34003d01 00303221 14003d02 30003d01  4.=..02!..=.0.=.</span>
<span class="go"> 0090 00302221 04002d02 80002009 34003d01  .0&quot;!..-... .4.=.</span>
<span class="go"> 00a0 00302222 10002d02 34002d01 30003d01  .0&quot;&quot;..-.4.-.0.=.</span>
<span class="go"> 00b0 00202320 00002d02 3800dd09 0000e03c  . # ..-.8......&lt;</span>
</pre></div>
</div>
<p>The first instruction is <strong>“addiu  $sp, -56”</strong> and its corresponding obj is
0x09ddffc8.
The opcode of addiu is 0x09, 8 bits; $sp register number is 13(0xd), 4bits; and
the immediate is 16 bits -56(=0xffc8), so it is correct.
The third instruction <strong>“st  $2, 52($fp)”</strong> and it’s corresponding obj
is 0x022b0034. The <strong>st</strong> opcode is <strong>0x02</strong>, $2 is 0x2, $fp is 0xb and
immediate is 52(0x0034).
Thanks to Cpu0 instruction format which opcode, register operand and
offset(imediate value) size are multiple of 4 bits.
Base on the 4 bits multiple, the obj format is easy to check by eyes.
The big endian (B0, B1, B2, B3) = (09, dd, ff, c8), objdump from B0 to B3 is
0x09ddffc8 and the little endian is (B3, B2, B1, B0) = (09, dd, ff, c8),
objdump from B0 to B3 is 0xc8ffdd09.</p>
</section>
<section id="elf-obj-related-code">
<h2><a class="toc-backref" href="#id5" role="doc-backlink">ELF obj related code</a><a class="headerlink" href="#elf-obj-related-code" title="Permalink to this heading">¶</a></h2>
<p>To support elf obj generation, the following code changed and added to
Chapter5_1.</p>
<p class="rubric">lbdex/chapters/Chapter5_1/InstPrinter/Cpu0InstPrinter.cpp</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#include &quot;MCTargetDesc/Cpu0MCExpr.h&quot;</span>
</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter5_1/MCTargetDesc/CMakeLists.txt</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>  <span class="n">Cpu0AsmBackend</span><span class="o">.</span><span class="n">cpp</span>
  <span class="n">Cpu0MCCodeEmitter</span><span class="o">.</span><span class="n">cpp</span>
  <span class="n">Cpu0MCExpr</span><span class="o">.</span><span class="n">cpp</span>
  <span class="n">Cpu0ELFObjectWriter</span><span class="o">.</span><span class="n">cpp</span>
  <span class="n">Cpu0TargetStreamer</span><span class="o">.</span><span class="n">cpp</span>
</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter5_1/MCTargetDesc/Cpu0AsmBackend.h</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>//===-- Cpu0AsmBackend.h - Cpu0 Asm Backend  ------------------------------===//
//
//                     The LLVM Compiler Infrastructure
//
// This file is distributed under the University of Illinois Open Source
// License. See LICENSE.TXT for details.
//
//===----------------------------------------------------------------------===//
//
// This file defines the Cpu0AsmBackend class.
//
//===----------------------------------------------------------------------===//
//

#ifndef LLVM_LIB_TARGET_CPU0_MCTARGETDESC_CPU0ASMBACKEND_H
#define LLVM_LIB_TARGET_CPU0_MCTARGETDESC_CPU0ASMBACKEND_H

#include &quot;Cpu0Config.h&quot;

#include &quot;MCTargetDesc/Cpu0FixupKinds.h&quot;
#include &quot;llvm/ADT/Triple.h&quot;
#include &quot;llvm/MC/MCAsmBackend.h&quot;

namespace llvm {

class MCAssembler;
struct MCFixupKindInfo;
class Target;
class MCObjectWriter;

class Cpu0AsmBackend : public MCAsmBackend {
  Triple TheTriple;

public:
  Cpu0AsmBackend(const Target &amp;T, const Triple &amp;TT)
      : MCAsmBackend(TT.isLittleEndian() ? support::little : support::big),
        TheTriple(TT) {}

  std::unique_ptr&lt;MCObjectTargetWriter&gt;
  createObjectTargetWriter() const override;

  void applyFixup(const MCAssembler &amp;Asm, const MCFixup &amp;Fixup,
                  const MCValue &amp;Target, MutableArrayRef&lt;char&gt; Data,
                  uint64_t Value, bool IsResolved,
                  const MCSubtargetInfo *STI) const override;

  const MCFixupKindInfo &amp;getFixupKindInfo(MCFixupKind Kind) const override;

  unsigned getNumFixupKinds() const override {
    return Cpu0::NumTargetFixupKinds;
  }

  /// @name Target Relaxation Interfaces
  /// @{

  /// MayNeedRelaxation - Check whether the given instruction may need
  /// relaxation.
  ///
  /// \param Inst - The instruction to test.
  bool mayNeedRelaxation(const MCInst &amp;Inst,
                         const MCSubtargetInfo &amp;STI) const override {
    return false;
  }

  /// fixupNeedsRelaxation - Target specific predicate for whether a given
  /// fixup requires the associated instruction to be relaxed.
   bool fixupNeedsRelaxation(const MCFixup &amp;Fixup, uint64_t Value,
                             const MCRelaxableFragment *DF,
                             const MCAsmLayout &amp;Layout) const override {
    // FIXME.
    llvm_unreachable(&quot;RelaxInstruction() unimplemented&quot;);
    return false;
  }

  /// @}

  bool writeNopData(raw_ostream &amp;OS, uint64_t Count) const override;
}; // class Cpu0AsmBackend

} // namespace

#endif

</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter5_1/MCTargetDesc/Cpu0AsmBackend.cpp</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>//===-- Cpu0AsmBackend.cpp - Cpu0 Asm Backend  ----------------------------===//
//
//                     The LLVM Compiler Infrastructure
//
// This file is distributed under the University of Illinois Open Source
// License. See LICENSE.TXT for details.
//
//===----------------------------------------------------------------------===//
//
// This file implements the Cpu0AsmBackend class.
//
//===----------------------------------------------------------------------===//
//

#include &quot;MCTargetDesc/Cpu0FixupKinds.h&quot;
#include &quot;MCTargetDesc/Cpu0AsmBackend.h&quot;

#include &quot;MCTargetDesc/Cpu0MCTargetDesc.h&quot;
#include &quot;llvm/MC/MCAsmBackend.h&quot;
#include &quot;llvm/MC/MCAssembler.h&quot;
#include &quot;llvm/MC/MCDirectives.h&quot;
#include &quot;llvm/MC/MCELFObjectWriter.h&quot;
#include &quot;llvm/MC/MCFixupKindInfo.h&quot;
#include &quot;llvm/MC/MCObjectWriter.h&quot;
#include &quot;llvm/MC/MCSubtargetInfo.h&quot;
#include &quot;llvm/Support/CommandLine.h&quot;
#include &quot;llvm/Support/ErrorHandling.h&quot;
#include &quot;llvm/Support/raw_ostream.h&quot;

using namespace llvm;

static cl::opt&lt;bool&gt; HasLLD(
  &quot;has-lld&quot;,
  cl::init(false),
  cl::desc(&quot;CPU0: Has lld linker for Cpu0.&quot;),
  cl::Hidden);

//@adjustFixupValue {
// Prepare value for the target space for it
static unsigned adjustFixupValue(const MCFixup &amp;Fixup, uint64_t Value,
                                 MCContext &amp;Ctx) {

  unsigned Kind = Fixup.getKind();

  // Add/subtract and shift
  switch (Kind) {
  default:
    return 0;
  case FK_GPRel_4:
  case FK_Data_4:
  case Cpu0::fixup_Cpu0_LO16:
    break;
  case Cpu0::fixup_Cpu0_HI16:
  case Cpu0::fixup_Cpu0_GOT:
    // Get the higher 16-bits. Also add 1 if bit 15 is 1.
    Value = (Value &gt;&gt; 16) &amp; 0xffff;
    break;
  }

  return Value;
}
//@adjustFixupValue }

std::unique_ptr&lt;MCObjectTargetWriter&gt;
Cpu0AsmBackend::createObjectTargetWriter() const {
  return createCpu0ELFObjectWriter(TheTriple);
}

/// ApplyFixup - Apply the \p Value for given \p Fixup into the provided
/// data fragment, at the offset specified by the fixup and following the
/// fixup kind as appropriate.
void Cpu0AsmBackend::applyFixup(const MCAssembler &amp;Asm, const MCFixup &amp;Fixup,
                                const MCValue &amp;Target,
                                MutableArrayRef&lt;char&gt; Data, uint64_t Value,
                                bool IsResolved,
                                const MCSubtargetInfo *STI) const {
  MCFixupKind Kind = Fixup.getKind();
  MCContext &amp;Ctx = Asm.getContext();
  Value = adjustFixupValue(Fixup, Value, Ctx);

  if (!Value)
    return; // Doesn&#39;t change encoding.

  // Where do we start in the object
  unsigned Offset = Fixup.getOffset();
  // Number of bytes we need to fixup
  unsigned NumBytes = (getFixupKindInfo(Kind).TargetSize + 7) / 8;
  // Used to point to big endian bytes
  unsigned FullSize;

  switch ((unsigned)Kind) {
  default:
    FullSize = 4;
    break;
  }

  // Grab current value, if any, from bits.
  uint64_t CurVal = 0;

  for (unsigned i = 0; i != NumBytes; ++i) {
    unsigned Idx = TheTriple.isLittleEndian() ? i : (FullSize - 1 - i);
    CurVal |= (uint64_t)((uint8_t)Data[Offset + Idx]) &lt;&lt; (i*8);
  }

  uint64_t Mask = ((uint64_t)(-1) &gt;&gt;
                    (64 - getFixupKindInfo(Kind).TargetSize));
  CurVal |= Value &amp; Mask;

  // Write out the fixed up bytes back to the code/data bits.
  for (unsigned i = 0; i != NumBytes; ++i) {
    unsigned Idx = TheTriple.isLittleEndian() ? i : (FullSize - 1 - i);
    Data[Offset + Idx] = (uint8_t)((CurVal &gt;&gt; (i*8)) &amp; 0xff);
  }
}

//@getFixupKindInfo {
const MCFixupKindInfo &amp;Cpu0AsmBackend::
getFixupKindInfo(MCFixupKind Kind) const {
  unsigned JSUBReloRec = 0;
  if (HasLLD) {
    JSUBReloRec = MCFixupKindInfo::FKF_IsPCRel;
  }
  else {
    JSUBReloRec = MCFixupKindInfo::FKF_IsPCRel | MCFixupKindInfo::FKF_Constant;
  }
  const static MCFixupKindInfo Infos[Cpu0::NumTargetFixupKinds] = {
    // This table *must* be in same the order of fixup_* kinds in
    // Cpu0FixupKinds.h.
    //
    // name                        offset  bits  flags
    { &quot;fixup_Cpu0_32&quot;,             0,     32,   0 },
    { &quot;fixup_Cpu0_HI16&quot;,           0,     16,   0 },
    { &quot;fixup_Cpu0_LO16&quot;,           0,     16,   0 },
    { &quot;fixup_Cpu0_GPREL16&quot;,        0,     16,   0 },
    { &quot;fixup_Cpu0_GOT&quot;,            0,     16,   0 },
    { &quot;fixup_Cpu0_GOT_HI16&quot;,       0,     16,   0 },
    { &quot;fixup_Cpu0_GOT_LO16&quot;,       0,     16,   0 }
  };

  if (Kind &lt; FirstTargetFixupKind)
    return MCAsmBackend::getFixupKindInfo(Kind);

  assert(unsigned(Kind - FirstTargetFixupKind) &lt; getNumFixupKinds() &amp;&amp;
         &quot;Invalid kind!&quot;);
  return Infos[Kind - FirstTargetFixupKind];
}
//@getFixupKindInfo }

/// WriteNopData - Write an (optimal) nop sequence of Count bytes
/// to the given output. If the target cannot generate such a sequence,
/// it should return an error.
///
/// \return - True on success.
bool Cpu0AsmBackend::writeNopData(raw_ostream &amp;OS, uint64_t Count) const {
  return true;
}

// MCAsmBackend
MCAsmBackend *llvm::createCpu0AsmBackend(const Target &amp;T,
                                         const MCSubtargetInfo &amp;STI,
                                         const MCRegisterInfo &amp;MRI,
                                         const MCTargetOptions &amp;Options) {
  return new Cpu0AsmBackend(T, STI.getTargetTriple());
}

</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter5_1/MCTargetDesc/Cpu0BaseInfo.h</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#include &quot;Cpu0FixupKinds.h&quot;</span>
</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter5_1/MCTargetDesc/Cpu0ELFObjectWriter.cpp</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//===--</span> <span class="n">Cpu0ELFObjectWriter</span><span class="o">.</span><span class="n">cpp</span> <span class="o">-</span> <span class="n">Cpu0</span> <span class="n">ELF</span> <span class="n">Writer</span> <span class="o">-------------------------===//</span>
<span class="o">//</span>
<span class="o">//</span>                     <span class="n">The</span> <span class="n">LLVM</span> <span class="n">Compiler</span> <span class="n">Infrastructure</span>
<span class="o">//</span>
<span class="o">//</span> <span class="n">This</span> <span class="n">file</span> <span class="ow">is</span> <span class="n">distributed</span> <span class="n">under</span> <span class="n">the</span> <span class="n">University</span> <span class="n">of</span> <span class="n">Illinois</span> <span class="n">Open</span> <span class="n">Source</span>
<span class="o">//</span> <span class="n">License</span><span class="o">.</span> <span class="n">See</span> <span class="n">LICENSE</span><span class="o">.</span><span class="n">TXT</span> <span class="k">for</span> <span class="n">details</span><span class="o">.</span>
<span class="o">//</span>
<span class="o">//===----------------------------------------------------------------------===//</span>

<span class="c1">#include &quot;Cpu0Config.h&quot;</span>

<span class="c1">#include &quot;MCTargetDesc/Cpu0BaseInfo.h&quot;</span>
<span class="c1">#include &quot;MCTargetDesc/Cpu0FixupKinds.h&quot;</span>
<span class="c1">#include &quot;MCTargetDesc/Cpu0MCTargetDesc.h&quot;</span>
<span class="c1">#include &quot;llvm/MC/MCAssembler.h&quot;</span>
<span class="c1">#include &quot;llvm/MC/MCELFObjectWriter.h&quot;</span>
<span class="c1">#include &quot;llvm/MC/MCExpr.h&quot;</span>
<span class="c1">#include &quot;llvm/MC/MCSection.h&quot;</span>
<span class="c1">#include &quot;llvm/MC/MCValue.h&quot;</span>
<span class="c1">#include &quot;llvm/Support/ErrorHandling.h&quot;</span>
<span class="c1">#include &lt;list&gt;</span>

<span class="n">using</span> <span class="n">namespace</span> <span class="n">llvm</span><span class="p">;</span>

<span class="n">namespace</span> <span class="p">{</span>
  <span class="k">class</span> <span class="nc">Cpu0ELFObjectWriter</span> <span class="p">:</span> <span class="n">public</span> <span class="n">MCELFObjectTargetWriter</span> <span class="p">{</span>
  <span class="n">public</span><span class="p">:</span>
    <span class="n">Cpu0ELFObjectWriter</span><span class="p">(</span><span class="n">uint8_t</span> <span class="n">OSABI</span><span class="p">,</span> <span class="nb">bool</span> <span class="n">HasRelocationAddend</span><span class="p">,</span> <span class="nb">bool</span> <span class="n">Is64</span><span class="p">);</span>

	<span class="o">~</span><span class="n">Cpu0ELFObjectWriter</span><span class="p">()</span> <span class="o">=</span> <span class="n">default</span><span class="p">;</span>

    <span class="n">unsigned</span> <span class="n">getRelocType</span><span class="p">(</span><span class="n">MCContext</span> <span class="o">&amp;</span><span class="n">Ctx</span><span class="p">,</span> <span class="n">const</span> <span class="n">MCValue</span> <span class="o">&amp;</span><span class="n">Target</span><span class="p">,</span>
                        <span class="n">const</span> <span class="n">MCFixup</span> <span class="o">&amp;</span><span class="n">Fixup</span><span class="p">,</span> <span class="nb">bool</span> <span class="n">IsPCRel</span><span class="p">)</span> <span class="n">const</span> <span class="n">override</span><span class="p">;</span>
    <span class="nb">bool</span> <span class="n">needsRelocateWithSymbol</span><span class="p">(</span><span class="n">const</span> <span class="n">MCSymbol</span> <span class="o">&amp;</span><span class="n">Sym</span><span class="p">,</span>
                                 <span class="n">unsigned</span> <span class="n">Type</span><span class="p">)</span> <span class="n">const</span> <span class="n">override</span><span class="p">;</span>
  <span class="p">};</span>
<span class="p">}</span>

<span class="n">Cpu0ELFObjectWriter</span><span class="p">::</span><span class="n">Cpu0ELFObjectWriter</span><span class="p">(</span><span class="n">uint8_t</span> <span class="n">OSABI</span><span class="p">,</span>
                                         <span class="nb">bool</span> <span class="n">HasRelocationAddend</span><span class="p">,</span> <span class="nb">bool</span> <span class="n">Is64</span><span class="p">)</span>
    <span class="p">:</span> <span class="n">MCELFObjectTargetWriter</span><span class="p">(</span><span class="o">/*</span><span class="n">Is64Bit_</span><span class="o">=</span><span class="n">false</span><span class="o">*/</span> <span class="n">Is64</span><span class="p">,</span> <span class="n">OSABI</span><span class="p">,</span> <span class="n">ELF</span><span class="p">::</span><span class="n">EM_CPU0</span><span class="p">,</span>
          <span class="o">/*</span><span class="n">HasRelocationAddend_</span> <span class="o">=</span> <span class="n">false</span><span class="o">*/</span> <span class="n">HasRelocationAddend</span><span class="p">)</span> <span class="p">{}</span>

<span class="o">//</span><span class="nd">@GetRelocType</span> <span class="p">{</span>
<span class="n">unsigned</span> <span class="n">Cpu0ELFObjectWriter</span><span class="p">::</span><span class="n">getRelocType</span><span class="p">(</span><span class="n">MCContext</span> <span class="o">&amp;</span><span class="n">Ctx</span><span class="p">,</span>
                                           <span class="n">const</span> <span class="n">MCValue</span> <span class="o">&amp;</span><span class="n">Target</span><span class="p">,</span>
                                           <span class="n">const</span> <span class="n">MCFixup</span> <span class="o">&amp;</span><span class="n">Fixup</span><span class="p">,</span>
                                           <span class="nb">bool</span> <span class="n">IsPCRel</span><span class="p">)</span> <span class="n">const</span> <span class="p">{</span>
  <span class="o">//</span> <span class="n">determine</span> <span class="n">the</span> <span class="nb">type</span> <span class="n">of</span> <span class="n">the</span> <span class="n">relocation</span>
  <span class="n">unsigned</span> <span class="n">Type</span> <span class="o">=</span> <span class="p">(</span><span class="n">unsigned</span><span class="p">)</span><span class="n">ELF</span><span class="p">::</span><span class="n">R_CPU0_NONE</span><span class="p">;</span>
  <span class="n">unsigned</span> <span class="n">Kind</span> <span class="o">=</span> <span class="p">(</span><span class="n">unsigned</span><span class="p">)</span><span class="n">Fixup</span><span class="o">.</span><span class="n">getKind</span><span class="p">();</span>

  <span class="n">switch</span> <span class="p">(</span><span class="n">Kind</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">default</span><span class="p">:</span>
    <span class="n">llvm_unreachable</span><span class="p">(</span><span class="s2">&quot;invalid fixup kind!&quot;</span><span class="p">);</span>
  <span class="k">case</span> <span class="n">FK_Data_4</span><span class="p">:</span>
    <span class="n">Type</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">::</span><span class="n">R_CPU0_32</span><span class="p">;</span>
    <span class="k">break</span><span class="p">;</span>
  <span class="k">case</span> <span class="n">Cpu0</span><span class="p">::</span><span class="n">fixup_Cpu0_32</span><span class="p">:</span>
    <span class="n">Type</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">::</span><span class="n">R_CPU0_32</span><span class="p">;</span>
    <span class="k">break</span><span class="p">;</span>
  <span class="k">case</span> <span class="n">Cpu0</span><span class="p">::</span><span class="n">fixup_Cpu0_GPREL16</span><span class="p">:</span>
    <span class="n">Type</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">::</span><span class="n">R_CPU0_GPREL16</span><span class="p">;</span>
    <span class="k">break</span><span class="p">;</span>
  <span class="k">case</span> <span class="n">Cpu0</span><span class="p">::</span><span class="n">fixup_Cpu0_GOT</span><span class="p">:</span>
    <span class="n">Type</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">::</span><span class="n">R_CPU0_GOT16</span><span class="p">;</span>
    <span class="k">break</span><span class="p">;</span>
  <span class="k">case</span> <span class="n">Cpu0</span><span class="p">::</span><span class="n">fixup_Cpu0_HI16</span><span class="p">:</span>
    <span class="n">Type</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">::</span><span class="n">R_CPU0_HI16</span><span class="p">;</span>
    <span class="k">break</span><span class="p">;</span>
  <span class="k">case</span> <span class="n">Cpu0</span><span class="p">::</span><span class="n">fixup_Cpu0_LO16</span><span class="p">:</span>
    <span class="n">Type</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">::</span><span class="n">R_CPU0_LO16</span><span class="p">;</span>
    <span class="k">break</span><span class="p">;</span>
  <span class="k">case</span> <span class="n">Cpu0</span><span class="p">::</span><span class="n">fixup_Cpu0_GOT_HI16</span><span class="p">:</span>
    <span class="n">Type</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">::</span><span class="n">R_CPU0_GOT_HI16</span><span class="p">;</span>
    <span class="k">break</span><span class="p">;</span>
  <span class="k">case</span> <span class="n">Cpu0</span><span class="p">::</span><span class="n">fixup_Cpu0_GOT_LO16</span><span class="p">:</span>
    <span class="n">Type</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">::</span><span class="n">R_CPU0_GOT_LO16</span><span class="p">;</span>
    <span class="k">break</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="n">Type</span><span class="p">;</span>
<span class="p">}</span>
<span class="o">//</span><span class="nd">@GetRelocType</span> <span class="p">}</span>

<span class="nb">bool</span>
<span class="n">Cpu0ELFObjectWriter</span><span class="p">::</span><span class="n">needsRelocateWithSymbol</span><span class="p">(</span><span class="n">const</span> <span class="n">MCSymbol</span> <span class="o">&amp;</span><span class="n">Sym</span><span class="p">,</span>
                                             <span class="n">unsigned</span> <span class="n">Type</span><span class="p">)</span> <span class="n">const</span> <span class="p">{</span>
  <span class="o">//</span> <span class="n">FIXME</span><span class="p">:</span> <span class="n">This</span> <span class="ow">is</span> <span class="n">extremelly</span> <span class="n">conservative</span><span class="o">.</span> <span class="n">This</span> <span class="n">really</span> <span class="n">needs</span> <span class="n">to</span> <span class="n">use</span> <span class="n">a</span>
  <span class="o">//</span> <span class="n">whitelist</span> <span class="k">with</span> <span class="n">a</span> <span class="n">clear</span> <span class="n">explanation</span> <span class="k">for</span> <span class="n">why</span> <span class="n">each</span> <span class="n">realocation</span> <span class="n">needs</span> <span class="n">to</span>
  <span class="o">//</span> <span class="n">point</span> <span class="n">to</span> <span class="n">the</span> <span class="n">symbol</span><span class="p">,</span> <span class="ow">not</span> <span class="n">to</span> <span class="n">the</span> <span class="n">section</span><span class="o">.</span>
  <span class="n">switch</span> <span class="p">(</span><span class="n">Type</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">default</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">true</span><span class="p">;</span>

  <span class="k">case</span> <span class="n">ELF</span><span class="p">::</span><span class="n">R_CPU0_GOT16</span><span class="p">:</span>
  <span class="o">//</span> <span class="n">For</span> <span class="n">Cpu0</span> <span class="n">pic</span> <span class="n">mode</span><span class="p">,</span> <span class="n">I</span> <span class="n">think</span> <span class="n">it</span><span class="s1">&#39;s OK to return true but I didn&#39;</span><span class="n">t</span> <span class="n">confirm</span><span class="o">.</span>
  <span class="o">//</span>  <span class="n">llvm_unreachable</span><span class="p">(</span><span class="s2">&quot;Should have been handled already&quot;</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">true</span><span class="p">;</span>

  <span class="o">//</span> <span class="n">These</span> <span class="n">relocations</span> <span class="n">might</span> <span class="n">be</span> <span class="n">paired</span> <span class="k">with</span> <span class="n">another</span> <span class="n">relocation</span><span class="o">.</span> <span class="n">The</span> <span class="n">pairing</span> <span class="ow">is</span>
  <span class="o">//</span> <span class="n">done</span> <span class="n">by</span> <span class="n">the</span> <span class="n">static</span> <span class="n">linker</span> <span class="n">by</span> <span class="n">matching</span> <span class="n">the</span> <span class="n">symbol</span><span class="o">.</span> <span class="n">Since</span> <span class="n">we</span> <span class="n">only</span> <span class="n">see</span> <span class="n">one</span>
  <span class="o">//</span> <span class="n">relocation</span> <span class="n">at</span> <span class="n">a</span> <span class="n">time</span><span class="p">,</span> <span class="n">we</span> <span class="n">have</span> <span class="n">to</span> <span class="n">force</span> <span class="n">them</span> <span class="n">to</span> <span class="n">relocate</span> <span class="k">with</span> <span class="n">a</span> <span class="n">symbol</span> <span class="n">to</span>
  <span class="o">//</span> <span class="n">avoid</span> <span class="n">ending</span> <span class="n">up</span> <span class="k">with</span> <span class="n">a</span> <span class="n">pair</span> <span class="n">where</span> <span class="n">one</span> <span class="n">points</span> <span class="n">to</span> <span class="n">a</span> <span class="n">section</span> <span class="ow">and</span> <span class="n">another</span>
  <span class="o">//</span> <span class="n">points</span> <span class="n">to</span> <span class="n">a</span> <span class="n">symbol</span><span class="o">.</span>
  <span class="k">case</span> <span class="n">ELF</span><span class="p">::</span><span class="n">R_CPU0_HI16</span><span class="p">:</span>
  <span class="k">case</span> <span class="n">ELF</span><span class="p">::</span><span class="n">R_CPU0_LO16</span><span class="p">:</span>
  <span class="o">//</span> <span class="n">R_CPU0_32</span> <span class="n">should</span> <span class="n">be</span> <span class="n">a</span> <span class="n">relocation</span> <span class="n">record</span><span class="p">,</span> <span class="n">I</span> <span class="n">don</span><span class="s1">&#39;t know why Mips set it to </span>
  <span class="o">//</span> <span class="n">false</span><span class="o">.</span>
  <span class="k">case</span> <span class="n">ELF</span><span class="p">::</span><span class="n">R_CPU0_32</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">true</span><span class="p">;</span>

  <span class="k">case</span> <span class="n">ELF</span><span class="p">::</span><span class="n">R_CPU0_GPREL16</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">false</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="n">std</span><span class="p">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">MCObjectTargetWriter</span><span class="o">&gt;</span> 
<span class="n">llvm</span><span class="p">::</span><span class="n">createCpu0ELFObjectWriter</span><span class="p">(</span><span class="n">const</span> <span class="n">Triple</span> <span class="o">&amp;</span><span class="n">TT</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">uint8_t</span> <span class="n">OSABI</span> <span class="o">=</span> <span class="n">MCELFObjectTargetWriter</span><span class="p">::</span><span class="n">getOSABI</span><span class="p">(</span><span class="n">TT</span><span class="o">.</span><span class="n">getOS</span><span class="p">());</span>
  <span class="nb">bool</span> <span class="n">IsN64</span> <span class="o">=</span> <span class="n">false</span><span class="p">;</span>
  <span class="nb">bool</span> <span class="n">HasRelocationAddend</span> <span class="o">=</span> <span class="n">TT</span><span class="o">.</span><span class="n">isArch64Bit</span><span class="p">();</span>
  <span class="k">return</span> <span class="n">std</span><span class="p">::</span><span class="n">make_unique</span><span class="o">&lt;</span><span class="n">Cpu0ELFObjectWriter</span><span class="o">&gt;</span><span class="p">(</span><span class="n">OSABI</span><span class="p">,</span> <span class="n">HasRelocationAddend</span><span class="p">,</span>
                                               <span class="n">IsN64</span><span class="p">);</span>
<span class="p">}</span>

</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter5_1/MCTargetDesc/Cpu0FixupKinds.h</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//===--</span> <span class="n">Cpu0FixupKinds</span><span class="o">.</span><span class="n">h</span> <span class="o">-</span> <span class="n">Cpu0</span> <span class="n">Specific</span> <span class="n">Fixup</span> <span class="n">Entries</span> <span class="o">----------*-</span> <span class="n">C</span><span class="o">++</span> <span class="o">-*-===//</span>
<span class="o">//</span>
<span class="o">//</span>                     <span class="n">The</span> <span class="n">LLVM</span> <span class="n">Compiler</span> <span class="n">Infrastructure</span>
<span class="o">//</span>
<span class="o">//</span> <span class="n">This</span> <span class="n">file</span> <span class="ow">is</span> <span class="n">distributed</span> <span class="n">under</span> <span class="n">the</span> <span class="n">University</span> <span class="n">of</span> <span class="n">Illinois</span> <span class="n">Open</span> <span class="n">Source</span>
<span class="o">//</span> <span class="n">License</span><span class="o">.</span> <span class="n">See</span> <span class="n">LICENSE</span><span class="o">.</span><span class="n">TXT</span> <span class="k">for</span> <span class="n">details</span><span class="o">.</span>
<span class="o">//</span>
<span class="o">//===----------------------------------------------------------------------===//</span>

<span class="c1">#ifndef LLVM_LIB_TARGET_CPU0_MCTARGETDESC_CPU0FIXUPKINDS_H</span>
<span class="c1">#define LLVM_LIB_TARGET_CPU0_MCTARGETDESC_CPU0FIXUPKINDS_H</span>

<span class="c1">#include &quot;Cpu0Config.h&quot;</span>

<span class="c1">#include &quot;llvm/MC/MCFixup.h&quot;</span>

<span class="n">namespace</span> <span class="n">llvm</span> <span class="p">{</span>
<span class="n">namespace</span> <span class="n">Cpu0</span> <span class="p">{</span>
  <span class="o">//</span> <span class="n">Although</span> <span class="n">most</span> <span class="n">of</span> <span class="n">the</span> <span class="n">current</span> <span class="n">fixup</span> <span class="n">types</span> <span class="n">reflect</span> <span class="n">a</span> <span class="n">unique</span> <span class="n">relocation</span>
  <span class="o">//</span> <span class="n">one</span> <span class="n">can</span> <span class="n">have</span> <span class="n">multiple</span> <span class="n">fixup</span> <span class="n">types</span> <span class="k">for</span> <span class="n">a</span> <span class="n">given</span> <span class="n">relocation</span> <span class="ow">and</span> <span class="n">thus</span> <span class="n">need</span>
  <span class="o">//</span> <span class="n">to</span> <span class="n">be</span> <span class="n">uniquely</span> <span class="n">named</span><span class="o">.</span>
  <span class="o">//</span>
  <span class="o">//</span> <span class="n">This</span> <span class="n">table</span> <span class="o">*</span><span class="n">must</span><span class="o">*</span> <span class="n">be</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">save</span> <span class="n">order</span> <span class="n">of</span>
  <span class="o">//</span> <span class="n">MCFixupKindInfo</span> <span class="n">Infos</span><span class="p">[</span><span class="n">Cpu0</span><span class="p">::</span><span class="n">NumTargetFixupKinds</span><span class="p">]</span>
  <span class="o">//</span> <span class="ow">in</span> <span class="n">Cpu0AsmBackend</span><span class="o">.</span><span class="n">cpp</span><span class="o">.</span>
  <span class="o">//</span><span class="nd">@Fixups</span> <span class="p">{</span>
  <span class="n">enum</span> <span class="n">Fixups</span> <span class="p">{</span>
    <span class="o">//@</span> <span class="n">Pure</span> <span class="n">upper</span> <span class="mi">32</span> <span class="n">bit</span> <span class="n">fixup</span> <span class="n">resulting</span> <span class="ow">in</span> <span class="o">-</span> <span class="n">R_CPU0_32</span><span class="o">.</span>
    <span class="n">fixup_Cpu0_32</span> <span class="o">=</span> <span class="n">FirstTargetFixupKind</span><span class="p">,</span>

    <span class="o">//</span> <span class="n">Pure</span> <span class="n">upper</span> <span class="mi">16</span> <span class="n">bit</span> <span class="n">fixup</span> <span class="n">resulting</span> <span class="ow">in</span> <span class="o">-</span> <span class="n">R_CPU0_HI16</span><span class="o">.</span>
    <span class="n">fixup_Cpu0_HI16</span><span class="p">,</span>

    <span class="o">//</span> <span class="n">Pure</span> <span class="n">lower</span> <span class="mi">16</span> <span class="n">bit</span> <span class="n">fixup</span> <span class="n">resulting</span> <span class="ow">in</span> <span class="o">-</span> <span class="n">R_CPU0_LO16</span><span class="o">.</span>
    <span class="n">fixup_Cpu0_LO16</span><span class="p">,</span>

    <span class="o">//</span> <span class="mi">16</span> <span class="n">bit</span> <span class="n">fixup</span> <span class="k">for</span> <span class="n">GP</span> <span class="n">offest</span> <span class="n">resulting</span> <span class="ow">in</span> <span class="o">-</span> <span class="n">R_CPU0_GPREL16</span><span class="o">.</span>
    <span class="n">fixup_Cpu0_GPREL16</span><span class="p">,</span>

    <span class="o">//</span> <span class="n">GOT</span> <span class="p">(</span><span class="n">Global</span> <span class="n">Offset</span> <span class="n">Table</span><span class="p">)</span>
    <span class="o">//</span> <span class="n">Symbol</span> <span class="n">fixup</span> <span class="n">resulting</span> <span class="ow">in</span> <span class="o">-</span> <span class="n">R_CPU0_GOT16</span><span class="o">.</span>
    <span class="n">fixup_Cpu0_GOT</span><span class="p">,</span>

    

    <span class="o">//</span> <span class="n">resulting</span> <span class="ow">in</span> <span class="o">-</span> <span class="n">R_CPU0_GOT_HI16</span>
    <span class="n">fixup_Cpu0_GOT_HI16</span><span class="p">,</span>

    <span class="o">//</span> <span class="n">resulting</span> <span class="ow">in</span> <span class="o">-</span> <span class="n">R_CPU0_GOT_LO16</span>
    <span class="n">fixup_Cpu0_GOT_LO16</span><span class="p">,</span>

    <span class="o">//</span> <span class="n">Marker</span>
    <span class="n">LastTargetFixupKind</span><span class="p">,</span>
    <span class="n">NumTargetFixupKinds</span> <span class="o">=</span> <span class="n">LastTargetFixupKind</span> <span class="o">-</span> <span class="n">FirstTargetFixupKind</span>
  <span class="p">};</span>
  <span class="o">//</span><span class="nd">@Fixups</span> <span class="p">}</span>
<span class="p">}</span> <span class="o">//</span> <span class="n">namespace</span> <span class="n">Cpu0</span>
<span class="p">}</span> <span class="o">//</span> <span class="n">namespace</span> <span class="n">llvm</span>

<span class="c1">#endif // LLVM_CPU0_CPU0FIXUPKINDS_H</span>

</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter5_1/MCTargetDesc/Cpu0MCCodeEmitter.h</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//===--</span> <span class="n">Cpu0MCCodeEmitter</span><span class="o">.</span><span class="n">h</span> <span class="o">-</span> <span class="n">Convert</span> <span class="n">Cpu0</span> <span class="n">Code</span> <span class="n">to</span> <span class="n">Machine</span> <span class="n">Code</span> <span class="o">-----------===//</span>
<span class="o">//</span>
<span class="o">//</span>                     <span class="n">The</span> <span class="n">LLVM</span> <span class="n">Compiler</span> <span class="n">Infrastructure</span>
<span class="o">//</span>
<span class="o">//</span> <span class="n">This</span> <span class="n">file</span> <span class="ow">is</span> <span class="n">distributed</span> <span class="n">under</span> <span class="n">the</span> <span class="n">University</span> <span class="n">of</span> <span class="n">Illinois</span> <span class="n">Open</span> <span class="n">Source</span>
<span class="o">//</span> <span class="n">License</span><span class="o">.</span> <span class="n">See</span> <span class="n">LICENSE</span><span class="o">.</span><span class="n">TXT</span> <span class="k">for</span> <span class="n">details</span><span class="o">.</span>
<span class="o">//</span>
<span class="o">//===----------------------------------------------------------------------===//</span>
<span class="o">//</span>
<span class="o">//</span> <span class="n">This</span> <span class="n">file</span> <span class="n">defines</span> <span class="n">the</span> <span class="n">Cpu0MCCodeEmitter</span> <span class="n">class</span><span class="o">.</span>
<span class="o">//</span>
<span class="o">//===----------------------------------------------------------------------===//</span>
<span class="o">//</span>

<span class="c1">#ifndef LLVM_LIB_TARGET_CPU0_MCTARGETDESC_CPU0MCCODEEMITTER_H</span>
<span class="c1">#define LLVM_LIB_TARGET_CPU0_MCTARGETDESC_CPU0MCCODEEMITTER_H</span>

<span class="c1">#include &quot;Cpu0Config.h&quot;</span>

<span class="c1">#include &quot;llvm/MC/MCCodeEmitter.h&quot;</span>
<span class="c1">#include &quot;llvm/Support/DataTypes.h&quot;</span>

<span class="n">using</span> <span class="n">namespace</span> <span class="n">llvm</span><span class="p">;</span>

<span class="n">namespace</span> <span class="n">llvm</span> <span class="p">{</span>
<span class="k">class</span> <span class="nc">MCContext</span><span class="p">;</span>
<span class="k">class</span> <span class="nc">MCExpr</span><span class="p">;</span>
<span class="k">class</span> <span class="nc">MCInst</span><span class="p">;</span>
<span class="k">class</span> <span class="nc">MCInstrInfo</span><span class="p">;</span>
<span class="k">class</span> <span class="nc">MCFixup</span><span class="p">;</span>
<span class="k">class</span> <span class="nc">MCOperand</span><span class="p">;</span>
<span class="k">class</span> <span class="nc">MCSubtargetInfo</span><span class="p">;</span>
<span class="k">class</span> <span class="nc">raw_ostream</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">Cpu0MCCodeEmitter</span> <span class="p">:</span> <span class="n">public</span> <span class="n">MCCodeEmitter</span> <span class="p">{</span>
  <span class="n">Cpu0MCCodeEmitter</span><span class="p">(</span><span class="n">const</span> <span class="n">Cpu0MCCodeEmitter</span> <span class="o">&amp;</span><span class="p">)</span> <span class="o">=</span> <span class="n">delete</span><span class="p">;</span>
  <span class="n">void</span> <span class="n">operator</span><span class="o">=</span><span class="p">(</span><span class="n">const</span> <span class="n">Cpu0MCCodeEmitter</span> <span class="o">&amp;</span><span class="p">)</span> <span class="o">=</span> <span class="n">delete</span><span class="p">;</span>
  <span class="n">const</span> <span class="n">MCInstrInfo</span> <span class="o">&amp;</span><span class="n">MCII</span><span class="p">;</span>
  <span class="n">MCContext</span> <span class="o">&amp;</span><span class="n">Ctx</span><span class="p">;</span>
  <span class="nb">bool</span> <span class="n">IsLittleEndian</span><span class="p">;</span>

<span class="n">public</span><span class="p">:</span>
  <span class="n">Cpu0MCCodeEmitter</span><span class="p">(</span><span class="n">const</span> <span class="n">MCInstrInfo</span> <span class="o">&amp;</span><span class="n">mcii</span><span class="p">,</span> <span class="n">MCContext</span> <span class="o">&amp;</span><span class="n">Ctx_</span><span class="p">,</span> <span class="nb">bool</span> <span class="n">IsLittle</span><span class="p">)</span>
      <span class="p">:</span> <span class="n">MCII</span><span class="p">(</span><span class="n">mcii</span><span class="p">),</span> <span class="n">Ctx</span><span class="p">(</span><span class="n">Ctx_</span><span class="p">),</span> <span class="n">IsLittleEndian</span><span class="p">(</span><span class="n">IsLittle</span><span class="p">)</span> <span class="p">{}</span>

  <span class="o">~</span><span class="n">Cpu0MCCodeEmitter</span><span class="p">()</span> <span class="n">override</span> <span class="p">{}</span>

  <span class="n">void</span> <span class="n">EmitByte</span><span class="p">(</span><span class="n">unsigned</span> <span class="n">char</span> <span class="n">C</span><span class="p">,</span> <span class="n">raw_ostream</span> <span class="o">&amp;</span><span class="n">OS</span><span class="p">)</span> <span class="n">const</span><span class="p">;</span>

  <span class="n">void</span> <span class="n">EmitInstruction</span><span class="p">(</span><span class="n">uint64_t</span> <span class="n">Val</span><span class="p">,</span> <span class="n">unsigned</span> <span class="n">Size</span><span class="p">,</span> <span class="n">raw_ostream</span> <span class="o">&amp;</span><span class="n">OS</span><span class="p">)</span> <span class="n">const</span><span class="p">;</span>

  <span class="n">void</span> <span class="n">encodeInstruction</span><span class="p">(</span><span class="n">const</span> <span class="n">MCInst</span> <span class="o">&amp;</span><span class="n">MI</span><span class="p">,</span> <span class="n">raw_ostream</span> <span class="o">&amp;</span><span class="n">OS</span><span class="p">,</span>
                         <span class="n">SmallVectorImpl</span><span class="o">&lt;</span><span class="n">MCFixup</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="n">Fixups</span><span class="p">,</span>
                         <span class="n">const</span> <span class="n">MCSubtargetInfo</span> <span class="o">&amp;</span><span class="n">STI</span><span class="p">)</span> <span class="n">const</span> <span class="n">override</span><span class="p">;</span>

  <span class="o">//</span> <span class="n">getBinaryCodeForInstr</span> <span class="o">-</span> <span class="n">TableGen</span><span class="s1">&#39;erated function for getting the</span>
  <span class="o">//</span> <span class="n">binary</span> <span class="n">encoding</span> <span class="k">for</span> <span class="n">an</span> <span class="n">instruction</span><span class="o">.</span>
  <span class="n">uint64_t</span> <span class="n">getBinaryCodeForInstr</span><span class="p">(</span><span class="n">const</span> <span class="n">MCInst</span> <span class="o">&amp;</span><span class="n">MI</span><span class="p">,</span>
                                 <span class="n">SmallVectorImpl</span><span class="o">&lt;</span><span class="n">MCFixup</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="n">Fixups</span><span class="p">,</span>
                                 <span class="n">const</span> <span class="n">MCSubtargetInfo</span> <span class="o">&amp;</span><span class="n">STI</span><span class="p">)</span> <span class="n">const</span><span class="p">;</span>

  <span class="o">//</span> <span class="n">getBranch16TargetOpValue</span> <span class="o">-</span> <span class="n">Return</span> <span class="n">binary</span> <span class="n">encoding</span> <span class="n">of</span> <span class="n">the</span> <span class="n">branch</span>
  <span class="o">//</span> <span class="n">target</span> <span class="n">operand</span><span class="p">,</span> <span class="n">such</span> <span class="k">as</span> <span class="n">BEQ</span><span class="p">,</span> <span class="n">BNE</span><span class="o">.</span> <span class="n">If</span> <span class="n">the</span> <span class="n">machine</span> <span class="n">operand</span>
  <span class="o">//</span> <span class="n">requires</span> <span class="n">relocation</span><span class="p">,</span> <span class="n">record</span> <span class="n">the</span> <span class="n">relocation</span> <span class="ow">and</span> <span class="k">return</span> <span class="n">zero</span><span class="o">.</span>
  <span class="n">unsigned</span> <span class="n">getBranch16TargetOpValue</span><span class="p">(</span><span class="n">const</span> <span class="n">MCInst</span> <span class="o">&amp;</span><span class="n">MI</span><span class="p">,</span> <span class="n">unsigned</span> <span class="n">OpNo</span><span class="p">,</span>
                                    <span class="n">SmallVectorImpl</span><span class="o">&lt;</span><span class="n">MCFixup</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="n">Fixups</span><span class="p">,</span>
                                    <span class="n">const</span> <span class="n">MCSubtargetInfo</span> <span class="o">&amp;</span><span class="n">STI</span><span class="p">)</span> <span class="n">const</span><span class="p">;</span>

  <span class="o">//</span> <span class="n">getBranch24TargetOpValue</span> <span class="o">-</span> <span class="n">Return</span> <span class="n">binary</span> <span class="n">encoding</span> <span class="n">of</span> <span class="n">the</span> <span class="n">branch</span>
  <span class="o">//</span> <span class="n">target</span> <span class="n">operand</span><span class="p">,</span> <span class="n">such</span> <span class="k">as</span> <span class="n">JMP</span> <span class="c1">#BB01, JEQ, JSUB. If the machine operand</span>
  <span class="o">//</span> <span class="n">requires</span> <span class="n">relocation</span><span class="p">,</span> <span class="n">record</span> <span class="n">the</span> <span class="n">relocation</span> <span class="ow">and</span> <span class="k">return</span> <span class="n">zero</span><span class="o">.</span>
  <span class="n">unsigned</span> <span class="n">getBranch24TargetOpValue</span><span class="p">(</span><span class="n">const</span> <span class="n">MCInst</span> <span class="o">&amp;</span><span class="n">MI</span><span class="p">,</span> <span class="n">unsigned</span> <span class="n">OpNo</span><span class="p">,</span>
                                    <span class="n">SmallVectorImpl</span><span class="o">&lt;</span><span class="n">MCFixup</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="n">Fixups</span><span class="p">,</span>
                                    <span class="n">const</span> <span class="n">MCSubtargetInfo</span> <span class="o">&amp;</span><span class="n">STI</span><span class="p">)</span> <span class="n">const</span><span class="p">;</span>
                                  
  <span class="o">//</span> <span class="n">getJumpTargetOpValue</span> <span class="o">-</span> <span class="n">Return</span> <span class="n">binary</span> <span class="n">encoding</span> <span class="n">of</span> <span class="n">the</span> <span class="n">jump</span>
  <span class="o">//</span> <span class="n">target</span> <span class="n">operand</span><span class="p">,</span> <span class="n">such</span> <span class="k">as</span> <span class="n">JSUB</span> <span class="c1">#function_addr. </span>
  <span class="o">//</span> <span class="n">If</span> <span class="n">the</span> <span class="n">machine</span> <span class="n">operand</span> <span class="n">requires</span> <span class="n">relocation</span><span class="p">,</span>
  <span class="o">//</span> <span class="n">record</span> <span class="n">the</span> <span class="n">relocation</span> <span class="ow">and</span> <span class="k">return</span> <span class="n">zero</span><span class="o">.</span>
   <span class="n">unsigned</span> <span class="n">getJumpTargetOpValue</span><span class="p">(</span><span class="n">const</span> <span class="n">MCInst</span> <span class="o">&amp;</span><span class="n">MI</span><span class="p">,</span> <span class="n">unsigned</span> <span class="n">OpNo</span><span class="p">,</span>
                                 <span class="n">SmallVectorImpl</span><span class="o">&lt;</span><span class="n">MCFixup</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="n">Fixups</span><span class="p">,</span>
                                 <span class="n">const</span> <span class="n">MCSubtargetInfo</span> <span class="o">&amp;</span><span class="n">STI</span><span class="p">)</span> <span class="n">const</span><span class="p">;</span>

  <span class="o">//</span> <span class="n">getMachineOpValue</span> <span class="o">-</span> <span class="n">Return</span> <span class="n">binary</span> <span class="n">encoding</span> <span class="n">of</span> <span class="n">operand</span><span class="o">.</span> <span class="n">If</span> <span class="n">the</span> <span class="n">machin</span>
  <span class="o">//</span> <span class="n">operand</span> <span class="n">requires</span> <span class="n">relocation</span><span class="p">,</span> <span class="n">record</span> <span class="n">the</span> <span class="n">relocation</span> <span class="ow">and</span> <span class="k">return</span> <span class="n">zero</span><span class="o">.</span>
  <span class="n">unsigned</span> <span class="n">getMachineOpValue</span><span class="p">(</span><span class="n">const</span> <span class="n">MCInst</span> <span class="o">&amp;</span><span class="n">MI</span><span class="p">,</span> <span class="n">const</span> <span class="n">MCOperand</span> <span class="o">&amp;</span><span class="n">MO</span><span class="p">,</span>
                             <span class="n">SmallVectorImpl</span><span class="o">&lt;</span><span class="n">MCFixup</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="n">Fixups</span><span class="p">,</span>
                             <span class="n">const</span> <span class="n">MCSubtargetInfo</span> <span class="o">&amp;</span><span class="n">STI</span><span class="p">)</span> <span class="n">const</span><span class="p">;</span>

  <span class="n">unsigned</span> <span class="n">getMemEncoding</span><span class="p">(</span><span class="n">const</span> <span class="n">MCInst</span> <span class="o">&amp;</span><span class="n">MI</span><span class="p">,</span> <span class="n">unsigned</span> <span class="n">OpNo</span><span class="p">,</span>
                          <span class="n">SmallVectorImpl</span><span class="o">&lt;</span><span class="n">MCFixup</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="n">Fixups</span><span class="p">,</span>
                          <span class="n">const</span> <span class="n">MCSubtargetInfo</span> <span class="o">&amp;</span><span class="n">STI</span><span class="p">)</span> <span class="n">const</span><span class="p">;</span>

  <span class="n">unsigned</span> <span class="n">getExprOpValue</span><span class="p">(</span><span class="n">const</span> <span class="n">MCExpr</span> <span class="o">*</span><span class="n">Expr</span><span class="p">,</span> <span class="n">SmallVectorImpl</span><span class="o">&lt;</span><span class="n">MCFixup</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="n">Fixups</span><span class="p">,</span>
                          <span class="n">const</span> <span class="n">MCSubtargetInfo</span> <span class="o">&amp;</span><span class="n">STI</span><span class="p">)</span> <span class="n">const</span><span class="p">;</span>
<span class="p">};</span> <span class="o">//</span> <span class="k">class</span> <span class="nc">Cpu0MCCodeEmitter</span>
<span class="p">}</span> <span class="o">//</span> <span class="n">namespace</span> <span class="n">llvm</span><span class="o">.</span>

<span class="c1">#endif</span>

</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter5_1/MCTargetDesc/Cpu0MCCodeEmitter.cpp</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>//===-- Cpu0MCCodeEmitter.cpp - Convert Cpu0 Code to Machine Code ---------===//
//
//                     The LLVM Compiler Infrastructure
//
// This file is distributed under the University of Illinois Open Source
// License. See LICENSE.TXT for details.
//
//===----------------------------------------------------------------------===//
//
// This file implements the Cpu0MCCodeEmitter class.
//
//===----------------------------------------------------------------------===//
//

#include &quot;Cpu0MCCodeEmitter.h&quot;

#include &quot;MCTargetDesc/Cpu0BaseInfo.h&quot;
#include &quot;MCTargetDesc/Cpu0FixupKinds.h&quot;
#include &quot;MCTargetDesc/Cpu0MCExpr.h&quot;
#include &quot;MCTargetDesc/Cpu0MCTargetDesc.h&quot;
#include &quot;llvm/ADT/APFloat.h&quot;
#include &quot;llvm/MC/MCCodeEmitter.h&quot;
#include &quot;llvm/MC/MCContext.h&quot;
#include &quot;llvm/MC/MCExpr.h&quot;
#include &quot;llvm/MC/MCInst.h&quot;
#include &quot;llvm/MC/MCInstrInfo.h&quot;
#include &quot;llvm/MC/MCRegisterInfo.h&quot;
#include &quot;llvm/MC/MCSubtargetInfo.h&quot;
#include &quot;llvm/Support/raw_ostream.h&quot;

#define DEBUG_TYPE &quot;mccodeemitter&quot;

#define GET_INSTRMAP_INFO
#include &quot;Cpu0GenInstrInfo.inc&quot;
#undef GET_INSTRMAP_INFO

using namespace llvm;

MCCodeEmitter *llvm::createCpu0MCCodeEmitterEB(const MCInstrInfo &amp;MCII,
                                               const MCRegisterInfo &amp;MRI,
                                               MCContext &amp;Ctx) {
  return new Cpu0MCCodeEmitter(MCII, Ctx, false);
}

MCCodeEmitter *llvm::createCpu0MCCodeEmitterEL(const MCInstrInfo &amp;MCII,
                                               const MCRegisterInfo &amp;MRI,
                                               MCContext &amp;Ctx) {
  return new Cpu0MCCodeEmitter(MCII, Ctx, true);
}

void Cpu0MCCodeEmitter::EmitByte(unsigned char C, raw_ostream &amp;OS) const {
  OS &lt;&lt; (char)C;
}

void Cpu0MCCodeEmitter::EmitInstruction(uint64_t Val, unsigned Size, raw_ostream &amp;OS) const {
  // Output the instruction encoding in little endian byte order.
  for (unsigned i = 0; i &lt; Size; ++i) {
    unsigned Shift = IsLittleEndian ? i * 8 : (Size - 1 - i) * 8;
    EmitByte((Val &gt;&gt; Shift) &amp; 0xff, OS);
  }
}

/// encodeInstruction - Emit the instruction.
/// Size the instruction (currently only 4 bytes)
void Cpu0MCCodeEmitter::
encodeInstruction(const MCInst &amp;MI, raw_ostream &amp;OS,
                  SmallVectorImpl&lt;MCFixup&gt; &amp;Fixups,
                  const MCSubtargetInfo &amp;STI) const
{
  uint32_t Binary = getBinaryCodeForInstr(MI, Fixups, STI);

  // Check for unimplemented opcodes.
  // Unfortunately in CPU0 both NOT and SLL will come in with Binary == 0
  // so we have to special check for them.
  unsigned Opcode = MI.getOpcode();
  if ((Opcode != Cpu0::NOP) &amp;&amp; (Opcode != Cpu0::SHL) &amp;&amp; !Binary)
    llvm_unreachable(&quot;unimplemented opcode in encodeInstruction()&quot;);

  const MCInstrDesc &amp;Desc = MCII.get(MI.getOpcode());
  uint64_t TSFlags = Desc.TSFlags;

  // Pseudo instructions don&#39;t get encoded and shouldn&#39;t be here
  // in the first place!
  if ((TSFlags &amp; Cpu0II::FormMask) == Cpu0II::Pseudo)
    llvm_unreachable(&quot;Pseudo opcode found in encodeInstruction()&quot;);

  // For now all instructions are 4 bytes
  int Size = 4; // FIXME: Have Desc.getSize() return the correct value!

  EmitInstruction(Binary, Size, OS);
}

//@CH8_1 {
/// getBranch16TargetOpValue - Return binary encoding of the branch
/// target operand. If the machine operand requires relocation,
/// record the relocation and return zero.
unsigned Cpu0MCCodeEmitter::
getBranch16TargetOpValue(const MCInst &amp;MI, unsigned OpNo,
                         SmallVectorImpl&lt;MCFixup&gt; &amp;Fixups,
                         const MCSubtargetInfo &amp;STI) const {
  return 0;
}

/// getBranch24TargetOpValue - Return binary encoding of the branch
/// target operand. If the machine operand requires relocation,
/// record the relocation and return zero.
unsigned Cpu0MCCodeEmitter::
getBranch24TargetOpValue(const MCInst &amp;MI, unsigned OpNo,
                       SmallVectorImpl&lt;MCFixup&gt; &amp;Fixups,
                       const MCSubtargetInfo &amp;STI) const {
  return 0;
}

/// getJumpTargetOpValue - Return binary encoding of the jump
/// target operand, such as JSUB. 
/// If the machine operand requires relocation,
/// record the relocation and return zero.
//@getJumpTargetOpValue {
unsigned Cpu0MCCodeEmitter::
getJumpTargetOpValue(const MCInst &amp;MI, unsigned OpNo,
                     SmallVectorImpl&lt;MCFixup&gt; &amp;Fixups,
                     const MCSubtargetInfo &amp;STI) const {
  return 0;
}
//@CH8_1 }

//@getExprOpValue {
unsigned Cpu0MCCodeEmitter::
getExprOpValue(const MCExpr *Expr,SmallVectorImpl&lt;MCFixup&gt; &amp;Fixups,
               const MCSubtargetInfo &amp;STI) const {
//@getExprOpValue body {
  MCExpr::ExprKind Kind = Expr-&gt;getKind();
  if (Kind == MCExpr::Constant) {
    return cast&lt;MCConstantExpr&gt;(Expr)-&gt;getValue();
  }

  if (Kind == MCExpr::Binary) {
    unsigned Res = getExprOpValue(cast&lt;MCBinaryExpr&gt;(Expr)-&gt;getLHS(), Fixups, STI);
    Res += getExprOpValue(cast&lt;MCBinaryExpr&gt;(Expr)-&gt;getRHS(), Fixups, STI);
    return Res;
  }

  if (Kind == MCExpr::Target) {
    const Cpu0MCExpr *Cpu0Expr = cast&lt;Cpu0MCExpr&gt;(Expr);

    Cpu0::Fixups FixupKind = Cpu0::Fixups(0);
    switch (Cpu0Expr-&gt;getKind()) {
    default: llvm_unreachable(&quot;Unsupported fixup kind for target expression!&quot;);
    } // switch
    Fixups.push_back(MCFixup::create(0, Expr, MCFixupKind(FixupKind)));
    return 0;
  }

  // All of the information is in the fixup.
  return 0;
}

/// getMachineOpValue - Return binary encoding of operand. If the machine
/// operand requires relocation, record the relocation and return zero.
unsigned Cpu0MCCodeEmitter::
getMachineOpValue(const MCInst &amp;MI, const MCOperand &amp;MO,
                  SmallVectorImpl&lt;MCFixup&gt; &amp;Fixups,
                  const MCSubtargetInfo &amp;STI) const {
  if (MO.isReg()) {
    unsigned Reg = MO.getReg();
    unsigned RegNo = Ctx.getRegisterInfo()-&gt;getEncodingValue(Reg);
    return RegNo;
  } else if (MO.isImm()) {
    return static_cast&lt;unsigned&gt;(MO.getImm());
  } else if (MO.isFPImm()) {
    return static_cast&lt;unsigned&gt;(APFloat(MO.getFPImm())
        .bitcastToAPInt().getHiBits(32).getLimitedValue());
  }
  // MO must be an Expr.
  assert(MO.isExpr());
  return getExprOpValue(MO.getExpr(),Fixups, STI);
}

/// getMemEncoding - Return binary encoding of memory related operand.
/// If the offset operand requires relocation, record the relocation.
unsigned
Cpu0MCCodeEmitter::getMemEncoding(const MCInst &amp;MI, unsigned OpNo,
                                  SmallVectorImpl&lt;MCFixup&gt; &amp;Fixups,
                                  const MCSubtargetInfo &amp;STI) const {
  // Base register is encoded in bits 20-16, offset is encoded in bits 15-0.
  assert(MI.getOperand(OpNo).isReg());
  unsigned RegBits = getMachineOpValue(MI, MI.getOperand(OpNo), Fixups, STI) &lt;&lt; 16;
  unsigned OffBits = getMachineOpValue(MI, MI.getOperand(OpNo+1), Fixups, STI);

  return (OffBits &amp; 0xFFFF) | RegBits;
}

#include &quot;Cpu0GenMCCodeEmitter.inc&quot;

</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter5_1/MCTargetDesc/Cpu0MCExpr.h</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//===--</span> <span class="n">Cpu0MCExpr</span><span class="o">.</span><span class="n">h</span> <span class="o">-</span> <span class="n">Cpu0</span> <span class="n">specific</span> <span class="n">MC</span> <span class="n">expression</span> <span class="n">classes</span> <span class="o">------*-</span> <span class="n">C</span><span class="o">++</span> <span class="o">-*-===//</span>
<span class="o">//</span>
<span class="o">//</span>                     <span class="n">The</span> <span class="n">LLVM</span> <span class="n">Compiler</span> <span class="n">Infrastructure</span>
<span class="o">//</span>
<span class="o">//</span> <span class="n">This</span> <span class="n">file</span> <span class="ow">is</span> <span class="n">distributed</span> <span class="n">under</span> <span class="n">the</span> <span class="n">University</span> <span class="n">of</span> <span class="n">Illinois</span> <span class="n">Open</span> <span class="n">Source</span>
<span class="o">//</span> <span class="n">License</span><span class="o">.</span> <span class="n">See</span> <span class="n">LICENSE</span><span class="o">.</span><span class="n">TXT</span> <span class="k">for</span> <span class="n">details</span><span class="o">.</span>
<span class="o">//</span>
<span class="o">//===----------------------------------------------------------------------===//</span>

<span class="c1">#ifndef LLVM_LIB_TARGET_CPU0_MCTARGETDESC_CPU0MCEXPR_H</span>
<span class="c1">#define LLVM_LIB_TARGET_CPU0_MCTARGETDESC_CPU0MCEXPR_H</span>

<span class="c1">#include &quot;Cpu0Config.h&quot;</span>
<span class="c1">#if CH &gt;= CH5_1</span>

<span class="c1">#include &quot;llvm/MC/MCAsmLayout.h&quot;</span>
<span class="c1">#include &quot;llvm/MC/MCExpr.h&quot;</span>
<span class="c1">#include &quot;llvm/MC/MCValue.h&quot;</span>

<span class="n">namespace</span> <span class="n">llvm</span> <span class="p">{</span>

<span class="k">class</span> <span class="nc">Cpu0MCExpr</span> <span class="p">:</span> <span class="n">public</span> <span class="n">MCTargetExpr</span> <span class="p">{</span>
<span class="n">public</span><span class="p">:</span>
  <span class="n">enum</span> <span class="n">Cpu0ExprKind</span> <span class="p">{</span>
    <span class="n">CEK_None</span><span class="p">,</span>
    <span class="n">CEK_ABS_HI</span><span class="p">,</span>
    <span class="n">CEK_ABS_LO</span><span class="p">,</span>
    <span class="n">CEK_CALL_HI16</span><span class="p">,</span>
    <span class="n">CEK_CALL_LO16</span><span class="p">,</span>
    <span class="n">CEK_DTP_HI</span><span class="p">,</span>
    <span class="n">CEK_DTP_LO</span><span class="p">,</span>
    <span class="n">CEK_GOT</span><span class="p">,</span>
    <span class="n">CEK_GOTTPREL</span><span class="p">,</span>
    <span class="n">CEK_GOT_CALL</span><span class="p">,</span>
    <span class="n">CEK_GOT_DISP</span><span class="p">,</span>
    <span class="n">CEK_GOT_HI16</span><span class="p">,</span>
    <span class="n">CEK_GOT_LO16</span><span class="p">,</span>
    <span class="n">CEK_GPREL</span><span class="p">,</span>
    <span class="n">CEK_TLSGD</span><span class="p">,</span>
    <span class="n">CEK_TLSLDM</span><span class="p">,</span>
    <span class="n">CEK_TP_HI</span><span class="p">,</span>
    <span class="n">CEK_TP_LO</span><span class="p">,</span>
    <span class="n">CEK_Special</span><span class="p">,</span>
  <span class="p">};</span>

<span class="n">private</span><span class="p">:</span>
  <span class="n">const</span> <span class="n">Cpu0ExprKind</span> <span class="n">Kind</span><span class="p">;</span>
  <span class="n">const</span> <span class="n">MCExpr</span> <span class="o">*</span><span class="n">Expr</span><span class="p">;</span>

  <span class="n">explicit</span> <span class="n">Cpu0MCExpr</span><span class="p">(</span><span class="n">Cpu0ExprKind</span> <span class="n">Kind</span><span class="p">,</span> <span class="n">const</span> <span class="n">MCExpr</span> <span class="o">*</span><span class="n">Expr</span><span class="p">)</span>
    <span class="p">:</span> <span class="n">Kind</span><span class="p">(</span><span class="n">Kind</span><span class="p">),</span> <span class="n">Expr</span><span class="p">(</span><span class="n">Expr</span><span class="p">)</span> <span class="p">{}</span>

<span class="n">public</span><span class="p">:</span>
  <span class="n">static</span> <span class="n">const</span> <span class="n">Cpu0MCExpr</span> <span class="o">*</span><span class="n">create</span><span class="p">(</span><span class="n">Cpu0ExprKind</span> <span class="n">Kind</span><span class="p">,</span> <span class="n">const</span> <span class="n">MCExpr</span> <span class="o">*</span><span class="n">Expr</span><span class="p">,</span>
                                  <span class="n">MCContext</span> <span class="o">&amp;</span><span class="n">Ctx</span><span class="p">);</span>
  <span class="n">static</span> <span class="n">const</span> <span class="n">Cpu0MCExpr</span> <span class="o">*</span><span class="n">create</span><span class="p">(</span><span class="n">const</span> <span class="n">MCSymbol</span> <span class="o">*</span><span class="n">Symbol</span><span class="p">,</span> 
                                  <span class="n">Cpu0MCExpr</span><span class="p">::</span><span class="n">Cpu0ExprKind</span> <span class="n">Kind</span><span class="p">,</span> <span class="n">MCContext</span> <span class="o">&amp;</span><span class="n">Ctx</span><span class="p">);</span>
  <span class="n">static</span> <span class="n">const</span> <span class="n">Cpu0MCExpr</span> <span class="o">*</span><span class="n">createGpOff</span><span class="p">(</span><span class="n">Cpu0ExprKind</span> <span class="n">Kind</span><span class="p">,</span> <span class="n">const</span> <span class="n">MCExpr</span> <span class="o">*</span><span class="n">Expr</span><span class="p">,</span>
                                       <span class="n">MCContext</span> <span class="o">&amp;</span><span class="n">Ctx</span><span class="p">);</span>

  <span class="o">///</span> <span class="n">Get</span> <span class="n">the</span> <span class="n">kind</span> <span class="n">of</span> <span class="n">this</span> <span class="n">expression</span><span class="o">.</span>
  <span class="n">Cpu0ExprKind</span> <span class="n">getKind</span><span class="p">()</span> <span class="n">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">Kind</span><span class="p">;</span> <span class="p">}</span>

  <span class="o">///</span> <span class="n">Get</span> <span class="n">the</span> <span class="n">child</span> <span class="n">of</span> <span class="n">this</span> <span class="n">expression</span><span class="o">.</span>
  <span class="n">const</span> <span class="n">MCExpr</span> <span class="o">*</span><span class="n">getSubExpr</span><span class="p">()</span> <span class="n">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">Expr</span><span class="p">;</span> <span class="p">}</span>

  <span class="n">void</span> <span class="n">printImpl</span><span class="p">(</span><span class="n">raw_ostream</span> <span class="o">&amp;</span><span class="n">OS</span><span class="p">,</span> <span class="n">const</span> <span class="n">MCAsmInfo</span> <span class="o">*</span><span class="n">MAI</span><span class="p">)</span> <span class="n">const</span> <span class="n">override</span><span class="p">;</span>
  <span class="nb">bool</span> <span class="n">evaluateAsRelocatableImpl</span><span class="p">(</span><span class="n">MCValue</span> <span class="o">&amp;</span><span class="n">Res</span><span class="p">,</span> <span class="n">const</span> <span class="n">MCAsmLayout</span> <span class="o">*</span><span class="n">Layout</span><span class="p">,</span>
                                 <span class="n">const</span> <span class="n">MCFixup</span> <span class="o">*</span><span class="n">Fixup</span><span class="p">)</span> <span class="n">const</span> <span class="n">override</span><span class="p">;</span>
  <span class="n">void</span> <span class="n">visitUsedExpr</span><span class="p">(</span><span class="n">MCStreamer</span> <span class="o">&amp;</span><span class="n">Streamer</span><span class="p">)</span> <span class="n">const</span> <span class="n">override</span><span class="p">;</span>
  <span class="n">MCFragment</span> <span class="o">*</span><span class="n">findAssociatedFragment</span><span class="p">()</span> <span class="n">const</span> <span class="n">override</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">getSubExpr</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">findAssociatedFragment</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="n">void</span> <span class="n">fixELFSymbolsInTLSFixups</span><span class="p">(</span><span class="n">MCAssembler</span> <span class="o">&amp;</span><span class="n">Asm</span><span class="p">)</span> <span class="n">const</span> <span class="n">override</span><span class="p">;</span>

  <span class="n">static</span> <span class="nb">bool</span> <span class="n">classof</span><span class="p">(</span><span class="n">const</span> <span class="n">MCExpr</span> <span class="o">*</span><span class="n">E</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">E</span><span class="o">-&gt;</span><span class="n">getKind</span><span class="p">()</span> <span class="o">==</span> <span class="n">MCExpr</span><span class="p">::</span><span class="n">Target</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="nb">bool</span> <span class="n">isGpOff</span><span class="p">(</span><span class="n">Cpu0ExprKind</span> <span class="o">&amp;</span><span class="n">Kind</span><span class="p">)</span> <span class="n">const</span><span class="p">;</span>
  <span class="nb">bool</span> <span class="n">isGpOff</span><span class="p">()</span> <span class="n">const</span> <span class="p">{</span>
    <span class="n">Cpu0ExprKind</span> <span class="n">Kind</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">isGpOff</span><span class="p">(</span><span class="n">Kind</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">};</span>
<span class="p">}</span> <span class="o">//</span> <span class="n">end</span> <span class="n">namespace</span> <span class="n">llvm</span>

<span class="c1">#endif // #if CH &gt;= CH5_1</span>

<span class="c1">#endif</span>
</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter5_1/MCTargetDesc/Cpu0MCExpr.cpp</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//===--</span> <span class="n">Cpu0MCExpr</span><span class="o">.</span><span class="n">cpp</span> <span class="o">-</span> <span class="n">Cpu0</span> <span class="n">specific</span> <span class="n">MC</span> <span class="n">expression</span> <span class="n">classes</span> <span class="o">--------------===//</span>
<span class="o">//</span>
<span class="o">//</span>                     <span class="n">The</span> <span class="n">LLVM</span> <span class="n">Compiler</span> <span class="n">Infrastructure</span>
<span class="o">//</span>
<span class="o">//</span> <span class="n">This</span> <span class="n">file</span> <span class="ow">is</span> <span class="n">distributed</span> <span class="n">under</span> <span class="n">the</span> <span class="n">University</span> <span class="n">of</span> <span class="n">Illinois</span> <span class="n">Open</span> <span class="n">Source</span>
<span class="o">//</span> <span class="n">License</span><span class="o">.</span> <span class="n">See</span> <span class="n">LICENSE</span><span class="o">.</span><span class="n">TXT</span> <span class="k">for</span> <span class="n">details</span><span class="o">.</span>
<span class="o">//</span>
<span class="o">//===----------------------------------------------------------------------===//</span>

<span class="c1">#include &quot;Cpu0.h&quot;</span>

<span class="c1">#if CH &gt;= CH5_1</span>

<span class="c1">#include &quot;Cpu0MCExpr.h&quot;</span>
<span class="c1">#include &quot;llvm/BinaryFormat/ELF.h&quot;</span>
<span class="c1">#include &quot;llvm/MC/MCAsmInfo.h&quot;</span>
<span class="c1">#include &quot;llvm/MC/MCAssembler.h&quot;</span>
<span class="c1">#include &quot;llvm/MC/MCContext.h&quot;</span>
<span class="c1">#include &quot;llvm/MC/MCObjectStreamer.h&quot;</span>
<span class="c1">#include &quot;llvm/MC/MCSymbolELF.h&quot;</span>

<span class="n">using</span> <span class="n">namespace</span> <span class="n">llvm</span><span class="p">;</span>

<span class="c1">#define DEBUG_TYPE &quot;cpu0mcexpr&quot;</span>

<span class="n">const</span> <span class="n">Cpu0MCExpr</span> <span class="o">*</span><span class="n">Cpu0MCExpr</span><span class="p">::</span><span class="n">create</span><span class="p">(</span><span class="n">Cpu0MCExpr</span><span class="p">::</span><span class="n">Cpu0ExprKind</span> <span class="n">Kind</span><span class="p">,</span>
                                     <span class="n">const</span> <span class="n">MCExpr</span> <span class="o">*</span><span class="n">Expr</span><span class="p">,</span> <span class="n">MCContext</span> <span class="o">&amp;</span><span class="n">Ctx</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="n">new</span> <span class="p">(</span><span class="n">Ctx</span><span class="p">)</span> <span class="n">Cpu0MCExpr</span><span class="p">(</span><span class="n">Kind</span><span class="p">,</span> <span class="n">Expr</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">const</span> <span class="n">Cpu0MCExpr</span> <span class="o">*</span><span class="n">Cpu0MCExpr</span><span class="p">::</span><span class="n">create</span><span class="p">(</span><span class="n">const</span> <span class="n">MCSymbol</span> <span class="o">*</span><span class="n">Symbol</span><span class="p">,</span> <span class="n">Cpu0MCExpr</span><span class="p">::</span><span class="n">Cpu0ExprKind</span> <span class="n">Kind</span><span class="p">,</span>
                         <span class="n">MCContext</span> <span class="o">&amp;</span><span class="n">Ctx</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">const</span> <span class="n">MCSymbolRefExpr</span> <span class="o">*</span><span class="n">MCSym</span> <span class="o">=</span>
      <span class="n">MCSymbolRefExpr</span><span class="p">::</span><span class="n">create</span><span class="p">(</span><span class="n">Symbol</span><span class="p">,</span> <span class="n">MCSymbolRefExpr</span><span class="p">::</span><span class="n">VK_None</span><span class="p">,</span> <span class="n">Ctx</span><span class="p">);</span>
  <span class="k">return</span> <span class="n">new</span> <span class="p">(</span><span class="n">Ctx</span><span class="p">)</span> <span class="n">Cpu0MCExpr</span><span class="p">(</span><span class="n">Kind</span><span class="p">,</span> <span class="n">MCSym</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">const</span> <span class="n">Cpu0MCExpr</span> <span class="o">*</span><span class="n">Cpu0MCExpr</span><span class="p">::</span><span class="n">createGpOff</span><span class="p">(</span><span class="n">Cpu0MCExpr</span><span class="p">::</span><span class="n">Cpu0ExprKind</span> <span class="n">Kind</span><span class="p">,</span>
                                          <span class="n">const</span> <span class="n">MCExpr</span> <span class="o">*</span><span class="n">Expr</span><span class="p">,</span> <span class="n">MCContext</span> <span class="o">&amp;</span><span class="n">Ctx</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="n">create</span><span class="p">(</span><span class="n">Kind</span><span class="p">,</span> <span class="n">create</span><span class="p">(</span><span class="n">CEK_None</span><span class="p">,</span> <span class="n">create</span><span class="p">(</span><span class="n">CEK_GPREL</span><span class="p">,</span> <span class="n">Expr</span><span class="p">,</span> <span class="n">Ctx</span><span class="p">),</span> <span class="n">Ctx</span><span class="p">),</span> <span class="n">Ctx</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">void</span> <span class="n">Cpu0MCExpr</span><span class="p">::</span><span class="n">printImpl</span><span class="p">(</span><span class="n">raw_ostream</span> <span class="o">&amp;</span><span class="n">OS</span><span class="p">,</span> <span class="n">const</span> <span class="n">MCAsmInfo</span> <span class="o">*</span><span class="n">MAI</span><span class="p">)</span> <span class="n">const</span> <span class="p">{</span>
  <span class="n">int64_t</span> <span class="n">AbsVal</span><span class="p">;</span>

  <span class="n">switch</span> <span class="p">(</span><span class="n">Kind</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">case</span> <span class="n">CEK_None</span><span class="p">:</span>
  <span class="k">case</span> <span class="n">CEK_Special</span><span class="p">:</span>
    <span class="n">llvm_unreachable</span><span class="p">(</span><span class="s2">&quot;CEK_None and CEK_Special are invalid&quot;</span><span class="p">);</span>
    <span class="k">break</span><span class="p">;</span>
  <span class="k">case</span> <span class="n">CEK_CALL_HI16</span><span class="p">:</span>
    <span class="n">OS</span> <span class="o">&lt;&lt;</span> <span class="s2">&quot;</span><span class="si">%c</span><span class="s2">all_hi&quot;</span><span class="p">;</span>
    <span class="k">break</span><span class="p">;</span>
  <span class="k">case</span> <span class="n">CEK_CALL_LO16</span><span class="p">:</span>
    <span class="n">OS</span> <span class="o">&lt;&lt;</span> <span class="s2">&quot;</span><span class="si">%c</span><span class="s2">all_lo&quot;</span><span class="p">;</span>
    <span class="k">break</span><span class="p">;</span>
  <span class="k">case</span> <span class="n">CEK_DTP_HI</span><span class="p">:</span>
    <span class="n">OS</span> <span class="o">&lt;&lt;</span> <span class="s2">&quot;</span><span class="si">%d</span><span class="s2">tp_hi&quot;</span><span class="p">;</span>
    <span class="k">break</span><span class="p">;</span>
  <span class="k">case</span> <span class="n">CEK_DTP_LO</span><span class="p">:</span>
    <span class="n">OS</span> <span class="o">&lt;&lt;</span> <span class="s2">&quot;</span><span class="si">%d</span><span class="s2">tp_lo&quot;</span><span class="p">;</span>
    <span class="k">break</span><span class="p">;</span>
  <span class="k">case</span> <span class="n">CEK_GOT</span><span class="p">:</span>
    <span class="n">OS</span> <span class="o">&lt;&lt;</span> <span class="s2">&quot;</span><span class="si">%g</span><span class="s2">ot&quot;</span><span class="p">;</span>
    <span class="k">break</span><span class="p">;</span>
  <span class="k">case</span> <span class="n">CEK_GOTTPREL</span><span class="p">:</span>
    <span class="n">OS</span> <span class="o">&lt;&lt;</span> <span class="s2">&quot;</span><span class="si">%g</span><span class="s2">ottprel&quot;</span><span class="p">;</span>
    <span class="k">break</span><span class="p">;</span>
  <span class="k">case</span> <span class="n">CEK_GOT_CALL</span><span class="p">:</span>
    <span class="n">OS</span> <span class="o">&lt;&lt;</span> <span class="s2">&quot;</span><span class="si">%c</span><span class="s2">all16&quot;</span><span class="p">;</span>
    <span class="k">break</span><span class="p">;</span>
  <span class="k">case</span> <span class="n">CEK_GOT_DISP</span><span class="p">:</span>
    <span class="n">OS</span> <span class="o">&lt;&lt;</span> <span class="s2">&quot;</span><span class="si">%g</span><span class="s2">ot_disp&quot;</span><span class="p">;</span>
    <span class="k">break</span><span class="p">;</span>
  <span class="k">case</span> <span class="n">CEK_GOT_HI16</span><span class="p">:</span>
    <span class="n">OS</span> <span class="o">&lt;&lt;</span> <span class="s2">&quot;</span><span class="si">%g</span><span class="s2">ot_hi&quot;</span><span class="p">;</span>
    <span class="k">break</span><span class="p">;</span>
  <span class="k">case</span> <span class="n">CEK_GOT_LO16</span><span class="p">:</span>
    <span class="n">OS</span> <span class="o">&lt;&lt;</span> <span class="s2">&quot;</span><span class="si">%g</span><span class="s2">ot_lo&quot;</span><span class="p">;</span>
    <span class="k">break</span><span class="p">;</span>
  <span class="k">case</span> <span class="n">CEK_GPREL</span><span class="p">:</span>
    <span class="n">OS</span> <span class="o">&lt;&lt;</span> <span class="s2">&quot;</span><span class="si">%g</span><span class="s2">p_rel&quot;</span><span class="p">;</span>
    <span class="k">break</span><span class="p">;</span>
  <span class="k">case</span> <span class="n">CEK_ABS_HI</span><span class="p">:</span>
    <span class="n">OS</span> <span class="o">&lt;&lt;</span> <span class="s2">&quot;</span><span class="si">%hi</span><span class="s2">&quot;</span><span class="p">;</span>
    <span class="k">break</span><span class="p">;</span>
  <span class="k">case</span> <span class="n">CEK_ABS_LO</span><span class="p">:</span>
    <span class="n">OS</span> <span class="o">&lt;&lt;</span> <span class="s2">&quot;</span><span class="si">%lo</span><span class="s2">&quot;</span><span class="p">;</span>
    <span class="k">break</span><span class="p">;</span>
  <span class="k">case</span> <span class="n">CEK_TLSGD</span><span class="p">:</span>
    <span class="n">OS</span> <span class="o">&lt;&lt;</span> <span class="s2">&quot;%tlsgd&quot;</span><span class="p">;</span>
    <span class="k">break</span><span class="p">;</span>
  <span class="k">case</span> <span class="n">CEK_TLSLDM</span><span class="p">:</span>
    <span class="n">OS</span> <span class="o">&lt;&lt;</span> <span class="s2">&quot;%tlsldm&quot;</span><span class="p">;</span>
    <span class="k">break</span><span class="p">;</span>
  <span class="k">case</span> <span class="n">CEK_TP_HI</span><span class="p">:</span>
    <span class="n">OS</span> <span class="o">&lt;&lt;</span> <span class="s2">&quot;%tp_hi&quot;</span><span class="p">;</span>
    <span class="k">break</span><span class="p">;</span>
  <span class="k">case</span> <span class="n">CEK_TP_LO</span><span class="p">:</span>
    <span class="n">OS</span> <span class="o">&lt;&lt;</span> <span class="s2">&quot;%tp_lo&quot;</span><span class="p">;</span>
    <span class="k">break</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="n">OS</span> <span class="o">&lt;&lt;</span> <span class="s1">&#39;(&#39;</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">Expr</span><span class="o">-&gt;</span><span class="n">evaluateAsAbsolute</span><span class="p">(</span><span class="n">AbsVal</span><span class="p">))</span>
    <span class="n">OS</span> <span class="o">&lt;&lt;</span> <span class="n">AbsVal</span><span class="p">;</span>
  <span class="k">else</span>
    <span class="n">Expr</span><span class="o">-&gt;</span><span class="nb">print</span><span class="p">(</span><span class="n">OS</span><span class="p">,</span> <span class="n">MAI</span><span class="p">,</span> <span class="n">true</span><span class="p">);</span>
  <span class="n">OS</span> <span class="o">&lt;&lt;</span> <span class="s1">&#39;)&#39;</span><span class="p">;</span>
<span class="p">}</span>

<span class="nb">bool</span>
<span class="n">Cpu0MCExpr</span><span class="p">::</span><span class="n">evaluateAsRelocatableImpl</span><span class="p">(</span><span class="n">MCValue</span> <span class="o">&amp;</span><span class="n">Res</span><span class="p">,</span>
                                      <span class="n">const</span> <span class="n">MCAsmLayout</span> <span class="o">*</span><span class="n">Layout</span><span class="p">,</span>
                                      <span class="n">const</span> <span class="n">MCFixup</span> <span class="o">*</span><span class="n">Fixup</span><span class="p">)</span> <span class="n">const</span> <span class="p">{</span>
  <span class="k">return</span> <span class="n">getSubExpr</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">evaluateAsRelocatable</span><span class="p">(</span><span class="n">Res</span><span class="p">,</span> <span class="n">Layout</span><span class="p">,</span> <span class="n">Fixup</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">void</span> <span class="n">Cpu0MCExpr</span><span class="p">::</span><span class="n">visitUsedExpr</span><span class="p">(</span><span class="n">MCStreamer</span> <span class="o">&amp;</span><span class="n">Streamer</span><span class="p">)</span> <span class="n">const</span> <span class="p">{</span>
  <span class="n">Streamer</span><span class="o">.</span><span class="n">visitUsedExpr</span><span class="p">(</span><span class="o">*</span><span class="n">getSubExpr</span><span class="p">());</span>
<span class="p">}</span>

<span class="n">void</span> <span class="n">Cpu0MCExpr</span><span class="p">::</span><span class="n">fixELFSymbolsInTLSFixups</span><span class="p">(</span><span class="n">MCAssembler</span> <span class="o">&amp;</span><span class="n">Asm</span><span class="p">)</span> <span class="n">const</span> <span class="p">{</span>
  <span class="n">switch</span> <span class="p">((</span><span class="nb">int</span><span class="p">)</span><span class="n">getKind</span><span class="p">())</span> <span class="p">{</span>
  <span class="k">case</span> <span class="n">CEK_None</span><span class="p">:</span>
  <span class="k">case</span> <span class="n">CEK_Special</span><span class="p">:</span>
    <span class="n">llvm_unreachable</span><span class="p">(</span><span class="s2">&quot;CEK_None and CEK_Special are invalid&quot;</span><span class="p">);</span>
    <span class="k">break</span><span class="p">;</span>
  <span class="k">case</span> <span class="n">CEK_CALL_HI16</span><span class="p">:</span>
  <span class="k">case</span> <span class="n">CEK_CALL_LO16</span><span class="p">:</span>
    <span class="k">break</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="nb">bool</span> <span class="n">Cpu0MCExpr</span><span class="p">::</span><span class="n">isGpOff</span><span class="p">(</span><span class="n">Cpu0ExprKind</span> <span class="o">&amp;</span><span class="n">Kind</span><span class="p">)</span> <span class="n">const</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">const</span> <span class="n">Cpu0MCExpr</span> <span class="o">*</span><span class="n">S1</span> <span class="o">=</span> <span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">const</span> <span class="n">Cpu0MCExpr</span><span class="o">&gt;</span><span class="p">(</span><span class="n">getSubExpr</span><span class="p">()))</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">const</span> <span class="n">Cpu0MCExpr</span> <span class="o">*</span><span class="n">S2</span> <span class="o">=</span> <span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">const</span> <span class="n">Cpu0MCExpr</span><span class="o">&gt;</span><span class="p">(</span><span class="n">S1</span><span class="o">-&gt;</span><span class="n">getSubExpr</span><span class="p">()))</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">S1</span><span class="o">-&gt;</span><span class="n">getKind</span><span class="p">()</span> <span class="o">==</span> <span class="n">CEK_None</span> <span class="o">&amp;&amp;</span> <span class="n">S2</span><span class="o">-&gt;</span><span class="n">getKind</span><span class="p">()</span> <span class="o">==</span> <span class="n">CEK_GPREL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">Kind</span> <span class="o">=</span> <span class="n">getKind</span><span class="p">();</span>
        <span class="k">return</span> <span class="n">true</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">#endif</span>
</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter5_1/MCTargetDesc/Cpu0MCTargetDesc.h</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">MCCodeEmitter</span> <span class="o">*</span><span class="n">createCpu0MCCodeEmitterEB</span><span class="p">(</span><span class="n">const</span> <span class="n">MCInstrInfo</span> <span class="o">&amp;</span><span class="n">MCII</span><span class="p">,</span>
                                         <span class="n">const</span> <span class="n">MCRegisterInfo</span> <span class="o">&amp;</span><span class="n">MRI</span><span class="p">,</span>
                                         <span class="n">MCContext</span> <span class="o">&amp;</span><span class="n">Ctx</span><span class="p">);</span>
<span class="n">MCCodeEmitter</span> <span class="o">*</span><span class="n">createCpu0MCCodeEmitterEL</span><span class="p">(</span><span class="n">const</span> <span class="n">MCInstrInfo</span> <span class="o">&amp;</span><span class="n">MCII</span><span class="p">,</span>
                                         <span class="n">const</span> <span class="n">MCRegisterInfo</span> <span class="o">&amp;</span><span class="n">MRI</span><span class="p">,</span>
                                         <span class="n">MCContext</span> <span class="o">&amp;</span><span class="n">Ctx</span><span class="p">);</span>

<span class="n">MCAsmBackend</span> <span class="o">*</span><span class="n">createCpu0AsmBackend</span><span class="p">(</span><span class="n">const</span> <span class="n">Target</span> <span class="o">&amp;</span><span class="n">T</span><span class="p">,</span>
                                   <span class="n">const</span> <span class="n">MCSubtargetInfo</span> <span class="o">&amp;</span><span class="n">STI</span><span class="p">,</span>
                                   <span class="n">const</span> <span class="n">MCRegisterInfo</span> <span class="o">&amp;</span><span class="n">MRI</span><span class="p">,</span>
                                   <span class="n">const</span> <span class="n">MCTargetOptions</span> <span class="o">&amp;</span><span class="n">Options</span><span class="p">);</span>

<span class="n">std</span><span class="p">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">MCObjectTargetWriter</span><span class="o">&gt;</span> <span class="n">createCpu0ELFObjectWriter</span><span class="p">(</span><span class="n">const</span> <span class="n">Triple</span> <span class="o">&amp;</span><span class="n">TT</span><span class="p">);</span>
</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter5_1/MCTargetDesc/Cpu0MCTargetDesc.cpp</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">static</span> <span class="n">MCStreamer</span> <span class="o">*</span><span class="n">createMCStreamer</span><span class="p">(</span><span class="n">const</span> <span class="n">Triple</span> <span class="o">&amp;</span><span class="n">TT</span><span class="p">,</span> <span class="n">MCContext</span> <span class="o">&amp;</span><span class="n">Context</span><span class="p">,</span>
                                    <span class="n">std</span><span class="p">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">MCAsmBackend</span><span class="o">&gt;</span> <span class="o">&amp;&amp;</span><span class="n">MAB</span><span class="p">,</span>
                                    <span class="n">std</span><span class="p">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">MCObjectWriter</span><span class="o">&gt;</span> <span class="o">&amp;&amp;</span><span class="n">OW</span><span class="p">,</span>
                                    <span class="n">std</span><span class="p">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">MCCodeEmitter</span><span class="o">&gt;</span> <span class="o">&amp;&amp;</span><span class="n">Emitter</span><span class="p">,</span>
                                    <span class="nb">bool</span> <span class="n">RelaxAll</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="n">createELFStreamer</span><span class="p">(</span><span class="n">Context</span><span class="p">,</span> <span class="n">std</span><span class="p">::</span><span class="n">move</span><span class="p">(</span><span class="n">MAB</span><span class="p">),</span> <span class="n">std</span><span class="p">::</span><span class="n">move</span><span class="p">(</span><span class="n">OW</span><span class="p">),</span>
                           <span class="n">std</span><span class="p">::</span><span class="n">move</span><span class="p">(</span><span class="n">Emitter</span><span class="p">),</span> <span class="n">RelaxAll</span><span class="p">);;</span>
<span class="p">}</span>

<span class="n">static</span> <span class="n">MCTargetStreamer</span> <span class="o">*</span><span class="n">createCpu0AsmTargetStreamer</span><span class="p">(</span><span class="n">MCStreamer</span> <span class="o">&amp;</span><span class="n">S</span><span class="p">,</span>
                                                     <span class="n">formatted_raw_ostream</span> <span class="o">&amp;</span><span class="n">OS</span><span class="p">,</span>
                                                     <span class="n">MCInstPrinter</span> <span class="o">*</span><span class="n">InstPrint</span><span class="p">,</span>
                                                     <span class="nb">bool</span> <span class="n">isVerboseAsm</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="n">new</span> <span class="n">Cpu0TargetAsmStreamer</span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="n">OS</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">extern</span> <span class="s2">&quot;C&quot;</span> <span class="n">void</span> <span class="n">LLVMInitializeCpu0TargetMC</span><span class="p">()</span> <span class="p">{</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>     <span class="o">//</span> <span class="n">Register</span> <span class="n">the</span> <span class="n">elf</span> <span class="n">streamer</span><span class="o">.</span>
    <span class="n">TargetRegistry</span><span class="p">::</span><span class="n">RegisterELFStreamer</span><span class="p">(</span><span class="o">*</span><span class="n">T</span><span class="p">,</span> <span class="n">createMCStreamer</span><span class="p">);</span>

    <span class="o">//</span> <span class="n">Register</span> <span class="n">the</span> <span class="n">asm</span> <span class="n">target</span> <span class="n">streamer</span><span class="o">.</span>
    <span class="n">TargetRegistry</span><span class="p">::</span><span class="n">RegisterAsmTargetStreamer</span><span class="p">(</span><span class="o">*</span><span class="n">T</span><span class="p">,</span> <span class="n">createCpu0AsmTargetStreamer</span><span class="p">);</span>

    <span class="o">//</span> <span class="n">Register</span> <span class="n">the</span> <span class="n">asm</span> <span class="n">backend</span><span class="o">.</span>
    <span class="n">TargetRegistry</span><span class="p">::</span><span class="n">RegisterMCAsmBackend</span><span class="p">(</span><span class="o">*</span><span class="n">T</span><span class="p">,</span> <span class="n">createCpu0AsmBackend</span><span class="p">);</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>  <span class="o">//</span> <span class="n">Register</span> <span class="n">the</span> <span class="n">MC</span> <span class="n">Code</span> <span class="n">Emitter</span>
  <span class="n">TargetRegistry</span><span class="p">::</span><span class="n">RegisterMCCodeEmitter</span><span class="p">(</span><span class="n">TheCpu0Target</span><span class="p">,</span>
                                        <span class="n">createCpu0MCCodeEmitterEB</span><span class="p">);</span>
  <span class="n">TargetRegistry</span><span class="p">::</span><span class="n">RegisterMCCodeEmitter</span><span class="p">(</span><span class="n">TheCpu0elTarget</span><span class="p">,</span>
                                        <span class="n">createCpu0MCCodeEmitterEL</span><span class="p">);</span>

</pre></div>
</div>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="p">}</span>
</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter5_1/Cpu0MCInstLower.h</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#include &quot;MCTargetDesc/Cpu0MCExpr.h&quot;</span>
</pre></div>
</div>
</section>
<section id="work-flow">
<h2><a class="toc-backref" href="#id6" role="doc-backlink">Work flow</a><a class="headerlink" href="#work-flow" title="Permalink to this heading">¶</a></h2>
<p>In Chapter3_2, OutStreamer-&gt;emitInstruction print the asm. To support elf obj
generation, this chapter create MCELFObjectStreamer inherited from OutStreamer
by calling createELFStreamer in Cpu0MCTargetDesc.cpp above. Once
MCELFObjectStreamer is created. The OutStreamer-&gt;emitInstruction will work with
other code added in directory MCTargetDesc of this chapter. The details of
expanation as follows,</p>
<p class="rubric">llvm/include/llvm/CodeGen/AsmPrinter.h</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">AsmPrinter</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">MachineFunctionPass</span><span class="w"> </span><span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
<span class="w">  </span><span class="p">...</span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">MCStreamer</span><span class="o">&gt;</span><span class="w"> </span><span class="n">OutStreamer</span><span class="p">;</span>
<span class="w">  </span><span class="p">...</span>
<span class="p">}</span>
</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter3_2/Cpu0AsmPrinter.h</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">LLVM_LIBRARY_VISIBILITY</span><span class="w"> </span><span class="n">Cpu0AsmPrinter</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">AsmPrinter</span><span class="w"> </span><span class="p">{</span>
</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter3_2/Cpu0AsmPrinter.cpp</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="nf">Cpu0AsmPrinter::emitInstruction</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">MachineInstr</span><span class="w"> </span><span class="o">*</span><span class="n">MI</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="p">...</span>
<span class="w">  </span><span class="k">do</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="p">...</span>
<span class="w">    </span><span class="n">OutStreamer</span><span class="o">-&gt;</span><span class="n">emitInstruction</span><span class="p">(</span><span class="n">TmpInst0</span><span class="p">,</span><span class="w"> </span><span class="n">getSubtargetInfo</span><span class="p">());</span>
<span class="w">    </span><span class="p">...</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">while</span><span class="w"> </span><span class="p">((</span><span class="o">++</span><span class="n">I</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">E</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">I</span><span class="o">-&gt;</span><span class="n">isInsideBundle</span><span class="p">());</span><span class="w"> </span><span class="c1">// Delay slot check</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="graphviz"><img src="_images/graphviz-c29f9d57f511757a22a36302596889c3b13eb84d.png" alt="digraph G {
  rankdir=TB;
  &quot;Cpu0AsmPrinter::EmitInstruction()&quot; -&gt; &quot;MCObjectStreamer::EmitInstruction()&quot; [label=&quot;AsmPrinter::OutStreamer is MCObjectStreamer if llc -filetype=obj\nAsmPrinter::OutStreamer is MCAsmStreamer if llc -filetype=asm&quot;];
  &quot;MCObjectStreamer::EmitInstruction()&quot; -&gt; &quot;MCELFStreamer::EmitInstToData()&quot; -&gt; &quot;encodeInstruction()&quot; -&gt; &quot;Cpu0MCCodeEmitter::getBinaryCodeForInstr()&quot;;
  &quot;Cpu0MCCodeEmitter::getBinaryCodeForInstr()&quot; -&gt; &quot;getBranch16TargetOpValue()&quot;;
  &quot;Cpu0MCCodeEmitter::getBinaryCodeForInstr()&quot; -&gt; &quot;getMachineOpValue()&quot;;
  subgraph cluster0 {
    label = &quot;Cpu0MCCodeEmitter.cpp&quot;;
    &quot;encodeInstruction()&quot;;
    &quot;getBranch16TargetOpValue()&quot;;
    &quot;getMachineOpValue()&quot;;
    &quot;getExprOpValue()&quot;;
    &quot;getMachineOpValue()&quot; -&gt; &quot;getExprOpValue()&quot;;
  }
  label = &quot;Figure: Calling Functions of elf encoder&quot;;
}" class="graphviz" /></div>
<p>The ELF encoder calling functions shown as the figure above.
AsmPrinter::OutStreamer is set to MCObjectStreamer when by llc driver when user
input <code class="docutils literal notranslate"><span class="pre">llc</span> <span class="pre">-filetype=obj</span></code>.</p>
<div class="graphviz"><img src="_images/graphviz-bf009aa7878011424cdc0abae4932b70269c81a8.png" alt="digraph G {
  rankdir=TB;
  subgraph cluster0 {
    label = &quot;Cpu0MCCodeEmitter.cpp&quot;;
    &quot;encodeInstruction()&quot;;
    &quot;getMachineOpValue()&quot;;
  }
  subgraph cluster1 {
    label = &quot;Cpu0MCCodeEmitter.inc&quot;;
    &quot;getBinaryCodeForInstr()&quot;
  }
  
  &quot;encodeInstruction()&quot; -&gt; &quot;getBinaryCodeForInstr()&quot; [label=&quot;1. MI.Opcode&quot;];
  
  &quot;getBinaryCodeForInstr()&quot; -&gt; &quot;encodeInstruction()&quot;  [label=&quot;4. full MI with operands (register number, immediate value, ...)&quot;];
  &quot;getBinaryCodeForInstr()&quot; -&gt; &quot;getMachineOpValue()&quot; [label=&quot;2. MI.Operand[n]&quot;];
  
  &quot;getMachineOpValue()&quot; -&gt; &quot;getBinaryCodeForInstr()&quot;  [label=&quot;3. RegNum&quot;];
  
  label = &quot;Figure: DFD flow for instruction encode&quot;;
}" class="graphviz" /></div>
<p>The instruction operands information for encoder is got as the figure above.
Steps as follows,</p>
<blockquote>
<div><ol class="arabic simple">
<li><p>Function encodeInstruction() pass MI.Opcode to getBinaryCodeForInstr().</p></li>
<li><p>getBinaryCodeForInstr() pass MI.Operand[n] to getMachineOpValue() and then,</p></li>
<li><p>get register number by calling getMachineOpValue().</p></li>
<li><p>getBinaryCodeForInstr() return the MI with all number of registers to encodeInstruction().</p></li>
</ol>
</div></blockquote>
<p>The MI.Opcode is set in Instruction Selection Stage.
The table gen function getBinaryCodeForInstr() get all the operands information
from the td files set by programmer as the following figure.</p>
<div class="graphviz"><img src="_images/graphviz-f2be32a11f0f84a442d8e01777a2ae0f48a7dd6c.png" alt="digraph G {
  rankdir=LR;
  // graphviz uses &amp;nn; to display control character, &amp;#38; ascii 0x38 is '&amp;', 0x60 is '&lt;', 0x62 is '&gt;'
  // when use port=&quot;f1&quot;, the shape cannot set to &quot;Mrecord&quot;
  getBinaryCodeForInstr [ penwidth = 1, fontname = &quot;Courier New&quot;, shape = &quot;rectangle&quot;, label =&lt;&lt;table border=&quot;0&quot; cellborder=&quot;0&quot; cellpadding=&quot;3&quot; bgcolor=&quot;white&quot;&gt;
    &lt;tr&gt;&lt;td bgcolor=&quot;grey&quot; align=&quot;center&quot; colspan=&quot;2&quot;&gt;&lt;font color=&quot;white&quot;&gt;Cpu0GenMCCodeEmitter.inc&lt;/font&gt;&lt;/td&gt;&lt;/tr&gt;
    &lt;tr&gt;&lt;td align=&quot;left&quot; bgcolor=&quot;yellow&quot; port=&quot;r0&quot;&gt;uint64_t Cpu0MCCodeEmitter::getBinaryCodeForInstr(const MCInst &amp;#38;MI, {&lt;/td&gt;&lt;/tr&gt;
    &lt;tr&gt;&lt;td align=&quot;left&quot;&gt;  ...&lt;/td&gt;&lt;/tr&gt;
    &lt;tr&gt;&lt;td align=&quot;left&quot;&gt;  static const uint64_t InstBits[] = {&lt;/td&gt;&lt;/tr&gt;
    &lt;tr&gt;&lt;td align=&quot;left&quot;&gt;  ...&lt;/td&gt;&lt;/tr&gt;
    &lt;tr&gt;&lt;td align=&quot;left&quot;&gt;  UINT64_C(318767104),	// ADD  /// 318767104=0x13000000&lt;/td&gt;&lt;/tr&gt;
    &lt;tr&gt;&lt;td align=&quot;left&quot;&gt;  ...&lt;/td&gt;&lt;/tr&gt;
    &lt;tr&gt;&lt;td align=&quot;left&quot;&gt;  }&lt;/td&gt;&lt;/tr&gt;
    &lt;tr&gt;&lt;td align=&quot;left&quot;&gt;  const unsigned opcode = MI.getOpcode();&lt;/td&gt;&lt;/tr&gt;
    &lt;tr&gt;&lt;td align=&quot;left&quot;&gt;  uint64_t Value = InstBits[opcode];&lt;/td&gt;&lt;/tr&gt;
    &lt;tr&gt;&lt;td align=&quot;left&quot;&gt;  ...&lt;/td&gt;&lt;/tr&gt;
    &lt;tr&gt;&lt;td align=&quot;left&quot;&gt;  switch (opcode) {&lt;/td&gt;&lt;/tr&gt;
    &lt;tr&gt;&lt;td align=&quot;left&quot;&gt;  ...&lt;/td&gt;&lt;/tr&gt;
    &lt;tr&gt;&lt;td align=&quot;left&quot;&gt;  case Cpu0::ADD:&lt;/td&gt;&lt;/tr&gt;
    &lt;tr&gt;&lt;td align=&quot;left&quot;&gt;  ...&lt;/td&gt;&lt;/tr&gt;
    &lt;tr&gt;&lt;td align=&quot;left&quot;&gt;    // op: ra&lt;/td&gt;&lt;/tr&gt;
    &lt;tr&gt;&lt;td align=&quot;left&quot; port=&quot;f1&quot;&gt;    op = getMachineOpValue(MI, MI.getOperand(0), Fixups, STI);&lt;/td&gt;&lt;/tr&gt;
    &lt;tr&gt;&lt;td align=&quot;left&quot;&gt;    Value |= (op &amp;#38; UINT64_C(15)) &amp;#60;&amp;#60; 20;&lt;/td&gt;&lt;/tr&gt;
    &lt;tr&gt;&lt;td align=&quot;left&quot;&gt;    // op: rb&lt;/td&gt;&lt;/tr&gt;
    &lt;tr&gt;&lt;td align=&quot;left&quot; port=&quot;f2&quot;&gt;    op = getMachineOpValue(MI, MI.getOperand(1), Fixups, STI);&lt;/td&gt;&lt;/tr&gt;
    &lt;tr&gt;&lt;td align=&quot;left&quot;&gt;    Value |= (op &amp;#38; UINT64_C(15)) &amp;#60;&amp;#60; 16;&lt;/td&gt;&lt;/tr&gt;
    &lt;tr&gt;&lt;td align=&quot;left&quot;&gt;    // op: rc&lt;/td&gt;&lt;/tr&gt;
    &lt;tr&gt;&lt;td align=&quot;left&quot; port=&quot;f3&quot;&gt;    op = getMachineOpValue(MI, MI.getOperand(2), Fixups, STI);&lt;/td&gt;&lt;/tr&gt;
    &lt;tr&gt;&lt;td align=&quot;left&quot;&gt;    Value |= (op &amp;#38; UINT64_C(15)) &amp;#60;&amp;#60; 12;&lt;/td&gt;&lt;/tr&gt;
    &lt;tr&gt;&lt;td align=&quot;left&quot;&gt;    break;&lt;/td&gt;&lt;/tr&gt;
    &lt;tr&gt;&lt;td align=&quot;left&quot;&gt;  }&lt;/td&gt;&lt;/tr&gt;
    &lt;tr&gt;&lt;td align=&quot;left&quot;&gt;  ...&lt;/td&gt;&lt;/tr&gt;
    &lt;tr&gt;&lt;td align=&quot;left&quot;&gt;  return Value;&lt;/td&gt;&lt;/tr&gt;
    &lt;tr&gt;&lt;td align=&quot;left&quot;&gt;}&lt;/td&gt;&lt;/tr&gt;
    &lt;/table&gt;&gt; ];
    
  InstrTd [ penwidth = 1, fontname = &quot;Courier New&quot;, shape = &quot;rectangle&quot;, label =&lt;&lt;table border=&quot;0&quot; cellborder=&quot;0&quot; cellpadding=&quot;3&quot; bgcolor=&quot;white&quot;&gt;
    &lt;tr&gt;&lt;td bgcolor=&quot;grey&quot; align=&quot;center&quot; colspan=&quot;2&quot;&gt;&lt;font color=&quot;white&quot;&gt;Cpu0InstrInfo.td&lt;/font&gt;&lt;/td&gt;&lt;/tr&gt;
    &lt;tr&gt;&lt;td align=&quot;left&quot;&gt;class ArithLogicR&amp;#60;bits&amp;#60;8&amp;#62; op, ...&lt;/td&gt;&lt;/tr&gt;
    &lt;tr&gt;&lt;td align=&quot;left&quot; port=&quot;f1&quot;&gt;  let Inst{23-20} = ra;&lt;/td&gt;&lt;/tr&gt;
    &lt;tr&gt;&lt;td align=&quot;left&quot; port=&quot;f2&quot;&gt;  let Inst{19-16} = rb;&lt;/td&gt;&lt;/tr&gt;
    &lt;tr&gt;&lt;td align=&quot;left&quot; port=&quot;f3&quot;&gt;  let Inst{15-12} = rc;&lt;/td&gt;&lt;/tr&gt;
    &lt;tr&gt;&lt;td align=&quot;left&quot;&gt;  ...&lt;/td&gt;&lt;/tr&gt;
    &lt;/table&gt;&gt; ];
  
  
  InstrTd:f1:e -&gt; getBinaryCodeForInstr:f1:n;
  InstrTd:f2:e -&gt; getBinaryCodeForInstr:f2:n;
  InstrTd:f3:e -&gt; getBinaryCodeForInstr:f3:n;
          
  label = &quot;Instruction encode, for instance:  addu $v0, $at, $v1\n  v0:MI.getOperand(0), at:MI.getOperand(1), v1:MI.getOperand(2)&quot;;
}" class="graphviz" /></div>
<p>For instance, Cpu0 backend will generate “addu $v0, $at, $v1” for the IR
“%0 = add %1, %2” once llvm allocate registers $v0, $at and $v1 for Operands
%0, %1 and %2 individually. The MCOperand structure for MI.Operands[] include
register number set in the pass of llvm allocate registers which can be got in
getMachineOpValue().</p>
<p>The getEncodingValue(Reg) in getMachineOpValue() as the following will get the
RegNo of encode from Register name such as AT, V0, or V1, … by using table gen
information from Cpu0RegisterInfo.td as the following. My comment is after “///”.</p>
<p class="rubric">include//llvm/MC/MCRegisterInfo.h</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="nf">InitMCRegisterInfo</span><span class="p">(...,</span>
<span class="w">                        </span><span class="k">const</span><span class="w"> </span><span class="kt">uint16_t</span><span class="w"> </span><span class="o">*</span><span class="n">RET</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="p">...</span>
<span class="w">  </span><span class="n">RegEncodingTable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">RET</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">unsigned</span><span class="w"> </span><span class="n">Cpu0MCCodeEmitter</span><span class="o">::</span>
<span class="nf">getMachineOpValue</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">MCInst</span><span class="w"> </span><span class="o">&amp;</span><span class="n">MI</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">MCOperand</span><span class="w"> </span><span class="o">&amp;</span><span class="n">MO</span><span class="p">,</span>
<span class="w">                  </span><span class="n">SmallVectorImpl</span><span class="o">&lt;</span><span class="n">MCFixup</span><span class="o">&gt;</span><span class="w"> </span><span class="o">&amp;</span><span class="n">Fixups</span><span class="p">,</span>
<span class="w">                  </span><span class="k">const</span><span class="w"> </span><span class="n">MCSubtargetInfo</span><span class="w"> </span><span class="o">&amp;</span><span class="n">STI</span><span class="p">)</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">MO</span><span class="p">.</span><span class="n">isReg</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="n">Reg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MO</span><span class="p">.</span><span class="n">getReg</span><span class="p">();</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="n">RegNo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Ctx</span><span class="p">.</span><span class="n">getRegisterInfo</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getEncodingValue</span><span class="p">(</span><span class="n">Reg</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">RegNo</span><span class="p">;</span>
<span class="w">  </span><span class="p">...</span>
<span class="p">}</span>
</pre></div>
</div>
<p class="rubric">include/llvm/MC/MCRegisterInfo.h</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="nf">InitMCRegisterInfo</span><span class="p">(...,</span>
<span class="w">                        </span><span class="k">const</span><span class="w"> </span><span class="kt">uint16_t</span><span class="w"> </span><span class="o">*</span><span class="n">RET</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="p">...</span>
<span class="w">  </span><span class="n">RegEncodingTable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">RET</span><span class="p">;</span>
<span class="p">}</span>

<span class="w"> </span><span class="c1">/// \brief Returns the encoding for RegNo</span>
<span class="kt">uint16_t</span><span class="w"> </span><span class="nf">getEncodingValue</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="n">RegNo</span><span class="p">)</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">assert</span><span class="p">(</span><span class="n">RegNo</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">NumRegs</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">         </span><span class="s">&quot;Attempting to get encoding for invalid register number!&quot;</span><span class="p">);</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">RegEncodingTable</span><span class="p">[</span><span class="n">RegNo</span><span class="p">];</span>
<span class="p">}</span>
</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter5_1/Cpu0RegisterInfo.td</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="n">let</span><span class="w"> </span><span class="n">Namespace</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Cpu0&quot;</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="p">...</span>
<span class="w">  </span><span class="n">def</span><span class="w"> </span><span class="n">AT</span><span class="w">   </span><span class="o">:</span><span class="w"> </span><span class="n">Cpu0GPRReg</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">,</span><span class="w">  </span><span class="s">&quot;1&quot;</span><span class="o">&gt;</span><span class="p">,</span><span class="w">    </span><span class="n">DwarfRegNum</span><span class="o">&lt;</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">  </span><span class="n">def</span><span class="w"> </span><span class="n">V0</span><span class="w">   </span><span class="o">:</span><span class="w"> </span><span class="n">Cpu0GPRReg</span><span class="o">&lt;</span><span class="mi">2</span><span class="p">,</span><span class="w">  </span><span class="s">&quot;2&quot;</span><span class="o">&gt;</span><span class="p">,</span><span class="w">    </span><span class="n">DwarfRegNum</span><span class="o">&lt;</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">  </span><span class="n">def</span><span class="w"> </span><span class="n">V1</span><span class="w">   </span><span class="o">:</span><span class="w"> </span><span class="n">Cpu0GPRReg</span><span class="o">&lt;</span><span class="mi">3</span><span class="p">,</span><span class="w">  </span><span class="s">&quot;3&quot;</span><span class="o">&gt;</span><span class="p">,</span><span class="w">    </span><span class="n">DwarfRegNum</span><span class="o">&lt;</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">  </span><span class="p">...</span>
<span class="p">}</span>
</pre></div>
</div>
<p class="rubric">build/lib/Target/Cpu0/Cpu0GenRegisterInfo.inc</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">namespace</span><span class="w"> </span><span class="nn">Cpu0</span><span class="w"> </span><span class="p">{</span>
<span class="k">enum</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">NoRegister</span><span class="p">,</span>
<span class="w">  </span><span class="n">AT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="w">  </span><span class="p">...</span>
<span class="w">  </span><span class="n">V0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">19</span><span class="p">,</span>
<span class="w">  </span><span class="n">V1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">20</span><span class="p">,</span>
<span class="w">  </span><span class="n">NUM_TARGET_REGS</span><span class="w">       </span><span class="c1">// 21</span>
<span class="p">};</span>
<span class="p">}</span><span class="w"> </span><span class="c1">// end namespace Cpu0</span>

<span class="k">extern</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">Cpu0RegEncodingTable</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="mi">0</span><span class="p">,</span>
<span class="w">  </span><span class="mi">1</span><span class="p">,</span><span class="w">     </span><span class="c1">/// 1, AT</span>
<span class="w">  </span><span class="mi">1</span><span class="p">,</span>
<span class="w">  </span><span class="mi">12</span><span class="p">,</span>
<span class="w">  </span><span class="mi">11</span><span class="p">,</span>
<span class="w">  </span><span class="mi">0</span><span class="p">,</span>
<span class="w">  </span><span class="mi">0</span><span class="p">,</span>
<span class="w">  </span><span class="mi">14</span><span class="p">,</span>
<span class="w">  </span><span class="mi">0</span><span class="p">,</span>
<span class="w">  </span><span class="mi">13</span><span class="p">,</span>
<span class="w">  </span><span class="mi">15</span><span class="p">,</span>
<span class="w">  </span><span class="mi">0</span><span class="p">,</span>
<span class="w">  </span><span class="mi">4</span><span class="p">,</span>
<span class="w">  </span><span class="mi">5</span><span class="p">,</span>
<span class="w">  </span><span class="mi">9</span><span class="p">,</span>
<span class="w">  </span><span class="mi">10</span><span class="p">,</span>
<span class="w">  </span><span class="mi">7</span><span class="p">,</span>
<span class="w">  </span><span class="mi">8</span><span class="p">,</span>
<span class="w">  </span><span class="mi">6</span><span class="p">,</span>
<span class="w">  </span><span class="mi">2</span><span class="p">,</span><span class="w">    </span><span class="c1">/// 19, V0</span>
<span class="w">  </span><span class="mi">3</span><span class="p">,</span><span class="w">    </span><span class="c1">/// 20, V1</span>
<span class="p">};</span>

<span class="k">static</span><span class="w"> </span><span class="kr">inline</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">InitCpu0MCRegisterInfo</span><span class="p">(</span><span class="n">MCRegisterInfo</span><span class="w"> </span><span class="o">*</span><span class="n">RI</span><span class="p">,</span><span class="w"> </span><span class="p">...)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">RI</span><span class="o">-&gt;</span><span class="n">InitMCRegisterInfo</span><span class="p">(...,</span><span class="w"> </span><span class="n">Cpu0RegEncodingTable</span><span class="p">);</span>
</pre></div>
</div>
<p>The applyFixup() of Cpu0AsmBackend.cpp will fix up the <strong>jeq</strong>, <strong>jub</strong>, …
instructions of “address control flow statements” or “function call statements”
used in later chapters.
The setting of true or false for each relocation record in
needsRelocateWithSymbol() of Cpu0ELFObjectWriter.cpp depends on whethor this
relocation record is needed to adjust address value during link or not.
If set true, then linker has chance to adjust this address value with correct
information. On the other hand, if set false, then linker has no correct
information to adjust this relocation record. About relocation record, it will
be introduced in later chapter ELF Support.</p>
<p>When emit elf obj format instruction, the EncodeInstruction() of
Cpu0MCCodeEmitter.cpp will be called since it override the same name of
function in parent class MCCodeEmitter.</p>
<p class="rubric">lbdex/chapters/Chapter2/Cpu0InstrInfo.td</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//</span> <span class="n">Address</span> <span class="n">operand</span>
<span class="k">def</span> <span class="nf">mem</span> <span class="p">:</span> <span class="n">Operand</span><span class="o">&lt;</span><span class="n">iPTR</span><span class="o">&gt;</span> <span class="p">{</span>
  <span class="n">let</span> <span class="n">PrintMethod</span> <span class="o">=</span> <span class="s2">&quot;printMemOperand&quot;</span><span class="p">;</span>
  <span class="n">let</span> <span class="n">MIOperandInfo</span> <span class="o">=</span> <span class="p">(</span><span class="n">ops</span> <span class="n">GPROut</span><span class="p">,</span> <span class="n">simm16</span><span class="p">);</span>
  <span class="n">let</span> <span class="n">EncoderMethod</span> <span class="o">=</span> <span class="s2">&quot;getMemEncoding&quot;</span><span class="p">;</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">}</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">LoadM32</span><span class="o">&lt;</span><span class="n">bits</span><span class="o">&lt;</span><span class="mi">8</span><span class="o">&gt;</span> <span class="n">op</span><span class="p">,</span> <span class="n">string</span> <span class="n">instr_asm</span><span class="p">,</span> <span class="n">PatFrag</span> <span class="n">OpNode</span><span class="p">,</span>
                   <span class="n">bit</span> <span class="n">Pseudo</span> <span class="o">=</span> <span class="mi">0</span><span class="o">&gt;</span>
  <span class="p">:</span> <span class="n">LoadM</span><span class="o">&lt;</span><span class="n">op</span><span class="p">,</span> <span class="n">instr_asm</span><span class="p">,</span> <span class="n">OpNode</span><span class="p">,</span> <span class="n">GPROut</span><span class="p">,</span> <span class="n">mem</span><span class="p">,</span> <span class="n">Pseudo</span><span class="o">&gt;</span> <span class="p">{</span>
<span class="p">}</span>

<span class="o">//</span> <span class="mi">32</span><span class="o">-</span><span class="n">bit</span> <span class="n">store</span><span class="o">.</span>
<span class="k">class</span> <span class="nc">StoreM32</span><span class="o">&lt;</span><span class="n">bits</span><span class="o">&lt;</span><span class="mi">8</span><span class="o">&gt;</span> <span class="n">op</span><span class="p">,</span> <span class="n">string</span> <span class="n">instr_asm</span><span class="p">,</span> <span class="n">PatFrag</span> <span class="n">OpNode</span><span class="p">,</span>
                    <span class="n">bit</span> <span class="n">Pseudo</span> <span class="o">=</span> <span class="mi">0</span><span class="o">&gt;</span>
  <span class="p">:</span> <span class="n">StoreM</span><span class="o">&lt;</span><span class="n">op</span><span class="p">,</span> <span class="n">instr_asm</span><span class="p">,</span> <span class="n">OpNode</span><span class="p">,</span> <span class="n">GPROut</span><span class="p">,</span> <span class="n">mem</span><span class="p">,</span> <span class="n">Pseudo</span><span class="o">&gt;</span> <span class="p">{</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The “let EncoderMethod = “getMemEncoding”;” in Cpu0InstrInfo.td as above will
making llvm call function getMemEncoding() when either <strong>ld</strong> or <strong>st</strong>
instruction is issued in elf obj since these two instructions use <strong>mem</strong>
Operand.</p>
<p>The other functions in Cpu0MCCodeEmitter.cpp are called by these two functions.</p>
<p>After encoder, the following code will write the encode instructions to buffer.</p>
<p class="rubric">src/lib/MC/MCELFStreamer.cpp</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="nf">MCELFStreamer::EmitInstToData</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">MCInst</span><span class="w"> </span><span class="o">&amp;</span><span class="n">Inst</span><span class="p">,</span>
<span class="w">                                   </span><span class="k">const</span><span class="w"> </span><span class="n">MCSubtargetInfo</span><span class="w"> </span><span class="o">&amp;</span><span class="n">STI</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="p">...</span>
<span class="w">  </span><span class="n">DF</span><span class="o">-&gt;</span><span class="n">setHasInstructions</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>
<span class="w">  </span><span class="n">DF</span><span class="o">-&gt;</span><span class="n">getContents</span><span class="p">().</span><span class="n">append</span><span class="p">(</span><span class="n">Code</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span><span class="w"> </span><span class="n">Code</span><span class="p">.</span><span class="n">end</span><span class="p">());</span>
<span class="w">  </span><span class="p">...</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Then, ELFObjectWriter::writeObject() will write the buffer to elf file.</p>
</section>
<section id="backend-target-registration-structure">
<h2><a class="toc-backref" href="#id7" role="doc-backlink">Backend Target Registration Structure</a><a class="headerlink" href="#backend-target-registration-structure" title="Permalink to this heading">¶</a></h2>
<p>Now, let’s examine Cpu0MCTargetDesc.cpp.
Cpu0MCTargetDesc.cpp do the target registration as mentioned in
the previous chapter here <a class="footnote-reference brackets" href="#target-registration" id="id1" role="doc-noteref"><span class="fn-bracket">[</span>1<span class="fn-bracket">]</span></a>, and the assembly
output has explained here <a class="footnote-reference brackets" href="#add-asmprinter" id="id2" role="doc-noteref"><span class="fn-bracket">[</span>2<span class="fn-bracket">]</span></a>.
List the register functions of ELF obj output as follows,</p>
<p class="rubric">Register function of elf streamer</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="c1">// Register the elf streamer.</span>
<span class="n">TargetRegistry</span><span class="o">::</span><span class="n">RegisterELFStreamer</span><span class="p">(</span><span class="o">*</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">createMCStreamer</span><span class="p">);</span>

<span class="w">  </span><span class="k">static</span><span class="w"> </span><span class="n">MCStreamer</span><span class="w"> </span><span class="o">*</span><span class="nf">createMCStreamer</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">Triple</span><span class="w"> </span><span class="o">&amp;</span><span class="n">TT</span><span class="p">,</span><span class="w"> </span><span class="n">MCContext</span><span class="w"> </span><span class="o">&amp;</span><span class="n">Context</span><span class="p">,</span>
<span class="w">                                      </span><span class="n">MCAsmBackend</span><span class="w"> </span><span class="o">&amp;</span><span class="n">MAB</span><span class="p">,</span><span class="w"> </span><span class="n">raw_pwrite_stream</span><span class="w"> </span><span class="o">&amp;</span><span class="n">OS</span><span class="p">,</span>
<span class="w">                                      </span><span class="n">MCCodeEmitter</span><span class="w"> </span><span class="o">*</span><span class="n">Emitter</span><span class="p">,</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">RelaxAll</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">createELFStreamer</span><span class="p">(</span><span class="n">Context</span><span class="p">,</span><span class="w"> </span><span class="n">MAB</span><span class="p">,</span><span class="w"> </span><span class="n">OS</span><span class="p">,</span><span class="w"> </span><span class="n">Emitter</span><span class="p">,</span><span class="w"> </span><span class="n">RelaxAll</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="c1">// MCELFStreamer.cpp</span>
<span class="w">  </span><span class="n">MCStreamer</span><span class="w"> </span><span class="o">*</span><span class="nf">llvm::createELFStreamer</span><span class="p">(</span><span class="n">MCContext</span><span class="w"> </span><span class="o">&amp;</span><span class="n">Context</span><span class="p">,</span><span class="w"> </span><span class="n">MCAsmBackend</span><span class="w"> </span><span class="o">&amp;</span><span class="n">MAB</span><span class="p">,</span>
<span class="w">                                      </span><span class="n">raw_pwrite_stream</span><span class="w"> </span><span class="o">&amp;</span><span class="n">OS</span><span class="p">,</span><span class="w"> </span><span class="n">MCCodeEmitter</span><span class="w"> </span><span class="o">*</span><span class="n">CE</span><span class="p">,</span>
<span class="w">                                      </span><span class="kt">bool</span><span class="w"> </span><span class="n">RelaxAll</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">MCELFStreamer</span><span class="w"> </span><span class="o">*</span><span class="n">S</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">MCELFStreamer</span><span class="p">(</span><span class="n">Context</span><span class="p">,</span><span class="w"> </span><span class="n">MAB</span><span class="p">,</span><span class="w"> </span><span class="n">OS</span><span class="p">,</span><span class="w"> </span><span class="n">CE</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">RelaxAll</span><span class="p">)</span>
<span class="w">      </span><span class="n">S</span><span class="o">-&gt;</span><span class="n">getAssembler</span><span class="p">().</span><span class="n">setRelaxAll</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">S</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
</pre></div>
</div>
<p>Above createELFStreamer takes care the elf obj streamer.
<a class="reference internal" href="#genobj-f10"><span class="std std-numref">Fig. 22</span></a> as follow is MCELFStreamer inheritance tree.
You can find a lot of operations in that inheritance tree.</p>
<figure class="align-center" id="id3">
<span id="genobj-f10"></span><a class="reference internal image-reference" href="_images/101.png"><img alt="_images/101.png" src="_images/101.png" style="width: 783.0px; height: 596.0px;" /></a>
<figcaption>
<p><span class="caption-number">Fig. 22 </span><span class="caption-text">MCELFStreamer inherit tree</span><a class="headerlink" href="#id3" title="Permalink to this image">¶</a></p>
</figcaption>
</figure>
<p class="rubric">Register function of asm target streamer</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="c1">// Register the asm target streamer.</span>
<span class="n">TargetRegistry</span><span class="o">::</span><span class="n">RegisterAsmTargetStreamer</span><span class="p">(</span><span class="o">*</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">createCpu0AsmTargetStreamer</span><span class="p">);</span>

<span class="w">  </span><span class="k">static</span><span class="w"> </span><span class="n">MCTargetStreamer</span><span class="w"> </span><span class="o">*</span><span class="nf">createCpu0AsmTargetStreamer</span><span class="p">(</span><span class="n">MCStreamer</span><span class="w"> </span><span class="o">&amp;</span><span class="n">S</span><span class="p">,</span>
<span class="w">                                                       </span><span class="n">formatted_raw_ostream</span><span class="w"> </span><span class="o">&amp;</span><span class="n">OS</span><span class="p">,</span>
<span class="w">                                                       </span><span class="n">MCInstPrinter</span><span class="w"> </span><span class="o">*</span><span class="n">InstPrint</span><span class="p">,</span>
<span class="w">                                                       </span><span class="kt">bool</span><span class="w"> </span><span class="n">isVerboseAsm</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Cpu0TargetAsmStreamer</span><span class="p">(</span><span class="n">S</span><span class="p">,</span><span class="w"> </span><span class="n">OS</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Cpu0TargetStreamer.h</span>
<span class="w">    </span><span class="k">class</span><span class="w"> </span><span class="nc">Cpu0TargetStreamer</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">MCTargetStreamer</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">public</span><span class="o">:</span>
<span class="w">      </span><span class="n">Cpu0TargetStreamer</span><span class="p">(</span><span class="n">MCStreamer</span><span class="w"> </span><span class="o">&amp;</span><span class="n">S</span><span class="p">);</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="c1">// This part is for ascii assembly output</span>
<span class="w">    </span><span class="k">class</span><span class="w"> </span><span class="nc">Cpu0TargetAsmStreamer</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">Cpu0TargetStreamer</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="n">formatted_raw_ostream</span><span class="w"> </span><span class="o">&amp;</span><span class="n">OS</span><span class="p">;</span>

<span class="w">    </span><span class="k">public</span><span class="o">:</span>
<span class="w">      </span><span class="n">Cpu0TargetAsmStreamer</span><span class="p">(</span><span class="n">MCStreamer</span><span class="w"> </span><span class="o">&amp;</span><span class="n">S</span><span class="p">,</span><span class="w"> </span><span class="n">formatted_raw_ostream</span><span class="w"> </span><span class="o">&amp;</span><span class="n">OS</span><span class="p">);</span>
<span class="w">    </span><span class="p">};</span>
</pre></div>
</div>
<p>Above instancing MCTargetStreamer instance.</p>
<p class="rubric">Register function of MC Code Emitter</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="c1">// Register the MC Code Emitter</span>
<span class="n">TargetRegistry</span><span class="o">::</span><span class="n">RegisterMCCodeEmitter</span><span class="p">(</span><span class="n">TheCpu0Target</span><span class="p">,</span>
<span class="w">                                      </span><span class="n">createCpu0MCCodeEmitterEB</span><span class="p">);</span>
<span class="n">TargetRegistry</span><span class="o">::</span><span class="n">RegisterMCCodeEmitter</span><span class="p">(</span><span class="n">TheCpu0elTarget</span><span class="p">,</span>
<span class="w">                                      </span><span class="n">createCpu0MCCodeEmitterEL</span><span class="p">);</span>

<span class="w">  </span><span class="c1">// Cpu0MCCodeEmitter.cpp</span>
<span class="w">  </span><span class="n">MCCodeEmitter</span><span class="w"> </span><span class="o">*</span><span class="nf">llvm::createCpu0MCCodeEmitterEB</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">MCInstrInfo</span><span class="w"> </span><span class="o">&amp;</span><span class="n">MCII</span><span class="p">,</span>
<span class="w">                                                 </span><span class="k">const</span><span class="w"> </span><span class="n">MCRegisterInfo</span><span class="w"> </span><span class="o">&amp;</span><span class="n">MRI</span><span class="p">,</span>
<span class="w">                                                 </span><span class="n">MCContext</span><span class="w"> </span><span class="o">&amp;</span><span class="n">Ctx</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Cpu0MCCodeEmitter</span><span class="p">(</span><span class="n">MCII</span><span class="p">,</span><span class="w"> </span><span class="n">Ctx</span><span class="p">,</span><span class="w"> </span><span class="nb">false</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="n">MCCodeEmitter</span><span class="w"> </span><span class="o">*</span><span class="nf">llvm::createCpu0MCCodeEmitterEL</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">MCInstrInfo</span><span class="w"> </span><span class="o">&amp;</span><span class="n">MCII</span><span class="p">,</span>
<span class="w">                                                 </span><span class="k">const</span><span class="w"> </span><span class="n">MCRegisterInfo</span><span class="w"> </span><span class="o">&amp;</span><span class="n">MRI</span><span class="p">,</span>
<span class="w">                                                 </span><span class="n">MCContext</span><span class="w"> </span><span class="o">&amp;</span><span class="n">Ctx</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Cpu0MCCodeEmitter</span><span class="p">(</span><span class="n">MCII</span><span class="p">,</span><span class="w"> </span><span class="n">Ctx</span><span class="p">,</span><span class="w"> </span><span class="nb">true</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
</pre></div>
</div>
<p>Above instancing two objects Cpu0MCCodeEmitter, one is for
big endian and the other is for little endian.
They take care the obj format generated while RegisterELFStreamer() reuse the
elf streamer class.</p>
<p>Reader maybe has the question: “What are the actual arguments in
createCpu0MCCodeEmitterEB(const MCInstrInfo &amp;MCII,  const MCSubtargetInfo &amp;STI,
MCContext &amp;Ctx)?” and “When they are assigned?”
Yes, we didn’t assign it at this point, we register the createXXX() function by
function pointer only (according C, TargetRegistry::RegisterXXX(TheCpu0Target,
createXXX()) where createXXX is function pointer).
LLVM keeps a function pointer to createXXX() when we call target registry, and
will call these createXXX() function back at proper time with arguments
assigned during the target registration process, RegisterXXX().</p>
<p class="rubric">Register function of asm backend</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="c1">// Register the asm backend.</span>
<span class="n">TargetRegistry</span><span class="o">::</span><span class="n">RegisterMCAsmBackend</span><span class="p">(</span><span class="n">TheCpu0Target</span><span class="p">,</span>
<span class="w">                                     </span><span class="n">createCpu0AsmBackendEB32</span><span class="p">);</span>
<span class="n">TargetRegistry</span><span class="o">::</span><span class="n">RegisterMCAsmBackend</span><span class="p">(</span><span class="n">TheCpu0elTarget</span><span class="p">,</span>
<span class="w">                                     </span><span class="n">createCpu0AsmBackendEL32</span><span class="p">);</span>

<span class="w">  </span><span class="c1">// Cpu0AsmBackend.cpp</span>
<span class="w">  </span><span class="n">MCAsmBackend</span><span class="w"> </span><span class="o">*</span><span class="nf">llvm::createCpu0AsmBackendEL32</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">Target</span><span class="w"> </span><span class="o">&amp;</span><span class="n">T</span><span class="p">,</span>
<span class="w">                                               </span><span class="k">const</span><span class="w"> </span><span class="n">MCRegisterInfo</span><span class="w"> </span><span class="o">&amp;</span><span class="n">MRI</span><span class="p">,</span>
<span class="w">                                               </span><span class="k">const</span><span class="w"> </span><span class="n">Triple</span><span class="w"> </span><span class="o">&amp;</span><span class="n">TT</span><span class="p">,</span><span class="w"> </span><span class="n">StringRef</span><span class="w"> </span><span class="n">CPU</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Cpu0AsmBackend</span><span class="p">(</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">TT</span><span class="p">.</span><span class="n">getOS</span><span class="p">(),</span><span class="w"> </span><span class="cm">/*IsLittle*/</span><span class="nb">true</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="n">MCAsmBackend</span><span class="w"> </span><span class="o">*</span><span class="nf">llvm::createCpu0AsmBackendEB32</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">Target</span><span class="w"> </span><span class="o">&amp;</span><span class="n">T</span><span class="p">,</span>
<span class="w">                                               </span><span class="k">const</span><span class="w"> </span><span class="n">MCRegisterInfo</span><span class="w"> </span><span class="o">&amp;</span><span class="n">MRI</span><span class="p">,</span>
<span class="w">                                               </span><span class="k">const</span><span class="w"> </span><span class="n">Triple</span><span class="w"> </span><span class="o">&amp;</span><span class="n">TT</span><span class="p">,</span><span class="w"> </span><span class="n">StringRef</span><span class="w"> </span><span class="n">CPU</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Cpu0AsmBackend</span><span class="p">(</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">TT</span><span class="p">.</span><span class="n">getOS</span><span class="p">(),</span><span class="w"> </span><span class="cm">/*IsLittle*/</span><span class="nb">false</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Cpu0AsmBackend.h</span>
<span class="w">    </span><span class="k">class</span><span class="w"> </span><span class="nc">Cpu0AsmBackend</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">MCAsmBackend</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="p">...</span>
<span class="w">    </span><span class="p">}</span>
</pre></div>
</div>
<p>Above Cpu0AsmBackend class is the bridge for asm to obj.
Two objects take care big endian and little endian, respectively.
It derived from MCAsmBackend.
Most of code for object file generated is implemented by MCELFStreamer and it’s
parent, MCAsmBackend.</p>
<aside class="footnote-list brackets">
<aside class="footnote brackets" id="target-registration" role="note">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id1">1</a><span class="fn-bracket">]</span></span>
<p><a class="reference external" href="http://jonathan2251.github.io/lbd/llvmstructure.html#target-registration">http://jonathan2251.github.io/lbd/llvmstructure.html#target-registration</a></p>
</aside>
<aside class="footnote brackets" id="add-asmprinter" role="note">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id2">2</a><span class="fn-bracket">]</span></span>
<p><a class="reference external" href="http://jonathan2251.github.io/lbd/backendstructure.html#add-asmprinter">http://jonathan2251.github.io/lbd/backendstructure.html#add-asmprinter</a></p>
</aside>
</aside>
</section>
</section>


      </div>
      <div class="bottomnav" role="navigation" aria-label="bottom navigation">
      
        <p>
        «&#160;&#160;<a href="otherinst.html">Arithmetic and logic instructions</a>
        &#160;&#160;::&#160;&#160;
        <a class="uplink" href="index.html">Contents</a>
        &#160;&#160;::&#160;&#160;
        <a href="globalvar.html">Global variables</a>&#160;&#160;»
        </p>

      </div>

    <div class="footer" role="contentinfo">
        &#169; Copyright 2016, Chen Chung-Shu.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 6.1.3.
    </div>
  </body>
</html>