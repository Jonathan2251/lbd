<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Backend structure &mdash; Tutorial: Creating an LLVM Backend for the Cpu0 Architecture</title>
    
    <link rel="stylesheet" href="_static/haiku.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '3.9.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="author" title="About these documents" href="about.html" />
    <link rel="top" title="Tutorial: Creating an LLVM Backend for the Cpu0 Architecture" href="index.html" />
    <link rel="next" title="Arithmetic and logic instructions" href="otherinst.html" />
    <link rel="prev" title="Cpu0 architecture and LLVM structure" href="llvmstructure.html" /> 
  </head>
  <body role="document">
      <div class="header" role="banner"><h1 class="heading"><a href="index.html">
          <span>Tutorial: Creating an LLVM Backend for the Cpu0 Architecture</span></a></h1>
        <h2 class="heading"><span>Backend structure</span></h2>
      </div>
      <div class="topnav" role="navigation" aria-label="top navigation">
      
        <p>
        «&#160;&#160;<a href="llvmstructure.html">Cpu0 architecture and LLVM structure</a>
        &#160;&#160;::&#160;&#160;
        <a class="uplink" href="index.html">Contents</a>
        &#160;&#160;::&#160;&#160;
        <a href="otherinst.html">Arithmetic and logic instructions</a>&#160;&#160;»
        </p>

      </div>
      <div class="content">
        
        
  <div class="section" id="backend-structure">
<span id="sec-backendstructure"></span><h1>Backend structure<a class="headerlink" href="#backend-structure" title="Permalink to this headline">¶</a></h1>
<div class="contents local topic" id="contents">
<ul class="simple">
<li><a class="reference internal" href="#targetmachine-structure" id="id14">TargetMachine structure</a></li>
<li><a class="reference internal" href="#add-asmprinter" id="id15">Add AsmPrinter</a></li>
<li><a class="reference internal" href="#add-cpu0dagtodagisel-class" id="id16">Add Cpu0DAGToDAGISel class</a></li>
<li><a class="reference internal" href="#handle-return-register-lr" id="id17">Handle return register $lr</a></li>
<li><a class="reference internal" href="#add-prologue-epilogue-functions" id="id18">Add Prologue/Epilogue functions</a><ul>
<li><a class="reference internal" href="#concept" id="id19">Concept</a></li>
<li><a class="reference internal" href="#prologue-and-epilogue-functions" id="id20">Prologue and Epilogue functions</a></li>
<li><a class="reference internal" href="#handle-stack-slot-for-local-variables" id="id21">Handle stack slot for local variables</a></li>
<li><a class="reference internal" href="#large-stack" id="id22">Large stack</a></li>
</ul>
</li>
<li><a class="reference internal" href="#data-operands-dags" id="id23">Data operands DAGs</a></li>
<li><a class="reference internal" href="#summary-of-this-chapter" id="id24">Summary of this Chapter</a></li>
</ul>
</div>
<p>This chapter introduces the backend class inheritance tree and class members
first.
Next, following the backend structure, adding individual classes implementation
in each section.
At the end of this chapter, we will have a backend to compile llvm
intermediate code into Cpu0 assembly code.</p>
<p>Many lines of code are added in this chapter.
They almost are common in every backend except the backend name (Cpu0 or
Mips ...). Actually, we copy almost all the
code from Mips and replace the name with Cpu0. In addition to knowing the DAGs
pattern match in theoretic compiler and realistic llvm code generation phase,
please focus on the classes relationship in this backend structure.
Once knowing the structure, you can
create your backend structure as quickly as we did, even though there are 5000
lines of code around added in this chapter.</p>
<div class="section" id="targetmachine-structure">
<h2><a class="toc-backref" href="#id14">TargetMachine structure</a><a class="headerlink" href="#targetmachine-structure" title="Permalink to this headline">¶</a></h2>
<p class="rubric">lbdex/chapters/Chapter3_1/Cpu0TargetObjectFile.h</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">//===--</span> <span class="n">llvm</span><span class="o">/</span><span class="n">Target</span><span class="o">/</span><span class="n">Cpu0TargetObjectFile</span><span class="o">.</span><span class="n">h</span> <span class="o">-</span> <span class="n">Cpu0</span> <span class="n">Object</span> <span class="n">Info</span> <span class="o">---*-</span> <span class="n">C</span><span class="o">++</span> <span class="o">-*-===//</span>
<span class="o">//</span>
<span class="o">//</span>                     <span class="n">The</span> <span class="n">LLVM</span> <span class="n">Compiler</span> <span class="n">Infrastructure</span>
<span class="o">//</span>
<span class="o">//</span> <span class="n">This</span> <span class="n">file</span> <span class="ow">is</span> <span class="n">distributed</span> <span class="n">under</span> <span class="n">the</span> <span class="n">University</span> <span class="n">of</span> <span class="n">Illinois</span> <span class="n">Open</span> <span class="n">Source</span>
<span class="o">//</span> <span class="n">License</span><span class="o">.</span> <span class="n">See</span> <span class="n">LICENSE</span><span class="o">.</span><span class="n">TXT</span> <span class="k">for</span> <span class="n">details</span><span class="o">.</span>
<span class="o">//</span>
<span class="o">//===----------------------------------------------------------------------===//</span>

<span class="c1">#ifndef LLVM_LIB_TARGET_CPU0_CPU0TARGETOBJECTFILE_H</span>
<span class="c1">#define LLVM_LIB_TARGET_CPU0_CPU0TARGETOBJECTFILE_H</span>

<span class="c1">#include &quot;Cpu0Config.h&quot;</span>

<span class="c1">#include &quot;Cpu0TargetMachine.h&quot;</span>
<span class="c1">#include &quot;llvm/CodeGen/TargetLoweringObjectFileImpl.h&quot;</span>

<span class="n">namespace</span> <span class="n">llvm</span> <span class="p">{</span>
<span class="k">class</span> <span class="nc">Cpu0TargetMachine</span><span class="p">;</span>
  <span class="k">class</span> <span class="nc">Cpu0TargetObjectFile</span> <span class="p">:</span> <span class="n">public</span> <span class="n">TargetLoweringObjectFileELF</span> <span class="p">{</span>
    <span class="n">MCSection</span> <span class="o">*</span><span class="n">SmallDataSection</span><span class="p">;</span>
    <span class="n">MCSection</span> <span class="o">*</span><span class="n">SmallBSSSection</span><span class="p">;</span>
    <span class="n">const</span> <span class="n">Cpu0TargetMachine</span> <span class="o">*</span><span class="n">TM</span><span class="p">;</span>
  <span class="n">public</span><span class="p">:</span>

    <span class="n">void</span> <span class="n">Initialize</span><span class="p">(</span><span class="n">MCContext</span> <span class="o">&amp;</span><span class="n">Ctx</span><span class="p">,</span> <span class="n">const</span> <span class="n">TargetMachine</span> <span class="o">&amp;</span><span class="n">TM</span><span class="p">)</span> <span class="n">override</span><span class="p">;</span>

  <span class="p">};</span>
<span class="p">}</span> <span class="o">//</span> <span class="n">end</span> <span class="n">namespace</span> <span class="n">llvm</span>

<span class="c1">#endif</span>

</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter3_1/Cpu0TargetObjectFile.cpp</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">//===--</span> <span class="n">Cpu0TargetObjectFile</span><span class="o">.</span><span class="n">cpp</span> <span class="o">-</span> <span class="n">Cpu0</span> <span class="n">Object</span> <span class="n">Files</span> <span class="o">----------------------===//</span>
<span class="o">//</span>
<span class="o">//</span>                     <span class="n">The</span> <span class="n">LLVM</span> <span class="n">Compiler</span> <span class="n">Infrastructure</span>
<span class="o">//</span>
<span class="o">//</span> <span class="n">This</span> <span class="n">file</span> <span class="ow">is</span> <span class="n">distributed</span> <span class="n">under</span> <span class="n">the</span> <span class="n">University</span> <span class="n">of</span> <span class="n">Illinois</span> <span class="n">Open</span> <span class="n">Source</span>
<span class="o">//</span> <span class="n">License</span><span class="o">.</span> <span class="n">See</span> <span class="n">LICENSE</span><span class="o">.</span><span class="n">TXT</span> <span class="k">for</span> <span class="n">details</span><span class="o">.</span>
<span class="o">//</span>
<span class="o">//===----------------------------------------------------------------------===//</span>

<span class="c1">#include &quot;Cpu0TargetObjectFile.h&quot;</span>

<span class="c1">#include &quot;Cpu0Subtarget.h&quot;</span>
<span class="c1">#include &quot;Cpu0TargetMachine.h&quot;</span>
<span class="c1">#include &quot;llvm/IR/DataLayout.h&quot;</span>
<span class="c1">#include &quot;llvm/IR/DerivedTypes.h&quot;</span>
<span class="c1">#include &quot;llvm/IR/GlobalVariable.h&quot;</span>
<span class="c1">#include &quot;llvm/MC/MCContext.h&quot;</span>
<span class="c1">#include &quot;llvm/MC/MCSectionELF.h&quot;</span>
<span class="c1">#include &quot;llvm/Support/CommandLine.h&quot;</span>
<span class="c1">#include &quot;llvm/Support/ELF.h&quot;</span>
<span class="c1">#include &quot;llvm/Target/TargetMachine.h&quot;</span>
<span class="n">using</span> <span class="n">namespace</span> <span class="n">llvm</span><span class="p">;</span>

<span class="n">static</span> <span class="n">cl</span><span class="p">::</span><span class="n">opt</span><span class="o">&lt;</span><span class="n">unsigned</span><span class="o">&gt;</span>
<span class="n">SSThreshold</span><span class="p">(</span><span class="s2">&quot;cpu0-ssection-threshold&quot;</span><span class="p">,</span> <span class="n">cl</span><span class="p">::</span><span class="n">Hidden</span><span class="p">,</span>
            <span class="n">cl</span><span class="p">::</span><span class="n">desc</span><span class="p">(</span><span class="s2">&quot;Small data and bss section threshold size (default=8)&quot;</span><span class="p">),</span>
            <span class="n">cl</span><span class="p">::</span><span class="n">init</span><span class="p">(</span><span class="mi">8</span><span class="p">));</span>

<span class="n">void</span> <span class="n">Cpu0TargetObjectFile</span><span class="p">::</span><span class="n">Initialize</span><span class="p">(</span><span class="n">MCContext</span> <span class="o">&amp;</span><span class="n">Ctx</span><span class="p">,</span> <span class="n">const</span> <span class="n">TargetMachine</span> <span class="o">&amp;</span><span class="n">TM</span><span class="p">){</span>
  <span class="n">TargetLoweringObjectFileELF</span><span class="p">::</span><span class="n">Initialize</span><span class="p">(</span><span class="n">Ctx</span><span class="p">,</span> <span class="n">TM</span><span class="p">);</span>
  <span class="n">InitializeELF</span><span class="p">(</span><span class="n">TM</span><span class="o">.</span><span class="n">Options</span><span class="o">.</span><span class="n">UseInitArray</span><span class="p">);</span>

  <span class="n">SmallDataSection</span> <span class="o">=</span> <span class="n">getContext</span><span class="p">()</span><span class="o">.</span><span class="n">getELFSection</span><span class="p">(</span>
      <span class="s2">&quot;.sdata&quot;</span><span class="p">,</span> <span class="n">ELF</span><span class="p">::</span><span class="n">SHT_PROGBITS</span><span class="p">,</span> <span class="n">ELF</span><span class="p">::</span><span class="n">SHF_WRITE</span> <span class="o">|</span> <span class="n">ELF</span><span class="p">::</span><span class="n">SHF_ALLOC</span><span class="p">);</span>

  <span class="n">SmallBSSSection</span> <span class="o">=</span> <span class="n">getContext</span><span class="p">()</span><span class="o">.</span><span class="n">getELFSection</span><span class="p">(</span><span class="s2">&quot;.sbss&quot;</span><span class="p">,</span> <span class="n">ELF</span><span class="p">::</span><span class="n">SHT_NOBITS</span><span class="p">,</span>
                                               <span class="n">ELF</span><span class="p">::</span><span class="n">SHF_WRITE</span> <span class="o">|</span> <span class="n">ELF</span><span class="p">::</span><span class="n">SHF_ALLOC</span><span class="p">);</span>
  <span class="n">this</span><span class="o">-&gt;</span><span class="n">TM</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">static_cast</span><span class="o">&lt;</span><span class="n">const</span> <span class="n">Cpu0TargetMachine</span> <span class="o">&amp;&gt;</span><span class="p">(</span><span class="n">TM</span><span class="p">);</span>
<span class="p">}</span>

</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter3_1/Cpu0TargetMachine.h</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">//===--</span> <span class="n">Cpu0TargetMachine</span><span class="o">.</span><span class="n">h</span> <span class="o">-</span> <span class="n">Define</span> <span class="n">TargetMachine</span> <span class="k">for</span> <span class="n">Cpu0</span> <span class="o">-----*-</span> <span class="n">C</span><span class="o">++</span> <span class="o">-*-===//</span>
<span class="o">//</span>
<span class="o">//</span>                     <span class="n">The</span> <span class="n">LLVM</span> <span class="n">Compiler</span> <span class="n">Infrastructure</span>
<span class="o">//</span>
<span class="o">//</span> <span class="n">This</span> <span class="n">file</span> <span class="ow">is</span> <span class="n">distributed</span> <span class="n">under</span> <span class="n">the</span> <span class="n">University</span> <span class="n">of</span> <span class="n">Illinois</span> <span class="n">Open</span> <span class="n">Source</span>
<span class="o">//</span> <span class="n">License</span><span class="o">.</span> <span class="n">See</span> <span class="n">LICENSE</span><span class="o">.</span><span class="n">TXT</span> <span class="k">for</span> <span class="n">details</span><span class="o">.</span>
<span class="o">//</span>
<span class="o">//===----------------------------------------------------------------------===//</span>
<span class="o">//</span>
<span class="o">//</span> <span class="n">This</span> <span class="n">file</span> <span class="n">declares</span> <span class="n">the</span> <span class="n">Cpu0</span> <span class="n">specific</span> <span class="n">subclass</span> <span class="n">of</span> <span class="n">TargetMachine</span><span class="o">.</span>
<span class="o">//</span>
<span class="o">//===----------------------------------------------------------------------===//</span>

<span class="c1">#ifndef LLVM_LIB_TARGET_CPU0_CPU0TARGETMACHINE_H</span>
<span class="c1">#define LLVM_LIB_TARGET_CPU0_CPU0TARGETMACHINE_H</span>

<span class="c1">#include &quot;Cpu0Config.h&quot;</span>

<span class="c1">#include &quot;MCTargetDesc/Cpu0ABIInfo.h&quot;</span>
<span class="c1">#include &quot;Cpu0Subtarget.h&quot;</span>
<span class="c1">#include &quot;llvm/CodeGen/Passes.h&quot;</span>
<span class="c1">#include &quot;llvm/CodeGen/SelectionDAGISel.h&quot;</span>
<span class="c1">#include &quot;llvm/Target/TargetFrameLowering.h&quot;</span>
<span class="c1">#include &quot;llvm/Target/TargetMachine.h&quot;</span>

<span class="n">namespace</span> <span class="n">llvm</span> <span class="p">{</span>
<span class="k">class</span> <span class="nc">formatted_raw_ostream</span><span class="p">;</span>
<span class="k">class</span> <span class="nc">Cpu0RegisterInfo</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">Cpu0TargetMachine</span> <span class="p">:</span> <span class="n">public</span> <span class="n">LLVMTargetMachine</span> <span class="p">{</span>
  <span class="nb">bool</span> <span class="n">isLittle</span><span class="p">;</span>
  <span class="n">std</span><span class="p">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">TargetLoweringObjectFile</span><span class="o">&gt;</span> <span class="n">TLOF</span><span class="p">;</span>
  <span class="o">//</span> <span class="n">Selected</span> <span class="n">ABI</span>
  <span class="n">Cpu0ABIInfo</span> <span class="n">ABI</span><span class="p">;</span>
  <span class="n">Cpu0Subtarget</span> <span class="n">DefaultSubtarget</span><span class="p">;</span>

  <span class="n">mutable</span> <span class="n">StringMap</span><span class="o">&lt;</span><span class="n">std</span><span class="p">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">Cpu0Subtarget</span><span class="o">&gt;&gt;</span> <span class="n">SubtargetMap</span><span class="p">;</span>
<span class="n">public</span><span class="p">:</span>
  <span class="n">Cpu0TargetMachine</span><span class="p">(</span><span class="n">const</span> <span class="n">Target</span> <span class="o">&amp;</span><span class="n">T</span><span class="p">,</span> <span class="n">const</span> <span class="n">Triple</span> <span class="o">&amp;</span><span class="n">TT</span><span class="p">,</span> <span class="n">StringRef</span> <span class="n">CPU</span><span class="p">,</span>
                    <span class="n">StringRef</span> <span class="n">FS</span><span class="p">,</span> <span class="n">const</span> <span class="n">TargetOptions</span> <span class="o">&amp;</span><span class="n">Options</span><span class="p">,</span>
                    <span class="n">Optional</span><span class="o">&lt;</span><span class="n">Reloc</span><span class="p">::</span><span class="n">Model</span><span class="o">&gt;</span> <span class="n">RM</span><span class="p">,</span> <span class="n">CodeModel</span><span class="p">::</span><span class="n">Model</span> <span class="n">CM</span><span class="p">,</span>
                    <span class="n">CodeGenOpt</span><span class="p">::</span><span class="n">Level</span> <span class="n">OL</span><span class="p">,</span> <span class="nb">bool</span> <span class="n">isLittle</span><span class="p">);</span>
  <span class="o">~</span><span class="n">Cpu0TargetMachine</span><span class="p">()</span> <span class="n">override</span><span class="p">;</span>

  <span class="n">const</span> <span class="n">Cpu0Subtarget</span> <span class="o">*</span><span class="n">getSubtargetImpl</span><span class="p">()</span> <span class="n">const</span> <span class="p">{</span>
    <span class="k">return</span> <span class="o">&amp;</span><span class="n">DefaultSubtarget</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="n">const</span> <span class="n">Cpu0Subtarget</span> <span class="o">*</span><span class="n">getSubtargetImpl</span><span class="p">(</span><span class="n">const</span> <span class="n">Function</span> <span class="o">&amp;</span><span class="n">F</span><span class="p">)</span> <span class="n">const</span> <span class="n">override</span><span class="p">;</span>

  <span class="o">//</span> <span class="n">Pass</span> <span class="n">Pipeline</span> <span class="n">Configuration</span>
  <span class="n">TargetPassConfig</span> <span class="o">*</span><span class="n">createPassConfig</span><span class="p">(</span><span class="n">PassManagerBase</span> <span class="o">&amp;</span><span class="n">PM</span><span class="p">)</span> <span class="n">override</span><span class="p">;</span>

  <span class="n">TargetLoweringObjectFile</span> <span class="o">*</span><span class="n">getObjFileLowering</span><span class="p">()</span> <span class="n">const</span> <span class="n">override</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">TLOF</span><span class="o">.</span><span class="n">get</span><span class="p">();</span>
  <span class="p">}</span>
  <span class="nb">bool</span> <span class="n">isLittleEndian</span><span class="p">()</span> <span class="n">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">isLittle</span><span class="p">;</span> <span class="p">}</span>
  <span class="n">const</span> <span class="n">Cpu0ABIInfo</span> <span class="o">&amp;</span><span class="n">getABI</span><span class="p">()</span> <span class="n">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">ABI</span><span class="p">;</span> <span class="p">}</span>
<span class="p">};</span>

<span class="o">///</span> <span class="n">Cpu0ebTargetMachine</span> <span class="o">-</span> <span class="n">Cpu032</span> <span class="n">big</span> <span class="n">endian</span> <span class="n">target</span> <span class="n">machine</span><span class="o">.</span>
<span class="o">///</span>
<span class="k">class</span> <span class="nc">Cpu0ebTargetMachine</span> <span class="p">:</span> <span class="n">public</span> <span class="n">Cpu0TargetMachine</span> <span class="p">{</span>
  <span class="n">virtual</span> <span class="n">void</span> <span class="n">anchor</span><span class="p">();</span>
<span class="n">public</span><span class="p">:</span>
  <span class="n">Cpu0ebTargetMachine</span><span class="p">(</span><span class="n">const</span> <span class="n">Target</span> <span class="o">&amp;</span><span class="n">T</span><span class="p">,</span> <span class="n">const</span> <span class="n">Triple</span> <span class="o">&amp;</span><span class="n">TT</span><span class="p">,</span> <span class="n">StringRef</span> <span class="n">CPU</span><span class="p">,</span>
                      <span class="n">StringRef</span> <span class="n">FS</span><span class="p">,</span> <span class="n">const</span> <span class="n">TargetOptions</span> <span class="o">&amp;</span><span class="n">Options</span><span class="p">,</span>
                      <span class="n">Optional</span><span class="o">&lt;</span><span class="n">Reloc</span><span class="p">::</span><span class="n">Model</span><span class="o">&gt;</span> <span class="n">RM</span><span class="p">,</span> <span class="n">CodeModel</span><span class="p">::</span><span class="n">Model</span> <span class="n">CM</span><span class="p">,</span>
                      <span class="n">CodeGenOpt</span><span class="p">::</span><span class="n">Level</span> <span class="n">OL</span><span class="p">);</span>
<span class="p">};</span>

<span class="o">///</span> <span class="n">Cpu0elTargetMachine</span> <span class="o">-</span> <span class="n">Cpu032</span> <span class="n">little</span> <span class="n">endian</span> <span class="n">target</span> <span class="n">machine</span><span class="o">.</span>
<span class="o">///</span>
<span class="k">class</span> <span class="nc">Cpu0elTargetMachine</span> <span class="p">:</span> <span class="n">public</span> <span class="n">Cpu0TargetMachine</span> <span class="p">{</span>
  <span class="n">virtual</span> <span class="n">void</span> <span class="n">anchor</span><span class="p">();</span>
<span class="n">public</span><span class="p">:</span>
  <span class="n">Cpu0elTargetMachine</span><span class="p">(</span><span class="n">const</span> <span class="n">Target</span> <span class="o">&amp;</span><span class="n">T</span><span class="p">,</span> <span class="n">const</span> <span class="n">Triple</span> <span class="o">&amp;</span><span class="n">TT</span><span class="p">,</span> <span class="n">StringRef</span> <span class="n">CPU</span><span class="p">,</span>
                      <span class="n">StringRef</span> <span class="n">FS</span><span class="p">,</span> <span class="n">const</span> <span class="n">TargetOptions</span> <span class="o">&amp;</span><span class="n">Options</span><span class="p">,</span>
                      <span class="n">Optional</span><span class="o">&lt;</span><span class="n">Reloc</span><span class="p">::</span><span class="n">Model</span><span class="o">&gt;</span> <span class="n">RM</span><span class="p">,</span> <span class="n">CodeModel</span><span class="p">::</span><span class="n">Model</span> <span class="n">CM</span><span class="p">,</span>
                      <span class="n">CodeGenOpt</span><span class="p">::</span><span class="n">Level</span> <span class="n">OL</span><span class="p">);</span>
<span class="p">};</span>
<span class="p">}</span> <span class="o">//</span> <span class="n">End</span> <span class="n">llvm</span> <span class="n">namespace</span>

<span class="c1">#endif</span>

</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter3_1/Cpu0TargetMachine.cpp</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>//===-- Cpu0TargetMachine.cpp - Define TargetMachine for Cpu0 -------------===//
//
//                     The LLVM Compiler Infrastructure
//
// This file is distributed under the University of Illinois Open Source
// License. See LICENSE.TXT for details.
//
//===----------------------------------------------------------------------===//
//
// Implements the info about Cpu0 target spec.
//
//===----------------------------------------------------------------------===//

#include &quot;Cpu0TargetMachine.h&quot;
#include &quot;Cpu0.h&quot;

#include &quot;Cpu0Subtarget.h&quot;
#include &quot;Cpu0TargetObjectFile.h&quot;
#include &quot;llvm/IR/LegacyPassManager.h&quot;
#include &quot;llvm/CodeGen/Passes.h&quot;
#include &quot;llvm/CodeGen/TargetPassConfig.h&quot;
#include &quot;llvm/Support/TargetRegistry.h&quot;
using namespace llvm;

#define DEBUG_TYPE &quot;cpu0&quot;

extern &quot;C&quot; void LLVMInitializeCpu0Target() {
  // Register the target.
  //- Big endian Target Machine
  RegisterTargetMachine&lt;Cpu0ebTargetMachine&gt; X(TheCpu0Target);
  //- Little endian Target Machine
  RegisterTargetMachine&lt;Cpu0elTargetMachine&gt; Y(TheCpu0elTarget);
}

static std::string computeDataLayout(const Triple &amp;TT, StringRef CPU,
                                     const TargetOptions &amp;Options,
                                     bool isLittle) {
  std::string Ret = &quot;&quot;;
  // There are both little and big endian cpu0.
  if (isLittle)
    Ret += &quot;e&quot;;
  else
    Ret += &quot;E&quot;;

  Ret += &quot;-m:m&quot;;

  // Pointers are 32 bit on some ABIs.
  Ret += &quot;-p:32:32&quot;;

  // 8 and 16 bit integers only need to have natural alignment, but try to
  // align them to 32 bits. 64 bit integers have natural alignment.
  Ret += &quot;-i8:8:32-i16:16:32-i64:64&quot;;

  // 32 bit registers are always available and the stack is at least 64 bit
  // aligned.
  Ret += &quot;-n32-S64&quot;;

  return Ret;
}

static Reloc::Model getEffectiveRelocModel(CodeModel::Model CM,
                                           Optional&lt;Reloc::Model&gt; RM) {
  if (!RM.hasValue() || CM == CodeModel::JITDefault)
    return Reloc::Static;
  return *RM;
}

// DataLayout --&gt; Big-endian, 32-bit pointer/ABI/alignment
// The stack is always 8 byte aligned
// On function prologue, the stack is created by decrementing
// its pointer. Once decremented, all references are done with positive
// offset from the stack/frame pointer, using StackGrowsUp enables
// an easier handling.
// Using CodeModel::Large enables different CALL behavior.
Cpu0TargetMachine::Cpu0TargetMachine(const Target &amp;T, const Triple &amp;TT,
                                     StringRef CPU, StringRef FS,
                                     const TargetOptions &amp;Options,
                                     Optional&lt;Reloc::Model&gt; RM,
                                     CodeModel::Model CM, CodeGenOpt::Level OL,
                                     bool isLittle)
  //- Default is big endian
    : LLVMTargetMachine(T, computeDataLayout(TT, CPU, Options, isLittle), TT,
                        CPU, FS, Options, getEffectiveRelocModel(CM, RM), CM,
                        OL),
      isLittle(isLittle), TLOF(make_unique&lt;Cpu0TargetObjectFile&gt;()),
      ABI(Cpu0ABIInfo::computeTargetABI()),
      DefaultSubtarget(TT, CPU, FS, isLittle, *this) {
  // initAsmInfo will display features by llc -march=cpu0 -mcpu=help on 3.7 but
  // not on 3.6
  initAsmInfo();
}

Cpu0TargetMachine::~Cpu0TargetMachine() {}

void Cpu0ebTargetMachine::anchor() { }

Cpu0ebTargetMachine::Cpu0ebTargetMachine(const Target &amp;T, const Triple &amp;TT,
                                         StringRef CPU, StringRef FS,
                                         const TargetOptions &amp;Options,
                                         Optional&lt;Reloc::Model&gt; RM,
                                         CodeModel::Model CM,
                                         CodeGenOpt::Level OL)
    : Cpu0TargetMachine(T, TT, CPU, FS, Options, RM, CM, OL, false) {}

void Cpu0elTargetMachine::anchor() { }

Cpu0elTargetMachine::Cpu0elTargetMachine(const Target &amp;T, const Triple &amp;TT,
                                         StringRef CPU, StringRef FS,
                                         const TargetOptions &amp;Options,
                                         Optional&lt;Reloc::Model&gt; RM,
                                         CodeModel::Model CM,
                                         CodeGenOpt::Level OL)
    : Cpu0TargetMachine(T, TT, CPU, FS, Options, RM, CM, OL, true) {}

const Cpu0Subtarget *
Cpu0TargetMachine::getSubtargetImpl(const Function &amp;F) const {
  Attribute CPUAttr = F.getFnAttribute(&quot;target-cpu&quot;);
  Attribute FSAttr = F.getFnAttribute(&quot;target-features&quot;);

  std::string CPU = !CPUAttr.hasAttribute(Attribute::None)
                        ? CPUAttr.getValueAsString().str()
                        : TargetCPU;
  std::string FS = !FSAttr.hasAttribute(Attribute::None)
                       ? FSAttr.getValueAsString().str()
                       : TargetFS;

  auto &amp;I = SubtargetMap[CPU + FS];
  if (!I) {
    // This needs to be done before we create a new subtarget since any
    // creation will depend on the TM and the code generation flags on the
    // function that reside in TargetOptions.
    resetTargetOptions(F);
    I = llvm::make_unique&lt;Cpu0Subtarget&gt;(TargetTriple, CPU, FS, isLittle,
                                         *this);
  }
  return I.get();
}

namespace {
//@Cpu0PassConfig {
/// Cpu0 Code Generator Pass Configuration Options.
class Cpu0PassConfig : public TargetPassConfig {
public:
  Cpu0PassConfig(Cpu0TargetMachine *TM, PassManagerBase &amp;PM)
    : TargetPassConfig(TM, PM) {}

  Cpu0TargetMachine &amp;getCpu0TargetMachine() const {
    return getTM&lt;Cpu0TargetMachine&gt;();
  }

  const Cpu0Subtarget &amp;getCpu0Subtarget() const {
    return *getCpu0TargetMachine().getSubtargetImpl();
  }
};
} // namespace

TargetPassConfig *Cpu0TargetMachine::createPassConfig(PassManagerBase &amp;PM) {
  return new Cpu0PassConfig(this, PM);
}

</pre></div>
</div>
<p class="rubric">include/llvm/Target/TargetInstInfo.h</p>
<div class="highlight-c++"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">TargetInstrInfo</span> <span class="o">:</span> <span class="k">public</span> <span class="n">MCInstrInfo</span> <span class="p">{</span>
  <span class="n">TargetInstrInfo</span><span class="p">(</span><span class="k">const</span> <span class="n">TargetInstrInfo</span> <span class="o">&amp;</span><span class="p">)</span> <span class="o">=</span> <span class="k">delete</span><span class="p">;</span>
  <span class="kt">void</span> <span class="k">operator</span><span class="o">=</span><span class="p">(</span><span class="k">const</span> <span class="n">TargetInstrInfo</span> <span class="o">&amp;</span><span class="p">)</span> <span class="o">=</span> <span class="k">delete</span><span class="p">;</span>
<span class="k">public</span><span class="o">:</span>
  <span class="p">...</span>
<span class="p">}</span>
<span class="p">...</span>
<span class="k">class</span> <span class="nc">TargetInstrInfoImpl</span> <span class="o">:</span> <span class="k">public</span> <span class="n">TargetInstrInfo</span> <span class="p">{</span>
<span class="k">protected</span><span class="o">:</span>
  <span class="n">TargetInstrInfoImpl</span><span class="p">(</span><span class="kt">int</span> <span class="n">CallFrameSetupOpcode</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
            <span class="kt">int</span> <span class="n">CallFrameDestroyOpcode</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
  <span class="o">:</span> <span class="n">TargetInstrInfo</span><span class="p">(</span><span class="n">CallFrameSetupOpcode</span><span class="p">,</span> <span class="n">CallFrameDestroyOpcode</span><span class="p">)</span> <span class="p">{}</span>
<span class="k">public</span><span class="o">:</span>
  <span class="p">...</span>
<span class="p">}</span>
</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter3_1/Cpu0.td</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">include</span> <span class="s2">&quot;Cpu0CallingConv.td&quot;</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span>// Without this will have error: &#39;cpu032I&#39; is not a recognized processor for 
//  this target (ignoring processor)
//===----------------------------------------------------------------------===//
// Cpu0 Subtarget features                                                    //
//===----------------------------------------------------------------------===//


def FeatureChapter3_1  : SubtargetFeature&lt;&quot;ch3_1&quot;, &quot;HasChapterDummy&quot;, &quot;true&quot;,
                                &quot;Enable Chapter instructions.&quot;&gt;;
def FeatureChapter3_2  : SubtargetFeature&lt;&quot;ch3_2&quot;, &quot;HasChapterDummy&quot;, &quot;true&quot;,
                                &quot;Enable Chapter instructions.&quot;&gt;;
def FeatureChapter3_3  : SubtargetFeature&lt;&quot;ch3_3&quot;, &quot;HasChapterDummy&quot;, &quot;true&quot;,
                                &quot;Enable Chapter instructions.&quot;&gt;;
def FeatureChapter3_4  : SubtargetFeature&lt;&quot;ch3_4&quot;, &quot;HasChapterDummy&quot;, &quot;true&quot;,
                                &quot;Enable Chapter instructions.&quot;&gt;;
def FeatureChapter3_5  : SubtargetFeature&lt;&quot;ch3_5&quot;, &quot;HasChapterDummy&quot;, &quot;true&quot;,
                                &quot;Enable Chapter instructions.&quot;&gt;;
def FeatureChapter4_1  : SubtargetFeature&lt;&quot;ch4_1&quot;, &quot;HasChapterDummy&quot;, &quot;true&quot;,
                                &quot;Enable Chapter instructions.&quot;&gt;;
def FeatureChapter4_2  : SubtargetFeature&lt;&quot;ch4_2&quot;, &quot;HasChapterDummy&quot;, &quot;true&quot;,
                                &quot;Enable Chapter instructions.&quot;&gt;;
def FeatureChapter5_1  : SubtargetFeature&lt;&quot;ch5_1&quot;, &quot;HasChapterDummy&quot;, &quot;true&quot;,
                                &quot;Enable Chapter instructions.&quot;&gt;;
def FeatureChapter6_1  : SubtargetFeature&lt;&quot;ch6_1&quot;, &quot;HasChapterDummy&quot;, &quot;true&quot;,
                                &quot;Enable Chapter instructions.&quot;&gt;;
def FeatureChapter7_1  : SubtargetFeature&lt;&quot;ch7_1&quot;, &quot;HasChapterDummy&quot;, &quot;true&quot;,
                                &quot;Enable Chapter instructions.&quot;&gt;;
def FeatureChapter8_1  : SubtargetFeature&lt;&quot;ch8_1&quot;, &quot;HasChapterDummy&quot;, &quot;true&quot;,
                                &quot;Enable Chapter instructions.&quot;&gt;;
def FeatureChapter8_2  : SubtargetFeature&lt;&quot;ch8_2&quot;, &quot;HasChapterDummy&quot;, &quot;true&quot;,
                                &quot;Enable Chapter instructions.&quot;&gt;;
def FeatureChapter9_1  : SubtargetFeature&lt;&quot;ch9_1&quot;, &quot;HasChapterDummy&quot;, &quot;true&quot;,
                                &quot;Enable Chapter instructions.&quot;&gt;;
def FeatureChapter9_2  : SubtargetFeature&lt;&quot;ch9_2&quot;, &quot;HasChapterDummy&quot;, &quot;true&quot;,
                                &quot;Enable Chapter instructions.&quot;&gt;;
def FeatureChapter9_3  : SubtargetFeature&lt;&quot;ch9_3&quot;, &quot;HasChapterDummy&quot;, &quot;true&quot;,
                                &quot;Enable Chapter instructions.&quot;&gt;;
def FeatureChapter10_1 : SubtargetFeature&lt;&quot;ch10_1&quot;, &quot;HasChapterDummy&quot;, &quot;true&quot;,
                                &quot;Enable Chapter instructions.&quot;&gt;;
def FeatureChapter11_1 : SubtargetFeature&lt;&quot;ch11_1&quot;, &quot;HasChapterDummy&quot;, &quot;true&quot;,
                                &quot;Enable Chapter instructions.&quot;&gt;;
def FeatureChapter11_2 : SubtargetFeature&lt;&quot;ch11_2&quot;, &quot;HasChapterDummy&quot;, &quot;true&quot;,
                                &quot;Enable Chapter instructions.&quot;&gt;;
def FeatureChapter12_1 : SubtargetFeature&lt;&quot;ch12_1&quot;, &quot;HasChapterDummy&quot;, &quot;true&quot;,
                                &quot;Enable Chapter instructions.&quot;&gt;;
def FeatureChapterAll  : SubtargetFeature&lt;&quot;chall&quot;, &quot;HasChapterDummy&quot;, &quot;true&quot;,
                                &quot;Enable Chapter instructions.&quot;,
                                [FeatureChapter3_1, FeatureChapter3_2, 
                                 FeatureChapter3_3, FeatureChapter3_4, 
                                 FeatureChapter3_5, 
                                 FeatureChapter4_1, FeatureChapter4_2, 
                                 FeatureChapter5_1, FeatureChapter6_1, 
                                 FeatureChapter7_1, FeatureChapter8_1, 
                                 FeatureChapter8_2, FeatureChapter9_1, 
                                 FeatureChapter9_2, FeatureChapter9_3, 
                                 FeatureChapter10_1, 
                                 FeatureChapter11_1, FeatureChapter11_2, 
                                 FeatureChapter12_1]&gt;;


def FeatureCmp         : SubtargetFeature&lt;&quot;cmp&quot;, &quot;HasCmp&quot;, &quot;true&quot;,
                                &quot;Enable &#39;cmp&#39; instructions.&quot;&gt;;
def FeatureSlt         : SubtargetFeature&lt;&quot;slt&quot;, &quot;HasSlt&quot;, &quot;true&quot;,
                                &quot;Enable &#39;slt&#39; instructions.&quot;&gt;;
def FeatureCpu032I     : SubtargetFeature&lt;&quot;cpu032I&quot;, &quot;Cpu0ArchVersion&quot;, 
                                &quot;Cpu032I&quot;, &quot;Cpu032I ISA Support&quot;,
                                [FeatureCmp, FeatureChapterAll]&gt;;
def FeatureCpu032II    : SubtargetFeature&lt;&quot;cpu032II&quot;, &quot;Cpu0ArchVersion&quot;,                      
                               &quot;Cpu032II&quot;, &quot;Cpu032II ISA Support (slt)&quot;,
                                [FeatureCmp, FeatureSlt, FeatureChapterAll]&gt;;

//===----------------------------------------------------------------------===//
// Cpu0 processors supported.
//===----------------------------------------------------------------------===//

class Proc&lt;string Name, list&lt;SubtargetFeature&gt; Features&gt;
 : Processor&lt;Name, Cpu0GenericItineraries, Features&gt;;

def : Proc&lt;&quot;cpu032I&quot;,  [FeatureCpu032I]&gt;;
def : Proc&lt;&quot;cpu032II&quot;, [FeatureCpu032II]&gt;;
// Above make Cpu0GenSubtargetInfo.inc set feature bit as the following order
// enum {
//   FeatureCmp =  1ULL &lt;&lt; 0,
//   FeatureCpu032I =  1ULL &lt;&lt; 1,
//   FeatureCpu032II =  1ULL &lt;&lt; 2,
//   FeatureSlt =  1ULL &lt;&lt; 3
// };
</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter3_1/Cpu0CallingConv.td</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>//===-- Cpu0CallingConv.td - Calling Conventions for Cpu0 --*- tablegen -*-===//
//
//                     The LLVM Compiler Infrastructure
//
// This file is distributed under the University of Illinois Open Source
// License. See LICENSE.TXT for details.
//
//===----------------------------------------------------------------------===//
// This describes the calling conventions for Cpu0 architecture.
//===----------------------------------------------------------------------===//

/// CCIfSubtarget - Match if the current subtarget has a feature F.
class CCIfSubtarget&lt;string F, CCAction A&gt;:
  CCIf&lt;!strconcat(&quot;State.getTarget().getSubtarget&lt;Cpu0Subtarget&gt;().&quot;, F), A&gt;;

def CSR_O32 : CalleeSavedRegs&lt;(add LR, FP,
                                   (sequence &quot;S%u&quot;, 1, 0))&gt;;

</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter3_1/Cpu0FrameLowering.h</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">//===--</span> <span class="n">Cpu0FrameLowering</span><span class="o">.</span><span class="n">h</span> <span class="o">-</span> <span class="n">Define</span> <span class="n">frame</span> <span class="n">lowering</span> <span class="k">for</span> <span class="n">Cpu0</span> <span class="o">----*-</span> <span class="n">C</span><span class="o">++</span> <span class="o">-*-===//</span>
<span class="o">//</span>
<span class="o">//</span>                     <span class="n">The</span> <span class="n">LLVM</span> <span class="n">Compiler</span> <span class="n">Infrastructure</span>
<span class="o">//</span>
<span class="o">//</span> <span class="n">This</span> <span class="n">file</span> <span class="ow">is</span> <span class="n">distributed</span> <span class="n">under</span> <span class="n">the</span> <span class="n">University</span> <span class="n">of</span> <span class="n">Illinois</span> <span class="n">Open</span> <span class="n">Source</span>
<span class="o">//</span> <span class="n">License</span><span class="o">.</span> <span class="n">See</span> <span class="n">LICENSE</span><span class="o">.</span><span class="n">TXT</span> <span class="k">for</span> <span class="n">details</span><span class="o">.</span>
<span class="o">//</span>
<span class="o">//===----------------------------------------------------------------------===//</span>
<span class="o">//</span>
<span class="o">//</span>
<span class="o">//</span>
<span class="o">//===----------------------------------------------------------------------===//</span>
<span class="c1">#ifndef LLVM_LIB_TARGET_CPU0_CPU0FRAMELOWERING_H</span>
<span class="c1">#define LLVM_LIB_TARGET_CPU0_CPU0FRAMELOWERING_H</span>

<span class="c1">#include &quot;Cpu0Config.h&quot;</span>

<span class="c1">#include &quot;Cpu0.h&quot;</span>
<span class="c1">#include &quot;llvm/Target/TargetFrameLowering.h&quot;</span>

<span class="n">namespace</span> <span class="n">llvm</span> <span class="p">{</span>
  <span class="k">class</span> <span class="nc">Cpu0Subtarget</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">Cpu0FrameLowering</span> <span class="p">:</span> <span class="n">public</span> <span class="n">TargetFrameLowering</span> <span class="p">{</span>
<span class="n">protected</span><span class="p">:</span>
  <span class="n">const</span> <span class="n">Cpu0Subtarget</span> <span class="o">&amp;</span><span class="n">STI</span><span class="p">;</span>

<span class="n">public</span><span class="p">:</span>
  <span class="n">explicit</span> <span class="n">Cpu0FrameLowering</span><span class="p">(</span><span class="n">const</span> <span class="n">Cpu0Subtarget</span> <span class="o">&amp;</span><span class="n">sti</span><span class="p">,</span> <span class="n">unsigned</span> <span class="n">Alignment</span><span class="p">)</span>
    <span class="p">:</span> <span class="n">TargetFrameLowering</span><span class="p">(</span><span class="n">StackGrowsDown</span><span class="p">,</span> <span class="n">Alignment</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">Alignment</span><span class="p">),</span>
      <span class="n">STI</span><span class="p">(</span><span class="n">sti</span><span class="p">)</span> <span class="p">{</span>
  <span class="p">}</span>

  <span class="n">static</span> <span class="n">const</span> <span class="n">Cpu0FrameLowering</span> <span class="o">*</span><span class="n">create</span><span class="p">(</span><span class="n">const</span> <span class="n">Cpu0Subtarget</span> <span class="o">&amp;</span><span class="n">ST</span><span class="p">);</span>

  <span class="nb">bool</span> <span class="n">hasFP</span><span class="p">(</span><span class="n">const</span> <span class="n">MachineFunction</span> <span class="o">&amp;</span><span class="n">MF</span><span class="p">)</span> <span class="n">const</span> <span class="n">override</span><span class="p">;</span>

<span class="p">};</span>

<span class="o">///</span> <span class="n">Create</span> <span class="n">Cpu0FrameLowering</span> <span class="n">objects</span><span class="o">.</span>
<span class="n">const</span> <span class="n">Cpu0FrameLowering</span> <span class="o">*</span><span class="n">createCpu0SEFrameLowering</span><span class="p">(</span><span class="n">const</span> <span class="n">Cpu0Subtarget</span> <span class="o">&amp;</span><span class="n">ST</span><span class="p">);</span>

<span class="p">}</span> <span class="o">//</span> <span class="n">End</span> <span class="n">llvm</span> <span class="n">namespace</span>

<span class="c1">#endif</span>

</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter3_1/Cpu0FrameLowering.cpp</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>//===-- Cpu0FrameLowering.cpp - Cpu0 Frame Information --------------------===//
//
//                     The LLVM Compiler Infrastructure
//
// This file is distributed under the University of Illinois Open Source
// License. See LICENSE.TXT for details.
//
//===----------------------------------------------------------------------===//
//
// This file contains the Cpu0 implementation of TargetFrameLowering class.
//
//===----------------------------------------------------------------------===//

#include &quot;Cpu0FrameLowering.h&quot;

#include &quot;Cpu0InstrInfo.h&quot;
#include &quot;Cpu0MachineFunction.h&quot;
#include &quot;Cpu0Subtarget.h&quot;
#include &quot;llvm/CodeGen/MachineFrameInfo.h&quot;
#include &quot;llvm/CodeGen/MachineFunction.h&quot;
#include &quot;llvm/CodeGen/MachineInstrBuilder.h&quot;
#include &quot;llvm/CodeGen/MachineModuleInfo.h&quot;
#include &quot;llvm/CodeGen/MachineRegisterInfo.h&quot;
#include &quot;llvm/IR/DataLayout.h&quot;
#include &quot;llvm/IR/Function.h&quot;
#include &quot;llvm/Support/CommandLine.h&quot;
#include &quot;llvm/Target/TargetOptions.h&quot;

using namespace llvm;

//- emitPrologue() and emitEpilogue must exist for main(). 

//===----------------------------------------------------------------------===//
//
// Stack Frame Processing methods
// +----------------------------+
//
// The stack is allocated decrementing the stack pointer on
// the first instruction of a function prologue. Once decremented,
// all stack references are done thought a positive offset
// from the stack/frame pointer, so the stack is considering
// to grow up! Otherwise terrible hacks would have to be made
// to get this stack ABI compliant :)
//
//  The stack frame required by the ABI (after call):
//  Offset
//
//  0                 ----------
//  4                 Args to pass
//  .                 saved $GP  (used in PIC)
//  .                 Alloca allocations
//  .                 Local Area
//  .                 CPU &quot;Callee Saved&quot; Registers
//  .                 saved FP
//  .                 saved RA
//  .                 FPU &quot;Callee Saved&quot; Registers
//  StackSize         -----------
//
// Offset - offset from sp after stack allocation on function prologue
//
// The sp is the stack pointer subtracted/added from the stack size
// at the Prologue/Epilogue
//
// References to the previous stack (to obtain arguments) are done
// with offsets that exceeds the stack size: (stacksize+(4*(num_arg-1))
//
// Examples:
// - reference to the actual stack frame
//   for any local area var there is smt like : FI &gt;= 0, StackOffset: 4
//     st REGX, 4(SP)
//
// - reference to previous stack frame
//   suppose there&#39;s a load to the 5th arguments : FI &lt; 0, StackOffset: 16.
//   The emitted instruction will be something like:
//     ld REGX, 16+StackSize(SP)
//
// Since the total stack size is unknown on LowerFormalArguments, all
// stack references (ObjectOffset) created to reference the function
// arguments, are negative numbers. This way, on eliminateFrameIndex it&#39;s
// possible to detect those references and the offsets are adjusted to
// their real location.
//
//===----------------------------------------------------------------------===//

const Cpu0FrameLowering *Cpu0FrameLowering::create(const Cpu0Subtarget &amp;ST) {
  return llvm::createCpu0SEFrameLowering(ST);
}

// hasFP - Return true if the specified function should have a dedicated frame
// pointer register.  This is true if the function has variable sized allocas,
// if it needs dynamic stack realignment, if frame pointer elimination is
// disabled, or if the frame address is taken.
bool Cpu0FrameLowering::hasFP(const MachineFunction &amp;MF) const {
  const MachineFrameInfo *MFI = MF.getFrameInfo();
  const TargetRegisterInfo *TRI = STI.getRegisterInfo();

  return MF.getTarget().Options.DisableFramePointerElim(MF) ||
      MFI-&gt;hasVarSizedObjects() || MFI-&gt;isFrameAddressTaken() ||
      TRI-&gt;needsStackRealignment(MF);
}

</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter3_1/Cpu0SEFrameLowering.h</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">//===--</span> <span class="n">Cpu0SEFrameLowering</span><span class="o">.</span><span class="n">h</span> <span class="o">-</span> <span class="n">Cpu032</span><span class="o">/</span><span class="mi">64</span> <span class="n">frame</span> <span class="n">lowering</span> <span class="o">--------*-</span> <span class="n">C</span><span class="o">++</span> <span class="o">-*-===//</span>
<span class="o">//</span>
<span class="o">//</span>                     <span class="n">The</span> <span class="n">LLVM</span> <span class="n">Compiler</span> <span class="n">Infrastructure</span>
<span class="o">//</span>
<span class="o">//</span> <span class="n">This</span> <span class="n">file</span> <span class="ow">is</span> <span class="n">distributed</span> <span class="n">under</span> <span class="n">the</span> <span class="n">University</span> <span class="n">of</span> <span class="n">Illinois</span> <span class="n">Open</span> <span class="n">Source</span>
<span class="o">//</span> <span class="n">License</span><span class="o">.</span> <span class="n">See</span> <span class="n">LICENSE</span><span class="o">.</span><span class="n">TXT</span> <span class="k">for</span> <span class="n">details</span><span class="o">.</span>
<span class="o">//</span>
<span class="o">//===----------------------------------------------------------------------===//</span>
<span class="o">//</span>
<span class="o">//</span>
<span class="o">//</span>
<span class="o">//===----------------------------------------------------------------------===//</span>

<span class="c1">#ifndef LLVM_LIB_TARGET_CPU0_CPU0SEFRAMELOWERING_H</span>
<span class="c1">#define LLVM_LIB_TARGET_CPU0_CPU0SEFRAMELOWERING_H</span>

<span class="c1">#include &quot;Cpu0Config.h&quot;</span>

<span class="c1">#include &quot;Cpu0FrameLowering.h&quot;</span>

<span class="n">namespace</span> <span class="n">llvm</span> <span class="p">{</span>

<span class="k">class</span> <span class="nc">Cpu0SEFrameLowering</span> <span class="p">:</span> <span class="n">public</span> <span class="n">Cpu0FrameLowering</span> <span class="p">{</span>
<span class="n">public</span><span class="p">:</span>
  <span class="n">explicit</span> <span class="n">Cpu0SEFrameLowering</span><span class="p">(</span><span class="n">const</span> <span class="n">Cpu0Subtarget</span> <span class="o">&amp;</span><span class="n">STI</span><span class="p">);</span>

  <span class="o">///</span> <span class="n">emitProlog</span><span class="o">/</span><span class="n">emitEpilog</span> <span class="o">-</span> <span class="n">These</span> <span class="n">methods</span> <span class="n">insert</span> <span class="n">prolog</span> <span class="ow">and</span> <span class="n">epilog</span> <span class="n">code</span> <span class="n">into</span>
  <span class="o">///</span> <span class="n">the</span> <span class="n">function</span><span class="o">.</span>
  <span class="n">void</span> <span class="n">emitPrologue</span><span class="p">(</span><span class="n">MachineFunction</span> <span class="o">&amp;</span><span class="n">MF</span><span class="p">,</span> <span class="n">MachineBasicBlock</span> <span class="o">&amp;</span><span class="n">MBB</span><span class="p">)</span> <span class="n">const</span> <span class="n">override</span><span class="p">;</span>
  <span class="n">void</span> <span class="n">emitEpilogue</span><span class="p">(</span><span class="n">MachineFunction</span> <span class="o">&amp;</span><span class="n">MF</span><span class="p">,</span> <span class="n">MachineBasicBlock</span> <span class="o">&amp;</span><span class="n">MBB</span><span class="p">)</span> <span class="n">const</span> <span class="n">override</span><span class="p">;</span>

<span class="p">};</span>

<span class="p">}</span> <span class="o">//</span> <span class="n">End</span> <span class="n">llvm</span> <span class="n">namespace</span>

<span class="c1">#endif</span>

</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter3_1/Cpu0SEFrameLowering.cpp</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">//===--</span> <span class="n">Cpu0SEFrameLowering</span><span class="o">.</span><span class="n">cpp</span> <span class="o">-</span> <span class="n">Cpu0</span> <span class="n">Frame</span> <span class="n">Information</span> <span class="o">------------------===//</span>
<span class="o">//</span>
<span class="o">//</span>                     <span class="n">The</span> <span class="n">LLVM</span> <span class="n">Compiler</span> <span class="n">Infrastructure</span>
<span class="o">//</span>
<span class="o">//</span> <span class="n">This</span> <span class="n">file</span> <span class="ow">is</span> <span class="n">distributed</span> <span class="n">under</span> <span class="n">the</span> <span class="n">University</span> <span class="n">of</span> <span class="n">Illinois</span> <span class="n">Open</span> <span class="n">Source</span>
<span class="o">//</span> <span class="n">License</span><span class="o">.</span> <span class="n">See</span> <span class="n">LICENSE</span><span class="o">.</span><span class="n">TXT</span> <span class="k">for</span> <span class="n">details</span><span class="o">.</span>
<span class="o">//</span>
<span class="o">//===----------------------------------------------------------------------===//</span>
<span class="o">//</span>
<span class="o">//</span> <span class="n">This</span> <span class="n">file</span> <span class="n">contains</span> <span class="n">the</span> <span class="n">Cpu0</span> <span class="n">implementation</span> <span class="n">of</span> <span class="n">TargetFrameLowering</span> <span class="n">class</span><span class="o">.</span>
<span class="o">//</span>
<span class="o">//===----------------------------------------------------------------------===//</span>

<span class="c1">#include &quot;Cpu0SEFrameLowering.h&quot;</span>

<span class="c1">#include &quot;Cpu0MachineFunction.h&quot;</span>
<span class="c1">#include &quot;Cpu0SEInstrInfo.h&quot;</span>
<span class="c1">#include &quot;Cpu0Subtarget.h&quot;</span>
<span class="c1">#include &quot;llvm/CodeGen/MachineFrameInfo.h&quot;</span>
<span class="c1">#include &quot;llvm/CodeGen/MachineFunction.h&quot;</span>
<span class="c1">#include &quot;llvm/CodeGen/MachineInstrBuilder.h&quot;</span>
<span class="c1">#include &quot;llvm/CodeGen/MachineModuleInfo.h&quot;</span>
<span class="c1">#include &quot;llvm/CodeGen/MachineRegisterInfo.h&quot;</span>
<span class="c1">#include &quot;llvm/CodeGen/RegisterScavenging.h&quot;</span>
<span class="c1">#include &quot;llvm/IR/DataLayout.h&quot;</span>
<span class="c1">#include &quot;llvm/IR/Function.h&quot;</span>
<span class="c1">#include &quot;llvm/Support/CommandLine.h&quot;</span>
<span class="c1">#include &quot;llvm/Target/TargetOptions.h&quot;</span>

<span class="n">using</span> <span class="n">namespace</span> <span class="n">llvm</span><span class="p">;</span>

<span class="n">Cpu0SEFrameLowering</span><span class="p">::</span><span class="n">Cpu0SEFrameLowering</span><span class="p">(</span><span class="n">const</span> <span class="n">Cpu0Subtarget</span> <span class="o">&amp;</span><span class="n">STI</span><span class="p">)</span>
    <span class="p">:</span> <span class="n">Cpu0FrameLowering</span><span class="p">(</span><span class="n">STI</span><span class="p">,</span> <span class="n">STI</span><span class="o">.</span><span class="n">stackAlignment</span><span class="p">())</span> <span class="p">{}</span>

<span class="o">//</span><span class="nd">@emitPrologue</span> <span class="p">{</span>
<span class="n">void</span> <span class="n">Cpu0SEFrameLowering</span><span class="p">::</span><span class="n">emitPrologue</span><span class="p">(</span><span class="n">MachineFunction</span> <span class="o">&amp;</span><span class="n">MF</span><span class="p">,</span>
                                       <span class="n">MachineBasicBlock</span> <span class="o">&amp;</span><span class="n">MBB</span><span class="p">)</span> <span class="n">const</span> <span class="p">{</span>
<span class="p">}</span>
<span class="o">//</span><span class="p">}</span>

<span class="o">//</span><span class="nd">@emitEpilogue</span> <span class="p">{</span>
<span class="n">void</span> <span class="n">Cpu0SEFrameLowering</span><span class="p">::</span><span class="n">emitEpilogue</span><span class="p">(</span><span class="n">MachineFunction</span> <span class="o">&amp;</span><span class="n">MF</span><span class="p">,</span>
                                 <span class="n">MachineBasicBlock</span> <span class="o">&amp;</span><span class="n">MBB</span><span class="p">)</span> <span class="n">const</span> <span class="p">{</span>
<span class="p">}</span>
<span class="o">//</span><span class="p">}</span>

<span class="n">const</span> <span class="n">Cpu0FrameLowering</span> <span class="o">*</span>
<span class="n">llvm</span><span class="p">::</span><span class="n">createCpu0SEFrameLowering</span><span class="p">(</span><span class="n">const</span> <span class="n">Cpu0Subtarget</span> <span class="o">&amp;</span><span class="n">ST</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="n">new</span> <span class="n">Cpu0SEFrameLowering</span><span class="p">(</span><span class="n">ST</span><span class="p">);</span>
<span class="p">}</span>

</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter3_1/Cpu0InstrInfo.h</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">//===--</span> <span class="n">Cpu0InstrInfo</span><span class="o">.</span><span class="n">h</span> <span class="o">-</span> <span class="n">Cpu0</span> <span class="n">Instruction</span> <span class="n">Information</span> <span class="o">----------*-</span> <span class="n">C</span><span class="o">++</span> <span class="o">-*-===//</span>
<span class="o">//</span>
<span class="o">//</span>                     <span class="n">The</span> <span class="n">LLVM</span> <span class="n">Compiler</span> <span class="n">Infrastructure</span>
<span class="o">//</span>
<span class="o">//</span> <span class="n">This</span> <span class="n">file</span> <span class="ow">is</span> <span class="n">distributed</span> <span class="n">under</span> <span class="n">the</span> <span class="n">University</span> <span class="n">of</span> <span class="n">Illinois</span> <span class="n">Open</span> <span class="n">Source</span>
<span class="o">//</span> <span class="n">License</span><span class="o">.</span> <span class="n">See</span> <span class="n">LICENSE</span><span class="o">.</span><span class="n">TXT</span> <span class="k">for</span> <span class="n">details</span><span class="o">.</span>
<span class="o">//</span>
<span class="o">//===----------------------------------------------------------------------===//</span>
<span class="o">//</span>
<span class="o">//</span> <span class="n">This</span> <span class="n">file</span> <span class="n">contains</span> <span class="n">the</span> <span class="n">Cpu0</span> <span class="n">implementation</span> <span class="n">of</span> <span class="n">the</span> <span class="n">TargetInstrInfo</span> <span class="n">class</span><span class="o">.</span>
<span class="o">//</span>
<span class="o">//===----------------------------------------------------------------------===//</span>

<span class="c1">#ifndef LLVM_LIB_TARGET_CPU0_CPU0INSTRINFO_H</span>
<span class="c1">#define LLVM_LIB_TARGET_CPU0_CPU0INSTRINFO_H</span>

<span class="c1">#include &quot;Cpu0Config.h&quot;</span>

<span class="c1">#include &quot;Cpu0.h&quot;</span>
<span class="c1">#include &quot;Cpu0RegisterInfo.h&quot;</span>
<span class="c1">#include &quot;llvm/CodeGen/MachineInstrBuilder.h&quot;</span>
<span class="c1">#include &quot;llvm/Target/TargetInstrInfo.h&quot;</span>

<span class="c1">#define GET_INSTRINFO_HEADER</span>
<span class="c1">#include &quot;Cpu0GenInstrInfo.inc&quot;</span>

<span class="n">namespace</span> <span class="n">llvm</span> <span class="p">{</span>

<span class="k">class</span> <span class="nc">Cpu0InstrInfo</span> <span class="p">:</span> <span class="n">public</span> <span class="n">Cpu0GenInstrInfo</span> <span class="p">{</span>
  <span class="n">virtual</span> <span class="n">void</span> <span class="n">anchor</span><span class="p">();</span>
<span class="n">protected</span><span class="p">:</span>
  <span class="n">const</span> <span class="n">Cpu0Subtarget</span> <span class="o">&amp;</span><span class="n">Subtarget</span><span class="p">;</span>
<span class="n">public</span><span class="p">:</span>
  <span class="n">explicit</span> <span class="n">Cpu0InstrInfo</span><span class="p">(</span><span class="n">const</span> <span class="n">Cpu0Subtarget</span> <span class="o">&amp;</span><span class="n">STI</span><span class="p">);</span>

  <span class="n">static</span> <span class="n">const</span> <span class="n">Cpu0InstrInfo</span> <span class="o">*</span><span class="n">create</span><span class="p">(</span><span class="n">Cpu0Subtarget</span> <span class="o">&amp;</span><span class="n">STI</span><span class="p">);</span>

  <span class="o">///</span> <span class="n">getRegisterInfo</span> <span class="o">-</span> <span class="n">TargetInstrInfo</span> <span class="ow">is</span> <span class="n">a</span> <span class="n">superset</span> <span class="n">of</span> <span class="n">MRegister</span> <span class="n">info</span><span class="o">.</span>  <span class="n">As</span>
  <span class="o">///</span> <span class="n">such</span><span class="p">,</span> <span class="n">whenever</span> <span class="n">a</span> <span class="n">client</span> <span class="n">has</span> <span class="n">an</span> <span class="n">instance</span> <span class="n">of</span> <span class="n">instruction</span> <span class="n">info</span><span class="p">,</span> <span class="n">it</span> <span class="n">should</span>
  <span class="o">///</span> <span class="n">always</span> <span class="n">be</span> <span class="n">able</span> <span class="n">to</span> <span class="n">get</span> <span class="n">register</span> <span class="n">info</span> <span class="k">as</span> <span class="n">well</span> <span class="p">(</span><span class="n">through</span> <span class="n">this</span> <span class="n">method</span><span class="p">)</span><span class="o">.</span>
  <span class="o">///</span>
  <span class="n">virtual</span> <span class="n">const</span> <span class="n">Cpu0RegisterInfo</span> <span class="o">&amp;</span><span class="n">getRegisterInfo</span><span class="p">()</span> <span class="n">const</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

  <span class="o">///</span> <span class="n">Return</span> <span class="n">the</span> <span class="n">number</span> <span class="n">of</span> <span class="nb">bytes</span> <span class="n">of</span> <span class="n">code</span> <span class="n">the</span> <span class="n">specified</span> <span class="n">instruction</span> <span class="n">may</span> <span class="n">be</span><span class="o">.</span>
  <span class="n">unsigned</span> <span class="n">GetInstSizeInBytes</span><span class="p">(</span><span class="n">const</span> <span class="n">MachineInstr</span> <span class="o">&amp;</span><span class="n">MI</span><span class="p">)</span> <span class="n">const</span><span class="p">;</span>

<span class="n">protected</span><span class="p">:</span>
<span class="p">};</span>
<span class="n">const</span> <span class="n">Cpu0InstrInfo</span> <span class="o">*</span><span class="n">createCpu0SEInstrInfo</span><span class="p">(</span><span class="n">const</span> <span class="n">Cpu0Subtarget</span> <span class="o">&amp;</span><span class="n">STI</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">#endif</span>

</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter3_1/Cpu0InstrInfo.cpp</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">//===--</span> <span class="n">Cpu0InstrInfo</span><span class="o">.</span><span class="n">cpp</span> <span class="o">-</span> <span class="n">Cpu0</span> <span class="n">Instruction</span> <span class="n">Information</span> <span class="o">------------------===//</span>
<span class="o">//</span>
<span class="o">//</span>                     <span class="n">The</span> <span class="n">LLVM</span> <span class="n">Compiler</span> <span class="n">Infrastructure</span>
<span class="o">//</span>
<span class="o">//</span> <span class="n">This</span> <span class="n">file</span> <span class="ow">is</span> <span class="n">distributed</span> <span class="n">under</span> <span class="n">the</span> <span class="n">University</span> <span class="n">of</span> <span class="n">Illinois</span> <span class="n">Open</span> <span class="n">Source</span>
<span class="o">//</span> <span class="n">License</span><span class="o">.</span> <span class="n">See</span> <span class="n">LICENSE</span><span class="o">.</span><span class="n">TXT</span> <span class="k">for</span> <span class="n">details</span><span class="o">.</span>
<span class="o">//</span>
<span class="o">//===----------------------------------------------------------------------===//</span>
<span class="o">//</span>
<span class="o">//</span> <span class="n">This</span> <span class="n">file</span> <span class="n">contains</span> <span class="n">the</span> <span class="n">Cpu0</span> <span class="n">implementation</span> <span class="n">of</span> <span class="n">the</span> <span class="n">TargetInstrInfo</span> <span class="n">class</span><span class="o">.</span>
<span class="o">//</span>
<span class="o">//===----------------------------------------------------------------------===//</span>

<span class="c1">#include &quot;Cpu0InstrInfo.h&quot;</span>

<span class="c1">#include &quot;Cpu0TargetMachine.h&quot;</span>
<span class="c1">#include &quot;Cpu0MachineFunction.h&quot;</span>
<span class="c1">#include &quot;llvm/ADT/STLExtras.h&quot;</span>
<span class="c1">#include &quot;llvm/CodeGen/MachineInstrBuilder.h&quot;</span>
<span class="c1">#include &quot;llvm/Support/ErrorHandling.h&quot;</span>
<span class="c1">#include &quot;llvm/Support/TargetRegistry.h&quot;</span>

<span class="n">using</span> <span class="n">namespace</span> <span class="n">llvm</span><span class="p">;</span>

<span class="c1">#define GET_INSTRINFO_CTOR_DTOR</span>
<span class="c1">#include &quot;Cpu0GenInstrInfo.inc&quot;</span>

<span class="o">//</span> <span class="n">Pin</span> <span class="n">the</span> <span class="n">vtable</span> <span class="n">to</span> <span class="n">this</span> <span class="n">file</span><span class="o">.</span>
<span class="n">void</span> <span class="n">Cpu0InstrInfo</span><span class="p">::</span><span class="n">anchor</span><span class="p">()</span> <span class="p">{}</span>

<span class="o">//</span><span class="nd">@Cpu0InstrInfo</span> <span class="p">{</span>
<span class="n">Cpu0InstrInfo</span><span class="p">::</span><span class="n">Cpu0InstrInfo</span><span class="p">(</span><span class="n">const</span> <span class="n">Cpu0Subtarget</span> <span class="o">&amp;</span><span class="n">STI</span><span class="p">)</span>
    <span class="p">:</span> 
      <span class="n">Subtarget</span><span class="p">(</span><span class="n">STI</span><span class="p">)</span> <span class="p">{}</span>

<span class="n">const</span> <span class="n">Cpu0InstrInfo</span> <span class="o">*</span><span class="n">Cpu0InstrInfo</span><span class="p">::</span><span class="n">create</span><span class="p">(</span><span class="n">Cpu0Subtarget</span> <span class="o">&amp;</span><span class="n">STI</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="n">llvm</span><span class="p">::</span><span class="n">createCpu0SEInstrInfo</span><span class="p">(</span><span class="n">STI</span><span class="p">);</span>
<span class="p">}</span>

<span class="o">//</span><span class="nd">@GetInstSizeInBytes</span> <span class="p">{</span>
<span class="o">///</span> <span class="n">Return</span> <span class="n">the</span> <span class="n">number</span> <span class="n">of</span> <span class="nb">bytes</span> <span class="n">of</span> <span class="n">code</span> <span class="n">the</span> <span class="n">specified</span> <span class="n">instruction</span> <span class="n">may</span> <span class="n">be</span><span class="o">.</span>
<span class="n">unsigned</span> <span class="n">Cpu0InstrInfo</span><span class="p">::</span><span class="n">GetInstSizeInBytes</span><span class="p">(</span><span class="n">const</span> <span class="n">MachineInstr</span> <span class="o">&amp;</span><span class="n">MI</span><span class="p">)</span> <span class="n">const</span> <span class="p">{</span>
<span class="o">//</span><span class="nd">@GetInstSizeInBytes</span> <span class="o">-</span> <span class="n">body</span>
  <span class="n">switch</span> <span class="p">(</span><span class="n">MI</span><span class="o">.</span><span class="n">getOpcode</span><span class="p">())</span> <span class="p">{</span>
  <span class="n">default</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">MI</span><span class="o">.</span><span class="n">getDesc</span><span class="p">()</span><span class="o">.</span><span class="n">getSize</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">}</span>

</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter3_1/Cpu0InstrInfo.td</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">//===----------------------------------------------------------------------===//</span>
<span class="o">//</span> <span class="n">Cpu0</span> <span class="n">Instruction</span> <span class="n">Predicate</span> <span class="n">Definitions</span><span class="o">.</span>
<span class="o">//===----------------------------------------------------------------------===//</span>

<span class="k">def</span> <span class="nf">Ch3_1</span>       <span class="p">:</span>     <span class="n">Predicate</span><span class="o">&lt;</span><span class="s2">&quot;Subtarget-&gt;hasChapter3_1()&quot;</span><span class="o">&gt;</span><span class="p">,</span>
                      <span class="n">AssemblerPredicate</span><span class="o">&lt;</span><span class="s2">&quot;FeatureChapter3_1&quot;</span><span class="o">&gt;</span><span class="p">;</span>
<span class="k">def</span> <span class="nf">Ch3_2</span>       <span class="p">:</span>     <span class="n">Predicate</span><span class="o">&lt;</span><span class="s2">&quot;Subtarget-&gt;hasChapter3_2()&quot;</span><span class="o">&gt;</span><span class="p">,</span>
                      <span class="n">AssemblerPredicate</span><span class="o">&lt;</span><span class="s2">&quot;FeatureChapter3_2&quot;</span><span class="o">&gt;</span><span class="p">;</span>
<span class="k">def</span> <span class="nf">Ch3_3</span>       <span class="p">:</span>     <span class="n">Predicate</span><span class="o">&lt;</span><span class="s2">&quot;Subtarget-&gt;hasChapter3_3()&quot;</span><span class="o">&gt;</span><span class="p">,</span>
                      <span class="n">AssemblerPredicate</span><span class="o">&lt;</span><span class="s2">&quot;FeatureChapter3_3&quot;</span><span class="o">&gt;</span><span class="p">;</span>
<span class="k">def</span> <span class="nf">Ch3_4</span>       <span class="p">:</span>     <span class="n">Predicate</span><span class="o">&lt;</span><span class="s2">&quot;Subtarget-&gt;hasChapter3_4()&quot;</span><span class="o">&gt;</span><span class="p">,</span>
                      <span class="n">AssemblerPredicate</span><span class="o">&lt;</span><span class="s2">&quot;FeatureChapter3_4&quot;</span><span class="o">&gt;</span><span class="p">;</span>
<span class="k">def</span> <span class="nf">Ch3_5</span>       <span class="p">:</span>     <span class="n">Predicate</span><span class="o">&lt;</span><span class="s2">&quot;Subtarget-&gt;hasChapter3_5()&quot;</span><span class="o">&gt;</span><span class="p">,</span>
                      <span class="n">AssemblerPredicate</span><span class="o">&lt;</span><span class="s2">&quot;FeatureChapter3_5&quot;</span><span class="o">&gt;</span><span class="p">;</span>
<span class="k">def</span> <span class="nf">Ch4_1</span>       <span class="p">:</span>     <span class="n">Predicate</span><span class="o">&lt;</span><span class="s2">&quot;Subtarget-&gt;hasChapter4_1()&quot;</span><span class="o">&gt;</span><span class="p">,</span>
                      <span class="n">AssemblerPredicate</span><span class="o">&lt;</span><span class="s2">&quot;FeatureChapter4_1&quot;</span><span class="o">&gt;</span><span class="p">;</span>
<span class="k">def</span> <span class="nf">Ch4_2</span>       <span class="p">:</span>     <span class="n">Predicate</span><span class="o">&lt;</span><span class="s2">&quot;Subtarget-&gt;hasChapter4_2()&quot;</span><span class="o">&gt;</span><span class="p">,</span>
                      <span class="n">AssemblerPredicate</span><span class="o">&lt;</span><span class="s2">&quot;FeatureChapter4_2&quot;</span><span class="o">&gt;</span><span class="p">;</span>
<span class="k">def</span> <span class="nf">Ch5_1</span>       <span class="p">:</span>     <span class="n">Predicate</span><span class="o">&lt;</span><span class="s2">&quot;Subtarget-&gt;hasChapter5_1()&quot;</span><span class="o">&gt;</span><span class="p">,</span>
                      <span class="n">AssemblerPredicate</span><span class="o">&lt;</span><span class="s2">&quot;FeatureChapter5_1&quot;</span><span class="o">&gt;</span><span class="p">;</span>
<span class="k">def</span> <span class="nf">Ch6_1</span>       <span class="p">:</span>     <span class="n">Predicate</span><span class="o">&lt;</span><span class="s2">&quot;Subtarget-&gt;hasChapter6_1()&quot;</span><span class="o">&gt;</span><span class="p">,</span>
                      <span class="n">AssemblerPredicate</span><span class="o">&lt;</span><span class="s2">&quot;FeatureChapter6_1&quot;</span><span class="o">&gt;</span><span class="p">;</span>
<span class="k">def</span> <span class="nf">Ch7_1</span>       <span class="p">:</span>     <span class="n">Predicate</span><span class="o">&lt;</span><span class="s2">&quot;Subtarget-&gt;hasChapter7_1()&quot;</span><span class="o">&gt;</span><span class="p">,</span>
                      <span class="n">AssemblerPredicate</span><span class="o">&lt;</span><span class="s2">&quot;FeatureChapter7_1&quot;</span><span class="o">&gt;</span><span class="p">;</span>
<span class="k">def</span> <span class="nf">Ch8_1</span>       <span class="p">:</span>     <span class="n">Predicate</span><span class="o">&lt;</span><span class="s2">&quot;Subtarget-&gt;hasChapter8_1()&quot;</span><span class="o">&gt;</span><span class="p">,</span>
                      <span class="n">AssemblerPredicate</span><span class="o">&lt;</span><span class="s2">&quot;FeatureChapter8_1&quot;</span><span class="o">&gt;</span><span class="p">;</span>
<span class="k">def</span> <span class="nf">Ch8_2</span>       <span class="p">:</span>     <span class="n">Predicate</span><span class="o">&lt;</span><span class="s2">&quot;Subtarget-&gt;hasChapter8_2()&quot;</span><span class="o">&gt;</span><span class="p">,</span>
                      <span class="n">AssemblerPredicate</span><span class="o">&lt;</span><span class="s2">&quot;FeatureChapter8_2&quot;</span><span class="o">&gt;</span><span class="p">;</span>
<span class="k">def</span> <span class="nf">Ch9_1</span>       <span class="p">:</span>     <span class="n">Predicate</span><span class="o">&lt;</span><span class="s2">&quot;Subtarget-&gt;hasChapter9_1()&quot;</span><span class="o">&gt;</span><span class="p">,</span>
                      <span class="n">AssemblerPredicate</span><span class="o">&lt;</span><span class="s2">&quot;FeatureChapter9_1&quot;</span><span class="o">&gt;</span><span class="p">;</span>
<span class="k">def</span> <span class="nf">Ch9_2</span>       <span class="p">:</span>     <span class="n">Predicate</span><span class="o">&lt;</span><span class="s2">&quot;Subtarget-&gt;hasChapter9_2()&quot;</span><span class="o">&gt;</span><span class="p">,</span>
                      <span class="n">AssemblerPredicate</span><span class="o">&lt;</span><span class="s2">&quot;FeatureChapter9_2&quot;</span><span class="o">&gt;</span><span class="p">;</span>
<span class="k">def</span> <span class="nf">Ch9_3</span>       <span class="p">:</span>     <span class="n">Predicate</span><span class="o">&lt;</span><span class="s2">&quot;Subtarget-&gt;hasChapter9_3()&quot;</span><span class="o">&gt;</span><span class="p">,</span>
                      <span class="n">AssemblerPredicate</span><span class="o">&lt;</span><span class="s2">&quot;FeatureChapter9_3&quot;</span><span class="o">&gt;</span><span class="p">;</span>
<span class="k">def</span> <span class="nf">Ch10_1</span>      <span class="p">:</span>     <span class="n">Predicate</span><span class="o">&lt;</span><span class="s2">&quot;Subtarget-&gt;hasChapter10_1()&quot;</span><span class="o">&gt;</span><span class="p">,</span>
                      <span class="n">AssemblerPredicate</span><span class="o">&lt;</span><span class="s2">&quot;FeatureChapter10_1&quot;</span><span class="o">&gt;</span><span class="p">;</span>
<span class="k">def</span> <span class="nf">Ch11_1</span>      <span class="p">:</span>     <span class="n">Predicate</span><span class="o">&lt;</span><span class="s2">&quot;Subtarget-&gt;hasChapter11_1()&quot;</span><span class="o">&gt;</span><span class="p">,</span>
                      <span class="n">AssemblerPredicate</span><span class="o">&lt;</span><span class="s2">&quot;FeatureChapter11_1&quot;</span><span class="o">&gt;</span><span class="p">;</span>
<span class="k">def</span> <span class="nf">Ch11_2</span>      <span class="p">:</span>     <span class="n">Predicate</span><span class="o">&lt;</span><span class="s2">&quot;Subtarget-&gt;hasChapter11_2()&quot;</span><span class="o">&gt;</span><span class="p">,</span>
                      <span class="n">AssemblerPredicate</span><span class="o">&lt;</span><span class="s2">&quot;FeatureChapter11_2&quot;</span><span class="o">&gt;</span><span class="p">;</span>
<span class="k">def</span> <span class="nf">Ch12_1</span>      <span class="p">:</span>     <span class="n">Predicate</span><span class="o">&lt;</span><span class="s2">&quot;Subtarget-&gt;hasChapter12_1()&quot;</span><span class="o">&gt;</span><span class="p">,</span>
                      <span class="n">AssemblerPredicate</span><span class="o">&lt;</span><span class="s2">&quot;FeatureChapter12_1&quot;</span><span class="o">&gt;</span><span class="p">;</span>
<span class="k">def</span> <span class="nf">Ch_all</span>      <span class="p">:</span>     <span class="n">Predicate</span><span class="o">&lt;</span><span class="s2">&quot;Subtarget-&gt;hasChapterAll()&quot;</span><span class="o">&gt;</span><span class="p">,</span>
                      <span class="n">AssemblerPredicate</span><span class="o">&lt;</span><span class="s2">&quot;FeatureChapterAll&quot;</span><span class="o">&gt;</span><span class="p">;</span>

<span class="k">def</span> <span class="nf">EnableOverflow</span>  <span class="p">:</span> <span class="n">Predicate</span><span class="o">&lt;</span><span class="s2">&quot;Subtarget-&gt;enableOverflow()&quot;</span><span class="o">&gt;</span><span class="p">;</span>
<span class="k">def</span> <span class="nf">DisableOverflow</span> <span class="p">:</span> <span class="n">Predicate</span><span class="o">&lt;</span><span class="s2">&quot;Subtarget-&gt;disableOverflow()&quot;</span><span class="o">&gt;</span><span class="p">;</span>

<span class="k">def</span> <span class="nf">HasCmp</span>      <span class="p">:</span>     <span class="n">Predicate</span><span class="o">&lt;</span><span class="s2">&quot;Subtarget-&gt;hasCmp()&quot;</span><span class="o">&gt;</span><span class="p">;</span>
<span class="k">def</span> <span class="nf">HasSlt</span>      <span class="p">:</span>     <span class="n">Predicate</span><span class="o">&lt;</span><span class="s2">&quot;Subtarget-&gt;hasSlt()&quot;</span><span class="o">&gt;</span><span class="p">;</span>
</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter3_1/Cpu0ISelLowering.h</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">//===--</span> <span class="n">Cpu0ISelLowering</span><span class="o">.</span><span class="n">h</span> <span class="o">-</span> <span class="n">Cpu0</span> <span class="n">DAG</span> <span class="n">Lowering</span> <span class="n">Interface</span> <span class="o">--------*-</span> <span class="n">C</span><span class="o">++</span> <span class="o">-*-===//</span>
<span class="o">//</span>
<span class="o">//</span>                     <span class="n">The</span> <span class="n">LLVM</span> <span class="n">Compiler</span> <span class="n">Infrastructure</span>
<span class="o">//</span>
<span class="o">//</span> <span class="n">This</span> <span class="n">file</span> <span class="ow">is</span> <span class="n">distributed</span> <span class="n">under</span> <span class="n">the</span> <span class="n">University</span> <span class="n">of</span> <span class="n">Illinois</span> <span class="n">Open</span> <span class="n">Source</span>
<span class="o">//</span> <span class="n">License</span><span class="o">.</span> <span class="n">See</span> <span class="n">LICENSE</span><span class="o">.</span><span class="n">TXT</span> <span class="k">for</span> <span class="n">details</span><span class="o">.</span>
<span class="o">//</span>
<span class="o">//===----------------------------------------------------------------------===//</span>
<span class="o">//</span>
<span class="o">//</span> <span class="n">This</span> <span class="n">file</span> <span class="n">defines</span> <span class="n">the</span> <span class="n">interfaces</span> <span class="n">that</span> <span class="n">Cpu0</span> <span class="n">uses</span> <span class="n">to</span> <span class="n">lower</span> <span class="n">LLVM</span> <span class="n">code</span> <span class="n">into</span> <span class="n">a</span>
<span class="o">//</span> <span class="n">selection</span> <span class="n">DAG</span><span class="o">.</span>
<span class="o">//</span>
<span class="o">//===----------------------------------------------------------------------===//</span>

<span class="c1">#ifndef LLVM_LIB_TARGET_CPU0_CPU0ISELLOWERING_H</span>
<span class="c1">#define LLVM_LIB_TARGET_CPU0_CPU0ISELLOWERING_H</span>

<span class="c1">#include &quot;Cpu0Config.h&quot;</span>

<span class="c1">#include &quot;MCTargetDesc/Cpu0ABIInfo.h&quot;</span>
<span class="c1">#include &quot;Cpu0.h&quot;</span>
<span class="c1">#include &quot;llvm/CodeGen/CallingConvLower.h&quot;</span>
<span class="c1">#include &quot;llvm/CodeGen/SelectionDAG.h&quot;</span>
<span class="c1">#include &quot;llvm/IR/Function.h&quot;</span>
<span class="c1">#include &quot;llvm/Target/TargetLowering.h&quot;</span>
<span class="c1">#include &lt;deque&gt;</span>

<span class="n">namespace</span> <span class="n">llvm</span> <span class="p">{</span>
  <span class="n">namespace</span> <span class="n">Cpu0ISD</span> <span class="p">{</span>
    <span class="n">enum</span> <span class="n">NodeType</span> <span class="p">{</span>
      <span class="o">//</span> <span class="n">Start</span> <span class="n">the</span> <span class="n">numbering</span> <span class="kn">from</span> <span class="nn">where</span> <span class="n">ISD</span> <span class="n">NodeType</span> <span class="n">finishes</span><span class="o">.</span>
      <span class="n">FIRST_NUMBER</span> <span class="o">=</span> <span class="n">ISD</span><span class="p">::</span><span class="n">BUILTIN_OP_END</span><span class="p">,</span>

      <span class="o">//</span> <span class="n">Jump</span> <span class="ow">and</span> <span class="n">link</span> <span class="p">(</span><span class="n">call</span><span class="p">)</span>
      <span class="n">JmpLink</span><span class="p">,</span>

      <span class="o">//</span> <span class="n">Tail</span> <span class="n">call</span>
      <span class="n">TailCall</span><span class="p">,</span>

      <span class="o">//</span> <span class="n">Get</span> <span class="n">the</span> <span class="n">Higher</span> <span class="mi">16</span> <span class="n">bits</span> <span class="kn">from</span> <span class="nn">a</span> <span class="mi">32</span><span class="o">-</span><span class="n">bit</span> <span class="n">immediate</span>
      <span class="o">//</span> <span class="n">No</span> <span class="n">relation</span> <span class="k">with</span> <span class="n">Cpu0</span> <span class="n">Hi</span> <span class="n">register</span>
      <span class="n">Hi</span><span class="p">,</span>
      <span class="o">//</span> <span class="n">Get</span> <span class="n">the</span> <span class="n">Lower</span> <span class="mi">16</span> <span class="n">bits</span> <span class="kn">from</span> <span class="nn">a</span> <span class="mi">32</span><span class="o">-</span><span class="n">bit</span> <span class="n">immediate</span>
      <span class="o">//</span> <span class="n">No</span> <span class="n">relation</span> <span class="k">with</span> <span class="n">Cpu0</span> <span class="n">Lo</span> <span class="n">register</span>
      <span class="n">Lo</span><span class="p">,</span>

      <span class="o">//</span> <span class="n">Handle</span> <span class="n">gp_rel</span> <span class="p">(</span><span class="n">small</span> <span class="n">data</span><span class="o">/</span><span class="n">bss</span> <span class="n">sections</span><span class="p">)</span> <span class="n">relocation</span><span class="o">.</span>
      <span class="n">GPRel</span><span class="p">,</span>

      <span class="o">//</span> <span class="n">Thread</span> <span class="n">Pointer</span>
      <span class="n">ThreadPointer</span><span class="p">,</span>

      <span class="o">//</span> <span class="n">Return</span>
      <span class="n">Ret</span><span class="p">,</span>

      <span class="n">EH_RETURN</span><span class="p">,</span>

      <span class="o">//</span> <span class="n">DivRem</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>
      <span class="n">DivRem</span><span class="p">,</span>
      <span class="n">DivRemU</span><span class="p">,</span>

      <span class="n">Wrapper</span><span class="p">,</span>
      <span class="n">DynAlloc</span><span class="p">,</span>

      <span class="n">Sync</span>
    <span class="p">};</span>
  <span class="p">}</span>

  <span class="o">//===--------------------------------------------------------------------===//</span>
  <span class="o">//</span> <span class="n">TargetLowering</span> <span class="n">Implementation</span>
  <span class="o">//===--------------------------------------------------------------------===//</span>
  <span class="k">class</span> <span class="nc">Cpu0FunctionInfo</span><span class="p">;</span>
  <span class="k">class</span> <span class="nc">Cpu0Subtarget</span><span class="p">;</span>

  <span class="o">//</span><span class="nd">@class</span> <span class="n">Cpu0TargetLowering</span>
  <span class="k">class</span> <span class="nc">Cpu0TargetLowering</span> <span class="p">:</span> <span class="n">public</span> <span class="n">TargetLowering</span>  <span class="p">{</span>
  <span class="n">public</span><span class="p">:</span>
    <span class="n">explicit</span> <span class="n">Cpu0TargetLowering</span><span class="p">(</span><span class="n">const</span> <span class="n">Cpu0TargetMachine</span> <span class="o">&amp;</span><span class="n">TM</span><span class="p">,</span>
                                <span class="n">const</span> <span class="n">Cpu0Subtarget</span> <span class="o">&amp;</span><span class="n">STI</span><span class="p">);</span>

    <span class="n">static</span> <span class="n">const</span> <span class="n">Cpu0TargetLowering</span> <span class="o">*</span><span class="n">create</span><span class="p">(</span><span class="n">const</span> <span class="n">Cpu0TargetMachine</span> <span class="o">&amp;</span><span class="n">TM</span><span class="p">,</span>
                                            <span class="n">const</span> <span class="n">Cpu0Subtarget</span> <span class="o">&amp;</span><span class="n">STI</span><span class="p">);</span>

    <span class="o">///</span> <span class="n">getTargetNodeName</span> <span class="o">-</span> <span class="n">This</span> <span class="n">method</span> <span class="n">returns</span> <span class="n">the</span> <span class="n">name</span> <span class="n">of</span> <span class="n">a</span> <span class="n">target</span> <span class="n">specific</span>
    <span class="o">//</span>  <span class="n">DAG</span> <span class="n">node</span><span class="o">.</span>
    <span class="n">const</span> <span class="n">char</span> <span class="o">*</span><span class="n">getTargetNodeName</span><span class="p">(</span><span class="n">unsigned</span> <span class="n">Opcode</span><span class="p">)</span> <span class="n">const</span> <span class="n">override</span><span class="p">;</span>

  <span class="n">protected</span><span class="p">:</span>

    <span class="o">///</span> <span class="n">ByValArgInfo</span> <span class="o">-</span> <span class="n">Byval</span> <span class="n">argument</span> <span class="n">information</span><span class="o">.</span>
    <span class="n">struct</span> <span class="n">ByValArgInfo</span> <span class="p">{</span>
      <span class="n">unsigned</span> <span class="n">FirstIdx</span><span class="p">;</span> <span class="o">//</span> <span class="n">Index</span> <span class="n">of</span> <span class="n">the</span> <span class="n">first</span> <span class="n">register</span> <span class="n">used</span><span class="o">.</span>
      <span class="n">unsigned</span> <span class="n">NumRegs</span><span class="p">;</span>  <span class="o">//</span> <span class="n">Number</span> <span class="n">of</span> <span class="n">registers</span> <span class="n">used</span> <span class="k">for</span> <span class="n">this</span> <span class="n">argument</span><span class="o">.</span>
      <span class="n">unsigned</span> <span class="n">Address</span><span class="p">;</span>  <span class="o">//</span> <span class="n">Offset</span> <span class="n">of</span> <span class="n">the</span> <span class="n">stack</span> <span class="n">area</span> <span class="n">used</span> <span class="n">to</span> <span class="k">pass</span> <span class="n">this</span> <span class="n">argument</span><span class="o">.</span>

      <span class="n">ByValArgInfo</span><span class="p">()</span> <span class="p">:</span> <span class="n">FirstIdx</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">NumRegs</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">Address</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="p">{}</span>
    <span class="p">};</span>

  <span class="n">protected</span><span class="p">:</span>
    <span class="o">//</span> <span class="n">Subtarget</span> <span class="n">Info</span>
    <span class="n">const</span> <span class="n">Cpu0Subtarget</span> <span class="o">&amp;</span><span class="n">Subtarget</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Cache</span> <span class="n">the</span> <span class="n">ABI</span> <span class="kn">from</span> <span class="nn">the</span> <span class="n">TargetMachine</span><span class="p">,</span> <span class="n">we</span> <span class="n">use</span> <span class="n">it</span> <span class="n">everywhere</span><span class="o">.</span>
    <span class="n">const</span> <span class="n">Cpu0ABIInfo</span> <span class="o">&amp;</span><span class="n">ABI</span><span class="p">;</span>

  <span class="n">private</span><span class="p">:</span>

    <span class="o">//</span> <span class="n">Lower</span> <span class="n">Operand</span> <span class="n">specifics</span>
    <span class="n">SDValue</span> <span class="n">lowerGlobalAddress</span><span class="p">(</span><span class="n">SDValue</span> <span class="n">Op</span><span class="p">,</span> <span class="n">SelectionDAG</span> <span class="o">&amp;</span><span class="n">DAG</span><span class="p">)</span> <span class="n">const</span><span class="p">;</span>

	<span class="o">//-</span> <span class="n">must</span> <span class="n">be</span> <span class="n">exist</span> <span class="n">even</span> <span class="n">without</span> <span class="n">function</span> <span class="nb">all</span>
    <span class="n">SDValue</span>
      <span class="n">LowerFormalArguments</span><span class="p">(</span><span class="n">SDValue</span> <span class="n">Chain</span><span class="p">,</span>
                           <span class="n">CallingConv</span><span class="p">::</span><span class="n">ID</span> <span class="n">CallConv</span><span class="p">,</span> <span class="nb">bool</span> <span class="n">IsVarArg</span><span class="p">,</span>
                           <span class="n">const</span> <span class="n">SmallVectorImpl</span><span class="o">&lt;</span><span class="n">ISD</span><span class="p">::</span><span class="n">InputArg</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="n">Ins</span><span class="p">,</span>
                           <span class="n">const</span> <span class="n">SDLoc</span> <span class="o">&amp;</span><span class="n">dl</span><span class="p">,</span> <span class="n">SelectionDAG</span> <span class="o">&amp;</span><span class="n">DAG</span><span class="p">,</span>
                           <span class="n">SmallVectorImpl</span><span class="o">&lt;</span><span class="n">SDValue</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="n">InVals</span><span class="p">)</span> <span class="n">const</span> <span class="n">override</span><span class="p">;</span>

    <span class="n">SDValue</span> <span class="n">LowerReturn</span><span class="p">(</span><span class="n">SDValue</span> <span class="n">Chain</span><span class="p">,</span>
                        <span class="n">CallingConv</span><span class="p">::</span><span class="n">ID</span> <span class="n">CallConv</span><span class="p">,</span> <span class="nb">bool</span> <span class="n">IsVarArg</span><span class="p">,</span>
                        <span class="n">const</span> <span class="n">SmallVectorImpl</span><span class="o">&lt;</span><span class="n">ISD</span><span class="p">::</span><span class="n">OutputArg</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="n">Outs</span><span class="p">,</span>
                        <span class="n">const</span> <span class="n">SmallVectorImpl</span><span class="o">&lt;</span><span class="n">SDValue</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="n">OutVals</span><span class="p">,</span>
                        <span class="n">const</span> <span class="n">SDLoc</span> <span class="o">&amp;</span><span class="n">dl</span><span class="p">,</span> <span class="n">SelectionDAG</span> <span class="o">&amp;</span><span class="n">DAG</span><span class="p">)</span> <span class="n">const</span> <span class="n">override</span><span class="p">;</span>

  <span class="p">};</span>
  <span class="n">const</span> <span class="n">Cpu0TargetLowering</span> <span class="o">*</span>
  <span class="n">createCpu0SETargetLowering</span><span class="p">(</span><span class="n">const</span> <span class="n">Cpu0TargetMachine</span> <span class="o">&amp;</span><span class="n">TM</span><span class="p">,</span> <span class="n">const</span> <span class="n">Cpu0Subtarget</span> <span class="o">&amp;</span><span class="n">STI</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">#endif // Cpu0ISELLOWERING_H</span>

</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter3_1/Cpu0ISelLowering.cpp</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">//===--</span> <span class="n">Cpu0ISelLowering</span><span class="o">.</span><span class="n">cpp</span> <span class="o">-</span> <span class="n">Cpu0</span> <span class="n">DAG</span> <span class="n">Lowering</span> <span class="n">Implementation</span> <span class="o">-----------===//</span>
<span class="o">//</span>
<span class="o">//</span>                     <span class="n">The</span> <span class="n">LLVM</span> <span class="n">Compiler</span> <span class="n">Infrastructure</span>
<span class="o">//</span>
<span class="o">//</span> <span class="n">This</span> <span class="n">file</span> <span class="ow">is</span> <span class="n">distributed</span> <span class="n">under</span> <span class="n">the</span> <span class="n">University</span> <span class="n">of</span> <span class="n">Illinois</span> <span class="n">Open</span> <span class="n">Source</span>
<span class="o">//</span> <span class="n">License</span><span class="o">.</span> <span class="n">See</span> <span class="n">LICENSE</span><span class="o">.</span><span class="n">TXT</span> <span class="k">for</span> <span class="n">details</span><span class="o">.</span>
<span class="o">//</span>
<span class="o">//===----------------------------------------------------------------------===//</span>
<span class="o">//</span>
<span class="o">//</span> <span class="n">This</span> <span class="n">file</span> <span class="n">defines</span> <span class="n">the</span> <span class="n">interfaces</span> <span class="n">that</span> <span class="n">Cpu0</span> <span class="n">uses</span> <span class="n">to</span> <span class="n">lower</span> <span class="n">LLVM</span> <span class="n">code</span> <span class="n">into</span> <span class="n">a</span>
<span class="o">//</span> <span class="n">selection</span> <span class="n">DAG</span><span class="o">.</span>
<span class="o">//</span>
<span class="o">//===----------------------------------------------------------------------===//</span>
<span class="c1">#include &quot;Cpu0ISelLowering.h&quot;</span>

<span class="c1">#include &quot;Cpu0MachineFunction.h&quot;</span>
<span class="c1">#include &quot;Cpu0TargetMachine.h&quot;</span>
<span class="c1">#include &quot;Cpu0TargetObjectFile.h&quot;</span>
<span class="c1">#include &quot;Cpu0Subtarget.h&quot;</span>
<span class="c1">#include &quot;llvm/ADT/Statistic.h&quot;</span>
<span class="c1">#include &quot;llvm/CodeGen/CallingConvLower.h&quot;</span>
<span class="c1">#include &quot;llvm/CodeGen/MachineFrameInfo.h&quot;</span>
<span class="c1">#include &quot;llvm/CodeGen/MachineFunction.h&quot;</span>
<span class="c1">#include &quot;llvm/CodeGen/MachineInstrBuilder.h&quot;</span>
<span class="c1">#include &quot;llvm/CodeGen/MachineRegisterInfo.h&quot;</span>
<span class="c1">#include &quot;llvm/CodeGen/SelectionDAG.h&quot;</span>
<span class="c1">#include &quot;llvm/CodeGen/ValueTypes.h&quot;</span>
<span class="c1">#include &quot;llvm/IR/CallingConv.h&quot;</span>
<span class="c1">#include &quot;llvm/IR/DerivedTypes.h&quot;</span>
<span class="c1">#include &quot;llvm/IR/GlobalVariable.h&quot;</span>
<span class="c1">#include &quot;llvm/Support/CommandLine.h&quot;</span>
<span class="c1">#include &quot;llvm/Support/Debug.h&quot;</span>
<span class="c1">#include &quot;llvm/Support/ErrorHandling.h&quot;</span>
<span class="c1">#include &quot;llvm/Support/raw_ostream.h&quot;</span>

<span class="n">using</span> <span class="n">namespace</span> <span class="n">llvm</span><span class="p">;</span>

<span class="c1">#define DEBUG_TYPE &quot;cpu0-lower&quot;</span>

<span class="o">//</span><span class="nd">@3_1</span> <span class="mi">1</span> <span class="p">{</span>
<span class="n">const</span> <span class="n">char</span> <span class="o">*</span><span class="n">Cpu0TargetLowering</span><span class="p">::</span><span class="n">getTargetNodeName</span><span class="p">(</span><span class="n">unsigned</span> <span class="n">Opcode</span><span class="p">)</span> <span class="n">const</span> <span class="p">{</span>
  <span class="n">switch</span> <span class="p">(</span><span class="n">Opcode</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">case</span> <span class="n">Cpu0ISD</span><span class="p">::</span><span class="n">JmpLink</span><span class="p">:</span>           <span class="k">return</span> <span class="s2">&quot;Cpu0ISD::JmpLink&quot;</span><span class="p">;</span>
  <span class="n">case</span> <span class="n">Cpu0ISD</span><span class="p">::</span><span class="n">TailCall</span><span class="p">:</span>          <span class="k">return</span> <span class="s2">&quot;Cpu0ISD::TailCall&quot;</span><span class="p">;</span>
  <span class="n">case</span> <span class="n">Cpu0ISD</span><span class="p">::</span><span class="n">Hi</span><span class="p">:</span>                <span class="k">return</span> <span class="s2">&quot;Cpu0ISD::Hi&quot;</span><span class="p">;</span>
  <span class="n">case</span> <span class="n">Cpu0ISD</span><span class="p">::</span><span class="n">Lo</span><span class="p">:</span>                <span class="k">return</span> <span class="s2">&quot;Cpu0ISD::Lo&quot;</span><span class="p">;</span>
  <span class="n">case</span> <span class="n">Cpu0ISD</span><span class="p">::</span><span class="n">GPRel</span><span class="p">:</span>             <span class="k">return</span> <span class="s2">&quot;Cpu0ISD::GPRel&quot;</span><span class="p">;</span>
  <span class="n">case</span> <span class="n">Cpu0ISD</span><span class="p">::</span><span class="n">Ret</span><span class="p">:</span>               <span class="k">return</span> <span class="s2">&quot;Cpu0ISD::Ret&quot;</span><span class="p">;</span>
  <span class="n">case</span> <span class="n">Cpu0ISD</span><span class="p">::</span><span class="n">EH_RETURN</span><span class="p">:</span>         <span class="k">return</span> <span class="s2">&quot;Cpu0ISD::EH_RETURN&quot;</span><span class="p">;</span>
  <span class="n">case</span> <span class="n">Cpu0ISD</span><span class="p">::</span><span class="n">DivRem</span><span class="p">:</span>            <span class="k">return</span> <span class="s2">&quot;Cpu0ISD::DivRem&quot;</span><span class="p">;</span>
  <span class="n">case</span> <span class="n">Cpu0ISD</span><span class="p">::</span><span class="n">DivRemU</span><span class="p">:</span>           <span class="k">return</span> <span class="s2">&quot;Cpu0ISD::DivRemU&quot;</span><span class="p">;</span>
  <span class="n">case</span> <span class="n">Cpu0ISD</span><span class="p">::</span><span class="n">Wrapper</span><span class="p">:</span>           <span class="k">return</span> <span class="s2">&quot;Cpu0ISD::Wrapper&quot;</span><span class="p">;</span>
  <span class="n">default</span><span class="p">:</span>                         <span class="k">return</span> <span class="n">NULL</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
<span class="o">//</span><span class="nd">@3_1</span> <span class="mi">1</span> <span class="p">}</span>

<span class="o">//</span><span class="nd">@Cpu0TargetLowering</span> <span class="p">{</span>
<span class="n">Cpu0TargetLowering</span><span class="p">::</span><span class="n">Cpu0TargetLowering</span><span class="p">(</span><span class="n">const</span> <span class="n">Cpu0TargetMachine</span> <span class="o">&amp;</span><span class="n">TM</span><span class="p">,</span>
                                       <span class="n">const</span> <span class="n">Cpu0Subtarget</span> <span class="o">&amp;</span><span class="n">STI</span><span class="p">)</span>
    <span class="p">:</span> <span class="n">TargetLowering</span><span class="p">(</span><span class="n">TM</span><span class="p">),</span> <span class="n">Subtarget</span><span class="p">(</span><span class="n">STI</span><span class="p">),</span> <span class="n">ABI</span><span class="p">(</span><span class="n">TM</span><span class="o">.</span><span class="n">getABI</span><span class="p">())</span> <span class="p">{</span>

<span class="p">}</span>

<span class="n">const</span> <span class="n">Cpu0TargetLowering</span> <span class="o">*</span><span class="n">Cpu0TargetLowering</span><span class="p">::</span><span class="n">create</span><span class="p">(</span><span class="n">const</span> <span class="n">Cpu0TargetMachine</span> <span class="o">&amp;</span><span class="n">TM</span><span class="p">,</span>
                                                     <span class="n">const</span> <span class="n">Cpu0Subtarget</span> <span class="o">&amp;</span><span class="n">STI</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="n">llvm</span><span class="p">::</span><span class="n">createCpu0SETargetLowering</span><span class="p">(</span><span class="n">TM</span><span class="p">,</span> <span class="n">STI</span><span class="p">);</span>
<span class="p">}</span>

<span class="o">//===----------------------------------------------------------------------===//</span>
<span class="o">//</span>  <span class="n">Lower</span> <span class="n">helper</span> <span class="n">functions</span>
<span class="o">//===----------------------------------------------------------------------===//</span>

<span class="o">//===----------------------------------------------------------------------===//</span>
<span class="o">//</span>  <span class="n">Misc</span> <span class="n">Lower</span> <span class="n">Operation</span> <span class="n">implementation</span>
<span class="o">//===----------------------------------------------------------------------===//</span>

<span class="c1">#include &quot;Cpu0GenCallingConv.inc&quot;</span>

<span class="o">//===----------------------------------------------------------------------===//</span>
<span class="o">//@</span>            <span class="n">Formal</span> <span class="n">Arguments</span> <span class="n">Calling</span> <span class="n">Convention</span> <span class="n">Implementation</span>
<span class="o">//===----------------------------------------------------------------------===//</span>

<span class="o">//</span><span class="nd">@LowerFormalArguments</span> <span class="p">{</span>
<span class="o">///</span> <span class="n">LowerFormalArguments</span> <span class="o">-</span> <span class="n">transform</span> <span class="n">physical</span> <span class="n">registers</span> <span class="n">into</span> <span class="n">virtual</span> <span class="n">registers</span>
<span class="o">///</span> <span class="ow">and</span> <span class="n">generate</span> <span class="n">load</span> <span class="n">operations</span> <span class="k">for</span> <span class="n">arguments</span> <span class="n">places</span> <span class="n">on</span> <span class="n">the</span> <span class="n">stack</span><span class="o">.</span>
<span class="n">SDValue</span>
<span class="n">Cpu0TargetLowering</span><span class="p">::</span><span class="n">LowerFormalArguments</span><span class="p">(</span><span class="n">SDValue</span> <span class="n">Chain</span><span class="p">,</span>
                                         <span class="n">CallingConv</span><span class="p">::</span><span class="n">ID</span> <span class="n">CallConv</span><span class="p">,</span>
                                         <span class="nb">bool</span> <span class="n">IsVarArg</span><span class="p">,</span>
                                         <span class="n">const</span> <span class="n">SmallVectorImpl</span><span class="o">&lt;</span><span class="n">ISD</span><span class="p">::</span><span class="n">InputArg</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="n">Ins</span><span class="p">,</span>
                                         <span class="n">const</span> <span class="n">SDLoc</span> <span class="o">&amp;</span><span class="n">DL</span><span class="p">,</span> <span class="n">SelectionDAG</span> <span class="o">&amp;</span><span class="n">DAG</span><span class="p">,</span>
                                         <span class="n">SmallVectorImpl</span><span class="o">&lt;</span><span class="n">SDValue</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="n">InVals</span><span class="p">)</span>
                                          <span class="n">const</span> <span class="p">{</span>

  <span class="k">return</span> <span class="n">Chain</span><span class="p">;</span>
<span class="p">}</span>
<span class="o">//</span> <span class="nd">@LowerFormalArguments</span> <span class="p">}</span>

<span class="o">//===----------------------------------------------------------------------===//</span>
<span class="o">//@</span>              <span class="n">Return</span> <span class="n">Value</span> <span class="n">Calling</span> <span class="n">Convention</span> <span class="n">Implementation</span>
<span class="o">//===----------------------------------------------------------------------===//</span>

<span class="n">SDValue</span>
<span class="n">Cpu0TargetLowering</span><span class="p">::</span><span class="n">LowerReturn</span><span class="p">(</span><span class="n">SDValue</span> <span class="n">Chain</span><span class="p">,</span>
                                <span class="n">CallingConv</span><span class="p">::</span><span class="n">ID</span> <span class="n">CallConv</span><span class="p">,</span> <span class="nb">bool</span> <span class="n">IsVarArg</span><span class="p">,</span>
                                <span class="n">const</span> <span class="n">SmallVectorImpl</span><span class="o">&lt;</span><span class="n">ISD</span><span class="p">::</span><span class="n">OutputArg</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="n">Outs</span><span class="p">,</span>
                                <span class="n">const</span> <span class="n">SmallVectorImpl</span><span class="o">&lt;</span><span class="n">SDValue</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="n">OutVals</span><span class="p">,</span>
                                <span class="n">const</span> <span class="n">SDLoc</span> <span class="o">&amp;</span><span class="n">DL</span><span class="p">,</span> <span class="n">SelectionDAG</span> <span class="o">&amp;</span><span class="n">DAG</span><span class="p">)</span> <span class="n">const</span> <span class="p">{</span>
  <span class="k">return</span> <span class="n">DAG</span><span class="o">.</span><span class="n">getNode</span><span class="p">(</span><span class="n">Cpu0ISD</span><span class="p">::</span><span class="n">Ret</span><span class="p">,</span> <span class="n">DL</span><span class="p">,</span> <span class="n">MVT</span><span class="p">::</span><span class="n">Other</span><span class="p">,</span>
                     <span class="n">Chain</span><span class="p">,</span> <span class="n">DAG</span><span class="o">.</span><span class="n">getRegister</span><span class="p">(</span><span class="n">Cpu0</span><span class="p">::</span><span class="n">LR</span><span class="p">,</span> <span class="n">MVT</span><span class="p">::</span><span class="n">i32</span><span class="p">));</span>
<span class="p">}</span>

</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter3_1/Cpu0SEISelLowering.h</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">//===--</span> <span class="n">Cpu0ISEISelLowering</span><span class="o">.</span><span class="n">h</span> <span class="o">-</span> <span class="n">Cpu0ISE</span> <span class="n">DAG</span> <span class="n">Lowering</span> <span class="n">Interface</span> <span class="o">----*-</span> <span class="n">C</span><span class="o">++</span> <span class="o">-*-===//</span>
<span class="o">//</span>
<span class="o">//</span>                     <span class="n">The</span> <span class="n">LLVM</span> <span class="n">Compiler</span> <span class="n">Infrastructure</span>
<span class="o">//</span>
<span class="o">//</span> <span class="n">This</span> <span class="n">file</span> <span class="ow">is</span> <span class="n">distributed</span> <span class="n">under</span> <span class="n">the</span> <span class="n">University</span> <span class="n">of</span> <span class="n">Illinois</span> <span class="n">Open</span> <span class="n">Source</span>
<span class="o">//</span> <span class="n">License</span><span class="o">.</span> <span class="n">See</span> <span class="n">LICENSE</span><span class="o">.</span><span class="n">TXT</span> <span class="k">for</span> <span class="n">details</span><span class="o">.</span>
<span class="o">//</span>
<span class="o">//===----------------------------------------------------------------------===//</span>
<span class="o">//</span>
<span class="o">//</span> <span class="n">Subclass</span> <span class="n">of</span> <span class="n">Cpu0ITargetLowering</span> <span class="n">specialized</span> <span class="k">for</span> <span class="n">cpu032</span><span class="o">/</span><span class="mf">64.</span>
<span class="o">//</span>
<span class="o">//===----------------------------------------------------------------------===//</span>

<span class="c1">#ifndef LLVM_LIB_TARGET_CPU0_CPU0SEISELLOWERING_H</span>
<span class="c1">#define LLVM_LIB_TARGET_CPU0_CPU0SEISELLOWERING_H</span>

<span class="c1">#include &quot;Cpu0Config.h&quot;</span>

<span class="c1">#include &quot;Cpu0ISelLowering.h&quot;</span>
<span class="c1">#include &quot;Cpu0RegisterInfo.h&quot;</span>

<span class="n">namespace</span> <span class="n">llvm</span> <span class="p">{</span>
  <span class="k">class</span> <span class="nc">Cpu0SETargetLowering</span> <span class="p">:</span> <span class="n">public</span> <span class="n">Cpu0TargetLowering</span>  <span class="p">{</span>
  <span class="n">public</span><span class="p">:</span>
    <span class="n">explicit</span> <span class="n">Cpu0SETargetLowering</span><span class="p">(</span><span class="n">const</span> <span class="n">Cpu0TargetMachine</span> <span class="o">&amp;</span><span class="n">TM</span><span class="p">,</span>
                                  <span class="n">const</span> <span class="n">Cpu0Subtarget</span> <span class="o">&amp;</span><span class="n">STI</span><span class="p">);</span>

    <span class="n">SDValue</span> <span class="n">LowerOperation</span><span class="p">(</span><span class="n">SDValue</span> <span class="n">Op</span><span class="p">,</span> <span class="n">SelectionDAG</span> <span class="o">&amp;</span><span class="n">DAG</span><span class="p">)</span> <span class="n">const</span> <span class="n">override</span><span class="p">;</span>
  <span class="n">private</span><span class="p">:</span>
  <span class="p">};</span>
<span class="p">}</span>

<span class="c1">#endif // Cpu0ISEISELLOWERING_H</span>

</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter3_1/Cpu0SEISelLowering.cpp</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">//===--</span> <span class="n">Cpu0SEISelLowering</span><span class="o">.</span><span class="n">cpp</span> <span class="o">-</span> <span class="n">Cpu0SE</span> <span class="n">DAG</span> <span class="n">Lowering</span> <span class="n">Interface</span> <span class="o">--*-</span> <span class="n">C</span><span class="o">++</span> <span class="o">-*-===//</span>
<span class="o">//</span>
<span class="o">//</span>                     <span class="n">The</span> <span class="n">LLVM</span> <span class="n">Compiler</span> <span class="n">Infrastructure</span>
<span class="o">//</span>
<span class="o">//</span> <span class="n">This</span> <span class="n">file</span> <span class="ow">is</span> <span class="n">distributed</span> <span class="n">under</span> <span class="n">the</span> <span class="n">University</span> <span class="n">of</span> <span class="n">Illinois</span> <span class="n">Open</span> <span class="n">Source</span>
<span class="o">//</span> <span class="n">License</span><span class="o">.</span> <span class="n">See</span> <span class="n">LICENSE</span><span class="o">.</span><span class="n">TXT</span> <span class="k">for</span> <span class="n">details</span><span class="o">.</span>
<span class="o">//</span>
<span class="o">//===----------------------------------------------------------------------===//</span>
<span class="o">//</span>
<span class="o">//</span> <span class="n">Subclass</span> <span class="n">of</span> <span class="n">Cpu0TargetLowering</span> <span class="n">specialized</span> <span class="k">for</span> <span class="n">cpu032</span><span class="o">.</span>
<span class="o">//</span>
<span class="o">//===----------------------------------------------------------------------===//</span>
<span class="c1">#include &quot;Cpu0MachineFunction.h&quot;</span>
<span class="c1">#include &quot;Cpu0SEISelLowering.h&quot;</span>

<span class="c1">#include &quot;Cpu0RegisterInfo.h&quot;</span>
<span class="c1">#include &quot;Cpu0TargetMachine.h&quot;</span>
<span class="c1">#include &quot;llvm/CodeGen/MachineInstrBuilder.h&quot;</span>
<span class="c1">#include &quot;llvm/CodeGen/MachineRegisterInfo.h&quot;</span>
<span class="c1">#include &quot;llvm/IR/Intrinsics.h&quot;</span>
<span class="c1">#include &quot;llvm/Support/CommandLine.h&quot;</span>
<span class="c1">#include &quot;llvm/Support/Debug.h&quot;</span>
<span class="c1">#include &quot;llvm/Support/raw_ostream.h&quot;</span>
<span class="c1">#include &quot;llvm/Target/TargetInstrInfo.h&quot;</span>

<span class="n">using</span> <span class="n">namespace</span> <span class="n">llvm</span><span class="p">;</span>

<span class="c1">#define DEBUG_TYPE &quot;cpu0-isel&quot;</span>

<span class="n">static</span> <span class="n">cl</span><span class="p">::</span><span class="n">opt</span><span class="o">&lt;</span><span class="nb">bool</span><span class="o">&gt;</span>
<span class="n">EnableCpu0TailCalls</span><span class="p">(</span><span class="s2">&quot;enable-cpu0-tail-calls&quot;</span><span class="p">,</span> <span class="n">cl</span><span class="p">::</span><span class="n">Hidden</span><span class="p">,</span>
                    <span class="n">cl</span><span class="p">::</span><span class="n">desc</span><span class="p">(</span><span class="s2">&quot;CPU0: Enable tail calls.&quot;</span><span class="p">),</span> <span class="n">cl</span><span class="p">::</span><span class="n">init</span><span class="p">(</span><span class="n">false</span><span class="p">));</span>

<span class="o">//</span><span class="nd">@Cpu0SETargetLowering</span> <span class="p">{</span>
<span class="n">Cpu0SETargetLowering</span><span class="p">::</span><span class="n">Cpu0SETargetLowering</span><span class="p">(</span><span class="n">const</span> <span class="n">Cpu0TargetMachine</span> <span class="o">&amp;</span><span class="n">TM</span><span class="p">,</span>
                                           <span class="n">const</span> <span class="n">Cpu0Subtarget</span> <span class="o">&amp;</span><span class="n">STI</span><span class="p">)</span>
    <span class="p">:</span> <span class="n">Cpu0TargetLowering</span><span class="p">(</span><span class="n">TM</span><span class="p">,</span> <span class="n">STI</span><span class="p">)</span> <span class="p">{</span>
<span class="o">//</span><span class="nd">@Cpu0SETargetLowering</span> <span class="n">body</span> <span class="p">{</span>
  <span class="o">//</span> <span class="n">Set</span> <span class="n">up</span> <span class="n">the</span> <span class="n">register</span> <span class="n">classes</span>
  <span class="n">addRegisterClass</span><span class="p">(</span><span class="n">MVT</span><span class="p">::</span><span class="n">i32</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">Cpu0</span><span class="p">::</span><span class="n">CPURegsRegClass</span><span class="p">);</span>

<span class="o">//</span> <span class="n">must</span><span class="p">,</span> <span class="n">computeRegisterProperties</span> <span class="o">-</span> <span class="n">Once</span> <span class="nb">all</span> <span class="n">of</span> <span class="n">the</span> <span class="n">register</span> <span class="n">classes</span> <span class="n">are</span> 
<span class="o">//</span>  <span class="n">added</span><span class="p">,</span> <span class="n">this</span> <span class="n">allows</span> <span class="n">us</span> <span class="n">to</span> <span class="n">compute</span> <span class="n">derived</span> <span class="n">properties</span> <span class="n">we</span> <span class="n">expose</span><span class="o">.</span>
  <span class="n">computeRegisterProperties</span><span class="p">(</span><span class="n">Subtarget</span><span class="o">.</span><span class="n">getRegisterInfo</span><span class="p">());</span>
<span class="p">}</span>

<span class="n">SDValue</span> <span class="n">Cpu0SETargetLowering</span><span class="p">::</span><span class="n">LowerOperation</span><span class="p">(</span><span class="n">SDValue</span> <span class="n">Op</span><span class="p">,</span>
                                             <span class="n">SelectionDAG</span> <span class="o">&amp;</span><span class="n">DAG</span><span class="p">)</span> <span class="n">const</span> <span class="p">{</span>

  <span class="k">return</span> <span class="n">Cpu0TargetLowering</span><span class="p">::</span><span class="n">LowerOperation</span><span class="p">(</span><span class="n">Op</span><span class="p">,</span> <span class="n">DAG</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">const</span> <span class="n">Cpu0TargetLowering</span> <span class="o">*</span>
<span class="n">llvm</span><span class="p">::</span><span class="n">createCpu0SETargetLowering</span><span class="p">(</span><span class="n">const</span> <span class="n">Cpu0TargetMachine</span> <span class="o">&amp;</span><span class="n">TM</span><span class="p">,</span>
                                 <span class="n">const</span> <span class="n">Cpu0Subtarget</span> <span class="o">&amp;</span><span class="n">STI</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="n">new</span> <span class="n">Cpu0SETargetLowering</span><span class="p">(</span><span class="n">TM</span><span class="p">,</span> <span class="n">STI</span><span class="p">);</span>
<span class="p">}</span>

</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter3_1/Cpu0MachineFunction.h</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">//===--</span> <span class="n">Cpu0MachineFunctionInfo</span><span class="o">.</span><span class="n">h</span> <span class="o">-</span> <span class="n">Private</span> <span class="n">data</span> <span class="n">used</span> <span class="k">for</span> <span class="n">Cpu0</span> <span class="o">----*-</span> <span class="n">C</span><span class="o">++</span> <span class="o">-*-=//</span>
<span class="o">//</span>
<span class="o">//</span>                     <span class="n">The</span> <span class="n">LLVM</span> <span class="n">Compiler</span> <span class="n">Infrastructure</span>
<span class="o">//</span>
<span class="o">//</span> <span class="n">This</span> <span class="n">file</span> <span class="ow">is</span> <span class="n">distributed</span> <span class="n">under</span> <span class="n">the</span> <span class="n">University</span> <span class="n">of</span> <span class="n">Illinois</span> <span class="n">Open</span> <span class="n">Source</span>
<span class="o">//</span> <span class="n">License</span><span class="o">.</span> <span class="n">See</span> <span class="n">LICENSE</span><span class="o">.</span><span class="n">TXT</span> <span class="k">for</span> <span class="n">details</span><span class="o">.</span>
<span class="o">//</span>
<span class="o">//===----------------------------------------------------------------------===//</span>
<span class="o">//</span>
<span class="o">//</span> <span class="n">This</span> <span class="n">file</span> <span class="n">declares</span> <span class="n">the</span> <span class="n">Cpu0</span> <span class="n">specific</span> <span class="n">subclass</span> <span class="n">of</span> <span class="n">MachineFunctionInfo</span><span class="o">.</span>
<span class="o">//</span>
<span class="o">//===----------------------------------------------------------------------===//</span>

<span class="c1">#ifndef LLVM_LIB_TARGET_CPU0_CPU0MACHINEFUNCTION_H</span>
<span class="c1">#define LLVM_LIB_TARGET_CPU0_CPU0MACHINEFUNCTION_H</span>

<span class="c1">#include &quot;Cpu0Config.h&quot;</span>

<span class="c1">#include &quot;llvm/CodeGen/MachineFrameInfo.h&quot;</span>
<span class="c1">#include &quot;llvm/CodeGen/MachineFunction.h&quot;</span>
<span class="c1">#include &quot;llvm/CodeGen/MachineMemOperand.h&quot;</span>
<span class="c1">#include &quot;llvm/CodeGen/PseudoSourceValue.h&quot;</span>
<span class="c1">#include &quot;llvm/Target/TargetFrameLowering.h&quot;</span>
<span class="c1">#include &quot;llvm/Target/TargetMachine.h&quot;</span>
<span class="c1">#include &lt;map&gt;</span>

<span class="n">namespace</span> <span class="n">llvm</span> <span class="p">{</span>

<span class="o">//</span><span class="nd">@1</span> <span class="p">{</span>
<span class="o">///</span> <span class="n">Cpu0FunctionInfo</span> <span class="o">-</span> <span class="n">This</span> <span class="k">class</span> <span class="nc">is</span> <span class="n">derived</span> <span class="kn">from</span> <span class="nn">MachineFunction</span> <span class="n">private</span>
<span class="o">///</span> <span class="n">Cpu0</span> <span class="n">target</span><span class="o">-</span><span class="n">specific</span> <span class="n">information</span> <span class="k">for</span> <span class="n">each</span> <span class="n">MachineFunction</span><span class="o">.</span>
<span class="k">class</span> <span class="nc">Cpu0FunctionInfo</span> <span class="p">:</span> <span class="n">public</span> <span class="n">MachineFunctionInfo</span> <span class="p">{</span>
<span class="n">public</span><span class="p">:</span>
  <span class="n">Cpu0FunctionInfo</span><span class="p">(</span><span class="n">MachineFunction</span><span class="o">&amp;</span> <span class="n">MF</span><span class="p">)</span>
  <span class="p">:</span> <span class="n">MF</span><span class="p">(</span><span class="n">MF</span><span class="p">),</span> 
    <span class="n">VarArgsFrameIndex</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> 
    <span class="n">MaxCallFrameSize</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="p">{}</span>

  <span class="o">~</span><span class="n">Cpu0FunctionInfo</span><span class="p">();</span>

  <span class="nb">int</span> <span class="n">getVarArgsFrameIndex</span><span class="p">()</span> <span class="n">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">VarArgsFrameIndex</span><span class="p">;</span> <span class="p">}</span>
  <span class="n">void</span> <span class="n">setVarArgsFrameIndex</span><span class="p">(</span><span class="nb">int</span> <span class="n">Index</span><span class="p">)</span> <span class="p">{</span> <span class="n">VarArgsFrameIndex</span> <span class="o">=</span> <span class="n">Index</span><span class="p">;</span> <span class="p">}</span>

<span class="n">private</span><span class="p">:</span>
  <span class="n">virtual</span> <span class="n">void</span> <span class="n">anchor</span><span class="p">();</span>

  <span class="n">MachineFunction</span><span class="o">&amp;</span> <span class="n">MF</span><span class="p">;</span>

    <span class="o">///</span> <span class="n">VarArgsFrameIndex</span> <span class="o">-</span> <span class="n">FrameIndex</span> <span class="k">for</span> <span class="n">start</span> <span class="n">of</span> <span class="n">varargs</span> <span class="n">area</span><span class="o">.</span>
  <span class="nb">int</span> <span class="n">VarArgsFrameIndex</span><span class="p">;</span>

  <span class="n">unsigned</span> <span class="n">MaxCallFrameSize</span><span class="p">;</span>
<span class="p">};</span>
<span class="o">//</span><span class="nd">@1</span> <span class="p">}</span>

<span class="p">}</span> <span class="o">//</span> <span class="n">end</span> <span class="n">of</span> <span class="n">namespace</span> <span class="n">llvm</span>

<span class="c1">#endif // CPU0_MACHINE_FUNCTION_INFO_H</span>

</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter3_1/Cpu0MachineFunction.cpp</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">//===--</span> <span class="n">Cpu0MachineFunctionInfo</span><span class="o">.</span><span class="n">cpp</span> <span class="o">-</span> <span class="n">Private</span> <span class="n">data</span> <span class="n">used</span> <span class="k">for</span> <span class="n">Cpu0</span> <span class="o">----------===//</span>
<span class="o">//</span>
<span class="o">//</span>                     <span class="n">The</span> <span class="n">LLVM</span> <span class="n">Compiler</span> <span class="n">Infrastructure</span>
<span class="o">//</span>
<span class="o">//</span> <span class="n">This</span> <span class="n">file</span> <span class="ow">is</span> <span class="n">distributed</span> <span class="n">under</span> <span class="n">the</span> <span class="n">University</span> <span class="n">of</span> <span class="n">Illinois</span> <span class="n">Open</span> <span class="n">Source</span>
<span class="o">//</span> <span class="n">License</span><span class="o">.</span> <span class="n">See</span> <span class="n">LICENSE</span><span class="o">.</span><span class="n">TXT</span> <span class="k">for</span> <span class="n">details</span><span class="o">.</span>
<span class="o">//</span>
<span class="o">//===----------------------------------------------------------------------===//</span>

<span class="c1">#include &quot;Cpu0MachineFunction.h&quot;</span>

<span class="c1">#include &quot;Cpu0InstrInfo.h&quot;</span>
<span class="c1">#include &quot;Cpu0Subtarget.h&quot;</span>
<span class="c1">#include &quot;llvm/IR/Function.h&quot;</span>
<span class="c1">#include &quot;llvm/CodeGen/MachineInstrBuilder.h&quot;</span>
<span class="c1">#include &quot;llvm/CodeGen/MachineRegisterInfo.h&quot;</span>

<span class="n">using</span> <span class="n">namespace</span> <span class="n">llvm</span><span class="p">;</span>

<span class="nb">bool</span> <span class="n">FixGlobalBaseReg</span><span class="p">;</span>

<span class="n">Cpu0FunctionInfo</span><span class="p">::</span><span class="o">~</span><span class="n">Cpu0FunctionInfo</span><span class="p">()</span> <span class="p">{}</span>

<span class="n">void</span> <span class="n">Cpu0FunctionInfo</span><span class="p">::</span><span class="n">anchor</span><span class="p">()</span> <span class="p">{</span> <span class="p">}</span>

</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter3_1/MCTargetDesc/Cpu0ABIInfo.h</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">//===----</span> <span class="n">Cpu0ABIInfo</span><span class="o">.</span><span class="n">h</span> <span class="o">-</span> <span class="n">Information</span> <span class="n">about</span> <span class="n">CPU0</span> <span class="n">ABI</span><span class="s1">&#39;s --------------------===//</span>
<span class="o">//</span>
<span class="o">//</span>                     <span class="n">The</span> <span class="n">LLVM</span> <span class="n">Compiler</span> <span class="n">Infrastructure</span>
<span class="o">//</span>
<span class="o">//</span> <span class="n">This</span> <span class="n">file</span> <span class="ow">is</span> <span class="n">distributed</span> <span class="n">under</span> <span class="n">the</span> <span class="n">University</span> <span class="n">of</span> <span class="n">Illinois</span> <span class="n">Open</span> <span class="n">Source</span>
<span class="o">//</span> <span class="n">License</span><span class="o">.</span> <span class="n">See</span> <span class="n">LICENSE</span><span class="o">.</span><span class="n">TXT</span> <span class="k">for</span> <span class="n">details</span><span class="o">.</span>
<span class="o">//</span>
<span class="o">//===----------------------------------------------------------------------===//</span>

<span class="c1">#ifndef LLVM_LIB_TARGET_CPU0_MCTARGETDESC_CPU0ABIINFO_H</span>
<span class="c1">#define LLVM_LIB_TARGET_CPU0_MCTARGETDESC_CPU0ABIINFO_H</span>

<span class="c1">#include &quot;Cpu0Config.h&quot;</span>

<span class="c1">#include &quot;llvm/ADT/ArrayRef.h&quot;</span>
<span class="c1">#include &quot;llvm/ADT/Triple.h&quot;</span>
<span class="c1">#include &quot;llvm/IR/CallingConv.h&quot;</span>
<span class="c1">#include &quot;llvm/MC/MCRegisterInfo.h&quot;</span>

<span class="n">namespace</span> <span class="n">llvm</span> <span class="p">{</span>

<span class="k">class</span> <span class="nc">MCTargetOptions</span><span class="p">;</span>
<span class="k">class</span> <span class="nc">StringRef</span><span class="p">;</span>
<span class="k">class</span> <span class="nc">TargetRegisterClass</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">Cpu0ABIInfo</span> <span class="p">{</span>
<span class="n">public</span><span class="p">:</span>
  <span class="n">enum</span> <span class="k">class</span> <span class="nc">ABI</span> <span class="p">{</span> <span class="n">Unknown</span><span class="p">,</span> <span class="n">O32</span><span class="p">,</span> <span class="n">S32</span> <span class="p">};</span>

<span class="n">protected</span><span class="p">:</span>
  <span class="n">ABI</span> <span class="n">ThisABI</span><span class="p">;</span>

<span class="n">public</span><span class="p">:</span>
  <span class="n">Cpu0ABIInfo</span><span class="p">(</span><span class="n">ABI</span> <span class="n">ThisABI</span><span class="p">)</span> <span class="p">:</span> <span class="n">ThisABI</span><span class="p">(</span><span class="n">ThisABI</span><span class="p">)</span> <span class="p">{}</span>

  <span class="n">static</span> <span class="n">Cpu0ABIInfo</span> <span class="n">Unknown</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="n">Cpu0ABIInfo</span><span class="p">(</span><span class="n">ABI</span><span class="p">::</span><span class="n">Unknown</span><span class="p">);</span> <span class="p">}</span>
  <span class="n">static</span> <span class="n">Cpu0ABIInfo</span> <span class="n">O32</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="n">Cpu0ABIInfo</span><span class="p">(</span><span class="n">ABI</span><span class="p">::</span><span class="n">O32</span><span class="p">);</span> <span class="p">}</span>
  <span class="n">static</span> <span class="n">Cpu0ABIInfo</span> <span class="n">S32</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="n">Cpu0ABIInfo</span><span class="p">(</span><span class="n">ABI</span><span class="p">::</span><span class="n">S32</span><span class="p">);</span> <span class="p">}</span>
  <span class="n">static</span> <span class="n">Cpu0ABIInfo</span> <span class="n">computeTargetABI</span><span class="p">();</span>

  <span class="nb">bool</span> <span class="n">IsKnown</span><span class="p">()</span> <span class="n">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">ThisABI</span> <span class="o">!=</span> <span class="n">ABI</span><span class="p">::</span><span class="n">Unknown</span><span class="p">;</span> <span class="p">}</span>
  <span class="nb">bool</span> <span class="n">IsO32</span><span class="p">()</span> <span class="n">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">ThisABI</span> <span class="o">==</span> <span class="n">ABI</span><span class="p">::</span><span class="n">O32</span><span class="p">;</span> <span class="p">}</span>
  <span class="nb">bool</span> <span class="n">IsS32</span><span class="p">()</span> <span class="n">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">ThisABI</span> <span class="o">==</span> <span class="n">ABI</span><span class="p">::</span><span class="n">S32</span><span class="p">;</span> <span class="p">}</span>
  <span class="n">ABI</span> <span class="n">GetEnumValue</span><span class="p">()</span> <span class="n">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">ThisABI</span><span class="p">;</span> <span class="p">}</span>

  <span class="o">///</span> <span class="n">The</span> <span class="n">registers</span> <span class="n">to</span> <span class="n">use</span> <span class="k">for</span> <span class="n">byval</span> <span class="n">arguments</span><span class="o">.</span>
  <span class="n">const</span> <span class="n">ArrayRef</span><span class="o">&lt;</span><span class="n">MCPhysReg</span><span class="o">&gt;</span> <span class="n">GetByValArgRegs</span><span class="p">()</span> <span class="n">const</span><span class="p">;</span>

  <span class="o">///</span> <span class="n">The</span> <span class="n">registers</span> <span class="n">to</span> <span class="n">use</span> <span class="k">for</span> <span class="n">the</span> <span class="n">variable</span> <span class="n">argument</span> <span class="nb">list</span><span class="o">.</span>
  <span class="n">const</span> <span class="n">ArrayRef</span><span class="o">&lt;</span><span class="n">MCPhysReg</span><span class="o">&gt;</span> <span class="n">GetVarArgRegs</span><span class="p">()</span> <span class="n">const</span><span class="p">;</span>

  <span class="o">///</span> <span class="n">Obtain</span> <span class="n">the</span> <span class="n">size</span> <span class="n">of</span> <span class="n">the</span> <span class="n">area</span> <span class="n">allocated</span> <span class="n">by</span> <span class="n">the</span> <span class="n">callee</span> <span class="k">for</span> <span class="n">arguments</span><span class="o">.</span>
  <span class="o">///</span> <span class="n">CallingConv</span><span class="p">::</span><span class="n">FastCall</span> <span class="n">affects</span> <span class="n">the</span> <span class="n">value</span> <span class="k">for</span> <span class="n">O32</span><span class="o">.</span>
  <span class="n">unsigned</span> <span class="n">GetCalleeAllocdArgSizeInBytes</span><span class="p">(</span><span class="n">CallingConv</span><span class="p">::</span><span class="n">ID</span> <span class="n">CC</span><span class="p">)</span> <span class="n">const</span><span class="p">;</span>

  <span class="o">///</span> <span class="n">Ordering</span> <span class="n">of</span> <span class="n">ABI</span><span class="s1">&#39;s</span>
  <span class="o">///</span> <span class="n">Cpu0GenSubtargetInfo</span><span class="o">.</span><span class="n">inc</span> <span class="n">will</span> <span class="n">use</span> <span class="n">this</span> <span class="n">to</span> <span class="n">resolve</span> <span class="n">conflicts</span> <span class="n">when</span> <span class="n">given</span>
  <span class="o">///</span> <span class="n">multiple</span> <span class="n">ABI</span> <span class="n">options</span><span class="o">.</span>
  <span class="nb">bool</span> <span class="n">operator</span><span class="o">&lt;</span><span class="p">(</span><span class="n">const</span> <span class="n">Cpu0ABIInfo</span> <span class="n">Other</span><span class="p">)</span> <span class="n">const</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">ThisABI</span> <span class="o">&lt;</span> <span class="n">Other</span><span class="o">.</span><span class="n">GetEnumValue</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="n">unsigned</span> <span class="n">GetStackPtr</span><span class="p">()</span> <span class="n">const</span><span class="p">;</span>
  <span class="n">unsigned</span> <span class="n">GetFramePtr</span><span class="p">()</span> <span class="n">const</span><span class="p">;</span>
  <span class="n">unsigned</span> <span class="n">GetNullPtr</span><span class="p">()</span> <span class="n">const</span><span class="p">;</span>

  <span class="n">unsigned</span> <span class="n">GetEhDataReg</span><span class="p">(</span><span class="n">unsigned</span> <span class="n">I</span><span class="p">)</span> <span class="n">const</span><span class="p">;</span>
  <span class="nb">int</span> <span class="n">EhDataRegSize</span><span class="p">()</span> <span class="n">const</span><span class="p">;</span>
<span class="p">};</span>
<span class="p">}</span>

<span class="c1">#endif</span>

</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter3_1/MCTargetDesc/Cpu0ABIInfo.cpp</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">//===----</span> <span class="n">Cpu0ABIInfo</span><span class="o">.</span><span class="n">cpp</span> <span class="o">-</span> <span class="n">Information</span> <span class="n">about</span> <span class="n">CPU0</span> <span class="n">ABI</span><span class="s1">&#39;s ------------------===//</span>
<span class="o">//</span>
<span class="o">//</span>                     <span class="n">The</span> <span class="n">LLVM</span> <span class="n">Compiler</span> <span class="n">Infrastructure</span>
<span class="o">//</span>
<span class="o">//</span> <span class="n">This</span> <span class="n">file</span> <span class="ow">is</span> <span class="n">distributed</span> <span class="n">under</span> <span class="n">the</span> <span class="n">University</span> <span class="n">of</span> <span class="n">Illinois</span> <span class="n">Open</span> <span class="n">Source</span>
<span class="o">//</span> <span class="n">License</span><span class="o">.</span> <span class="n">See</span> <span class="n">LICENSE</span><span class="o">.</span><span class="n">TXT</span> <span class="k">for</span> <span class="n">details</span><span class="o">.</span>
<span class="o">//</span>
<span class="o">//===----------------------------------------------------------------------===//</span>

<span class="c1">#include &quot;Cpu0Config.h&quot;</span>

<span class="c1">#include &quot;Cpu0ABIInfo.h&quot;</span>
<span class="c1">#include &quot;Cpu0RegisterInfo.h&quot;</span>
<span class="c1">#include &quot;llvm/ADT/StringRef.h&quot;</span>
<span class="c1">#include &quot;llvm/ADT/StringSwitch.h&quot;</span>
<span class="c1">#include &quot;llvm/MC/MCTargetOptions.h&quot;</span>
<span class="c1">#include &quot;llvm/Support/CommandLine.h&quot;</span>

<span class="n">using</span> <span class="n">namespace</span> <span class="n">llvm</span><span class="p">;</span>

<span class="n">static</span> <span class="n">cl</span><span class="p">::</span><span class="n">opt</span><span class="o">&lt;</span><span class="nb">bool</span><span class="o">&gt;</span>
<span class="n">EnableCpu0S32Calls</span><span class="p">(</span><span class="s2">&quot;cpu0-s32-calls&quot;</span><span class="p">,</span> <span class="n">cl</span><span class="p">::</span><span class="n">Hidden</span><span class="p">,</span>
                    <span class="n">cl</span><span class="p">::</span><span class="n">desc</span><span class="p">(</span><span class="s2">&quot;CPU0 S32 call: use stack only to pass arguments.</span><span class="se">\</span>
<span class="s2">                    &quot;</span><span class="p">),</span> <span class="n">cl</span><span class="p">::</span><span class="n">init</span><span class="p">(</span><span class="n">false</span><span class="p">));</span>

<span class="n">namespace</span> <span class="p">{</span>
<span class="n">static</span> <span class="n">const</span> <span class="n">MCPhysReg</span> <span class="n">O32IntRegs</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">Cpu0</span><span class="p">::</span><span class="n">A0</span><span class="p">,</span> <span class="n">Cpu0</span><span class="p">::</span><span class="n">A1</span><span class="p">};</span>
<span class="n">static</span> <span class="n">const</span> <span class="n">MCPhysReg</span> <span class="n">S32IntRegs</span> <span class="o">=</span> <span class="p">{};</span>
<span class="p">}</span>

<span class="n">const</span> <span class="n">ArrayRef</span><span class="o">&lt;</span><span class="n">MCPhysReg</span><span class="o">&gt;</span> <span class="n">Cpu0ABIInfo</span><span class="p">::</span><span class="n">GetByValArgRegs</span><span class="p">()</span> <span class="n">const</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">IsO32</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">makeArrayRef</span><span class="p">(</span><span class="n">O32IntRegs</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">IsS32</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">makeArrayRef</span><span class="p">(</span><span class="n">S32IntRegs</span><span class="p">);</span>
  <span class="n">llvm_unreachable</span><span class="p">(</span><span class="s2">&quot;Unhandled ABI&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">const</span> <span class="n">ArrayRef</span><span class="o">&lt;</span><span class="n">MCPhysReg</span><span class="o">&gt;</span> <span class="n">Cpu0ABIInfo</span><span class="p">::</span><span class="n">GetVarArgRegs</span><span class="p">()</span> <span class="n">const</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">IsO32</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">makeArrayRef</span><span class="p">(</span><span class="n">O32IntRegs</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">IsS32</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">makeArrayRef</span><span class="p">(</span><span class="n">S32IntRegs</span><span class="p">);</span>
  <span class="n">llvm_unreachable</span><span class="p">(</span><span class="s2">&quot;Unhandled ABI&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">unsigned</span> <span class="n">Cpu0ABIInfo</span><span class="p">::</span><span class="n">GetCalleeAllocdArgSizeInBytes</span><span class="p">(</span><span class="n">CallingConv</span><span class="p">::</span><span class="n">ID</span> <span class="n">CC</span><span class="p">)</span> <span class="n">const</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">IsO32</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">CC</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">IsS32</span><span class="p">())</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">llvm_unreachable</span><span class="p">(</span><span class="s2">&quot;Unhandled ABI&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">Cpu0ABIInfo</span> <span class="n">Cpu0ABIInfo</span><span class="p">::</span><span class="n">computeTargetABI</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">Cpu0ABIInfo</span> <span class="n">abi</span><span class="p">(</span><span class="n">ABI</span><span class="p">::</span><span class="n">Unknown</span><span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">EnableCpu0S32Calls</span><span class="p">)</span>
    <span class="n">abi</span> <span class="o">=</span> <span class="n">ABI</span><span class="p">::</span><span class="n">S32</span><span class="p">;</span>
  <span class="k">else</span>
    <span class="n">abi</span> <span class="o">=</span> <span class="n">ABI</span><span class="p">::</span><span class="n">O32</span><span class="p">;</span>
  <span class="o">//</span> <span class="n">Assert</span> <span class="n">exactly</span> <span class="n">one</span> <span class="n">ABI</span> <span class="n">was</span> <span class="n">chosen</span><span class="o">.</span>
  <span class="k">assert</span><span class="p">(</span><span class="n">abi</span><span class="o">.</span><span class="n">ThisABI</span> <span class="o">!=</span> <span class="n">ABI</span><span class="p">::</span><span class="n">Unknown</span><span class="p">);</span>

  <span class="k">return</span> <span class="n">abi</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">unsigned</span> <span class="n">Cpu0ABIInfo</span><span class="p">::</span><span class="n">GetStackPtr</span><span class="p">()</span> <span class="n">const</span> <span class="p">{</span>
  <span class="k">return</span> <span class="n">Cpu0</span><span class="p">::</span><span class="n">SP</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">unsigned</span> <span class="n">Cpu0ABIInfo</span><span class="p">::</span><span class="n">GetFramePtr</span><span class="p">()</span> <span class="n">const</span> <span class="p">{</span>
  <span class="k">return</span> <span class="n">Cpu0</span><span class="p">::</span><span class="n">FP</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">unsigned</span> <span class="n">Cpu0ABIInfo</span><span class="p">::</span><span class="n">GetNullPtr</span><span class="p">()</span> <span class="n">const</span> <span class="p">{</span>
  <span class="k">return</span> <span class="n">Cpu0</span><span class="p">::</span><span class="n">ZERO</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">unsigned</span> <span class="n">Cpu0ABIInfo</span><span class="p">::</span><span class="n">GetEhDataReg</span><span class="p">(</span><span class="n">unsigned</span> <span class="n">I</span><span class="p">)</span> <span class="n">const</span> <span class="p">{</span>
  <span class="n">static</span> <span class="n">const</span> <span class="n">unsigned</span> <span class="n">EhDataReg</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">Cpu0</span><span class="p">::</span><span class="n">A0</span><span class="p">,</span> <span class="n">Cpu0</span><span class="p">::</span><span class="n">A1</span>
  <span class="p">};</span>

  <span class="k">return</span> <span class="n">EhDataReg</span><span class="p">[</span><span class="n">I</span><span class="p">];</span>
<span class="p">}</span>

<span class="nb">int</span> <span class="n">Cpu0ABIInfo</span><span class="p">::</span><span class="n">EhDataRegSize</span><span class="p">()</span> <span class="n">const</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">ThisABI</span> <span class="o">==</span> <span class="n">ABI</span><span class="p">::</span><span class="n">S32</span><span class="p">)</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">else</span>
    <span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
<span class="p">}</span>

</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter3_1/Cpu0Subtarget.h</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>
<span class="c1">#include &quot;Cpu0FrameLowering.h&quot;</span>
<span class="c1">#include &quot;Cpu0ISelLowering.h&quot;</span>
<span class="c1">#include &quot;Cpu0InstrInfo.h&quot;</span>
<span class="c1">#include &quot;llvm/CodeGen/SelectionDAGTargetInfo.h&quot;</span>
<span class="c1">#include &quot;llvm/IR/DataLayout.h&quot;</span>
<span class="c1">#include &quot;llvm/MC/MCInstrItineraries.h&quot;</span>
<span class="c1">#include &quot;llvm/Target/TargetSubtargetInfo.h&quot;</span>
<span class="c1">#include &lt;string&gt;</span>

<span class="c1">#define GET_SUBTARGETINFO_HEADER</span>
<span class="c1">#include &quot;Cpu0GenSubtargetInfo.inc&quot;</span>

</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">namespace</span> <span class="n">llvm</span> <span class="p">{</span>
<span class="k">class</span> <span class="nc">StringRef</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">Cpu0TargetMachine</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">Cpu0Subtarget</span> <span class="p">:</span> <span class="n">public</span> <span class="n">Cpu0GenSubtargetInfo</span> <span class="p">{</span>
  <span class="n">virtual</span> <span class="n">void</span> <span class="n">anchor</span><span class="p">();</span>

<span class="n">public</span><span class="p">:</span>

  <span class="nb">bool</span> <span class="n">HasChapterDummy</span><span class="p">;</span>
  <span class="nb">bool</span> <span class="n">HasChapterAll</span><span class="p">;</span>

  <span class="nb">bool</span> <span class="n">hasChapter3_1</span><span class="p">()</span> <span class="n">const</span> <span class="p">{</span>
<span class="c1">#if CH &gt;= CH3_1</span>
    <span class="k">return</span> <span class="n">true</span><span class="p">;</span>
<span class="c1">#else</span>
    <span class="k">return</span> <span class="n">false</span><span class="p">;</span>
<span class="c1">#endif</span>
  <span class="p">}</span>

  <span class="nb">bool</span> <span class="n">hasChapter3_2</span><span class="p">()</span> <span class="n">const</span> <span class="p">{</span>
<span class="c1">#if CH &gt;= CH3_2</span>
    <span class="k">return</span> <span class="n">true</span><span class="p">;</span>
<span class="c1">#else</span>
    <span class="k">return</span> <span class="n">false</span><span class="p">;</span>
<span class="c1">#endif</span>
  <span class="p">}</span>

  <span class="nb">bool</span> <span class="n">hasChapter3_3</span><span class="p">()</span> <span class="n">const</span> <span class="p">{</span>
<span class="c1">#if CH &gt;= CH3_3</span>
    <span class="k">return</span> <span class="n">true</span><span class="p">;</span>
<span class="c1">#else</span>
    <span class="k">return</span> <span class="n">false</span><span class="p">;</span>
<span class="c1">#endif</span>
  <span class="p">}</span>

  <span class="nb">bool</span> <span class="n">hasChapter3_4</span><span class="p">()</span> <span class="n">const</span> <span class="p">{</span>
<span class="c1">#if CH &gt;= CH3_4</span>
    <span class="k">return</span> <span class="n">true</span><span class="p">;</span>
<span class="c1">#else</span>
    <span class="k">return</span> <span class="n">false</span><span class="p">;</span>
<span class="c1">#endif</span>
  <span class="p">}</span>

  <span class="nb">bool</span> <span class="n">hasChapter3_5</span><span class="p">()</span> <span class="n">const</span> <span class="p">{</span>
<span class="c1">#if CH &gt;= CH3_5</span>
    <span class="k">return</span> <span class="n">true</span><span class="p">;</span>
<span class="c1">#else</span>
    <span class="k">return</span> <span class="n">false</span><span class="p">;</span>
<span class="c1">#endif</span>
  <span class="p">}</span>

  <span class="nb">bool</span> <span class="n">hasChapter4_1</span><span class="p">()</span> <span class="n">const</span> <span class="p">{</span>
<span class="c1">#if CH &gt;= CH4_1</span>
    <span class="k">return</span> <span class="n">true</span><span class="p">;</span>
<span class="c1">#else</span>
    <span class="k">return</span> <span class="n">false</span><span class="p">;</span>
<span class="c1">#endif</span>
  <span class="p">}</span>

  <span class="nb">bool</span> <span class="n">hasChapter4_2</span><span class="p">()</span> <span class="n">const</span> <span class="p">{</span>
<span class="c1">#if CH &gt;= CH4_2</span>
    <span class="k">return</span> <span class="n">true</span><span class="p">;</span>
<span class="c1">#else</span>
    <span class="k">return</span> <span class="n">false</span><span class="p">;</span>
<span class="c1">#endif</span>
  <span class="p">}</span>

  <span class="nb">bool</span> <span class="n">hasChapter5_1</span><span class="p">()</span> <span class="n">const</span> <span class="p">{</span>
<span class="c1">#if CH &gt;= CH5_1</span>
    <span class="k">return</span> <span class="n">true</span><span class="p">;</span>
<span class="c1">#else</span>
    <span class="k">return</span> <span class="n">false</span><span class="p">;</span>
<span class="c1">#endif</span>
  <span class="p">}</span>

  <span class="nb">bool</span> <span class="n">hasChapter6_1</span><span class="p">()</span> <span class="n">const</span> <span class="p">{</span>
<span class="c1">#if CH &gt;= CH6_1</span>
    <span class="k">return</span> <span class="n">true</span><span class="p">;</span>
<span class="c1">#else</span>
    <span class="k">return</span> <span class="n">false</span><span class="p">;</span>
<span class="c1">#endif</span>
  <span class="p">}</span>

  <span class="nb">bool</span> <span class="n">hasChapter7_1</span><span class="p">()</span> <span class="n">const</span> <span class="p">{</span>
<span class="c1">#if CH &gt;= CH7_1</span>
    <span class="k">return</span> <span class="n">true</span><span class="p">;</span>
<span class="c1">#else</span>
    <span class="k">return</span> <span class="n">false</span><span class="p">;</span>
<span class="c1">#endif</span>
  <span class="p">}</span>

  <span class="nb">bool</span> <span class="n">hasChapter8_1</span><span class="p">()</span> <span class="n">const</span> <span class="p">{</span>
<span class="c1">#if CH &gt;= CH8_1</span>
    <span class="k">return</span> <span class="n">true</span><span class="p">;</span>
<span class="c1">#else</span>
    <span class="k">return</span> <span class="n">false</span><span class="p">;</span>
<span class="c1">#endif</span>
  <span class="p">}</span>

  <span class="nb">bool</span> <span class="n">hasChapter8_2</span><span class="p">()</span> <span class="n">const</span> <span class="p">{</span>
<span class="c1">#if CH &gt;= CH8_2</span>
    <span class="k">return</span> <span class="n">true</span><span class="p">;</span>
<span class="c1">#else</span>
    <span class="k">return</span> <span class="n">false</span><span class="p">;</span>
<span class="c1">#endif</span>
  <span class="p">}</span>
  
  <span class="nb">bool</span> <span class="n">hasChapter9_1</span><span class="p">()</span> <span class="n">const</span> <span class="p">{</span>
<span class="c1">#if CH &gt;= CH9_1</span>
    <span class="k">return</span> <span class="n">true</span><span class="p">;</span>
<span class="c1">#else</span>
    <span class="k">return</span> <span class="n">false</span><span class="p">;</span>
<span class="c1">#endif</span>
  <span class="p">}</span>

  <span class="nb">bool</span> <span class="n">hasChapter9_2</span><span class="p">()</span> <span class="n">const</span> <span class="p">{</span>
<span class="c1">#if CH &gt;= CH9_2</span>
    <span class="k">return</span> <span class="n">true</span><span class="p">;</span>
<span class="c1">#else</span>
    <span class="k">return</span> <span class="n">false</span><span class="p">;</span>
<span class="c1">#endif</span>
  <span class="p">}</span>

  <span class="nb">bool</span> <span class="n">hasChapter9_3</span><span class="p">()</span> <span class="n">const</span> <span class="p">{</span>
<span class="c1">#if CH &gt;= CH9_3</span>
    <span class="k">return</span> <span class="n">true</span><span class="p">;</span>
<span class="c1">#else</span>
    <span class="k">return</span> <span class="n">false</span><span class="p">;</span>
<span class="c1">#endif</span>
  <span class="p">}</span>

  <span class="nb">bool</span> <span class="n">hasChapter10_1</span><span class="p">()</span> <span class="n">const</span> <span class="p">{</span>
<span class="c1">#if CH &gt;= CH10_1</span>
    <span class="k">return</span> <span class="n">true</span><span class="p">;</span>
<span class="c1">#else</span>
    <span class="k">return</span> <span class="n">false</span><span class="p">;</span>
<span class="c1">#endif</span>
  <span class="p">}</span>

  <span class="nb">bool</span> <span class="n">hasChapter11_1</span><span class="p">()</span> <span class="n">const</span> <span class="p">{</span>
<span class="c1">#if CH &gt;= CH11_1</span>
    <span class="k">return</span> <span class="n">true</span><span class="p">;</span>
<span class="c1">#else</span>
    <span class="k">return</span> <span class="n">false</span><span class="p">;</span>
<span class="c1">#endif</span>
  <span class="p">}</span>

  <span class="nb">bool</span> <span class="n">hasChapter11_2</span><span class="p">()</span> <span class="n">const</span> <span class="p">{</span>
<span class="c1">#if CH &gt;= CH11_2</span>
    <span class="k">return</span> <span class="n">true</span><span class="p">;</span>
<span class="c1">#else</span>
    <span class="k">return</span> <span class="n">false</span><span class="p">;</span>
<span class="c1">#endif</span>
  <span class="p">}</span>

  <span class="nb">bool</span> <span class="n">hasChapter12_1</span><span class="p">()</span> <span class="n">const</span> <span class="p">{</span>
<span class="c1">#if CH &gt;= CH12_1</span>
    <span class="k">return</span> <span class="n">true</span><span class="p">;</span>
<span class="c1">#else</span>
    <span class="k">return</span> <span class="n">false</span><span class="p">;</span>
<span class="c1">#endif</span>
  <span class="p">}</span>

<span class="n">protected</span><span class="p">:</span>
  <span class="n">enum</span> <span class="n">Cpu0ArchEnum</span> <span class="p">{</span>
    <span class="n">Cpu032I</span><span class="p">,</span>
    <span class="n">Cpu032II</span>
  <span class="p">};</span>

  <span class="o">//</span> <span class="n">Cpu0</span> <span class="n">architecture</span> <span class="n">version</span>
  <span class="n">Cpu0ArchEnum</span> <span class="n">Cpu0ArchVersion</span><span class="p">;</span>

  <span class="o">//</span> <span class="n">IsLittle</span> <span class="o">-</span> <span class="n">The</span> <span class="n">target</span> <span class="ow">is</span> <span class="n">Little</span> <span class="n">Endian</span>
  <span class="nb">bool</span> <span class="n">IsLittle</span><span class="p">;</span>

  <span class="nb">bool</span> <span class="n">EnableOverflow</span><span class="p">;</span>

  <span class="o">//</span> <span class="n">HasCmp</span> <span class="o">-</span> <span class="nb">cmp</span> <span class="n">instructions</span><span class="o">.</span>
  <span class="nb">bool</span> <span class="n">HasCmp</span><span class="p">;</span>

  <span class="o">//</span> <span class="n">HasSlt</span> <span class="o">-</span> <span class="n">slt</span> <span class="n">instructions</span><span class="o">.</span>
  <span class="nb">bool</span> <span class="n">HasSlt</span><span class="p">;</span>

  <span class="n">InstrItineraryData</span> <span class="n">InstrItins</span><span class="p">;</span>

</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span>
  const Cpu0TargetMachine &amp;TM;

  Triple TargetTriple;

  const SelectionDAGTargetInfo TSInfo;

  std::unique_ptr&lt;const Cpu0InstrInfo&gt; InstrInfo;
  std::unique_ptr&lt;const Cpu0FrameLowering&gt; FrameLowering;
  std::unique_ptr&lt;const Cpu0TargetLowering&gt; TLInfo;

public:
  bool isPositionIndependent() const;
  const Cpu0ABIInfo &amp;getABI() const;

  /// This constructor initializes the data members to match that
  /// of the specified triple.
  Cpu0Subtarget(const Triple &amp;TT, const std::string &amp;CPU, const std::string &amp;FS,
                bool little, const Cpu0TargetMachine &amp;_TM);

//- Vitual function, must have
  /// ParseSubtargetFeatures - Parses features string setting specified
  /// subtarget options.  Definition of function is auto generated by tblgen.
  void ParseSubtargetFeatures(StringRef CPU, StringRef FS);

  bool isLittle() const { return IsLittle; }
  bool hasCpu032I() const { return Cpu0ArchVersion &gt;= Cpu032I; }
  bool isCpu032I() const { return Cpu0ArchVersion == Cpu032I; }
  bool hasCpu032II() const { return Cpu0ArchVersion &gt;= Cpu032II; }
  bool isCpu032II() const { return Cpu0ArchVersion == Cpu032II; }

  /// Features related to the presence of specific instructions.
  bool enableOverflow() const { return EnableOverflow; }
  bool disableOverflow() const { return !EnableOverflow; }
  bool hasCmp()   const { return HasCmp; }
  bool hasSlt()   const { return HasSlt; }

</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span>
  <span class="nb">bool</span> <span class="n">abiUsesSoftFloat</span><span class="p">()</span> <span class="n">const</span><span class="p">;</span>

  <span class="nb">bool</span> <span class="n">enableLongBranchPass</span><span class="p">()</span> <span class="n">const</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">hasCpu032II</span><span class="p">();</span>
  <span class="p">}</span>
  
  <span class="n">unsigned</span> <span class="n">stackAlignment</span><span class="p">()</span> <span class="n">const</span> <span class="p">{</span> <span class="k">return</span> <span class="mi">8</span><span class="p">;</span> <span class="p">}</span>

  <span class="n">Cpu0Subtarget</span> <span class="o">&amp;</span><span class="n">initializeSubtargetDependencies</span><span class="p">(</span><span class="n">StringRef</span> <span class="n">CPU</span><span class="p">,</span> <span class="n">StringRef</span> <span class="n">FS</span><span class="p">,</span>
                                                 <span class="n">const</span> <span class="n">TargetMachine</span> <span class="o">&amp;</span><span class="n">TM</span><span class="p">);</span>

  <span class="n">const</span> <span class="n">SelectionDAGTargetInfo</span> <span class="o">*</span><span class="n">getSelectionDAGInfo</span><span class="p">()</span> <span class="n">const</span> <span class="n">override</span> <span class="p">{</span>
    <span class="k">return</span> <span class="o">&amp;</span><span class="n">TSInfo</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="n">const</span> <span class="n">Cpu0InstrInfo</span> <span class="o">*</span><span class="n">getInstrInfo</span><span class="p">()</span> <span class="n">const</span> <span class="n">override</span> <span class="p">{</span> <span class="k">return</span> <span class="n">InstrInfo</span><span class="o">.</span><span class="n">get</span><span class="p">();</span> <span class="p">}</span>
  <span class="n">const</span> <span class="n">TargetFrameLowering</span> <span class="o">*</span><span class="n">getFrameLowering</span><span class="p">()</span> <span class="n">const</span> <span class="n">override</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">FrameLowering</span><span class="o">.</span><span class="n">get</span><span class="p">();</span>
  <span class="p">}</span>
  <span class="n">const</span> <span class="n">Cpu0RegisterInfo</span> <span class="o">*</span><span class="n">getRegisterInfo</span><span class="p">()</span> <span class="n">const</span> <span class="n">override</span> <span class="p">{</span>
    <span class="k">return</span> <span class="o">&amp;</span><span class="n">InstrInfo</span><span class="o">-&gt;</span><span class="n">getRegisterInfo</span><span class="p">();</span>
  <span class="p">}</span>
  <span class="n">const</span> <span class="n">Cpu0TargetLowering</span> <span class="o">*</span><span class="n">getTargetLowering</span><span class="p">()</span> <span class="n">const</span> <span class="n">override</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">TLInfo</span><span class="o">.</span><span class="n">get</span><span class="p">();</span>
  <span class="p">}</span>
  <span class="n">const</span> <span class="n">InstrItineraryData</span> <span class="o">*</span><span class="n">getInstrItineraryData</span><span class="p">()</span> <span class="n">const</span> <span class="n">override</span> <span class="p">{</span>
    <span class="k">return</span> <span class="o">&amp;</span><span class="n">InstrItins</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">};</span>
<span class="p">}</span> <span class="o">//</span> <span class="n">End</span> <span class="n">llvm</span> <span class="n">namespace</span>


<span class="c1">#endif</span>
</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter3_1/Cpu0Subtarget.cpp</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">//===--</span> <span class="n">Cpu0Subtarget</span><span class="o">.</span><span class="n">cpp</span> <span class="o">-</span> <span class="n">Cpu0</span> <span class="n">Subtarget</span> <span class="n">Information</span> <span class="o">--------------------===//</span>
<span class="o">//</span>
<span class="o">//</span>                     <span class="n">The</span> <span class="n">LLVM</span> <span class="n">Compiler</span> <span class="n">Infrastructure</span>
<span class="o">//</span>
<span class="o">//</span> <span class="n">This</span> <span class="n">file</span> <span class="ow">is</span> <span class="n">distributed</span> <span class="n">under</span> <span class="n">the</span> <span class="n">University</span> <span class="n">of</span> <span class="n">Illinois</span> <span class="n">Open</span> <span class="n">Source</span>
<span class="o">//</span> <span class="n">License</span><span class="o">.</span> <span class="n">See</span> <span class="n">LICENSE</span><span class="o">.</span><span class="n">TXT</span> <span class="k">for</span> <span class="n">details</span><span class="o">.</span>
<span class="o">//</span>
<span class="o">//===----------------------------------------------------------------------===//</span>
<span class="o">//</span>
<span class="o">//</span> <span class="n">This</span> <span class="n">file</span> <span class="n">implements</span> <span class="n">the</span> <span class="n">Cpu0</span> <span class="n">specific</span> <span class="n">subclass</span> <span class="n">of</span> <span class="n">TargetSubtargetInfo</span><span class="o">.</span>
<span class="o">//</span>
<span class="o">//===----------------------------------------------------------------------===//</span>

<span class="c1">#include &quot;Cpu0Subtarget.h&quot;</span>

<span class="c1">#include &quot;Cpu0MachineFunction.h&quot;</span>
<span class="c1">#include &quot;Cpu0.h&quot;</span>
<span class="c1">#include &quot;Cpu0RegisterInfo.h&quot;</span>

<span class="c1">#include &quot;Cpu0TargetMachine.h&quot;</span>
<span class="c1">#include &quot;llvm/IR/Attributes.h&quot;</span>
<span class="c1">#include &quot;llvm/IR/Function.h&quot;</span>
<span class="c1">#include &quot;llvm/Support/CommandLine.h&quot;</span>
<span class="c1">#include &quot;llvm/Support/ErrorHandling.h&quot;</span>
<span class="c1">#include &quot;llvm/Support/TargetRegistry.h&quot;</span>

<span class="n">using</span> <span class="n">namespace</span> <span class="n">llvm</span><span class="p">;</span>

<span class="c1">#define DEBUG_TYPE &quot;cpu0-subtarget&quot;</span>

<span class="c1">#define GET_SUBTARGETINFO_TARGET_DESC</span>
<span class="c1">#define GET_SUBTARGETINFO_CTOR</span>
<span class="c1">#include &quot;Cpu0GenSubtargetInfo.inc&quot;</span>

<span class="n">extern</span> <span class="nb">bool</span> <span class="n">FixGlobalBaseReg</span><span class="p">;</span>

<span class="n">void</span> <span class="n">Cpu0Subtarget</span><span class="p">::</span><span class="n">anchor</span><span class="p">()</span> <span class="p">{</span> <span class="p">}</span>

<span class="o">//</span><span class="nd">@1</span> <span class="p">{</span>
<span class="n">Cpu0Subtarget</span><span class="p">::</span><span class="n">Cpu0Subtarget</span><span class="p">(</span><span class="n">const</span> <span class="n">Triple</span> <span class="o">&amp;</span><span class="n">TT</span><span class="p">,</span> <span class="n">const</span> <span class="n">std</span><span class="p">::</span><span class="n">string</span> <span class="o">&amp;</span><span class="n">CPU</span><span class="p">,</span>
                             <span class="n">const</span> <span class="n">std</span><span class="p">::</span><span class="n">string</span> <span class="o">&amp;</span><span class="n">FS</span><span class="p">,</span> <span class="nb">bool</span> <span class="n">little</span><span class="p">,</span> 
                             <span class="n">const</span> <span class="n">Cpu0TargetMachine</span> <span class="o">&amp;</span><span class="n">_TM</span><span class="p">)</span> <span class="p">:</span>
<span class="o">//</span><span class="nd">@1</span> <span class="p">}</span>
  <span class="o">//</span> <span class="n">Cpu0GenSubtargetInfo</span> <span class="n">will</span> <span class="n">display</span> <span class="n">features</span> <span class="n">by</span> <span class="n">llc</span> <span class="o">-</span><span class="n">march</span><span class="o">=</span><span class="n">cpu0</span> <span class="o">-</span><span class="n">mcpu</span><span class="o">=</span><span class="n">help</span>
  <span class="n">Cpu0GenSubtargetInfo</span><span class="p">(</span><span class="n">TT</span><span class="p">,</span> <span class="n">CPU</span><span class="p">,</span> <span class="n">FS</span><span class="p">),</span>
  <span class="n">IsLittle</span><span class="p">(</span><span class="n">little</span><span class="p">),</span> <span class="n">TM</span><span class="p">(</span><span class="n">_TM</span><span class="p">),</span> <span class="n">TargetTriple</span><span class="p">(</span><span class="n">TT</span><span class="p">),</span> <span class="n">TSInfo</span><span class="p">(),</span>
      <span class="n">InstrInfo</span><span class="p">(</span>
          <span class="n">Cpu0InstrInfo</span><span class="p">::</span><span class="n">create</span><span class="p">(</span><span class="n">initializeSubtargetDependencies</span><span class="p">(</span><span class="n">CPU</span><span class="p">,</span> <span class="n">FS</span><span class="p">,</span> <span class="n">TM</span><span class="p">))),</span>
      <span class="n">FrameLowering</span><span class="p">(</span><span class="n">Cpu0FrameLowering</span><span class="p">::</span><span class="n">create</span><span class="p">(</span><span class="o">*</span><span class="n">this</span><span class="p">)),</span>
      <span class="n">TLInfo</span><span class="p">(</span><span class="n">Cpu0TargetLowering</span><span class="p">::</span><span class="n">create</span><span class="p">(</span><span class="n">TM</span><span class="p">,</span> <span class="o">*</span><span class="n">this</span><span class="p">))</span> <span class="p">{</span>

<span class="p">}</span>

<span class="nb">bool</span> <span class="n">Cpu0Subtarget</span><span class="p">::</span><span class="n">isPositionIndependent</span><span class="p">()</span> <span class="n">const</span> <span class="p">{</span>
  <span class="k">return</span> <span class="n">TM</span><span class="o">.</span><span class="n">isPositionIndependent</span><span class="p">();</span>
<span class="p">}</span>

<span class="n">Cpu0Subtarget</span> <span class="o">&amp;</span>
<span class="n">Cpu0Subtarget</span><span class="p">::</span><span class="n">initializeSubtargetDependencies</span><span class="p">(</span><span class="n">StringRef</span> <span class="n">CPU</span><span class="p">,</span> <span class="n">StringRef</span> <span class="n">FS</span><span class="p">,</span>
                                               <span class="n">const</span> <span class="n">TargetMachine</span> <span class="o">&amp;</span><span class="n">TM</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">TargetTriple</span><span class="o">.</span><span class="n">getArch</span><span class="p">()</span> <span class="o">==</span> <span class="n">Triple</span><span class="p">::</span><span class="n">cpu0</span> <span class="o">||</span> <span class="n">TargetTriple</span><span class="o">.</span><span class="n">getArch</span><span class="p">()</span> <span class="o">==</span> <span class="n">Triple</span><span class="p">::</span><span class="n">cpu0el</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">CPU</span><span class="o">.</span><span class="n">empty</span><span class="p">()</span> <span class="o">||</span> <span class="n">CPU</span> <span class="o">==</span> <span class="s2">&quot;generic&quot;</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">CPU</span> <span class="o">=</span> <span class="s2">&quot;cpu032II&quot;</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">CPU</span> <span class="o">==</span> <span class="s2">&quot;help&quot;</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">CPU</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
      <span class="k">return</span> <span class="o">*</span><span class="n">this</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">CPU</span> <span class="o">!=</span> <span class="s2">&quot;cpu032I&quot;</span> <span class="o">&amp;&amp;</span> <span class="n">CPU</span> <span class="o">!=</span> <span class="s2">&quot;cpu032II&quot;</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">CPU</span> <span class="o">=</span> <span class="s2">&quot;cpu032II&quot;</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">else</span> <span class="p">{</span>
    <span class="n">errs</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s2">&quot;!!!Error, TargetTriple.getArch() = &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">TargetTriple</span><span class="o">.</span><span class="n">getArch</span><span class="p">()</span>
           <span class="o">&lt;&lt;</span>  <span class="s2">&quot;CPU = &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">CPU</span> <span class="o">&lt;&lt;</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>
    <span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
  <span class="p">}</span>
  
  <span class="k">if</span> <span class="p">(</span><span class="n">CPU</span> <span class="o">==</span> <span class="s2">&quot;cpu032I&quot;</span><span class="p">)</span>
    <span class="n">Cpu0ArchVersion</span> <span class="o">=</span> <span class="n">Cpu032I</span><span class="p">;</span>
  <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">CPU</span> <span class="o">==</span> <span class="s2">&quot;cpu032II&quot;</span><span class="p">)</span>
    <span class="n">Cpu0ArchVersion</span> <span class="o">=</span> <span class="n">Cpu032II</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">isCpu032I</span><span class="p">())</span> <span class="p">{</span>
    <span class="n">HasCmp</span> <span class="o">=</span> <span class="n">true</span><span class="p">;</span>
    <span class="n">HasSlt</span> <span class="o">=</span> <span class="n">false</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">isCpu032II</span><span class="p">())</span> <span class="p">{</span>
    <span class="n">HasCmp</span> <span class="o">=</span> <span class="n">true</span><span class="p">;</span>
    <span class="n">HasSlt</span> <span class="o">=</span> <span class="n">true</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">else</span> <span class="p">{</span>
    <span class="n">errs</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s2">&quot;-mcpu must be empty(default:cpu032II), cpu032I or cpu032II&quot;</span> <span class="o">&lt;&lt;</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="o">//</span> <span class="n">Parse</span> <span class="n">features</span> <span class="n">string</span><span class="o">.</span>
  <span class="n">ParseSubtargetFeatures</span><span class="p">(</span><span class="n">CPU</span><span class="p">,</span> <span class="n">FS</span><span class="p">);</span>
  <span class="o">//</span> <span class="n">Initialize</span> <span class="n">scheduling</span> <span class="n">itinerary</span> <span class="k">for</span> <span class="n">the</span> <span class="n">specified</span> <span class="n">CPU</span><span class="o">.</span>
  <span class="n">InstrItins</span> <span class="o">=</span> <span class="n">getInstrItineraryForCPU</span><span class="p">(</span><span class="n">CPU</span><span class="p">);</span>

  <span class="k">return</span> <span class="o">*</span><span class="n">this</span><span class="p">;</span>
<span class="p">}</span>

<span class="nb">bool</span> <span class="n">Cpu0Subtarget</span><span class="p">::</span><span class="n">abiUsesSoftFloat</span><span class="p">()</span> <span class="n">const</span> <span class="p">{</span>
<span class="o">//</span>  <span class="k">return</span> <span class="n">TM</span><span class="o">-&gt;</span><span class="n">Options</span><span class="o">.</span><span class="n">UseSoftFloat</span><span class="p">;</span>
  <span class="k">return</span> <span class="n">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">const</span> <span class="n">Cpu0ABIInfo</span> <span class="o">&amp;</span><span class="n">Cpu0Subtarget</span><span class="p">::</span><span class="n">getABI</span><span class="p">()</span> <span class="n">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">TM</span><span class="o">.</span><span class="n">getABI</span><span class="p">();</span> <span class="p">}</span>

</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter3_1/Cpu0RegisterInfo.h</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">//===--</span> <span class="n">Cpu0RegisterInfo</span><span class="o">.</span><span class="n">h</span> <span class="o">-</span> <span class="n">Cpu0</span> <span class="n">Register</span> <span class="n">Information</span> <span class="n">Impl</span> <span class="o">-----*-</span> <span class="n">C</span><span class="o">++</span> <span class="o">-*-===//</span>
<span class="o">//</span>
<span class="o">//</span>                     <span class="n">The</span> <span class="n">LLVM</span> <span class="n">Compiler</span> <span class="n">Infrastructure</span>
<span class="o">//</span>
<span class="o">//</span> <span class="n">This</span> <span class="n">file</span> <span class="ow">is</span> <span class="n">distributed</span> <span class="n">under</span> <span class="n">the</span> <span class="n">University</span> <span class="n">of</span> <span class="n">Illinois</span> <span class="n">Open</span> <span class="n">Source</span>
<span class="o">//</span> <span class="n">License</span><span class="o">.</span> <span class="n">See</span> <span class="n">LICENSE</span><span class="o">.</span><span class="n">TXT</span> <span class="k">for</span> <span class="n">details</span><span class="o">.</span>
<span class="o">//</span>
<span class="o">//===----------------------------------------------------------------------===//</span>
<span class="o">//</span>
<span class="o">//</span> <span class="n">This</span> <span class="n">file</span> <span class="n">contains</span> <span class="n">the</span> <span class="n">Cpu0</span> <span class="n">implementation</span> <span class="n">of</span> <span class="n">the</span> <span class="n">TargetRegisterInfo</span> <span class="n">class</span><span class="o">.</span>
<span class="o">//</span>
<span class="o">//===----------------------------------------------------------------------===//</span>

<span class="c1">#ifndef LLVM_LIB_TARGET_CPU0_CPU0REGISTERINFO_H</span>
<span class="c1">#define LLVM_LIB_TARGET_CPU0_CPU0REGISTERINFO_H</span>

<span class="c1">#include &quot;Cpu0Config.h&quot;</span>

<span class="c1">#include &quot;Cpu0.h&quot;</span>
<span class="c1">#include &quot;llvm/Target/TargetRegisterInfo.h&quot;</span>

<span class="c1">#define GET_REGINFO_HEADER</span>
<span class="c1">#include &quot;Cpu0GenRegisterInfo.inc&quot;</span>

<span class="n">namespace</span> <span class="n">llvm</span> <span class="p">{</span>
<span class="k">class</span> <span class="nc">Cpu0Subtarget</span><span class="p">;</span>
<span class="k">class</span> <span class="nc">TargetInstrInfo</span><span class="p">;</span>
<span class="k">class</span> <span class="nc">Type</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">Cpu0RegisterInfo</span> <span class="p">:</span> <span class="n">public</span> <span class="n">Cpu0GenRegisterInfo</span> <span class="p">{</span>
<span class="n">protected</span><span class="p">:</span>
  <span class="n">const</span> <span class="n">Cpu0Subtarget</span> <span class="o">&amp;</span><span class="n">Subtarget</span><span class="p">;</span>

<span class="n">public</span><span class="p">:</span>
  <span class="n">Cpu0RegisterInfo</span><span class="p">(</span><span class="n">const</span> <span class="n">Cpu0Subtarget</span> <span class="o">&amp;</span><span class="n">Subtarget</span><span class="p">);</span>

  <span class="n">const</span> <span class="n">MCPhysReg</span> <span class="o">*</span><span class="n">getCalleeSavedRegs</span><span class="p">(</span><span class="n">const</span> <span class="n">MachineFunction</span> <span class="o">*</span><span class="n">MF</span><span class="p">)</span> <span class="n">const</span> <span class="n">override</span><span class="p">;</span>

  <span class="n">const</span> <span class="n">uint32_t</span> <span class="o">*</span><span class="n">getCallPreservedMask</span><span class="p">(</span><span class="n">const</span> <span class="n">MachineFunction</span> <span class="o">&amp;</span><span class="n">MF</span><span class="p">,</span>
                                       <span class="n">CallingConv</span><span class="p">::</span><span class="n">ID</span><span class="p">)</span> <span class="n">const</span> <span class="n">override</span><span class="p">;</span>

  <span class="n">BitVector</span> <span class="n">getReservedRegs</span><span class="p">(</span><span class="n">const</span> <span class="n">MachineFunction</span> <span class="o">&amp;</span><span class="n">MF</span><span class="p">)</span> <span class="n">const</span> <span class="n">override</span><span class="p">;</span>

  <span class="nb">bool</span> <span class="n">requiresRegisterScavenging</span><span class="p">(</span><span class="n">const</span> <span class="n">MachineFunction</span> <span class="o">&amp;</span><span class="n">MF</span><span class="p">)</span> <span class="n">const</span> <span class="n">override</span><span class="p">;</span>

  <span class="nb">bool</span> <span class="n">trackLivenessAfterRegAlloc</span><span class="p">(</span><span class="n">const</span> <span class="n">MachineFunction</span> <span class="o">&amp;</span><span class="n">MF</span><span class="p">)</span> <span class="n">const</span> <span class="n">override</span><span class="p">;</span>

  <span class="o">///</span> <span class="n">Stack</span> <span class="n">Frame</span> <span class="n">Processing</span> <span class="n">Methods</span>
  <span class="n">void</span> <span class="n">eliminateFrameIndex</span><span class="p">(</span><span class="n">MachineBasicBlock</span><span class="p">::</span><span class="n">iterator</span> <span class="n">II</span><span class="p">,</span>
                           <span class="nb">int</span> <span class="n">SPAdj</span><span class="p">,</span> <span class="n">unsigned</span> <span class="n">FIOperandNum</span><span class="p">,</span>
                           <span class="n">RegScavenger</span> <span class="o">*</span><span class="n">RS</span> <span class="o">=</span> <span class="n">nullptr</span><span class="p">)</span> <span class="n">const</span> <span class="n">override</span><span class="p">;</span>

  <span class="o">///</span> <span class="n">Debug</span> <span class="n">information</span> <span class="n">queries</span><span class="o">.</span>
  <span class="n">unsigned</span> <span class="n">getFrameRegister</span><span class="p">(</span><span class="n">const</span> <span class="n">MachineFunction</span> <span class="o">&amp;</span><span class="n">MF</span><span class="p">)</span> <span class="n">const</span> <span class="n">override</span><span class="p">;</span>

  <span class="o">///</span> \<span class="n">brief</span> <span class="n">Return</span> <span class="n">GPR</span> <span class="n">register</span> <span class="n">class</span><span class="o">.</span>
  <span class="n">virtual</span> <span class="n">const</span> <span class="n">TargetRegisterClass</span> <span class="o">*</span><span class="n">intRegClass</span><span class="p">(</span><span class="n">unsigned</span> <span class="n">Size</span><span class="p">)</span> <span class="n">const</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">};</span>

<span class="p">}</span> <span class="o">//</span> <span class="n">end</span> <span class="n">namespace</span> <span class="n">llvm</span>

<span class="c1">#endif</span>

</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter3_1/Cpu0RegisterInfo.cpp</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>//===-- Cpu0RegisterInfo.cpp - CPU0 Register Information -== --------------===//
//
//                     The LLVM Compiler Infrastructure
//
// This file is distributed under the University of Illinois Open Source
// License. See LICENSE.TXT for details.
//
//===----------------------------------------------------------------------===//
//
// This file contains the CPU0 implementation of the TargetRegisterInfo class.
//
//===----------------------------------------------------------------------===//

#define DEBUG_TYPE &quot;cpu0-reg-info&quot;

#include &quot;Cpu0RegisterInfo.h&quot;

#include &quot;Cpu0.h&quot;
#include &quot;Cpu0Subtarget.h&quot;
#include &quot;Cpu0MachineFunction.h&quot;
#include &quot;llvm/IR/Function.h&quot;
#include &quot;llvm/IR/Type.h&quot;
#include &quot;llvm/Support/CommandLine.h&quot;
#include &quot;llvm/Support/Debug.h&quot;
#include &quot;llvm/Support/ErrorHandling.h&quot;
#include &quot;llvm/Support/raw_ostream.h&quot;

#define GET_REGINFO_TARGET_DESC
#include &quot;Cpu0GenRegisterInfo.inc&quot;

using namespace llvm;

Cpu0RegisterInfo::Cpu0RegisterInfo(const Cpu0Subtarget &amp;ST)
  : Cpu0GenRegisterInfo(Cpu0::LR), Subtarget(ST) {}

//===----------------------------------------------------------------------===//
// Callee Saved Registers methods
//===----------------------------------------------------------------------===//
/// Cpu0 Callee Saved Registers
// In Cpu0CallConv.td,
// def CSR_O32 : CalleeSavedRegs&lt;(add LR, FP,
//                                   (sequence &quot;S%u&quot;, 2, 0))&gt;;
// llc create CSR_O32_SaveList and CSR_O32_RegMask from above defined.
const MCPhysReg *
Cpu0RegisterInfo::getCalleeSavedRegs(const MachineFunction *MF) const {
  return CSR_O32_SaveList;
}

const uint32_t *
Cpu0RegisterInfo::getCallPreservedMask(const MachineFunction &amp;MF,
                                       CallingConv::ID) const {
  return CSR_O32_RegMask; 
}

// pure virtual method
//@getReservedRegs {
BitVector Cpu0RegisterInfo::
getReservedRegs(const MachineFunction &amp;MF) const {
//@getReservedRegs body {
  static const uint16_t ReservedCPURegs[] = {
    Cpu0::ZERO, Cpu0::AT, Cpu0::SP, Cpu0::LR, Cpu0::PC
  };
  BitVector Reserved(getNumRegs());

  for (unsigned I = 0; I &lt; array_lengthof(ReservedCPURegs); ++I)
    Reserved.set(ReservedCPURegs[I]);

  return Reserved;
}

//@eliminateFrameIndex {
//- If no eliminateFrameIndex(), it will hang on run. 
// pure virtual method
// FrameIndex represent objects inside a abstract stack.
// We must replace FrameIndex with an stack/frame pointer
// direct reference.
void Cpu0RegisterInfo::
eliminateFrameIndex(MachineBasicBlock::iterator II, int SPAdj,
                    unsigned FIOperandNum, RegScavenger *RS) const {
}
//}

bool
Cpu0RegisterInfo::requiresRegisterScavenging(const MachineFunction &amp;MF) const {
  return true;
}

bool
Cpu0RegisterInfo::trackLivenessAfterRegAlloc(const MachineFunction &amp;MF) const {
  return true;
}

// pure virtual method
unsigned Cpu0RegisterInfo::
getFrameRegister(const MachineFunction &amp;MF) const {
  const TargetFrameLowering *TFI = MF.getSubtarget().getFrameLowering();
  return TFI-&gt;hasFP(MF) ? (Cpu0::FP) :
                          (Cpu0::SP);
}

</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter3_1/Cpu0SERegisterInfo.h</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">//===--</span> <span class="n">Cpu0SERegisterInfo</span><span class="o">.</span><span class="n">h</span> <span class="o">-</span> <span class="n">Cpu032</span> <span class="n">Register</span> <span class="n">Information</span> <span class="o">------*-</span> <span class="n">C</span><span class="o">++</span> <span class="o">-*-===//</span>
<span class="o">//</span>
<span class="o">//</span>                     <span class="n">The</span> <span class="n">LLVM</span> <span class="n">Compiler</span> <span class="n">Infrastructure</span>
<span class="o">//</span>
<span class="o">//</span> <span class="n">This</span> <span class="n">file</span> <span class="ow">is</span> <span class="n">distributed</span> <span class="n">under</span> <span class="n">the</span> <span class="n">University</span> <span class="n">of</span> <span class="n">Illinois</span> <span class="n">Open</span> <span class="n">Source</span>
<span class="o">//</span> <span class="n">License</span><span class="o">.</span> <span class="n">See</span> <span class="n">LICENSE</span><span class="o">.</span><span class="n">TXT</span> <span class="k">for</span> <span class="n">details</span><span class="o">.</span>
<span class="o">//</span>
<span class="o">//===----------------------------------------------------------------------===//</span>
<span class="o">//</span>
<span class="o">//</span> <span class="n">This</span> <span class="n">file</span> <span class="n">contains</span> <span class="n">the</span> <span class="n">Cpu032</span><span class="o">/</span><span class="mi">64</span> <span class="n">implementation</span> <span class="n">of</span> <span class="n">the</span> <span class="n">TargetRegisterInfo</span>
<span class="o">//</span> <span class="n">class</span><span class="o">.</span>
<span class="o">//</span>
<span class="o">//===----------------------------------------------------------------------===//</span>

<span class="c1">#ifndef LLVM_LIB_TARGET_CPU0_CPU0SEREGISTERINFO_H</span>
<span class="c1">#define LLVM_LIB_TARGET_CPU0_CPU0SEREGISTERINFO_H</span>

<span class="c1">#include &quot;Cpu0Config.h&quot;</span>

<span class="c1">#include &quot;Cpu0RegisterInfo.h&quot;</span>

<span class="n">namespace</span> <span class="n">llvm</span> <span class="p">{</span>
<span class="k">class</span> <span class="nc">Cpu0SEInstrInfo</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">Cpu0SERegisterInfo</span> <span class="p">:</span> <span class="n">public</span> <span class="n">Cpu0RegisterInfo</span> <span class="p">{</span>
<span class="n">public</span><span class="p">:</span>
  <span class="n">Cpu0SERegisterInfo</span><span class="p">(</span><span class="n">const</span> <span class="n">Cpu0Subtarget</span> <span class="o">&amp;</span><span class="n">Subtarget</span><span class="p">);</span>

  <span class="n">const</span> <span class="n">TargetRegisterClass</span> <span class="o">*</span><span class="n">intRegClass</span><span class="p">(</span><span class="n">unsigned</span> <span class="n">Size</span><span class="p">)</span> <span class="n">const</span> <span class="n">override</span><span class="p">;</span>
<span class="p">};</span>

<span class="p">}</span> <span class="o">//</span> <span class="n">end</span> <span class="n">namespace</span> <span class="n">llvm</span>

<span class="c1">#endif</span>

</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter3_1/Cpu0SERegisterInfo.cpp</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">//===--</span> <span class="n">Cpu0SERegisterInfo</span><span class="o">.</span><span class="n">cpp</span> <span class="o">-</span> <span class="n">CPU0</span> <span class="n">Register</span> <span class="n">Information</span> <span class="o">------==</span> <span class="o">-------===//</span>
<span class="o">//</span>
<span class="o">//</span>                     <span class="n">The</span> <span class="n">LLVM</span> <span class="n">Compiler</span> <span class="n">Infrastructure</span>
<span class="o">//</span>
<span class="o">//</span> <span class="n">This</span> <span class="n">file</span> <span class="ow">is</span> <span class="n">distributed</span> <span class="n">under</span> <span class="n">the</span> <span class="n">University</span> <span class="n">of</span> <span class="n">Illinois</span> <span class="n">Open</span> <span class="n">Source</span>
<span class="o">//</span> <span class="n">License</span><span class="o">.</span> <span class="n">See</span> <span class="n">LICENSE</span><span class="o">.</span><span class="n">TXT</span> <span class="k">for</span> <span class="n">details</span><span class="o">.</span>
<span class="o">//</span>
<span class="o">//===----------------------------------------------------------------------===//</span>
<span class="o">//</span>
<span class="o">//</span> <span class="n">This</span> <span class="n">file</span> <span class="n">contains</span> <span class="n">the</span> <span class="n">CPU0</span> <span class="n">implementation</span> <span class="n">of</span> <span class="n">the</span> <span class="n">TargetRegisterInfo</span>
<span class="o">//</span> <span class="n">class</span><span class="o">.</span>
<span class="o">//</span>
<span class="o">//===----------------------------------------------------------------------===//</span>

<span class="c1">#include &quot;Cpu0SERegisterInfo.h&quot;</span>

<span class="n">using</span> <span class="n">namespace</span> <span class="n">llvm</span><span class="p">;</span>

<span class="c1">#define DEBUG_TYPE &quot;cpu0-reg-info&quot;</span>

<span class="n">Cpu0SERegisterInfo</span><span class="p">::</span><span class="n">Cpu0SERegisterInfo</span><span class="p">(</span><span class="n">const</span> <span class="n">Cpu0Subtarget</span> <span class="o">&amp;</span><span class="n">ST</span><span class="p">)</span>
  <span class="p">:</span> <span class="n">Cpu0RegisterInfo</span><span class="p">(</span><span class="n">ST</span><span class="p">)</span> <span class="p">{}</span>

<span class="n">const</span> <span class="n">TargetRegisterClass</span> <span class="o">*</span>
<span class="n">Cpu0SERegisterInfo</span><span class="p">::</span><span class="n">intRegClass</span><span class="p">(</span><span class="n">unsigned</span> <span class="n">Size</span><span class="p">)</span> <span class="n">const</span> <span class="p">{</span>
  <span class="k">return</span> <span class="o">&amp;</span><span class="n">Cpu0</span><span class="p">::</span><span class="n">CPURegsRegClass</span><span class="p">;</span>
<span class="p">}</span>

</pre></div>
</div>
<p class="rubric">cmake_debug_build/lib/Target/Cpu0/Cpu0GenInstInfo.inc</p>
<div class="highlight-c++"><div class="highlight"><pre><span></span><span class="c1">//- Cpu0GenInstInfo.inc which generate from Cpu0InstrInfo.td</span>
<span class="cp">#ifdef GET_INSTRINFO_HEADER</span>
<span class="cp">#undef GET_INSTRINFO_HEADER</span>
<span class="k">namespace</span> <span class="n">llvm</span> <span class="p">{</span>
<span class="k">struct</span> <span class="nl">Cpu0GenInstrInfo</span> <span class="p">:</span> <span class="k">public</span> <span class="n">TargetInstrInfoImpl</span> <span class="p">{</span>
  <span class="k">explicit</span> <span class="n">Cpu0GenInstrInfo</span><span class="p">(</span><span class="kt">int</span> <span class="n">SO</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="kt">int</span> <span class="n">DO</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
<span class="p">};</span>
<span class="p">}</span> <span class="c1">// End llvm namespace</span>
<span class="cp">#endif </span><span class="c1">// GET_INSTRINFO_HEADER</span>

<span class="cp">#define GET_INSTRINFO_HEADER</span>
<span class="cp">#include</span> <span class="cpf">&quot;Cpu0GenInstrInfo.inc&quot;</span><span class="cp"></span>
<span class="c1">//- Cpu0InstInfo.h</span>
<span class="k">class</span> <span class="nc">Cpu0InstrInfo</span> <span class="o">:</span> <span class="k">public</span> <span class="n">Cpu0GenInstrInfo</span> <span class="p">{</span>
  <span class="n">Cpu0TargetMachine</span> <span class="o">&amp;</span><span class="n">TM</span><span class="p">;</span>
<span class="k">public</span><span class="o">:</span>
  <span class="k">explicit</span> <span class="n">Cpu0InstrInfo</span><span class="p">(</span><span class="n">Cpu0TargetMachine</span> <span class="o">&amp;</span><span class="n">TM</span><span class="p">);</span>
<span class="p">};</span>
</pre></div>
</div>
<div class="figure align-center" id="id4">
<span id="backendstructure-f1"></span><img alt="_images/1.png" src="_images/1.png" />
<p class="caption"><span class="caption-number">Fig. 14 </span><span class="caption-text">Cpu0 backend class access link</span></p>
</div>
<p>Chapter3_1 add most Cpu0 backend classes. The code of Chapter3_1 can be
summaried as <a class="reference internal" href="#backendstructure-f1"><span class="std std-numref">Fig. 14</span></a>.
Class Cpu0Subtarget provides the interfaces getInstrInfo(), getFrameLowering(),
..., to get other Cpu0 classes.
Most classes (like Cpu0InstrInfo, Cpu0RegisterInfo, ...) have Subtarget
reference member to allowing them access other classes through the Cpu0Subtarget
interface.
If the backend module hasn&#8217;t the Subtarget reference, these classes still can
access Subtarget class through Cpu0TargetMachine (usually use TM as
symbol) by static_cast&lt;Cpu0TargetMachine &amp;&gt;(TM).getSubtargetImpl().
Once getting Subtarget class, the backend code can access other classes through
it.
For those name of Cpu0SExx classes, they mean the standard 32 bits class.
This arrangement follows llvm 3.5 Mips backend style. Mips backend uses
Mips16, MipsSE and Mips64 files/classes name to define classes for 16,
32 and 64 bits architecture, respectively.
Since Cpu0Subtarget creates Cpu0InstrInfo, Cpu0RegisterInfo, ..., at constuctor
function, it can provide the class reference through the interfaces shown in
<a class="reference internal" href="#backendstructure-f1"><span class="std std-numref">Fig. 14</span></a>.</p>
<p>Below <a class="reference internal" href="#backendstructure-f2"><span class="std std-numref">Fig. 15</span></a> shows Cpu0 TableGen inheritance
relationship.
Last chapter mentioned that backend class can include the TableGen generated
classes and inherited from it.
All the TableGen generated classes of Cpu0 backend are in
cmake_debug_build/lib/Target/Cpu0/*.inc. Through C++ inheritance mechanism,
TableGen provides backend programmers a fexible way to use its generated
code. Programmers have chance to override this function if they need to.</p>
<div class="figure align-center" id="id5">
<span id="backendstructure-f2"></span><img alt="_images/2.png" src="_images/2.png" />
<p class="caption"><span class="caption-number">Fig. 15 </span><span class="caption-text">Cpu0 classes inherited from TableGen generated files</span></p>
</div>
<p>Since llvm has deep inheritance tree, they are not digged here.
Benefit from the inheritance tree structure, not much code needed
to be implemented in classes of instruction, frame/stack and select DAG, since
much code are implemented by their parent classes.
The llvm-tblgen generate Cpu0GenInstrInfo.inc based on information from
Cpu0InstrInfo.td.
Cpu0InstrInfo.h extract those code it needs from Cpu0GenInstrInfo.inc by define
“#define GET_INSTRINFO_HEADER”.
With TabelGen, the code size in backend is reduced again through the pattern
match theory of compiler developemnt. This is explained in both sections
of &#8220;DAG&#8221; and &#8220;Instruction Selection&#8221; in last chapter.
Following is the code fragment from Cpu0GenInstrInfo.inc.
Code between &#8220;#if def  GET_INSTRINFO_HEADER&#8221; and
&#8220;#endif // GET_INSTRINFO_HEADER”&#8221; will be extracted to Cpu0InstrInfo.h.</p>
<p class="rubric">cmake_debug_build/lib/Target/Cpu0/Cpu0GenInstInfo.inc</p>
<div class="highlight-c++"><div class="highlight"><pre><span></span><span class="c1">//- Cpu0GenInstInfo.inc which generate from Cpu0InstrInfo.td</span>
<span class="cp">#ifdef GET_INSTRINFO_HEADER</span>
<span class="cp">#undef GET_INSTRINFO_HEADER</span>
<span class="k">namespace</span> <span class="n">llvm</span> <span class="p">{</span>
<span class="k">struct</span> <span class="nl">Cpu0GenInstrInfo</span> <span class="p">:</span> <span class="k">public</span> <span class="n">TargetInstrInfoImpl</span> <span class="p">{</span>
  <span class="k">explicit</span> <span class="n">Cpu0GenInstrInfo</span><span class="p">(</span><span class="kt">int</span> <span class="n">SO</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="kt">int</span> <span class="n">DO</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
<span class="p">};</span>
<span class="p">}</span> <span class="c1">// End llvm namespace</span>
<span class="cp">#endif </span><span class="c1">// GET_INSTRINFO_HEADER</span>
</pre></div>
</div>
<p>Reference web sites are here <a class="footnote-reference" href="#targetmachine" id="id1">[1]</a> <a class="footnote-reference" href="#datalayout" id="id2">[2]</a>.</p>
<p>Chapter3_1/CMakeLists.txt is modified with these new added *.cpp as follows,</p>
<p class="rubric">lbdex/chapters/Chapter3_1/CMakeLists.txt</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">tablegen</span><span class="p">(</span><span class="n">LLVM</span> <span class="n">Cpu0GenDAGISel</span><span class="o">.</span><span class="n">inc</span> <span class="o">-</span><span class="n">gen</span><span class="o">-</span><span class="n">dag</span><span class="o">-</span><span class="n">isel</span><span class="p">)</span>
<span class="n">tablegen</span><span class="p">(</span><span class="n">LLVM</span> <span class="n">Cpu0GenCallingConv</span><span class="o">.</span><span class="n">inc</span> <span class="o">-</span><span class="n">gen</span><span class="o">-</span><span class="n">callingconv</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span>  <span class="n">Cpu0FrameLowering</span><span class="o">.</span><span class="n">cpp</span>
</pre></div>
</div>
<p>Please take a look for Chapter3_1 code.
After that, building Chapter3_1 by <strong>&#8220;#define CH  CH3_1&#8221;</strong> in Cpu0Config.h as
follows, and do building with Xcode on iMac or make on linux again.</p>
<p class="rubric">~/llvm/test/src/lib/Target/Cpu0SetChapter.h</p>
<div class="highlight-c++"><div class="highlight"><pre><span></span><span class="cp">#define CH       CH3_1</span>
</pre></div>
</div>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">118-165-78-230:input Jonathan$</span> /Users/Jonathan/llvm/test/cmake_debug_build/
<span class="go">Debug/bin/llc -march=cpu0 -relocation-model=pic -filetype=asm ch3.bc -o</span>
<span class="go">ch3.cpu0.s</span>
<span class="go">... Assertion `AsmInfo &amp;&amp; &quot;MCAsmInfo not initialized. &quot;</span>
<span class="go">...</span>
</pre></div>
</div>
<p>With Chapter3_1 implementation, the Chapter2 error message
&#8220;Could not allocate target machine!&#8221; has gone.
The new error say that we have not Target AsmPrinter.
We will add it in next section.</p>
<p>Chapter3_1 create FeatureCpu032I and FeatureCpu032II for CPU cpu032I and
cpu032II, repectively.
Beyond that, it defines two more features, FeatureCmp and FeatureSlt.
In order to demostrate the &#8220;instruction set designing choice&#8221; to readers, this
book creates two CPU.
Readers will realize why Mips CPU uses instruction SLT instead of
CMP after they have read later Chapter &#8220;Control flow statement&#8221;.
With the added code of supporting cpu032I and cpu32II in Cpu0.td and
Cpu0InstrInfo.td of Chapter3_1, the command <code class="docutils literal"><span class="pre">llc</span> <span class="pre">-march=cpu0</span> <span class="pre">-mcpu=help</span></code> can
display messages as follows,</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">JonathantekiiMac:input Jonathan$</span> /Users/Jonathan/llvm/test/
<span class="go">cmake_debug_build/Debug/bin/llc -march=cpu0 -mcpu=help</span>
<span class="go">Available CPUs for this target:</span>

<span class="go">  cpu032I  - Select the cpu032I processor.</span>
<span class="go">  cpu032II - Select the cpu032II processor.</span>

<span class="go">Available features for this target:</span>

<span class="go">  ch10_1   - Enable Chapter instructions..</span>
<span class="go">  ch11_1   - Enable Chapter instructions..</span>
<span class="go">  ch11_2   - Enable Chapter instructions..</span>
<span class="go">  ch14_1   - Enable Chapter instructions..</span>
<span class="go">  ch3_1    - Enable Chapter instructions..</span>
<span class="go">  ch3_2    - Enable Chapter instructions..</span>
<span class="go">  ch3_3    - Enable Chapter instructions..</span>
<span class="go">  ch3_4    - Enable Chapter instructions..</span>
<span class="go">  ch3_5    - Enable Chapter instructions..</span>
<span class="go">  ch4_1    - Enable Chapter instructions..</span>
<span class="go">  ch4_2    - Enable Chapter instructions..</span>
<span class="go">  ch5_1    - Enable Chapter instructions..</span>
<span class="go">  ch6_1    - Enable Chapter instructions..</span>
<span class="go">  ch7_1    - Enable Chapter instructions..</span>
<span class="go">  ch8_1    - Enable Chapter instructions..</span>
<span class="go">  ch8_2    - Enable Chapter instructions..</span>
<span class="go">  ch9_1    - Enable Chapter instructions..</span>
<span class="go">  ch9_2    - Enable Chapter instructions..</span>
<span class="go">  ch9_3    - Enable Chapter instructions..</span>
<span class="go">  chall    - Enable Chapter instructions..</span>
<span class="go">  cmp      - Enable &#39;cmp&#39; instructions..</span>
<span class="go">  cpu032I  - Cpu032I ISA Support.</span>
<span class="go">  cpu032II - Cpu032II ISA Support (slt).</span>
<span class="go">  o32      - Enable o32 ABI.</span>
<span class="go">  s32      - Enable s32 ABI.</span>
<span class="go">  slt      - Enable &#39;slt&#39; instructions..</span>

<span class="go">Use +feature to enable a feature, or -feature to disable it.</span>
<span class="go">For example, llc -mcpu=mycpu -mattr=+feature1,-feature2</span>
<span class="go">...</span>
</pre></div>
</div>
<p>When user input <code class="docutils literal"><span class="pre">-mcpu=cpu032I</span></code>, the variable IsCpu032I from Cpu0InstrInfo.td
will be true since the function isCpu032I() defined in Cpu0Subtarget.h is
true (set Cpu0ArchVersion to cpu032I in initializeSubtargetDependencies() called
in constructor function, the variable CPU in constructor function is &#8220;cpu032I&#8221;
when user input -mcpu=cpu032I).
Please notice variable Cpu0ArchVersion must be initialized in
Cpu0Subtarget.cpp, otherwise variable Cpu0ArchVersion can be any value and
functions isCpu032I() and isCpu032II() which support <code class="docutils literal"><span class="pre">llc</span> <span class="pre">-mcpu=cpu032I</span></code> and
<code class="docutils literal"><span class="pre">llc</span> <span class="pre">-mcpu=cpu032II</span></code>, repectively, will have trouble.
The value of variables HasCmp and HasSlt are set depend on Cpu0ArchVersion.
Instructions slt and beq, ... are supported only in case of HasSlt is true, and
furthermore, HasSlt is true only when Cpu0ArchVersion is Cpu032II.
Similiarly, Ch4_1, Ch4_2, ..., are used in controlling the enable or disable of
instruction definition. Through <strong>Subtarget-&gt;hasChapter4_1()</strong> which exists
both in Cpu0.td and Cpu0Subtarget.h, the Predicate, such as Ch4_1, defined in
Cpu0InstrInfo.td can be enabled or disabled. For example, the shift-rotate
instructions can be enabled by define CH to greater than or equal to CH4_1 as
follows,</p>
<p class="rubric">lbdex/Cpu0/Cpu0InstrInfo.td</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>let Predicates = [Ch4_1] in {
class shift_rotate_reg&lt;bits&lt;8&gt; op, bits&lt;4&gt; isRotate, string instr_asm,
                       SDNode OpNode, RegisterClass RC&gt;:
  FA&lt;op, (outs GPROut:$ra), (ins RC:$rb, RC:$rc),
     !strconcat(instr_asm, &quot;\t$ra, $rb, $rc&quot;),
     [(set GPROut:$ra, (OpNode RC:$rb, RC:$rc))], IIAlu&gt; {
  let shamt = 0;
}
}
</pre></div>
</div>
<p class="rubric">~/llvm/test/src/lib/Target/Cpu0SetChapter.h</p>
<div class="highlight-c++"><div class="highlight"><pre><span></span><span class="cp">#define CH       CH4_1</span>
</pre></div>
</div>
<p>On the contrary, it can be disabled by define it to less than CH4_1, for
instance CH3_5, as follows,</p>
<p class="rubric">~/llvm/test/src/lib/Target/Cpu0SetChapter.h</p>
<div class="highlight-c++"><div class="highlight"><pre><span></span><span class="cp">#define CH       CH3_5</span>
</pre></div>
</div>
</div>
<div class="section" id="add-asmprinter">
<h2><a class="toc-backref" href="#id15">Add AsmPrinter</a><a class="headerlink" href="#add-asmprinter" title="Permalink to this headline">¶</a></h2>
<p>Chapter3_2/ contains the Cpu0AsmPrinter definition.</p>
<p class="rubric">lbdex/chapters/Chapter2/Cpu0.td</p>
<div class="highlight-c++"><div class="highlight"><pre><span></span><span class="n">def</span> <span class="nl">Cpu0InstrInfo</span> <span class="p">:</span> <span class="n">InstrInfo</span><span class="p">;</span>

<span class="c1">// Will generate Cpu0GenAsmWrite.inc included by Cpu0InstPrinter.cpp, contents</span>
<span class="c1">//  as follows,</span>
<span class="c1">// void Cpu0InstPrinter::printInstruction(const MCInst *MI, raw_ostream &amp;O) {...}</span>
<span class="c1">// const char *Cpu0InstPrinter::getRegisterName(unsigned RegNo) {...}</span>
<span class="n">def</span> <span class="nl">Cpu0</span> <span class="p">:</span> <span class="n">Target</span> <span class="p">{</span>
<span class="c1">// def Cpu0InstrInfo : InstrInfo as before.</span>
  <span class="n">let</span> <span class="n">InstructionSet</span> <span class="o">=</span> <span class="n">Cpu0InstrInfo</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>As above comments of Chapter2/Cpu0.td indicate, it will generate
Cpu0GenAsmWrite.inc which is included by Cpu0InstPrinter.cpp as follows,</p>
<p class="rubric">lbdex/chapters/Chapter3_2/InstPrinter/Cpu0InstPrinter.h</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">//===</span> <span class="n">Cpu0InstPrinter</span><span class="o">.</span><span class="n">h</span> <span class="o">-</span> <span class="n">Convert</span> <span class="n">Cpu0</span> <span class="n">MCInst</span> <span class="n">to</span> <span class="n">assembly</span> <span class="n">syntax</span> <span class="o">-*-</span> <span class="n">C</span><span class="o">++</span> <span class="o">-*-==//</span>
<span class="o">//</span>
<span class="o">//</span>                     <span class="n">The</span> <span class="n">LLVM</span> <span class="n">Compiler</span> <span class="n">Infrastructure</span>
<span class="o">//</span>
<span class="o">//</span> <span class="n">This</span> <span class="n">file</span> <span class="ow">is</span> <span class="n">distributed</span> <span class="n">under</span> <span class="n">the</span> <span class="n">University</span> <span class="n">of</span> <span class="n">Illinois</span> <span class="n">Open</span> <span class="n">Source</span>
<span class="o">//</span> <span class="n">License</span><span class="o">.</span> <span class="n">See</span> <span class="n">LICENSE</span><span class="o">.</span><span class="n">TXT</span> <span class="k">for</span> <span class="n">details</span><span class="o">.</span>
<span class="o">//</span>
<span class="o">//===----------------------------------------------------------------------===//</span>
<span class="o">//</span>
<span class="o">//</span> <span class="n">This</span> <span class="k">class</span> <span class="nc">prints</span> <span class="n">a</span> <span class="n">Cpu0</span> <span class="n">MCInst</span> <span class="n">to</span> <span class="n">a</span> <span class="o">.</span><span class="n">s</span> <span class="n">file</span><span class="o">.</span>
<span class="o">//</span>
<span class="o">//===----------------------------------------------------------------------===//</span>

<span class="c1">#ifndef LLVM_LIB_TARGET_CPU0_INSTPRINTER_CPU0INSTPRINTER_H</span>
<span class="c1">#define LLVM_LIB_TARGET_CPU0_INSTPRINTER_CPU0INSTPRINTER_H</span>

<span class="c1">#include &quot;Cpu0Config.h&quot;</span>

<span class="c1">#include &quot;llvm/MC/MCInstPrinter.h&quot;</span>

<span class="n">namespace</span> <span class="n">llvm</span> <span class="p">{</span>
<span class="o">//</span> <span class="n">These</span> <span class="n">enumeration</span> <span class="n">declarations</span> <span class="n">were</span> <span class="n">orignally</span> <span class="ow">in</span> <span class="n">Cpu0InstrInfo</span><span class="o">.</span><span class="n">h</span> <span class="n">but</span>
<span class="o">//</span> <span class="n">had</span> <span class="n">to</span> <span class="n">be</span> <span class="n">moved</span> <span class="n">here</span> <span class="n">to</span> <span class="n">avoid</span> <span class="n">circular</span> <span class="n">dependencies</span> <span class="n">between</span>
<span class="o">//</span> <span class="n">LLVMCpu0CodeGen</span> <span class="ow">and</span> <span class="n">LLVMCpu0AsmPrinter</span><span class="o">.</span>

<span class="k">class</span> <span class="nc">TargetMachine</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">Cpu0InstPrinter</span> <span class="p">:</span> <span class="n">public</span> <span class="n">MCInstPrinter</span> <span class="p">{</span>
<span class="n">public</span><span class="p">:</span>
  <span class="n">Cpu0InstPrinter</span><span class="p">(</span><span class="n">const</span> <span class="n">MCAsmInfo</span> <span class="o">&amp;</span><span class="n">MAI</span><span class="p">,</span> <span class="n">const</span> <span class="n">MCInstrInfo</span> <span class="o">&amp;</span><span class="n">MII</span><span class="p">,</span>
                  <span class="n">const</span> <span class="n">MCRegisterInfo</span> <span class="o">&amp;</span><span class="n">MRI</span><span class="p">)</span>
    <span class="p">:</span> <span class="n">MCInstPrinter</span><span class="p">(</span><span class="n">MAI</span><span class="p">,</span> <span class="n">MII</span><span class="p">,</span> <span class="n">MRI</span><span class="p">)</span> <span class="p">{}</span>

  <span class="o">//</span> <span class="n">Autogenerated</span> <span class="n">by</span> <span class="n">tblgen</span><span class="o">.</span>
  <span class="n">void</span> <span class="n">printInstruction</span><span class="p">(</span><span class="n">const</span> <span class="n">MCInst</span> <span class="o">*</span><span class="n">MI</span><span class="p">,</span> <span class="n">raw_ostream</span> <span class="o">&amp;</span><span class="n">O</span><span class="p">);</span>
  <span class="n">static</span> <span class="n">const</span> <span class="n">char</span> <span class="o">*</span><span class="n">getRegisterName</span><span class="p">(</span><span class="n">unsigned</span> <span class="n">RegNo</span><span class="p">);</span>

  <span class="n">void</span> <span class="n">printRegName</span><span class="p">(</span><span class="n">raw_ostream</span> <span class="o">&amp;</span><span class="n">OS</span><span class="p">,</span> <span class="n">unsigned</span> <span class="n">RegNo</span><span class="p">)</span> <span class="n">const</span> <span class="n">override</span><span class="p">;</span>
  <span class="n">void</span> <span class="n">printInst</span><span class="p">(</span><span class="n">const</span> <span class="n">MCInst</span> <span class="o">*</span><span class="n">MI</span><span class="p">,</span> <span class="n">raw_ostream</span> <span class="o">&amp;</span><span class="n">O</span><span class="p">,</span> <span class="n">StringRef</span> <span class="n">Annot</span><span class="p">,</span>
                 <span class="n">const</span> <span class="n">MCSubtargetInfo</span> <span class="o">&amp;</span><span class="n">STI</span><span class="p">)</span> <span class="n">override</span><span class="p">;</span>

  <span class="nb">bool</span> <span class="n">printAliasInstr</span><span class="p">(</span><span class="n">const</span> <span class="n">MCInst</span> <span class="o">*</span><span class="n">MI</span><span class="p">,</span> <span class="n">raw_ostream</span> <span class="o">&amp;</span><span class="n">OS</span><span class="p">);</span>
  <span class="n">void</span> <span class="n">printCustomAliasOperand</span><span class="p">(</span><span class="n">const</span> <span class="n">MCInst</span> <span class="o">*</span><span class="n">MI</span><span class="p">,</span> <span class="n">unsigned</span> <span class="n">OpIdx</span><span class="p">,</span>
                               <span class="n">unsigned</span> <span class="n">PrintMethodIdx</span><span class="p">,</span> <span class="n">raw_ostream</span> <span class="o">&amp;</span><span class="n">O</span><span class="p">);</span>

<span class="n">private</span><span class="p">:</span>
  <span class="n">void</span> <span class="n">printOperand</span><span class="p">(</span><span class="n">const</span> <span class="n">MCInst</span> <span class="o">*</span><span class="n">MI</span><span class="p">,</span> <span class="n">unsigned</span> <span class="n">OpNo</span><span class="p">,</span> <span class="n">raw_ostream</span> <span class="o">&amp;</span><span class="n">O</span><span class="p">);</span>
  <span class="n">void</span> <span class="n">printUnsignedImm</span><span class="p">(</span><span class="n">const</span> <span class="n">MCInst</span> <span class="o">*</span><span class="n">MI</span><span class="p">,</span> <span class="nb">int</span> <span class="n">opNum</span><span class="p">,</span> <span class="n">raw_ostream</span> <span class="o">&amp;</span><span class="n">O</span><span class="p">);</span>
  <span class="n">void</span> <span class="n">printMemOperand</span><span class="p">(</span><span class="n">const</span> <span class="n">MCInst</span> <span class="o">*</span><span class="n">MI</span><span class="p">,</span> <span class="nb">int</span> <span class="n">opNum</span><span class="p">,</span> <span class="n">raw_ostream</span> <span class="o">&amp;</span><span class="n">O</span><span class="p">);</span>
<span class="o">//</span><span class="c1">#if CH &gt;= CH7_1</span>
  <span class="n">void</span> <span class="n">printMemOperandEA</span><span class="p">(</span><span class="n">const</span> <span class="n">MCInst</span> <span class="o">*</span><span class="n">MI</span><span class="p">,</span> <span class="nb">int</span> <span class="n">opNum</span><span class="p">,</span> <span class="n">raw_ostream</span> <span class="o">&amp;</span><span class="n">O</span><span class="p">);</span>
<span class="o">//</span><span class="c1">#endif</span>
<span class="p">};</span>
<span class="p">}</span> <span class="o">//</span> <span class="n">end</span> <span class="n">namespace</span> <span class="n">llvm</span>

<span class="c1">#endif</span>

</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter3_2/InstPrinter/Cpu0InstPrinter.cpp</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>//===-- Cpu0InstPrinter.cpp - Convert Cpu0 MCInst to assembly syntax ------===//
//
//                     The LLVM Compiler Infrastructure
//
// This file is distributed under the University of Illinois Open Source
// License. See LICENSE.TXT for details.
//
//===----------------------------------------------------------------------===//
//
// This class prints an Cpu0 MCInst to a .s file.
//
//===----------------------------------------------------------------------===//

#include &quot;Cpu0InstPrinter.h&quot;

#include &quot;Cpu0InstrInfo.h&quot;
#include &quot;llvm/ADT/StringExtras.h&quot;
#include &quot;llvm/MC/MCExpr.h&quot;
#include &quot;llvm/MC/MCInst.h&quot;
#include &quot;llvm/MC/MCInstrInfo.h&quot;
#include &quot;llvm/MC/MCSymbol.h&quot;
#include &quot;llvm/Support/ErrorHandling.h&quot;
#include &quot;llvm/Support/raw_ostream.h&quot;
using namespace llvm;

#define DEBUG_TYPE &quot;asm-printer&quot;

#define PRINT_ALIAS_INSTR
#include &quot;Cpu0GenAsmWriter.inc&quot;

void Cpu0InstPrinter::printRegName(raw_ostream &amp;OS, unsigned RegNo) const {
//- getRegisterName(RegNo) defined in Cpu0GenAsmWriter.inc indicated in 
//   Cpu0.td.
// RegNo: from Cpu0GenRegisterInfo.inc, such as:
//  FP = 3,
//  ...
//  SP = 9,
// LLVM auto assign RegNo based on Cpu0RegisterInfo.td
//  def FP   : Cpu0GPRReg&lt;12, &quot;fp&quot;&gt;,   DwarfRegNum&lt;[12]&gt;;
//  def SP   : Cpu0GPRReg&lt;13, &quot;sp&quot;&gt;,   DwarfRegNum&lt;[13]&gt;;
  OS &lt;&lt; &#39;$&#39; &lt;&lt; StringRef(getRegisterName(RegNo)).lower();
}

//@1 {
void Cpu0InstPrinter::printInst(const MCInst *MI, raw_ostream &amp;O,
                                StringRef Annot, const MCSubtargetInfo &amp;STI) {
  // Try to print any aliases first.
  if (!printAliasInstr(MI, O))
//@1 }
    //- printInstruction(MI, O) defined in Cpu0GenAsmWriter.inc which came from 
    //   Cpu0.td indicate.
    printInstruction(MI, O);
  printAnnotation(O, Annot);
}

void Cpu0InstPrinter::printOperand(const MCInst *MI, unsigned OpNo,
                                   raw_ostream &amp;O) {
  const MCOperand &amp;Op = MI-&gt;getOperand(OpNo);
  if (Op.isReg()) {
    printRegName(O, Op.getReg());
    return;
  }

  if (Op.isImm()) {
    O &lt;&lt; Op.getImm();
    return;
  }

  assert(Op.isExpr() &amp;&amp; &quot;unknown operand kind in printOperand&quot;);
  Op.getExpr()-&gt;print(O, &amp;MAI, true);
}

void Cpu0InstPrinter::printUnsignedImm(const MCInst *MI, int opNum,
                                       raw_ostream &amp;O) {
  const MCOperand &amp;MO = MI-&gt;getOperand(opNum);
  if (MO.isImm())
    O &lt;&lt; (unsigned short int)MO.getImm();
  else
    printOperand(MI, opNum, O);
}

void Cpu0InstPrinter::
printMemOperand(const MCInst *MI, int opNum, raw_ostream &amp;O) {
  // Load/Store memory operands -- imm($reg)
  // If PIC target the target is loaded as the
  // pattern ld $t9,%call16($gp)
  printOperand(MI, opNum+1, O);
  O &lt;&lt; &quot;(&quot;;
  printOperand(MI, opNum, O);
  O &lt;&lt; &quot;)&quot;;
}

//#if CH &gt;= CH7_1
// The DAG data node, mem_ea of Cpu0InstrInfo.td, cannot be disabled by
// ch7_1, only opcode node can be disabled.
void Cpu0InstPrinter::
printMemOperandEA(const MCInst *MI, int opNum, raw_ostream &amp;O) {
  // when using stack locations for not load/store instructions
  // print the same way as all normal 3 operand instructions.
  printOperand(MI, opNum, O);
  O &lt;&lt; &quot;, &quot;;
  printOperand(MI, opNum+1, O);
  return;
}
//#endif

</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter3_2/InstPrinter/CMakeLists.txt</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">add_llvm_library</span><span class="p">(</span><span class="n">LLVMCpu0AsmPrinter</span>
  <span class="n">Cpu0InstPrinter</span><span class="o">.</span><span class="n">cpp</span>
  <span class="p">)</span>

</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter3_2/InstPrinter/LLVMBuild.txt</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="p">;</span><span class="o">===-</span> <span class="o">./</span><span class="n">lib</span><span class="o">/</span><span class="n">Target</span><span class="o">/</span><span class="n">Cpu0</span><span class="o">/</span><span class="n">InstPrinter</span><span class="o">/</span><span class="n">LLVMBuild</span><span class="o">.</span><span class="n">txt</span> <span class="o">--------------*-</span> <span class="n">Conf</span> <span class="o">-*--===</span><span class="p">;</span>
<span class="p">;</span>
<span class="p">;</span>                     <span class="n">The</span> <span class="n">LLVM</span> <span class="n">Compiler</span> <span class="n">Infrastructure</span>
<span class="p">;</span>
<span class="p">;</span> <span class="n">This</span> <span class="n">file</span> <span class="ow">is</span> <span class="n">distributed</span> <span class="n">under</span> <span class="n">the</span> <span class="n">University</span> <span class="n">of</span> <span class="n">Illinois</span> <span class="n">Open</span> <span class="n">Source</span>
<span class="p">;</span> <span class="n">License</span><span class="o">.</span> <span class="n">See</span> <span class="n">LICENSE</span><span class="o">.</span><span class="n">TXT</span> <span class="k">for</span> <span class="n">details</span><span class="o">.</span>
<span class="p">;</span>
<span class="p">;</span><span class="o">===------------------------------------------------------------------------===</span><span class="p">;</span>
<span class="p">;</span>
<span class="p">;</span> <span class="n">This</span> <span class="ow">is</span> <span class="n">an</span> <span class="n">LLVMBuild</span> <span class="n">description</span> <span class="n">file</span> <span class="k">for</span> <span class="n">the</span> <span class="n">components</span> <span class="ow">in</span> <span class="n">this</span> <span class="n">subdirectory</span><span class="o">.</span>
<span class="p">;</span>
<span class="p">;</span> <span class="n">For</span> <span class="n">more</span> <span class="n">information</span> <span class="n">on</span> <span class="n">the</span> <span class="n">LLVMBuild</span> <span class="n">system</span><span class="p">,</span> <span class="n">please</span> <span class="n">see</span><span class="p">:</span>
<span class="p">;</span>
<span class="p">;</span>   <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">llvm</span><span class="o">.</span><span class="n">org</span><span class="o">/</span><span class="n">docs</span><span class="o">/</span><span class="n">LLVMBuild</span><span class="o">.</span><span class="n">html</span>
<span class="p">;</span>
<span class="p">;</span><span class="o">===------------------------------------------------------------------------===</span><span class="p">;</span>

<span class="p">[</span><span class="n">component_0</span><span class="p">]</span>
<span class="nb">type</span> <span class="o">=</span> <span class="n">Library</span>
<span class="n">name</span> <span class="o">=</span> <span class="n">Cpu0AsmPrinter</span>
<span class="n">parent</span> <span class="o">=</span> <span class="n">Cpu0</span>
<span class="n">required_libraries</span> <span class="o">=</span> <span class="n">MC</span> <span class="n">Support</span>
<span class="n">add_to_library_groups</span> <span class="o">=</span> <span class="n">Cpu0</span>

</pre></div>
</div>
<p>Cpu0GenAsmWrite.inc has the implementations of
Cpu0InstPrinter::printInstruction() and Cpu0InstPrinter::getRegisterName().
Both of these functions can be auto-generated from the information we defined
in Cpu0InstrInfo.td and Cpu0RegisterInfo.td.
To let these two functions work in our code, the only thing needed is adding a
class Cpu0InstPrinter and include them as did in Chapter3_2.</p>
<p>File Chapter3_2/Cpu0/InstPrinter/Cpu0InstPrinter.cpp include Cpu0GenAsmWrite.inc
and call the auto-generated functions from TableGen.</p>
<p>Function Cpu0InstPrinter::printMemOperand() defined in
Chapter3_2/InstPrinter/Cpu0InstPrinter.cpp as above.
It will be triggered since Cpu0InstrInfo.td
defined <strong>&#8216;let PrintMethod = &#8220;printMemOperand&#8221;;&#8217;</strong> as follows,</p>
<p class="rubric">lbdex/chapters/Chapter2/Cpu0InstrInfo.td</p>
<div class="code c++ highlight-default"><div class="highlight"><pre><span></span>// Address operand
def mem : Operand&lt;i32&gt; {
  let PrintMethod = &quot;printMemOperand&quot;;
  let MIOperandInfo = (ops CPURegs, simm16);
  let EncoderMethod = &quot;getMemEncoding&quot;;
}
...
// 32-bit load.
multiclass LoadM32&lt;bits&lt;8&gt; op, string instr_asm, PatFrag OpNode,
                   bit Pseudo = 0&gt; {
  def #NAME# : LoadM&lt;op, instr_asm, OpNode, GPROut, mem, Pseudo&gt;;
}

// 32-bit store.
multiclass StoreM32&lt;bits&lt;8&gt; op, string instr_asm, PatFrag OpNode,
                    bit Pseudo = 0&gt; {
  def #NAME# : StoreM&lt;op, instr_asm, OpNode, CPURegs, mem, Pseudo&gt;;
}

defm LD     : LoadM32&lt;0x01,  &quot;ld&quot;,  load_a&gt;;
defm ST     : StoreM32&lt;0x02, &quot;st&quot;,  store_a&gt;;
</pre></div>
</div>
<p>Cpu0InstPrinter::printMemOperand() will print backend operands for &#8220;local
variable access&#8221;, which is like the following,</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="go">ld    $2, 16($fp)</span>
<span class="go">st    $2, 8($fp)</span>
</pre></div>
</div>
<p>Next, add Cpu0MCInstLower (Cpu0MCInstLower.h, Cpu0MCInstLower.cpp) as well as
Cpu0BaseInfo.h,
Cpu0FixupKinds.h and Cpu0MCAsmInfo (Cpu0MCAsmInfo.h, Cpu0MCAsmInfo.cpp) in
sub-directory MCTargetDesc as follows,</p>
<p class="rubric">lbdex/chapters/Chapter3_2/Cpu0MCInstLower.h</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">//===--</span> <span class="n">Cpu0MCInstLower</span><span class="o">.</span><span class="n">h</span> <span class="o">-</span> <span class="n">Lower</span> <span class="n">MachineInstr</span> <span class="n">to</span> <span class="n">MCInst</span> <span class="o">-------*-</span> <span class="n">C</span><span class="o">++</span> <span class="o">-*--===//</span>
<span class="o">//</span>
<span class="o">//</span>                     <span class="n">The</span> <span class="n">LLVM</span> <span class="n">Compiler</span> <span class="n">Infrastructure</span>
<span class="o">//</span>
<span class="o">//</span> <span class="n">This</span> <span class="n">file</span> <span class="ow">is</span> <span class="n">distributed</span> <span class="n">under</span> <span class="n">the</span> <span class="n">University</span> <span class="n">of</span> <span class="n">Illinois</span> <span class="n">Open</span> <span class="n">Source</span>
<span class="o">//</span> <span class="n">License</span><span class="o">.</span> <span class="n">See</span> <span class="n">LICENSE</span><span class="o">.</span><span class="n">TXT</span> <span class="k">for</span> <span class="n">details</span><span class="o">.</span>
<span class="o">//</span>
<span class="o">//===----------------------------------------------------------------------===//</span>

<span class="c1">#ifndef LLVM_LIB_TARGET_CPU0_CPU0MCINSTLOWER_H</span>
<span class="c1">#define LLVM_LIB_TARGET_CPU0_CPU0MCINSTLOWER_H</span>

<span class="c1">#include &quot;Cpu0Config.h&quot;</span>

<span class="c1">#include &quot;llvm/ADT/SmallVector.h&quot;</span>
<span class="c1">#include &quot;llvm/CodeGen/MachineOperand.h&quot;</span>
<span class="c1">#include &quot;llvm/Support/Compiler.h&quot;</span>

<span class="n">namespace</span> <span class="n">llvm</span> <span class="p">{</span>
  <span class="k">class</span> <span class="nc">MCContext</span><span class="p">;</span>
  <span class="k">class</span> <span class="nc">MCInst</span><span class="p">;</span>
  <span class="k">class</span> <span class="nc">MCOperand</span><span class="p">;</span>
  <span class="k">class</span> <span class="nc">MachineInstr</span><span class="p">;</span>
  <span class="k">class</span> <span class="nc">MachineFunction</span><span class="p">;</span>
  <span class="k">class</span> <span class="nc">Cpu0AsmPrinter</span><span class="p">;</span>

<span class="o">//</span><span class="nd">@1</span> <span class="p">{</span>
<span class="o">///</span> <span class="n">This</span> <span class="k">class</span> <span class="nc">is</span> <span class="n">used</span> <span class="n">to</span> <span class="n">lower</span> <span class="n">an</span> <span class="n">MachineInstr</span> <span class="n">into</span> <span class="n">an</span> <span class="n">MCInst</span><span class="o">.</span>
<span class="k">class</span> <span class="nc">LLVM_LIBRARY_VISIBILITY</span> <span class="n">Cpu0MCInstLower</span> <span class="p">{</span>
<span class="o">//</span><span class="nd">@2</span>
  <span class="n">typedef</span> <span class="n">MachineOperand</span><span class="p">::</span><span class="n">MachineOperandType</span> <span class="n">MachineOperandType</span><span class="p">;</span>
  <span class="n">MCContext</span> <span class="o">*</span><span class="n">Ctx</span><span class="p">;</span>
  <span class="n">Cpu0AsmPrinter</span> <span class="o">&amp;</span><span class="n">AsmPrinter</span><span class="p">;</span>
<span class="n">public</span><span class="p">:</span>
  <span class="n">Cpu0MCInstLower</span><span class="p">(</span><span class="n">Cpu0AsmPrinter</span> <span class="o">&amp;</span><span class="n">asmprinter</span><span class="p">);</span>
  <span class="n">void</span> <span class="n">Initialize</span><span class="p">(</span><span class="n">MCContext</span><span class="o">*</span> <span class="n">C</span><span class="p">);</span>
  <span class="n">void</span> <span class="n">Lower</span><span class="p">(</span><span class="n">const</span> <span class="n">MachineInstr</span> <span class="o">*</span><span class="n">MI</span><span class="p">,</span> <span class="n">MCInst</span> <span class="o">&amp;</span><span class="n">OutMI</span><span class="p">)</span> <span class="n">const</span><span class="p">;</span>
  <span class="n">MCOperand</span> <span class="n">LowerOperand</span><span class="p">(</span><span class="n">const</span> <span class="n">MachineOperand</span><span class="o">&amp;</span> <span class="n">MO</span><span class="p">,</span> <span class="n">unsigned</span> <span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="n">const</span><span class="p">;</span>
<span class="p">};</span>
<span class="p">}</span>

<span class="c1">#endif</span>

</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter3_2/Cpu0MCInstLower.cpp</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">//===--</span> <span class="n">Cpu0MCInstLower</span><span class="o">.</span><span class="n">cpp</span> <span class="o">-</span> <span class="n">Convert</span> <span class="n">Cpu0</span> <span class="n">MachineInstr</span> <span class="n">to</span> <span class="n">MCInst</span> <span class="o">---------===//</span>
<span class="o">//</span>
<span class="o">//</span>                     <span class="n">The</span> <span class="n">LLVM</span> <span class="n">Compiler</span> <span class="n">Infrastructure</span>
<span class="o">//</span>
<span class="o">//</span> <span class="n">This</span> <span class="n">file</span> <span class="ow">is</span> <span class="n">distributed</span> <span class="n">under</span> <span class="n">the</span> <span class="n">University</span> <span class="n">of</span> <span class="n">Illinois</span> <span class="n">Open</span> <span class="n">Source</span>
<span class="o">//</span> <span class="n">License</span><span class="o">.</span> <span class="n">See</span> <span class="n">LICENSE</span><span class="o">.</span><span class="n">TXT</span> <span class="k">for</span> <span class="n">details</span><span class="o">.</span>
<span class="o">//</span>
<span class="o">//===----------------------------------------------------------------------===//</span>
<span class="o">//</span>
<span class="o">//</span> <span class="n">This</span> <span class="n">file</span> <span class="n">contains</span> <span class="n">code</span> <span class="n">to</span> <span class="n">lower</span> <span class="n">Cpu0</span> <span class="n">MachineInstrs</span> <span class="n">to</span> <span class="n">their</span> <span class="n">corresponding</span>
<span class="o">//</span> <span class="n">MCInst</span> <span class="n">records</span><span class="o">.</span>
<span class="o">//</span>
<span class="o">//===----------------------------------------------------------------------===//</span>

<span class="c1">#include &quot;Cpu0MCInstLower.h&quot;</span>

<span class="c1">#include &quot;Cpu0AsmPrinter.h&quot;</span>
<span class="c1">#include &quot;Cpu0InstrInfo.h&quot;</span>
<span class="c1">#include &quot;MCTargetDesc/Cpu0BaseInfo.h&quot;</span>
<span class="c1">#include &quot;llvm/CodeGen/MachineFunction.h&quot;</span>
<span class="c1">#include &quot;llvm/CodeGen/MachineInstr.h&quot;</span>
<span class="c1">#include &quot;llvm/CodeGen/MachineOperand.h&quot;</span>
<span class="c1">#include &quot;llvm/IR/Mangler.h&quot;</span>
<span class="c1">#include &quot;llvm/MC/MCContext.h&quot;</span>
<span class="c1">#include &quot;llvm/MC/MCExpr.h&quot;</span>
<span class="c1">#include &quot;llvm/MC/MCInst.h&quot;</span>

<span class="n">using</span> <span class="n">namespace</span> <span class="n">llvm</span><span class="p">;</span>

<span class="n">Cpu0MCInstLower</span><span class="p">::</span><span class="n">Cpu0MCInstLower</span><span class="p">(</span><span class="n">Cpu0AsmPrinter</span> <span class="o">&amp;</span><span class="n">asmprinter</span><span class="p">)</span>
  <span class="p">:</span> <span class="n">AsmPrinter</span><span class="p">(</span><span class="n">asmprinter</span><span class="p">)</span> <span class="p">{}</span>

<span class="n">void</span> <span class="n">Cpu0MCInstLower</span><span class="p">::</span><span class="n">Initialize</span><span class="p">(</span><span class="n">MCContext</span><span class="o">*</span> <span class="n">C</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">Ctx</span> <span class="o">=</span> <span class="n">C</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">static</span> <span class="n">void</span> <span class="n">CreateMCInst</span><span class="p">(</span><span class="n">MCInst</span><span class="o">&amp;</span> <span class="n">Inst</span><span class="p">,</span> <span class="n">unsigned</span> <span class="n">Opc</span><span class="p">,</span> <span class="n">const</span> <span class="n">MCOperand</span><span class="o">&amp;</span> <span class="n">Opnd0</span><span class="p">,</span>
                         <span class="n">const</span> <span class="n">MCOperand</span><span class="o">&amp;</span> <span class="n">Opnd1</span><span class="p">,</span>
                         <span class="n">const</span> <span class="n">MCOperand</span><span class="o">&amp;</span> <span class="n">Opnd2</span> <span class="o">=</span> <span class="n">MCOperand</span><span class="p">())</span> <span class="p">{</span>
  <span class="n">Inst</span><span class="o">.</span><span class="n">setOpcode</span><span class="p">(</span><span class="n">Opc</span><span class="p">);</span>
  <span class="n">Inst</span><span class="o">.</span><span class="n">addOperand</span><span class="p">(</span><span class="n">Opnd0</span><span class="p">);</span>
  <span class="n">Inst</span><span class="o">.</span><span class="n">addOperand</span><span class="p">(</span><span class="n">Opnd1</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">Opnd2</span><span class="o">.</span><span class="n">isValid</span><span class="p">())</span>
    <span class="n">Inst</span><span class="o">.</span><span class="n">addOperand</span><span class="p">(</span><span class="n">Opnd2</span><span class="p">);</span>
<span class="p">}</span>

<span class="o">//</span><span class="nd">@LowerOperand</span> <span class="p">{</span>
<span class="n">MCOperand</span> <span class="n">Cpu0MCInstLower</span><span class="p">::</span><span class="n">LowerOperand</span><span class="p">(</span><span class="n">const</span> <span class="n">MachineOperand</span><span class="o">&amp;</span> <span class="n">MO</span><span class="p">,</span>
                                        <span class="n">unsigned</span> <span class="n">offset</span><span class="p">)</span> <span class="n">const</span> <span class="p">{</span>
  <span class="n">MachineOperandType</span> <span class="n">MOTy</span> <span class="o">=</span> <span class="n">MO</span><span class="o">.</span><span class="n">getType</span><span class="p">();</span>

  <span class="n">switch</span> <span class="p">(</span><span class="n">MOTy</span><span class="p">)</span> <span class="p">{</span>
  <span class="o">//</span><span class="nd">@2</span>
  <span class="n">default</span><span class="p">:</span> <span class="n">llvm_unreachable</span><span class="p">(</span><span class="s2">&quot;unknown operand type&quot;</span><span class="p">);</span>
  <span class="n">case</span> <span class="n">MachineOperand</span><span class="p">::</span><span class="n">MO_Register</span><span class="p">:</span>
    <span class="o">//</span> <span class="n">Ignore</span> <span class="nb">all</span> <span class="n">implicit</span> <span class="n">register</span> <span class="n">operands</span><span class="o">.</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">MO</span><span class="o">.</span><span class="n">isImplicit</span><span class="p">())</span> <span class="k">break</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">MCOperand</span><span class="p">::</span><span class="n">createReg</span><span class="p">(</span><span class="n">MO</span><span class="o">.</span><span class="n">getReg</span><span class="p">());</span>
  <span class="n">case</span> <span class="n">MachineOperand</span><span class="p">::</span><span class="n">MO_Immediate</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">MCOperand</span><span class="p">::</span><span class="n">createImm</span><span class="p">(</span><span class="n">MO</span><span class="o">.</span><span class="n">getImm</span><span class="p">()</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>
  <span class="n">case</span> <span class="n">MachineOperand</span><span class="p">::</span><span class="n">MO_RegisterMask</span><span class="p">:</span>
    <span class="k">break</span><span class="p">;</span>
 <span class="p">}</span>

  <span class="k">return</span> <span class="n">MCOperand</span><span class="p">();</span>
<span class="p">}</span>

<span class="n">void</span> <span class="n">Cpu0MCInstLower</span><span class="p">::</span><span class="n">Lower</span><span class="p">(</span><span class="n">const</span> <span class="n">MachineInstr</span> <span class="o">*</span><span class="n">MI</span><span class="p">,</span> <span class="n">MCInst</span> <span class="o">&amp;</span><span class="n">OutMI</span><span class="p">)</span> <span class="n">const</span> <span class="p">{</span>
  <span class="n">OutMI</span><span class="o">.</span><span class="n">setOpcode</span><span class="p">(</span><span class="n">MI</span><span class="o">-&gt;</span><span class="n">getOpcode</span><span class="p">());</span>

  <span class="k">for</span> <span class="p">(</span><span class="n">unsigned</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">e</span> <span class="o">=</span> <span class="n">MI</span><span class="o">-&gt;</span><span class="n">getNumOperands</span><span class="p">();</span> <span class="n">i</span> <span class="o">!=</span> <span class="n">e</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">const</span> <span class="n">MachineOperand</span> <span class="o">&amp;</span><span class="n">MO</span> <span class="o">=</span> <span class="n">MI</span><span class="o">-&gt;</span><span class="n">getOperand</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
    <span class="n">MCOperand</span> <span class="n">MCOp</span> <span class="o">=</span> <span class="n">LowerOperand</span><span class="p">(</span><span class="n">MO</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">MCOp</span><span class="o">.</span><span class="n">isValid</span><span class="p">())</span>
      <span class="n">OutMI</span><span class="o">.</span><span class="n">addOperand</span><span class="p">(</span><span class="n">MCOp</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>

</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter3_2/MCTargetDesc/Cpu0BaseInfo.h</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">//===--</span> <span class="n">Cpu0BaseInfo</span><span class="o">.</span><span class="n">h</span> <span class="o">-</span> <span class="n">Top</span> <span class="n">level</span> <span class="n">definitions</span> <span class="k">for</span> <span class="n">CPU0</span> <span class="n">MC</span> <span class="o">------*-</span> <span class="n">C</span><span class="o">++</span> <span class="o">-*-===//</span>
<span class="o">//</span>
<span class="o">//</span>                     <span class="n">The</span> <span class="n">LLVM</span> <span class="n">Compiler</span> <span class="n">Infrastructure</span>
<span class="o">//</span>
<span class="o">//</span> <span class="n">This</span> <span class="n">file</span> <span class="ow">is</span> <span class="n">distributed</span> <span class="n">under</span> <span class="n">the</span> <span class="n">University</span> <span class="n">of</span> <span class="n">Illinois</span> <span class="n">Open</span> <span class="n">Source</span>
<span class="o">//</span> <span class="n">License</span><span class="o">.</span> <span class="n">See</span> <span class="n">LICENSE</span><span class="o">.</span><span class="n">TXT</span> <span class="k">for</span> <span class="n">details</span><span class="o">.</span>
<span class="o">//</span>
<span class="o">//===----------------------------------------------------------------------===//</span>
<span class="o">//</span>
<span class="o">//</span> <span class="n">This</span> <span class="n">file</span> <span class="n">contains</span> <span class="n">small</span> <span class="n">standalone</span> <span class="n">helper</span> <span class="n">functions</span> <span class="ow">and</span> <span class="n">enum</span> <span class="n">definitions</span> <span class="k">for</span>
<span class="o">//</span> <span class="n">the</span> <span class="n">Cpu0</span> <span class="n">target</span> <span class="n">useful</span> <span class="k">for</span> <span class="n">the</span> <span class="n">compiler</span> <span class="n">back</span><span class="o">-</span><span class="n">end</span> <span class="ow">and</span> <span class="n">the</span> <span class="n">MC</span> <span class="n">libraries</span><span class="o">.</span>
<span class="o">//</span>
<span class="o">//===----------------------------------------------------------------------===//</span>
<span class="c1">#ifndef LLVM_LIB_TARGET_CPU0_MCTARGETDESC_CPU0BASEINFO_H</span>
<span class="c1">#define LLVM_LIB_TARGET_CPU0_MCTARGETDESC_CPU0BASEINFO_H</span>

<span class="c1">#include &quot;Cpu0Config.h&quot;</span>

<span class="c1">#include &quot;Cpu0MCTargetDesc.h&quot;</span>
<span class="c1">#include &quot;llvm/MC/MCExpr.h&quot;</span>
<span class="c1">#include &quot;llvm/Support/DataTypes.h&quot;</span>
<span class="c1">#include &quot;llvm/Support/ErrorHandling.h&quot;</span>

<span class="n">namespace</span> <span class="n">llvm</span> <span class="p">{</span>

<span class="o">///</span> <span class="n">Cpu0II</span> <span class="o">-</span> <span class="n">This</span> <span class="n">namespace</span> <span class="n">holds</span> <span class="nb">all</span> <span class="n">of</span> <span class="n">the</span> <span class="n">target</span> <span class="n">specific</span> <span class="n">flags</span> <span class="n">that</span>
<span class="o">///</span> <span class="n">instruction</span> <span class="n">info</span> <span class="n">tracks</span><span class="o">.</span>
<span class="o">//</span><span class="nd">@Cpu0II</span>
<span class="n">namespace</span> <span class="n">Cpu0II</span> <span class="p">{</span>
  <span class="o">///</span> <span class="n">Target</span> <span class="n">Operand</span> <span class="n">Flag</span> <span class="n">enum</span><span class="o">.</span>
  <span class="n">enum</span> <span class="n">TOF</span> <span class="p">{</span>
    <span class="o">//===------------------------------------------------------------------===//</span>
    <span class="o">//</span> <span class="n">Cpu0</span> <span class="n">Specific</span> <span class="n">MachineOperand</span> <span class="n">flags</span><span class="o">.</span>

    <span class="n">MO_NO_FLAG</span><span class="p">,</span>

    <span class="o">///</span> <span class="n">MO_GOT_CALL</span> <span class="o">-</span> <span class="n">Represents</span> <span class="n">the</span> <span class="n">offset</span> <span class="n">into</span> <span class="n">the</span> <span class="k">global</span> <span class="n">offset</span> <span class="n">table</span> <span class="n">at</span>
    <span class="o">///</span> <span class="n">which</span> <span class="n">the</span> <span class="n">address</span> <span class="n">of</span> <span class="n">a</span> <span class="n">call</span> <span class="n">site</span> <span class="n">relocation</span> <span class="n">entry</span> <span class="n">symbol</span> <span class="n">resides</span>
    <span class="o">///</span> <span class="n">during</span> <span class="n">execution</span><span class="o">.</span> <span class="n">This</span> <span class="ow">is</span> <span class="n">different</span> <span class="kn">from</span> <span class="nn">the</span> <span class="n">above</span> <span class="n">since</span> <span class="n">this</span> <span class="n">flag</span>
    <span class="o">///</span> <span class="n">can</span> <span class="n">only</span> <span class="n">be</span> <span class="n">present</span> <span class="ow">in</span> <span class="n">call</span> <span class="n">instructions</span><span class="o">.</span>
    <span class="n">MO_GOT_CALL</span><span class="p">,</span>

    <span class="o">///</span> <span class="n">MO_GPREL</span> <span class="o">-</span> <span class="n">Represents</span> <span class="n">the</span> <span class="n">offset</span> <span class="kn">from</span> <span class="nn">the</span> <span class="n">current</span> <span class="n">gp</span> <span class="n">value</span> <span class="n">to</span> <span class="n">be</span> <span class="n">used</span>
    <span class="o">///</span> <span class="k">for</span> <span class="n">the</span> <span class="n">relocatable</span> <span class="nb">object</span> <span class="n">file</span> <span class="n">being</span> <span class="n">produced</span><span class="o">.</span>
    <span class="n">MO_GPREL</span><span class="p">,</span>

    <span class="o">///</span> <span class="n">MO_ABS_HI</span><span class="o">/</span><span class="n">LO</span> <span class="o">-</span> <span class="n">Represents</span> <span class="n">the</span> <span class="n">hi</span> <span class="ow">or</span> <span class="n">low</span> <span class="n">part</span> <span class="n">of</span> <span class="n">an</span> <span class="n">absolute</span> <span class="n">symbol</span>
    <span class="o">///</span> <span class="n">address</span><span class="o">.</span>
    <span class="n">MO_ABS_HI</span><span class="p">,</span>
    <span class="n">MO_ABS_LO</span><span class="p">,</span>

    <span class="o">///</span> <span class="n">MO_GOT_HI16</span><span class="o">/</span><span class="n">LO16</span> <span class="o">-</span> <span class="n">Relocations</span> <span class="n">used</span> <span class="k">for</span> <span class="n">large</span> <span class="n">GOTs</span><span class="o">.</span>
    <span class="n">MO_GOT_HI16</span><span class="p">,</span>
    <span class="n">MO_GOT_LO16</span>
  <span class="p">};</span> <span class="o">//</span> <span class="n">enum</span> <span class="n">TOF</span> <span class="p">{</span>

  <span class="n">enum</span> <span class="p">{</span>
    <span class="o">//===------------------------------------------------------------------===//</span>
    <span class="o">//</span> <span class="n">Instruction</span> <span class="n">encodings</span><span class="o">.</span>  <span class="n">These</span> <span class="n">are</span> <span class="n">the</span> <span class="n">standard</span><span class="o">/</span><span class="n">most</span> <span class="n">common</span> <span class="n">forms</span> <span class="k">for</span>
    <span class="o">//</span> <span class="n">Cpu0</span> <span class="n">instructions</span><span class="o">.</span>
    <span class="o">//</span>

    <span class="o">//</span> <span class="n">Pseudo</span> <span class="o">-</span> <span class="n">This</span> <span class="n">represents</span> <span class="n">an</span> <span class="n">instruction</span> <span class="n">that</span> <span class="ow">is</span> <span class="n">a</span> <span class="n">pseudo</span> <span class="n">instruction</span>
    <span class="o">//</span> <span class="ow">or</span> <span class="n">one</span> <span class="n">that</span> <span class="n">has</span> <span class="ow">not</span> <span class="n">been</span> <span class="n">implemented</span> <span class="n">yet</span><span class="o">.</span>  <span class="n">It</span> <span class="ow">is</span> <span class="n">illegal</span> <span class="n">to</span> <span class="n">code</span> <span class="n">generate</span>
    <span class="o">//</span> <span class="n">it</span><span class="p">,</span> <span class="n">but</span> <span class="n">tolerated</span> <span class="k">for</span> <span class="n">intermediate</span> <span class="n">implementation</span> <span class="n">stages</span><span class="o">.</span>
    <span class="n">Pseudo</span>   <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>

    <span class="o">///</span> <span class="n">FrmR</span> <span class="o">-</span> <span class="n">This</span> <span class="n">form</span> <span class="ow">is</span> <span class="k">for</span> <span class="n">instructions</span> <span class="n">of</span> <span class="n">the</span> <span class="nb">format</span> <span class="n">R</span><span class="o">.</span>
    <span class="n">FrmR</span>  <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="o">///</span> <span class="n">FrmI</span> <span class="o">-</span> <span class="n">This</span> <span class="n">form</span> <span class="ow">is</span> <span class="k">for</span> <span class="n">instructions</span> <span class="n">of</span> <span class="n">the</span> <span class="nb">format</span> <span class="n">I</span><span class="o">.</span>
    <span class="n">FrmI</span>  <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
    <span class="o">///</span> <span class="n">FrmJ</span> <span class="o">-</span> <span class="n">This</span> <span class="n">form</span> <span class="ow">is</span> <span class="k">for</span> <span class="n">instructions</span> <span class="n">of</span> <span class="n">the</span> <span class="nb">format</span> <span class="n">J</span><span class="o">.</span>
    <span class="n">FrmJ</span>  <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
    <span class="o">///</span> <span class="n">FrmOther</span> <span class="o">-</span> <span class="n">This</span> <span class="n">form</span> <span class="ow">is</span> <span class="k">for</span> <span class="n">instructions</span> <span class="n">that</span> <span class="n">have</span> <span class="n">no</span> <span class="n">specific</span> <span class="nb">format</span><span class="o">.</span>
    <span class="n">FrmOther</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>

    <span class="n">FormMask</span> <span class="o">=</span> <span class="mi">15</span>
  <span class="p">};</span>
<span class="p">}</span>

<span class="p">}</span>

<span class="c1">#endif</span>

</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter3_2/Cpu0MCAsmInfo.h</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">//===--</span> <span class="n">Cpu0MCAsmInfo</span><span class="o">.</span><span class="n">h</span> <span class="o">-</span> <span class="n">Cpu0</span> <span class="n">Asm</span> <span class="n">Info</span> <span class="o">------------------------*-</span> <span class="n">C</span><span class="o">++</span> <span class="o">-*--===//</span>
<span class="o">//</span>
<span class="o">//</span>                     <span class="n">The</span> <span class="n">LLVM</span> <span class="n">Compiler</span> <span class="n">Infrastructure</span>
<span class="o">//</span>
<span class="o">//</span> <span class="n">This</span> <span class="n">file</span> <span class="ow">is</span> <span class="n">distributed</span> <span class="n">under</span> <span class="n">the</span> <span class="n">University</span> <span class="n">of</span> <span class="n">Illinois</span> <span class="n">Open</span> <span class="n">Source</span>
<span class="o">//</span> <span class="n">License</span><span class="o">.</span> <span class="n">See</span> <span class="n">LICENSE</span><span class="o">.</span><span class="n">TXT</span> <span class="k">for</span> <span class="n">details</span><span class="o">.</span>
<span class="o">//</span>
<span class="o">//===----------------------------------------------------------------------===//</span>
<span class="o">//</span>
<span class="o">//</span> <span class="n">This</span> <span class="n">file</span> <span class="n">contains</span> <span class="n">the</span> <span class="n">declaration</span> <span class="n">of</span> <span class="n">the</span> <span class="n">Cpu0MCAsmInfo</span> <span class="n">class</span><span class="o">.</span>
<span class="o">//</span>
<span class="o">//===----------------------------------------------------------------------===//</span>

<span class="c1">#ifndef LLVM_LIB_TARGET_CPU0_MCTARGETDESC_CPU0MCASMINFO_H</span>
<span class="c1">#define LLVM_LIB_TARGET_CPU0_MCTARGETDESC_CPU0MCASMINFO_H</span>

<span class="c1">#include &quot;Cpu0Config.h&quot;</span>
<span class="c1">#if CH &gt;= CH3_2</span>

<span class="c1">#include &quot;llvm/MC/MCAsmInfoELF.h&quot;</span>

<span class="n">namespace</span> <span class="n">llvm</span> <span class="p">{</span>
  <span class="k">class</span> <span class="nc">Triple</span><span class="p">;</span>

  <span class="k">class</span> <span class="nc">Cpu0MCAsmInfo</span> <span class="p">:</span> <span class="n">public</span> <span class="n">MCAsmInfoELF</span> <span class="p">{</span>
    <span class="n">void</span> <span class="n">anchor</span><span class="p">()</span> <span class="n">override</span><span class="p">;</span>
  <span class="n">public</span><span class="p">:</span>
    <span class="n">explicit</span> <span class="n">Cpu0MCAsmInfo</span><span class="p">(</span><span class="n">const</span> <span class="n">Triple</span> <span class="o">&amp;</span><span class="n">TheTriple</span><span class="p">);</span>
  <span class="p">};</span>

<span class="p">}</span> <span class="o">//</span> <span class="n">namespace</span> <span class="n">llvm</span>

<span class="c1">#endif // #if CH &gt;= CH3_2</span>

<span class="c1">#endif</span>
</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter3_2/Cpu0MCAsmInfo.cpp</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>//===-- Cpu0MCAsmInfo.cpp - Cpu0 Asm Properties ---------------------------===//
//
//                     The LLVM Compiler Infrastructure
//
// This file is distributed under the University of Illinois Open Source
// License. See LICENSE.TXT for details.
//
//===----------------------------------------------------------------------===//
//
// This file contains the declarations of the Cpu0MCAsmInfo properties.
//
//===----------------------------------------------------------------------===//

#include &quot;Cpu0MCAsmInfo.h&quot;
#if CH &gt;= CH3_2

#include &quot;llvm/ADT/Triple.h&quot;

using namespace llvm;

void Cpu0MCAsmInfo::anchor() { }

Cpu0MCAsmInfo::Cpu0MCAsmInfo(const Triple &amp;TheTriple) {
  if ((TheTriple.getArch() == Triple::cpu0))
    IsLittleEndian = false; // the default of IsLittleEndian is true

  AlignmentIsInBytes          = false;
  Data16bitsDirective         = &quot;\t.2byte\t&quot;;
  Data32bitsDirective         = &quot;\t.4byte\t&quot;;
  Data64bitsDirective         = &quot;\t.8byte\t&quot;;
  PrivateGlobalPrefix         = &quot;$&quot;;
// PrivateLabelPrefix: display $BB for the labels of basic block
  PrivateLabelPrefix          = &quot;$&quot;;
  CommentString               = &quot;#&quot;;
  ZeroDirective               = &quot;\t.space\t&quot;;
  GPRel32Directive            = &quot;\t.gpword\t&quot;;
  GPRel64Directive            = &quot;\t.gpdword\t&quot;;
  WeakRefDirective            = &quot;\t.weak\t&quot;;
  UseAssignmentForEHBegin = true;

  SupportsDebugInformation = true;
  ExceptionsType = ExceptionHandling::DwarfCFI;
  DwarfRegNumForCFI = true;
}

#endif // #if CH &gt;= CH3_2
</pre></div>
</div>
<p>Finally, add code in Cpu0MCTargetDesc.cpp to register Cpu0InstPrinter as
below. It also registers other classes (register, instruction and
subtarget) which defined in Chapter3_1 at this point.</p>
<p class="rubric">lbdex/chapters/Chapter3_2/MCTargetDesc/Cpu0MCTargetDesc.h</p>
<div class="highlight-c++"><div class="highlight"><pre><span></span><span class="k">namespace</span> <span class="n">llvm</span> <span class="p">{</span>
<span class="k">class</span> <span class="nc">MCAsmBackend</span><span class="p">;</span>
<span class="k">class</span> <span class="nc">MCCodeEmitter</span><span class="p">;</span>
<span class="k">class</span> <span class="nc">MCContext</span><span class="p">;</span>
<span class="k">class</span> <span class="nc">MCInstrInfo</span><span class="p">;</span>
<span class="k">class</span> <span class="nc">MCObjectWriter</span><span class="p">;</span>
<span class="k">class</span> <span class="nc">MCRegisterInfo</span><span class="p">;</span>
<span class="k">class</span> <span class="nc">MCSubtargetInfo</span><span class="p">;</span>
<span class="k">class</span> <span class="nc">StringRef</span><span class="p">;</span>
<span class="p">...</span>
<span class="k">class</span> <span class="nc">raw_ostream</span><span class="p">;</span>
<span class="p">...</span>
<span class="p">}</span>
</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter3_2/MCTargetDesc/Cpu0MCTargetDesc.cpp</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="c1">#include &quot;InstPrinter/Cpu0InstPrinter.h&quot;</span>
<span class="c1">#include &quot;Cpu0MCAsmInfo.h&quot;</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span>/// Select the Cpu0 Architecture Feature for the given triple and cpu name.
/// The function will be called at command &#39;llvm-objdump -d&#39; for Cpu0 elf input.
static std::string selectCpu0ArchFeature(const Triple &amp;TT, StringRef CPU) {
  std::string Cpu0ArchFeature;
  if (CPU.empty() || CPU == &quot;generic&quot;) {
    if (TT.getArch() == Triple::cpu0 || TT.getArch() == Triple::cpu0el) {
      if (CPU.empty() || CPU == &quot;cpu032II&quot;) {
        Cpu0ArchFeature = &quot;+cpu032II&quot;;
      }
      else {
        if (CPU == &quot;cpu032I&quot;) {
          Cpu0ArchFeature = &quot;+cpu032I&quot;;
        }
      }
    }
  }
  return Cpu0ArchFeature;
}
//@1 }

static MCInstrInfo *createCpu0MCInstrInfo() {
  MCInstrInfo *X = new MCInstrInfo();
  InitCpu0MCInstrInfo(X); // defined in Cpu0GenInstrInfo.inc
  return X;
}

static MCRegisterInfo *createCpu0MCRegisterInfo(const Triple &amp;TT) {
  MCRegisterInfo *X = new MCRegisterInfo();
  InitCpu0MCRegisterInfo(X, Cpu0::SW); // defined in Cpu0GenRegisterInfo.inc
  return X;
}

static MCSubtargetInfo *createCpu0MCSubtargetInfo(const Triple &amp;TT,
                                                  StringRef CPU, StringRef FS) {
  std::string ArchFS = selectCpu0ArchFeature(TT,CPU);
  if (!FS.empty()) {
    if (!ArchFS.empty())
      ArchFS = ArchFS + &quot;,&quot; + FS.str();
    else
      ArchFS = FS;
  }
  return createCpu0MCSubtargetInfoImpl(TT, CPU, ArchFS);
// createCpu0MCSubtargetInfoImpl defined in Cpu0GenSubtargetInfo.inc
}

static MCAsmInfo *createCpu0MCAsmInfo(const MCRegisterInfo &amp;MRI,
                                      const Triple &amp;TT) {
  MCAsmInfo *MAI = new Cpu0MCAsmInfo(TT);

  unsigned SP = MRI.getDwarfRegNum(Cpu0::SP, true);
  MCCFIInstruction Inst = MCCFIInstruction::createDefCfa(nullptr, SP, 0);
  MAI-&gt;addInitialFrameState(Inst);

  return MAI;
}

static MCInstPrinter *createCpu0MCInstPrinter(const Triple &amp;T,
                                              unsigned SyntaxVariant,
                                              const MCAsmInfo &amp;MAI,
                                              const MCInstrInfo &amp;MII,
                                              const MCRegisterInfo &amp;MRI) {
  return new Cpu0InstPrinter(MAI, MII, MRI);
}

namespace {

class Cpu0MCInstrAnalysis : public MCInstrAnalysis {
public:
  Cpu0MCInstrAnalysis(const MCInstrInfo *Info) : MCInstrAnalysis(Info) {}
};
}

static MCInstrAnalysis *createCpu0MCInstrAnalysis(const MCInstrInfo *Info) {
  return new Cpu0MCInstrAnalysis(Info);
}

//@2 {
extern &quot;C&quot; void LLVMInitializeCpu0TargetMC() {
  for (Target *T : {&amp;TheCpu0Target, &amp;TheCpu0elTarget}) {
    // Register the MC asm info.
    RegisterMCAsmInfoFn X(*T, createCpu0MCAsmInfo);

    // Register the MC instruction info.
    TargetRegistry::RegisterMCInstrInfo(*T, createCpu0MCInstrInfo);

    // Register the MC register info.
    TargetRegistry::RegisterMCRegInfo(*T, createCpu0MCRegisterInfo);

    // Register the MC subtarget info.
    TargetRegistry::RegisterMCSubtargetInfo(*T,
	                                        createCpu0MCSubtargetInfo);
    // Register the MC instruction analyzer.
    TargetRegistry::RegisterMCInstrAnalysis(*T, createCpu0MCInstrAnalysis);
    // Register the MCInstPrinter.
    TargetRegistry::RegisterMCInstPrinter(*T,
	                                      createCpu0MCInstPrinter);
  }

}
//@2 }

</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter3_2/MCTargetDesc/CMakeLists.txt</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>  <span class="n">Cpu0MCAsmInfo</span><span class="o">.</span><span class="n">cpp</span>
</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter3_2/MCTargetDesc/LLVMBuild.txt</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>                     <span class="n">Cpu0AsmPrinter</span> 
</pre></div>
</div>
<p>To make the registration clearly, summary as the following diagram, <a class="reference internal" href="#backendstructure-f3"><span class="std std-numref">Fig. 16</span></a>.</p>
<div class="figure align-center" id="id6">
<span id="backendstructure-f3"></span><img alt="_images/dyn_reg.png" src="_images/dyn_reg.png" />
<p class="caption"><span class="caption-number">Fig. 16 </span><span class="caption-text">Tblgen generate files for Cpu0 backend</span></p>
</div>
<p>Above createCpu0MCAsmInfo() registering the object of class Cpu0MCAsmInfo for
target TheCpu0Target and TheCpu0elTarget.
TheCpu0Target is for big endian and TheCpu0elTarget is for little endian.
Cpu0MCAsmInfo is derived from MCAsmInfo which is an llvm built-in class.
Most code is implemented in it&#8217;s parent, backend reuses those code by
inheritance.</p>
<p>Above createCpu0MCInstrInfo() instancing MCInstrInfo object X, and initialize it
by InitCpu0MCInstrInfo(X).
Since InitCpu0MCInstrInfo(X) is defined in Cpu0GenInstrInfo.inc, this function
will add the information from Cpu0InstrInfo.td we specified.</p>
<p>Above createCpu0MCInstPrinter() instancing Cpu0InstPrinter to take care printing
function for instructions.</p>
<p>Above createCpu0MCRegisterInfo() is similar to &#8220;Register function of MC instruction info&#8221;, but it
initializes the register information specified in Cpu0RegisterInfo.td.
They share some values from instruction/register td description, so
no need to specify them again in Initialize routine if they are consistant with
td description files.</p>
<p>Above createCpu0MCSubtargetInfo() instancing MCSubtargetInfo object and initialize with
Cpu0.td information.</p>
<p>According &#8220;section Target Registration&#8221; <a class="footnote-reference" href="#registration" id="id3">[3]</a>, we can register Cpu0
backend classes at LLVMInitializeCpu0TargetMC() on demand by the dynamic
register mechanism as the above function, LLVMInitializeCpu0TargetMC().</p>
<p>Now, it&#8217;s time to work with AsmPrinter as follows,</p>
<p class="rubric">lbdex/chapters/Chapter3_2/Cpu0AsmPrinter.h</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">//===--</span> <span class="n">Cpu0AsmPrinter</span><span class="o">.</span><span class="n">h</span> <span class="o">-</span> <span class="n">Cpu0</span> <span class="n">LLVM</span> <span class="n">Assembly</span> <span class="n">Printer</span> <span class="o">----------*-</span> <span class="n">C</span><span class="o">++</span> <span class="o">-*--===//</span>
<span class="o">//</span>
<span class="o">//</span>                     <span class="n">The</span> <span class="n">LLVM</span> <span class="n">Compiler</span> <span class="n">Infrastructure</span>
<span class="o">//</span>
<span class="o">//</span> <span class="n">This</span> <span class="n">file</span> <span class="ow">is</span> <span class="n">distributed</span> <span class="n">under</span> <span class="n">the</span> <span class="n">University</span> <span class="n">of</span> <span class="n">Illinois</span> <span class="n">Open</span> <span class="n">Source</span>
<span class="o">//</span> <span class="n">License</span><span class="o">.</span> <span class="n">See</span> <span class="n">LICENSE</span><span class="o">.</span><span class="n">TXT</span> <span class="k">for</span> <span class="n">details</span><span class="o">.</span>
<span class="o">//</span>
<span class="o">//===----------------------------------------------------------------------===//</span>
<span class="o">//</span>
<span class="o">//</span> <span class="n">Cpu0</span> <span class="n">Assembly</span> <span class="n">printer</span> <span class="n">class</span><span class="o">.</span>
<span class="o">//</span>
<span class="o">//===----------------------------------------------------------------------===//</span>

<span class="c1">#ifndef LLVM_LIB_TARGET_CPU0_CPU0ASMPRINTER_H</span>
<span class="c1">#define LLVM_LIB_TARGET_CPU0_CPU0ASMPRINTER_H</span>

<span class="c1">#include &quot;Cpu0Config.h&quot;</span>

<span class="c1">#include &quot;Cpu0MachineFunction.h&quot;</span>
<span class="c1">#include &quot;Cpu0MCInstLower.h&quot;</span>
<span class="c1">#include &quot;Cpu0Subtarget.h&quot;</span>
<span class="c1">#include &quot;Cpu0TargetMachine.h&quot;</span>
<span class="c1">#include &quot;llvm/CodeGen/AsmPrinter.h&quot;</span>
<span class="c1">#include &quot;llvm/MC/MCStreamer.h&quot;</span>
<span class="c1">#include &quot;llvm/Support/Compiler.h&quot;</span>
<span class="c1">#include &quot;llvm/Target/TargetMachine.h&quot;</span>

<span class="n">namespace</span> <span class="n">llvm</span> <span class="p">{</span>
<span class="k">class</span> <span class="nc">MCStreamer</span><span class="p">;</span>
<span class="k">class</span> <span class="nc">MachineInstr</span><span class="p">;</span>
<span class="k">class</span> <span class="nc">MachineBasicBlock</span><span class="p">;</span>
<span class="k">class</span> <span class="nc">Module</span><span class="p">;</span>
<span class="k">class</span> <span class="nc">raw_ostream</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">LLVM_LIBRARY_VISIBILITY</span> <span class="n">Cpu0AsmPrinter</span> <span class="p">:</span> <span class="n">public</span> <span class="n">AsmPrinter</span> <span class="p">{</span>

  <span class="n">void</span> <span class="n">EmitInstrWithMacroNoAT</span><span class="p">(</span><span class="n">const</span> <span class="n">MachineInstr</span> <span class="o">*</span><span class="n">MI</span><span class="p">);</span>

<span class="n">private</span><span class="p">:</span>

  <span class="o">//</span> <span class="n">lowerOperand</span> <span class="o">-</span> <span class="n">Convert</span> <span class="n">a</span> <span class="n">MachineOperand</span> <span class="n">into</span> <span class="n">the</span> <span class="n">equivalent</span> <span class="n">MCOperand</span><span class="o">.</span>
  <span class="nb">bool</span> <span class="n">lowerOperand</span><span class="p">(</span><span class="n">const</span> <span class="n">MachineOperand</span> <span class="o">&amp;</span><span class="n">MO</span><span class="p">,</span> <span class="n">MCOperand</span> <span class="o">&amp;</span><span class="n">MCOp</span><span class="p">);</span>

<span class="n">public</span><span class="p">:</span>

  <span class="n">const</span> <span class="n">Cpu0Subtarget</span> <span class="o">*</span><span class="n">Subtarget</span><span class="p">;</span>
  <span class="n">const</span> <span class="n">Cpu0FunctionInfo</span> <span class="o">*</span><span class="n">Cpu0FI</span><span class="p">;</span>
  <span class="n">Cpu0MCInstLower</span> <span class="n">MCInstLowering</span><span class="p">;</span>

  <span class="n">explicit</span> <span class="n">Cpu0AsmPrinter</span><span class="p">(</span><span class="n">TargetMachine</span> <span class="o">&amp;</span><span class="n">TM</span><span class="p">,</span>
                          <span class="n">std</span><span class="p">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">MCStreamer</span><span class="o">&gt;</span> <span class="n">Streamer</span><span class="p">)</span>
    <span class="p">:</span> <span class="n">AsmPrinter</span><span class="p">(</span><span class="n">TM</span><span class="p">,</span> <span class="n">std</span><span class="p">::</span><span class="n">move</span><span class="p">(</span><span class="n">Streamer</span><span class="p">)),</span> 
      <span class="n">MCInstLowering</span><span class="p">(</span><span class="o">*</span><span class="n">this</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">Subtarget</span> <span class="o">=</span> <span class="n">static_cast</span><span class="o">&lt;</span><span class="n">Cpu0TargetMachine</span> <span class="o">&amp;&gt;</span><span class="p">(</span><span class="n">TM</span><span class="p">)</span><span class="o">.</span><span class="n">getSubtargetImpl</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="n">virtual</span> <span class="n">const</span> <span class="n">char</span> <span class="o">*</span><span class="n">getPassName</span><span class="p">()</span> <span class="n">const</span> <span class="n">override</span> <span class="p">{</span>
    <span class="k">return</span> <span class="s2">&quot;Cpu0 Assembly Printer&quot;</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="n">virtual</span> <span class="nb">bool</span> <span class="n">runOnMachineFunction</span><span class="p">(</span><span class="n">MachineFunction</span> <span class="o">&amp;</span><span class="n">MF</span><span class="p">)</span> <span class="n">override</span><span class="p">;</span>

<span class="o">//-</span> <span class="n">EmitInstruction</span><span class="p">()</span> <span class="n">must</span> <span class="n">exists</span> <span class="ow">or</span> <span class="n">will</span> <span class="n">have</span> <span class="n">run</span> <span class="n">time</span> <span class="n">error</span><span class="o">.</span>
  <span class="n">void</span> <span class="n">EmitInstruction</span><span class="p">(</span><span class="n">const</span> <span class="n">MachineInstr</span> <span class="o">*</span><span class="n">MI</span><span class="p">)</span> <span class="n">override</span><span class="p">;</span>
  <span class="n">void</span> <span class="n">printSavedRegsBitmask</span><span class="p">(</span><span class="n">raw_ostream</span> <span class="o">&amp;</span><span class="n">O</span><span class="p">);</span>
  <span class="n">void</span> <span class="n">printHex32</span><span class="p">(</span><span class="n">unsigned</span> <span class="nb">int</span> <span class="n">Value</span><span class="p">,</span> <span class="n">raw_ostream</span> <span class="o">&amp;</span><span class="n">O</span><span class="p">);</span>
  <span class="n">void</span> <span class="n">emitFrameDirective</span><span class="p">();</span>
  <span class="n">const</span> <span class="n">char</span> <span class="o">*</span><span class="n">getCurrentABIString</span><span class="p">()</span> <span class="n">const</span><span class="p">;</span>
  <span class="n">void</span> <span class="n">EmitFunctionEntryLabel</span><span class="p">()</span> <span class="n">override</span><span class="p">;</span>
  <span class="n">void</span> <span class="n">EmitFunctionBodyStart</span><span class="p">()</span> <span class="n">override</span><span class="p">;</span>
  <span class="n">void</span> <span class="n">EmitFunctionBodyEnd</span><span class="p">()</span> <span class="n">override</span><span class="p">;</span>
  <span class="n">void</span> <span class="n">EmitStartOfAsmFile</span><span class="p">(</span><span class="n">Module</span> <span class="o">&amp;</span><span class="n">M</span><span class="p">)</span> <span class="n">override</span><span class="p">;</span>
  <span class="n">void</span> <span class="n">PrintDebugValueComment</span><span class="p">(</span><span class="n">const</span> <span class="n">MachineInstr</span> <span class="o">*</span><span class="n">MI</span><span class="p">,</span> <span class="n">raw_ostream</span> <span class="o">&amp;</span><span class="n">OS</span><span class="p">);</span>
<span class="p">};</span>
<span class="p">}</span>

<span class="c1">#endif</span>

</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter3_2/Cpu0AsmPrinter.cpp</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>//===-- Cpu0AsmPrinter.cpp - Cpu0 LLVM Assembly Printer -------------------===//
//
//                     The LLVM Compiler Infrastructure
//
// This file is distributed under the University of Illinois Open Source
// License. See LICENSE.TXT for details.
//
//===----------------------------------------------------------------------===//
//
// This file contains a printer that converts from our internal representation
// of machine-dependent LLVM code to GAS-format CPU0 assembly language.
//
//===----------------------------------------------------------------------===//

#include &quot;Cpu0AsmPrinter.h&quot;

#include &quot;InstPrinter/Cpu0InstPrinter.h&quot;
#include &quot;MCTargetDesc/Cpu0BaseInfo.h&quot;
#include &quot;Cpu0.h&quot;
#include &quot;Cpu0InstrInfo.h&quot;
#include &quot;llvm/ADT/SmallString.h&quot;
#include &quot;llvm/ADT/StringExtras.h&quot;
#include &quot;llvm/ADT/Twine.h&quot;
#include &quot;llvm/CodeGen/MachineConstantPool.h&quot;
#include &quot;llvm/CodeGen/MachineFunctionPass.h&quot;
#include &quot;llvm/CodeGen/MachineFrameInfo.h&quot;
#include &quot;llvm/CodeGen/MachineInstr.h&quot;
#include &quot;llvm/CodeGen/MachineMemOperand.h&quot;
#include &quot;llvm/IR/BasicBlock.h&quot;
#include &quot;llvm/IR/Instructions.h&quot;
#include &quot;llvm/IR/Mangler.h&quot;
#include &quot;llvm/MC/MCAsmInfo.h&quot;
#include &quot;llvm/MC/MCInst.h&quot;
#include &quot;llvm/MC/MCStreamer.h&quot;
#include &quot;llvm/MC/MCSymbol.h&quot;
#include &quot;llvm/Support/raw_ostream.h&quot;
#include &quot;llvm/Support/TargetRegistry.h&quot;
#include &quot;llvm/Target/TargetLoweringObjectFile.h&quot;
#include &quot;llvm/Target/TargetOptions.h&quot;

using namespace llvm;

#define DEBUG_TYPE &quot;cpu0-asm-printer&quot;

bool Cpu0AsmPrinter::runOnMachineFunction(MachineFunction &amp;MF) {
  Cpu0FI = MF.getInfo&lt;Cpu0FunctionInfo&gt;();
  AsmPrinter::runOnMachineFunction(MF);
  return true;
}

//@EmitInstruction {
//- EmitInstruction() must exists or will have run time error.
void Cpu0AsmPrinter::EmitInstruction(const MachineInstr *MI) {
//@EmitInstruction body {
  if (MI-&gt;isDebugValue()) {
    SmallString&lt;128&gt; Str;
    raw_svector_ostream OS(Str);

    PrintDebugValueComment(MI, OS);
    return;
  }

  //@print out instruction:
  //  Print out both ordinary instruction and boudle instruction
  MachineBasicBlock::const_instr_iterator I = MI-&gt;getIterator();
  MachineBasicBlock::const_instr_iterator E = MI-&gt;getParent()-&gt;instr_end();

  do {

    if (I-&gt;isPseudo())
      llvm_unreachable(&quot;Pseudo opcode found in EmitInstruction()&quot;);

    MCInst TmpInst0;
    MCInstLowering.Lower(&amp;*I, TmpInst0);
    OutStreamer-&gt;EmitInstruction(TmpInst0, getSubtargetInfo());
  } while ((++I != E) &amp;&amp; I-&gt;isInsideBundle()); // Delay slot check
}
//@EmitInstruction }

//===----------------------------------------------------------------------===//
//
//  Cpu0 Asm Directives
//
//  -- Frame directive &quot;frame Stackpointer, Stacksize, RARegister&quot;
//  Describe the stack frame.
//
//  -- Mask directives &quot;(f)mask  bitmask, offset&quot;
//  Tells the assembler which registers are saved and where.
//  bitmask - contain a little endian bitset indicating which registers are
//            saved on function prologue (e.g. with a 0x80000000 mask, the
//            assembler knows the register 31 (RA) is saved at prologue.
//  offset  - the position before stack pointer subtraction indicating where
//            the first saved register on prologue is located. (e.g. with a
//
//  Consider the following function prologue:
//
//    .frame  $fp,48,$ra
//    .mask   0xc0000000,-8
//       addiu $sp, $sp, -48
//       st $ra, 40($sp)
//       st $fp, 36($sp)
//
//    With a 0xc0000000 mask, the assembler knows the register 31 (RA) and
//    30 (FP) are saved at prologue. As the save order on prologue is from
//    left to right, RA is saved first. A -8 offset means that after the
//    stack pointer subtration, the first register in the mask (RA) will be
//    saved at address 48-8=40.
//
//===----------------------------------------------------------------------===//

//===----------------------------------------------------------------------===//
// Mask directives
//===----------------------------------------------------------------------===//
//	.frame	$sp,8,$lr
//-&gt;	.mask 	0x00000000,0
//	.set	noreorder
//	.set	nomacro

// Create a bitmask with all callee saved registers for CPU or Floating Point
// registers. For CPU registers consider LR, GP and FP for saving if necessary.
void Cpu0AsmPrinter::printSavedRegsBitmask(raw_ostream &amp;O) {
  // CPU and FPU Saved Registers Bitmasks
  unsigned CPUBitmask = 0;
  int CPUTopSavedRegOff;

  // Set the CPU and FPU Bitmasks
  const MachineFrameInfo *MFI = MF-&gt;getFrameInfo();
  const TargetRegisterInfo *TRI = MF-&gt;getSubtarget().getRegisterInfo();
  const std::vector&lt;CalleeSavedInfo&gt; &amp;CSI = MFI-&gt;getCalleeSavedInfo();
  // size of stack area to which FP callee-saved regs are saved.
  unsigned CPURegSize = Cpu0::CPURegsRegClass.getSize();
  unsigned i = 0, e = CSI.size();

  // Set CPU Bitmask.
  for (; i != e; ++i) {
    unsigned Reg = CSI[i].getReg();
    unsigned RegNum = TRI-&gt;getEncodingValue(Reg);
    CPUBitmask |= (1 &lt;&lt; RegNum);
  }

  CPUTopSavedRegOff = CPUBitmask ? -CPURegSize : 0;

  // Print CPUBitmask
  O &lt;&lt; &quot;\t.mask \t&quot;; printHex32(CPUBitmask, O);
  O &lt;&lt; &#39;,&#39; &lt;&lt; CPUTopSavedRegOff &lt;&lt; &#39;\n&#39;;
}

// Print a 32 bit hex number with all numbers.
void Cpu0AsmPrinter::printHex32(unsigned Value, raw_ostream &amp;O) {
  O &lt;&lt; &quot;0x&quot;;
  for (int i = 7; i &gt;= 0; i--)
    O.write_hex((Value &amp; (0xF &lt;&lt; (i*4))) &gt;&gt; (i*4));
}

//===----------------------------------------------------------------------===//
// Frame and Set directives
//===----------------------------------------------------------------------===//
//-&gt;	.frame	$sp,8,$lr
//	.mask 	0x00000000,0
//	.set	noreorder
//	.set	nomacro
/// Frame Directive
void Cpu0AsmPrinter::emitFrameDirective() {
  const TargetRegisterInfo &amp;RI = *MF-&gt;getSubtarget().getRegisterInfo();

  unsigned stackReg  = RI.getFrameRegister(*MF);
  unsigned returnReg = RI.getRARegister();
  unsigned stackSize = MF-&gt;getFrameInfo()-&gt;getStackSize();

  if (OutStreamer-&gt;hasRawTextSupport())
    OutStreamer-&gt;EmitRawText(&quot;\t.frame\t$&quot; +
           StringRef(Cpu0InstPrinter::getRegisterName(stackReg)).lower() +
           &quot;,&quot; + Twine(stackSize) + &quot;,$&quot; +
           StringRef(Cpu0InstPrinter::getRegisterName(returnReg)).lower());
}

/// Emit Set directives.
const char *Cpu0AsmPrinter::getCurrentABIString() const {
  switch (static_cast&lt;Cpu0TargetMachine &amp;&gt;(TM).getABI().GetEnumValue()) {
  case Cpu0ABIInfo::ABI::O32:  return &quot;abiO32&quot;;
  case Cpu0ABIInfo::ABI::S32:  return &quot;abiS32&quot;;
  default: llvm_unreachable(&quot;Unknown Cpu0 ABI&quot;);
  }
}

//		.type	main,@function
//-&gt;		.ent	main                    # @main
//	main:
void Cpu0AsmPrinter::EmitFunctionEntryLabel() {
  if (OutStreamer-&gt;hasRawTextSupport())
    OutStreamer-&gt;EmitRawText(&quot;\t.ent\t&quot; + Twine(CurrentFnSym-&gt;getName()));
  OutStreamer-&gt;EmitLabel(CurrentFnSym);
}

//  .frame  $sp,8,$pc
//  .mask   0x00000000,0
//-&gt;  .set  noreorder
//@-&gt; .set  nomacro
/// EmitFunctionBodyStart - Targets can override this to emit stuff before
/// the first basic block in the function.
void Cpu0AsmPrinter::EmitFunctionBodyStart() {
  MCInstLowering.Initialize(&amp;MF-&gt;getContext());

  emitFrameDirective();

  if (OutStreamer-&gt;hasRawTextSupport()) {
    SmallString&lt;128&gt; Str;
    raw_svector_ostream OS(Str);
    printSavedRegsBitmask(OS);
    OutStreamer-&gt;EmitRawText(OS.str());
    OutStreamer-&gt;EmitRawText(StringRef(&quot;\t.set\tnoreorder&quot;));
    OutStreamer-&gt;EmitRawText(StringRef(&quot;\t.set\tnomacro&quot;));
    if (Cpu0FI-&gt;getEmitNOAT())
      OutStreamer-&gt;EmitRawText(StringRef(&quot;\t.set\tnoat&quot;));
  }
}

//-&gt;	.set	macro
//-&gt;	.set	reorder
//-&gt;	.end	main
/// EmitFunctionBodyEnd - Targets can override this to emit stuff after
/// the last basic block in the function.
void Cpu0AsmPrinter::EmitFunctionBodyEnd() {
  // There are instruction for this macros, but they must
  // always be at the function end, and we can&#39;t emit and
  // break with BB logic.
  if (OutStreamer-&gt;hasRawTextSupport()) {
    if (Cpu0FI-&gt;getEmitNOAT())
      OutStreamer-&gt;EmitRawText(StringRef(&quot;\t.set\tat&quot;));
    OutStreamer-&gt;EmitRawText(StringRef(&quot;\t.set\tmacro&quot;));
    OutStreamer-&gt;EmitRawText(StringRef(&quot;\t.set\treorder&quot;));
    OutStreamer-&gt;EmitRawText(&quot;\t.end\t&quot; + Twine(CurrentFnSym-&gt;getName()));
  }
}

//	.section .mdebug.abi32
//	.previous
void Cpu0AsmPrinter::EmitStartOfAsmFile(Module &amp;M) {
  // FIXME: Use SwitchSection.

  // Tell the assembler which ABI we are using
  if (OutStreamer-&gt;hasRawTextSupport())
    OutStreamer-&gt;EmitRawText(&quot;\t.section .mdebug.&quot; +
                            Twine(getCurrentABIString()));

  // return to previous section
  if (OutStreamer-&gt;hasRawTextSupport())
    OutStreamer-&gt;EmitRawText(StringRef(&quot;\t.previous&quot;));
}

void Cpu0AsmPrinter::PrintDebugValueComment(const MachineInstr *MI,
                                           raw_ostream &amp;OS) {
  // TODO: implement
  OS &lt;&lt; &quot;PrintDebugValueComment()&quot;;
}

// Force static initialization.
extern &quot;C&quot; void LLVMInitializeCpu0AsmPrinter() {
  RegisterAsmPrinter&lt;Cpu0AsmPrinter&gt; X(TheCpu0Target);
  RegisterAsmPrinter&lt;Cpu0AsmPrinter&gt; Y(TheCpu0elTarget);
}

</pre></div>
</div>
<p>When instruction is ready to print, function Cpu0AsmPrinter::EmitInstruction()
will be triggered first. And then it will call OutStreamer.EmitInstruction() to
print OP code and register name according the information from
Cpu0GenInstrInfo.inc and Cpu0GenRegisterInfo.inc both registered at dynamic
register function, LLVMInitializeCpu0TargetMC().
Notice, file Cpu0InstPrinter.cpp only print operand while the OP code
information come from Cpu0InstrInfo.td.</p>
<p>Add the following code to Cpu0ISelLowering.cpp.</p>
<p class="rubric">lbdex/chapters/Chapter3_2/Cpu0ISelLowering.cpp</p>
<div class="highlight-c++"><div class="highlight"><pre><span></span><span class="n">Cpu0TargetLowering</span><span class="o">::</span>
<span class="n">Cpu0TargetLowering</span><span class="p">(</span><span class="n">Cpu0TargetMachine</span> <span class="o">&amp;</span><span class="n">TM</span><span class="p">)</span>
  <span class="o">:</span> <span class="n">TargetLowering</span><span class="p">(</span><span class="n">TM</span><span class="p">,</span> <span class="k">new</span> <span class="n">Cpu0TargetObjectFile</span><span class="p">()),</span>
    <span class="n">Subtarget</span><span class="p">(</span><span class="o">&amp;</span><span class="n">TM</span><span class="p">.</span><span class="n">getSubtarget</span><span class="o">&lt;</span><span class="n">Cpu0Subtarget</span><span class="o">&gt;</span><span class="p">())</span> <span class="p">{</span>

<span class="c1">//- Set .align 2</span>
<span class="c1">// It will emit .align 2 later</span>
  <span class="n">setMinFunctionAlignment</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>

<span class="c1">// must, computeRegisterProperties - Once all of the register classes are</span>
<span class="c1">//  added, this allows us to compute derived properties we expose.</span>
  <span class="n">computeRegisterProperties</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Add the following code to Cpu0MachineFunction.h since the Cpu0AsmPrinter.cpp
will call getEmitNOAT().</p>
<p class="rubric">lbdex/chapters/Chapter3_2/Cpu0MachineFunction.h</p>
<div class="highlight-c++"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Cpu0FunctionInfo</span> <span class="o">:</span> <span class="k">public</span> <span class="n">MachineFunctionInfo</span> <span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
  <span class="n">Cpu0FunctionInfo</span><span class="p">(</span><span class="n">MachineFunction</span><span class="o">&amp;</span> <span class="n">MF</span><span class="p">)</span>
  <span class="o">:</span> <span class="p">...</span>
    <span class="p">,</span> <span class="n">EmitNOAT</span><span class="p">(</span><span class="nb">false</span><span class="p">)</span>
    <span class="p">{}</span>

  <span class="p">...</span>
  <span class="kt">bool</span> <span class="n">getEmitNOAT</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">EmitNOAT</span><span class="p">;</span> <span class="p">}</span>
  <span class="kt">void</span> <span class="n">setEmitNOAT</span><span class="p">()</span> <span class="p">{</span> <span class="n">EmitNOAT</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span> <span class="p">}</span>
<span class="k">private</span><span class="o">:</span>
  <span class="p">...</span>
  <span class="kt">bool</span> <span class="n">EmitNOAT</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>
</div>
<p>Beyond adding these new .cpp files to CMakeLists.txt, please remember to add
subdirectory InstPrinter, enable asmprinter, adding libraries AsmPrinter and
Cpu0AsmPrinter to LLVMBuild.txt as follows,</p>
<p class="rubric">lbdex/chapters/Chapter3_2/CMakeLists.txt</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">tablegen</span><span class="p">(</span><span class="n">LLVM</span> <span class="n">Cpu0GenCodeEmitter</span><span class="o">.</span><span class="n">inc</span> <span class="o">-</span><span class="n">gen</span><span class="o">-</span><span class="n">emitter</span><span class="p">)</span>
<span class="n">tablegen</span><span class="p">(</span><span class="n">LLVM</span> <span class="n">Cpu0GenMCCodeEmitter</span><span class="o">.</span><span class="n">inc</span> <span class="o">-</span><span class="n">gen</span><span class="o">-</span><span class="n">emitter</span><span class="p">)</span>

<span class="n">tablegen</span><span class="p">(</span><span class="n">LLVM</span> <span class="n">Cpu0GenAsmWriter</span><span class="o">.</span><span class="n">inc</span> <span class="o">-</span><span class="n">gen</span><span class="o">-</span><span class="n">asm</span><span class="o">-</span><span class="n">writer</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-c++"><div class="highlight"><pre><span></span><span class="p">...</span>
<span class="n">add_llvm_target</span><span class="p">(</span><span class="n">Cpu0CodeGen</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span>  <span class="n">Cpu0AsmPrinter</span><span class="o">.</span><span class="n">cpp</span>
  <span class="n">Cpu0MCInstLower</span><span class="o">.</span><span class="n">cpp</span>
</pre></div>
</div>
<div class="highlight-c++"><div class="highlight"><pre><span></span>  <span class="p">...</span>
  <span class="p">)</span>
<span class="p">...</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">add_subdirectory</span><span class="p">(</span><span class="n">InstPrinter</span><span class="p">)</span>
</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter3_2/LLVMBuild.txt</p>
<div class="highlight-c++"><div class="highlight"><pre><span></span><span class="c1">//  LLVMBuild.txt</span>
<span class="p">[</span><span class="n">common</span><span class="p">]</span>
<span class="n">subdirectories</span> <span class="o">=</span>
  <span class="n">InstPrinter</span>
  <span class="p">...</span>

<span class="p">[</span><span class="n">component_0</span><span class="p">]</span>
<span class="p">...</span>
<span class="cp"># Please enable asmprinter</span>
<span class="n">has_asmprinter</span> <span class="o">=</span> <span class="mi">1</span>
<span class="p">...</span>

<span class="p">[</span><span class="n">component_1</span><span class="p">]</span>
<span class="n">required_libraries</span> <span class="o">=</span>
                     <span class="n">AsmPrinter</span>
                     <span class="p">...</span>
                     <span class="n">Cpu0AsmPrinter</span>
                     <span class="p">...</span>
</pre></div>
</div>
<p>Now, run Chapter3_2/Cpu0 for AsmPrinter support, will get new error message as
follows,</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">118-165-78-230:input Jonathan$</span> /Users/Jonathan/llvm/test/cmake_debug_build/
<span class="go">Debug/bin/llc -march=cpu0 -relocation-model=pic -filetype=asm ch3.bc -o</span>
<span class="go">ch3.cpu0.s</span>
<span class="go">/Users/Jonathan/llvm/test/cmake_debug_build/Debug/bin/llc: target does not</span>
<span class="go">support generation of this file type!</span>
</pre></div>
</div>
<p>The <code class="docutils literal"><span class="pre">llc</span></code> fails to compile IR code into machine code since we don&#8217;t implement
class Cpu0DAGToDAGISel.</p>
</div>
<div class="section" id="add-cpu0dagtodagisel-class">
<h2><a class="toc-backref" href="#id16">Add Cpu0DAGToDAGISel class</a><a class="headerlink" href="#add-cpu0dagtodagisel-class" title="Permalink to this headline">¶</a></h2>
<p>The IR DAG to machine instruction DAG transformation is introduced in the
previous chapter.
Now, let&#8217;s check what IR DAG nodes the file ch3.bc has. List ch3.ll as follows,</p>
<div class="code c++ highlight-default"><div class="highlight"><pre><span></span><span class="o">//</span> <span class="n">ch3</span><span class="o">.</span><span class="n">ll</span>
<span class="n">define</span> <span class="n">i32</span> <span class="nd">@main</span><span class="p">()</span> <span class="n">nounwind</span> <span class="n">uwtable</span> <span class="p">{</span>
<span class="o">%</span><span class="mi">1</span> <span class="o">=</span> <span class="n">alloca</span> <span class="n">i32</span><span class="p">,</span> <span class="n">align</span> <span class="mi">4</span>
<span class="n">store</span> <span class="n">i32</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i32</span><span class="o">*</span> <span class="o">%</span><span class="mi">1</span>
<span class="n">ret</span> <span class="n">i32</span> <span class="mi">0</span>
<span class="p">}</span>
</pre></div>
</div>
<p>As above, ch3.ll uses the IR DAG node <strong>store</strong>, <strong>ret</strong>.
So, the definitions in Cpu0InstrInfo.td as below is enough.
The ADDiu used for stack adjustment which will be needed in later section
&#8220;Add Prologue/Epilogue functions&#8221; of this chapter.
IR DAG is defined in file  include/llvm/Target/TargetSelectionDAG.td.</p>
<p class="rubric">lbdex/chapters/Chapter2/Cpu0InstrInfo.td</p>
<div class="highlight-c++"><div class="highlight"><pre><span></span><span class="c1">//===----------------------------------------------------------------------===//</span>

<span class="c1">/// Load and Store Instructions</span>
<span class="c1">///  aligned</span>
<span class="n">defm</span> <span class="nl">LD</span>     <span class="p">:</span> <span class="n">LoadM32</span><span class="o">&lt;</span><span class="mh">0x01</span><span class="p">,</span>  <span class="s">&quot;ld&quot;</span><span class="p">,</span>  <span class="n">load_a</span><span class="o">&gt;</span><span class="p">;</span>
<span class="n">defm</span> <span class="nl">ST</span>     <span class="p">:</span> <span class="n">StoreM32</span><span class="o">&lt;</span><span class="mh">0x02</span><span class="p">,</span> <span class="s">&quot;st&quot;</span><span class="p">,</span>  <span class="n">store_a</span><span class="o">&gt;</span><span class="p">;</span>

<span class="c1">/// Arithmetic Instructions (ALU Immediate)</span>
<span class="c1">// IR &quot;add&quot; defined in include/llvm/Target/TargetSelectionDAG.td, line 315 (def add).</span>
<span class="n">def</span> <span class="nl">ADDiu</span>   <span class="p">:</span> <span class="n">ArithLogicI</span><span class="o">&lt;</span><span class="mh">0x09</span><span class="p">,</span> <span class="s">&quot;addiu&quot;</span><span class="p">,</span> <span class="n">add</span><span class="p">,</span> <span class="n">simm16</span><span class="p">,</span> <span class="n">immSExt16</span><span class="p">,</span> <span class="n">CPURegs</span><span class="o">&gt;</span><span class="p">;</span>

<span class="n">let</span> <span class="n">isReturn</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">isTerminator</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">hasDelaySlot</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">isBarrier</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">hasCtrlDep</span><span class="o">=</span><span class="mi">1</span> <span class="n">in</span>
<span class="n">def</span> <span class="nl">RetLR</span> <span class="p">:</span> <span class="n">Cpu0Pseudo</span><span class="o">&lt;</span><span class="p">(</span><span class="n">outs</span><span class="p">),</span> <span class="p">(</span><span class="n">ins</span><span class="p">),</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="p">[(</span><span class="n">Cpu0Ret</span><span class="p">)]</span><span class="o">&gt;</span><span class="p">;</span>

<span class="n">def</span> <span class="nl">RET</span>     <span class="p">:</span> <span class="n">RetBase</span><span class="o">&lt;</span><span class="n">GPROut</span><span class="o">&gt;</span><span class="p">;</span>
</pre></div>
</div>
<p>Add class Cpu0DAGToDAGISel (Cpu0ISelDAGToDAG.cpp) to CMakeLists.txt, and add
the following fragment to Cpu0TargetMachine.cpp,</p>
<p class="rubric">lbdex/chapters/Chapter3_3/CMakeLists.txt</p>
<div class="highlight-c++"><div class="highlight"><pre><span></span><span class="n">add_llvm_target</span><span class="p">(</span>
  <span class="p">...</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span>  <span class="n">Cpu0ISelDAGToDAG</span><span class="o">.</span><span class="n">cpp</span>
  <span class="n">Cpu0SEISelDAGToDAG</span><span class="o">.</span><span class="n">cpp</span>
</pre></div>
</div>
<div class="highlight-c++"><div class="highlight"><pre><span></span>  <span class="p">...</span>
<span class="p">)</span>
</pre></div>
</div>
<p>The following code in Cpu0TargetMachine.cpp will create a pass in instruction
selection stage.</p>
<p class="rubric">lbdex/chapters/Chapter3_3/Cpu0TargetMachine.cpp</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="c1">#include &quot;Cpu0SEISelDAGToDAG.h&quot;</span>
</pre></div>
</div>
<div class="highlight-c++"><div class="highlight"><pre><span></span><span class="p">...</span>
<span class="k">class</span> <span class="nc">Cpu0PassConfig</span> <span class="o">:</span> <span class="k">public</span> <span class="n">TargetPassConfig</span> <span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
  <span class="p">...</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span>  <span class="nb">bool</span> <span class="n">addInstSelector</span><span class="p">()</span> <span class="n">override</span><span class="p">;</span>
</pre></div>
</div>
<div class="highlight-c++"><div class="highlight"><pre><span></span><span class="p">};</span>
<span class="p">...</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">//</span> <span class="n">Install</span> <span class="n">an</span> <span class="n">instruction</span> <span class="n">selector</span> <span class="k">pass</span> <span class="n">using</span>
<span class="o">//</span> <span class="n">the</span> <span class="n">ISelDag</span> <span class="n">to</span> <span class="n">gen</span> <span class="n">Cpu0</span> <span class="n">code</span><span class="o">.</span>
<span class="nb">bool</span> <span class="n">Cpu0PassConfig</span><span class="p">::</span><span class="n">addInstSelector</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">addPass</span><span class="p">(</span><span class="n">createCpu0SEISelDag</span><span class="p">(</span><span class="n">getCpu0TargetMachine</span><span class="p">(),</span> <span class="n">getOptLevel</span><span class="p">()));</span>
  <span class="k">return</span> <span class="n">false</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter3_3/Cpu0ISelDAGToDAG.h</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">//===----</span> <span class="n">Cpu0ISelDAGToDAG</span><span class="o">.</span><span class="n">h</span> <span class="o">-</span> <span class="n">A</span> <span class="n">Dag</span> <span class="n">to</span> <span class="n">Dag</span> <span class="n">Inst</span> <span class="n">Selector</span> <span class="k">for</span> <span class="n">Cpu0</span> <span class="o">--------===//</span>
<span class="o">//</span>
<span class="o">//</span>                     <span class="n">The</span> <span class="n">LLVM</span> <span class="n">Compiler</span> <span class="n">Infrastructure</span>
<span class="o">//</span>
<span class="o">//</span> <span class="n">This</span> <span class="n">file</span> <span class="ow">is</span> <span class="n">distributed</span> <span class="n">under</span> <span class="n">the</span> <span class="n">University</span> <span class="n">of</span> <span class="n">Illinois</span> <span class="n">Open</span> <span class="n">Source</span>
<span class="o">//</span> <span class="n">License</span><span class="o">.</span> <span class="n">See</span> <span class="n">LICENSE</span><span class="o">.</span><span class="n">TXT</span> <span class="k">for</span> <span class="n">details</span><span class="o">.</span>
<span class="o">//</span>
<span class="o">//===----------------------------------------------------------------------===//</span>
<span class="o">//</span>
<span class="o">//</span> <span class="n">This</span> <span class="n">file</span> <span class="n">defines</span> <span class="n">an</span> <span class="n">instruction</span> <span class="n">selector</span> <span class="k">for</span> <span class="n">the</span> <span class="n">CPU0</span> <span class="n">target</span><span class="o">.</span>
<span class="o">//</span>
<span class="o">//===----------------------------------------------------------------------===//</span>

<span class="c1">#ifndef LLVM_LIB_TARGET_CPU0_CPU0ISELDAGTODAG_H</span>
<span class="c1">#define LLVM_LIB_TARGET_CPU0_CPU0ISELDAGTODAG_H</span>

<span class="c1">#include &quot;Cpu0Config.h&quot;</span>

<span class="c1">#include &quot;Cpu0.h&quot;</span>
<span class="c1">#include &quot;Cpu0Subtarget.h&quot;</span>
<span class="c1">#include &quot;Cpu0TargetMachine.h&quot;</span>
<span class="c1">#include &quot;llvm/CodeGen/SelectionDAGISel.h&quot;</span>
<span class="c1">#include &quot;llvm/IR/Type.h&quot;</span>
<span class="c1">#include &quot;llvm/Support/Debug.h&quot;</span>

<span class="o">//===----------------------------------------------------------------------===//</span>
<span class="o">//</span> <span class="n">Instruction</span> <span class="n">Selector</span> <span class="n">Implementation</span>
<span class="o">//===----------------------------------------------------------------------===//</span>

<span class="o">//===----------------------------------------------------------------------===//</span>
<span class="o">//</span> <span class="n">Cpu0DAGToDAGISel</span> <span class="o">-</span> <span class="n">CPU0</span> <span class="n">specific</span> <span class="n">code</span> <span class="n">to</span> <span class="n">select</span> <span class="n">CPU0</span> <span class="n">machine</span>
<span class="o">//</span> <span class="n">instructions</span> <span class="k">for</span> <span class="n">SelectionDAG</span> <span class="n">operations</span><span class="o">.</span>
<span class="o">//===----------------------------------------------------------------------===//</span>
<span class="n">namespace</span> <span class="n">llvm</span> <span class="p">{</span>

<span class="k">class</span> <span class="nc">Cpu0DAGToDAGISel</span> <span class="p">:</span> <span class="n">public</span> <span class="n">SelectionDAGISel</span> <span class="p">{</span>
<span class="n">public</span><span class="p">:</span>
  <span class="n">explicit</span> <span class="n">Cpu0DAGToDAGISel</span><span class="p">(</span><span class="n">Cpu0TargetMachine</span> <span class="o">&amp;</span><span class="n">TM</span><span class="p">,</span> <span class="n">CodeGenOpt</span><span class="p">::</span><span class="n">Level</span> <span class="n">OL</span><span class="p">)</span>
      <span class="p">:</span> <span class="n">SelectionDAGISel</span><span class="p">(</span><span class="n">TM</span><span class="p">,</span> <span class="n">OL</span><span class="p">),</span> <span class="n">Subtarget</span><span class="p">(</span><span class="n">nullptr</span><span class="p">)</span> <span class="p">{}</span>

  <span class="o">//</span> <span class="n">Pass</span> <span class="n">Name</span>
  <span class="n">const</span> <span class="n">char</span> <span class="o">*</span><span class="n">getPassName</span><span class="p">()</span> <span class="n">const</span> <span class="n">override</span> <span class="p">{</span>
    <span class="k">return</span> <span class="s2">&quot;CPU0 DAG-&gt;DAG Pattern Instruction Selection&quot;</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="nb">bool</span> <span class="n">runOnMachineFunction</span><span class="p">(</span><span class="n">MachineFunction</span> <span class="o">&amp;</span><span class="n">MF</span><span class="p">)</span> <span class="n">override</span><span class="p">;</span>

<span class="n">protected</span><span class="p">:</span>

  <span class="o">///</span> <span class="n">Keep</span> <span class="n">a</span> <span class="n">pointer</span> <span class="n">to</span> <span class="n">the</span> <span class="n">Cpu0Subtarget</span> <span class="n">around</span> <span class="n">so</span> <span class="n">that</span> <span class="n">we</span> <span class="n">can</span> <span class="n">make</span> <span class="n">the</span> <span class="n">right</span>
  <span class="o">///</span> <span class="n">decision</span> <span class="n">when</span> <span class="n">generating</span> <span class="n">code</span> <span class="k">for</span> <span class="n">different</span> <span class="n">targets</span><span class="o">.</span>
  <span class="n">const</span> <span class="n">Cpu0Subtarget</span> <span class="o">*</span><span class="n">Subtarget</span><span class="p">;</span>

<span class="n">private</span><span class="p">:</span>
  <span class="o">//</span> <span class="n">Include</span> <span class="n">the</span> <span class="n">pieces</span> <span class="n">autogenerated</span> <span class="kn">from</span> <span class="nn">the</span> <span class="n">target</span> <span class="n">description</span><span class="o">.</span>
  <span class="c1">#include &quot;Cpu0GenDAGISel.inc&quot;</span>

  <span class="o">///</span> <span class="n">getTargetMachine</span> <span class="o">-</span> <span class="n">Return</span> <span class="n">a</span> <span class="n">reference</span> <span class="n">to</span> <span class="n">the</span> <span class="n">TargetMachine</span><span class="p">,</span> <span class="n">casted</span>
  <span class="o">///</span> <span class="n">to</span> <span class="n">the</span> <span class="n">target</span><span class="o">-</span><span class="n">specific</span> <span class="nb">type</span><span class="o">.</span>
  <span class="n">const</span> <span class="n">Cpu0TargetMachine</span> <span class="o">&amp;</span><span class="n">getTargetMachine</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">static_cast</span><span class="o">&lt;</span><span class="n">const</span> <span class="n">Cpu0TargetMachine</span> <span class="o">&amp;&gt;</span><span class="p">(</span><span class="n">TM</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="n">void</span> <span class="n">Select</span><span class="p">(</span><span class="n">SDNode</span> <span class="o">*</span><span class="n">N</span><span class="p">)</span> <span class="n">override</span><span class="p">;</span>

  <span class="n">virtual</span> <span class="nb">bool</span> <span class="n">trySelect</span><span class="p">(</span><span class="n">SDNode</span> <span class="o">*</span><span class="n">Node</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

  <span class="o">//</span> <span class="n">Complex</span> <span class="n">Pattern</span><span class="o">.</span>
  <span class="nb">bool</span> <span class="n">SelectAddr</span><span class="p">(</span><span class="n">SDNode</span> <span class="o">*</span><span class="n">Parent</span><span class="p">,</span> <span class="n">SDValue</span> <span class="n">N</span><span class="p">,</span> <span class="n">SDValue</span> <span class="o">&amp;</span><span class="n">Base</span><span class="p">,</span> <span class="n">SDValue</span> <span class="o">&amp;</span><span class="n">Offset</span><span class="p">);</span>

  <span class="o">//</span> <span class="n">getImm</span> <span class="o">-</span> <span class="n">Return</span> <span class="n">a</span> <span class="n">target</span> <span class="n">constant</span> <span class="k">with</span> <span class="n">the</span> <span class="n">specified</span> <span class="n">value</span><span class="o">.</span>
  <span class="n">inline</span> <span class="n">SDValue</span> <span class="n">getImm</span><span class="p">(</span><span class="n">const</span> <span class="n">SDNode</span> <span class="o">*</span><span class="n">Node</span><span class="p">,</span> <span class="n">unsigned</span> <span class="n">Imm</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">CurDAG</span><span class="o">-&gt;</span><span class="n">getTargetConstant</span><span class="p">(</span><span class="n">Imm</span><span class="p">,</span> <span class="n">SDLoc</span><span class="p">(</span><span class="n">Node</span><span class="p">),</span> <span class="n">Node</span><span class="o">-&gt;</span><span class="n">getValueType</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
  <span class="p">}</span>

  <span class="n">virtual</span> <span class="n">void</span> <span class="n">processFunctionAfterISel</span><span class="p">(</span><span class="n">MachineFunction</span> <span class="o">&amp;</span><span class="n">MF</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="p">};</span>

<span class="p">}</span>

<span class="c1">#endif</span>

</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter3_3/Cpu0ISelDAGToDAG.cpp</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>//===-- Cpu0ISelDAGToDAG.cpp - A Dag to Dag Inst Selector for Cpu0 --------===//
//
//                     The LLVM Compiler Infrastructure
//
// This file is distributed under the University of Illinois Open Source
// License. See LICENSE.TXT for details.
//
//===----------------------------------------------------------------------===//
//
// This file defines an instruction selector for the CPU0 target.
//
//===----------------------------------------------------------------------===//

#include &quot;Cpu0ISelDAGToDAG.h&quot;
#include &quot;Cpu0.h&quot;

#include &quot;Cpu0MachineFunction.h&quot;
#include &quot;Cpu0RegisterInfo.h&quot;
#include &quot;Cpu0SEISelDAGToDAG.h&quot;
#include &quot;Cpu0TargetMachine.h&quot;
#include &quot;llvm/CodeGen/MachineConstantPool.h&quot;
#include &quot;llvm/CodeGen/MachineFrameInfo.h&quot;
#include &quot;llvm/CodeGen/MachineFunction.h&quot;
#include &quot;llvm/CodeGen/MachineInstrBuilder.h&quot;
#include &quot;llvm/CodeGen/MachineRegisterInfo.h&quot;
#include &quot;llvm/CodeGen/SelectionDAGISel.h&quot;
#include &quot;llvm/CodeGen/SelectionDAGNodes.h&quot;
#include &quot;llvm/IR/CFG.h&quot;
#include &quot;llvm/IR/GlobalValue.h&quot;
#include &quot;llvm/IR/Instructions.h&quot;
#include &quot;llvm/IR/Intrinsics.h&quot;
#include &quot;llvm/IR/Type.h&quot;
#include &quot;llvm/Support/Debug.h&quot;
#include &quot;llvm/Support/ErrorHandling.h&quot;
#include &quot;llvm/Support/raw_ostream.h&quot;
#include &quot;llvm/Target/TargetMachine.h&quot;
using namespace llvm;

#define DEBUG_TYPE &quot;cpu0-isel&quot;

//===----------------------------------------------------------------------===//
// Instruction Selector Implementation
//===----------------------------------------------------------------------===//

//===----------------------------------------------------------------------===//
// Cpu0DAGToDAGISel - CPU0 specific code to select CPU0 machine
// instructions for SelectionDAG operations.
//===----------------------------------------------------------------------===//

bool Cpu0DAGToDAGISel::runOnMachineFunction(MachineFunction &amp;MF) {
  bool Ret = SelectionDAGISel::runOnMachineFunction(MF);

  return Ret;
}

//@SelectAddr {
/// ComplexPattern used on Cpu0InstrInfo
/// Used on Cpu0 Load/Store instructions
bool Cpu0DAGToDAGISel::
SelectAddr(SDNode *Parent, SDValue Addr, SDValue &amp;Base, SDValue &amp;Offset) {
//@SelectAddr }
  EVT ValTy = Addr.getValueType();
  SDLoc DL(Addr);

  // If Parent is an unaligned f32 load or store, select a (base + index)
  // floating point load/store instruction (luxc1 or suxc1).
  const LSBaseSDNode* LS = 0;

  if (Parent &amp;&amp; (LS = dyn_cast&lt;LSBaseSDNode&gt;(Parent))) {
    EVT VT = LS-&gt;getMemoryVT();

    if (VT.getSizeInBits() / 8 &gt; LS-&gt;getAlignment()) {
      assert(&quot;Unaligned loads/stores not supported for this type.&quot;);
      if (VT == MVT::f32)
        return false;
    }
  }

  // if Address is FI, get the TargetFrameIndex.
  if (FrameIndexSDNode *FIN = dyn_cast&lt;FrameIndexSDNode&gt;(Addr)) {
    Base   = CurDAG-&gt;getTargetFrameIndex(FIN-&gt;getIndex(), ValTy);
    Offset = CurDAG-&gt;getTargetConstant(0, DL, ValTy);
    return true;
  }

  Base   = Addr;
  Offset = CurDAG-&gt;getTargetConstant(0, DL, ValTy);
  return true;
}

//@Select {
/// Select instructions not customized! Used for
/// expanded, promoted and normal instructions
void Cpu0DAGToDAGISel::Select(SDNode *Node) {
//@Select }
  unsigned Opcode = Node-&gt;getOpcode();

  // Dump information about the Node being selected
  DEBUG(errs() &lt;&lt; &quot;Selecting: &quot;; Node-&gt;dump(CurDAG); errs() &lt;&lt; &quot;\n&quot;);

  // If we have a custom node, we already have selected!
  if (Node-&gt;isMachineOpcode()) {
    DEBUG(errs() &lt;&lt; &quot;== &quot;; Node-&gt;dump(CurDAG); errs() &lt;&lt; &quot;\n&quot;);
    Node-&gt;setNodeId(-1);
    return;
  }

  // See if subclasses can handle this node.
  if (trySelect(Node))
    return;

  switch(Opcode) {
  default: break;

  }

  // Select the default instruction
  SelectCode(Node);
}

</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter3_3/Cpu0SEISelDAGToDAG.h</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">//===--</span> <span class="n">Cpu0SEISelDAGToDAG</span><span class="o">.</span><span class="n">h</span> <span class="o">-</span> <span class="n">A</span> <span class="n">Dag</span> <span class="n">to</span> <span class="n">Dag</span> <span class="n">Inst</span> <span class="n">Selector</span> <span class="k">for</span> <span class="n">Cpu0SE</span> <span class="o">-----===//</span>
<span class="o">//</span>
<span class="o">//</span>                     <span class="n">The</span> <span class="n">LLVM</span> <span class="n">Compiler</span> <span class="n">Infrastructure</span>
<span class="o">//</span>
<span class="o">//</span> <span class="n">This</span> <span class="n">file</span> <span class="ow">is</span> <span class="n">distributed</span> <span class="n">under</span> <span class="n">the</span> <span class="n">University</span> <span class="n">of</span> <span class="n">Illinois</span> <span class="n">Open</span> <span class="n">Source</span>
<span class="o">//</span> <span class="n">License</span><span class="o">.</span> <span class="n">See</span> <span class="n">LICENSE</span><span class="o">.</span><span class="n">TXT</span> <span class="k">for</span> <span class="n">details</span><span class="o">.</span>
<span class="o">//</span>
<span class="o">//===----------------------------------------------------------------------===//</span>
<span class="o">//</span>
<span class="o">//</span> <span class="n">Subclass</span> <span class="n">of</span> <span class="n">Cpu0DAGToDAGISel</span> <span class="n">specialized</span> <span class="k">for</span> <span class="n">cpu032</span><span class="o">.</span>
<span class="o">//</span>
<span class="o">//===----------------------------------------------------------------------===//</span>

<span class="c1">#ifndef LLVM_LIB_TARGET_CPU0_CPU0SEISELDAGTODAG_H</span>
<span class="c1">#define LLVM_LIB_TARGET_CPU0_CPU0SEISELDAGTODAG_H</span>

<span class="c1">#include &quot;Cpu0Config.h&quot;</span>

<span class="c1">#include &quot;Cpu0ISelDAGToDAG.h&quot;</span>

<span class="n">namespace</span> <span class="n">llvm</span> <span class="p">{</span>

<span class="k">class</span> <span class="nc">Cpu0SEDAGToDAGISel</span> <span class="p">:</span> <span class="n">public</span> <span class="n">Cpu0DAGToDAGISel</span> <span class="p">{</span>

<span class="n">public</span><span class="p">:</span>
  <span class="n">explicit</span> <span class="n">Cpu0SEDAGToDAGISel</span><span class="p">(</span><span class="n">Cpu0TargetMachine</span> <span class="o">&amp;</span><span class="n">TM</span><span class="p">,</span> <span class="n">CodeGenOpt</span><span class="p">::</span><span class="n">Level</span> <span class="n">OL</span><span class="p">)</span>
      <span class="p">:</span> <span class="n">Cpu0DAGToDAGISel</span><span class="p">(</span><span class="n">TM</span><span class="p">,</span> <span class="n">OL</span><span class="p">)</span> <span class="p">{}</span>

<span class="n">private</span><span class="p">:</span>

  <span class="nb">bool</span> <span class="n">runOnMachineFunction</span><span class="p">(</span><span class="n">MachineFunction</span> <span class="o">&amp;</span><span class="n">MF</span><span class="p">)</span> <span class="n">override</span><span class="p">;</span>

  <span class="nb">bool</span> <span class="n">trySelect</span><span class="p">(</span><span class="n">SDNode</span> <span class="o">*</span><span class="n">Node</span><span class="p">)</span> <span class="n">override</span><span class="p">;</span>

  <span class="n">void</span> <span class="n">processFunctionAfterISel</span><span class="p">(</span><span class="n">MachineFunction</span> <span class="o">&amp;</span><span class="n">MF</span><span class="p">)</span> <span class="n">override</span><span class="p">;</span>

  <span class="o">//</span> <span class="n">Insert</span> <span class="n">instructions</span> <span class="n">to</span> <span class="n">initialize</span> <span class="n">the</span> <span class="k">global</span> <span class="n">base</span> <span class="n">register</span> <span class="ow">in</span> <span class="n">the</span>
  <span class="o">//</span> <span class="n">first</span> <span class="n">MBB</span> <span class="n">of</span> <span class="n">the</span> <span class="n">function</span><span class="o">.</span>
<span class="o">//</span>  <span class="n">void</span> <span class="n">initGlobalBaseReg</span><span class="p">(</span><span class="n">MachineFunction</span> <span class="o">&amp;</span><span class="n">MF</span><span class="p">);</span>

<span class="p">};</span>

<span class="n">FunctionPass</span> <span class="o">*</span><span class="n">createCpu0SEISelDag</span><span class="p">(</span><span class="n">Cpu0TargetMachine</span> <span class="o">&amp;</span><span class="n">TM</span><span class="p">,</span>
                                  <span class="n">CodeGenOpt</span><span class="p">::</span><span class="n">Level</span> <span class="n">OptLevel</span><span class="p">);</span>

<span class="p">}</span>

<span class="c1">#endif</span>

</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter3_3/Cpu0ISelDAGToDAG.cpp</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">//===--</span> <span class="n">Cpu0SEISelDAGToDAG</span><span class="o">.</span><span class="n">cpp</span> <span class="o">-</span> <span class="n">A</span> <span class="n">Dag</span> <span class="n">to</span> <span class="n">Dag</span> <span class="n">Inst</span> <span class="n">Selector</span> <span class="k">for</span> <span class="n">Cpu0SE</span> <span class="o">----===//</span>
<span class="o">//</span>
<span class="o">//</span>                     <span class="n">The</span> <span class="n">LLVM</span> <span class="n">Compiler</span> <span class="n">Infrastructure</span>
<span class="o">//</span>
<span class="o">//</span> <span class="n">This</span> <span class="n">file</span> <span class="ow">is</span> <span class="n">distributed</span> <span class="n">under</span> <span class="n">the</span> <span class="n">University</span> <span class="n">of</span> <span class="n">Illinois</span> <span class="n">Open</span> <span class="n">Source</span>
<span class="o">//</span> <span class="n">License</span><span class="o">.</span> <span class="n">See</span> <span class="n">LICENSE</span><span class="o">.</span><span class="n">TXT</span> <span class="k">for</span> <span class="n">details</span><span class="o">.</span>
<span class="o">//</span>
<span class="o">//===----------------------------------------------------------------------===//</span>
<span class="o">//</span>
<span class="o">//</span> <span class="n">Subclass</span> <span class="n">of</span> <span class="n">Cpu0DAGToDAGISel</span> <span class="n">specialized</span> <span class="k">for</span> <span class="n">cpu032</span><span class="o">.</span>
<span class="o">//</span>
<span class="o">//===----------------------------------------------------------------------===//</span>

<span class="c1">#include &quot;Cpu0SEISelDAGToDAG.h&quot;</span>

<span class="c1">#include &quot;MCTargetDesc/Cpu0BaseInfo.h&quot;</span>
<span class="c1">#include &quot;Cpu0.h&quot;</span>
<span class="c1">#include &quot;Cpu0MachineFunction.h&quot;</span>
<span class="c1">#include &quot;Cpu0RegisterInfo.h&quot;</span>
<span class="c1">#include &quot;llvm/CodeGen/MachineConstantPool.h&quot;</span>
<span class="c1">#include &quot;llvm/CodeGen/MachineFrameInfo.h&quot;</span>
<span class="c1">#include &quot;llvm/CodeGen/MachineFunction.h&quot;</span>
<span class="c1">#include &quot;llvm/CodeGen/MachineInstrBuilder.h&quot;</span>
<span class="c1">#include &quot;llvm/CodeGen/MachineRegisterInfo.h&quot;</span>
<span class="c1">#include &quot;llvm/CodeGen/SelectionDAGNodes.h&quot;</span>
<span class="c1">#include &quot;llvm/IR/CFG.h&quot;</span>
<span class="c1">#include &quot;llvm/IR/GlobalValue.h&quot;</span>
<span class="c1">#include &quot;llvm/IR/Instructions.h&quot;</span>
<span class="c1">#include &quot;llvm/IR/Intrinsics.h&quot;</span>
<span class="c1">#include &quot;llvm/IR/Type.h&quot;</span>
<span class="c1">#include &quot;llvm/Support/Debug.h&quot;</span>
<span class="c1">#include &quot;llvm/Support/ErrorHandling.h&quot;</span>
<span class="c1">#include &quot;llvm/Support/raw_ostream.h&quot;</span>
<span class="c1">#include &quot;llvm/Target/TargetMachine.h&quot;</span>
<span class="n">using</span> <span class="n">namespace</span> <span class="n">llvm</span><span class="p">;</span>

<span class="c1">#define DEBUG_TYPE &quot;cpu0-isel&quot;</span>

<span class="nb">bool</span> <span class="n">Cpu0SEDAGToDAGISel</span><span class="p">::</span><span class="n">runOnMachineFunction</span><span class="p">(</span><span class="n">MachineFunction</span> <span class="o">&amp;</span><span class="n">MF</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">Subtarget</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">static_cast</span><span class="o">&lt;</span><span class="n">const</span> <span class="n">Cpu0Subtarget</span> <span class="o">&amp;&gt;</span><span class="p">(</span><span class="n">MF</span><span class="o">.</span><span class="n">getSubtarget</span><span class="p">());</span>
  <span class="k">return</span> <span class="n">Cpu0DAGToDAGISel</span><span class="p">::</span><span class="n">runOnMachineFunction</span><span class="p">(</span><span class="n">MF</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">void</span> <span class="n">Cpu0SEDAGToDAGISel</span><span class="p">::</span><span class="n">processFunctionAfterISel</span><span class="p">(</span><span class="n">MachineFunction</span> <span class="o">&amp;</span><span class="n">MF</span><span class="p">)</span> <span class="p">{</span>
<span class="p">}</span>

<span class="o">//</span><span class="nd">@selectNode</span>
<span class="nb">bool</span> <span class="n">Cpu0SEDAGToDAGISel</span><span class="p">::</span><span class="n">trySelect</span><span class="p">(</span><span class="n">SDNode</span> <span class="o">*</span><span class="n">Node</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">unsigned</span> <span class="n">Opcode</span> <span class="o">=</span> <span class="n">Node</span><span class="o">-&gt;</span><span class="n">getOpcode</span><span class="p">();</span>
  <span class="n">SDLoc</span> <span class="n">DL</span><span class="p">(</span><span class="n">Node</span><span class="p">);</span>

  <span class="o">///</span>
  <span class="o">//</span> <span class="n">Instruction</span> <span class="n">Selection</span> <span class="ow">not</span> <span class="n">handled</span> <span class="n">by</span> <span class="n">the</span> <span class="n">auto</span><span class="o">-</span><span class="n">generated</span>
  <span class="o">//</span> <span class="n">tablegen</span> <span class="n">selection</span> <span class="n">should</span> <span class="n">be</span> <span class="n">handled</span> <span class="n">here</span><span class="o">.</span>
  <span class="o">///</span>

  <span class="o">///</span>
  <span class="o">//</span> <span class="n">Instruction</span> <span class="n">Selection</span> <span class="ow">not</span> <span class="n">handled</span> <span class="n">by</span> <span class="n">the</span> <span class="n">auto</span><span class="o">-</span><span class="n">generated</span>
  <span class="o">//</span> <span class="n">tablegen</span> <span class="n">selection</span> <span class="n">should</span> <span class="n">be</span> <span class="n">handled</span> <span class="n">here</span><span class="o">.</span>
  <span class="o">///</span>
  <span class="n">EVT</span> <span class="n">NodeTy</span> <span class="o">=</span> <span class="n">Node</span><span class="o">-&gt;</span><span class="n">getValueType</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
  <span class="n">unsigned</span> <span class="n">MultOpc</span><span class="p">;</span>

  <span class="n">switch</span><span class="p">(</span><span class="n">Opcode</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">default</span><span class="p">:</span> <span class="k">break</span><span class="p">;</span>

  <span class="p">}</span>

  <span class="k">return</span> <span class="n">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">FunctionPass</span> <span class="o">*</span><span class="n">llvm</span><span class="p">::</span><span class="n">createCpu0SEISelDag</span><span class="p">(</span><span class="n">Cpu0TargetMachine</span> <span class="o">&amp;</span><span class="n">TM</span><span class="p">,</span>
                                        <span class="n">CodeGenOpt</span><span class="p">::</span><span class="n">Level</span> <span class="n">OptLevel</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="n">new</span> <span class="n">Cpu0SEDAGToDAGISel</span><span class="p">(</span><span class="n">TM</span><span class="p">,</span> <span class="n">OptLevel</span><span class="p">);</span>
<span class="p">}</span>

</pre></div>
</div>
<p>Function Cpu0DAGToDAGISel::Select() of Cpu0ISelDAGToDAG.cpp is for the
selection of &#8220;OP code DAG node&#8221; while Cpu0DAGToDAGISel::SelectAddr() is for the
selection of &#8220;DATA DAG node with <strong>addr</strong> type&#8221; which defined in
Chapter2/Cpu0InstrInfo.td. This method&#8217;s name corresponding to
Chapter2/Cpu0InstrInfo.td as follows,</p>
<p class="rubric">lbdex/chapters/Chapter2/Cpu0InstrInfo.td</p>
<div class="highlight-c++"><div class="highlight"><pre><span></span><span class="n">def</span> <span class="nl">addr</span> <span class="p">:</span> <span class="n">ComplexPattern</span><span class="o">&lt;</span><span class="n">iPTR</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;SelectAddr&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">frameindex</span><span class="p">],</span> <span class="p">[</span><span class="n">SDNPWantParent</span><span class="p">]</span><span class="o">&gt;</span><span class="p">;</span>
</pre></div>
</div>
<p>The iPTR, ComplexPattern, frameindex and SDNPWantParent defined as follows,</p>
<p class="rubric">src/include/llvm/Target/TargetSelection.td</p>
<div class="highlight-c++"><div class="highlight"><pre><span></span><span class="n">def</span> <span class="nl">SDNPWantParent</span>  <span class="p">:</span> <span class="n">SDNodeProperty</span><span class="p">;</span>   <span class="c1">// ComplexPattern gets the parent</span>
<span class="p">...</span>
<span class="n">def</span> <span class="nl">frameindex</span>  <span class="p">:</span> <span class="n">SDNode</span><span class="o">&lt;</span><span class="s">&quot;ISD::FrameIndex&quot;</span><span class="p">,</span>           <span class="n">SDTPtrLeaf</span><span class="p">,</span> <span class="p">[],</span>
                         <span class="s">&quot;FrameIndexSDNode&quot;</span><span class="o">&gt;</span><span class="p">;</span>
<span class="p">...</span>
<span class="c1">// Complex patterns, e.g. X86 addressing mode, requires pattern matching code</span>
<span class="c1">// in C++. NumOperands is the number of operands returned by the select function;</span>
<span class="c1">// SelectFunc is the name of the function used to pattern match the max. pattern;</span>
<span class="c1">// RootNodes are the list of possible root nodes of the sub-dags to match.</span>
<span class="c1">// e.g. X86 addressing mode - def addr : ComplexPattern&lt;4, &quot;SelectAddr&quot;, [add]&gt;;</span>
<span class="c1">//</span>
<span class="k">class</span> <span class="nc">ComplexPattern</span><span class="o">&lt;</span><span class="n">ValueType</span> <span class="n">ty</span><span class="p">,</span> <span class="kt">int</span> <span class="n">numops</span><span class="p">,</span> <span class="n">string</span> <span class="n">fn</span><span class="p">,</span>
                     <span class="n">list</span><span class="o">&lt;</span><span class="n">SDNode</span><span class="o">&gt;</span> <span class="n">roots</span> <span class="o">=</span> <span class="p">[],</span> <span class="n">list</span><span class="o">&lt;</span><span class="n">SDNodeProperty</span><span class="o">&gt;</span> <span class="n">props</span> <span class="o">=</span> <span class="p">[]</span><span class="o">&gt;</span> <span class="p">{</span>
  <span class="n">ValueType</span> <span class="n">Ty</span> <span class="o">=</span> <span class="n">ty</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">NumOperands</span> <span class="o">=</span> <span class="n">numops</span><span class="p">;</span>
  <span class="n">string</span> <span class="n">SelectFunc</span> <span class="o">=</span> <span class="n">fn</span><span class="p">;</span>
  <span class="n">list</span><span class="o">&lt;</span><span class="n">SDNode</span><span class="o">&gt;</span> <span class="n">RootNodes</span> <span class="o">=</span> <span class="n">roots</span><span class="p">;</span>
  <span class="n">list</span><span class="o">&lt;</span><span class="n">SDNodeProperty</span><span class="o">&gt;</span> <span class="n">Properties</span> <span class="o">=</span> <span class="n">props</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p class="rubric">src/include/llvm/CodeGen/ValueTypes.td</p>
<div class="highlight-c++"><div class="highlight"><pre><span></span><span class="c1">// Pseudo valuetype mapped to the current pointer size.</span>
<span class="n">def</span> <span class="nl">iPTR</span>   <span class="p">:</span> <span class="n">ValueType</span><span class="o">&lt;</span><span class="mi">0</span>  <span class="p">,</span> <span class="mi">255</span><span class="o">&gt;</span><span class="p">;</span>
</pre></div>
</div>
<p>Build Chapter3_3 and run with it, finding the error message of Chapter3_2 is
gone. The new error message for Chapter3_3 as follows,</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">118-165-78-230:input Jonathan$</span> /Users/Jonathan/llvm/test/cmake_debug_build/
<span class="go">Debug/bin/llc -march=cpu0 -relocation-model=pic -filetype=asm ch3.bc -o</span>
<span class="go">ch3.cpu0.s</span>
<span class="go">...</span>
<span class="go">LLVM ERROR: Cannot select: 0x24834b8: ch = Cpu0ISD::Ret 0x24832a8, 0x24833b0 [ORD=4] [ID=6]</span>
<span class="go">  0x24833b0: i32 = Register %LR [ID=4]</span>
<span class="go">...</span>
<span class="go">  0x7f80f182d210: i32 = Register %LR [ID=4]</span>
</pre></div>
</div>
<p>Above can display the error message DAG node &#8220;Cpu0ISD::Ret&#8221; because the following
code added in Chapter3_1/Cpu0ISelLowering.cpp.</p>
<p class="rubric">lbdex/chapters/Chapter3_1/Cpu0ISelLowering.cpp</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">const</span> <span class="n">char</span> <span class="o">*</span><span class="n">Cpu0TargetLowering</span><span class="p">::</span><span class="n">getTargetNodeName</span><span class="p">(</span><span class="n">unsigned</span> <span class="n">Opcode</span><span class="p">)</span> <span class="n">const</span> <span class="p">{</span>
  <span class="n">switch</span> <span class="p">(</span><span class="n">Opcode</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">case</span> <span class="n">Cpu0ISD</span><span class="p">::</span><span class="n">JmpLink</span><span class="p">:</span>           <span class="k">return</span> <span class="s2">&quot;Cpu0ISD::JmpLink&quot;</span><span class="p">;</span>
  <span class="n">case</span> <span class="n">Cpu0ISD</span><span class="p">::</span><span class="n">TailCall</span><span class="p">:</span>          <span class="k">return</span> <span class="s2">&quot;Cpu0ISD::TailCall&quot;</span><span class="p">;</span>
  <span class="n">case</span> <span class="n">Cpu0ISD</span><span class="p">::</span><span class="n">Hi</span><span class="p">:</span>                <span class="k">return</span> <span class="s2">&quot;Cpu0ISD::Hi&quot;</span><span class="p">;</span>
  <span class="n">case</span> <span class="n">Cpu0ISD</span><span class="p">::</span><span class="n">Lo</span><span class="p">:</span>                <span class="k">return</span> <span class="s2">&quot;Cpu0ISD::Lo&quot;</span><span class="p">;</span>
  <span class="n">case</span> <span class="n">Cpu0ISD</span><span class="p">::</span><span class="n">GPRel</span><span class="p">:</span>             <span class="k">return</span> <span class="s2">&quot;Cpu0ISD::GPRel&quot;</span><span class="p">;</span>
  <span class="n">case</span> <span class="n">Cpu0ISD</span><span class="p">::</span><span class="n">Ret</span><span class="p">:</span>               <span class="k">return</span> <span class="s2">&quot;Cpu0ISD::Ret&quot;</span><span class="p">;</span>
  <span class="n">case</span> <span class="n">Cpu0ISD</span><span class="p">::</span><span class="n">EH_RETURN</span><span class="p">:</span>         <span class="k">return</span> <span class="s2">&quot;Cpu0ISD::EH_RETURN&quot;</span><span class="p">;</span>
  <span class="n">case</span> <span class="n">Cpu0ISD</span><span class="p">::</span><span class="n">DivRem</span><span class="p">:</span>            <span class="k">return</span> <span class="s2">&quot;Cpu0ISD::DivRem&quot;</span><span class="p">;</span>
  <span class="n">case</span> <span class="n">Cpu0ISD</span><span class="p">::</span><span class="n">DivRemU</span><span class="p">:</span>           <span class="k">return</span> <span class="s2">&quot;Cpu0ISD::DivRemU&quot;</span><span class="p">;</span>
  <span class="n">case</span> <span class="n">Cpu0ISD</span><span class="p">::</span><span class="n">Wrapper</span><span class="p">:</span>           <span class="k">return</span> <span class="s2">&quot;Cpu0ISD::Wrapper&quot;</span><span class="p">;</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span>  <span class="n">default</span><span class="p">:</span>                         <span class="k">return</span> <span class="n">NULL</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="handle-return-register-lr">
<h2><a class="toc-backref" href="#id17">Handle return register $lr</a><a class="headerlink" href="#handle-return-register-lr" title="Permalink to this headline">¶</a></h2>
<p>The following code is the result of running Mips backend with ch3.cpp.</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">JonathantekiiMac:input Jonathan$</span> ~/llvm/release/cmake_debug_build/Debug/bin/llc
<span class="go">-march=mips -relocation-model=pic -filetype=asm ch3.bc -o -</span>
<span class="go">  .text</span>
<span class="go">  .abicalls</span>
<span class="go">  .section  .mdebug.abi32,&quot;&quot;,@progbits</span>
<span class="go">  .nan  legacy</span>
<span class="go">  .file &quot;ch3.bc&quot;</span>
<span class="go">  .text</span>
<span class="go">  .globl  main</span>
<span class="go">  .align  2</span>
<span class="go">  .type main,@function</span>
<span class="go">  .set  nomicromips</span>
<span class="go">  .set  nomips16</span>
<span class="go">  .ent  main</span>
<span class="go">main:                                   # @main</span>
<span class="go">  .frame  $fp,8,$ra</span>
<span class="go">  .mask   0x40000000,-4</span>
<span class="go">  .fmask  0x00000000,0</span>
<span class="go">  .set  noreorder</span>
<span class="go">  .set  nomacro</span>
<span class="go">  .set  noat</span>
<span class="gp">#</span> BB#0:
<span class="go">  addiu $sp, $sp, -8</span>
<span class="go">  sw  $fp, 4($sp)             # 4-byte Folded Spill</span>
<span class="go">  move   $fp, $sp</span>
<span class="go">  sw  $zero, 0($fp)</span>
<span class="go">  addiu $2, $zero, 0</span>
<span class="go">  move   $sp, $fp</span>
<span class="go">  lw  $fp, 4($sp)             # 4-byte Folded Reload</span>
<span class="go">  jr  $ra</span>
<span class="go">  addiu $sp, $sp, 8</span>
<span class="go">  .set  at</span>
<span class="go">  .set  macro</span>
<span class="go">  .set  reorder</span>
<span class="go">  .end  main</span>
<span class="gp">$</span>func_end0:
<span class="go">  .size main, ($func_end0)-main</span>
</pre></div>
</div>
<p>As you can see, Mips return to the caller by using &#8220;jr $ra&#8221; where
$ra is a specific register which keeps the caller&#8217;s next instruction address.
And it saves the return value in register $2.
If we only create DAGs directly, then will having the following two problems.</p>
<ol class="arabic simple">
<li>LLVM can allocate any register for return value, for instance $3, rather
than keeps it in $2.</li>
</ol>
<p>2. LLVM will allocate a register randomly to &#8220;jr&#8221; since jr needs one operand.
For instance, it generate &#8220;jr $8&#8221; rather than &#8220;jr $ra&#8221;.</p>
<p>If Backend uses the &#8220;jal sub-routine&#8221; and &#8220;jr&#8221;, and put the return address in
the specific register $ra, then no the second problem. But in Mips, it allows
programmer uses &#8220;jal $rx, sub-routine&#8221; and &#8220;jr $rx&#8221; whereas $rx is not $ra.
Allowing programmer uses other register but $ra providing more flexibility in
programming of high level language such as C with assembly.
File ch8_2_longbranch.cpp in the following is an example, it uses jr $1 without
spill $ra register. This will save a lot of time if it is in a hot function.</p>
<p class="rubric">lbdex/input/ch8_2_longbranch.cpp</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="nb">int</span> <span class="n">test_longbranch</span><span class="p">()</span>
<span class="p">{</span>
  <span class="n">volatile</span> <span class="nb">int</span> <span class="n">a</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
  <span class="n">volatile</span> <span class="nb">int</span> <span class="n">b</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="nb">int</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">a</span> <span class="o">&lt;</span> <span class="n">b</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

</pre></div>
</div>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">JonathantekiiMac:input Jonathan$</span> clang -target mips-unknown-linux-gnu -c
<span class="go">ch8_2_longbranch.cpp -emit-llvm -o ch8_2_longbranch.bc</span>
<span class="gp">JonathantekiiMac:input Jonathan$</span> ~/llvm/release/cmake_debug_build/Debug/bin/llc
<span class="go">-march=mips -relocation-model=pic -filetype=asm -force-mips-long-branch</span>
<span class="go">ch8_2_longbranch.bc -o -</span>
<span class="go">  ...</span>
<span class="go">  .ent  _Z15test_longbranchv</span>
<span class="go">_Z15test_longbranchv:                   # @_Z15test_longbranchv</span>
<span class="go">  .frame  $fp,16,$ra</span>
<span class="go">  .mask   0x40000000,-4</span>
<span class="go">  .fmask  0x00000000,0</span>
<span class="go">  .set  noreorder</span>
<span class="go">  .set  nomacro</span>
<span class="go">  .set  noat</span>
<span class="gp">#</span> BB#0:
<span class="go">  addiu $sp, $sp, -16</span>
<span class="go">  sw  $fp, 12($sp)            # 4-byte Folded Spill</span>
<span class="go">  move   $fp, $sp</span>
<span class="go">  addiu $1, $zero, 2</span>
<span class="go">  sw  $1, 8($fp)</span>
<span class="go">  addiu $2, $zero, 1</span>
<span class="go">  sw  $2, 4($fp)</span>
<span class="go">  sw  $zero, 0($fp)</span>
<span class="go">  lw  $1, 8($fp)</span>
<span class="go">  lw  $3, 4($fp)</span>
<span class="go">  slt $1, $1, $3</span>
<span class="go">  bnez  $1, $BB0_3</span>
<span class="go">  nop</span>
<span class="gp">#</span> BB#1:
<span class="go">  addiu $sp, $sp, -8</span>
<span class="go">  sw  $ra, 0($sp)</span>
<span class="go">  lui $1, %hi(($BB0_4)-($BB0_2))</span>
<span class="go">  bal $BB0_2</span>
<span class="go">  addiu $1, $1, %lo(($BB0_4)-($BB0_2))</span>
<span class="gp">$</span>BB0_2:
<span class="go">  addu  $1, $ra, $1</span>
<span class="go">  lw  $ra, 0($sp)</span>
<span class="go">  jr  $1</span>
<span class="go">  addiu $sp, $sp, 8</span>
<span class="gp">$</span>BB0_3:
<span class="go">  sw  $2, 0($fp)</span>
<span class="gp">$</span>BB0_4:
<span class="go">  lw  $2, 0($fp)</span>
<span class="go">  move   $sp, $fp</span>
<span class="go">  lw  $fp, 12($sp)            # 4-byte Folded Reload</span>
<span class="go">  jr  $ra</span>
<span class="go">  addiu $sp, $sp, 16</span>
<span class="go">  .set  at</span>
<span class="go">  .set  macro</span>
<span class="go">  .set  reorder</span>
<span class="go">  .end  _Z15test_longbranchv</span>
<span class="gp">$</span>func_end0:
<span class="go">  .size _Z15test_longbranchv, ($func_end0)-_Z15test_longbranchv</span>
</pre></div>
</div>
<p>The following code handle the return register $lr.</p>
<p class="rubric">lbdex/chapters/Chapter3_4/Cpu0CallingConv.td</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">RetCC_Cpu0EABI</span> <span class="p">:</span> <span class="n">CallingConv</span><span class="o">&lt;</span><span class="p">[</span>
  <span class="o">//</span> <span class="n">i32</span> <span class="n">are</span> <span class="n">returned</span> <span class="ow">in</span> <span class="n">registers</span> <span class="n">V0</span><span class="p">,</span> <span class="n">V1</span><span class="p">,</span> <span class="n">A0</span><span class="p">,</span> <span class="n">A1</span>
  <span class="n">CCIfType</span><span class="o">&lt;</span><span class="p">[</span><span class="n">i32</span><span class="p">],</span> <span class="n">CCAssignToReg</span><span class="o">&lt;</span><span class="p">[</span><span class="n">V0</span><span class="p">,</span> <span class="n">V1</span><span class="p">,</span> <span class="n">A0</span><span class="p">,</span> <span class="n">A1</span><span class="p">]</span><span class="o">&gt;&gt;</span>
<span class="p">]</span><span class="o">&gt;</span><span class="p">;</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">RetCC_Cpu0</span> <span class="p">:</span> <span class="n">CallingConv</span><span class="o">&lt;</span><span class="p">[</span>
  <span class="n">CCDelegateTo</span><span class="o">&lt;</span><span class="n">RetCC_Cpu0EABI</span><span class="o">&gt;</span>
<span class="p">]</span><span class="o">&gt;</span><span class="p">;</span>
</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter3_4/Cpu0InstrFormats.td</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">//</span> <span class="n">Cpu0</span> <span class="n">Pseudo</span> <span class="n">Instructions</span> <span class="n">Format</span>
<span class="k">class</span> <span class="nc">Cpu0Pseudo</span><span class="o">&lt;</span><span class="n">dag</span> <span class="n">outs</span><span class="p">,</span> <span class="n">dag</span> <span class="n">ins</span><span class="p">,</span> <span class="n">string</span> <span class="n">asmstr</span><span class="p">,</span> <span class="nb">list</span><span class="o">&lt;</span><span class="n">dag</span><span class="o">&gt;</span> <span class="n">pattern</span><span class="o">&gt;</span><span class="p">:</span>
      <span class="n">Cpu0Inst</span><span class="o">&lt;</span><span class="n">outs</span><span class="p">,</span> <span class="n">ins</span><span class="p">,</span> <span class="n">asmstr</span><span class="p">,</span> <span class="n">pattern</span><span class="p">,</span> <span class="n">IIPseudo</span><span class="p">,</span> <span class="n">Pseudo</span><span class="o">&gt;</span> <span class="p">{</span>
  <span class="n">let</span> <span class="n">isCodeGenOnly</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="n">let</span> <span class="n">isPseudo</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter3_4/Cpu0InstrInfo.td</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">let</span> <span class="n">Predicates</span> <span class="o">=</span> <span class="p">[</span><span class="n">Ch3_4</span><span class="p">]</span> <span class="ow">in</span> <span class="p">{</span>
<span class="n">let</span> <span class="n">isReturn</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">isTerminator</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">hasDelaySlot</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">isBarrier</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">hasCtrlDep</span><span class="o">=</span><span class="mi">1</span> <span class="ow">in</span>
  <span class="k">def</span> <span class="nf">RetLR</span> <span class="p">:</span> <span class="n">Cpu0Pseudo</span><span class="o">&lt;</span><span class="p">(</span><span class="n">outs</span><span class="p">),</span> <span class="p">(</span><span class="n">ins</span><span class="p">),</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="p">[(</span><span class="n">Cpu0Ret</span><span class="p">)]</span><span class="o">&gt;</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter3_4/Cpu0ISelLowering.h</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>    /// Cpu0CC - This class provides methods used to analyze formal and call
    /// arguments and inquire about calling convention information.
    class Cpu0CC {
    public:
      enum SpecialCallingConvType {
        NoSpecialCallingConv
      };

      Cpu0CC(CallingConv::ID CallConv, bool IsO32, CCState &amp;Info,
             SpecialCallingConvType SpecialCallingConv = NoSpecialCallingConv);

      void analyzeCallResult(const SmallVectorImpl&lt;ISD::InputArg&gt; &amp;Ins,
                             bool IsSoftFloat, const SDNode *CallNode,
                             const Type *RetTy) const;

      void analyzeReturn(const SmallVectorImpl&lt;ISD::OutputArg&gt; &amp;Outs,
                         bool IsSoftFloat, const Type *RetTy) const;

      const CCState &amp;getCCInfo() const { return CCInfo; }

      /// hasByValArg - Returns true if function has byval arguments.
      bool hasByValArg() const { return !ByValArgs.empty(); }

      /// reservedArgArea - The size of the area the caller reserves for
      /// register arguments. This is 16-byte if ABI is O32.
      unsigned reservedArgArea() const;

      typedef SmallVectorImpl&lt;ByValArgInfo&gt;::const_iterator byval_iterator;
      byval_iterator byval_begin() const { return ByValArgs.begin(); }
      byval_iterator byval_end() const { return ByValArgs.end(); }

    private:

      /// Return the type of the register which is used to pass an argument or
      /// return a value. This function returns f64 if the argument is an i64
      /// value which has been generated as a result of softening an f128 value.
      /// Otherwise, it just returns VT.
      MVT getRegVT(MVT VT, const Type *OrigTy, const SDNode *CallNode,
                   bool IsSoftFloat) const;

      template&lt;typename Ty&gt;
      void analyzeReturn(const SmallVectorImpl&lt;Ty&gt; &amp;RetVals, bool IsSoftFloat,
                         const SDNode *CallNode, const Type *RetTy) const;

      CCState &amp;CCInfo;
      CallingConv::ID CallConv;
      bool IsO32;
      SmallVector&lt;ByValArgInfo, 2&gt; ByValArgs;
    };
</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter3_4/Cpu0ISelLowering.cpp</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">SDValue</span>
<span class="n">Cpu0TargetLowering</span><span class="p">::</span><span class="n">LowerReturn</span><span class="p">(</span><span class="n">SDValue</span> <span class="n">Chain</span><span class="p">,</span>
                                <span class="n">CallingConv</span><span class="p">::</span><span class="n">ID</span> <span class="n">CallConv</span><span class="p">,</span> <span class="nb">bool</span> <span class="n">IsVarArg</span><span class="p">,</span>
                                <span class="n">const</span> <span class="n">SmallVectorImpl</span><span class="o">&lt;</span><span class="n">ISD</span><span class="p">::</span><span class="n">OutputArg</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="n">Outs</span><span class="p">,</span>
                                <span class="n">const</span> <span class="n">SmallVectorImpl</span><span class="o">&lt;</span><span class="n">SDValue</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="n">OutVals</span><span class="p">,</span>
                                <span class="n">const</span> <span class="n">SDLoc</span> <span class="o">&amp;</span><span class="n">DL</span><span class="p">,</span> <span class="n">SelectionDAG</span> <span class="o">&amp;</span><span class="n">DAG</span><span class="p">)</span> <span class="n">const</span> <span class="p">{</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span>  // CCValAssign - represent the assignment of
  // the return value to a location
  SmallVector&lt;CCValAssign, 16&gt; RVLocs;
  MachineFunction &amp;MF = DAG.getMachineFunction();

  // CCState - Info about the registers and stack slot.
  CCState CCInfo(CallConv, IsVarArg, MF, RVLocs,
                 *DAG.getContext());
  Cpu0CC Cpu0CCInfo(CallConv, ABI.IsO32(), 
                    CCInfo);

  // Analyze return values.
  Cpu0CCInfo.analyzeReturn(Outs, Subtarget.abiUsesSoftFloat(),
                           MF.getFunction()-&gt;getReturnType());

  SDValue Flag;
  SmallVector&lt;SDValue, 4&gt; RetOps(1, Chain);

  // Copy the result values into the output registers.
  for (unsigned i = 0; i != RVLocs.size(); ++i) {
    SDValue Val = OutVals[i];
    CCValAssign &amp;VA = RVLocs[i];
    assert(VA.isRegLoc() &amp;&amp; &quot;Can only return in registers!&quot;);

    if (RVLocs[i].getValVT() != RVLocs[i].getLocVT())
      Val = DAG.getNode(ISD::BITCAST, DL, RVLocs[i].getLocVT(), Val);

    Chain = DAG.getCopyToReg(Chain, DL, VA.getLocReg(), Val, Flag);

    // Guarantee that all emitted copies are stuck together with flags.
    Flag = Chain.getValue(1);
    RetOps.push_back(DAG.getRegister(VA.getLocReg(), VA.getLocVT()));
  }

//@Ordinary struct type: 2 {
  // The cpu0 ABIs for returning structs by value requires that we copy
  // the sret argument into $v0 for the return. We saved the argument into
  // a virtual register in the entry block, so now we copy the value out
  // and into $v0.
  if (MF.getFunction()-&gt;hasStructRetAttr()) {
    Cpu0FunctionInfo *Cpu0FI = MF.getInfo&lt;Cpu0FunctionInfo&gt;();
    unsigned Reg = Cpu0FI-&gt;getSRetReturnReg();

    if (!Reg)
      llvm_unreachable(&quot;sret virtual register not created in the entry block&quot;);
    SDValue Val =
        DAG.getCopyFromReg(Chain, DL, Reg, getPointerTy(DAG.getDataLayout()));
    unsigned V0 = Cpu0::V0;

    Chain = DAG.getCopyToReg(Chain, DL, V0, Val, Flag);
    Flag = Chain.getValue(1);
    RetOps.push_back(DAG.getRegister(V0, getPointerTy(DAG.getDataLayout())));
  }
//@Ordinary struct type: 2 }

  RetOps[0] = Chain;  // Update chain.

  // Add the flag if we have it.
  if (Flag.getNode())
    RetOps.push_back(Flag);

  // Return on Cpu0 is always a &quot;ret $lr&quot;
  return DAG.getNode(Cpu0ISD::Ret, DL, MVT::Other, RetOps);
</pre></div>
</div>
<div class="highlight-c++"><div class="highlight"><pre><span></span><span class="p">}</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">template</span><span class="o">&lt;</span><span class="n">typename</span> <span class="n">Ty</span><span class="o">&gt;</span>
<span class="n">void</span> <span class="n">Cpu0TargetLowering</span><span class="p">::</span><span class="n">Cpu0CC</span><span class="p">::</span>
<span class="n">analyzeReturn</span><span class="p">(</span><span class="n">const</span> <span class="n">SmallVectorImpl</span><span class="o">&lt;</span><span class="n">Ty</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="n">RetVals</span><span class="p">,</span> <span class="nb">bool</span> <span class="n">IsSoftFloat</span><span class="p">,</span>
              <span class="n">const</span> <span class="n">SDNode</span> <span class="o">*</span><span class="n">CallNode</span><span class="p">,</span> <span class="n">const</span> <span class="n">Type</span> <span class="o">*</span><span class="n">RetTy</span><span class="p">)</span> <span class="n">const</span> <span class="p">{</span>
  <span class="n">CCAssignFn</span> <span class="o">*</span><span class="n">Fn</span><span class="p">;</span>

  <span class="n">Fn</span> <span class="o">=</span> <span class="n">RetCC_Cpu0</span><span class="p">;</span>

  <span class="k">for</span> <span class="p">(</span><span class="n">unsigned</span> <span class="n">I</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">E</span> <span class="o">=</span> <span class="n">RetVals</span><span class="o">.</span><span class="n">size</span><span class="p">();</span> <span class="n">I</span> <span class="o">&lt;</span> <span class="n">E</span><span class="p">;</span> <span class="o">++</span><span class="n">I</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">MVT</span> <span class="n">VT</span> <span class="o">=</span> <span class="n">RetVals</span><span class="p">[</span><span class="n">I</span><span class="p">]</span><span class="o">.</span><span class="n">VT</span><span class="p">;</span>
    <span class="n">ISD</span><span class="p">::</span><span class="n">ArgFlagsTy</span> <span class="n">Flags</span> <span class="o">=</span> <span class="n">RetVals</span><span class="p">[</span><span class="n">I</span><span class="p">]</span><span class="o">.</span><span class="n">Flags</span><span class="p">;</span>
    <span class="n">MVT</span> <span class="n">RegVT</span> <span class="o">=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">getRegVT</span><span class="p">(</span><span class="n">VT</span><span class="p">,</span> <span class="n">RetTy</span><span class="p">,</span> <span class="n">CallNode</span><span class="p">,</span> <span class="n">IsSoftFloat</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">Fn</span><span class="p">(</span><span class="n">I</span><span class="p">,</span> <span class="n">VT</span><span class="p">,</span> <span class="n">RegVT</span><span class="p">,</span> <span class="n">CCValAssign</span><span class="p">::</span><span class="n">Full</span><span class="p">,</span> <span class="n">Flags</span><span class="p">,</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">CCInfo</span><span class="p">))</span> <span class="p">{</span>
<span class="c1">#ifndef NDEBUG</span>
      <span class="n">dbgs</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s2">&quot;Call result #&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">I</span> <span class="o">&lt;&lt;</span> <span class="s2">&quot; has unhandled type &quot;</span>
             <span class="o">&lt;&lt;</span> <span class="n">EVT</span><span class="p">(</span><span class="n">VT</span><span class="p">)</span><span class="o">.</span><span class="n">getEVTString</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">;</span>
<span class="c1">#endif</span>
      <span class="n">llvm_unreachable</span><span class="p">(</span><span class="n">nullptr</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="n">void</span> <span class="n">Cpu0TargetLowering</span><span class="p">::</span><span class="n">Cpu0CC</span><span class="p">::</span>
<span class="n">analyzeCallResult</span><span class="p">(</span><span class="n">const</span> <span class="n">SmallVectorImpl</span><span class="o">&lt;</span><span class="n">ISD</span><span class="p">::</span><span class="n">InputArg</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="n">Ins</span><span class="p">,</span> <span class="nb">bool</span> <span class="n">IsSoftFloat</span><span class="p">,</span>
                  <span class="n">const</span> <span class="n">SDNode</span> <span class="o">*</span><span class="n">CallNode</span><span class="p">,</span> <span class="n">const</span> <span class="n">Type</span> <span class="o">*</span><span class="n">RetTy</span><span class="p">)</span> <span class="n">const</span> <span class="p">{</span>
  <span class="n">analyzeReturn</span><span class="p">(</span><span class="n">Ins</span><span class="p">,</span> <span class="n">IsSoftFloat</span><span class="p">,</span> <span class="n">CallNode</span><span class="p">,</span> <span class="n">RetTy</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">void</span> <span class="n">Cpu0TargetLowering</span><span class="p">::</span><span class="n">Cpu0CC</span><span class="p">::</span>
<span class="n">analyzeReturn</span><span class="p">(</span><span class="n">const</span> <span class="n">SmallVectorImpl</span><span class="o">&lt;</span><span class="n">ISD</span><span class="p">::</span><span class="n">OutputArg</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="n">Outs</span><span class="p">,</span> <span class="nb">bool</span> <span class="n">IsSoftFloat</span><span class="p">,</span>
              <span class="n">const</span> <span class="n">Type</span> <span class="o">*</span><span class="n">RetTy</span><span class="p">)</span> <span class="n">const</span> <span class="p">{</span>
  <span class="n">analyzeReturn</span><span class="p">(</span><span class="n">Outs</span><span class="p">,</span> <span class="n">IsSoftFloat</span><span class="p">,</span> <span class="n">nullptr</span><span class="p">,</span> <span class="n">RetTy</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span>unsigned Cpu0TargetLowering::Cpu0CC::reservedArgArea() const {
  return (IsO32 &amp;&amp; (CallConv != CallingConv::Fast)) ? 8 : 0;
}
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">MVT</span> <span class="n">Cpu0TargetLowering</span><span class="p">::</span><span class="n">Cpu0CC</span><span class="p">::</span><span class="n">getRegVT</span><span class="p">(</span><span class="n">MVT</span> <span class="n">VT</span><span class="p">,</span> <span class="n">const</span> <span class="n">Type</span> <span class="o">*</span><span class="n">OrigTy</span><span class="p">,</span>
                                         <span class="n">const</span> <span class="n">SDNode</span> <span class="o">*</span><span class="n">CallNode</span><span class="p">,</span>
                                         <span class="nb">bool</span> <span class="n">IsSoftFloat</span><span class="p">)</span> <span class="n">const</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">IsSoftFloat</span> <span class="o">||</span> <span class="n">IsO32</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">VT</span><span class="p">;</span>

  <span class="k">return</span> <span class="n">VT</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter3_4/Cpu0MachineFunction.h</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">///</span> <span class="n">Cpu0FunctionInfo</span> <span class="o">-</span> <span class="n">This</span> <span class="k">class</span> <span class="nc">is</span> <span class="n">derived</span> <span class="kn">from</span> <span class="nn">MachineFunction</span> <span class="n">private</span>
<span class="o">///</span> <span class="n">Cpu0</span> <span class="n">target</span><span class="o">-</span><span class="n">specific</span> <span class="n">information</span> <span class="k">for</span> <span class="n">each</span> <span class="n">MachineFunction</span><span class="o">.</span>
<span class="k">class</span> <span class="nc">Cpu0FunctionInfo</span> <span class="p">:</span> <span class="n">public</span> <span class="n">MachineFunctionInfo</span> <span class="p">{</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span>    <span class="n">SRetReturnReg</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">CallsEhReturn</span><span class="p">(</span><span class="n">false</span><span class="p">),</span> <span class="n">CallsEhDwarf</span><span class="p">(</span><span class="n">false</span><span class="p">),</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span>  <span class="n">unsigned</span> <span class="n">getSRetReturnReg</span><span class="p">()</span> <span class="n">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">SRetReturnReg</span><span class="p">;</span> <span class="p">}</span>
  <span class="n">void</span> <span class="n">setSRetReturnReg</span><span class="p">(</span><span class="n">unsigned</span> <span class="n">Reg</span><span class="p">)</span> <span class="p">{</span> <span class="n">SRetReturnReg</span> <span class="o">=</span> <span class="n">Reg</span><span class="p">;</span> <span class="p">}</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span>  <span class="nb">bool</span> <span class="n">hasByvalArg</span><span class="p">()</span> <span class="n">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">HasByvalArg</span><span class="p">;</span> <span class="p">}</span>
  <span class="n">void</span> <span class="n">setFormalArgInfo</span><span class="p">(</span><span class="n">unsigned</span> <span class="n">Size</span><span class="p">,</span> <span class="nb">bool</span> <span class="n">HasByval</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">IncomingArgSize</span> <span class="o">=</span> <span class="n">Size</span><span class="p">;</span>
    <span class="n">HasByvalArg</span> <span class="o">=</span> <span class="n">HasByval</span><span class="p">;</span>
  <span class="p">}</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span>  <span class="o">///</span> <span class="n">SRetReturnReg</span> <span class="o">-</span> <span class="n">Some</span> <span class="n">subtargets</span> <span class="n">require</span> <span class="n">that</span> <span class="n">sret</span> <span class="n">lowering</span> <span class="n">includes</span>
  <span class="o">///</span> <span class="n">returning</span> <span class="n">the</span> <span class="n">value</span> <span class="n">of</span> <span class="n">the</span> <span class="n">returned</span> <span class="n">struct</span> <span class="ow">in</span> <span class="n">a</span> <span class="n">register</span><span class="o">.</span> <span class="n">This</span> <span class="n">field</span>
  <span class="o">///</span> <span class="n">holds</span> <span class="n">the</span> <span class="n">virtual</span> <span class="n">register</span> <span class="n">into</span> <span class="n">which</span> <span class="n">the</span> <span class="n">sret</span> <span class="n">argument</span> <span class="ow">is</span> <span class="n">passed</span><span class="o">.</span>
  <span class="n">unsigned</span> <span class="n">SRetReturnReg</span><span class="p">;</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span>  <span class="o">///</span> <span class="kc">True</span> <span class="k">if</span> <span class="n">function</span> <span class="n">has</span> <span class="n">a</span> <span class="n">byval</span> <span class="n">argument</span><span class="o">.</span>
  <span class="nb">bool</span> <span class="n">HasByvalArg</span><span class="p">;</span>

  <span class="o">///</span> <span class="n">Size</span> <span class="n">of</span> <span class="n">incoming</span> <span class="n">argument</span> <span class="n">area</span><span class="o">.</span>
  <span class="n">unsigned</span> <span class="n">IncomingArgSize</span><span class="p">;</span>

  <span class="o">///</span> <span class="n">CallsEhReturn</span> <span class="o">-</span> <span class="n">Whether</span> <span class="n">the</span> <span class="n">function</span> <span class="n">calls</span> <span class="n">llvm</span><span class="o">.</span><span class="n">eh</span><span class="o">.</span><span class="k">return</span><span class="o">.</span>
  <span class="nb">bool</span> <span class="n">CallsEhReturn</span><span class="p">;</span>

  <span class="o">///</span> <span class="n">CallsEhDwarf</span> <span class="o">-</span> <span class="n">Whether</span> <span class="n">the</span> <span class="n">function</span> <span class="n">calls</span> <span class="n">llvm</span><span class="o">.</span><span class="n">eh</span><span class="o">.</span><span class="n">dwarf</span><span class="o">.</span>
  <span class="nb">bool</span> <span class="n">CallsEhDwarf</span><span class="p">;</span>

  <span class="o">///</span> <span class="n">Frame</span> <span class="n">objects</span> <span class="k">for</span> <span class="n">spilling</span> <span class="n">eh</span> <span class="n">data</span> <span class="n">registers</span><span class="o">.</span>
  <span class="nb">int</span> <span class="n">EhDataRegFI</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
</pre></div>
</div>
<div class="highlight-c++"><div class="highlight"><pre><span></span><span class="p">}</span>
</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter3_4/Cpu0SEInstrInfo.h</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">//</span><span class="nd">@expandPostRAPseudo</span>
  <span class="nb">bool</span> <span class="n">expandPostRAPseudo</span><span class="p">(</span><span class="n">MachineInstr</span> <span class="o">&amp;</span><span class="n">MI</span><span class="p">)</span> <span class="n">const</span> <span class="n">override</span><span class="p">;</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">private</span><span class="p">:</span>
  <span class="n">void</span> <span class="n">expandRetLR</span><span class="p">(</span><span class="n">MachineBasicBlock</span> <span class="o">&amp;</span><span class="n">MBB</span><span class="p">,</span> <span class="n">MachineBasicBlock</span><span class="p">::</span><span class="n">iterator</span> <span class="n">I</span><span class="p">)</span> <span class="n">const</span><span class="p">;</span>
</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter3_4/Cpu0SEInstrInfo.cpp</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">//</span><span class="nd">@expandPostRAPseudo</span>
<span class="o">///</span> <span class="n">Expand</span> <span class="n">Pseudo</span> <span class="n">instructions</span> <span class="n">into</span> <span class="n">real</span> <span class="n">backend</span> <span class="n">instructions</span>
<span class="nb">bool</span> <span class="n">Cpu0SEInstrInfo</span><span class="p">::</span><span class="n">expandPostRAPseudo</span><span class="p">(</span><span class="n">MachineInstr</span> <span class="o">&amp;</span><span class="n">MI</span><span class="p">)</span> <span class="n">const</span> <span class="p">{</span>
<span class="o">//</span><span class="nd">@expandPostRAPseudo</span><span class="o">-</span><span class="n">body</span>
  <span class="n">MachineBasicBlock</span> <span class="o">&amp;</span><span class="n">MBB</span> <span class="o">=</span> <span class="o">*</span><span class="n">MI</span><span class="o">.</span><span class="n">getParent</span><span class="p">();</span>

  <span class="n">switch</span> <span class="p">(</span><span class="n">MI</span><span class="o">.</span><span class="n">getDesc</span><span class="p">()</span><span class="o">.</span><span class="n">getOpcode</span><span class="p">())</span> <span class="p">{</span>
  <span class="n">default</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">false</span><span class="p">;</span>
  <span class="n">case</span> <span class="n">Cpu0</span><span class="p">::</span><span class="n">RetLR</span><span class="p">:</span>
    <span class="n">expandRetLR</span><span class="p">(</span><span class="n">MBB</span><span class="p">,</span> <span class="n">MI</span><span class="p">);</span>
    <span class="k">break</span><span class="p">;</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span>  <span class="p">}</span>

  <span class="n">MBB</span><span class="o">.</span><span class="n">erase</span><span class="p">(</span><span class="n">MI</span><span class="p">);</span>
  <span class="k">return</span> <span class="n">true</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">void</span> <span class="n">Cpu0SEInstrInfo</span><span class="p">::</span><span class="n">expandRetLR</span><span class="p">(</span><span class="n">MachineBasicBlock</span> <span class="o">&amp;</span><span class="n">MBB</span><span class="p">,</span>
                                <span class="n">MachineBasicBlock</span><span class="p">::</span><span class="n">iterator</span> <span class="n">I</span><span class="p">)</span> <span class="n">const</span> <span class="p">{</span>
  <span class="n">BuildMI</span><span class="p">(</span><span class="n">MBB</span><span class="p">,</span> <span class="n">I</span><span class="p">,</span> <span class="n">I</span><span class="o">-&gt;</span><span class="n">getDebugLoc</span><span class="p">(),</span> <span class="n">get</span><span class="p">(</span><span class="n">Cpu0</span><span class="p">::</span><span class="n">RET</span><span class="p">))</span><span class="o">.</span><span class="n">addReg</span><span class="p">(</span><span class="n">Cpu0</span><span class="p">::</span><span class="n">LR</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Build Chapter3_4 and run with it, finding the error message in Chapter3_3 is
gone. The compile result will hang on and please press &#8220;ctrl+C&#8221; to abort
as follows,</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">118-165-78-230:input Jonathan$</span> clang -target mips-unknown-linux-gnu -c
<span class="go">ch3.cpp -emit-llvm -o ch3.bc</span>
<span class="gp">118-165-78-230:input Jonathan$</span> ~/llvm/test/cmake_debug_build/Debug/bin/llvm-dis
<span class="go">ch3.bc -o -</span>
<span class="go">...</span>
<span class="go">define i32 @main() #0 {</span>
<span class="gp">  %</span><span class="nv">1</span> <span class="o">=</span> alloca i32, align 4
<span class="go">  store i32 0, i32* %1</span>
<span class="go">  ret i32 0</span>
<span class="go">}</span>

<span class="gp">118-165-78-230:input Jonathan$</span> /Users/Jonathan/llvm/test/cmake_debug_build/
<span class="go">Debug/bin/llc -march=cpu0 -relocation-model=pic -filetype=asm ch3.bc -o -</span>
<span class="go">  ...</span>
<span class="go">  .text</span>
<span class="go">  .section .mdebug.abiO32</span>
<span class="go">  .previous</span>
<span class="go">  .file &quot;ch3.bc&quot;</span>
<span class="go">^C</span>
</pre></div>
</div>
<p>It hangs on because Cpu0 backend has not handled stack slot for local variables.
Instruction &#8220;store i32 0, i32* %1&#8221; in above IR need Cpu0 allocate a stack slot
and save to the stack slot.
However, the ch3.cpp can be run with option <code class="docutils literal"><span class="pre">clang</span> <span class="pre">-O2</span></code> as follows,</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">118-165-78-230:input Jonathan$</span> clang -O2 -target mips-unknown-linux-gnu -c
<span class="go">ch3.cpp -emit-llvm -o ch3.bc</span>
<span class="gp">118-165-78-230:input Jonathan$</span> ~/llvm/test/cmake_debug_build/Debug/bin/llvm-dis
<span class="go">ch3.bc -o -</span>
<span class="go">...</span>
<span class="go">define i32 @main() #0 {</span>
<span class="go">  ret i32 0</span>
<span class="go">}</span>

<span class="gp">118-165-78-230:input Jonathan$</span> /Users/Jonathan/llvm/test/cmake_debug_build/
<span class="go">Debug/bin/llc -march=cpu0 -relocation-model=pic -filetype=asm ch3.bc -o -</span>
<span class="go">  .text</span>
<span class="go">  .section .mdebug.abiO32</span>
<span class="go">  .previous</span>
<span class="go">  .file &quot;ch3.bc&quot;</span>
<span class="go">  .globl  main</span>
<span class="go">  .align  2</span>
<span class="go">  .type main,@function</span>
<span class="go">  .ent  main                    # @main</span>
<span class="go">main:</span>
<span class="go">  .frame  $sp,0,$lr</span>
<span class="go">  .mask   0x00000000,0</span>
<span class="go">  .set  noreorder</span>
<span class="go">  .set  nomacro</span>
<span class="gp">#</span> BB#0:
<span class="go">  addiu $2, $zero, 0</span>
<span class="go">  ret $lr</span>
<span class="go">  .set  macro</span>
<span class="go">  .set  reorder</span>
<span class="go">  .end  main</span>
<span class="gp">$</span>func_end0:
<span class="go">  .size main, ($func_end0)-main</span>
</pre></div>
</div>
<p>To see how the <strong>&#8216;DAG-&gt;DAG Pattern Instruction Selection&#8217;</strong> work in llc, let&#8217;s
compile with <code class="docutils literal"><span class="pre">llc</span> <span class="pre">-print-before-all</span> <span class="pre">-print-after-all</span></code> option and get the following result.
The DAGs which before and after instruction selection stage are shown as follows,</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">118-165-78-230:input Jonathan$</span> clang -O2 -target mips-unknown-linux-gnu -c
<span class="go">ch3.cpp -emit-llvm -o ch3.bc</span>
<span class="gp">118-165-78-12:input Jonathan$</span> /Users/Jonathan/llvm/test/cmake_debug_build/
<span class="go">Debug/bin/llc -march=cpu0 -relocation-model=pic -filetype=asm</span>
<span class="go">-print-before-all -print-after-all ch3.bc -o -</span>
<span class="go">...</span>
<span class="go">*** IR Dump After Module Verifier ***</span>
<span class="go">; Function Attrs: nounwind readnone</span>
<span class="go">define i32 @main() #0 {</span>
<span class="go">  ret i32 0</span>
<span class="go">}</span>
<span class="go">...</span>
<span class="go">Initial selection DAG: BB#0 &#39;main:&#39;</span>
<span class="go">SelectionDAG has 5 nodes:</span>
<span class="go">    t0: ch = EntryToken</span>
<span class="go">  t3: ch,glue = CopyToReg t0, Register:i32 %V0, Constant:i32&lt;0&gt;</span>
<span class="go">  t4: ch = Cpu0ISD::Ret t3, Register:i32 %V0, t3:1</span>
<span class="go">...</span>
<span class="go">===== Instruction selection begins: BB#0 &#39;&#39;</span>
<span class="go">Selecting: t4: ch = Cpu0ISD::Ret t3, Register:i32 %V0, t3:1</span>

<span class="go">ISEL: Starting pattern match on root node: t4: ch = Cpu0ISD::Ret t3, Register:i32 %V0, t3:1</span>

<span class="go">  Morphed node: t4: ch = RetLR Register:i32 %V0, t3, t3:1</span>

<span class="go">ISEL: Match complete!</span>
<span class="go">Selecting: t3: ch,glue = CopyToReg t0, Register:i32 %V0, Constant:i32&lt;0&gt;</span>

<span class="go">Selecting: t2: i32 = Register %V0</span>

<span class="go">Selecting: t1: i32 = Constant&lt;0&gt;</span>

<span class="go">ISEL: Starting pattern match on root node: t1: i32 = Constant&lt;0&gt;</span>

<span class="go">  Initial Opcode index to 3158</span>
<span class="go">  Morphed node: t1: i32 = ADDiu Register:i32 %ZERO, TargetConstant:i32&lt;0&gt;</span>

<span class="go">ISEL: Match complete!</span>
<span class="go">Selecting: t0: ch = EntryToken</span>

<span class="go">===== Instruction selection ends:</span>
<span class="go">Selected selection DAG: BB#0 &#39;main:&#39;</span>
<span class="go">SelectionDAG has 7 nodes:</span>
<span class="go">    t0: ch = EntryToken</span>
<span class="go">    t1: i32 = ADDiu Register:i32 %ZERO, TargetConstant:i32&lt;0&gt;</span>
<span class="go">  t3: ch,glue = CopyToReg t0, Register:i32 %V0, t1</span>
<span class="go">  t4: ch = RetLR Register:i32 %V0, t3, t3:1</span>
<span class="go">...</span>
<span class="go">********** REWRITE VIRTUAL REGISTERS **********</span>
<span class="go">********** Function: main</span>
<span class="go">********** REGISTER MAP **********</span>
<span class="go">[%vreg0 -&gt; %V0] GPROut</span>

<span class="go">0B  BB#0: derived from LLVM BB %0</span>
<span class="go">16B   %vreg0&lt;def&gt; = ADDiu %ZERO, 0; GPROut:%vreg0</span>
<span class="go">32B   %V0&lt;def&gt; = COPY %vreg0&lt;kill&gt;; GPROut:%vreg0</span>
<span class="go">48B   RetLR %V0&lt;imp-use&gt;</span>
<span class="gp">&gt;</span> %V0&lt;def&gt; <span class="o">=</span> ADDiu %ZERO, 0
<span class="gp">&gt;</span> %V0&lt;def&gt; <span class="o">=</span> COPY %V0&lt;kill&gt;
<span class="go">Identity copy: %V0&lt;def&gt; = COPY %V0&lt;kill&gt;</span>
<span class="go">  deleted.</span>
<span class="gp">&gt;</span> RetLR %V0&lt;imp-use&gt;
<span class="gp">#</span> *** IR Dump After Virtual Register Rewriter ***:
<span class="gp">#</span> Machine code <span class="k">for</span> <span class="k">function</span> main: Properties: &lt;Post SSA, tracking liveness, AllVRegsAllocated&gt;

<span class="go">0B  BB#0: derived from LLVM BB %0</span>
<span class="go">16B   %V0&lt;def&gt; = ADDiu %ZERO, 0</span>
<span class="go">48B   RetLR %V0&lt;imp-use&gt;</span>
<span class="go">...</span>
<span class="go">********** EXPANDING POST-RA PSEUDO INSTRS **********</span>
<span class="go">********** Function: main</span>
<span class="gp">#</span> *** IR Dump After Post-RA pseudo instruction expansion pass ***:
<span class="gp">#</span> Machine code <span class="k">for</span> <span class="k">function</span> main: Properties: &lt;Post SSA, tracking liveness, AllVRegsAllocated&gt;

<span class="go">BB#0: derived from LLVM BB %0</span>
<span class="gp">  %</span>V0&lt;def&gt; <span class="o">=</span> ADDiu %ZERO, 0
<span class="go">  RET %LR</span>
<span class="go">...</span>

<span class="go">  .globl  main</span>
<span class="go">  .p2align  2</span>
<span class="go">  .type main,@function</span>
<span class="go">  .ent  main                    # @main</span>
<span class="go">main:</span>
<span class="go">  .frame  $sp,0,$lr</span>
<span class="go">  .mask   0x00000000,0</span>
<span class="go">  .set  noreorder</span>
<span class="go">  .set  nomacro</span>
<span class="gp">#</span> BB#0:
<span class="go">  addiu $2, $zero, 0</span>
<span class="go">  ret $lr</span>
<span class="go">  .set  macro</span>
<span class="go">  .set  reorder</span>
<span class="go">  .end  main</span>
<span class="gp">$</span>func_end0:
<span class="go">  .size main, ($func_end0)-main</span>


<span class="go">  .ident  &quot;Apple LLVM version 7.0.0 (clang-700.1.76)&quot;</span>
<span class="go">  .section  &quot;.note.GNU-stack&quot;,&quot;&quot;,@progbits</span>
</pre></div>
</div>
<p>Summary above translation into Table: Chapter 3 .bc IR instructions.</p>
<table border="1" class="docutils" id="id7">
<caption><span class="caption-number">Table 10 </span><span class="caption-text">Chapter 3 .bc IR instructions</span><a class="headerlink" href="#id7" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="28%" />
<col width="33%" />
<col width="15%" />
<col width="7%" />
<col width="7%" />
<col width="10%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">.bc</th>
<th class="head">Lower</th>
<th class="head">ISel</th>
<th class="head">RVR</th>
<th class="head">Post-RA</th>
<th class="head">AsmP</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>constant 0</td>
<td>constant 0</td>
<td>ADDiu</td>
<td>ADDiu</td>
<td>ADDiu</td>
<td>addiu</td>
</tr>
<tr class="row-odd"><td>ret</td>
<td>Cpu0ISD::Ret</td>
<td>CopyToReg,RetLR</td>
<td>RetLR</td>
<td>RET</td>
<td>ret</td>
</tr>
</tbody>
</table>
<ul class="simple">
<li>Lower: Initial selection DAG (Cpu0ISelLowering.cpp, LowerReturn(...))</li>
<li>ISel: Instruction selection</li>
<li>RVR: REWRITE VIRTUAL REGISTERS, remove CopyToReg</li>
<li>AsmP: Cpu0 Asm Printer</li>
<li>Post-RA: Post-RA pseudo instruction expansion pass</li>
</ul>
<p>From above <code class="docutils literal"><span class="pre">llc</span> <span class="pre">-print-before-all</span> <span class="pre">-print-after-all</span></code> display, we see <strong>ret</strong> is translated into
<strong>Cpu0ISD::Ret</strong> in stage Optimized legalized selection DAG, and then
translated into Cpu0 instructions <strong>ret</strong> finally.
Since ret use <strong>constant 0</strong> (<strong>ret i32 0</strong> in this example), the
constant 0 will be translated into <strong>&#8220;addiu $2, $zero, 0&#8221;</strong> via the following
pattern defined in Cpu0InstrInfo.td.</p>
<p class="rubric">lbdex/chapters/Chapter2/Cpu0InstrInfo.td</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>// Small immediates
def : Pat&lt;(i32 immSExt16:$in),
          (ADDiu ZERO, imm:$in)&gt;;
</pre></div>
</div>
<p>In order to handle IR ret, these codes in Cpu0InstrInfo.td do things as below.</p>
<ol class="arabic simple">
<li>Declare a pseudo node Cpu0::RetLR to takes care the IR Cpu0ISD::Ret by the
following code,</li>
</ol>
<p class="rubric">lbdex/chapters/Chapter3_4/Cpu0InstrInfo.td</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">//</span> <span class="n">Return</span>
<span class="k">def</span> <span class="nf">Cpu0Ret</span> <span class="p">:</span> <span class="n">SDNode</span><span class="o">&lt;</span><span class="s2">&quot;Cpu0ISD::Ret&quot;</span><span class="p">,</span> <span class="n">SDTNone</span><span class="p">,</span>
                     <span class="p">[</span><span class="n">SDNPHasChain</span><span class="p">,</span> <span class="n">SDNPOptInGlue</span><span class="p">,</span> <span class="n">SDNPVariadic</span><span class="p">]</span><span class="o">&gt;</span><span class="p">;</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">let</span> <span class="n">Predicates</span> <span class="o">=</span> <span class="p">[</span><span class="n">Ch3_4</span><span class="p">]</span> <span class="ow">in</span> <span class="p">{</span>
<span class="n">let</span> <span class="n">isReturn</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">isTerminator</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">hasDelaySlot</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">isBarrier</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">hasCtrlDep</span><span class="o">=</span><span class="mi">1</span> <span class="ow">in</span>
  <span class="k">def</span> <span class="nf">RetLR</span> <span class="p">:</span> <span class="n">Cpu0Pseudo</span><span class="o">&lt;</span><span class="p">(</span><span class="n">outs</span><span class="p">),</span> <span class="p">(</span><span class="n">ins</span><span class="p">),</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="p">[(</span><span class="n">Cpu0Ret</span><span class="p">)]</span><span class="o">&gt;</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<ol class="arabic simple" start="2">
<li>Create Cpu0ISD::Ret node in LowerReturn() of Cpu0ISelLowering.cpp, which is
called when meets keyword of return in C. Remind, In LowerReturn() put
return value in register $2 ($v0).</li>
<li>After instruction selection, the Cpu0ISD::Ret is replaced by Cpu0::RetLR
as below. This effect come from &#8220;def RetLR&#8221; as step 1.</li>
</ol>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="go">===== Instruction selection begins: BB#0 &#39;entry&#39;</span>
<span class="go">Selecting: 0x1ea4050: ch = Cpu0ISD::Ret 0x1ea3f50, 0x1ea3e50,</span>
<span class="go">0x1ea3f50:1 [ID=27]</span>

<span class="go">ISEL: Starting pattern match on root node: 0x1ea4050: ch = Cpu0ISD::Ret</span>
<span class="go">0x1ea3f50, 0x1ea3e50, 0x1ea3f50:1 [ID=27]</span>

<span class="go">  Morphed node: 0x1ea4050: ch = RetLR 0x1ea3e50, 0x1ea3f50, 0x1ea3f50:1</span>
<span class="go">...</span>
<span class="go">ISEL: Match complete!</span>
<span class="go">=&gt; 0x1ea4050: ch = RetLR 0x1ea3e50, 0x1ea3f50, 0x1ea3f50:1</span>
<span class="go">...</span>
<span class="go">===== Instruction selection ends:</span>
<span class="go">Selected selection DAG: BB#0 &#39;main:entry&#39;</span>
<span class="go">SelectionDAG has 28 nodes:</span>
<span class="go">...</span>
<span class="go">    0x1ea3e50: &lt;multiple use&gt;</span>
<span class="go">    0x1ea3f50: &lt;multiple use&gt;</span>
<span class="go">    0x1ea3f50: &lt;multiple use&gt;</span>
<span class="go">  0x1ea4050: ch = RetLR 0x1ea3e50, 0x1ea3f50, 0x1ea3f50:1</span>
</pre></div>
</div>
<ol class="arabic simple" start="4">
<li>Expand the Cpu0ISD::RetLR into instruction Cpu0::RET $lr in &#8220;Post-RA pseudo
instruction expansion pass&#8221; stage by the code in Chapter3_4/Cpu0SEInstrInfo.cpp
as above. This stage come after the register allocation, so we can replace the
V0 ($r2) by LR ($lr) without any side effect.</li>
<li>Print assembly or obj according the information of *.inc generated by
TableGen from *.td as the following at &#8220;Cpu0 Assembly Print&#8221; stage.</li>
</ol>
<p class="rubric">lbdex/chapters/Chapter2/Cpu0InstrInfo.td</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>//@JumpFR {
let isBranch=1, isTerminator=1, isBarrier=1, imm16=0, hasDelaySlot = 1,
    isIndirectBranch = 1 in
class JumpFR&lt;bits&lt;8&gt; op, string instr_asm, RegisterClass RC&gt;:
  FL&lt;op, (outs), (ins RC:$ra),
     !strconcat(instr_asm, &quot;\t$ra&quot;), [(brind RC:$ra)], IIBranch&gt; {
  let rb = 0;
  let imm16 = 0;
</pre></div>
</div>
<div class="highlight-c++"><div class="highlight"><pre><span></span><span class="p">}</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">RET</span>     <span class="p">:</span> <span class="n">RetBase</span><span class="o">&lt;</span><span class="n">GPROut</span><span class="o">&gt;</span><span class="p">;</span>
</pre></div>
</div>
<table border="1" class="docutils" id="id8">
<caption><span class="caption-number">Table 11 </span><span class="caption-text">Handle return register lr</span><a class="headerlink" href="#id8" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="56%" />
<col width="44%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Stage</th>
<th class="head">Function</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>Write Code</td>
<td>Declare a pseudo node Cpu0::RetLR</td>
</tr>
<tr class="row-odd"><td><ul class="first last simple">
<li></li>
</ul>
</td>
<td>for IR Cpu0::Ret;</td>
</tr>
<tr class="row-even"><td>Before CPU0 DAG-&gt;DAG Pattern Instruction Selection</td>
<td>Create Cpu0ISD::Ret DAG</td>
</tr>
<tr class="row-odd"><td>Instruction selection</td>
<td>Cpu0::Ret is replaced by Cpu0::RetLR</td>
</tr>
<tr class="row-even"><td>Post-RA pseudo instruction expansion pass</td>
<td>Cpu0::RetLR -&gt; Cpu0::RET $lr</td>
</tr>
<tr class="row-odd"><td>Cpu0 Assembly Printer</td>
<td>Print according &#8220;def RET&#8221;</td>
</tr>
</tbody>
</table>
<p>Function LowerReturn() of Cpu0ISelLowering.cpp handle return variable correctly.
Chapter3_4/Cpu0ISelLowering.cpp create Cpu0ISD::Ret node in LowerReturn() which
is called by llvm system when it meets C&#8217;s keyword of return.
More specificly, it creates DAGs (Cpu0ISD::Ret (CopyToReg %X, %V0, %Y), %V0,
Flag). Since the the
V0 register is assigned in CopyToReg and Cpu0ISD::Ret use V0, the CopyToReg
with V0 register will live out and won&#8217;t be removed at any later optimization
steps. Remember, if use &#8220;return DAG.getNode(Cpu0ISD::Ret, DL, MVT::Other,
Chain, DAG.getRegister(Cpu0::LR, MVT::i32));&#8221; instead of &#8220;return DAG.getNode
(Cpu0ISD::Ret, DL, MVT::Other, &amp;RetOps[0], RetOps.size());&#8221; then the V0 register
won&#8217;t be live out, and the previous DAG (CopyToReg %X, %V0, %Y) will be removed
at later optimization steps. It ending with the return value is error.</p>
</div>
<div class="section" id="add-prologue-epilogue-functions">
<h2><a class="toc-backref" href="#id18">Add Prologue/Epilogue functions</a><a class="headerlink" href="#add-prologue-epilogue-functions" title="Permalink to this headline">¶</a></h2>
<div class="section" id="concept">
<h3><a class="toc-backref" href="#id19">Concept</a><a class="headerlink" href="#concept" title="Permalink to this headline">¶</a></h3>
<p>Following come from tricore_llvm.pdf section “4.4.2 Non-static Register
Information ”.</p>
<p>For some target architectures, some aspects of the target architecture’s
register set are dependent upon variable factors and have to be determined at
runtime.
As a consequence, they cannot be generated statically from a TableGen
description – although that would be possible for the bulk of them in the case
of the TriCore backend.
Among them are the following points:</p>
<ul class="simple">
<li>Callee-saved registers. Normally, the ABI specifies a set of registers that a
function must save on entry and restore on return if their contents are
possibly modified during execution.</li>
<li>Reserved registers. Although the set of unavailable registers is already
defined in the TableGen file, TriCoreRegisterInfo contains a method that marks
all non-allocatable register numbers in a bit vector.</li>
</ul>
<p>The following methods are implemented:</p>
<ul class="simple">
<li>emitPrologue() inserts prologue code at the beginning of a function. Thanks
to TriCore’s context model, this is a trivial task as it is not required to
save any registers manually. The only thing that has to be done is reserving
space for the function’s stack frame by decrementing the stack pointer.
In addition, if the function needs a frame pointer, the frame register %a14 is
set to the old value of the stack pointer beforehand.</li>
<li>emitEpilogue() is intended to emit instructions to destroy the stack frame
and restore all previously saved registers before returning from a function.
However, as %a10 (stack pointer), %a11 (return address), and %a14 (frame
pointer, if any) are all part of the upper context, no epilogue code is needed
at all. All cleanup operations are performed implicitly by the ret instruction.</li>
<li>eliminateFrameIndex() is called for each instruction that references a word
of data in a stack slot. All previous passes of the code generator have been
addressing stack slots through an abstract frame index and an immediate offset.
The purpose of this function is to translate such a reference into a
register–offset pair. Depending on whether the machine function that contains
the instruction has a fixed or a variable stack frame, either the stack pointer
%a10 or the frame pointer %a14 is used as the base register.
The offset is computed accordingly.
<a class="reference internal" href="#backendstructure-f10"><span class="std std-numref">Fig. 17</span></a> demonstrates for both cases how a stack slot
is addressed.</li>
</ul>
<p>If the addressing mode of the affected instruction cannot handle the address
because the offset is too large (the offset field has 10 bits for the BO
addressing mode and 16 bits for the BOL mode), a sequence of instructions is
emitted that explicitly computes the effective address.
Interim results are put into an unused address register.
If none is available, an already occupied address register is scavenged.
For this purpose, LLVM’s framework offers a class named RegScavenger that
takes care of all the details.</p>
<div class="figure align-center" id="id9">
<span id="backendstructure-f10"></span><img alt="_images/10.png" src="_images/10.png" />
<p class="caption"><span class="caption-number">Fig. 17 </span><span class="caption-text">Addressing of a variable a located on the stack.
If the stack frame has a variable size, slot must be addressed relative to
the frame pointer</span></p>
</div>
</div>
<div class="section" id="prologue-and-epilogue-functions">
<h3><a class="toc-backref" href="#id20">Prologue and Epilogue functions</a><a class="headerlink" href="#prologue-and-epilogue-functions" title="Permalink to this headline">¶</a></h3>
<p>The Prologue and Epilogue functions as follows,</p>
<p class="rubric">lbdex/chapters/Chapter3_5/Cpu0SEFrameLowering.cpp</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>void Cpu0SEFrameLowering::emitPrologue(MachineFunction &amp;MF,
                                       MachineBasicBlock &amp;MBB) const {
  assert(&amp;MF.front() == &amp;MBB &amp;&amp; &quot;Shrink-wrapping not yet supported&quot;);
  MachineFrameInfo *MFI    = MF.getFrameInfo();
  Cpu0FunctionInfo *Cpu0FI = MF.getInfo&lt;Cpu0FunctionInfo&gt;();

  const Cpu0SEInstrInfo &amp;TII =
    *static_cast&lt;const Cpu0SEInstrInfo*&gt;(STI.getInstrInfo());
  const Cpu0RegisterInfo &amp;RegInfo =
      *static_cast&lt;const Cpu0RegisterInfo *&gt;(STI.getRegisterInfo());

  MachineBasicBlock::iterator MBBI = MBB.begin();
  DebugLoc dl = MBBI != MBB.end() ? MBBI-&gt;getDebugLoc() : DebugLoc();
  Cpu0ABIInfo ABI = STI.getABI();
  unsigned SP = Cpu0::SP;
  const TargetRegisterClass *RC = &amp;Cpu0::GPROutRegClass;

  // First, compute final stack size.
  uint64_t StackSize = MFI-&gt;getStackSize();

  // No need to allocate space on the stack.
  if (StackSize == 0 &amp;&amp; !MFI-&gt;adjustsStack()) return;

  MachineModuleInfo &amp;MMI = MF.getMMI();
  const MCRegisterInfo *MRI = MMI.getContext().getRegisterInfo();
  MachineLocation DstML, SrcML;

  // Adjust stack.
  TII.adjustStackPtr(SP, -StackSize, MBB, MBBI);

  // emit &quot;.cfi_def_cfa_offset StackSize&quot;
  unsigned CFIIndex = MMI.addFrameInst(
      MCCFIInstruction::createDefCfaOffset(nullptr, -StackSize));
  BuildMI(MBB, MBBI, dl, TII.get(TargetOpcode::CFI_INSTRUCTION))
      .addCFIIndex(CFIIndex);

  const std::vector&lt;CalleeSavedInfo&gt; &amp;CSI = MFI-&gt;getCalleeSavedInfo();

  if (CSI.size()) {
    // Find the instruction past the last instruction that saves a callee-saved
    // register to the stack.
    for (unsigned i = 0; i &lt; CSI.size(); ++i)
      ++MBBI;

    // Iterate over list of callee-saved registers and emit .cfi_offset
    // directives.
    for (std::vector&lt;CalleeSavedInfo&gt;::const_iterator I = CSI.begin(),
           E = CSI.end(); I != E; ++I) {
      int64_t Offset = MFI-&gt;getObjectOffset(I-&gt;getFrameIdx());
      unsigned Reg = I-&gt;getReg();
      {
        // Reg is in CPURegs.
        unsigned CFIIndex = MMI.addFrameInst(MCCFIInstruction::createOffset(
            nullptr, MRI-&gt;getDwarfRegNum(Reg, 1), Offset));
        BuildMI(MBB, MBBI, dl, TII.get(TargetOpcode::CFI_INSTRUCTION))
            .addCFIIndex(CFIIndex);
      }
    }
  }

}
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span>void Cpu0SEFrameLowering::emitEpilogue(MachineFunction &amp;MF,
                                 MachineBasicBlock &amp;MBB) const {
  MachineBasicBlock::iterator MBBI = MBB.getLastNonDebugInstr();
  MachineFrameInfo *MFI            = MF.getFrameInfo();
  Cpu0FunctionInfo *Cpu0FI = MF.getInfo&lt;Cpu0FunctionInfo&gt;();

  const Cpu0SEInstrInfo &amp;TII =
      *static_cast&lt;const Cpu0SEInstrInfo *&gt;(STI.getInstrInfo());
  const Cpu0RegisterInfo &amp;RegInfo =
      *static_cast&lt;const Cpu0RegisterInfo *&gt;(STI.getRegisterInfo());

  DebugLoc dl = MBBI-&gt;getDebugLoc();
  Cpu0ABIInfo ABI = STI.getABI();
  unsigned SP = Cpu0::SP;

  // Get the number of bytes from FrameInfo
  uint64_t StackSize = MFI-&gt;getStackSize();

  if (!StackSize)
    return;

  // Adjust stack.
  TII.adjustStackPtr(SP, StackSize, MBB, MBBI);
}
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span>bool
Cpu0SEFrameLowering::hasReservedCallFrame(const MachineFunction &amp;MF) const {
  const MachineFrameInfo *MFI = MF.getFrameInfo();

  // Reserve call frame if the size of the maximum call frame fits into 16-bit
  // immediate field and there are no variable sized objects on the stack.
  // Make sure the second register scavenger spill slot can be accessed with one
  // instruction.
  return isInt&lt;16&gt;(MFI-&gt;getMaxCallFrameSize() + getStackAlignment()) &amp;&amp;
    !MFI-&gt;hasVarSizedObjects();
}
</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter3_5/Cpu0MachineFunction.h</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>  <span class="n">unsigned</span> <span class="n">getIncomingArgSize</span><span class="p">()</span> <span class="n">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">IncomingArgSize</span><span class="p">;</span> <span class="p">}</span>

  <span class="nb">bool</span> <span class="n">callsEhReturn</span><span class="p">()</span> <span class="n">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">CallsEhReturn</span><span class="p">;</span> <span class="p">}</span>
  <span class="n">void</span> <span class="n">setCallsEhReturn</span><span class="p">()</span> <span class="p">{</span> <span class="n">CallsEhReturn</span> <span class="o">=</span> <span class="n">true</span><span class="p">;</span> <span class="p">}</span>

  <span class="nb">bool</span> <span class="n">callsEhDwarf</span><span class="p">()</span> <span class="n">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">CallsEhDwarf</span><span class="p">;</span> <span class="p">}</span>
  <span class="n">void</span> <span class="n">setCallsEhDwarf</span><span class="p">()</span> <span class="p">{</span> <span class="n">CallsEhDwarf</span> <span class="o">=</span> <span class="n">true</span><span class="p">;</span> <span class="p">}</span>

  <span class="n">void</span> <span class="n">createEhDataRegsFI</span><span class="p">();</span>
  <span class="nb">int</span> <span class="n">getEhDataRegFI</span><span class="p">(</span><span class="n">unsigned</span> <span class="n">Reg</span><span class="p">)</span> <span class="n">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">EhDataRegFI</span><span class="p">[</span><span class="n">Reg</span><span class="p">];</span> <span class="p">}</span>

  <span class="n">unsigned</span> <span class="n">getMaxCallFrameSize</span><span class="p">()</span> <span class="n">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">MaxCallFrameSize</span><span class="p">;</span> <span class="p">}</span>
  <span class="n">void</span> <span class="n">setMaxCallFrameSize</span><span class="p">(</span><span class="n">unsigned</span> <span class="n">S</span><span class="p">)</span> <span class="p">{</span> <span class="n">MaxCallFrameSize</span> <span class="o">=</span> <span class="n">S</span><span class="p">;</span> <span class="p">}</span>
</pre></div>
</div>
<p>Now we explain the Prologue and Epilogue further by example code.
For the following llvm IR code of ch3.cpp, Chapter3_5 of Cpu0 backend will emit
the corresponding machine instructions as follows,</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">118-165-78-230:input Jonathan$</span> clang -target mips-unknown-linux-gnu -c
<span class="go">ch3.cpp -emit-llvm -o ch3.bc</span>
<span class="gp">118-165-78-230:input Jonathan$</span> ~/llvm/test/cmake_debug_build/Debug/bin/llvm-dis
<span class="go">ch3.bc -o -</span>
<span class="go">...</span>
<span class="go">define i32 @main() #0 {</span>
<span class="gp">  %</span><span class="nv">1</span> <span class="o">=</span> alloca i32, align 4
<span class="go">  store i32 0, i32* %1</span>
<span class="go">  ret i32 0</span>
<span class="go">}</span>

<span class="gp">118-165-78-230:input Jonathan$</span> /Users/Jonathan/llvm/test/cmake_debug_build/
<span class="go">Debug/bin/llc -march=cpu0 -relocation-model=pic -filetype=asm ch3.bc -o -</span>
<span class="go">  ...</span>
<span class="go">  .section .mdebug.abi32</span>
<span class="go">  .previous</span>
<span class="go">  .file &quot;ch3.bc&quot;</span>
<span class="go">  .text</span>
<span class="go">  .globl  main//static void expandLargeImm\\n</span>
<span class="go">  .align  2</span>
<span class="go">  .type main,@function</span>
<span class="go">  .ent  main                    # @main</span>
<span class="go">main:</span>
<span class="go">  .cfi_startproc</span>
<span class="go">  .frame  $sp,8,$lr</span>
<span class="go">  .mask   0x00000000,0</span>
<span class="go">  .set  noreorder</span>
<span class="go">  .set  nomacro</span>
<span class="gp">#</span> BB#0:
<span class="go">  addiu $sp, $sp, -8</span>
<span class="gp">$</span>tmp1:
<span class="go">  .cfi_def_cfa_offset 8</span>
<span class="go">  addiu $2, $zero, 0</span>
<span class="go">  st  $2, 4($sp)</span>
<span class="go">  addiu $sp, $sp, 8</span>
<span class="go">  ret $lr</span>
<span class="go">  .set  macro</span>
<span class="go">  .set  reorder</span>
<span class="go">  .end  main</span>
<span class="gp">$</span>tmp2:
<span class="go">  .size main, ($tmp2)-main</span>
<span class="go">  .cfi_endproc</span>
</pre></div>
</div>
<p>LLVM get the stack size by counting how many virtual registers is assigned to
local variables.
After that, it calls emitPrologue().</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>  <span class="n">virtual</span> <span class="n">void</span> <span class="n">adjustStackPtr</span><span class="p">(</span><span class="n">unsigned</span> <span class="n">SP</span><span class="p">,</span> <span class="n">int64_t</span> <span class="n">Amount</span><span class="p">,</span>
                              <span class="n">MachineBasicBlock</span> <span class="o">&amp;</span><span class="n">MBB</span><span class="p">,</span>
                              <span class="n">MachineBasicBlock</span><span class="p">::</span><span class="n">iterator</span> <span class="n">I</span><span class="p">)</span> <span class="n">const</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter3_5/Cpu0SEInstrInfo.h</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>  <span class="o">///</span> <span class="n">Adjust</span> <span class="n">SP</span> <span class="n">by</span> <span class="n">Amount</span> <span class="nb">bytes</span><span class="o">.</span>
  <span class="n">void</span> <span class="n">adjustStackPtr</span><span class="p">(</span><span class="n">unsigned</span> <span class="n">SP</span><span class="p">,</span> <span class="n">int64_t</span> <span class="n">Amount</span><span class="p">,</span> <span class="n">MachineBasicBlock</span> <span class="o">&amp;</span><span class="n">MBB</span><span class="p">,</span>
                      <span class="n">MachineBasicBlock</span><span class="p">::</span><span class="n">iterator</span> <span class="n">I</span><span class="p">)</span> <span class="n">const</span> <span class="n">override</span><span class="p">;</span>

  <span class="o">///</span> <span class="n">Emit</span> <span class="n">a</span> <span class="n">series</span> <span class="n">of</span> <span class="n">instructions</span> <span class="n">to</span> <span class="n">load</span> <span class="n">an</span> <span class="n">immediate</span><span class="o">.</span> <span class="n">If</span> <span class="n">NewImm</span> <span class="ow">is</span> <span class="n">a</span>
  <span class="o">///</span> <span class="n">non</span><span class="o">-</span><span class="n">NULL</span> <span class="n">parameter</span><span class="p">,</span> <span class="n">the</span> <span class="n">last</span> <span class="n">instruction</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">emitted</span><span class="p">,</span> <span class="n">but</span> <span class="n">instead</span>
  <span class="o">///</span> <span class="n">its</span> <span class="n">immediate</span> <span class="n">operand</span> <span class="ow">is</span> <span class="n">returned</span> <span class="ow">in</span> <span class="n">NewImm</span><span class="o">.</span>
  <span class="n">unsigned</span> <span class="n">loadImmediate</span><span class="p">(</span><span class="n">int64_t</span> <span class="n">Imm</span><span class="p">,</span> <span class="n">MachineBasicBlock</span> <span class="o">&amp;</span><span class="n">MBB</span><span class="p">,</span>
                         <span class="n">MachineBasicBlock</span><span class="p">::</span><span class="n">iterator</span> <span class="n">II</span><span class="p">,</span> <span class="n">const</span> <span class="n">DebugLoc</span> <span class="o">&amp;</span><span class="n">DL</span><span class="p">,</span>
                         <span class="n">unsigned</span> <span class="o">*</span><span class="n">NewImm</span><span class="p">)</span> <span class="n">const</span><span class="p">;</span>
</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter3_5/Cpu0SEInstrInfo.cpp</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>/// Adjust SP by Amount bytes.
void Cpu0SEInstrInfo::adjustStackPtr(unsigned SP, int64_t Amount,
                                     MachineBasicBlock &amp;MBB,
                                     MachineBasicBlock::iterator I) const {
  DebugLoc DL = I != MBB.end() ? I-&gt;getDebugLoc() : DebugLoc();
  unsigned ADDu = Cpu0::ADDu;
  unsigned ADDiu = Cpu0::ADDiu;

  if (isInt&lt;16&gt;(Amount)) {
    // addiu sp, sp, amount
    BuildMI(MBB, I, DL, get(ADDiu), SP).addReg(SP).addImm(Amount);
  }
  else { // Expand immediate that doesn&#39;t fit in 16-bit.
    unsigned Reg = loadImmediate(Amount, MBB, I, DL, nullptr);
    BuildMI(MBB, I, DL, get(ADDu), SP).addReg(SP).addReg(Reg, RegState::Kill);
  }
}

/// This function generates the sequence of instructions needed to get the
/// result of adding register REG and immediate IMM.
unsigned
Cpu0SEInstrInfo::loadImmediate(int64_t Imm, MachineBasicBlock &amp;MBB,
                               MachineBasicBlock::iterator II,
                               const DebugLoc &amp;DL,
                               unsigned *NewImm) const {
  Cpu0AnalyzeImmediate AnalyzeImm;
  unsigned Size = 32;
  unsigned LUi = Cpu0::LUi;
  unsigned ZEROReg = Cpu0::ZERO;
  unsigned ATReg = Cpu0::AT;
  bool LastInstrIsADDiu = NewImm;

  const Cpu0AnalyzeImmediate::InstSeq &amp;Seq =
    AnalyzeImm.Analyze(Imm, Size, LastInstrIsADDiu);
  Cpu0AnalyzeImmediate::InstSeq::const_iterator Inst = Seq.begin();

  assert(Seq.size() &amp;&amp; (!LastInstrIsADDiu || (Seq.size() &gt; 1)));

  // The first instruction can be a LUi, which is different from other
  // instructions (ADDiu, ORI and SLL) in that it does not have a register
  // operand.
  if (Inst-&gt;Opc == LUi)
    BuildMI(MBB, II, DL, get(LUi), ATReg).addImm(SignExtend64&lt;16&gt;(Inst-&gt;ImmOpnd));
  else
    BuildMI(MBB, II, DL, get(Inst-&gt;Opc), ATReg).addReg(ZEROReg)
      .addImm(SignExtend64&lt;16&gt;(Inst-&gt;ImmOpnd));

  // Build the remaining instructions in Seq.
  for (++Inst; Inst != Seq.end() - LastInstrIsADDiu; ++Inst)
    BuildMI(MBB, II, DL, get(Inst-&gt;Opc), ATReg).addReg(ATReg)
      .addImm(SignExtend64&lt;16&gt;(Inst-&gt;ImmOpnd));

  if (LastInstrIsADDiu)
    *NewImm = Inst-&gt;ImmOpnd;

  return ATReg;
}
</pre></div>
</div>
<p>In emitPrologue(), it emits machine instructions to adjust sp (stack pointer
register) for local variables.
For our example, it will emit the instruction,</p>
<div class="code c++ highlight-default"><div class="highlight"><pre><span></span>addiu $sp, $sp, -8
</pre></div>
</div>
<p>The emitEpilogue() will emit “addiu  $sp, $sp, 8”, where 8 is the stack size.</p>
<p>In above ch3.cpp assembly output, it generates &#8220;addiu $2, $zero, 0&#8221; rather than
&#8220;ori $2, $zero, 0&#8221; because ADDiu defined before ORi as following, so it takes the
priority. Of course, if the ORi is defined first, the it will translate into
&#8220;ori&#8221; instruction.</p>
<p class="rubric">lbdex/chapters/Chapter2/Cpu0InstrInfo.td</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>// Small immediates
def : Pat&lt;(i32 immSExt16:$in),
          (ADDiu ZERO, imm:$in)&gt;;
</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter3_5/Cpu0InstrInfo.td</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>let Predicates = [Ch3_5] in {
def : Pat&lt;(i32 immZExt16:$in),
          (ORi ZERO, imm:$in)&gt;;
def : Pat&lt;(i32 immLow16Zero:$in),
          (LUi (HI16 imm:$in))&gt;;

// Arbitrary immediates
def : Pat&lt;(i32 imm:$imm),
          (ORi (LUi (HI16 imm:$imm)), (LO16 imm:$imm))&gt;;
} // let Predicates = [Ch3_4]
</pre></div>
</div>
</div>
<div class="section" id="handle-stack-slot-for-local-variables">
<h3><a class="toc-backref" href="#id21">Handle stack slot for local variables</a><a class="headerlink" href="#handle-stack-slot-for-local-variables" title="Permalink to this headline">¶</a></h3>
<p>The following code handle the stack slot for local variables.</p>
<p class="rubric">lbdex/chapters/Chapter3_5/Cpu0RegisterInfo.cpp</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>//- If no eliminateFrameIndex(), it will hang on run. 
// pure virtual method
// FrameIndex represent objects inside a abstract stack.
// We must replace FrameIndex with an stack/frame pointer
// direct reference.
void Cpu0RegisterInfo::
eliminateFrameIndex(MachineBasicBlock::iterator II, int SPAdj,
                    unsigned FIOperandNum, RegScavenger *RS) const {
  MachineInstr &amp;MI = *II;
  MachineFunction &amp;MF = *MI.getParent()-&gt;getParent();
  MachineFrameInfo *MFI = MF.getFrameInfo();
  Cpu0FunctionInfo *Cpu0FI = MF.getInfo&lt;Cpu0FunctionInfo&gt;();

  unsigned i = 0;
  while (!MI.getOperand(i).isFI()) {
    ++i;
    assert(i &lt; MI.getNumOperands() &amp;&amp;
           &quot;Instr doesn&#39;t have FrameIndex operand!&quot;);
  }

  DEBUG(errs() &lt;&lt; &quot;\nFunction : &quot; &lt;&lt; MF.getFunction()-&gt;getName() &lt;&lt; &quot;\n&quot;;
        errs() &lt;&lt; &quot;&lt;---------&gt;\n&quot; &lt;&lt; MI);

  int FrameIndex = MI.getOperand(i).getIndex();
  uint64_t stackSize = MF.getFrameInfo()-&gt;getStackSize();
  int64_t spOffset = MF.getFrameInfo()-&gt;getObjectOffset(FrameIndex);

  DEBUG(errs() &lt;&lt; &quot;FrameIndex : &quot; &lt;&lt; FrameIndex &lt;&lt; &quot;\n&quot;
               &lt;&lt; &quot;spOffset   : &quot; &lt;&lt; spOffset &lt;&lt; &quot;\n&quot;
               &lt;&lt; &quot;stackSize  : &quot; &lt;&lt; stackSize &lt;&lt; &quot;\n&quot;);

  const std::vector&lt;CalleeSavedInfo&gt; &amp;CSI = MFI-&gt;getCalleeSavedInfo();
  int MinCSFI = 0;
  int MaxCSFI = -1;

  if (CSI.size()) {
    MinCSFI = CSI[0].getFrameIdx();
    MaxCSFI = CSI[CSI.size() - 1].getFrameIdx();
  }

  // The following stack frame objects are always referenced relative to $sp:
  //  1. Outgoing arguments.
  //  2. Pointer to dynamically allocated stack space.
  //  3. Locations for callee-saved registers.
  // Everything else is referenced relative to whatever register
  // getFrameRegister() returns.
  unsigned FrameReg;

  FrameReg = Cpu0::SP;

  // Calculate final offset.
  // - There is no need to change the offset if the frame object is one of the
  //   following: an outgoing argument, pointer to a dynamically allocated
  //   stack space or a $gp restore location,
  // - If the frame object is any of the following, its offset must be adjusted
  //   by adding the size of the stack:
  //   incoming argument, callee-saved register location or local variable.
  int64_t Offset;
    Offset = spOffset + (int64_t)stackSize;

  Offset    += MI.getOperand(i+1).getImm();

  DEBUG(errs() &lt;&lt; &quot;Offset     : &quot; &lt;&lt; Offset &lt;&lt; &quot;\n&quot; &lt;&lt; &quot;&lt;---------&gt;\n&quot;);

  // If MI is not a debug value, make sure Offset fits in the 16-bit immediate
  // field.
  if (!MI.isDebugValue() &amp;&amp; !isInt&lt;16&gt;(Offset)) {
	assert(&quot;(!MI.isDebugValue() &amp;&amp; !isInt&lt;16&gt;(Offset))&quot;);
  }

  MI.getOperand(i).ChangeToRegister(FrameReg, false);
  MI.getOperand(i+1).ChangeToImmediate(Offset);
}
</pre></div>
</div>
<p>The eliminateFrameIndex() of Cpu0RegisterInfo.cpp is called after stages
&#8220;instruction selection&#8221; and &#8220;registers allocated&#8221;.
It translates frame index to correct offset of stack pointer by
&#8220;spOffset = MF.getFrameInfo()-&gt;getObjectOffset(FrameIndex);&#8221;.
For instance of ch3.cpp, displaying the offset calculating as follows,</p>
<div class="code c++ highlight-default"><div class="highlight"><pre><span></span>Spilling live registers at end of block.
BB#0: derived from LLVM BB %0
      %V0&lt;def&gt; = ADDiu %ZERO, 0
      ST %V0, &lt;fi#0&gt;, 0; mem:ST4[%1]
      RetLR %V0&lt;imp-use,kill&gt;
alloc FI(0) at SP[-4]

Function : main
&lt;---------&gt;
ST %V0, &lt;fi#0&gt;, 0; mem:ST4[%1]
FrameIndex : 0
spOffset   : -4
stackSize  : 8
Offset     : 4
&lt;---------&gt;
  ...
  .file &quot;ch3.bc&quot;
  ...
  .frame  $sp,8,$lr
  ...
# BB#0:
  addiu $sp, $sp, -8
$tmp1:
  .cfi_def_cfa_offset 8
  addiu $2, $zero, 0
  st  $2, 4($sp)
  ...
</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter3_5/Cpu0SEFrameLowering.cpp</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">//</span> <span class="n">This</span> <span class="n">method</span> <span class="ow">is</span> <span class="n">called</span> <span class="n">immediately</span> <span class="n">before</span> <span class="n">PrologEpilogInserter</span> <span class="n">scans</span> <span class="n">the</span> 
<span class="o">//</span>  <span class="n">physical</span> <span class="n">registers</span> <span class="n">used</span> <span class="n">to</span> <span class="n">determine</span> <span class="n">what</span> <span class="n">callee</span> <span class="n">saved</span> <span class="n">registers</span> <span class="n">should</span> <span class="n">be</span> 
<span class="o">//</span>  <span class="n">spilled</span><span class="o">.</span> <span class="n">This</span> <span class="n">method</span> <span class="ow">is</span> <span class="n">optional</span><span class="o">.</span> 
<span class="n">void</span> <span class="n">Cpu0SEFrameLowering</span><span class="p">::</span><span class="n">determineCalleeSaves</span><span class="p">(</span><span class="n">MachineFunction</span> <span class="o">&amp;</span><span class="n">MF</span><span class="p">,</span>
                                               <span class="n">BitVector</span> <span class="o">&amp;</span><span class="n">SavedRegs</span><span class="p">,</span>
                                               <span class="n">RegScavenger</span> <span class="o">*</span><span class="n">RS</span><span class="p">)</span> <span class="n">const</span> <span class="p">{</span>
<span class="o">//</span><span class="nd">@determineCalleeSaves</span><span class="o">-</span><span class="n">body</span>
  <span class="n">TargetFrameLowering</span><span class="p">::</span><span class="n">determineCalleeSaves</span><span class="p">(</span><span class="n">MF</span><span class="p">,</span> <span class="n">SavedRegs</span><span class="p">,</span> <span class="n">RS</span><span class="p">);</span>
  <span class="n">Cpu0FunctionInfo</span> <span class="o">*</span><span class="n">Cpu0FI</span> <span class="o">=</span> <span class="n">MF</span><span class="o">.</span><span class="n">getInfo</span><span class="o">&lt;</span><span class="n">Cpu0FunctionInfo</span><span class="o">&gt;</span><span class="p">();</span>
  <span class="n">MachineRegisterInfo</span><span class="o">&amp;</span> <span class="n">MRI</span> <span class="o">=</span> <span class="n">MF</span><span class="o">.</span><span class="n">getRegInfo</span><span class="p">();</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">MF</span><span class="o">.</span><span class="n">getFrameInfo</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">hasCalls</span><span class="p">())</span>
    <span class="n">setAliasRegs</span><span class="p">(</span><span class="n">MF</span><span class="p">,</span> <span class="n">SavedRegs</span><span class="p">,</span> <span class="n">Cpu0</span><span class="p">::</span><span class="n">LR</span><span class="p">);</span>

  <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The determineCalleeSaves() of Cpu0SEFrameLowering.cpp as above determine the
spill registers. Once the spill registers are determined, the function
SpillCalleeSavedRegisters() will save/restore registers to/from stack slots via the
following code.</p>
<p class="rubric">lbdex/chapters/Chapter3_5/Cpu0InstrInfo.h</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>  <span class="n">void</span> <span class="n">storeRegToStackSlot</span><span class="p">(</span><span class="n">MachineBasicBlock</span> <span class="o">&amp;</span><span class="n">MBB</span><span class="p">,</span>
                           <span class="n">MachineBasicBlock</span><span class="p">::</span><span class="n">iterator</span> <span class="n">MBBI</span><span class="p">,</span>
                           <span class="n">unsigned</span> <span class="n">SrcReg</span><span class="p">,</span> <span class="nb">bool</span> <span class="n">isKill</span><span class="p">,</span> <span class="nb">int</span> <span class="n">FrameIndex</span><span class="p">,</span>
                           <span class="n">const</span> <span class="n">TargetRegisterClass</span> <span class="o">*</span><span class="n">RC</span><span class="p">,</span>
                           <span class="n">const</span> <span class="n">TargetRegisterInfo</span> <span class="o">*</span><span class="n">TRI</span><span class="p">)</span> <span class="n">const</span> <span class="n">override</span> <span class="p">{</span>
    <span class="n">storeRegToStack</span><span class="p">(</span><span class="n">MBB</span><span class="p">,</span> <span class="n">MBBI</span><span class="p">,</span> <span class="n">SrcReg</span><span class="p">,</span> <span class="n">isKill</span><span class="p">,</span> <span class="n">FrameIndex</span><span class="p">,</span> <span class="n">RC</span><span class="p">,</span> <span class="n">TRI</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="n">void</span> <span class="n">loadRegFromStackSlot</span><span class="p">(</span><span class="n">MachineBasicBlock</span> <span class="o">&amp;</span><span class="n">MBB</span><span class="p">,</span>
                            <span class="n">MachineBasicBlock</span><span class="p">::</span><span class="n">iterator</span> <span class="n">MBBI</span><span class="p">,</span>
                            <span class="n">unsigned</span> <span class="n">DestReg</span><span class="p">,</span> <span class="nb">int</span> <span class="n">FrameIndex</span><span class="p">,</span>
                            <span class="n">const</span> <span class="n">TargetRegisterClass</span> <span class="o">*</span><span class="n">RC</span><span class="p">,</span>
                            <span class="n">const</span> <span class="n">TargetRegisterInfo</span> <span class="o">*</span><span class="n">TRI</span><span class="p">)</span> <span class="n">const</span> <span class="n">override</span> <span class="p">{</span>
    <span class="n">loadRegFromStack</span><span class="p">(</span><span class="n">MBB</span><span class="p">,</span> <span class="n">MBBI</span><span class="p">,</span> <span class="n">DestReg</span><span class="p">,</span> <span class="n">FrameIndex</span><span class="p">,</span> <span class="n">RC</span><span class="p">,</span> <span class="n">TRI</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="n">virtual</span> <span class="n">void</span> <span class="n">storeRegToStack</span><span class="p">(</span><span class="n">MachineBasicBlock</span> <span class="o">&amp;</span><span class="n">MBB</span><span class="p">,</span>
                               <span class="n">MachineBasicBlock</span><span class="p">::</span><span class="n">iterator</span> <span class="n">MI</span><span class="p">,</span>
                               <span class="n">unsigned</span> <span class="n">SrcReg</span><span class="p">,</span> <span class="nb">bool</span> <span class="n">isKill</span><span class="p">,</span> <span class="nb">int</span> <span class="n">FrameIndex</span><span class="p">,</span>
                               <span class="n">const</span> <span class="n">TargetRegisterClass</span> <span class="o">*</span><span class="n">RC</span><span class="p">,</span>
                               <span class="n">const</span> <span class="n">TargetRegisterInfo</span> <span class="o">*</span><span class="n">TRI</span><span class="p">,</span>
                               <span class="n">int64_t</span> <span class="n">Offset</span><span class="p">)</span> <span class="n">const</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

  <span class="n">virtual</span> <span class="n">void</span> <span class="n">loadRegFromStack</span><span class="p">(</span><span class="n">MachineBasicBlock</span> <span class="o">&amp;</span><span class="n">MBB</span><span class="p">,</span>
                                <span class="n">MachineBasicBlock</span><span class="p">::</span><span class="n">iterator</span> <span class="n">MI</span><span class="p">,</span>
                                <span class="n">unsigned</span> <span class="n">DestReg</span><span class="p">,</span> <span class="nb">int</span> <span class="n">FrameIndex</span><span class="p">,</span>
                                <span class="n">const</span> <span class="n">TargetRegisterClass</span> <span class="o">*</span><span class="n">RC</span><span class="p">,</span>
                                <span class="n">const</span> <span class="n">TargetRegisterInfo</span> <span class="o">*</span><span class="n">TRI</span><span class="p">,</span>
                                <span class="n">int64_t</span> <span class="n">Offset</span><span class="p">)</span> <span class="n">const</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span>  <span class="n">MachineMemOperand</span> <span class="o">*</span><span class="n">GetMemOperand</span><span class="p">(</span><span class="n">MachineBasicBlock</span> <span class="o">&amp;</span><span class="n">MBB</span><span class="p">,</span> <span class="nb">int</span> <span class="n">FI</span><span class="p">,</span>
                                   <span class="n">MachineMemOperand</span><span class="p">::</span><span class="n">Flags</span> <span class="n">Flags</span><span class="p">)</span> <span class="n">const</span><span class="p">;</span>
</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter3_5/Cpu0InstrInfo.cpp</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">MachineMemOperand</span> <span class="o">*</span>
<span class="n">Cpu0InstrInfo</span><span class="p">::</span><span class="n">GetMemOperand</span><span class="p">(</span><span class="n">MachineBasicBlock</span> <span class="o">&amp;</span><span class="n">MBB</span><span class="p">,</span> <span class="nb">int</span> <span class="n">FI</span><span class="p">,</span>
                             <span class="n">MachineMemOperand</span><span class="p">::</span><span class="n">Flags</span> <span class="n">Flags</span><span class="p">)</span> <span class="n">const</span> <span class="p">{</span>

  <span class="n">MachineFunction</span> <span class="o">&amp;</span><span class="n">MF</span> <span class="o">=</span> <span class="o">*</span><span class="n">MBB</span><span class="o">.</span><span class="n">getParent</span><span class="p">();</span>
  <span class="n">MachineFrameInfo</span> <span class="o">&amp;</span><span class="n">MFI</span> <span class="o">=</span> <span class="o">*</span><span class="n">MF</span><span class="o">.</span><span class="n">getFrameInfo</span><span class="p">();</span>
  <span class="n">unsigned</span> <span class="n">Align</span> <span class="o">=</span> <span class="n">MFI</span><span class="o">.</span><span class="n">getObjectAlignment</span><span class="p">(</span><span class="n">FI</span><span class="p">);</span>

  <span class="k">return</span> <span class="n">MF</span><span class="o">.</span><span class="n">getMachineMemOperand</span><span class="p">(</span><span class="n">MachinePointerInfo</span><span class="p">::</span><span class="n">getFixedStack</span><span class="p">(</span><span class="n">MF</span><span class="p">,</span> <span class="n">FI</span><span class="p">),</span>
                                 <span class="n">Flags</span><span class="p">,</span> <span class="n">MFI</span><span class="o">.</span><span class="n">getObjectSize</span><span class="p">(</span><span class="n">FI</span><span class="p">),</span> <span class="n">Align</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter3_5/Cpu0SEInstrInfo.h</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>  <span class="n">void</span> <span class="n">storeRegToStack</span><span class="p">(</span><span class="n">MachineBasicBlock</span> <span class="o">&amp;</span><span class="n">MBB</span><span class="p">,</span>
                       <span class="n">MachineBasicBlock</span><span class="p">::</span><span class="n">iterator</span> <span class="n">MI</span><span class="p">,</span>
                       <span class="n">unsigned</span> <span class="n">SrcReg</span><span class="p">,</span> <span class="nb">bool</span> <span class="n">isKill</span><span class="p">,</span> <span class="nb">int</span> <span class="n">FrameIndex</span><span class="p">,</span>
                       <span class="n">const</span> <span class="n">TargetRegisterClass</span> <span class="o">*</span><span class="n">RC</span><span class="p">,</span>
                       <span class="n">const</span> <span class="n">TargetRegisterInfo</span> <span class="o">*</span><span class="n">TRI</span><span class="p">,</span>
                       <span class="n">int64_t</span> <span class="n">Offset</span><span class="p">)</span> <span class="n">const</span> <span class="n">override</span><span class="p">;</span>

  <span class="n">void</span> <span class="n">loadRegFromStack</span><span class="p">(</span><span class="n">MachineBasicBlock</span> <span class="o">&amp;</span><span class="n">MBB</span><span class="p">,</span>
                        <span class="n">MachineBasicBlock</span><span class="p">::</span><span class="n">iterator</span> <span class="n">MI</span><span class="p">,</span>
                        <span class="n">unsigned</span> <span class="n">DestReg</span><span class="p">,</span> <span class="nb">int</span> <span class="n">FrameIndex</span><span class="p">,</span>
                        <span class="n">const</span> <span class="n">TargetRegisterClass</span> <span class="o">*</span><span class="n">RC</span><span class="p">,</span>
                        <span class="n">const</span> <span class="n">TargetRegisterInfo</span> <span class="o">*</span><span class="n">TRI</span><span class="p">,</span>
                        <span class="n">int64_t</span> <span class="n">Offset</span><span class="p">)</span> <span class="n">const</span> <span class="n">override</span><span class="p">;</span>
</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter3_5/Cpu0SEInstrInfo.cpp</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">void</span> <span class="n">Cpu0SEInstrInfo</span><span class="p">::</span>
<span class="n">storeRegToStack</span><span class="p">(</span><span class="n">MachineBasicBlock</span> <span class="o">&amp;</span><span class="n">MBB</span><span class="p">,</span> <span class="n">MachineBasicBlock</span><span class="p">::</span><span class="n">iterator</span> <span class="n">I</span><span class="p">,</span>
                <span class="n">unsigned</span> <span class="n">SrcReg</span><span class="p">,</span> <span class="nb">bool</span> <span class="n">isKill</span><span class="p">,</span> <span class="nb">int</span> <span class="n">FI</span><span class="p">,</span>
                <span class="n">const</span> <span class="n">TargetRegisterClass</span> <span class="o">*</span><span class="n">RC</span><span class="p">,</span> <span class="n">const</span> <span class="n">TargetRegisterInfo</span> <span class="o">*</span><span class="n">TRI</span><span class="p">,</span>
                <span class="n">int64_t</span> <span class="n">Offset</span><span class="p">)</span> <span class="n">const</span> <span class="p">{</span>
  <span class="n">DebugLoc</span> <span class="n">DL</span><span class="p">;</span>
  <span class="n">MachineMemOperand</span> <span class="o">*</span><span class="n">MMO</span> <span class="o">=</span> <span class="n">GetMemOperand</span><span class="p">(</span><span class="n">MBB</span><span class="p">,</span> <span class="n">FI</span><span class="p">,</span> <span class="n">MachineMemOperand</span><span class="p">::</span><span class="n">MOStore</span><span class="p">);</span>

  <span class="n">unsigned</span> <span class="n">Opc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

  <span class="n">Opc</span> <span class="o">=</span> <span class="n">Cpu0</span><span class="p">::</span><span class="n">ST</span><span class="p">;</span>
  <span class="k">assert</span><span class="p">(</span><span class="n">Opc</span> <span class="o">&amp;&amp;</span> <span class="s2">&quot;Register class not handled!&quot;</span><span class="p">);</span>
  <span class="n">BuildMI</span><span class="p">(</span><span class="n">MBB</span><span class="p">,</span> <span class="n">I</span><span class="p">,</span> <span class="n">DL</span><span class="p">,</span> <span class="n">get</span><span class="p">(</span><span class="n">Opc</span><span class="p">))</span><span class="o">.</span><span class="n">addReg</span><span class="p">(</span><span class="n">SrcReg</span><span class="p">,</span> <span class="n">getKillRegState</span><span class="p">(</span><span class="n">isKill</span><span class="p">))</span>
    <span class="o">.</span><span class="n">addFrameIndex</span><span class="p">(</span><span class="n">FI</span><span class="p">)</span><span class="o">.</span><span class="n">addImm</span><span class="p">(</span><span class="n">Offset</span><span class="p">)</span><span class="o">.</span><span class="n">addMemOperand</span><span class="p">(</span><span class="n">MMO</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">void</span> <span class="n">Cpu0SEInstrInfo</span><span class="p">::</span>
<span class="n">loadRegFromStack</span><span class="p">(</span><span class="n">MachineBasicBlock</span> <span class="o">&amp;</span><span class="n">MBB</span><span class="p">,</span> <span class="n">MachineBasicBlock</span><span class="p">::</span><span class="n">iterator</span> <span class="n">I</span><span class="p">,</span>
                 <span class="n">unsigned</span> <span class="n">DestReg</span><span class="p">,</span> <span class="nb">int</span> <span class="n">FI</span><span class="p">,</span> <span class="n">const</span> <span class="n">TargetRegisterClass</span> <span class="o">*</span><span class="n">RC</span><span class="p">,</span>
                 <span class="n">const</span> <span class="n">TargetRegisterInfo</span> <span class="o">*</span><span class="n">TRI</span><span class="p">,</span> <span class="n">int64_t</span> <span class="n">Offset</span><span class="p">)</span> <span class="n">const</span> <span class="p">{</span>
  <span class="n">DebugLoc</span> <span class="n">DL</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">I</span> <span class="o">!=</span> <span class="n">MBB</span><span class="o">.</span><span class="n">end</span><span class="p">())</span> <span class="n">DL</span> <span class="o">=</span> <span class="n">I</span><span class="o">-&gt;</span><span class="n">getDebugLoc</span><span class="p">();</span>
  <span class="n">MachineMemOperand</span> <span class="o">*</span><span class="n">MMO</span> <span class="o">=</span> <span class="n">GetMemOperand</span><span class="p">(</span><span class="n">MBB</span><span class="p">,</span> <span class="n">FI</span><span class="p">,</span> <span class="n">MachineMemOperand</span><span class="p">::</span><span class="n">MOLoad</span><span class="p">);</span>
  <span class="n">unsigned</span> <span class="n">Opc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

  <span class="n">Opc</span> <span class="o">=</span> <span class="n">Cpu0</span><span class="p">::</span><span class="n">LD</span><span class="p">;</span>
  <span class="k">assert</span><span class="p">(</span><span class="n">Opc</span> <span class="o">&amp;&amp;</span> <span class="s2">&quot;Register class not handled!&quot;</span><span class="p">);</span>
  <span class="n">BuildMI</span><span class="p">(</span><span class="n">MBB</span><span class="p">,</span> <span class="n">I</span><span class="p">,</span> <span class="n">DL</span><span class="p">,</span> <span class="n">get</span><span class="p">(</span><span class="n">Opc</span><span class="p">),</span> <span class="n">DestReg</span><span class="p">)</span><span class="o">.</span><span class="n">addFrameIndex</span><span class="p">(</span><span class="n">FI</span><span class="p">)</span><span class="o">.</span><span class="n">addImm</span><span class="p">(</span><span class="n">Offset</span><span class="p">)</span>
    <span class="o">.</span><span class="n">addMemOperand</span><span class="p">(</span><span class="n">MMO</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Functions storeRegToStack() Cpu0SEInstrInfo.cpp and storeRegToStackSlot() of
Cpu0InstrInfo.cpp handle the registers spilling during register allocation
process.
Since each local variable connecting to a frame index, code &#8221;.addFrameIndex(FI).
addImm(Offset).addMemOperand(MMO);&#8221; in storeRegToStack() where Offset is 0 is
added for each virtual register.
The loadRegFromStackSlot() and loadRegFromStack() will be used when it needs
reload from stack slot.</p>
<p>If adding V0 to Cpu0CallingConv.td as the following and without
both storeRegToStack() and storeRegToStackSlot() in Cpu0SEInstrInfo.cpp,
Cpu0SEInstrInfo.h and Cpu0InstrInfo.h it will get the belowing error.</p>
<p class="rubric">lbdex/Cpu0/Cpu0CallingConv.td</p>
<div class="highlight-c++"><div class="highlight"><pre><span></span><span class="n">def</span> <span class="nl">CSR_O32</span> <span class="p">:</span> <span class="n">CalleeSavedRegs</span><span class="o">&lt;</span><span class="p">(</span><span class="n">add</span> <span class="n">LR</span><span class="p">,</span> <span class="n">FP</span><span class="p">,</span> <span class="n">V0</span><span class="p">,</span>
                                 <span class="p">(</span><span class="n">sequence</span> <span class="s">&quot;S%u&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span><span class="o">&gt;</span><span class="p">;</span>
</pre></div>
</div>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">114-43-191-19:input Jonathan$</span> ~/llvm/test/cmake_debug_build/Debug/bin/llc
<span class="go">-march=cpu0 -relocation-model=pic -filetype=asm ch3.bc -o -</span>
<span class="go">  .text</span>
<span class="go">  .section .mdebug.abiO32</span>
<span class="go">  .previous</span>
<span class="go">  .file &quot;ch3.bc&quot;</span>
<span class="go">Target didn&#39;t implement TargetInstrInfo::storeRegToStackSlot!</span>
<span class="go">...</span>
<span class="go">Stack dump:</span>
<span class="go">...</span>
<span class="go">Abort trap: 6</span>
</pre></div>
</div>
<table border="1" class="docutils" id="id10">
<caption><span class="caption-number">Table 12 </span><span class="caption-text">Backend functions called in PrologEpilogInserter.cpp</span><a class="headerlink" href="#id10" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="52%" />
<col width="48%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Stage</th>
<th class="head">Function</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>Prologue/Epilogue Insertion &amp; Frame Finalization</td>
<td>&nbsp;</td>
</tr>
<tr class="row-odd"><td><ul class="first last simple">
<li>Determine spill callee saved registers</li>
</ul>
</td>
<td><ul class="first last simple">
<li>Cpu0SEFrameLowering::determineCalleeSaves</li>
</ul>
</td>
</tr>
<tr class="row-even"><td><ul class="first last simple">
<li>Spill callee saved registers</li>
</ul>
</td>
<td><ul class="first last simple">
<li>Cpu0SEFrameLowering::spillCalleeSavedRegisters</li>
</ul>
</td>
</tr>
<tr class="row-odd"><td><ul class="first last simple">
<li>Prolog</li>
</ul>
</td>
<td><ul class="first last simple">
<li>Cpu0SEFrameLowering::emitPrologue</li>
</ul>
</td>
</tr>
<tr class="row-even"><td><ul class="first last simple">
<li>Epilog</li>
</ul>
</td>
<td><ul class="first last simple">
<li>Cpu0SEFrameLowering::emitEpilogue</li>
</ul>
</td>
</tr>
<tr class="row-odd"><td><ul class="first last simple">
<li>Handle stack slot for local variables</li>
</ul>
</td>
<td><ul class="first last simple">
<li>Cpu0RegisterInfo::eliminateFrameIndex</li>
</ul>
</td>
</tr>
</tbody>
</table>
<p>File PrologEpilogInserter.cpp includes the calling of backend functions
spillCalleeSavedRegisters(), emitProlog(), emitEpilog() and eliminateFrameIndex()
as follows,</p>
<p class="rubric">lib/CodeGen/PrologEpilogInserter.cpp</p>
<div class="highlight-c++"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">PEI</span> <span class="o">:</span> <span class="k">public</span> <span class="n">MachineFunctionPass</span> <span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
  <span class="k">static</span> <span class="kt">char</span> <span class="n">ID</span><span class="p">;</span>
  <span class="k">explicit</span> <span class="nf">PEI</span><span class="p">(</span><span class="k">const</span> <span class="n">TargetMachine</span> <span class="o">*</span><span class="n">TM</span> <span class="o">=</span> <span class="k">nullptr</span><span class="p">)</span> <span class="o">:</span> <span class="n">MachineFunctionPass</span><span class="p">(</span><span class="n">ID</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">initializePEIPass</span><span class="p">(</span><span class="o">*</span><span class="n">PassRegistry</span><span class="o">::</span><span class="n">getPassRegistry</span><span class="p">());</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">TM</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="n">TM</span><span class="o">-&gt;</span><span class="n">usesPhysRegsForPEI</span><span class="p">()))</span> <span class="p">{</span>
      <span class="p">...</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="n">SpillCalleeSavedRegisters</span> <span class="o">=</span> <span class="n">doSpillCalleeSavedRegs</span><span class="p">;</span>
      <span class="p">...</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="p">...</span>
<span class="p">}</span>

<span class="c1">/// insertCSRSpillsAndRestores - Insert spill and restore code for</span>
<span class="c1">/// callee saved registers used in the function.</span>
<span class="c1">///</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">insertCSRSpillsAndRestores</span><span class="p">(</span><span class="n">MachineFunction</span> <span class="o">&amp;</span><span class="n">Fn</span><span class="p">,</span>
                                       <span class="k">const</span> <span class="n">MBBVector</span> <span class="o">&amp;</span><span class="n">SaveBlocks</span><span class="p">,</span>
                                       <span class="k">const</span> <span class="n">MBBVector</span> <span class="o">&amp;</span><span class="n">RestoreBlocks</span><span class="p">)</span> <span class="p">{</span>
  <span class="p">...</span>
  <span class="c1">// Spill using target interface.</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">MachineBasicBlock</span> <span class="o">*</span><span class="nl">SaveBlock</span> <span class="p">:</span> <span class="n">SaveBlocks</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">...</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">TFI</span><span class="o">-&gt;</span><span class="n">spillCalleeSavedRegisters</span><span class="p">(</span><span class="o">*</span><span class="n">SaveBlock</span><span class="p">,</span> <span class="n">I</span><span class="p">,</span> <span class="n">CSI</span><span class="p">,</span> <span class="n">TRI</span><span class="p">))</span> <span class="p">{</span>
      <span class="k">for</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">e</span> <span class="o">=</span> <span class="n">CSI</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="n">i</span> <span class="o">!=</span> <span class="n">e</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// Insert the spill to the stack frame.</span>
        <span class="p">...</span>
        <span class="n">TII</span><span class="p">.</span><span class="n">storeRegToStackSlot</span><span class="p">(</span><span class="o">*</span><span class="n">SaveBlock</span><span class="p">,</span> <span class="n">I</span><span class="p">,</span> <span class="n">Reg</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="n">CSI</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">getFrameIdx</span><span class="p">(),</span>
                                <span class="n">RC</span><span class="p">,</span> <span class="n">TRI</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="p">...</span>
  <span class="p">}</span>

  <span class="c1">// Restore using target interface.</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">MachineBasicBlock</span> <span class="o">*</span><span class="nl">MBB</span> <span class="p">:</span> <span class="n">RestoreBlocks</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">...</span>
    <span class="c1">// Restore all registers immediately before the return and any</span>
    <span class="c1">// terminators that precede it.</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">TFI</span><span class="o">-&gt;</span><span class="n">restoreCalleeSavedRegisters</span><span class="p">(</span><span class="o">*</span><span class="n">MBB</span><span class="p">,</span> <span class="n">I</span><span class="p">,</span> <span class="n">CSI</span><span class="p">,</span> <span class="n">TRI</span><span class="p">))</span> <span class="p">{</span>
      <span class="k">for</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">e</span> <span class="o">=</span> <span class="n">CSI</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="n">i</span> <span class="o">!=</span> <span class="n">e</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
        <span class="p">...</span>
        <span class="n">TII</span><span class="p">.</span><span class="n">loadRegFromStackSlot</span><span class="p">(</span><span class="o">*</span><span class="n">MBB</span><span class="p">,</span> <span class="n">I</span><span class="p">,</span> <span class="n">Reg</span><span class="p">,</span> <span class="n">CSI</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">getFrameIdx</span><span class="p">(),</span> <span class="n">RC</span><span class="p">,</span> <span class="n">TRI</span><span class="p">);</span>
        <span class="p">...</span>
      <span class="p">}</span>
    <span class="p">...</span>
  <span class="p">}</span>
  <span class="p">...</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">doSpillCalleeSavedRegs</span><span class="p">(</span><span class="n">MachineFunction</span> <span class="o">&amp;</span><span class="n">Fn</span><span class="p">,</span> <span class="n">RegScavenger</span> <span class="o">*</span><span class="n">RS</span><span class="p">,</span>
                                   <span class="kt">unsigned</span> <span class="o">&amp;</span><span class="n">MinCSFrameIndex</span><span class="p">,</span>
                                   <span class="kt">unsigned</span> <span class="o">&amp;</span><span class="n">MaxCSFrameIndex</span><span class="p">,</span>
                                   <span class="k">const</span> <span class="n">MBBVector</span> <span class="o">&amp;</span><span class="n">SaveBlocks</span><span class="p">,</span>
                                   <span class="k">const</span> <span class="n">MBBVector</span> <span class="o">&amp;</span><span class="n">RestoreBlocks</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">const</span> <span class="n">Function</span> <span class="o">*</span><span class="n">F</span> <span class="o">=</span> <span class="n">Fn</span><span class="p">.</span><span class="n">getFunction</span><span class="p">();</span>
  <span class="k">const</span> <span class="n">TargetFrameLowering</span> <span class="o">*</span><span class="n">TFI</span> <span class="o">=</span> <span class="n">Fn</span><span class="p">.</span><span class="n">getSubtarget</span><span class="p">().</span><span class="n">getFrameLowering</span><span class="p">();</span>
  <span class="n">MinCSFrameIndex</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">numeric_limits</span><span class="o">&lt;</span><span class="kt">unsigned</span><span class="o">&gt;::</span><span class="n">max</span><span class="p">();</span>
  <span class="n">MaxCSFrameIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

  <span class="c1">// Determine which of the registers in the callee save list should be saved.</span>
  <span class="n">BitVector</span> <span class="n">SavedRegs</span><span class="p">;</span>
  <span class="n">TFI</span><span class="o">-&gt;</span><span class="n">determineCalleeSaves</span><span class="p">(</span><span class="n">Fn</span><span class="p">,</span> <span class="n">SavedRegs</span><span class="p">,</span> <span class="n">RS</span><span class="p">);</span>

  <span class="c1">// Assign stack slots for any callee-saved registers that must be spilled.</span>
  <span class="n">assignCalleeSavedSpillSlots</span><span class="p">(</span><span class="n">Fn</span><span class="p">,</span> <span class="n">SavedRegs</span><span class="p">,</span> <span class="n">MinCSFrameIndex</span><span class="p">,</span> <span class="n">MaxCSFrameIndex</span><span class="p">);</span>

  <span class="c1">// Add the code to save and restore the callee saved registers.</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">F</span><span class="o">-&gt;</span><span class="n">hasFnAttribute</span><span class="p">(</span><span class="n">Attribute</span><span class="o">::</span><span class="n">Naked</span><span class="p">))</span>
    <span class="n">insertCSRSpillsAndRestores</span><span class="p">(</span><span class="n">Fn</span><span class="p">,</span> <span class="n">SaveBlocks</span><span class="p">,</span> <span class="n">RestoreBlocks</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">PEI</span><span class="o">::</span><span class="n">insertPrologEpilogCode</span><span class="p">(</span><span class="n">MachineFunction</span> <span class="o">&amp;</span><span class="n">Fn</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">const</span> <span class="n">TargetFrameLowering</span> <span class="o">&amp;</span><span class="n">TFI</span> <span class="o">=</span> <span class="o">*</span><span class="n">Fn</span><span class="p">.</span><span class="n">getSubtarget</span><span class="p">().</span><span class="n">getFrameLowering</span><span class="p">();</span>

  <span class="c1">// Add prologue to the function...</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">MachineBasicBlock</span> <span class="o">*</span><span class="nl">SaveBlock</span> <span class="p">:</span> <span class="n">SaveBlocks</span><span class="p">)</span>
    <span class="n">TFI</span><span class="p">.</span><span class="n">emitPrologue</span><span class="p">(</span><span class="n">Fn</span><span class="p">,</span> <span class="o">*</span><span class="n">SaveBlock</span><span class="p">);</span>

  <span class="c1">// Add epilogue to restore the callee-save registers in each exiting block.</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">MachineBasicBlock</span> <span class="o">*</span><span class="nl">RestoreBlock</span> <span class="p">:</span> <span class="n">RestoreBlocks</span><span class="p">)</span>
    <span class="n">TFI</span><span class="p">.</span><span class="n">emitEpilogue</span><span class="p">(</span><span class="n">Fn</span><span class="p">,</span> <span class="o">*</span><span class="n">RestoreBlock</span><span class="p">);</span>
  <span class="p">...</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">PEI</span><span class="o">::</span><span class="n">replaceFrameIndices</span><span class="p">(</span><span class="n">MachineBasicBlock</span> <span class="o">*</span><span class="n">BB</span><span class="p">,</span> <span class="n">MachineFunction</span> <span class="o">&amp;</span><span class="n">Fn</span><span class="p">,</span>
                              <span class="kt">int</span> <span class="o">&amp;</span><span class="n">SPAdj</span><span class="p">)</span> <span class="p">{</span>
  <span class="p">...</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">e</span> <span class="o">=</span> <span class="n">MI</span><span class="p">.</span><span class="n">getNumOperands</span><span class="p">();</span> <span class="n">i</span> <span class="o">!=</span> <span class="n">e</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
      <span class="p">...</span>
      <span class="c1">// If this instruction has a FrameIndex operand, we need to</span>
      <span class="c1">// use that target machine register info object to eliminate</span>
      <span class="c1">// it.</span>
      <span class="n">TRI</span><span class="p">.</span><span class="n">eliminateFrameIndex</span><span class="p">(</span><span class="n">MI</span><span class="p">,</span> <span class="n">SPAdj</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
                              <span class="n">FrameIndexVirtualScavenging</span> <span class="o">?</span>  <span class="k">nullptr</span> <span class="o">:</span> <span class="n">RS</span><span class="p">);</span>
      <span class="p">...</span>
    <span class="p">}</span>
  <span class="p">...</span>
<span class="p">}</span>

<span class="c1">/// replaceFrameIndices - Replace all MO_FrameIndex operands with physical</span>
<span class="c1">/// register references and actual offsets.</span>
<span class="c1">///</span>
<span class="kt">void</span> <span class="n">PEI</span><span class="o">::</span><span class="n">replaceFrameIndices</span><span class="p">(</span><span class="n">MachineFunction</span> <span class="o">&amp;</span><span class="n">Fn</span><span class="p">)</span> <span class="p">{</span>
  <span class="p">...</span>
  <span class="c1">// Iterate over the reachable blocks in DFS order.</span>
  <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="n">DFI</span> <span class="o">=</span> <span class="n">df_ext_begin</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Fn</span><span class="p">,</span> <span class="n">Reachable</span><span class="p">),</span> <span class="n">DFE</span> <span class="o">=</span> <span class="n">df_ext_end</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Fn</span><span class="p">,</span> <span class="n">Reachable</span><span class="p">);</span>
       <span class="n">DFI</span> <span class="o">!=</span> <span class="n">DFE</span><span class="p">;</span> <span class="o">++</span><span class="n">DFI</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">...</span>
    <span class="n">replaceFrameIndices</span><span class="p">(</span><span class="n">BB</span><span class="p">,</span> <span class="n">Fn</span><span class="p">,</span> <span class="n">SPAdj</span><span class="p">);</span>
    <span class="p">...</span>
  <span class="p">}</span>

  <span class="c1">// Handle the unreachable blocks.</span>
  <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="o">&amp;</span><span class="nl">BB</span> <span class="p">:</span> <span class="n">Fn</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">...</span>
    <span class="n">replaceFrameIndices</span><span class="p">(</span><span class="o">&amp;</span><span class="n">BB</span><span class="p">,</span> <span class="n">Fn</span><span class="p">,</span> <span class="n">SPAdj</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kt">bool</span> <span class="n">PEI</span><span class="o">::</span><span class="n">runOnMachineFunction</span><span class="p">(</span><span class="n">MachineFunction</span> <span class="o">&amp;</span><span class="n">Fn</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">const</span> <span class="n">TargetFrameLowering</span> <span class="o">&amp;</span><span class="n">TFI</span> <span class="o">=</span> <span class="o">*</span><span class="n">Fn</span><span class="p">.</span><span class="n">getSubtarget</span><span class="p">().</span><span class="n">getFrameLowering</span><span class="p">();</span>
  <span class="p">...</span>
  <span class="n">FrameIndexVirtualScavenging</span> <span class="o">=</span> <span class="n">TRI</span><span class="o">-&gt;</span><span class="n">requiresFrameIndexScavenging</span><span class="p">(</span><span class="n">Fn</span><span class="p">);</span>
  <span class="p">...</span>
  <span class="c1">// Handle CSR spilling and restoring, for targets that need it.</span>
  <span class="n">SpillCalleeSavedRegisters</span><span class="p">(</span><span class="n">Fn</span><span class="p">,</span> <span class="n">RS</span><span class="p">,</span> <span class="n">MinCSFrameIndex</span><span class="p">,</span> <span class="n">MaxCSFrameIndex</span><span class="p">,</span>
                            <span class="n">SaveBlocks</span><span class="p">,</span> <span class="n">RestoreBlocks</span><span class="p">);</span>
  <span class="p">...</span>
  <span class="c1">// Calculate actual frame offsets for all abstract stack objects...</span>
  <span class="n">calculateFrameObjectOffsets</span><span class="p">(</span><span class="n">Fn</span><span class="p">);</span>

  <span class="c1">// Add prolog and epilog code to the function.  This function is required</span>
  <span class="c1">// to align the stack frame as necessary for any stack variables or</span>
  <span class="c1">// called functions.  Because of this, calculateCalleeSavedRegisters()</span>
  <span class="c1">// must be called before this function in order to set the AdjustsStack</span>
  <span class="c1">// and MaxCallFrameSize variables.</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">F</span><span class="o">-&gt;</span><span class="n">hasFnAttribute</span><span class="p">(</span><span class="n">Attribute</span><span class="o">::</span><span class="n">Naked</span><span class="p">))</span>
    <span class="n">insertPrologEpilogCode</span><span class="p">(</span><span class="n">Fn</span><span class="p">);</span>

  <span class="c1">// Replace all MO_FrameIndex operands with physical register references</span>
  <span class="c1">// and actual offsets.</span>
  <span class="c1">//</span>
  <span class="n">replaceFrameIndices</span><span class="p">(</span><span class="n">Fn</span><span class="p">);</span>

  <span class="c1">// If register scavenging is needed, as we&#39;ve enabled doing it as a</span>
  <span class="c1">// post-pass, scavenge the virtual registers that frame index elimination</span>
  <span class="c1">// inserted.</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">TRI</span><span class="o">-&gt;</span><span class="n">requiresRegisterScavenging</span><span class="p">(</span><span class="n">Fn</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">FrameIndexVirtualScavenging</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">ScavengeFrameVirtualRegs</span><span class="p">(</span><span class="n">Fn</span><span class="p">,</span> <span class="n">RS</span><span class="p">);</span>

    <span class="c1">// Clear any vregs created by virtual scavenging.</span>
    <span class="n">Fn</span><span class="p">.</span><span class="n">getRegInfo</span><span class="p">().</span><span class="n">clearVirtRegs</span><span class="p">();</span>
  <span class="p">}</span>
  <span class="p">...</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="large-stack">
<h3><a class="toc-backref" href="#id22">Large stack</a><a class="headerlink" href="#large-stack" title="Permalink to this headline">¶</a></h3>
<p>At this point, we have translated the very simple main() function with
&#8220;return 0;&#8221; single instruction.
The Cpu0AnalyzeImmediate.cpp and the Cpu0InstrInfo.td instructions defined in
Chapter3_5 as the following, which take care the 32 bits stack size adjustments.</p>
<p class="rubric">lbdex/chapters/Chapter3_5/CMakeLists.txt</p>
<div class="highlight-c++"><div class="highlight"><pre><span></span><span class="n">add_llvm_target</span><span class="p">(</span>
  <span class="p">...</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span>  <span class="n">Cpu0AnalyzeImmediate</span><span class="o">.</span><span class="n">cpp</span>
</pre></div>
</div>
<div class="highlight-c++"><div class="highlight"><pre><span></span>  <span class="p">...</span>
<span class="p">)</span>
</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter3_5/Cpu0AnalyzeImmediate.h</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">//===--</span> <span class="n">Cpu0AnalyzeImmediate</span><span class="o">.</span><span class="n">h</span> <span class="o">-</span> <span class="n">Analyze</span> <span class="n">Immediates</span> <span class="o">------------*-</span> <span class="n">C</span><span class="o">++</span> <span class="o">-*--===//</span>
<span class="o">//</span>
<span class="o">//</span>                     <span class="n">The</span> <span class="n">LLVM</span> <span class="n">Compiler</span> <span class="n">Infrastructure</span>
<span class="o">//</span>
<span class="o">//</span> <span class="n">This</span> <span class="n">file</span> <span class="ow">is</span> <span class="n">distributed</span> <span class="n">under</span> <span class="n">the</span> <span class="n">University</span> <span class="n">of</span> <span class="n">Illinois</span> <span class="n">Open</span> <span class="n">Source</span>
<span class="o">//</span> <span class="n">License</span><span class="o">.</span> <span class="n">See</span> <span class="n">LICENSE</span><span class="o">.</span><span class="n">TXT</span> <span class="k">for</span> <span class="n">details</span><span class="o">.</span>
<span class="o">//</span>
<span class="o">//===----------------------------------------------------------------------===//</span>
<span class="c1">#ifndef CPU0_ANALYZE_IMMEDIATE_H</span>
<span class="c1">#define CPU0_ANALYZE_IMMEDIATE_H</span>

<span class="c1">#include &quot;Cpu0Config.h&quot;</span>
<span class="c1">#if CH &gt;= CH3_5</span>

<span class="c1">#include &quot;llvm/ADT/SmallVector.h&quot;</span>
<span class="c1">#include &quot;llvm/Support/DataTypes.h&quot;</span>

<span class="n">namespace</span> <span class="n">llvm</span> <span class="p">{</span>

  <span class="k">class</span> <span class="nc">Cpu0AnalyzeImmediate</span> <span class="p">{</span>
  <span class="n">public</span><span class="p">:</span>
    <span class="n">struct</span> <span class="n">Inst</span> <span class="p">{</span>
      <span class="n">unsigned</span> <span class="n">Opc</span><span class="p">,</span> <span class="n">ImmOpnd</span><span class="p">;</span>
      <span class="n">Inst</span><span class="p">(</span><span class="n">unsigned</span> <span class="n">Opc</span><span class="p">,</span> <span class="n">unsigned</span> <span class="n">ImmOpnd</span><span class="p">);</span>
    <span class="p">};</span>
    <span class="n">typedef</span> <span class="n">SmallVector</span><span class="o">&lt;</span><span class="n">Inst</span><span class="p">,</span> <span class="mi">7</span> <span class="o">&gt;</span> <span class="n">InstSeq</span><span class="p">;</span>

    <span class="o">///</span> <span class="n">Analyze</span> <span class="o">-</span> <span class="n">Get</span> <span class="n">an</span> <span class="n">instruction</span> <span class="n">sequence</span> <span class="n">to</span> <span class="n">load</span> <span class="n">immediate</span> <span class="n">Imm</span><span class="o">.</span> <span class="n">The</span> <span class="n">last</span>
    <span class="o">///</span> <span class="n">instruction</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">sequence</span> <span class="n">must</span> <span class="n">be</span> <span class="n">an</span> <span class="n">ADDiu</span> <span class="k">if</span> <span class="n">LastInstrIsADDiu</span> <span class="ow">is</span>
    <span class="o">///</span> <span class="n">true</span><span class="p">;</span>
    <span class="n">const</span> <span class="n">InstSeq</span> <span class="o">&amp;</span><span class="n">Analyze</span><span class="p">(</span><span class="n">uint64_t</span> <span class="n">Imm</span><span class="p">,</span> <span class="n">unsigned</span> <span class="n">Size</span><span class="p">,</span> <span class="nb">bool</span> <span class="n">LastInstrIsADDiu</span><span class="p">);</span>
  <span class="n">private</span><span class="p">:</span>
    <span class="n">typedef</span> <span class="n">SmallVector</span><span class="o">&lt;</span><span class="n">InstSeq</span><span class="p">,</span> <span class="mi">5</span><span class="o">&gt;</span> <span class="n">InstSeqLs</span><span class="p">;</span>

    <span class="o">///</span> <span class="n">AddInstr</span> <span class="o">-</span> <span class="n">Add</span> <span class="n">I</span> <span class="n">to</span> <span class="nb">all</span> <span class="n">instruction</span> <span class="n">sequences</span> <span class="ow">in</span> <span class="n">SeqLs</span><span class="o">.</span>
    <span class="n">void</span> <span class="n">AddInstr</span><span class="p">(</span><span class="n">InstSeqLs</span> <span class="o">&amp;</span><span class="n">SeqLs</span><span class="p">,</span> <span class="n">const</span> <span class="n">Inst</span> <span class="o">&amp;</span><span class="n">I</span><span class="p">);</span>

    <span class="o">///</span> <span class="n">GetInstSeqLsADDiu</span> <span class="o">-</span> <span class="n">Get</span> <span class="n">instruction</span> <span class="n">sequences</span> <span class="n">which</span> <span class="n">end</span> <span class="k">with</span> <span class="n">an</span> <span class="n">ADDiu</span> <span class="n">to</span>
    <span class="o">///</span> <span class="n">load</span> <span class="n">immediate</span> <span class="n">Imm</span>
    <span class="n">void</span> <span class="n">GetInstSeqLsADDiu</span><span class="p">(</span><span class="n">uint64_t</span> <span class="n">Imm</span><span class="p">,</span> <span class="n">unsigned</span> <span class="n">RemSize</span><span class="p">,</span> <span class="n">InstSeqLs</span> <span class="o">&amp;</span><span class="n">SeqLs</span><span class="p">);</span>

    <span class="o">///</span> <span class="n">GetInstSeqLsORi</span> <span class="o">-</span> <span class="n">Get</span> <span class="n">instruction</span> <span class="n">sequences</span> <span class="n">which</span> <span class="n">end</span> <span class="k">with</span> <span class="n">an</span> <span class="n">ORi</span> <span class="n">to</span>
    <span class="o">///</span> <span class="n">load</span> <span class="n">immediate</span> <span class="n">Imm</span>
    <span class="n">void</span> <span class="n">GetInstSeqLsORi</span><span class="p">(</span><span class="n">uint64_t</span> <span class="n">Imm</span><span class="p">,</span> <span class="n">unsigned</span> <span class="n">RemSize</span><span class="p">,</span> <span class="n">InstSeqLs</span> <span class="o">&amp;</span><span class="n">SeqLs</span><span class="p">);</span>

    <span class="o">///</span> <span class="n">GetInstSeqLsSHL</span> <span class="o">-</span> <span class="n">Get</span> <span class="n">instruction</span> <span class="n">sequences</span> <span class="n">which</span> <span class="n">end</span> <span class="k">with</span> <span class="n">a</span> <span class="n">SHL</span> <span class="n">to</span>
    <span class="o">///</span> <span class="n">load</span> <span class="n">immediate</span> <span class="n">Imm</span>
    <span class="n">void</span> <span class="n">GetInstSeqLsSHL</span><span class="p">(</span><span class="n">uint64_t</span> <span class="n">Imm</span><span class="p">,</span> <span class="n">unsigned</span> <span class="n">RemSize</span><span class="p">,</span> <span class="n">InstSeqLs</span> <span class="o">&amp;</span><span class="n">SeqLs</span><span class="p">);</span>

    <span class="o">///</span> <span class="n">GetInstSeqLs</span> <span class="o">-</span> <span class="n">Get</span> <span class="n">instruction</span> <span class="n">sequences</span> <span class="n">to</span> <span class="n">load</span> <span class="n">immediate</span> <span class="n">Imm</span><span class="o">.</span>
    <span class="n">void</span> <span class="n">GetInstSeqLs</span><span class="p">(</span><span class="n">uint64_t</span> <span class="n">Imm</span><span class="p">,</span> <span class="n">unsigned</span> <span class="n">RemSize</span><span class="p">,</span> <span class="n">InstSeqLs</span> <span class="o">&amp;</span><span class="n">SeqLs</span><span class="p">);</span>

    <span class="o">///</span> <span class="n">ReplaceADDiuSHLWithLUi</span> <span class="o">-</span> <span class="n">Replace</span> <span class="n">an</span> <span class="n">ADDiu</span> <span class="o">&amp;</span> <span class="n">SHL</span> <span class="n">pair</span> <span class="k">with</span> <span class="n">a</span> <span class="n">LUi</span><span class="o">.</span>
    <span class="n">void</span> <span class="n">ReplaceADDiuSHLWithLUi</span><span class="p">(</span><span class="n">InstSeq</span> <span class="o">&amp;</span><span class="n">Seq</span><span class="p">);</span>

    <span class="o">///</span> <span class="n">GetShortestSeq</span> <span class="o">-</span> <span class="n">Find</span> <span class="n">the</span> <span class="n">shortest</span> <span class="n">instruction</span> <span class="n">sequence</span> <span class="ow">in</span> <span class="n">SeqLs</span> <span class="ow">and</span>
    <span class="o">///</span> <span class="k">return</span> <span class="n">it</span> <span class="ow">in</span> <span class="n">Insts</span><span class="o">.</span>
    <span class="n">void</span> <span class="n">GetShortestSeq</span><span class="p">(</span><span class="n">InstSeqLs</span> <span class="o">&amp;</span><span class="n">SeqLs</span><span class="p">,</span> <span class="n">InstSeq</span> <span class="o">&amp;</span><span class="n">Insts</span><span class="p">);</span>

    <span class="n">unsigned</span> <span class="n">Size</span><span class="p">;</span>
    <span class="n">unsigned</span> <span class="n">ADDiu</span><span class="p">,</span> <span class="n">ORi</span><span class="p">,</span> <span class="n">SHL</span><span class="p">,</span> <span class="n">LUi</span><span class="p">;</span>
    <span class="n">InstSeq</span> <span class="n">Insts</span><span class="p">;</span>
  <span class="p">};</span>
<span class="p">}</span>

<span class="c1">#endif // #if CH &gt;= CH3_5</span>

<span class="c1">#endif</span>
</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter3_5/Cpu0AnalyzeImmediate.cpp</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>//===-- Cpu0AnalyzeImmediate.cpp - Analyze Immediates ---------------------===//
//
//                     The LLVM Compiler Infrastructure
//
// This file is distributed under the University of Illinois Open Source
// License. See LICENSE.TXT for details.
//
//===----------------------------------------------------------------------===//
#include &quot;Cpu0AnalyzeImmediate.h&quot;
#include &quot;Cpu0.h&quot;
#if CH &gt;= CH3_5

#include &quot;llvm/Support/MathExtras.h&quot;

using namespace llvm;

Cpu0AnalyzeImmediate::Inst::Inst(unsigned O, unsigned I) : Opc(O), ImmOpnd(I) {}

// Add I to the instruction sequences.
void Cpu0AnalyzeImmediate::AddInstr(InstSeqLs &amp;SeqLs, const Inst &amp;I) {
  // Add an instruction seqeunce consisting of just I.
  if (SeqLs.empty()) {
    SeqLs.push_back(InstSeq(1, I));
    return;
  }

  for (InstSeqLs::iterator Iter = SeqLs.begin(); Iter != SeqLs.end(); ++Iter)
    Iter-&gt;push_back(I);
}

void Cpu0AnalyzeImmediate::GetInstSeqLsADDiu(uint64_t Imm, unsigned RemSize,
                                             InstSeqLs &amp;SeqLs) {
  GetInstSeqLs((Imm + 0x8000ULL) &amp; 0xffffffffffff0000ULL, RemSize, SeqLs);
  AddInstr(SeqLs, Inst(ADDiu, Imm &amp; 0xffffULL));
}

void Cpu0AnalyzeImmediate::GetInstSeqLsORi(uint64_t Imm, unsigned RemSize,
                                           InstSeqLs &amp;SeqLs) {
  GetInstSeqLs(Imm &amp; 0xffffffffffff0000ULL, RemSize, SeqLs);
  AddInstr(SeqLs, Inst(ORi, Imm &amp; 0xffffULL));
}

void Cpu0AnalyzeImmediate::GetInstSeqLsSHL(uint64_t Imm, unsigned RemSize,
                                           InstSeqLs &amp;SeqLs) {
  unsigned Shamt = countTrailingZeros(Imm);
  GetInstSeqLs(Imm &gt;&gt; Shamt, RemSize - Shamt, SeqLs);
  AddInstr(SeqLs, Inst(SHL, Shamt));
}

void Cpu0AnalyzeImmediate::GetInstSeqLs(uint64_t Imm, unsigned RemSize,
                                        InstSeqLs &amp;SeqLs) {
  uint64_t MaskedImm = Imm &amp; (0xffffffffffffffffULL &gt;&gt; (64 - Size));

  // Do nothing if Imm is 0.
  if (!MaskedImm)
    return;

  // A single ADDiu will do if RemSize &lt;= 16.
  if (RemSize &lt;= 16) {
    AddInstr(SeqLs, Inst(ADDiu, MaskedImm));
    return;
  }

  // Shift if the lower 16-bit is cleared.
  if (!(Imm &amp; 0xffff)) {
    GetInstSeqLsSHL(Imm, RemSize, SeqLs);
    return;
  }

  GetInstSeqLsADDiu(Imm, RemSize, SeqLs);

  // If bit 15 is cleared, it doesn&#39;t make a difference whether the last
  // instruction is an ADDiu or ORi. In that case, do not call GetInstSeqLsORi.
  if (Imm &amp; 0x8000) {
    InstSeqLs SeqLsORi;
    GetInstSeqLsORi(Imm, RemSize, SeqLsORi);
    SeqLs.insert(SeqLs.end(), SeqLsORi.begin(), SeqLsORi.end());
  }
}

// Replace a ADDiu &amp; SHL pair with a LUi.
// e.g. the following two instructions
//  ADDiu 0x0111
//  SHL 18
// are replaced with
//  LUi 0x444
void Cpu0AnalyzeImmediate::ReplaceADDiuSHLWithLUi(InstSeq &amp;Seq) {
  // Check if the first two instructions are ADDiu and SHL and the shift amount
  // is at least 16.
  if ((Seq.size() &lt; 2) || (Seq[0].Opc != ADDiu) ||
      (Seq[1].Opc != SHL) || (Seq[1].ImmOpnd &lt; 16))
    return;

  // Sign-extend and shift operand of ADDiu and see if it still fits in 16-bit.
  int64_t Imm = SignExtend64&lt;16&gt;(Seq[0].ImmOpnd);
  int64_t ShiftedImm = (uint64_t)Imm &lt;&lt; (Seq[1].ImmOpnd - 16);

  if (!isInt&lt;16&gt;(ShiftedImm))
    return;

  // Replace the first instruction and erase the second.
  Seq[0].Opc = LUi;
  Seq[0].ImmOpnd = (unsigned)(ShiftedImm &amp; 0xffff);
  Seq.erase(Seq.begin() + 1);
}

void Cpu0AnalyzeImmediate::GetShortestSeq(InstSeqLs &amp;SeqLs, InstSeq &amp;Insts) {
  InstSeqLs::iterator ShortestSeq = SeqLs.end();
  // The length of an instruction sequence is at most 7.
  unsigned ShortestLength = 8;

  for (InstSeqLs::iterator S = SeqLs.begin(); S != SeqLs.end(); ++S) {
    ReplaceADDiuSHLWithLUi(*S);
    assert(S-&gt;size() &lt;= 7);

    if (S-&gt;size() &lt; ShortestLength) {
      ShortestSeq = S;
      ShortestLength = S-&gt;size();
    }
  }

  Insts.clear();
  Insts.append(ShortestSeq-&gt;begin(), ShortestSeq-&gt;end());
}

const Cpu0AnalyzeImmediate::InstSeq
&amp;Cpu0AnalyzeImmediate::Analyze(uint64_t Imm, unsigned Size,
                               bool LastInstrIsADDiu) {
  this-&gt;Size = Size;

  ADDiu = Cpu0::ADDiu;
  ORi = Cpu0::ORi;
  SHL = Cpu0::SHL;
  LUi = Cpu0::LUi;

  InstSeqLs SeqLs;

  // Get the list of instruction sequences.
  if (LastInstrIsADDiu | !Imm)
    GetInstSeqLsADDiu(Imm, Size, SeqLs);
  else
    GetInstSeqLs(Imm, Size, SeqLs);

  // Set Insts to the shortest instruction sequence.
  GetShortestSeq(SeqLs, Insts);

  return Insts;
}

#endif
</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter3_5/Cpu0InstrInfo.h</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="c1">#include &quot;Cpu0AnalyzeImmediate.h&quot;</span>
</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter3_5/Cpu0InstrInfo.td</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Cpu0InstAlias</span><span class="o">&lt;</span><span class="n">string</span> <span class="n">Asm</span><span class="p">,</span> <span class="n">dag</span> <span class="n">Result</span><span class="p">,</span> <span class="n">bit</span> <span class="n">Emit</span> <span class="o">=</span> <span class="mb">0b1</span><span class="o">&gt;</span> <span class="p">:</span>
  <span class="n">InstAlias</span><span class="o">&lt;</span><span class="n">Asm</span><span class="p">,</span> <span class="n">Result</span><span class="p">,</span> <span class="n">Emit</span><span class="o">&gt;</span><span class="p">;</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">shamt</span>       <span class="p">:</span> <span class="n">Operand</span><span class="o">&lt;</span><span class="n">i32</span><span class="o">&gt;</span><span class="p">;</span>

<span class="o">//</span> <span class="n">Unsigned</span> <span class="n">Operand</span>
<span class="k">def</span> <span class="nf">uimm16</span>      <span class="p">:</span> <span class="n">Operand</span><span class="o">&lt;</span><span class="n">i32</span><span class="o">&gt;</span> <span class="p">{</span>
  <span class="n">let</span> <span class="n">PrintMethod</span> <span class="o">=</span> <span class="s2">&quot;printUnsignedImm&quot;</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">//</span> <span class="n">Transformation</span> <span class="n">Function</span> <span class="o">-</span> <span class="n">get</span> <span class="n">the</span> <span class="n">lower</span> <span class="mi">16</span> <span class="n">bits</span><span class="o">.</span>
<span class="k">def</span> <span class="nf">LO16</span> <span class="p">:</span> <span class="n">SDNodeXForm</span><span class="o">&lt;</span><span class="n">imm</span><span class="p">,</span> <span class="p">[{</span>
  <span class="o">//</span> <span class="n">N</span> <span class="ow">is</span> <span class="n">SDNode</span><span class="p">,</span> <span class="n">getZExtValue</span><span class="p">()</span> <span class="ow">is</span> <span class="n">N</span><span class="s1">&#39;s member function</span>
  <span class="k">return</span> <span class="n">getImm</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="o">-&gt;</span><span class="n">getZExtValue</span><span class="p">()</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">);</span>
<span class="p">}]</span><span class="o">&gt;</span><span class="p">;</span>

<span class="o">//</span> <span class="n">Transformation</span> <span class="n">Function</span> <span class="o">-</span> <span class="n">get</span> <span class="n">the</span> <span class="n">higher</span> <span class="mi">16</span> <span class="n">bits</span><span class="o">.</span>
<span class="k">def</span> <span class="nf">HI16</span> <span class="p">:</span> <span class="n">SDNodeXForm</span><span class="o">&lt;</span><span class="n">imm</span><span class="p">,</span> <span class="p">[{</span>
  <span class="k">return</span> <span class="n">getImm</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="p">(</span><span class="n">N</span><span class="o">-&gt;</span><span class="n">getZExtValue</span><span class="p">()</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">);</span>
<span class="p">}]</span><span class="o">&gt;</span><span class="p">;</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span>// Node immediate fits as 16-bit zero extended on target immediate.
// The LO16 param means that only the lower 16 bits of the node
// immediate are caught.
// e.g. addiu, sltiu
def immZExt16  : PatLeaf&lt;(imm), [{
  if (N-&gt;getValueType(0) == MVT::i32)
    return (uint32_t)N-&gt;getZExtValue() == (unsigned short)N-&gt;getZExtValue();
  else
    return (uint64_t)N-&gt;getZExtValue() == (unsigned short)N-&gt;getZExtValue();
}], LO16&gt;;

// Immediate can be loaded with LUi (32-bit int with lower 16-bit cleared).
def immLow16Zero : PatLeaf&lt;(imm), [{
  int64_t Val = N-&gt;getSExtValue();
  return isInt&lt;32&gt;(Val) &amp;&amp; !(Val &amp; 0xffff);
}]&gt;;

// shamt field must fit in 5 bits.
def immZExt5 : ImmLeaf&lt;i32, [{return Imm == (Imm &amp; 0x1f);}]&gt;;
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span>let Predicates = [Ch3_5] in {
// Arithmetic and logical instructions with 3 register operands.
class ArithLogicR&lt;bits&lt;8&gt; op, string instr_asm, SDNode OpNode,
                  InstrItinClass itin, RegisterClass RC, bit isComm = 0&gt;:
  FA&lt;op, (outs GPROut:$ra), (ins RC:$rb, RC:$rc),
     !strconcat(instr_asm, &quot;\t$ra, $rb, $rc&quot;),
     [(set GPROut:$ra, (OpNode RC:$rb, RC:$rc))], itin&gt; {
  let shamt = 0;
  let isCommutable = isComm;	// e.g. add rb rc =  add rc rb
  let isReMaterializable = 1;
}
}
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span>let Predicates = [Ch3_5] in {
// Shifts
class shift_rotate_imm&lt;bits&lt;8&gt; op, bits&lt;4&gt; isRotate, string instr_asm,
                       SDNode OpNode, PatFrag PF, Operand ImmOpnd,
                       RegisterClass RC&gt;:
  FA&lt;op, (outs GPROut:$ra), (ins RC:$rb, ImmOpnd:$shamt),
     !strconcat(instr_asm, &quot;\t$ra, $rb, $shamt&quot;),
     [(set GPROut:$ra, (OpNode RC:$rb, PF:$shamt))], IIAlu&gt; {
  let rc = 0;
}

// 32-bit shift instructions.
class shift_rotate_imm32&lt;bits&lt;8&gt; op, bits&lt;4&gt; isRotate, string instr_asm,
                         SDNode OpNode&gt;:
  shift_rotate_imm&lt;op, isRotate, instr_asm, OpNode, immZExt5, shamt, CPURegs&gt;;
}
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span>let Predicates = [Ch3_5] in {
// Load Upper Imediate
class LoadUpper&lt;bits&lt;8&gt; op, string instr_asm, RegisterClass RC, Operand Imm&gt;:
  FL&lt;op, (outs RC:$ra), (ins Imm:$imm16),
     !strconcat(instr_asm, &quot;\t$ra, $imm16&quot;), [], IIAlu&gt; {
  let rb = 0;
  let isReMaterializable = 1;
}
}
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">let</span> <span class="n">Predicates</span> <span class="o">=</span> <span class="p">[</span><span class="n">Ch3_5</span><span class="p">]</span> <span class="ow">in</span> <span class="p">{</span>
<span class="k">def</span> <span class="nf">ORi</span>     <span class="p">:</span> <span class="n">ArithLogicI</span><span class="o">&lt;</span><span class="mh">0x0d</span><span class="p">,</span> <span class="s2">&quot;ori&quot;</span><span class="p">,</span> <span class="ow">or</span><span class="p">,</span> <span class="n">uimm16</span><span class="p">,</span> <span class="n">immZExt16</span><span class="p">,</span> <span class="n">CPURegs</span><span class="o">&gt;</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">let</span> <span class="n">Predicates</span> <span class="o">=</span> <span class="p">[</span><span class="n">Ch3_5</span><span class="p">]</span> <span class="ow">in</span> <span class="p">{</span>
<span class="k">def</span> <span class="nf">LUi</span>     <span class="p">:</span> <span class="n">LoadUpper</span><span class="o">&lt;</span><span class="mh">0x0f</span><span class="p">,</span> <span class="s2">&quot;lui&quot;</span><span class="p">,</span> <span class="n">GPROut</span><span class="p">,</span> <span class="n">uimm16</span><span class="o">&gt;</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">let</span> <span class="n">Predicates</span> <span class="o">=</span> <span class="p">[</span><span class="n">Ch3_5</span><span class="p">]</span> <span class="ow">in</span> <span class="p">{</span>
<span class="n">let</span> <span class="n">Predicates</span> <span class="o">=</span> <span class="p">[</span><span class="n">DisableOverflow</span><span class="p">]</span> <span class="ow">in</span> <span class="p">{</span>
<span class="k">def</span> <span class="nf">ADDu</span>    <span class="p">:</span> <span class="n">ArithLogicR</span><span class="o">&lt;</span><span class="mh">0x11</span><span class="p">,</span> <span class="s2">&quot;addu&quot;</span><span class="p">,</span> <span class="n">add</span><span class="p">,</span> <span class="n">IIAlu</span><span class="p">,</span> <span class="n">CPURegs</span><span class="p">,</span> <span class="mi">1</span><span class="o">&gt;</span><span class="p">;</span>
<span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">let</span> <span class="n">Predicates</span> <span class="o">=</span> <span class="p">[</span><span class="n">Ch3_5</span><span class="p">]</span> <span class="ow">in</span> <span class="p">{</span>
<span class="k">def</span> <span class="nf">SHL</span>     <span class="p">:</span> <span class="n">shift_rotate_imm32</span><span class="o">&lt;</span><span class="mh">0x1e</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="s2">&quot;shl&quot;</span><span class="p">,</span> <span class="n">shl</span><span class="o">&gt;</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span>let Predicates = [Ch3_5] in {
//===----------------------------------------------------------------------===//
// Instruction aliases
//===----------------------------------------------------------------------===//
def : Cpu0InstAlias&lt;&quot;move $dst, $src&quot;,
                    (ADDu GPROut:$dst, GPROut:$src,ZERO), 1&gt;;
}
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span>let Predicates = [Ch3_5] in {
def : Pat&lt;(i32 immZExt16:$in),
          (ORi ZERO, imm:$in)&gt;;
def : Pat&lt;(i32 immLow16Zero:$in),
          (LUi (HI16 imm:$in))&gt;;

// Arbitrary immediates
def : Pat&lt;(i32 imm:$imm),
          (ORi (LUi (HI16 imm:$imm)), (LO16 imm:$imm))&gt;;
} // let Predicates = [Ch3_4]
</pre></div>
</div>
<p>The Cpu0AnalyzeImmediate.cpp written in recursive with a little complicate in
logic. However, the recursive
skills is used in the front end compile book, you should fimiliar with it.
Instead of tracking the code, listing the stack size and the instructions
generated in &#8220;Table: Cpu0 stack adjustment instructions before replace addiu and
shl with lui instruction&#8221; as follows and &#8220;Table: Cpu0 stack adjustment
instructions after replace addiu and shl with lui instruction&#8221; at next,</p>
<table border="1" class="docutils" id="id11">
<caption><span class="caption-number">Table 13 </span><span class="caption-text">Cpu0 stack adjustment instructions before replace addiu and shl with lui instruction</span><a class="headerlink" href="#id11" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="19%" />
<col width="15%" />
<col width="33%" />
<col width="33%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">stack size range</th>
<th class="head">ex. stack size</th>
<th class="head">Cpu0 Prologue instructions</th>
<th class="head">Cpu0 Epilogue instructions</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>0 ~ 0x7ff8</td>
<td><ul class="first last simple">
<li>0x7ff8</li>
</ul>
</td>
<td><ul class="first last simple">
<li>addiu $sp, $sp, -32760;</li>
</ul>
</td>
<td><ul class="first last simple">
<li>addiu $sp, $sp, 32760;</li>
</ul>
</td>
</tr>
<tr class="row-odd"><td>0x8000 ~ 0xfff8</td>
<td><ul class="first last simple">
<li>0x8000</li>
</ul>
</td>
<td><ul class="first last simple">
<li>addiu $sp, $sp, -32768;</li>
</ul>
</td>
<td><ul class="first last simple">
<li>addiu $1, $zero, 1;</li>
<li>shl $1, $1, 16;</li>
<li>addiu $1, $1, -32768;</li>
<li>addu $sp, $sp, $1;</li>
</ul>
</td>
</tr>
<tr class="row-even"><td>x10000 ~ 0xfffffff8</td>
<td><ul class="first last simple">
<li>0x7ffffff8</li>
</ul>
</td>
<td><ul class="first last simple">
<li>addiu $1, $zero, 8;</li>
<li>shl $1, $1, 28;</li>
<li>addiu $1, $1, 8;</li>
<li>addu $sp, $sp, $1;</li>
</ul>
</td>
<td><ul class="first last simple">
<li>addiu $1, $zero, 8;</li>
<li>shl $1, $1, 28;</li>
<li>addiu $1, $1, -8;</li>
<li>addu $sp, $sp, $1;</li>
</ul>
</td>
</tr>
<tr class="row-odd"><td>x10000 ~ 0xfffffff8</td>
<td><ul class="first last simple">
<li>0x90008000</li>
</ul>
</td>
<td><ul class="first last simple">
<li>addiu $1, $zero, -9;</li>
<li>shl $1, $1, 28;</li>
<li>addiu $1, $1, -32768;</li>
<li>addu $sp, $sp, $1;</li>
</ul>
</td>
<td><ul class="first last simple">
<li>addiu $1, $zero, -28671;</li>
<li>shl $1, $1, 16</li>
<li>addiu $1, $1, -32768;</li>
<li>addu $sp, $sp, $1;</li>
</ul>
</td>
</tr>
</tbody>
</table>
<p>Since the Cpu0 stack is 8 bytes alignment, addresses from 0x7ff9 to 0x7fff are
impossible existing.</p>
<p>Assume sp = 0xa0008000 and stack size = 0x90008000, then (0xa0008000 -
0x90008000) =&gt; 0x10000000. Verify with the Cpu0 Prologue instructions as
follows,</p>
<ol class="arabic simple">
<li>&#8220;addiu       $1, $zero, -9&#8221; =&gt; ($1 = 0 + 0xfffffff7) =&gt; $1 = 0xfffffff7.</li>
<li>&#8220;shl $1, $1, 28;&#8221; =&gt; $1 = 0x70000000.</li>
<li>&#8220;addiu       $1, $1, -32768&#8221; =&gt; $1 = (0x70000000 + 0xffff8000) =&gt; $1 = 0x6fff8000.</li>
<li>&#8220;addu        $sp, $sp, $1&#8221; =&gt; $sp = (0xa0008000 + 0x6fff8000) =&gt; $sp = 0x10000000.</li>
</ol>
<p>Verify with the Cpu0 Epilogue instructions with sp = 0x10000000 and stack size =
0x90008000 as follows,</p>
<ol class="arabic simple">
<li>&#8220;addiu       $1, $zero, -28671&#8221; =&gt; ($1 = 0 + 0xffff9001) =&gt; $1 = 0xffff9001.</li>
<li>&#8220;shl $1, $1, 16;&#8221; =&gt; $1 = 0x90010000.</li>
<li>&#8220;addiu       $1, $1, -32768&#8221; =&gt; $1 = (0x90010000 + 0xffff8000) =&gt; $1 = 0x90008000.</li>
<li>&#8220;addu        $sp, $sp, $1&#8221; =&gt; $sp = (0x10000000 + 0x90008000) =&gt; $sp = 0xa0008000.</li>
</ol>
<p>The Cpu0AnalyzeImmediate::GetShortestSeq() will call Cpu0AnalyzeImmediate::
ReplaceADDiuSHLWithLUi() to replace addiu and shl with single instruction lui
only. The effect as the following table.</p>
<table border="1" class="docutils" id="id12">
<caption><span class="caption-number">Table 14 </span><span class="caption-text">Cpu0 stack adjustment instructions after replace addiu and shl with lui instruction</span><a class="headerlink" href="#id12" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="19%" />
<col width="15%" />
<col width="33%" />
<col width="33%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">stack size range</th>
<th class="head">ex. stack size</th>
<th class="head">Cpu0 Prologue instructions</th>
<th class="head">Cpu0 Epilogue instructions</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>0x8000 ~ 0xfff8</td>
<td><ul class="first last simple">
<li>0x8000</li>
</ul>
</td>
<td><ul class="first last simple">
<li>addiu $sp, $sp, -32768;</li>
</ul>
</td>
<td><ul class="first last simple">
<li>ori     $1, $zero, 32768;</li>
<li>addu $sp, $sp, $1;</li>
</ul>
</td>
</tr>
<tr class="row-odd"><td>x10000 ~ 0xfffffff8</td>
<td><ul class="first last simple">
<li>0x7ffffff8</li>
</ul>
</td>
<td><ul class="first last simple">
<li>lui $1, 32768;</li>
<li>addiu $1, $1, 8;</li>
<li>addu $sp, $sp, $1;</li>
</ul>
</td>
<td><ul class="first last simple">
<li>lui     $1, 32767;</li>
<li>ori     $1, $1, 65528</li>
<li>addu $sp, $sp, $1;</li>
</ul>
</td>
</tr>
<tr class="row-even"><td>x10000 ~ 0xfffffff8</td>
<td><ul class="first last simple">
<li>0x90008000</li>
</ul>
</td>
<td><ul class="first last simple">
<li>lui $1, 28671;</li>
<li>ori $1, $1, 32768;</li>
<li>addu $sp, $sp, $1;</li>
</ul>
</td>
<td><ul class="first last simple">
<li>lui $1, 36865;</li>
<li>addiu $1, $1, -32768;</li>
<li>addu $sp, $sp, $1;</li>
</ul>
</td>
</tr>
</tbody>
</table>
<p>Assume sp = 0xa0008000 and stack size = 0x90008000, then (0xa0008000 -
0x90008000) =&gt; 0x10000000. Verify with the Cpu0 Prologue instructions as
follows,</p>
<ol class="arabic simple">
<li>&#8220;lui $1, 28671&#8221; =&gt; $1 = 0x6fff0000.</li>
<li>&#8220;ori $1, $1, 32768&#8221; =&gt; $1 = (0x6fff0000 + 0x00008000) =&gt; $1 = 0x6fff8000.</li>
<li>&#8220;addu        $sp, $sp, $1&#8221; =&gt; $sp = (0xa0008000 + 0x6fff8000) =&gt; $sp = 0x10000000.</li>
</ol>
<p>Verify with the Cpu0 Epilogue instructions with sp = 0x10000000 and stack size =
0x90008000 as follows,</p>
<ol class="arabic simple">
<li>&#8220;lui $1, 36865&#8221; =&gt; $1 = 0x90010000.</li>
<li>&#8220;addiu $1, $1, -32768&#8221; =&gt; $1 = (0x90010000 + 0xffff8000) =&gt; $1 = 0x90008000.</li>
<li>&#8220;addu $sp, $sp, $1&#8221; =&gt; $sp = (0x10000000 + 0x90008000) =&gt; $sp = 0xa0008000.</li>
</ol>
<p>File ch3_largeframe.cpp include the large frame test.</p>
<p>Run Chapter3_5 with ch3_largeframe.cpp will get the following result.</p>
<p class="rubric">lbdex/input/ch3_largeframe.cpp</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="nb">int</span> <span class="n">test_largegframe</span><span class="p">()</span> <span class="p">{</span>
  <span class="nb">int</span> <span class="n">a</span><span class="p">[</span><span class="mi">469753856</span><span class="p">];</span>

  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">118-165-78-12:input Jonathan$</span> clang -target mips-unknown-linux-gnu -c
<span class="go">ch3_largeframe.cpp -emit-llvm -o ch3_largeframe.bc</span>
<span class="gp">118-165-78-12:input Jonathan$</span> /Users/Jonathan/llvm/test/cmake_debug_build/
<span class="go">Debug/bin/llc -march=cpu0 -relocation-model=pic -filetype=asm</span>
<span class="go">ch3_largeframe.bc.bc -o -</span>
<span class="go">  ...</span>
<span class="go">  .section .mdebug.abiO32</span>
<span class="go">  .previous</span>
<span class="go">  .file &quot;ch3_largeframe.bc&quot;</span>
<span class="go">  .globl  _Z16test_largegframev</span>
<span class="go">  .align  2</span>
<span class="go">  .type _Z16test_largegframev,@function</span>
<span class="go">  .ent  _Z16test_largegframev   # @_Z16test_largegframev</span>
<span class="go">_Z16test_largegframev:</span>
<span class="go">  .frame  $fp,1879015424,$lr</span>
<span class="go">  .mask   0x00000000,0</span>
<span class="go">  .set  noreorder</span>
<span class="go">  .set  nomacro</span>
<span class="go">  .set  noat</span>
<span class="gp">#</span> BB#0:
<span class="go">  lui $1, 36865</span>
<span class="go">  addiu $1, $1, -32768</span>
<span class="go">  addu  $sp, $sp, $1</span>
<span class="go">  addiu $2, $zero, 0</span>
<span class="go">  lui $1, 28672</span>
<span class="go">  addiu $1, $1, -32768</span>
<span class="go">  addu  $sp, $sp, $1</span>
<span class="go">  ret $lr</span>
<span class="go">  .set  at</span>
<span class="go">  .set  macro</span>
<span class="go">  .set  reorder</span>
<span class="go">  .end  _Z16test_largegframev</span>
<span class="gp">$</span>func_end0:
<span class="go">  .size _Z16test_largegframev, ($func_end0)-_Z16test_largegframev</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="data-operands-dags">
<h2><a class="toc-backref" href="#id23">Data operands DAGs</a><a class="headerlink" href="#data-operands-dags" title="Permalink to this headline">¶</a></h2>
<p>From above or compiler book, you can see all the OP code are the internal nodes
in DAGs graph, and operands are the leaves of DAGs.
To develop your backend, you can copy the
related data operands DAGs node from other backend since the IR data nodes are
take cared by all the backend.
About the data DAGs nodes, you can understand some of them through the
Cpu0InstrInfo.td and find them by command,
grep -R &#8220;&lt;datadag&gt;&#8221;  `find src/include/llvm`,
with spending a little more time to think or guess about it.
Some data DAGs we know more, some we know a little and some remains unknown but
it&#8217;s OK for us.
List some of data DAGs we understand and occured until now as follows,</p>
<p class="rubric">include/llvm/Target/TargetSelectionDAG.td</p>
<div class="highlight-c++"><div class="highlight"><pre><span></span><span class="c1">// PatLeaf&#39;s are pattern fragments that have no operands.  This is just a helper</span>
<span class="c1">// to define immediates and other common things concisely.</span>
<span class="k">class</span> <span class="nc">PatLeaf</span><span class="o">&lt;</span><span class="n">dag</span> <span class="n">frag</span><span class="p">,</span> <span class="n">code</span> <span class="n">pred</span> <span class="o">=</span> <span class="p">[{}],</span> <span class="n">SDNodeXForm</span> <span class="n">xform</span> <span class="o">=</span> <span class="n">NOOP_SDNodeXForm</span><span class="o">&gt;</span>
 <span class="o">:</span> <span class="n">PatFrag</span><span class="o">&lt;</span><span class="p">(</span><span class="n">ops</span><span class="p">),</span> <span class="n">frag</span><span class="p">,</span> <span class="n">pred</span><span class="p">,</span> <span class="n">xform</span><span class="o">&gt;</span><span class="p">;</span>

<span class="c1">// ImmLeaf is a pattern fragment with a constraint on the immediate.  The</span>
<span class="c1">// constraint is a function that is run on the immediate (always with the value</span>
<span class="c1">// sign extended out to an int64_t) as Imm.  For example:</span>
<span class="c1">//</span>
<span class="c1">//  def immSExt8 : ImmLeaf&lt;i16, [{ return (char)Imm == Imm; }]&gt;;</span>
<span class="c1">//</span>
<span class="c1">// this is a more convenient form to match &#39;imm&#39; nodes in than PatLeaf and also</span>
<span class="c1">// is preferred over using PatLeaf because it allows the code generator to</span>
<span class="c1">// reason more about the constraint.</span>
<span class="c1">//</span>
<span class="c1">// If FastIsel should ignore all instructions that have an operand of this type,</span>
<span class="c1">// the FastIselShouldIgnore flag can be set.  This is an optimization to reduce</span>
<span class="c1">// the code size of the generated fast instruction selector.</span>
<span class="k">class</span> <span class="nc">ImmLeaf</span><span class="o">&lt;</span><span class="n">ValueType</span> <span class="n">vt</span><span class="p">,</span> <span class="n">code</span> <span class="n">pred</span><span class="p">,</span> <span class="n">SDNodeXForm</span> <span class="n">xform</span> <span class="o">=</span> <span class="n">NOOP_SDNodeXForm</span><span class="o">&gt;</span>
  <span class="o">:</span> <span class="n">PatFrag</span><span class="o">&lt;</span><span class="p">(</span><span class="n">ops</span><span class="p">),</span> <span class="p">(</span><span class="n">vt</span> <span class="n">imm</span><span class="p">),</span> <span class="p">[{}],</span> <span class="n">xform</span><span class="o">&gt;</span> <span class="p">{</span>
  <span class="n">let</span> <span class="n">ImmediateCode</span> <span class="o">=</span> <span class="n">pred</span><span class="p">;</span>
  <span class="n">bit</span> <span class="n">FastIselShouldIgnore</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter3_5/Cpu0InstrInfo.td</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>// Signed Operand
def simm16      : Operand&lt;i32&gt; {
// LLVM supply the “let DecoderMethod” keyword to allow programmers implement 
// their decode function.
// LLVM will call these DecodeMethod when user uses Disassembler tools, such as
// llvm-objdump -d.
  let DecoderMethod= &quot;DecodeSimm16&quot;;
}
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">shamt</span>       <span class="p">:</span> <span class="n">Operand</span><span class="o">&lt;</span><span class="n">i32</span><span class="o">&gt;</span><span class="p">;</span>

<span class="o">//</span> <span class="n">Unsigned</span> <span class="n">Operand</span>
<span class="k">def</span> <span class="nf">uimm16</span>      <span class="p">:</span> <span class="n">Operand</span><span class="o">&lt;</span><span class="n">i32</span><span class="o">&gt;</span> <span class="p">{</span>
  <span class="n">let</span> <span class="n">PrintMethod</span> <span class="o">=</span> <span class="s2">&quot;printUnsignedImm&quot;</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span>// Address operand
def mem : Operand&lt;iPTR&gt; {
// Making llvm call function Cpu0InstPrinter::printMemOperand()
  let PrintMethod = &quot;printMemOperand&quot;;
// For example, ld $2, 4($sp), the mem operand is 4($sp):(ops CPURegs, simm16). 
  let MIOperandInfo = (ops CPURegs, simm16);
// Making llvm call function getMemEncoding() when either ld or st instruction is 
// issued in elf obj since these two instructions use mem Operand.
  let EncoderMethod = &quot;getMemEncoding&quot;;
</pre></div>
</div>
<div class="highlight-c++"><div class="highlight"><pre><span></span><span class="p">}</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">//</span> <span class="n">Transformation</span> <span class="n">Function</span> <span class="o">-</span> <span class="n">get</span> <span class="n">the</span> <span class="n">lower</span> <span class="mi">16</span> <span class="n">bits</span><span class="o">.</span>
<span class="k">def</span> <span class="nf">LO16</span> <span class="p">:</span> <span class="n">SDNodeXForm</span><span class="o">&lt;</span><span class="n">imm</span><span class="p">,</span> <span class="p">[{</span>
  <span class="o">//</span> <span class="n">N</span> <span class="ow">is</span> <span class="n">SDNode</span><span class="p">,</span> <span class="n">getZExtValue</span><span class="p">()</span> <span class="ow">is</span> <span class="n">N</span><span class="s1">&#39;s member function</span>
  <span class="k">return</span> <span class="n">getImm</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="o">-&gt;</span><span class="n">getZExtValue</span><span class="p">()</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">);</span>
<span class="p">}]</span><span class="o">&gt;</span><span class="p">;</span>

<span class="o">//</span> <span class="n">Transformation</span> <span class="n">Function</span> <span class="o">-</span> <span class="n">get</span> <span class="n">the</span> <span class="n">higher</span> <span class="mi">16</span> <span class="n">bits</span><span class="o">.</span>
<span class="k">def</span> <span class="nf">HI16</span> <span class="p">:</span> <span class="n">SDNodeXForm</span><span class="o">&lt;</span><span class="n">imm</span><span class="p">,</span> <span class="p">[{</span>
  <span class="k">return</span> <span class="n">getImm</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="p">(</span><span class="n">N</span><span class="o">-&gt;</span><span class="n">getZExtValue</span><span class="p">()</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">);</span>
<span class="p">}]</span><span class="o">&gt;</span><span class="p">;</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">//</span> <span class="n">Node</span> <span class="n">immediate</span> <span class="n">fits</span> <span class="k">as</span> <span class="mi">16</span><span class="o">-</span><span class="n">bit</span> <span class="n">sign</span> <span class="n">extended</span> <span class="n">on</span> <span class="n">target</span> <span class="n">immediate</span><span class="o">.</span>
<span class="o">//</span> <span class="n">e</span><span class="o">.</span><span class="n">g</span><span class="o">.</span> <span class="n">addi</span><span class="p">,</span> <span class="n">andi</span>
<span class="k">def</span> <span class="nf">immSExt16</span>  <span class="p">:</span> <span class="n">PatLeaf</span><span class="o">&lt;</span><span class="p">(</span><span class="n">imm</span><span class="p">),</span> <span class="p">[{</span> <span class="k">return</span> <span class="n">isInt</span><span class="o">&lt;</span><span class="mi">16</span><span class="o">&gt;</span><span class="p">(</span><span class="n">N</span><span class="o">-&gt;</span><span class="n">getSExtValue</span><span class="p">());</span> <span class="p">}]</span><span class="o">&gt;</span><span class="p">;</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span>// Node immediate fits as 16-bit zero extended on target immediate.
// The LO16 param means that only the lower 16 bits of the node
// immediate are caught.
// e.g. addiu, sltiu
def immZExt16  : PatLeaf&lt;(imm), [{
  if (N-&gt;getValueType(0) == MVT::i32)
    return (uint32_t)N-&gt;getZExtValue() == (unsigned short)N-&gt;getZExtValue();
  else
    return (uint64_t)N-&gt;getZExtValue() == (unsigned short)N-&gt;getZExtValue();
}], LO16&gt;;

// Immediate can be loaded with LUi (32-bit int with lower 16-bit cleared).
def immLow16Zero : PatLeaf&lt;(imm), [{
  int64_t Val = N-&gt;getSExtValue();
  return isInt&lt;32&gt;(Val) &amp;&amp; !(Val &amp; 0xffff);
}]&gt;;

// shamt field must fit in 5 bits.
def immZExt5 : ImmLeaf&lt;i32, [{return Imm == (Imm &amp; 0x1f);}]&gt;;
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span>// As TableGen is unable to generate selection code for complex addressing modes,
// selection of a MEMbol operand must be done manually. 
// Reference https://opus4.kobv.de/opus4-fau/files/1108/tricore_llvm.pdf
// Cpu0 Address Mode! SDNode frameindex could possibily be a match
// since load and store instructions from stack used it.
def addr : 
  ComplexPattern&lt;iPTR, 2, &quot;SelectAddr&quot;, [frameindex], [SDNPWantParent]&gt;;

//===----------------------------------------------------------------------===//
// Pattern fragment for load/store
//===----------------------------------------------------------------------===//

class AlignedLoad&lt;PatFrag Node&gt; :
  PatFrag&lt;(ops node:$ptr), (Node node:$ptr), [{
  LoadSDNode *LD = cast&lt;LoadSDNode&gt;(N);
  return LD-&gt;getMemoryVT().getSizeInBits()/8 &lt;= LD-&gt;getAlignment();
}]&gt;;

class AlignedStore&lt;PatFrag Node&gt; :
  PatFrag&lt;(ops node:$val, node:$ptr), (Node node:$val, node:$ptr), [{
  StoreSDNode *SD = cast&lt;StoreSDNode&gt;(N);
  return SD-&gt;getMemoryVT().getSizeInBits()/8 &lt;= SD-&gt;getAlignment();
}]&gt;;
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">load_a</span>          <span class="p">:</span> <span class="n">AlignedLoad</span><span class="o">&lt;</span><span class="n">load</span><span class="o">&gt;</span><span class="p">;</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">store_a</span>         <span class="p">:</span> <span class="n">AlignedStore</span><span class="o">&lt;</span><span class="n">store</span><span class="o">&gt;</span><span class="p">;</span>
</pre></div>
</div>
<p>As mentioned in sub-section &#8220;instruction selection&#8221; of last chapter,
immSExt16 is a data leaf DAG node and it will return true if its value is
in the range of signed 16 bits integer. The load_a, store_a and others are
similar but they check with alignment.</p>
<p>The mem is explained in chapter3_2 for print operand; addr is explained in
chapter3_3 for data DAG selection.
The simm16, ...,  inherited from Operand&lt;i32&gt; because Cpu0 is 32 bits.
It may over 16 bits, so immSExt16 pattern leaf is used to control it as example
ADDiu mention in last chapter.
PatLeaf immZExt16, immLow16Zero and ImmLeaf immZExt5 are similar to immSExt16.</p>
</div>
<div class="section" id="summary-of-this-chapter">
<h2><a class="toc-backref" href="#id24">Summary of this Chapter</a><a class="headerlink" href="#summary-of-this-chapter" title="Permalink to this headline">¶</a></h2>
<p>Summary the functions for llvm backend stages as the following table.</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">118-165-79-200:input Jonathan$</span> /Users/Jonathan/llvm/test/cmake_debug_build/
<span class="go">Debug/bin/llc -march=cpu0 -relocation-model=pic -filetype=asm ch3.bc</span>
<span class="go">-debug-pass=Structure -o -</span>
<span class="go">...</span>
<span class="go">Machine Branch Probability Analysis</span>
<span class="go">  ModulePass Manager</span>
<span class="go">    FunctionPass Manager</span>
<span class="go">      ...</span>
<span class="go">      CPU0 DAG-&gt;DAG Pattern Instruction Selection</span>
<span class="go">        Initial selection DAG</span>
<span class="go">        Optimized lowered selection DAG</span>
<span class="go">        Type-legalized selection DAG</span>
<span class="go">        Optimized type-legalized selection DAG</span>
<span class="go">        Legalized selection DAG</span>
<span class="go">        Optimized legalized selection DAG</span>
<span class="go">        Instruction selection</span>
<span class="go">        Selected selection DAG</span>
<span class="go">        Scheduling</span>
<span class="go">      ...</span>
<span class="go">      Greedy Register Allocator</span>
<span class="go">      ...</span>
<span class="go">      Prologue/Epilogue Insertion &amp; Frame Finalization</span>
<span class="go">      ...</span>
<span class="go">      Post-RA pseudo instruction expansion pass</span>
<span class="go">      ...</span>
<span class="go">      Cpu0 Assembly Printer</span>
</pre></div>
</div>
<table border="1" class="docutils" id="id13">
<caption><span class="caption-number">Table 15 </span><span class="caption-text">Functions for llvm backend stages</span><a class="headerlink" href="#id13" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="52%" />
<col width="48%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Stage</th>
<th class="head">Function</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>Before CPU0 DAG-&gt;DAG Pattern Instruction Selection</td>
<td><ul class="first last simple">
<li>Cpu0TargetLowering::LowerFormalArguments</li>
<li>Cpu0TargetLowering::LowerReturn</li>
</ul>
</td>
</tr>
<tr class="row-odd"><td>Instruction selection</td>
<td><ul class="first last simple">
<li>Cpu0DAGToDAGISel::Select</li>
</ul>
</td>
</tr>
<tr class="row-even"><td>Prologue/Epilogue Insertion &amp; Frame Finalization</td>
<td>&nbsp;</td>
</tr>
<tr class="row-odd"><td><ul class="first last simple">
<li>Determine spill callee saved registers</li>
</ul>
</td>
<td><ul class="first last simple">
<li>Cpu0SEFrameLowering::determineCalleeSaves</li>
</ul>
</td>
</tr>
<tr class="row-even"><td><ul class="first last simple">
<li>Spill callee saved registers</li>
</ul>
</td>
<td><ul class="first last simple">
<li>Cpu0SEFrameLowering::spillCalleeSavedRegisters</li>
</ul>
</td>
</tr>
<tr class="row-odd"><td><ul class="first last simple">
<li>Prolog</li>
</ul>
</td>
<td><ul class="first last simple">
<li>Cpu0SEFrameLowering::emitPrologue</li>
</ul>
</td>
</tr>
<tr class="row-even"><td><ul class="first last simple">
<li>Epilog</li>
</ul>
</td>
<td><ul class="first last simple">
<li>Cpu0SEFrameLowering::emitEpilogue</li>
</ul>
</td>
</tr>
<tr class="row-odd"><td><ul class="first last simple">
<li>Handle stack slot for local variables</li>
</ul>
</td>
<td><ul class="first last simple">
<li>Cpu0RegisterInfo::eliminateFrameIndex</li>
</ul>
</td>
</tr>
<tr class="row-even"><td>Post-RA pseudo instruction expansion pass</td>
<td><ul class="first last simple">
<li>Cpu0SEInstrInfo::expandPostRAPseudo</li>
</ul>
</td>
</tr>
<tr class="row-odd"><td>Cpu0 Assembly Printer</td>
<td><ul class="first last simple">
<li>Cpu0AsmPrinter.cpp, Cpu0MCInstLower.cpp</li>
<li>Cpu0InstPrinter.cpp</li>
</ul>
</td>
</tr>
</tbody>
</table>
<p>We add a pass in Instruction Section stage in section &#8220;Add Cpu0DAGToDAGISel
class&#8221;. You can embed your code into other passes like that. Please check
CodeGen/Passes.h for the information. Remember the pass is called according
the function unit as the <code class="docutils literal"><span class="pre">llc</span> <span class="pre">-debug-pass=Structure</span></code> indicated.</p>
<p>We have finished a simple compiler for cpu0 which only supports <strong>ld</strong>,
<strong>st</strong>, <strong>addiu</strong>, <strong>ori</strong>, <strong>lui</strong>, <strong>addu</strong>, <strong>shl</strong> and <strong>ret</strong> 8
instructions.</p>
<p>We are satisfied with this result.
But you may think “After so much code we program, and just get these 8
instructions!”.
The point is we have created a frame work for Cpu0 target machine (please
look back the llvm backend structure class inheritance tree early in this
chapter).
Until now, we have over 3000 lines of source code with comments which include
files *.cpp, *.h, *.td, CMakeLists.txt and LLVMBuild.txt.
It can be counted by command <code class="docutils literal"><span class="pre">wc</span> <span class="pre">`find</span> <span class="pre">dir</span> <span class="pre">-name</span> <span class="pre">*.cpp`</span></code> for files *.cpp,
*.h, *.td, *.txt.
LLVM front end tutorial have 700 lines of source code without comments in total.
Don&#8217;t feel down with this result.
In reality, writing a backend is warm up slowly but run fastly.
Clang has over 500,000 lines of source code with comments in clang/lib
directory which include C++ and Obj C support.
Mips backend of llvm 3.1 has only 15,000 lines with comments.
Even the complicate X86 CPU which CISC outside and RISC inside (micro
instruction), has only 45,000 lines in llvm 3.1 with comments.
In next chapter, we will show you that add a new instruction support is as easy
as 123.</p>
<table class="docutils footnote" frame="void" id="targetmachine" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id1">[1]</a></td><td><a class="reference external" href="http://llvm.org/docs/WritingAnLLVMBackend.html#target-machine">http://llvm.org/docs/WritingAnLLVMBackend.html#target-machine</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="datalayout" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id2">[2]</a></td><td><a class="reference external" href="http://llvm.org/docs/LangRef.html#data-layout">http://llvm.org/docs/LangRef.html#data-layout</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="registration" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id3">[3]</a></td><td><a class="reference external" href="http://jonathan2251.github.io/lbd/llvmstructure.html#target-registration">http://jonathan2251.github.io/lbd/llvmstructure.html#target-registration</a></td></tr>
</tbody>
</table>
</div>
</div>


      </div>
      <div class="bottomnav" role="navigation" aria-label="bottom navigation">
      
        <p>
        «&#160;&#160;<a href="llvmstructure.html">Cpu0 architecture and LLVM structure</a>
        &#160;&#160;::&#160;&#160;
        <a class="uplink" href="index.html">Contents</a>
        &#160;&#160;::&#160;&#160;
        <a href="otherinst.html">Arithmetic and logic instructions</a>&#160;&#160;»
        </p>

      </div>

    <div class="footer" role="contentinfo">
        &copy; Copyright 2016, Chen Chung-Shu.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.4.4.
    </div>
  </body>
</html>