
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>Cpu0 Architecture and LLVM Structure &#8212; Tutorial: Creating an LLVM Backend for the Cpu0 Architecture</title>
    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="_static/haiku.css" />
    <link rel="stylesheet" type="text/css" href="_static/graphviz.css" />
    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="_static/doctools.js"></script>
    <link rel="author" title="About these documents" href="about.html" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Backend structure" href="backendstructure.html" />
    <link rel="prev" title="About" href="about.html" /> 
  </head><body>
      <div class="header" role="banner"><h1 class="heading"><a href="index.html">
          <span>Tutorial: Creating an LLVM Backend for the Cpu0 Architecture</span></a></h1>
        <h2 class="heading"><span>Cpu0 Architecture and LLVM Structure</span></h2>
      </div>
      <div class="topnav" role="navigation" aria-label="top navigation">
      
        <p>
        «&#160;&#160;<a href="about.html">About</a>
        &#160;&#160;::&#160;&#160;
        <a class="uplink" href="index.html">Contents</a>
        &#160;&#160;::&#160;&#160;
        <a href="backendstructure.html">Backend structure</a>&#160;&#160;»
        </p>

      </div>
      <div class="content" role="main">
        
        
  <section id="cpu0-architecture-and-llvm-structure">
<span id="sec-llvmstructure"></span><h1>Cpu0 Architecture and LLVM Structure<a class="headerlink" href="#cpu0-architecture-and-llvm-structure" title="Permalink to this heading">¶</a></h1>
<nav class="contents local" id="contents">
<ul class="simple">
<li><p><a class="reference internal" href="#bnf-auto-generated-parsers-vs-handwritten-parsers" id="id77">BNF Auto-Generated Parsers vs. Handwritten Parsers</a></p>
<ul>
<li><p><a class="reference internal" href="#why-doesn-t-the-clang-compiler-use-yacc-lex-tools-to-parse-c" id="id78">Why doesn’t the Clang compiler use YACC/LEX tools to parse C++?</a></p></li>
<li><p><a class="reference internal" href="#compiler-compiler-tools-for-context-sensitive-c-parsing" id="id79">Compiler-Compiler Tools for Context-Sensitive C++ Parsing</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#cpu0-processor-architecture-details" id="id80">Cpu0 Processor Architecture Details</a></p>
<ul>
<li><p><a class="reference internal" href="#brief-introduction" id="id81">Brief introduction</a></p></li>
<li><p><a class="reference internal" href="#the-cpu0-instruction-set" id="id82">The Cpu0 Instruction Set</a></p>
<ul>
<li><p><a class="reference internal" href="#why-not-use-add-instead-of-sub" id="id83">Why Not Use ADD Instead of SUB?</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#the-status-register" id="id84">The Status Register</a></p></li>
<li><p><a class="reference internal" href="#cpu0-s-stages-of-instruction-execution" id="id85">Cpu0’s Stages of Instruction Execution</a></p></li>
<li><p><a class="reference internal" href="#cpu0-s-interrupt-vector" id="id86">Cpu0’s Interrupt Vector</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#llvm-structure" id="id87">LLVM Structure</a></p>
<ul>
<li><p><a class="reference internal" href="#ssa-form" id="id88">SSA Form</a></p></li>
<li><p><a class="reference internal" href="#dsa-form" id="id89">DSA Form</a></p></li>
<li><p><a class="reference internal" href="#three-phase-design" id="id90">Three-Phase Design</a></p></li>
<li><p><a class="reference internal" href="#llvm-s-target-description-files-td" id="id91">LLVM’s Target Description Files: .td</a></p></li>
<li><p><a class="reference internal" href="#llvm-code-generation-sequence" id="id92">LLVM Code Generation Sequence</a></p></li>
<li><p><a class="reference internal" href="#llvm-vs-gcc-in-structure" id="id93">LLVM vs. GCC in Structure</a></p></li>
<li><p><a class="reference internal" href="#llvm-blog" id="id94">LLVM Blog</a></p></li>
<li><p><a class="reference internal" href="#cfg-control-flow-graph" id="id95">CFG (Control Flow Graph)</a></p></li>
<li><p><a class="reference internal" href="#dag-directed-acyclic-graph" id="id96">DAG (Directed Acyclic Graph)</a></p></li>
<li><p><a class="reference internal" href="#instruction-selection" id="id97">Instruction Selection</a></p></li>
<li><p><a class="reference internal" href="#caller-and-callee-saved-registers" id="id98">Caller and Callee Saved Registers</a></p></li>
<li><p><a class="reference internal" href="#live-in-and-live-out-registers" id="id99">Live-In and Live-Out Registers</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#create-cpu0-backend" id="id100">Create Cpu0 Backend</a></p>
<ul>
<li><p><a class="reference internal" href="#cpu0-backend-machine-id-and-relocation-records" id="id101">Cpu0 Backend Machine ID and Relocation Records</a></p></li>
<li><p><a class="reference internal" href="#creating-the-initial-cpu0-td-files" id="id102">Creating the Initial Cpu0 .td Files</a></p></li>
<li><p><a class="reference internal" href="#target-registration" id="id103">Target Registration</a></p></li>
<li><p><a class="reference internal" href="#build-libraries-and-td-files" id="id104">Build Libraries and <cite>.td</cite> Files</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#options-for-llc-debugging" id="id105">Options for <cite>llc</cite> Debugging</a></p></li>
<li><p><a class="reference internal" href="#opt-debugging-options" id="id106"><cite>opt</cite> Debugging Options</a></p></li>
</ul>
</nav>
<p>Before you begin this tutorial, you should know that you can always try to
develop your own backend by porting code from existing backends.
The majority of the code you will want to investigate can be found in the
/lib/Target directory of your root LLVM installation.
As most major RISC instruction sets have some similarities, this may be the
avenue you might try if you are an experienced programmer and knowledgable of
compiler backends.</p>
<p>On the other hand, there is a steep learning curve and you may easily get stuck
debugging your new backend. You can easily spend a lot of time tracing which
methods are callbacks of some function, or which are calling some overridden
method deep in the LLVM codebase - and with a codebase as large as LLVM, all of
this can easily become difficult to keep track of.
This tutorial will help you work through this process while learning the
fundamentals of LLVM backend design.
It will show you what is necessary to get your first backend functional and
complete, and it should help you understand how to debug your backend when it
produces incorrect machine code using output provided by the compiler.</p>
<p>This chapter details the Cpu0 instruction set and the structure of LLVM.
The LLVM structure information is adapted from Chris Lattner’s LLVM chapter of
the Architecture of Open Source Applications book <a class="footnote-reference brackets" href="#aosa-book" id="id1" role="doc-noteref"><span class="fn-bracket">[</span>10<span class="fn-bracket">]</span></a>. You can read
the original article from the AOSA website if you prefer.</p>
<p>At the end of this Chapter, you will begin to create a new LLVM backend by
writing register and instruction definitions in the Target Description files
which will be used in next chapter.</p>
<p>Finally, there are compiler knowledge like DAG (Directed-Acyclic-Graph) and
instruction selection needed in llvm backend design, and they are explained
here.</p>
<section id="bnf-auto-generated-parsers-vs-handwritten-parsers">
<h2><a class="toc-backref" href="#id77" role="doc-backlink">BNF Auto-Generated Parsers vs. Handwritten Parsers</a><a class="headerlink" href="#bnf-auto-generated-parsers-vs-handwritten-parsers" title="Permalink to this heading">¶</a></h2>
<p><strong>Context Free Grammar:</strong></p>
<ul class="simple">
<li><p>“A context-free grammar defines a language that can be parsed independently
of surrounding input context; each production rule applies based solely on
the current nonterminal, not on neighboring symbols.”</p></li>
<li><p>All context-free grammars (CFGs) can be expressed in Backus-Naur Form (BNF).</p></li>
</ul>
<section id="why-doesn-t-the-clang-compiler-use-yacc-lex-tools-to-parse-c">
<h3><a class="toc-backref" href="#id78" role="doc-backlink">Why doesn’t the Clang compiler use YACC/LEX tools to parse C++?</a><a class="headerlink" href="#why-doesn-t-the-clang-compiler-use-yacc-lex-tools-to-parse-c" title="Permalink to this heading">¶</a></h3>
<p>Clang does not use YACC/LEX because <strong>C++ is too complex and context-sensitive</strong>
for traditional parser generators. YACC and LEX work with context-free grammars,
but C++ has many context-sensitive features, especially in templates below:</p>
<p class="rubric">Context-sensitive template instantiation</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;iostream&gt;</span><span class="cp"></span>

<span class="cp">#if TEMPLATE==1</span>
<span class="k">template</span><span class="w"> </span><span class="o">&lt;</span><span class="k">typename</span><span class="w"> </span><span class="nc">T</span><span class="o">&gt;</span><span class="w"></span>
<span class="kt">void</span><span class="w"> </span><span class="n">f</span><span class="p">(</span><span class="n">T</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Template f(T)&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="cp">#endif</span>

<span class="cp">#if FUNCTION==1</span>
<span class="kt">void</span><span class="w"> </span><span class="n">f</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Non-template f(int)&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="cp">#endif</span>

<span class="kt">int</span><span class="w"> </span><span class="n">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="cp">#if (TEMPLATE==1) || (FUNCTION==1)</span>
<span class="w">    </span><span class="n">f</span><span class="p">(</span><span class="mi">42</span><span class="p">);</span><span class="w">        </span><span class="c1">// Which one gets called?</span>
<span class="w">    </span><span class="n">f</span><span class="p">(</span><span class="sc">&#39;a&#39;</span><span class="p">);</span><span class="w">       </span><span class="c1">// Template or non-template?</span>
<span class="cp">#endif</span>
<span class="cp">#if TEMPLATE==1</span>
<span class="w">    </span><span class="n">f</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="sc">&#39;a&#39;</span><span class="p">);</span><span class="w">  </span><span class="c1">// Explicit template instantiation</span>
<span class="cp">#endif</span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="n">References</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">clang</span><span class="o">++</span><span class="w"> </span><span class="o">-</span><span class="n">DFUNCTION</span><span class="o">=</span><span class="mi">1</span><span class="w"> </span><span class="o">-</span><span class="n">DTEMPLATE</span><span class="o">=</span><span class="mi">0</span><span class="w"> </span><span class="n">cpp</span><span class="o">-</span><span class="k">template</span><span class="p">.</span><span class="n">cpp</span><span class="w"></span>
<span class="n">References</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">a</span><span class="p">.</span><span class="n">out</span><span class="w"></span>
<span class="n">Non</span><span class="o">-</span><span class="k">template</span><span class="w"> </span><span class="n">f</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="w"></span>
<span class="n">Non</span><span class="o">-</span><span class="k">template</span><span class="w"> </span><span class="n">f</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="w"></span>
<span class="n">References</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">clang</span><span class="o">++</span><span class="w"> </span><span class="o">-</span><span class="n">DFUNCTION</span><span class="o">=</span><span class="mi">0</span><span class="w"> </span><span class="o">-</span><span class="n">DTEMPLATE</span><span class="o">=</span><span class="mi">1</span><span class="w"> </span><span class="n">cpp</span><span class="o">-</span><span class="k">template</span><span class="p">.</span><span class="n">cpp</span><span class="w"></span>
<span class="n">References</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">a</span><span class="p">.</span><span class="n">out</span><span class="w"></span>
<span class="n">Template</span><span class="w"> </span><span class="n">f</span><span class="p">(</span><span class="n">T</span><span class="p">)</span><span class="w"></span>
<span class="n">Template</span><span class="w"> </span><span class="n">f</span><span class="p">(</span><span class="n">T</span><span class="p">)</span><span class="w"></span>
<span class="n">Template</span><span class="w"> </span><span class="n">f</span><span class="p">(</span><span class="n">T</span><span class="p">)</span><span class="w"></span>
<span class="n">References</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">clang</span><span class="o">++</span><span class="w"> </span><span class="o">-</span><span class="n">DFUNCTION</span><span class="o">=</span><span class="mi">1</span><span class="w"> </span><span class="o">-</span><span class="n">DTEMPLATE</span><span class="o">=</span><span class="mi">1</span><span class="w"> </span><span class="n">cpp</span><span class="o">-</span><span class="k">template</span><span class="p">.</span><span class="n">cpp</span><span class="w"></span>
<span class="n">References</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">a</span><span class="p">.</span><span class="n">out</span><span class="w"></span>
<span class="n">Non</span><span class="o">-</span><span class="k">template</span><span class="w"> </span><span class="n">f</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="w"></span>
<span class="n">Template</span><span class="w"> </span><span class="n">f</span><span class="p">(</span><span class="n">T</span><span class="p">)</span><span class="w"></span>
<span class="n">Template</span><span class="w"> </span><span class="n">f</span><span class="p">(</span><span class="n">T</span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
<p>In the C++ code above, both f(42) and f(‘a’) can match either the template
function or the non-template function.</p>
<p>🤯 Why This Is Hard for YACC:</p>
<p>YACC operates on context-free grammars, but this example is context-sensitive.
The expression f(‘a’); selects a template if a template definition exists;
otherwise, it selects a function if a function definition exists. As a result,
this behavior cannot be implemented using BNF-based tools like YACC/LEX.</p>
<p>To parse this example, the following are required:</p>
<ul class="simple">
<li><p>Template argument deduction: The compiler must infer T from the call.</p></li>
<li><p>Overload resolution: It must choose between the template and non-template
versions.</p></li>
<li><p>Implicit conversions: ‘a’ can be converted to int, which affects overload
ranking.</p></li>
<li><p>Explicit template instantiation: f&lt;int&gt;(‘a’) forces the template, but YACC
doesn’t track template types.</p></li>
</ul>
<p>To model this in YACC:</p>
<p>You’d need to simulate template instantiation and ranking — which is way beyond
what YACC was designed for.</p>
<p>This kind of logic is not just syntactic — it’s deeply semantic. That’s why
compilers like Clang use handwritten parsers with tight integration between
parsing and semantic analysis.</p>
<p>Clang doesn’t use YACC/LEX because:</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Feature</p></th>
<th class="head"><p>YACC/LEX</p></th>
<th class="head"><p>Hand-written Parser</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Handles context-sensitive grammar</p></td>
<td><p>❌</p></td>
<td><p>✅</p></td>
</tr>
<tr class="row-odd"><td><p>Good error recovery</p></td>
<td><p>❌</p></td>
<td><p>✅</p></td>
</tr>
<tr class="row-even"><td><p>Integration with semantic analysis</p></td>
<td><p>❌</p></td>
<td><p>✅</p></td>
</tr>
<tr class="row-odd"><td><p>Easy to maintain/extend for C++</p></td>
<td><p>❌</p></td>
<td><p>✅</p></td>
</tr>
<tr class="row-even"><td><p>Fine-grained control</p></td>
<td><p>❌</p></td>
<td><p>✅</p></td>
</tr>
</tbody>
</table>
<p>The GNU <cite>g++</cite> compiler abandoned BNF tools starting from version 3.x.</p>
</section>
<section id="compiler-compiler-tools-for-context-sensitive-c-parsing">
<h3><a class="toc-backref" href="#id79" role="doc-backlink">Compiler-Compiler Tools for Context-Sensitive C++ Parsing</a><a class="headerlink" href="#compiler-compiler-tools-for-context-sensitive-c-parsing" title="Permalink to this heading">¶</a></h3>
<p>While traditional tools like YACC/Lex are limited to context-free grammars,
modern compiler construction requires handling context-sensitive features —
especially in C++ templates, overload resolution, and semantic analysis.
Below is a list of tools that attempt to address these challenges.</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Tool</p></th>
<th class="head"><p>Generates Parser Code?</p></th>
<th class="head"><p>Context-Sensitive Support?</p></th>
<th class="head"><p>Notes</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>ANTLR</p></td>
<td><p>✅ Yes</p></td>
<td><p>⚠️ Limited</p></td>
<td><p>Supports semantic predicates; struggles with full C++ complexity</p></td>
</tr>
<tr class="row-odd"><td><p>BNFLite</p></td>
<td><p>✅ Yes</p></td>
<td><p>⚠️ Partial</p></td>
<td><p>Lightweight C++ template library; ideal for DSLs, not full C++</p></td>
</tr>
<tr class="row-even"><td><p>PEGTL</p></td>
<td><p>✅ Yes</p></td>
<td><p>⚠️ Limited</p></td>
<td><p>PEG-based parser combinator library in C++; expressive but limited</p></td>
</tr>
<tr class="row-odd"><td><p>GLR Parsers (Elsa)</p></td>
<td><p>✅ Yes</p></td>
<td><p>✅ Yes</p></td>
<td><p>Can handle ambiguity and deferred resolution; used in research</p></td>
</tr>
<tr class="row-even"><td><p>Clang LibTooling</p></td>
<td><p>✅ Yes (via AST)</p></td>
<td><p>✅ Yes</p></td>
<td><p>Offers full C++ parsing + semantic analysis; industrial-grade tooling</p></td>
</tr>
</tbody>
</table>
<p>Why Most Tools Fall Short:</p>
<ul class="simple">
<li><p>C++ templates are <strong>Turing-complete</strong>, making static analysis alone insufficient.</p></li>
<li><p>Overload resolution requires understanding <strong>types, scopes, and conversions</strong>.</p></li>
<li><p>C++ syntax is <strong>deeply ambiguous</strong>, defying context-free parsing strategies.</p></li>
</ul>
<p>Recommended Approach:</p>
<p>For building C++ parsers:</p>
<ul class="simple">
<li><p>Use <strong>GLR-based tools</strong> like Elsa if ambiguity and template complexity must
be handled directly.</p></li>
<li><p>Or leverage <strong>Clang LibTooling</strong> for full semantic integration, AST
manipulation, and robust code analysis.</p></li>
</ul>
<p>In summary, while modern tools improve on YACC/LEX, <strong>the complexity of C++ still
requires a custom parser that deeply integrates with semantic analysis and type
resolution. Clang’s approach remains the most practical for full C++ support.
Moreover the error messages and recovery are still weaker than Clang</strong>.</p>
<p>While C++ compilers do not benefit from BNF
generator tools, many other programming and scripting languages, which are
more context-free, can take advantage of them.
The following information comes from Wikipedia:</p>
<p>Java syntax has a context-free grammar that can be parsed by a simple LALR
parser. Parsing C++ is more complicated <a class="footnote-reference brackets" href="#java-cpp" id="id2" role="doc-noteref"><span class="fn-bracket">[</span>1<span class="fn-bracket">]</span></a>.</p>
</section>
</section>
<section id="cpu0-processor-architecture-details">
<h2><a class="toc-backref" href="#id80" role="doc-backlink">Cpu0 Processor Architecture Details</a><a class="headerlink" href="#cpu0-processor-architecture-details" title="Permalink to this heading">¶</a></h2>
<p>This section is based on materials available here <a class="footnote-reference brackets" href="#cpu0-chinese" id="id3" role="doc-noteref"><span class="fn-bracket">[</span>2<span class="fn-bracket">]</span></a> (Chinese)
and here <a class="footnote-reference brackets" href="#cpu0-english" id="id4" role="doc-noteref"><span class="fn-bracket">[</span>3<span class="fn-bracket">]</span></a> (English). However, I changed some ISA from original
Cpu0 for designing a simple integer operational CPU and llvm backend. This is
my intention for writing this book that I want to know what a simple and robotic
CPU ISA and llvm backend can be.</p>
<section id="brief-introduction">
<h3><a class="toc-backref" href="#id81" role="doc-backlink">Brief introduction</a><a class="headerlink" href="#brief-introduction" title="Permalink to this heading">¶</a></h3>
<p>Cpu0 is a 32-bit architecture. It has 16 general purpose registers (R0, …,
R15), co-processor registers (like Mips), and other special registers. Its
structure is illustrated in <a class="reference internal" href="#llvmstructure-f1"><span class="std std-numref">Fig. 3</span></a> below.</p>
<figure class="align-center" id="id49">
<span id="llvmstructure-f1"></span><a class="reference internal image-reference" href="_images/14.png"><img alt="_images/14.png" src="_images/14.png" style="width: 608px; height: 360px;" /></a>
<figcaption>
<p><span class="caption-number">Fig. 3 </span><span class="caption-text">Architectural block diagram of the Cpu0 processor</span><a class="headerlink" href="#id49" title="Permalink to this image">¶</a></p>
</figcaption>
</figure>
<p>The registers are used for the following purposes:</p>
<table class="docutils align-default" id="id50">
<caption><span class="caption-number">Table 2 </span><span class="caption-text">Cpu0 general purpose registers (GPR)</span><a class="headerlink" href="#id50" title="Permalink to this table">¶</a></caption>
<thead>
<tr class="row-odd"><th class="head"><p>Register</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>R0</p></td>
<td><p>Constant register, value is 0</p></td>
</tr>
<tr class="row-odd"><td><p>R1-R10</p></td>
<td><p>General-purpose registers</p></td>
</tr>
<tr class="row-even"><td><p>R11</p></td>
<td><p>Global Pointer register (GP)</p></td>
</tr>
<tr class="row-odd"><td><p>R12</p></td>
<td><p>Frame Pointer register (FP)</p></td>
</tr>
<tr class="row-even"><td><p>R13</p></td>
<td><p>Stack Pointer register (SP)</p></td>
</tr>
<tr class="row-odd"><td><p>R14</p></td>
<td><p>Link Register (LR)</p></td>
</tr>
<tr class="row-even"><td><p>R15</p></td>
<td><p>Status Word Register (SW)</p></td>
</tr>
</tbody>
</table>
<table class="docutils align-default" id="id51">
<caption><span class="caption-number">Table 3 </span><span class="caption-text">Cpu0 co-processor 0 registers (C0R)</span><a class="headerlink" href="#id51" title="Permalink to this table">¶</a></caption>
<thead>
<tr class="row-odd"><th class="head"><p>Register</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>0</p></td>
<td><p>Program Counter (PC)</p></td>
</tr>
<tr class="row-odd"><td><p>1</p></td>
<td><p>Error Program Counter (EPC)</p></td>
</tr>
</tbody>
</table>
<table class="docutils align-default" id="id52">
<caption><span class="caption-number">Table 4 </span><span class="caption-text">Cpu0 other registers</span><a class="headerlink" href="#id52" title="Permalink to this table">¶</a></caption>
<thead>
<tr class="row-odd"><th class="head"><p>Register</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>IR</p></td>
<td><p>Instruction register</p></td>
</tr>
<tr class="row-odd"><td><p>MAR</p></td>
<td><p>Memory Address Register (MAR)</p></td>
</tr>
<tr class="row-even"><td><p>MDR</p></td>
<td><p>Memory Data Register (MDR)</p></td>
</tr>
<tr class="row-odd"><td><p>HI</p></td>
<td><p>High part of MULT result</p></td>
</tr>
<tr class="row-even"><td><p>LO</p></td>
<td><p>Low part of MULT result</p></td>
</tr>
</tbody>
</table>
</section>
<section id="the-cpu0-instruction-set">
<h3><a class="toc-backref" href="#id82" role="doc-backlink">The Cpu0 Instruction Set</a><a class="headerlink" href="#the-cpu0-instruction-set" title="Permalink to this heading">¶</a></h3>
<p>The Cpu0 instruction set is categorized into three types:</p>
<ul class="simple">
<li><p><strong>L-type instructions</strong>: Primarily used for memory operations.</p></li>
<li><p><strong>A-type instructions</strong>: Designed for arithmetic operations.</p></li>
<li><p><strong>J-type instructions</strong>: Typically used for altering control flow (e.g., jumps).</p></li>
</ul>
<p><a class="reference internal" href="#llvmstructure-f2"><span class="std std-numref">Fig. 4</span></a> illustrates the bitfield breakdown for each
instruction type.</p>
<figure class="align-center" id="id53">
<span id="llvmstructure-f2"></span><a class="reference internal image-reference" href="_images/22.png"><img alt="_images/22.png" src="_images/22.png" style="width: 530.0px; height: 292.0px;" /></a>
<figcaption>
<p><span class="caption-number">Fig. 4 </span><span class="caption-text">Cpu0’s three instruction formats</span><a class="headerlink" href="#id53" title="Permalink to this image">¶</a></p>
</figcaption>
</figure>
<table class="docutils align-default" id="id54">
<caption><span class="caption-number">Table 5 </span><span class="caption-text">C, llvm-ir <a class="footnote-reference brackets" href="#langref" id="id5" role="doc-noteref"><span class="fn-bracket">[</span>13<span class="fn-bracket">]</span></a> and Cpu0</span><a class="headerlink" href="#id54" title="Permalink to this table">¶</a></caption>
<thead>
<tr class="row-odd"><th class="head"><p>C</p></th>
<th class="head"><p>llvm-ir</p></th>
<th class="head"><p>Cpu0</p></th>
<th class="head"><p>I or II</p></th>
<th class="head"><p>Comment</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>=</p></td>
<td><p>load/store</p></td>
<td><p>ld/lb/lbu/lh/lhu</p></td>
<td><p>I</p></td>
<td></td>
</tr>
<tr class="row-odd"><td><p>&amp;, &amp;&amp;</p></td>
<td><p>and</p></td>
<td><p>and</p></td>
<td><p>I</p></td>
<td></td>
</tr>
<tr class="row-even"><td><p>|, ||</p></td>
<td><p>or</p></td>
<td><p>or</p></td>
<td><p>I</p></td>
<td></td>
</tr>
<tr class="row-odd"><td><p>^</p></td>
<td><p>xor</p></td>
<td><p>xor/nor</p></td>
<td><p>I</p></td>
<td><p>! can be got from two ir</p></td>
</tr>
<tr class="row-even"><td><p>!</p></td>
<td><ul class="simple">
<li><p>%tobool = icmp ne i32 %6, 0</p></li>
<li><p>%lnot = xor i1 %tobool, true</p></li>
</ul>
</td>
<td><ul class="simple">
<li><p>cmp</p></li>
<li><p>xor</p></li>
</ul>
</td>
<td></td>
<td></td>
</tr>
<tr class="row-odd"><td><p>==, !=, &lt;, &lt;=, &gt;, &gt;=</p></td>
<td><p>icmp/fcmp &lt;cond&gt; cond:eq/ne,…</p></td>
<td><p>cmp/ucmp … + floating-lib</p></td>
<td><p>I</p></td>
<td></td>
</tr>
<tr class="row-even"><td><p>“</p></td>
<td><p>“</p></td>
<td><p>slt/sltu/slti/sltiu</p></td>
<td><p>II</p></td>
<td><p>slti/sltiu: ex. a == 3 reduce instructions</p></td>
</tr>
<tr class="row-odd"><td><p>if (a &lt;= b)</p></td>
<td><p>icmp/fcmp &lt;cond&gt; +
br i1 &lt;cond&gt;, …</p></td>
<td><p>cmp/uccmp + jeq/jne/jlt/jgt/jle/jge</p></td>
<td><p>I</p></td>
<td><p>Conditional branch</p></td>
</tr>
<tr class="row-even"><td><p>if (bool)</p></td>
<td><p>br i1 &lt;cond&gt;, …</p></td>
<td><p>jeq/jne</p></td>
<td><p>I</p></td>
<td></td>
</tr>
<tr class="row-odd"><td><p>“</p></td>
<td><p>“</p></td>
<td><p>beq/bne</p></td>
<td><p>II</p></td>
<td></td>
</tr>
<tr class="row-even"><td><p>goto</p></td>
<td><p>br &lt;dest&gt;</p></td>
<td><p>jmp</p></td>
<td><p>I</p></td>
<td><p>Uncondictional branch</p></td>
</tr>
<tr class="row-odd"><td><p>call sub-function</p></td>
<td><p>call</p></td>
<td><p>jsub</p></td>
<td><p>I</p></td>
<td><p>Provide 24-bit address range of calling sub-function (the address from caller to callee is within 24-bit)</p></td>
</tr>
<tr class="row-even"><td><p>“</p></td>
<td><p>“</p></td>
<td><p>jalr</p></td>
<td><p>I</p></td>
<td><p>Add for 32-bit address range of calling sub-function</p></td>
</tr>
<tr class="row-odd"><td><p>return</p></td>
<td><p>ret</p></td>
<td><p>ret</p></td>
<td><p>I</p></td>
<td></td>
</tr>
<tr class="row-even"><td><p>+, -, *</p></td>
<td><p>add/fadd, sub/fsub, mul/fmul</p></td>
<td><p>add/addu/addiu, sub/subu, mul</p></td>
<td><p>I</p></td>
<td></td>
</tr>
<tr class="row-odd"><td><p>/, %</p></td>
<td><p>udiv/sdiv/fdiv, urem/srem/frem</p></td>
<td><p>div, mfhi/mflo/mthi/mtlo</p></td>
<td><p>I</p></td>
<td></td>
</tr>
<tr class="row-even"><td><p>&lt;&lt;, &gt;&gt;</p></td>
<td><p>shl, lshr/ashr</p></td>
<td><p>shl/rol/rolv, srl/sra/ror/rorv</p></td>
<td><p>II</p></td>
<td></td>
</tr>
<tr class="row-odd"><td><p>float &lt;-&gt; int</p></td>
<td><p>fptoui, sitofp, …</p></td>
<td></td>
<td></td>
<td><p>Cpu0 uses SW for floating value, and these two IR are for HW floating instruction</p></td>
</tr>
<tr class="row-even"><td><p>__builtin_clz/clo</p></td>
<td><p>llvm.clz/llvm_clo</p></td>
<td><p>floating-lib + clz, clo</p></td>
<td><p>I</p></td>
<td><p>For SW floating-lib, uses __builtin_clz / __builtin_clo in clang and clang generates llvm.clz/llvm.clo intrinsic function</p></td>
</tr>
<tr class="row-odd"><td><p>__builtin_eh_xxx</p></td>
<td><p>llvm.eh.xxx</p></td>
<td><p>st/ld</p></td>
<td><p>I</p></td>
<td><p>pass information to exception handler through $4, $5</p></td>
</tr>
</tbody>
</table>
<table class="docutils align-default" id="id55">
<caption><span class="caption-number">Table 6 </span><span class="caption-text">C++, llvm-ir <a class="footnote-reference brackets" href="#langref" id="id6" role="doc-noteref"><span class="fn-bracket">[</span>13<span class="fn-bracket">]</span></a> and Cpu0</span><a class="headerlink" href="#id55" title="Permalink to this table">¶</a></caption>
<thead>
<tr class="row-odd"><th class="head"><p>C++</p></th>
<th class="head"><p>llvm-ir</p></th>
<th class="head"><p>Cpu0</p></th>
<th class="head"><p>I or II</p></th>
<th class="head"><p>Comment</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>try {  }</p></td>
<td><p>invoke void &#64;_Z15throw_exception</p></td>
<td><p>jsub  _Z15throw_exception</p></td>
<td><p>I</p></td>
<td></td>
</tr>
<tr class="row-odd"><td><p>catch { }</p></td>
<td><p>landingpad…catch</p></td>
<td><p>st and ld</p></td>
<td><p>I</p></td>
<td><p>st/ld $4 &amp; $5 to/from stack, $4:exception address, $5: exception typeid</p></td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><strong>Selection of LLVM-IR and the ISA for a RISC CPU</strong></p>
<ul class="simple">
<li><p>LLVM-IR and the ISA of a RISC CPU emerged after the C language.
As shown in the table above, they can be selected based on C language
constructs.</p></li>
<li><p>Not listed in the table, LLVM-IR includes terminator instructions such as
<cite>switch</cite>, <cite>invoke</cite>, and others, as well as atomic operations and a variety
of LLVM intrinsics. These intrinsics provide better performance for backend
implementations, such as <cite>llvm.vector.reduce.*</cite>.</p></li>
<li><p>For vector processing on CPUs/GPUs, vector-type math LLVM-IR or
LLVM intrinsics can be used for implementation.</p></li>
</ul>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><strong>Selection of the ISA for Cpu0</strong></p>
<ul class="simple">
<li><p>The original author of Cpu0 designed its ISA as a teaching material,
without focusing on performance.</p></li>
<li><p>My goal is to refine the ISA selection and design, considering both its
role as an LLVM tutorial and its basic performance as an ISA. I am not
interested in a poorly designed ISA.</p>
<ul>
<li><p>As shown in the table above, <cite>“if (a &lt;= b)”</cite> can be rewritten as
<cite>“t = (a &lt;= b)”</cite> followed by <cite>“if (t)”</cite>.
Thus, I designed <strong>ISA II of Cpu0</strong> to use <cite>“slt + beq”</cite> instead of
<cite>“cmp + jeq”</cite>, reducing six conditional jump instructions
(<cite>jeq/jne/jlt/jgt/jle/jge</cite>) to just two (<cite>beq/bne</cite>).
This balances complexity and performance in the Cpu0 ISA.</p></li>
<li><p>For the same reason, I adopted <strong>slt</strong> from <strong>MIPS</strong> instead of <strong>cmp</strong>
from <strong>ARM</strong>. This allows the destination register to be any general-
purpose register (GPR), avoiding bottlenecks caused by a shared
“status register.”</p></li>
<li><p>Floating-point operations can be implemented in software, so Cpu0
only supports integer instructions. I added <strong>clz</strong> (count leading zeros)
and <strong>clo</strong> (count leading ones) to Cpu0 since floating-point libraries,
such as <cite>compiler-rt/builtin</cite>, rely on these built-in functions.
Floating-point normalization can leverage <strong>clz</strong> and <strong>clo</strong> for
performance improvements. Although Cpu0 could use multiple instructions
to implement <cite>llvm.clz</cite> and <cite>llvm.clo</cite>, having dedicated <strong>clz/clo</strong>
instructions allows execution in a single instruction.</p></li>
<li><p>I extended <strong>ISA II of Cpu0</strong> for better performance, following the
principles of MIPS.</p></li>
</ul>
</li>
</ul>
</div>
<p>The following table provides details on the cpu032I instruction set:</p>
<ul class="simple">
<li><p>First column F.: meaning Format.</p></li>
</ul>
<table class="docutils align-default" id="id56">
<caption><span class="caption-number">Table 7 </span><span class="caption-text">cpu032I Instruction Set</span><a class="headerlink" href="#id56" title="Permalink to this table">¶</a></caption>
<colgroup>
<col style="width: 3%" />
<col style="width: 11%" />
<col style="width: 8%" />
<col style="width: 31%" />
<col style="width: 19%" />
<col style="width: 28%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>F.</p></th>
<th class="head"><p>Mnemonic</p></th>
<th class="head"><p>Opcode</p></th>
<th class="head"><p>Meaning</p></th>
<th class="head"><p>Syntax</p></th>
<th class="head"><p>Operation</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>L</p></td>
<td><p>NOP</p></td>
<td><p>00</p></td>
<td><p>No Operation</p></td>
<td></td>
<td></td>
</tr>
<tr class="row-odd"><td><p>L</p></td>
<td><p>LD</p></td>
<td><p>01</p></td>
<td><p>Load word</p></td>
<td><p>LD Ra, [Rb+Cx]</p></td>
<td><p>Ra &lt;= [Rb+Cx]</p></td>
</tr>
<tr class="row-even"><td><p>L</p></td>
<td><p>ST</p></td>
<td><p>02</p></td>
<td><p>Store word</p></td>
<td><p>ST Ra, [Rb+Cx]</p></td>
<td><p>[Rb+Cx] &lt;= Ra</p></td>
</tr>
<tr class="row-odd"><td><p>L</p></td>
<td><p>LB</p></td>
<td><p>03</p></td>
<td><p>Load byte</p></td>
<td><p>LB Ra, [Rb+Cx]</p></td>
<td><p>Ra &lt;= (byte)[Rb+Cx] <a class="footnote-reference brackets" href="#lb-note" id="id7" role="doc-noteref"><span class="fn-bracket">[</span>4<span class="fn-bracket">]</span></a></p></td>
</tr>
<tr class="row-even"><td><p>L</p></td>
<td><p>LBu</p></td>
<td><p>04</p></td>
<td><p>Load byte unsigned</p></td>
<td><p>LBu Ra, [Rb+Cx]</p></td>
<td><p>Ra &lt;= (byte)[Rb+Cx] <a class="footnote-reference brackets" href="#lb-note" id="id8" role="doc-noteref"><span class="fn-bracket">[</span>4<span class="fn-bracket">]</span></a></p></td>
</tr>
<tr class="row-odd"><td><p>L</p></td>
<td><p>SB</p></td>
<td><p>05</p></td>
<td><p>Store byte</p></td>
<td><p>SB Ra, [Rb+Cx]</p></td>
<td><p>[Rb+Cx] &lt;= (byte)Ra</p></td>
</tr>
<tr class="row-even"><td><p>L</p></td>
<td><p>LH</p></td>
<td><p>06</p></td>
<td><p>Load half word</p></td>
<td><p>LH Ra, [Rb+Cx]</p></td>
<td><p>Ra &lt;= (2bytes)[Rb+Cx] <a class="footnote-reference brackets" href="#lb-note" id="id9" role="doc-noteref"><span class="fn-bracket">[</span>4<span class="fn-bracket">]</span></a></p></td>
</tr>
<tr class="row-odd"><td><p>L</p></td>
<td><p>LHu</p></td>
<td><p>07</p></td>
<td><p>Load half word unsigned</p></td>
<td><p>LHu Ra, [Rb+Cx]</p></td>
<td><p>Ra &lt;= (2bytes)[Rb+Cx] <a class="footnote-reference brackets" href="#lb-note" id="id10" role="doc-noteref"><span class="fn-bracket">[</span>4<span class="fn-bracket">]</span></a></p></td>
</tr>
<tr class="row-even"><td><p>L</p></td>
<td><p>SH</p></td>
<td><p>08</p></td>
<td><p>Store half word</p></td>
<td><p>SH Ra, [Rb+Cx]</p></td>
<td><p>[Rb+Cx] &lt;= Ra</p></td>
</tr>
<tr class="row-odd"><td><p>L</p></td>
<td><p>ADDiu</p></td>
<td><p>09</p></td>
<td><p>Add immediate</p></td>
<td><p>ADDiu Ra, Rb, Cx</p></td>
<td><p>Ra &lt;= (Rb + Cx)</p></td>
</tr>
<tr class="row-even"><td><p>L</p></td>
<td><p>ANDi</p></td>
<td><p>0C</p></td>
<td><p>AND imm</p></td>
<td><p>ANDi Ra, Rb, Cx</p></td>
<td><p>Ra &lt;= (Rb &amp; Cx)</p></td>
</tr>
<tr class="row-odd"><td><p>L</p></td>
<td><p>ORi</p></td>
<td><p>0D</p></td>
<td><p>OR</p></td>
<td><p>ORi Ra, Rb, Cx</p></td>
<td><p>Ra &lt;= (Rb | Cx)</p></td>
</tr>
<tr class="row-even"><td><p>L</p></td>
<td><p>XORi</p></td>
<td><p>0E</p></td>
<td><p>XOR</p></td>
<td><p>XORi Ra, Rb, Cx</p></td>
<td><p>Ra &lt;= (Rb ^ Cx)</p></td>
</tr>
<tr class="row-odd"><td><p>L</p></td>
<td><p>LUi</p></td>
<td><p>0F</p></td>
<td><p>Load upper</p></td>
<td><p>LUi Ra, Cx</p></td>
<td><p>Ra &lt;= (Cx &lt;&lt; 16)</p></td>
</tr>
<tr class="row-even"><td><p>A</p></td>
<td><p>ADDu</p></td>
<td><p>11</p></td>
<td><p>Add unsigned</p></td>
<td><p>ADD Ra, Rb, Rc</p></td>
<td><p>Ra &lt;= Rb + Rc <a class="footnote-reference brackets" href="#u-note" id="id11" role="doc-noteref"><span class="fn-bracket">[</span>5<span class="fn-bracket">]</span></a></p></td>
</tr>
<tr class="row-odd"><td><p>A</p></td>
<td><p>SUBu</p></td>
<td><p>12</p></td>
<td><p>Sub unsigned</p></td>
<td><p>SUB Ra, Rb, Rc</p></td>
<td><p>Ra &lt;= Rb - Rc <a class="footnote-reference brackets" href="#u-note" id="id12" role="doc-noteref"><span class="fn-bracket">[</span>5<span class="fn-bracket">]</span></a></p></td>
</tr>
<tr class="row-even"><td><p>A</p></td>
<td><p>ADD</p></td>
<td><p>13</p></td>
<td><p>Add</p></td>
<td><p>ADD Ra, Rb, Rc</p></td>
<td><p>Ra &lt;= Rb + Rc <a class="footnote-reference brackets" href="#u-note" id="id13" role="doc-noteref"><span class="fn-bracket">[</span>5<span class="fn-bracket">]</span></a></p></td>
</tr>
<tr class="row-odd"><td><p>A</p></td>
<td><p>SUB</p></td>
<td><p>14</p></td>
<td><p>Subtract</p></td>
<td><p>SUB Ra, Rb, Rc</p></td>
<td><p>Ra &lt;= Rb - Rc <a class="footnote-reference brackets" href="#u-note" id="id14" role="doc-noteref"><span class="fn-bracket">[</span>5<span class="fn-bracket">]</span></a></p></td>
</tr>
<tr class="row-even"><td><p>A</p></td>
<td><p>CLZ</p></td>
<td><p>15</p></td>
<td><p>Count Leading Zero</p></td>
<td><p>CLZ Ra, Rb</p></td>
<td><p>Ra &lt;= bits of leading zero on Rb</p></td>
</tr>
<tr class="row-odd"><td><p>A</p></td>
<td><p>CLO</p></td>
<td><p>16</p></td>
<td><p>Count Leading One</p></td>
<td><p>CLO Ra, Rb</p></td>
<td><p>Ra &lt;= bits of leading one on Rb</p></td>
</tr>
<tr class="row-even"><td><p>A</p></td>
<td><p>MUL</p></td>
<td><p>17</p></td>
<td><p>Multiply</p></td>
<td><p>MUL Ra, Rb, Rc</p></td>
<td><p>Ra &lt;= Rb * Rc</p></td>
</tr>
<tr class="row-odd"><td><p>A</p></td>
<td><p>AND</p></td>
<td><p>18</p></td>
<td><p>Bitwise and</p></td>
<td><p>AND Ra, Rb, Rc</p></td>
<td><p>Ra &lt;= Rb &amp; Rc</p></td>
</tr>
<tr class="row-even"><td><p>A</p></td>
<td><p>OR</p></td>
<td><p>19</p></td>
<td><p>Bitwise or</p></td>
<td><p>OR Ra, Rb, Rc</p></td>
<td><p>Ra &lt;= Rb | Rc</p></td>
</tr>
<tr class="row-odd"><td><p>A</p></td>
<td><p>XOR</p></td>
<td><p>1A</p></td>
<td><p>Bitwise exclusive or</p></td>
<td><p>XOR Ra, Rb, Rc</p></td>
<td><p>Ra &lt;= Rb ^ Rc</p></td>
</tr>
<tr class="row-even"><td><p>A</p></td>
<td><p>NOR</p></td>
<td><p>1B</p></td>
<td><p>Bitwise boolean nor</p></td>
<td><p>NOR Ra, Rb, Rc</p></td>
<td><p>Ra &lt;= Rb nor Rc</p></td>
</tr>
<tr class="row-odd"><td><p>A</p></td>
<td><p>ROL</p></td>
<td><p>1C</p></td>
<td><p>Rotate left</p></td>
<td><p>ROL Ra, Rb, Cx</p></td>
<td><p>Ra &lt;= Rb rol Cx</p></td>
</tr>
<tr class="row-even"><td><p>A</p></td>
<td><p>ROR</p></td>
<td><p>1D</p></td>
<td><p>Rotate right</p></td>
<td><p>ROR Ra, Rb, Cx</p></td>
<td><p>Ra &lt;= Rb ror Cx</p></td>
</tr>
<tr class="row-odd"><td><p>A</p></td>
<td><p>SHL</p></td>
<td><p>1E</p></td>
<td><p>Shift left</p></td>
<td><p>SHL Ra, Rb, Cx</p></td>
<td><p>Ra &lt;= Rb &lt;&lt; Cx</p></td>
</tr>
<tr class="row-even"><td><p>A</p></td>
<td><p>SHR</p></td>
<td><p>1F</p></td>
<td><p>Shift right</p></td>
<td><p>SHR Ra, Rb, Cx</p></td>
<td><p>Ra &lt;= Rb &gt;&gt; Cx</p></td>
</tr>
<tr class="row-odd"><td><p>A</p></td>
<td><p>SRA</p></td>
<td><p>20</p></td>
<td><p>Shift right</p></td>
<td><p>SRA Ra, Rb, Cx</p></td>
<td><p>Ra &lt;= Rb ‘&gt;&gt; Cx <a class="footnote-reference brackets" href="#sra-note" id="id15" role="doc-noteref"><span class="fn-bracket">[</span>7<span class="fn-bracket">]</span></a></p></td>
</tr>
<tr class="row-even"><td><p>A</p></td>
<td><p>SRAV</p></td>
<td><p>21</p></td>
<td><p>Shift right</p></td>
<td><p>SRAV Ra, Rb, Rc</p></td>
<td><p>Ra &lt;= Rb ‘&gt;&gt; Rc <a class="footnote-reference brackets" href="#sra-note" id="id16" role="doc-noteref"><span class="fn-bracket">[</span>7<span class="fn-bracket">]</span></a></p></td>
</tr>
<tr class="row-odd"><td><p>A</p></td>
<td><p>SHLV</p></td>
<td><p>22</p></td>
<td><p>Shift left</p></td>
<td><p>SHLV Ra, Rb, Rc</p></td>
<td><p>Ra &lt;= Rb &lt;&lt; Rc</p></td>
</tr>
<tr class="row-even"><td><p>A</p></td>
<td><p>SHRV</p></td>
<td><p>23</p></td>
<td><p>Shift right</p></td>
<td><p>SHRV Ra, Rb, Rc</p></td>
<td><p>Ra &lt;= Rb &gt;&gt; Rc</p></td>
</tr>
<tr class="row-odd"><td><p>A</p></td>
<td><p>ROL</p></td>
<td><p>24</p></td>
<td><p>Rotate left</p></td>
<td><p>ROL Ra, Rb, Rc</p></td>
<td><p>Ra &lt;= Rb rol Rc</p></td>
</tr>
<tr class="row-even"><td><p>A</p></td>
<td><p>ROR</p></td>
<td><p>25</p></td>
<td><p>Rotate right</p></td>
<td><p>ROR Ra, Rb, Rc</p></td>
<td><p>Ra &lt;= Rb ror Rc</p></td>
</tr>
<tr class="row-odd"><td><p>A</p></td>
<td><p>CMP</p></td>
<td><p>2A</p></td>
<td><p>Compare</p></td>
<td><p>CMP Ra, Rb</p></td>
<td><p>SW &lt;= (Ra cond Rb) <a class="footnote-reference brackets" href="#cond-note" id="id17" role="doc-noteref"><span class="fn-bracket">[</span>6<span class="fn-bracket">]</span></a></p></td>
</tr>
<tr class="row-even"><td><p>A</p></td>
<td><p>CMPu</p></td>
<td><p>2B</p></td>
<td><p>Compare</p></td>
<td><p>CMPu Ra, Rb</p></td>
<td><p>SW &lt;= (Ra cond Rb) <a class="footnote-reference brackets" href="#cond-note" id="id18" role="doc-noteref"><span class="fn-bracket">[</span>6<span class="fn-bracket">]</span></a></p></td>
</tr>
<tr class="row-odd"><td><p>J</p></td>
<td><p>JEQ</p></td>
<td><p>30</p></td>
<td><p>Jump if equal (==)</p></td>
<td><p>JEQ Cx</p></td>
<td><p>if SW(==), PC &lt;= PC + Cx</p></td>
</tr>
<tr class="row-even"><td><p>J</p></td>
<td><p>JNE</p></td>
<td><p>31</p></td>
<td><p>Jump if not equal (!=)</p></td>
<td><p>JNE Cx</p></td>
<td><p>if SW(!=), PC &lt;= PC + Cx</p></td>
</tr>
<tr class="row-odd"><td><p>J</p></td>
<td><p>JLT</p></td>
<td><p>32</p></td>
<td><p>Jump if less than (&lt;)</p></td>
<td><p>JLT Cx</p></td>
<td><p>if SW(&lt;), PC &lt;= PC + Cx</p></td>
</tr>
<tr class="row-even"><td><p>J</p></td>
<td><p>JGT</p></td>
<td><p>33</p></td>
<td><p>Jump if greater than (&gt;)</p></td>
<td><p>JGT Cx</p></td>
<td><p>if SW(&gt;), PC &lt;= PC + Cx</p></td>
</tr>
<tr class="row-odd"><td><p>J</p></td>
<td><p>JLE</p></td>
<td><p>34</p></td>
<td><p>Jump if less than or equals (&lt;=)</p></td>
<td><p>JLE Cx</p></td>
<td><p>if SW(&lt;=), PC &lt;= PC + Cx</p></td>
</tr>
<tr class="row-even"><td><p>J</p></td>
<td><p>JGE</p></td>
<td><p>35</p></td>
<td><p>Jump if greater than or equals (&gt;=)</p></td>
<td><p>JGE Cx</p></td>
<td><p>if SW(&gt;=), PC &lt;= PC + Cx</p></td>
</tr>
<tr class="row-odd"><td><p>J</p></td>
<td><p>JMP</p></td>
<td><p>36</p></td>
<td><p>Jump (unconditional)</p></td>
<td><p>JMP Cx</p></td>
<td><p>PC &lt;= PC + Cx</p></td>
</tr>
<tr class="row-even"><td><p>J</p></td>
<td><p>JALR</p></td>
<td><p>39</p></td>
<td><p>Indirect jump</p></td>
<td><p>JALR Rb</p></td>
<td><p>LR &lt;= PC; PC &lt;= Rb <a class="footnote-reference brackets" href="#call-note" id="id19" role="doc-noteref"><span class="fn-bracket">[</span>8<span class="fn-bracket">]</span></a></p></td>
</tr>
<tr class="row-odd"><td><p>J</p></td>
<td><p>BAL</p></td>
<td><p>3A</p></td>
<td><p>Branch and link</p></td>
<td><p>BAL Cx</p></td>
<td><p>LR &lt;= PC; PC &lt;= PC + Cx</p></td>
</tr>
<tr class="row-even"><td><p>J</p></td>
<td><p>JSUB</p></td>
<td><p>3B</p></td>
<td><p>Jump to subroutine</p></td>
<td><p>JSUB Cx</p></td>
<td><p>LR &lt;= PC; PC &lt;= PC + Cx</p></td>
</tr>
<tr class="row-odd"><td><p>J</p></td>
<td><p>JR/RET</p></td>
<td><p>3C</p></td>
<td><p>Return from subroutine</p></td>
<td><p>JR $1 or RET LR</p></td>
<td><p>PC &lt;= LR <a class="footnote-reference brackets" href="#jr-note" id="id20" role="doc-noteref"><span class="fn-bracket">[</span>9<span class="fn-bracket">]</span></a></p></td>
</tr>
<tr class="row-even"><td><p>A</p></td>
<td><p>MULT</p></td>
<td><p>41</p></td>
<td><p>Multiply for 64 bits result</p></td>
<td><p>MULT Ra, Rb</p></td>
<td><p>(HI,LO) &lt;= MULT(Ra,Rb)</p></td>
</tr>
<tr class="row-odd"><td><p>A</p></td>
<td><p>MULTU</p></td>
<td><p>42</p></td>
<td><p>MULT for unsigned 64 bits</p></td>
<td><p>MULTU Ra, Rb</p></td>
<td><p>(HI,LO) &lt;= MULTU(Ra,Rb)</p></td>
</tr>
<tr class="row-even"><td><p>A</p></td>
<td><p>DIV</p></td>
<td><p>43</p></td>
<td><p>Divide</p></td>
<td><p>DIV Ra, Rb</p></td>
<td><p>HI&lt;=Ra%Rb, LO&lt;=Ra/Rb</p></td>
</tr>
<tr class="row-odd"><td><p>A</p></td>
<td><p>DIVU</p></td>
<td><p>44</p></td>
<td><p>Divide unsigned</p></td>
<td><p>DIVU Ra, Rb</p></td>
<td><p>HI&lt;=Ra%Rb, LO&lt;=Ra/Rb</p></td>
</tr>
<tr class="row-even"><td><p>A</p></td>
<td><p>MFHI</p></td>
<td><p>46</p></td>
<td><p>Move HI to GPR</p></td>
<td><p>MFHI Ra</p></td>
<td><p>Ra &lt;= HI</p></td>
</tr>
<tr class="row-odd"><td><p>A</p></td>
<td><p>MFLO</p></td>
<td><p>47</p></td>
<td><p>Move LO to GPR</p></td>
<td><p>MFLO Ra</p></td>
<td><p>Ra &lt;= LO</p></td>
</tr>
<tr class="row-even"><td><p>A</p></td>
<td><p>MTHI</p></td>
<td><p>48</p></td>
<td><p>Move GPR to HI</p></td>
<td><p>MTHI Ra</p></td>
<td><p>HI &lt;= Ra</p></td>
</tr>
<tr class="row-odd"><td><p>A</p></td>
<td><p>MTLO</p></td>
<td><p>49</p></td>
<td><p>Move GPR to LO</p></td>
<td><p>MTLO Ra</p></td>
<td><p>LO &lt;= Ra</p></td>
</tr>
<tr class="row-even"><td><p>A</p></td>
<td><p>MFC0</p></td>
<td><p>50</p></td>
<td><p>Move C0R to GPR</p></td>
<td><p>MFC0 Ra, Rb</p></td>
<td><p>Ra &lt;= Rb</p></td>
</tr>
<tr class="row-odd"><td><p>A</p></td>
<td><p>MTC0</p></td>
<td><p>51</p></td>
<td><p>Move GPR to C0R</p></td>
<td><p>MTC0 Ra, Rb</p></td>
<td><p>Ra &lt;= Rb</p></td>
</tr>
<tr class="row-even"><td><p>A</p></td>
<td><p>C0MOV</p></td>
<td><p>52</p></td>
<td><p>Move C0R to C0R</p></td>
<td><p>C0MOV Ra, Rb</p></td>
<td><p>Ra &lt;= Rb</p></td>
</tr>
</tbody>
</table>
<p>The following table provides details on the newly added cpu032II instruction set:</p>
<table class="docutils align-default" id="id57">
<caption><span class="caption-number">Table 8 </span><span class="caption-text">cpu032II Instruction Set</span><a class="headerlink" href="#id57" title="Permalink to this table">¶</a></caption>
<colgroup>
<col style="width: 3%" />
<col style="width: 11%" />
<col style="width: 8%" />
<col style="width: 31%" />
<col style="width: 19%" />
<col style="width: 28%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>F.</p></th>
<th class="head"><p>Mnemonic</p></th>
<th class="head"><p>Opcode</p></th>
<th class="head"><p>Meaning</p></th>
<th class="head"><p>Syntax</p></th>
<th class="head"><p>Operation</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>L</p></td>
<td><p>SLTi</p></td>
<td><p>26</p></td>
<td><p>Set less Then</p></td>
<td><p>SLTi Ra, Rb, Cx</p></td>
<td><p>Ra &lt;= (Rb &lt; Cx)</p></td>
</tr>
<tr class="row-odd"><td><p>L</p></td>
<td><p>SLTiu</p></td>
<td><p>27</p></td>
<td><p>SLTi unsigned</p></td>
<td><p>SLTiu Ra, Rb, Cx</p></td>
<td><p>Ra &lt;= (Rb &lt; Cx)</p></td>
</tr>
<tr class="row-even"><td><p>A</p></td>
<td><p>SLT</p></td>
<td><p>28</p></td>
<td><p>Set less Then</p></td>
<td><p>SLT Ra, Rb, Rc</p></td>
<td><p>Ra &lt;= (Rb &lt; Rc)</p></td>
</tr>
<tr class="row-odd"><td><p>A</p></td>
<td><p>SLTu</p></td>
<td><p>29</p></td>
<td><p>SLT unsigned</p></td>
<td><p>SLTu Ra, Rb, Rc</p></td>
<td><p>Ra &lt;= (Rb &lt; Rc)</p></td>
</tr>
<tr class="row-even"><td><p>L</p></td>
<td><p>BEQ</p></td>
<td><p>37</p></td>
<td><p>Branch if equal</p></td>
<td><p>BEQ Ra, Rb, Cx</p></td>
<td><p>if (Ra==Rb), PC &lt;= PC + Cx</p></td>
</tr>
<tr class="row-odd"><td><p>L</p></td>
<td><p>BNE</p></td>
<td><p>38</p></td>
<td><p>Branch if not equal</p></td>
<td><p>BNE Ra, Rb, Cx</p></td>
<td><p>if (Ra!=Rb), PC &lt;= PC + Cx</p></td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><strong>Cpu0 Unsigned Instructions</strong></p>
<p>Like MIPS, except for <cite>DIVU</cite>, arithmetic unsigned instructions such as
<cite>ADDu</cite> and <cite>SUBu</cite> do not trigger overflow exceptions.
The <cite>ADDu</cite> and <cite>SUBu</cite> handle both signed and unsigned integers correctly.</p>
<p>For example:</p>
<ul class="simple">
<li><p><cite>(ADDu 1, -2) = -1</cite></p></li>
<li><p><cite>(ADDu 0x01, 0xfffffffe) = 0xffffffff (4G - 1)</cite></p></li>
</ul>
<p>If you interpret the result as a negative value, it is <cite>-1</cite>.
If interpreted as positive, it is <cite>+4G - 1</cite>.</p>
</div>
<section id="why-not-use-add-instead-of-sub">
<h4><a class="toc-backref" href="#id83" role="doc-backlink">Why Not Use ADD Instead of SUB?</a><a class="headerlink" href="#why-not-use-add-instead-of-sub" title="Permalink to this heading">¶</a></h4>
<p>From introductory computer science textbooks, we know that <cite>SUB</cite> can be
replaced by <cite>ADD</cite> as follows:</p>
<ul class="simple">
<li><p><cite>(A - B) = (A + (-B))</cite></p></li>
</ul>
<p>Since MIPS represents <cite>int</cite> in C using 32 bits, consider the case where
<cite>B = -2G</cite>:</p>
<ul class="simple">
<li><p><cite>(A - (-2G)) = (A + 2G)</cite></p></li>
</ul>
<p>However, the problem is that while <cite>-2G</cite> can be represented in a 32-bit
machine, <cite>+2G</cite> cannot. This is because the range of 32-bit two’s complement
representation is <cite>(-2G .. 2G-1)</cite>.</p>
<p>Two’s complement representation allows for efficient computation in hardware
design, making it widely used in real CPU implementations.
This is why almost every CPU includes a <cite>SUB</cite> instruction rather than relying
solely on <cite>ADD</cite>.</p>
</section>
</section>
<section id="the-status-register">
<h3><a class="toc-backref" href="#id84" role="doc-backlink">The Status Register</a><a class="headerlink" href="#the-status-register" title="Permalink to this heading">¶</a></h3>
<p>The Cpu0 status word register (<cite>SW</cite>) contains the state of the following flags:</p>
<ul class="simple">
<li><p><strong>Negative (N)</strong></p></li>
<li><p><strong>Zero (Z)</strong></p></li>
<li><p><strong>Carry (C)</strong></p></li>
<li><p><strong>Overflow (V)</strong></p></li>
<li><p><strong>Debug (D)</strong></p></li>
<li><p><strong>Mode (M)</strong></p></li>
<li><p><strong>Interrupt (I)</strong></p></li>
</ul>
<p>The bit layout of the <cite>SW</cite> register is shown in <a class="reference internal" href="#llvmstructure-f3"><span class="std std-numref">Fig. 5</span></a> below.</p>
<figure class="align-center" id="id58">
<span id="llvmstructure-f3"></span><a class="reference internal image-reference" href="_images/3.png"><img alt="_images/3.png" src="_images/3.png" style="width: 684px; height: 126px;" /></a>
<figcaption>
<p><span class="caption-number">Fig. 5 </span><span class="caption-text">Cpu0 status word (SW) register</span><a class="headerlink" href="#id58" title="Permalink to this image">¶</a></p>
</figcaption>
</figure>
<p>When a <cite>CMP Ra, Rb</cite> instruction executes, it updates the condition flags in the
status word (<cite>SW</cite>) register as follows:</p>
<ul class="simple">
<li><p><strong>If `Ra &gt; Rb`</strong>, then <cite>N = 0</cite>, <cite>Z = 0</cite></p></li>
<li><p><strong>If `Ra &lt; Rb`</strong>, then <cite>N = 1</cite>, <cite>Z = 0</cite></p></li>
<li><p><strong>If `Ra = Rb`</strong>, then <cite>N = 0</cite>, <cite>Z = 1</cite></p></li>
</ul>
<p>The direction (i.e., taken or not taken) of conditional jump instructions
(<cite>JGT</cite>, <cite>JLT</cite>, <cite>JGE</cite>, <cite>JLE</cite>, <cite>JEQ</cite>, <cite>JNE</cite>) is determined by the values of the
<cite>N</cite> and <cite>Z</cite> flags in the <cite>SW</cite> register.</p>
</section>
<section id="cpu0-s-stages-of-instruction-execution">
<h3><a class="toc-backref" href="#id85" role="doc-backlink">Cpu0’s Stages of Instruction Execution</a><a class="headerlink" href="#cpu0-s-stages-of-instruction-execution" title="Permalink to this heading">¶</a></h3>
<p>The Cpu0 architecture has a five-stage pipeline. The stages are:
instruction fetch (IF), instruction decode (ID), execute (EX), memory access
(MEM), and write-back (WB).</p>
<p>Below is a description of what happens in each stage of the processor:</p>
<ol class="arabic simple">
<li><p><strong>Instruction Fetch (IF)</strong></p></li>
</ol>
<ul class="simple">
<li><p>The Cpu0 fetches the instruction pointed to by the Program Counter (PC)
into the Instruction Register (IR): <cite>IR = [PC]</cite>.</p></li>
<li><p>The PC is then updated to point to the next instruction: <cite>PC = PC + 4</cite>.</p></li>
</ul>
<ol class="arabic simple" start="2">
<li><p><strong>Instruction Decode (ID)</strong></p></li>
</ol>
<ul class="simple">
<li><p>The control unit decodes the instruction stored in <cite>IR</cite>, routes necessary
data from registers to the ALU, and sets the ALU’s operation mode based on
the instruction’s opcode.</p></li>
</ul>
<ol class="arabic simple" start="3">
<li><p><strong>Execute (EX)</strong></p></li>
</ol>
<ul class="simple">
<li><p>The ALU executes the operation designated by the control unit on the data
in registers.</p></li>
<li><p>Except for load and store instructions, the result is stored in the
destination register after execution.</p></li>
</ul>
<ol class="arabic simple" start="4">
<li><p><strong>Memory Access (MEM)</strong></p></li>
</ol>
<ul class="simple">
<li><p>If the instruction is a load, data is read from the data cache into the
pipeline register <cite>MEM/WB</cite>.</p></li>
<li><p>If the instruction is a store, data is written from the register to the
data cache.</p></li>
</ul>
<ol class="arabic simple" start="5">
<li><p><strong>Write-Back (WB)</strong></p></li>
</ol>
<ul class="simple">
<li><p>If the instruction is a load, data is moved from the pipeline register
<cite>MEM/WB</cite> to the destination register.</p></li>
</ul>
</section>
<section id="cpu0-s-interrupt-vector">
<h3><a class="toc-backref" href="#id86" role="doc-backlink">Cpu0’s Interrupt Vector</a><a class="headerlink" href="#cpu0-s-interrupt-vector" title="Permalink to this heading">¶</a></h3>
<table class="docutils align-default" id="id59">
<caption><span class="caption-number">Table 9 </span><span class="caption-text">Cpu0’s Interrupt Vector</span><a class="headerlink" href="#id59" title="Permalink to this table">¶</a></caption>
<thead>
<tr class="row-odd"><th class="head"><p>Address</p></th>
<th class="head"><p>type</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>0x00</p></td>
<td><p>Reset</p></td>
</tr>
<tr class="row-odd"><td><p>0x04</p></td>
<td><p>Error Handle</p></td>
</tr>
<tr class="row-even"><td><p>0x08</p></td>
<td><p>Interrupt</p></td>
</tr>
</tbody>
</table>
</section>
</section>
<section id="llvm-structure">
<h2><a class="toc-backref" href="#id87" role="doc-backlink">LLVM Structure</a><a class="headerlink" href="#llvm-structure" title="Permalink to this heading">¶</a></h2>
<p>This section introduces the compiler’s data structures, algorithms, and
mechanisms used in LLVM.</p>
<section id="ssa-form">
<h3><a class="toc-backref" href="#id88" role="doc-backlink">SSA Form</a><a class="headerlink" href="#ssa-form" title="Permalink to this heading">¶</a></h3>
<p>Static Single Assignment (SSA) form ensures that each variable is assigned
exactly once. In SSA form, a single instruction has one variable (destination
virtual registers).
However one virtual register may map to two real registers.
LLVM handles it by packing them into a single value, like a struct or a vector,
or using multiple instructions as follows:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">%</span><span class="nv">res</span> <span class="o">=</span> call <span class="o">{</span>i32, i1<span class="o">}</span> @llvm.sadd.with.overflow.i32<span class="o">(</span>i32 %a, i32 %b<span class="o">)</span>
<span class="gp">%</span><span class="nv">sum</span> <span class="o">=</span> extractvalue <span class="o">{</span>i32, i1<span class="o">}</span> %res, <span class="m">0</span>
<span class="gp">%</span><span class="nv">overflow</span> <span class="o">=</span> extractvalue <span class="o">{</span>i32, i1<span class="o">}</span> %res, <span class="m">1</span>
</pre></div>
</div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">%</span><span class="nv">y</span> <span class="o">=</span> call &lt;<span class="m">4</span> x float&gt; @llvm.ceil.v4f32<span class="o">(</span>&lt;<span class="m">4</span> x float&gt; %x<span class="o">)</span>
</pre></div>
</div>
<p>LLVM IR follows SSA form, meaning it has an <strong>unbounded number of virtual
registers</strong>—each variable is assigned exactly once and is stored in a separate
virtual register.</p>
<p>As a result, the optimization steps in the code generation sequence—including
<strong>Instruction Selection</strong>, <strong>Scheduling and Formation</strong>, and <strong>Register
Allocation</strong>—retain all optimization opportunities.</p>
<p>For example, if we used a limited number of virtual registers instead of an
unlimited set, as shown in the following code:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">%</span><span class="nv">a</span> <span class="o">=</span> add nsw i32 <span class="m">1</span>, i32 <span class="m">0</span>
<span class="go">store i32 %a, i32* %c, align 4</span>
<span class="gp">%</span><span class="nv">a</span> <span class="o">=</span> add nsw i32 <span class="m">2</span>, i32 <span class="m">0</span>
<span class="go">store i32 %a, i32* %c, align 4</span>
</pre></div>
</div>
<p>In the above example, a limited number of virtual registers is used, causing
virtual register <cite>%a</cite> to be assigned twice.</p>
<p>As a result, the compiler must generate the following code, since <cite>%a</cite> is
assigned as an output in two different statements.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">=&gt; %a = add i32 1, i32 0</span>
<span class="go">    st %a,  i32* %c, 1</span>
<span class="gp">    %</span><span class="nv">a</span> <span class="o">=</span> add i32 <span class="m">2</span>, i32 <span class="m">0</span>
<span class="go">    st %a,  i32* %c, 2</span>
</pre></div>
</div>
<p>The above code must execute sequentially.</p>
<p>In contrast, the SSA form shown below can be reordered and executed in parallel
using the following alternative version <a class="footnote-reference brackets" href="#dragonbooks-10-2-3" id="id21" role="doc-noteref"><span class="fn-bracket">[</span>16<span class="fn-bracket">]</span></a>.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">  %</span><span class="nv">a</span> <span class="o">=</span> add nsw i32 <span class="m">1</span>, i32 <span class="m">0</span>
<span class="go">  store i32 %a, i32* %c, align 4</span>
<span class="gp">  %</span><span class="nv">b</span> <span class="o">=</span> add nsw i32 <span class="m">2</span>, i32 <span class="m">0</span>
<span class="go">  store i32 %b, i32* %d, align 4</span>

<span class="go">// version 1</span>
<span class="go">=&gt; %a = add i32 1, i32 0</span>
<span class="go">    st %a,  i32* %c, 0</span>
<span class="gp">    %</span><span class="nv">b</span> <span class="o">=</span> add i32 <span class="m">2</span>, i32 <span class="m">0</span>
<span class="go">    st %b,  i32* %d, 0</span>

<span class="go">// version 2</span>
<span class="go">=&gt; %a = add i32 1, i32 0</span>
<span class="gp">    %</span><span class="nv">b</span> <span class="o">=</span> add i32 <span class="m">2</span>, i32 <span class="m">0</span>
<span class="go">    st %a,  i32* %c, 0</span>
<span class="go">    st %b,  i32* %d, 0</span>

<span class="go">// version 3</span>
<span class="go">=&gt; %b = add i32 2, i32 0</span>
<span class="go">    st %b,  i32* %d, 0</span>
<span class="gp">    %</span><span class="nv">a</span> <span class="o">=</span> add i32 <span class="m">1</span>, i32 <span class="m">0</span>
<span class="go">    st %a,  i32* %c, 0</span>
</pre></div>
</div>
</section>
<section id="dsa-form">
<h3><a class="toc-backref" href="#id89" role="doc-backlink">DSA Form</a><a class="headerlink" href="#dsa-form" title="Permalink to this heading">¶</a></h3>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">for (int i = 0; i &lt; 1000; i++) {</span>
<span class="go">  b[i] = f(g(a[i]));</span>
<span class="go">}</span>
</pre></div>
</div>
<p>For the source program above, the following represent its SSA form at both the
source code level and the LLVM IR level, respectively.</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">1000</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">t</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">g</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span><span class="w"></span>
<span class="w">  </span><span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">f</span><span class="p">(</span><span class="n">t</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<div class="highlight-llvm notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="nv">%pi</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">alloca</span><span class="w"> </span><span class="kt">i32</span><span class="w"></span>
<span class="w">  </span><span class="k">store</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="kt">i32</span><span class="p">*</span><span class="w"> </span><span class="nv">%pi</span><span class="w"></span>
<span class="w">  </span><span class="nv">%i</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">load</span><span class="w"> </span><span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="kt">i32</span><span class="p">*</span><span class="w"> </span><span class="nv">%pi</span><span class="w"></span>
<span class="w">  </span><span class="nv">%cmp</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">icmp</span><span class="w"> </span><span class="k">slt</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="nv">%i</span><span class="p">,</span><span class="w"> </span><span class="m">1000</span><span class="w"></span>
<span class="w">  </span><span class="k">br</span><span class="w"> </span><span class="kt">i1</span><span class="w"> </span><span class="nv">%cmp</span><span class="p">,</span><span class="w"> </span><span class="kt">label</span><span class="w"> </span><span class="nv">%true</span><span class="p">,</span><span class="w"> </span><span class="kt">label</span><span class="w"> </span><span class="nv">%end</span><span class="w"></span>
<span class="nl">true:</span><span class="w"></span>
<span class="w">  </span><span class="nv">%a_idx</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">add</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="nv">%i</span><span class="p">,</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="nv">%a_addr</span><span class="w"></span>
<span class="w">  </span><span class="nv">%val0</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">load</span><span class="w"> </span><span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="kt">i32</span><span class="p">*</span><span class="w"> </span><span class="nv">%a_idx</span><span class="w"></span>
<span class="w">  </span><span class="nv">%t</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">call</span><span class="w"> </span><span class="kt">i64</span><span class="w"> </span><span class="nv">%g</span><span class="p">(</span><span class="kt">i32</span><span class="w"> </span><span class="nv">%val0</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="nv">%val1</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">call</span><span class="w"> </span><span class="kt">i64</span><span class="w"> </span><span class="nv">%f</span><span class="p">(</span><span class="kt">i32</span><span class="w"> </span><span class="nv">%t</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="nv">%b_idx</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">add</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="nv">%i</span><span class="p">,</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="nv">%b_addr</span><span class="w"></span>
<span class="w">  </span><span class="k">store</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="nv">%val1</span><span class="p">,</span><span class="w"> </span><span class="kt">i32</span><span class="p">*</span><span class="w"> </span><span class="nv">%b_idx</span><span class="w"></span>
<span class="nl">end:</span><span class="w"></span>
</pre></div>
</div>
<p>The following represents the <strong>DSA (Dynamic Single Assignment) form</strong>.</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">1000</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">g</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span><span class="w"></span>
<span class="w">  </span><span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">f</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<div class="highlight-llvm notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="nv">%pi</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">alloca</span><span class="w"> </span><span class="kt">i32</span><span class="w"></span>
<span class="w">  </span><span class="k">store</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="kt">i32</span><span class="p">*</span><span class="w"> </span><span class="nv">%pi</span><span class="w"></span>
<span class="w">  </span><span class="nv">%i</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">load</span><span class="w"> </span><span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="kt">i32</span><span class="p">*</span><span class="w"> </span><span class="nv">%pi</span><span class="w"></span>
<span class="w">  </span><span class="nv">%cmp</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">icmp</span><span class="w"> </span><span class="k">slt</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="nv">%i</span><span class="p">,</span><span class="w"> </span><span class="m">1000</span><span class="w"></span>
<span class="w">  </span><span class="k">br</span><span class="w"> </span><span class="kt">i1</span><span class="w"> </span><span class="nv">%cmp</span><span class="p">,</span><span class="w"> </span><span class="kt">label</span><span class="w"> </span><span class="nv">%true</span><span class="p">,</span><span class="w"> </span><span class="kt">label</span><span class="w"> </span><span class="nv">%end</span><span class="w"></span>
<span class="nl">true:</span><span class="w"></span>
<span class="w">  </span><span class="nv">%a_idx</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">add</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="nv">%i</span><span class="p">,</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="nv">%a_addr</span><span class="w"></span>
<span class="w">  </span><span class="nv">%val0</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">load</span><span class="w"> </span><span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="kt">i32</span><span class="p">*</span><span class="w"> </span><span class="nv">%a_idx</span><span class="w"></span>
<span class="w">  </span><span class="nv">%t_idx</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">add</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="nv">%i</span><span class="p">,</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="nv">%t_addr</span><span class="w"></span>
<span class="w">  </span><span class="nv">%temp</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">call</span><span class="w"> </span><span class="kt">i64</span><span class="w"> </span><span class="nv">%g</span><span class="p">(</span><span class="kt">i32</span><span class="w"> </span><span class="nv">%val0</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="k">store</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="nv">%temp</span><span class="p">,</span><span class="w"> </span><span class="kt">i32</span><span class="p">*</span><span class="w"> </span><span class="nv">%t_idx</span><span class="w"></span>
<span class="w">  </span><span class="nv">%val1</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">call</span><span class="w"> </span><span class="kt">i64</span><span class="w"> </span><span class="nv">%f</span><span class="p">(</span><span class="kt">i32</span><span class="w"> </span><span class="nv">%temp</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="nv">%b_idx</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">add</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="nv">%i</span><span class="p">,</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="nv">%b_addr</span><span class="w"></span>
<span class="w">  </span><span class="k">store</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="nv">%val1</span><span class="p">,</span><span class="w"> </span><span class="kt">i32</span><span class="p">*</span><span class="w"> </span><span class="nv">%b_idx</span><span class="w"></span>
<span class="nl">end:</span><span class="w"></span>
</pre></div>
</div>
<p>In some internet video applications and multi-core (SMP) platforms, splitting
<cite>g()</cite> and <cite>f()</cite> into two separate loops can improve performance.</p>
<p>DSA allows this transformation, whereas SSA does not. While extra analysis on
<cite>%temp</cite> in SSA could reconstruct <cite>%t_idx</cite> and <cite>%t_addr</cite> as shown in the DSA
form below, compiler transformations typically follow a high-to-low approach.</p>
<p>Additionally, LLVM IR already loses the <cite>for</cite> loop structure, even though part
of the losted information
can be reconstructed through further analysis.</p>
<p>For this reason, in this book—as well as in most compiler-related research—the
discussion follows a high-to-low transformation premise. Otherwise, it would
fall into the domain of <strong>reverse engineering</strong> in assemblers or compilers.</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">1000</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">g</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">1000</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">f</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<div class="highlight-llvm notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="nv">%pi</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">alloca</span><span class="w"> </span><span class="kt">i32</span><span class="w"></span>
<span class="w">  </span><span class="k">store</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="kt">i32</span><span class="p">*</span><span class="w"> </span><span class="nv">%pi</span><span class="w"></span>
<span class="w">  </span><span class="nv">%i</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">load</span><span class="w"> </span><span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="kt">i32</span><span class="p">*</span><span class="w"> </span><span class="nv">%pi</span><span class="w"></span>
<span class="w">  </span><span class="nv">%cmp</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">icmp</span><span class="w"> </span><span class="k">slt</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="nv">%i</span><span class="p">,</span><span class="w"> </span><span class="m">1000</span><span class="w"></span>
<span class="w">  </span><span class="k">br</span><span class="w"> </span><span class="kt">i1</span><span class="w"> </span><span class="nv">%cmp</span><span class="p">,</span><span class="w"> </span><span class="kt">label</span><span class="w"> </span><span class="nv">%true</span><span class="p">,</span><span class="w"> </span><span class="kt">label</span><span class="w"> </span><span class="nv">%end</span><span class="w"></span>
<span class="nl">true:</span><span class="w"></span>
<span class="w">  </span><span class="nv">%a_idx</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">add</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="nv">%i</span><span class="p">,</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="nv">%a_addr</span><span class="w"></span>
<span class="w">  </span><span class="nv">%val0</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">load</span><span class="w"> </span><span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="kt">i32</span><span class="p">*</span><span class="w"> </span><span class="nv">%a_idx</span><span class="w"></span>
<span class="w">  </span><span class="nv">%t_idx</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">add</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="nv">%i</span><span class="p">,</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="nv">%t_addr</span><span class="w"></span>
<span class="w">  </span><span class="nv">%temp</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">call</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="nv">%g</span><span class="p">(</span><span class="kt">i32</span><span class="w"> </span><span class="nv">%val0</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="k">store</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="nv">%temp</span><span class="p">,</span><span class="w"> </span><span class="kt">i32</span><span class="p">*</span><span class="w"> </span><span class="nv">%t_idx</span><span class="w"></span>
<span class="nl">end:</span><span class="w"></span>

<span class="w">  </span><span class="nv">%pi</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">alloca</span><span class="w"> </span><span class="kt">i32</span><span class="w"></span>
<span class="w">  </span><span class="k">store</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="kt">i32</span><span class="p">*</span><span class="w"> </span><span class="nv">%pi</span><span class="w"></span>
<span class="w">  </span><span class="nv">%i</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">load</span><span class="w"> </span><span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="kt">i32</span><span class="p">*</span><span class="w"> </span><span class="nv">%pi</span><span class="w"></span>
<span class="w">  </span><span class="nv">%cmp</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">icmp</span><span class="w"> </span><span class="k">slt</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="nv">%i</span><span class="p">,</span><span class="w"> </span><span class="m">1000</span><span class="w"></span>
<span class="w">  </span><span class="k">br</span><span class="w"> </span><span class="kt">i1</span><span class="w"> </span><span class="nv">%cmp</span><span class="p">,</span><span class="w"> </span><span class="kt">label</span><span class="w"> </span><span class="nv">%true</span><span class="p">,</span><span class="w"> </span><span class="kt">label</span><span class="w"> </span><span class="nv">%end</span><span class="w"></span>
<span class="nl">true:</span><span class="w"></span>
<span class="w">  </span><span class="nv">%t_idx</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">add</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="nv">%i</span><span class="p">,</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="nv">%t_addr</span><span class="w"></span>
<span class="w">  </span><span class="nv">%temp</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">load</span><span class="w"> </span><span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="kt">i32</span><span class="p">*</span><span class="w"> </span><span class="nv">%t_idx</span><span class="w"></span>
<span class="w">  </span><span class="nv">%val1</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">call</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="nv">%f</span><span class="p">(</span><span class="kt">i32</span><span class="w"> </span><span class="nv">%temp</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="nv">%b_idx</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">add</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="nv">%i</span><span class="p">,</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="nv">%b_addr</span><span class="w"></span>
<span class="w">  </span><span class="k">store</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="nv">%val1</span><span class="p">,</span><span class="w"> </span><span class="kt">i32</span><span class="p">*</span><span class="w"> </span><span class="nv">%b_idx</span><span class="w"></span>
<span class="nl">end:</span><span class="w"></span>
</pre></div>
</div>
<p>Now, data dependencies exist only on <cite>t[i]</cite> between <cite>“t[i] = g(a[i])”</cite> and
<cite>“b[i] = f(t[i])”</cite> for each <cite>i = (0..999)</cite>.</p>
<p>As a result, the program can execute in various orders, offering significant
parallel processing opportunities for <strong>multi-core (SMP) systems</strong> and
<strong>heterogeneous processors</strong>.</p>
<p>For example, <cite>g(x)</cite> can be executed on a <strong>GPU</strong>, while <cite>f(x)</cite> runs on a <strong>CPU</strong>.</p>
</section>
<section id="three-phase-design">
<h3><a class="toc-backref" href="#id90" role="doc-backlink">Three-Phase Design</a><a class="headerlink" href="#three-phase-design" title="Permalink to this heading">¶</a></h3>
<p>This content and the following sub-section are adapted from the AOSA chapter
on LLVM written by Chris Lattner <a class="footnote-reference brackets" href="#aosa-book" id="id22" role="doc-noteref"><span class="fn-bracket">[</span>10<span class="fn-bracket">]</span></a>.</p>
<p>The most common design for a traditional static compiler (such as most C
compilers) follows a three-phase structure, consisting of the front end,
the optimizer, and the back end, as shown in <a class="reference internal" href="#llvmstructure-f6"><span class="std std-numref">Fig. 6</span></a>.</p>
<p>The <strong>front end</strong> parses the source code, checks for errors, and constructs
a language-specific Abstract Syntax Tree (AST) to represent the input code.
The AST may then be converted into an intermediate representation for
optimization, after which the <strong>optimizer</strong> and <strong>back end</strong> process the code.</p>
<figure class="align-center" id="id60">
<span id="llvmstructure-f6"></span><a class="reference internal image-reference" href="_images/61.png"><img alt="_images/61.png" src="_images/61.png" style="width: 329.0px; height: 44.099999999999994px;" /></a>
<figcaption>
<p><span class="caption-number">Fig. 6 </span><span class="caption-text">Three Major Components of a Three Phase Compiler</span><a class="headerlink" href="#id60" title="Permalink to this image">¶</a></p>
</figcaption>
</figure>
<p>The optimizer performs a wide range of transformations to improve code execution
efficiency, such as eliminating redundant computations. It is generally
independent of both the source language and the target architecture.</p>
<p>The back end, also known as the code generator, maps the optimized code onto
the target instruction set. In addition to producing correct code, it is
responsible for generating efficient code that leverages the unique features of
the target architecture. Common components of a compiler back end include
instruction selection, register allocation, and instruction scheduling.</p>
<p>This model applies equally well to interpreters and Just-In-Time (JIT)
compilers. The Java Virtual Machine (JVM) is an example of this model, using
Java bytecode as the interface between the front end and the optimizer.</p>
<p>The greatest advantage of this classical design becomes evident when a compiler
supports multiple source languages or target architectures. If the compiler’s
optimizer uses a common intermediate representation, a front end can be written
for any language that compiles to this representation, and a back end can be
developed for any target that compiles from it, as illustrated in
<a class="reference internal" href="#llvmstructure-f7"><span class="std std-numref">Fig. 7</span></a>.</p>
<figure class="align-center" id="id61">
<span id="llvmstructure-f7"></span><a class="reference internal image-reference" href="_images/7.png"><img alt="_images/7.png" src="_images/7.png" style="width: 585.9px; height: 209.29999999999998px;" /></a>
<figcaption>
<p><span class="caption-number">Fig. 7 </span><span class="caption-text">Retargetablity</span><a class="headerlink" href="#id61" title="Permalink to this image">¶</a></p>
</figcaption>
</figure>
<p>With this design, porting the compiler to support a new source language
(e.g., Algol or BASIC) requires implementing a new front end, while the
existing optimizer and back end can be reused. If these components were not
separated, adding a new source language would require rebuilding the entire
compiler from scratch. Supporting <cite>N</cite> targets and <cite>M</cite> source languages would
then necessitate developing <cite>N * M</cite> compilers.</p>
<p>Another advantage of the three-phase design, which stems from its
retargetability, is that the compiler can serve a broader range of programmers
compared to one that supports only a single source language and target. For an
open-source project, this translates to a larger community of potential
contributors, leading to more enhancements and improvements.</p>
<p>This is why open-source compilers that cater to diverse communities, such as
GCC, often generate better-optimized machine code than narrower compilers like
FreePASCAL. In contrast, the quality of proprietary compilers depends directly
on their development budget. For example, the Intel ICC compiler is widely
recognized for producing high-quality machine code despite serving a smaller
audience.</p>
<p>A final major benefit of the three-phase design is that the skills required to
develop a front end differ from those needed for the optimizer and back end.
By separating these concerns, “front-end developers” can focus on enhancing
and maintaining their part of the compiler. While this is a social rather than
a technical factor, it has a significant impact in practice—especially for
open-source projects aiming to lower barriers to contribution.</p>
<p>The most critical aspect of this design is the <strong>LLVM Intermediate
Representation (IR)</strong>, which serves as the compiler’s core code representation.
LLVM IR is designed to support mid-level analysis and transformations commonly
found in the optimization phase of a compiler.</p>
<p>It was created with several specific goals, including support for lightweight
runtime optimizations, cross-function and interprocedural optimizations, whole-
program analysis, and aggressive restructuring transformations. However, its
most defining characteristic is that it is a first-class language with well-
defined semantics.</p>
<p>To illustrate this, here is a simple example of an LLVM <cite>.ll</cite> file:</p>
<div class="highlight-llvm notranslate"><div class="highlight"><pre><span></span><span class="k">define</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="vg">@add1</span><span class="p">(</span><span class="kt">i32</span><span class="w"> </span><span class="nv">%a</span><span class="p">,</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="nv">%b</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="nl">entry:</span><span class="w"></span>
<span class="w">  </span><span class="nv">%tmp1</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">add</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="nv">%a</span><span class="p">,</span><span class="w"> </span><span class="nv">%b</span><span class="w"></span>
<span class="w">  </span><span class="k">ret</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="nv">%tmp1</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="k">define</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="vg">@add2</span><span class="p">(</span><span class="kt">i32</span><span class="w"> </span><span class="nv">%a</span><span class="p">,</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="nv">%b</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="nl">entry:</span><span class="w"></span>
<span class="w">  </span><span class="nv">%tmp1</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">icmp</span><span class="w"> </span><span class="k">eq</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="nv">%a</span><span class="p">,</span><span class="w"> </span><span class="m">0</span><span class="w"></span>
<span class="w">  </span><span class="k">br</span><span class="w"> </span><span class="kt">i1</span><span class="w"> </span><span class="nv">%tmp1</span><span class="p">,</span><span class="w"> </span><span class="kt">label</span><span class="w"> </span><span class="nv">%done</span><span class="p">,</span><span class="w"> </span><span class="kt">label</span><span class="w"> </span><span class="nv">%recurse</span><span class="w"></span>
<span class="nl">recurse:</span><span class="w"></span>
<span class="w">  </span><span class="nv">%tmp2</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">sub</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="nv">%a</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="w"></span>
<span class="w">  </span><span class="nv">%tmp3</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">add</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="nv">%b</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="w"></span>
<span class="w">  </span><span class="nv">%tmp4</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">call</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="vg">@add2</span><span class="p">(</span><span class="kt">i32</span><span class="w"> </span><span class="nv">%tmp2</span><span class="p">,</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="nv">%tmp3</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="k">ret</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="nv">%tmp4</span><span class="w"></span>
<span class="nl">done:</span><span class="w"></span>
<span class="w">  </span><span class="k">ret</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="nv">%b</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="c1">// Above LLVM IR corresponds to this C code, which provides two different ways to</span>
<span class="c1">//  add integers:</span>
<span class="kt">unsigned</span><span class="w"> </span><span class="nf">add1</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="n">b</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">a</span><span class="o">+</span><span class="n">b</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="c1">// Perhaps not the most efficient way to add two numbers.</span>
<span class="kt">unsigned</span><span class="w"> </span><span class="nf">add2</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="n">b</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">a</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">b</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">add2</span><span class="p">(</span><span class="n">a</span><span class="mi">-1</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>As shown in this example, LLVM IR is a low-level, RISC-like virtual instruction
set. Like a real RISC instruction set, it supports linear sequences of simple
instructions such as <cite>add</cite>, <cite>subtract</cite>, <cite>compare</cite>, and <cite>branch</cite>.</p>
<p>These instructions follow a three-address format, meaning they take inputs and
produce a result in a different register. LLVM IR supports labels and generally
resembles an unusual form of assembly language.</p>
<p>Unlike most RISC instruction sets, LLVM IR is strongly typed and uses a simple
type system (e.g., <cite>i32</cite> represents a 32-bit integer, and <cite>i32**</cite> is a pointer
to a pointer to a 32-bit integer). Additionally, some machine-specific details
are abstracted away.</p>
<p>For instance, the calling convention is handled through <cite>call</cite> and <cite>ret</cite>
instructions with explicit arguments. Another key difference from machine code
is that LLVM IR does not use a fixed set of named registers. Instead, it
employs an infinite set of temporaries prefixed with <cite>%</cite>.</p>
<p>Beyond being a language, LLVM IR exists in three isomorphic forms:</p>
<ul class="simple">
<li><p>A <strong>textual format</strong> (as seen above).</p></li>
<li><p>An <strong>in-memory data structure</strong> used by optimizations.</p></li>
<li><p>A <strong>compact binary “bitcode” format</strong> stored on disk.</p></li>
</ul>
<p>The LLVM project provides tools to convert between these forms:</p>
<ul class="simple">
<li><p><cite>llvm-as</cite> assembles a textual <cite>.ll</cite> file into a <cite>.bc</cite> file containing
bitcode.</p></li>
<li><p><cite>llvm-dis</cite> disassembles a <cite>.bc</cite> file back into a <cite>.ll</cite> file.</p></li>
</ul>
<p>The intermediate representation (IR) of a compiler is crucial because it
creates an ideal environment for optimizations. Unlike the front end and
back end, the optimizer is not restricted to a specific source language or
target machine.</p>
<p>However, it must effectively serve both. It should be easy for the front end
to generate while remaining expressive enough to enable important
optimizations for real hardware targets.</p>
</section>
<section id="llvm-s-target-description-files-td">
<h3><a class="toc-backref" href="#id91" role="doc-backlink">LLVM’s Target Description Files: .td</a><a class="headerlink" href="#llvm-s-target-description-files-td" title="Permalink to this heading">¶</a></h3>
<p>The “mix and match” approach allows target authors to select components that
best suit their architecture, enabling significant code reuse across different
targets.</p>
<p>However, this introduces a challenge: each shared component must be capable of
handling target-specific properties in a generic way. For instance, a shared
register allocator must be aware of the register file of each target and the
constraints that exist between instructions and their register operands.</p>
<p>LLVM addresses this challenge by requiring each target to provide a target
description using a declarative domain-specific language, defined in a set of
<cite>.td</cite> files. These files are processed by the <cite>tblgen</cite> tool to generate the
necessary target-specific data structures.</p>
<p>The simplified build process for the x86 target is illustrated in
<a class="reference internal" href="#llvmstructure-f8"><span class="std std-numref">Fig. 8</span></a>.</p>
<figure class="align-center" id="id62">
<span id="llvmstructure-f8"></span><a class="reference internal image-reference" href="_images/8.png"><img alt="_images/8.png" src="_images/8.png" style="width: 595.0px; height: 299.59999999999997px;" /></a>
<figcaption>
<p><span class="caption-number">Fig. 8 </span><span class="caption-text">Simplified x86 Target Definition</span><a class="headerlink" href="#id62" title="Permalink to this image">¶</a></p>
</figcaption>
</figure>
<p>The different subsystems supported by <cite>.td</cite> files enable target authors to
construct various components of their target architecture.</p>
<p>For example, the x86 backend defines a register class named <cite>“GR32”</cite>, which
contains all 32-bit registers. In <cite>.td</cite> files, target-specific definitions
are conventionally written in all capital letters. The definition is as follows:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="n">def</span><span class="w"> </span><span class="n">GR32</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">RegisterClass</span><span class="o">&lt;</span><span class="p">[</span><span class="n">i32</span><span class="p">],</span><span class="w"> </span><span class="mi">32</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="p">[</span><span class="n">EAX</span><span class="p">,</span><span class="w"> </span><span class="n">ECX</span><span class="p">,</span><span class="w"> </span><span class="n">EDX</span><span class="p">,</span><span class="w"> </span><span class="n">ESI</span><span class="p">,</span><span class="w"> </span><span class="n">EDI</span><span class="p">,</span><span class="w"> </span><span class="n">EBX</span><span class="p">,</span><span class="w"> </span><span class="n">EBP</span><span class="p">,</span><span class="w"> </span><span class="n">ESP</span><span class="p">,</span><span class="w"></span>
<span class="w">   </span><span class="n">R8D</span><span class="p">,</span><span class="w"> </span><span class="n">R9D</span><span class="p">,</span><span class="w"> </span><span class="n">R10D</span><span class="p">,</span><span class="w"> </span><span class="n">R11D</span><span class="p">,</span><span class="w"> </span><span class="n">R14D</span><span class="p">,</span><span class="w"> </span><span class="n">R15D</span><span class="p">,</span><span class="w"> </span><span class="n">R12D</span><span class="p">,</span><span class="w"> </span><span class="n">R13D</span><span class="p">]</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">...</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>The language used in <cite>.td</cite> files is the Target (Hardware) Description Language,
which allows LLVM backend compiler engineers to define the transformation from
LLVM IR to machine instructions for their CPUs.</p>
<p>In the frontend, compiler development tools provide a <strong>Parser Generator</strong> for
building compilers. In the backend, they offer a <strong>Machine Code Generator</strong> to
facilitate instruction selection and code generation, as shown in
<a class="reference internal" href="#llvmstructure-frontendtblgen"><span class="std std-numref">Fig. 9</span></a> and <a class="reference internal" href="#llvmstructure-llvmtblgen"><span class="std std-numref">Fig. 10</span></a>.</p>
<figure class="align-default" id="id63">
<span id="llvmstructure-frontendtblgen"></span><div class="graphviz"><img src="_images/graphviz-74a5e5851b60471e6d5a9ff7c6db59714d51f294.png" alt="digraph G {
  rankdir=TB;
  subgraph cluster_0 {
	node [color=black]; &quot;parser generator such as yacc/lex&quot;;
	node [shape=note];  &quot;code gen function embedded in BNF&quot;, &quot;regular expression + BNF&quot;, &quot;front parser&quot;;
	&quot;code gen function embedded in BNF&quot; -&gt; &quot;parser generator such as yacc/lex&quot;;
	&quot;regular expression + BNF&quot; -&gt; &quot;parser generator such as yacc/lex&quot;;
	&quot;parser generator such as yacc/lex&quot; -&gt; &quot;front parser&quot;;
  }
  subgraph cluster_1 {
	node [color=black]; &quot;yacc/lex&quot;;
	node [shape=note];  &quot;*.c, *.cpp&quot;, &quot;*.y, *.l&quot;, &quot;front parser: *.cpp&quot;;
	&quot;*.c, *.cpp&quot; -&gt; &quot;yacc/lex&quot;;
	&quot;*.y, *.l&quot; -&gt; &quot;yacc/lex&quot;;
	&quot;yacc/lex&quot; -&gt; &quot;front parser: *.cpp&quot;;
  }
//  label = &quot;Frontend TableGen Flow&quot;;

}" class="graphviz" /></div>
<figcaption>
<p><span class="caption-number">Fig. 9 </span><span class="caption-text">Frontend TableGen Flow</span><a class="headerlink" href="#id63" title="Permalink to this image">¶</a></p>
</figcaption>
</figure>
<figure class="align-default" id="id64">
<span id="llvmstructure-llvmtblgen"></span><div class="graphviz"><img src="_images/graphviz-81295f2014797bb79821309dd987a449dd36f539.png" alt="digraph G {
  rankdir=TB;
  subgraph cluster_0 {
	node [color=black]; &quot;TableGen&quot;;
	node [shape=note];  &quot;Hardware/Target Description Language Files&quot;, &quot;Pattern Match files in c/c++\nfor IR -&gt; Machine Instructions&quot;;
	&quot;Hardware/Target Description Language Files&quot; -&gt; &quot;TableGen&quot;;
	&quot;TableGen&quot; -&gt; &quot;Pattern Match files in c/c++\nfor IR -&gt; Machine Instructions&quot;;
  }
  subgraph cluster_1 {
	node [color=black]; &quot;llvm-tblgen&quot;;
	node [shape=note];  &quot;*.td&quot;, &quot;*.inc&quot;;
	&quot;*.td&quot; -&gt; &quot;llvm-tblgen&quot; -&gt; &quot;*.inc&quot;;
  }
//  label = &quot;llvm TableGen Flow&quot;;

}" class="graphviz" /></div>
<figcaption>
<p><span class="caption-number">Fig. 10 </span><span class="caption-text">llvm TableGen Flow</span><a class="headerlink" href="#id64" title="Permalink to this image">¶</a></p>
</figcaption>
</figure>
</section>
<section id="llvm-code-generation-sequence">
<h3><a class="toc-backref" href="#id92" role="doc-backlink">LLVM Code Generation Sequence</a><a class="headerlink" href="#llvm-code-generation-sequence" title="Permalink to this heading">¶</a></h3>
<p>Following diagram is from <cite>tricore_llvm.pdf</cite>.</p>
<figure class="align-center" id="id65">
<span id="llvmstructure-f9"></span><a class="reference internal image-reference" href="_images/9.png"><img alt="_images/9.png" src="_images/9.png" style="width: 1030px; height: 537px;" /></a>
<figcaption>
<p><span class="caption-number">Fig. 11 </span><span class="caption-text"><cite>tricore_llvm.pdf</cite>: <strong>Code Generation Sequence</strong>
On the path from LLVM code to assembly code, numerous passes are executed,
and several data structures are used to represent intermediate results.</span><a class="headerlink" href="#id65" title="Permalink to this image">¶</a></p>
</figcaption>
</figure>
<p>LLVM is a <strong>Static Single Assignment (SSA)</strong>-based representation.
It provides an infinite number of virtual registers that can hold values of
primitive types, including integral, floating-point, and pointer values.</p>
<p>In LLVM’s SSA representation, each operand is stored in a separate virtual
register. Comments in LLVM IR are denoted by the <cite>;</cite> symbol.</p>
<p>The following are examples of LLVM SSA instructions:</p>
<div class="highlight-llvm notranslate"><div class="highlight"><pre><span></span><span class="k">store</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="kt">i32</span><span class="p">*</span><span class="w"> </span><span class="nv">%a</span><span class="w">  </span><span class="c">; store i32 type of 0 to virtual register %a, %a is</span>
<span class="w">            </span><span class="c">;  pointer type which point to i32 value</span>
<span class="k">store</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="nv">%b</span><span class="p">,</span><span class="w"> </span><span class="kt">i32</span><span class="p">*</span><span class="w"> </span><span class="nv">%c</span><span class="w"> </span><span class="c">; store %b contents to %c point to, %b isi32 type virtual</span>
<span class="w">            </span><span class="c">;  register, %c is pointer type which point to i32 value.</span>
<span class="nv">%a1</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">load</span><span class="w"> </span><span class="kt">i32</span><span class="p">*</span><span class="w"> </span><span class="nv">%a</span><span class="w">    </span><span class="c">; load the memory value where %a point to and assign the</span>
<span class="w">            </span><span class="c">;  memory value to %a1</span>
<span class="nv">%a3</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">add</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="nv">%a2</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="w">  </span><span class="c">; add %a2 and 1 and save to %a3</span>
</pre></div>
</div>
<p>We explain the code generation process below.
If you are unfamiliar with the concepts, we recommend first reviewing
Section 4.2 of <cite>tricore_llvm.pdf</cite>.</p>
<p>You may also refer to <em>The LLVM Target-Independent Code Generator</em> <a class="footnote-reference brackets" href="#codegen" id="id23" role="doc-noteref"><span class="fn-bracket">[</span>12<span class="fn-bracket">]</span></a>
and the <em>LLVM Language Reference Manual</em> <a class="footnote-reference brackets" href="#langref" id="id24" role="doc-noteref"><span class="fn-bracket">[</span>13<span class="fn-bracket">]</span></a>. However, we believe that
Section 4.2 of <cite>tricore_llvm.pdf</cite> provides sufficient information.</p>
<p>We suggest consulting the above web documents only if you still have
difficulties understanding the material, even after reading this section and
the next two sections on <strong>DAG</strong> and <strong>Instruction Selection</strong>.</p>
<ol class="arabic simple">
<li><p><strong>Instruction Selection</strong></p></li>
</ol>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">// In this stage, the LLVM opcode is transformed into a machine opcode,</span>
<span class="go">// but the operand remains an LLVM virtual operand.</span>
<span class="go">    store i16 0, i16* %a  // Store 0 of i16 type to the location pointed to by %a</span>
<span class="go">=&gt;  st i16 0, i32* %a     // Use the Cpu0 backend instruction `st` instead of `store`.</span>
</pre></div>
</div>
<ol class="arabic simple" start="2">
<li><p><strong>Scheduling and Formation</strong></p></li>
</ol>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">// In this stage, instruction order is optimized for execution cycles</span>
<span class="go">// or to reduce register pressure.</span>
<span class="go">    st i32 %a, i16* %b, i16 5  // Store %a to *(%b + 5)</span>
<span class="go">    st %b, i32* %c, i16 0</span>
<span class="gp">    %</span><span class="nv">d</span> <span class="o">=</span> ld i32* %c

<span class="go">// The instruction order is rearranged. In RISC CPUs like MIPS,</span>
<span class="go">// `ld %c` depends on the previous `st %c`, requiring a 1-cycle delay.</span>
<span class="go">// This means `ld` cannot immediately follow `st`.</span>
<span class="go">=&gt;  st %b, i32* %c, i16 0</span>
<span class="go">    st i32 %a, i16* %b, i16 5</span>
<span class="gp">    %</span><span class="nv">d</span> <span class="o">=</span> ld i32* %c, i16 <span class="m">0</span>

<span class="go">// Without instruction reordering, a `nop` instruction must be inserted,</span>
<span class="go">// adding an extra cycle. (In reality, MIPS dynamically schedules</span>
<span class="go">// instructions and inserts `nop` between `st` and `ld` if necessary.)</span>
<span class="go">    st i32 %a, i16* %b, i16 5</span>
<span class="go">    st %b, i32* %c, i16 0</span>
<span class="go">    nop</span>
<span class="gp">    %</span><span class="nv">d</span> <span class="o">=</span> ld i32* %c, i16 <span class="m">0</span>

<span class="go">// **Minimizing Register Pressure**</span>
<span class="go">// Suppose `%c` remains live after the basic block, but `%a` and `%b` do not.</span>
<span class="go">// Without reordering, at least 3 registers are required:</span>
<span class="gp">    %</span><span class="nv">a</span> <span class="o">=</span> add i32 <span class="m">1</span>, i32 <span class="m">0</span>
<span class="gp">    %</span><span class="nv">b</span> <span class="o">=</span> add i32 <span class="m">2</span>, i32 <span class="m">0</span>
<span class="go">    st %a, i32* %c, 1</span>
<span class="go">    st %b, i32* %c, 2</span>

<span class="go">// The reordered version reduces register usage to 2 by allocating `%a`</span>
<span class="go">// and `%b` in the same...</span>

<span class="go">// Register allocation optimization</span>
<span class="go">=&gt; %a = add i32 1, i32 0</span>
<span class="go">    st %a, i32* %c, 1</span>
<span class="gp">    %</span><span class="nv">b</span> <span class="o">=</span> add i32 <span class="m">2</span>, i32 <span class="m">0</span>
<span class="go">    st %b, i32* %c, 2</span>
</pre></div>
</div>
<ol class="arabic" start="3">
<li><p><strong>SSA-Based Machine Code Optimization</strong></p>
<p>For example, common subexpression elimination, as shown in the next
section on <strong>DAG</strong>.</p>
</li>
<li><p><strong>Register Allocation</strong></p>
<p>Assign physical registers to virtual registers.</p>
</li>
<li><p><strong>Prologue/Epilogue Code Insertion</strong></p>
<p>Explained in the section <strong>Add Prologue/Epilogue Functions</strong>.</p>
</li>
<li><p><strong>Late Machine Code Optimizations</strong></p>
<p>Any “last-minute” peephole optimizations of the final machine code
are applied in this phase.
For example, replacing <cite>x = x * 2</cite> with <cite>x = x &lt;&lt; 1</cite> for integer operands.</p>
</li>
<li><p><strong>Code Emission</strong></p>
<p>The final machine code is emitted.
- For <strong>static compilation</strong>, the output is an assembly file.
- For <strong>JIT compilation</strong>, machine instruction opcodes are written into memory.</p>
</li>
</ol>
<p>The LLVM code generation sequence can also be viewed using:</p>
<p><code class="docutils literal notranslate"><span class="pre">llc</span> <span class="pre">-debug-pass=Structure</span></code></p>
<p>as shown below. The first four code generation stages from
<a class="reference internal" href="#llvmstructure-f9"><span class="std std-numref">Fig. 11</span></a> appear in the
<strong>‘DAG-&gt;DAG Pattern Instruction Selection’</strong> section of the
<code class="docutils literal notranslate"><span class="pre">llc</span> <span class="pre">-debug-pass=Structure</span></code> output.</p>
<p>The order of <strong>Peephole Optimizations</strong> and <strong>Prologue/Epilogue Insertion</strong>
differs between <a class="reference internal" href="#llvmstructure-f9"><span class="std std-numref">Fig. 11</span></a> and
<code class="docutils literal notranslate"><span class="pre">llc</span> <span class="pre">-debug-pass=Structure</span></code> (marked with <cite>*</cite> in the output).</p>
<p>There is no need to be concerned about this, as LLVM is continuously evolving,
and its internal sequence may change over time.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">118-165-79-200:input Jonathan$ </span>llc --help-hidden
<span class="go">OVERVIEW: llvm system compiler</span>

<span class="go">USAGE: llc [options] &lt;input bitcode&gt;</span>

<span class="go">OPTIONS:</span>
<span class="go">...</span>
<span class="go">  -debug-pass                             - Print PassManager debugging information</span>
<span class="go">    =None                                 -   disable debug output</span>
<span class="go">    =Arguments                            -   print pass arguments to pass to &#39;opt&#39;</span>
<span class="go">    =Structure                            -   print pass structure before run()</span>
<span class="go">    =Executions                           -   print pass name before it is executed</span>
<span class="go">    =Details                              -   print pass details when it is executed</span>

<span class="gp">118-165-79-200:input Jonathan$ </span>llc -march<span class="o">=</span>mips -debug-pass<span class="o">=</span>Structure ch3.bc
<span class="go">...</span>
<span class="go">Target Library Information</span>
<span class="go">Target Transform Info</span>
<span class="go">Data Layout</span>
<span class="go">Target Pass Configuration</span>
<span class="go">No Alias Analysis (always returns &#39;may&#39; alias)</span>
<span class="go">Type-Based Alias Analysis</span>
<span class="go">Basic Alias Analysis (stateless AA impl)</span>
<span class="go">Create Garbage Collector Module Metadata</span>
<span class="go">Machine Module Information</span>
<span class="go">Machine Branch Probability Analysis</span>
<span class="go">  ModulePass Manager</span>
<span class="go">    FunctionPass Manager</span>
<span class="go">      Preliminary module verification</span>
<span class="go">      Dominator Tree Construction</span>
<span class="go">      Module Verifier</span>
<span class="go">      Natural Loop Information</span>
<span class="go">      Loop Pass Manager</span>
<span class="go">        Canonicalize natural loops</span>
<span class="go">      Scalar Evolution Analysis</span>
<span class="go">      Loop Pass Manager</span>
<span class="go">        Canonicalize natural loops</span>
<span class="go">        Induction Variable Users</span>
<span class="go">        Loop Strength Reduction</span>
<span class="go">      Lower Garbage Collection Instructions</span>
<span class="go">      Remove unreachable blocks from the CFG</span>
<span class="go">      Exception handling preparation</span>
<span class="go">      Optimize for code generation</span>
<span class="go">      Insert stack protectors</span>
<span class="go">      Preliminary module verification</span>
<span class="go">      Dominator Tree Construction</span>
<span class="go">      Module Verifier</span>
<span class="go">      Machine Function Analysis</span>
<span class="go">      Natural Loop Information</span>
<span class="go">      Branch Probability Analysis</span>
<span class="go">    * MIPS DAG-&gt;DAG Pattern Instruction Selection</span>
<span class="go">      Expand ISel Pseudo-instructions</span>
<span class="go">      Tail Duplication</span>
<span class="go">      Optimize machine instruction PHIs</span>
<span class="go">      MachineDominator Tree Construction</span>
<span class="go">      Slot index numbering</span>
<span class="go">      Merge disjoint stack slots</span>
<span class="go">      Local Stack Slot Allocation</span>
<span class="go">      Remove dead machine instructions</span>
<span class="go">      MachineDominator Tree Construction</span>
<span class="go">      Machine Natural Loop Construction</span>
<span class="go">      Machine Loop Invariant Code Motion</span>
<span class="go">      Machine Common Subexpression Elimination</span>
<span class="go">      Machine code sinking</span>
<span class="go">    * Peephole Optimizations</span>
<span class="go">      Process Implicit Definitions</span>
<span class="go">      Remove unreachable machine basic blocks</span>
<span class="go">      Live Variable Analysis</span>
<span class="go">      Eliminate PHI nodes for register allocation</span>
<span class="go">      Two-Address instruction pass</span>
<span class="go">      Slot index numbering</span>
<span class="go">      Live Interval Analysis</span>
<span class="go">      Debug Variable Analysis</span>
<span class="go">      Simple Register Coalescing</span>
<span class="go">      Live Stack Slot Analysis</span>
<span class="go">      Calculate spill weights</span>
<span class="go">      Virtual Register Map</span>
<span class="go">      Live Register Matrix</span>
<span class="go">      Bundle Machine CFG Edges</span>
<span class="go">      Spill Code Placement Analysis</span>
<span class="go">    * Greedy Register Allocator</span>
<span class="go">      Virtual Register Rewriter</span>
<span class="go">      Stack Slot Coloring</span>
<span class="go">      Machine Loop Invariant Code Motion</span>
<span class="go">    * Prologue/Epilogue Insertion &amp; Frame Finalization</span>
<span class="go">      Control Flow Optimizer</span>
<span class="go">      Tail Duplication</span>
<span class="go">      Machine Copy Propagation Pass</span>
<span class="go">    * Post-RA pseudo instruction expansion pass</span>
<span class="go">      MachineDominator Tree Construction</span>
<span class="go">      Machine Natural Loop Construction</span>
<span class="go">      Post RA top-down list latency scheduler</span>
<span class="go">      Analyze Machine Code For Garbage Collection</span>
<span class="go">      Machine Block Frequency Analysis</span>
<span class="go">      Branch Probability Basic Block Placement</span>
<span class="go">      Mips Delay Slot Filler</span>
<span class="go">      Mips Long Branch</span>
<span class="go">      MachineDominator Tree Construction</span>
<span class="go">      Machine Natural Loop Construction</span>
<span class="go">    * Mips Assembly Printer</span>
<span class="go">      Delete Garbage Collector Information</span>
</pre></div>
</div>
<ul>
<li><p>Since <strong>Instruction Scheduling</strong> and <strong>Dead Code Elimination</strong> affect
<strong>Register Allocation</strong>, LLVM does not revisit earlier passes once a later
pass is completed. <strong>Register Allocation</strong> occurs after <strong>Instruction
Scheduling</strong>.</p>
<p>The passes from <strong>Live Variable Analysis</strong> to <strong>Greedy Register Allocator</strong>
handle <strong>Register Allocation</strong>. More details on register allocation passes
can be found here: <a class="footnote-reference brackets" href="#cmu-rac" id="id25" role="doc-noteref"><span class="fn-bracket">[</span>14<span class="fn-bracket">]</span></a> <a class="footnote-reference brackets" href="#ra-wiki" id="id26" role="doc-noteref"><span class="fn-bracket">[</span>15<span class="fn-bracket">]</span></a>.</p>
</li>
</ul>
</section>
<section id="llvm-vs-gcc-in-structure">
<h3><a class="toc-backref" href="#id93" role="doc-backlink">LLVM vs. GCC in Structure</a><a class="headerlink" href="#llvm-vs-gcc-in-structure" title="Permalink to this heading">¶</a></h3>
<p>The official GCC documentation can be found here: <a class="footnote-reference brackets" href="#gnu" id="id27" role="doc-noteref"><span class="fn-bracket">[</span>17<span class="fn-bracket">]</span></a>.</p>
<table class="docutils align-default" id="id66">
<caption><span class="caption-number">Table 10 </span><span class="caption-text">clang vs gcc-frontend</span><a class="headerlink" href="#id66" title="Permalink to this table">¶</a></caption>
<thead>
<tr class="row-odd"><th class="head"><p>frontend</p></th>
<th class="head"><p>clang</p></th>
<th class="head"><p>gcc-frontend <a class="footnote-reference brackets" href="#gcc-frontend" id="id28" role="doc-noteref"><span class="fn-bracket">[</span>18<span class="fn-bracket">]</span></a></p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>LANGUAGE</p></td>
<td><p>C/C++</p></td>
<td><p>C/C++</p></td>
</tr>
<tr class="row-odd"><td><p>parsing</p></td>
<td><p>parsing</p></td>
<td><p>parsing</p></td>
</tr>
<tr class="row-even"><td><p>AST</p></td>
<td><p>clang-AST</p></td>
<td><p>GENERIC <a class="footnote-reference brackets" href="#generic" id="id29" role="doc-noteref"><span class="fn-bracket">[</span>19<span class="fn-bracket">]</span></a></p></td>
</tr>
<tr class="row-odd"><td><p>optimization &amp; codgen</p></td>
<td><p>clang-backend</p></td>
<td><p>gimplifier</p></td>
</tr>
<tr class="row-even"><td><p>IR</p></td>
<td><p>LLVM IR</p></td>
<td><p>GIMPLE <a class="footnote-reference brackets" href="#gimple" id="id30" role="doc-noteref"><span class="fn-bracket">[</span>20<span class="fn-bracket">]</span></a></p></td>
</tr>
</tbody>
</table>
<table class="docutils align-default" id="id67">
<caption><span class="caption-number">Table 11 </span><span class="caption-text">llvm vs gcc (kernal and target/backend)</span><a class="headerlink" href="#id67" title="Permalink to this table">¶</a></caption>
<thead>
<tr class="row-odd"><th class="head"><p>backend</p></th>
<th class="head"><p>llvm</p></th>
<th class="head"><p>gcc</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>IR</p></td>
<td><p>LLVM IR</p></td>
<td><p>GIMPLE</p></td>
</tr>
<tr class="row-odd"><td><p>transfer</p></td>
<td><p>optimziation &amp; pass</p></td>
<td><p>optimization &amp; plugins</p></td>
</tr>
<tr class="row-even"><td><p>DAG</p></td>
<td><p>DAG</p></td>
<td><p>RTL <a class="footnote-reference brackets" href="#rtl" id="id31" role="doc-noteref"><span class="fn-bracket">[</span>21<span class="fn-bracket">]</span></a></p></td>
</tr>
<tr class="row-odd"><td><p>codgen</p></td>
<td><p>tblgen for td</p></td>
<td><p>codgen for md <a class="footnote-reference brackets" href="#md" id="id32" role="doc-noteref"><span class="fn-bracket">[</span>22<span class="fn-bracket">]</span></a></p></td>
</tr>
</tbody>
</table>
<p>Both <strong>LLVM IR</strong> and <strong>GIMPLE</strong> use SSA form.</p>
<p>LLVM IR was originally designed to be fully reusable across various tools,
not just within the compiler itself. In contrast, the <strong>GCC community</strong> never
intended for GIMPLE to be used beyond the compiler.</p>
<p>Richard Stallman actively resisted efforts to make GCC’s IR more reusable to
prevent third-party commercial tools from leveraging GCC frontends.
As a result, <strong>GIMPLE (GCC’s IR)</strong> was never designed to fully describe a
compiled program.</p>
<p>For example, it lacks critical information such as the program’s <strong>call graph</strong>,
<strong>type definitions</strong>, <strong>stack offsets</strong>, and <strong>alias information</strong>
<a class="footnote-reference brackets" href="#llvm-ir-vs-gimple" id="id33" role="doc-noteref"><span class="fn-bracket">[</span>23<span class="fn-bracket">]</span></a>.</p>
</section>
<section id="llvm-blog">
<h3><a class="toc-backref" href="#id94" role="doc-backlink">LLVM Blog</a><a class="headerlink" href="#llvm-blog" title="Permalink to this heading">¶</a></h3>
<p>A user may rely on a <strong>null pointer</strong> as a guard to ensure code correctness.
However, <strong>undef</strong> values occur only during compiler optimizations
<a class="footnote-reference brackets" href="#null-pointer-ex" id="id34" role="doc-noteref"><span class="fn-bracket">[</span>24<span class="fn-bracket">]</span></a>.</p>
<p>If a user fails to explicitly bind a null pointer—either directly or
indirectly—compilers like <strong>LLVM</strong> and <strong>GCC</strong> may interpret the null pointer
as <strong>undef</strong>, leading to unexpected optimization behavior
<a class="footnote-reference brackets" href="#null-pointer" id="id35" role="doc-noteref"><span class="fn-bracket">[</span>25<span class="fn-bracket">]</span></a>.</p>
</section>
<section id="cfg-control-flow-graph">
<h3><a class="toc-backref" href="#id95" role="doc-backlink">CFG (Control Flow Graph)</a><a class="headerlink" href="#cfg-control-flow-graph" title="Permalink to this heading">¶</a></h3>
<p>The SSA form can be represented using a <strong>Control Flow Graph (CFG)</strong> and
optimized by analyzing it.</p>
<p>Each node in the graph represents a <strong>basic block (BB)</strong>—a straight-line
sequence of code without any jumps or jump targets. A jump target always
<strong>starts</strong> a basic block, while a jump <strong>ends</strong> one <a class="footnote-reference brackets" href="#cfg-wiki" id="id36" role="doc-noteref"><span class="fn-bracket">[</span>26<span class="fn-bracket">]</span></a>.</p>
<p>The following is an example of a <strong>CFG</strong>.
<strong>Jumps and branches always appear in the last statement of basic blocks (BBs)</strong>
as shown in <a class="reference internal" href="#cfg-ex"><span class="std std-numref">Fig. 12</span></a>.</p>
<p class="rubric">Fig/llvmstructure/cfg-ex.cpp</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span><span class="w"> </span><span class="nf">cfg_ex</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">n</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">a</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">b</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">i</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">b</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">goto</span><span class="w"> </span><span class="n">label_1</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="nl">label_1</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">case</span><span class="w"> </span><span class="mi">10</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="o">*</span><span class="n">a</span><span class="o">-</span><span class="n">b</span><span class="o">+</span><span class="mi">2</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">a</span><span class="o">++</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">a</span><span class="o">+</span><span class="n">b</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p class="rubric">Fig/llvmstructure/cfg-ex.ll</p>
<div class="highlight-llvm notranslate"><div class="highlight"><pre><span></span><span class="k">define</span><span class="w"> </span><span class="k">dso_local</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="vg">@_Z6cfg_exiii</span><span class="p">(</span><span class="kt">i32</span><span class="w"> </span><span class="k">signext</span><span class="w"> </span><span class="nv">%a</span><span class="p">,</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="k">signext</span><span class="w"> </span><span class="nv">%b</span><span class="p">,</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="k">signext</span><span class="w"> </span><span class="nv">%n</span><span class="p">)</span><span class="w"> </span><span class="k">local_unnamed_addr</span><span class="w"> </span><span class="k">nounwind</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="nl">entry:</span><span class="w"></span>
<span class="w">  </span><span class="nv">%cmp.not23</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">icmp</span><span class="w"> </span><span class="k">slt</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="nv">%n</span><span class="p">,</span><span class="w"> </span><span class="m">0</span><span class="w"></span>
<span class="w">  </span><span class="k">br</span><span class="w"> </span><span class="kt">i1</span><span class="w"> </span><span class="nv">%cmp.not23</span><span class="p">,</span><span class="w"> </span><span class="kt">label</span><span class="w"> </span><span class="nv">%cleanup</span><span class="p">,</span><span class="w"> </span><span class="kt">label</span><span class="w"> </span><span class="nv">%for.body</span><span class="w"></span>

<span class="nl">for.cond:</span><span class="w">                                         </span><span class="c">; preds = %for.body</span>
<span class="w">  </span><span class="nv">%inc</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">add</span><span class="w"> </span><span class="k">nuw</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="nv">%i.026</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="w"></span>
<span class="w">  </span><span class="nv">%exitcond.not</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">icmp</span><span class="w"> </span><span class="k">eq</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="nv">%i.026</span><span class="p">,</span><span class="w"> </span><span class="nv">%n</span><span class="w"></span>
<span class="w">  </span><span class="k">br</span><span class="w"> </span><span class="kt">i1</span><span class="w"> </span><span class="nv">%exitcond.not</span><span class="p">,</span><span class="w"> </span><span class="kt">label</span><span class="w"> </span><span class="nv">%cleanup</span><span class="p">,</span><span class="w"> </span><span class="kt">label</span><span class="w"> </span><span class="nv">%for.body</span><span class="p">,</span><span class="w"> </span><span class="nv">!llvm.loop</span><span class="w"> </span><span class="nv nv-Anonymous">!2</span><span class="w"></span>

<span class="nl">for.body:</span><span class="w">                                         </span><span class="c">; preds = %entry, %for.cond</span>
<span class="w">  </span><span class="nv">%i.026</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">phi</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="nv">%inc</span><span class="p">,</span><span class="w"> </span><span class="nv">%for.cond</span><span class="w"> </span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="nv">%entry</span><span class="w"> </span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="nv">%a.addr.025</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">phi</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="nv">%a.addr.1</span><span class="p">,</span><span class="w"> </span><span class="nv">%for.cond</span><span class="w"> </span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="nv">%a</span><span class="p">,</span><span class="w"> </span><span class="nv">%entry</span><span class="w"> </span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="nv">%b.addr.024</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">phi</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="nv">%b.addr.1</span><span class="p">,</span><span class="w"> </span><span class="nv">%for.cond</span><span class="w"> </span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="nv">%b</span><span class="p">,</span><span class="w"> </span><span class="nv">%entry</span><span class="w"> </span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="nv">%cmp1</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">icmp</span><span class="w"> </span><span class="k">slt</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="nv">%a.addr.025</span><span class="p">,</span><span class="w"> </span><span class="nv">%b.addr.024</span><span class="w"></span>
<span class="w">  </span><span class="nv">%sub</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">sext</span><span class="w"> </span><span class="kt">i1</span><span class="w"> </span><span class="nv">%cmp1</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="kt">i32</span><span class="w"></span>
<span class="w">  </span><span class="nv">%b.addr.1</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">add</span><span class="w"> </span><span class="k">nsw</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="nv">%b.addr.024</span><span class="p">,</span><span class="w"> </span><span class="nv">%sub</span><span class="w"></span>
<span class="w">  </span><span class="nv">%add</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="kt">i1</span><span class="w"> </span><span class="nv">%cmp1</span><span class="p">,</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="nv">%i.026</span><span class="p">,</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="m">0</span><span class="w"></span>
<span class="w">  </span><span class="nv">%a.addr.1</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">add</span><span class="w"> </span><span class="k">nsw</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="nv">%add</span><span class="p">,</span><span class="w"> </span><span class="nv">%a.addr.025</span><span class="w"></span>
<span class="w">  </span><span class="nv">%cmp2</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">icmp</span><span class="w"> </span><span class="k">eq</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="nv">%b.addr.1</span><span class="p">,</span><span class="w"> </span><span class="m">0</span><span class="w"></span>
<span class="w">  </span><span class="k">br</span><span class="w"> </span><span class="kt">i1</span><span class="w"> </span><span class="nv">%cmp2</span><span class="p">,</span><span class="w"> </span><span class="kt">label</span><span class="w"> </span><span class="nv">%cleanup</span><span class="p">,</span><span class="w"> </span><span class="kt">label</span><span class="w"> </span><span class="nv">%for.cond</span><span class="w"></span>

<span class="nl">cleanup:</span><span class="w">                                          </span><span class="c">; preds = %for.cond, %for.body, %entry</span>
<span class="w">  </span><span class="nv">%b.addr.2</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">phi</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="nv">%b</span><span class="p">,</span><span class="w"> </span><span class="nv">%entry</span><span class="w"> </span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="nv">%for.body</span><span class="w"> </span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="nv">%b.addr.1</span><span class="p">,</span><span class="w"> </span><span class="nv">%for.cond</span><span class="w"> </span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="nv">%a.addr.2</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">phi</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="nv">%a</span><span class="p">,</span><span class="w"> </span><span class="nv">%entry</span><span class="w"> </span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="nv">%a.addr.1</span><span class="p">,</span><span class="w"> </span><span class="nv">%for.body</span><span class="w"> </span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="nv">%a.addr.1</span><span class="p">,</span><span class="w"> </span><span class="nv">%for.cond</span><span class="w"> </span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="nv">%cond</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">icmp</span><span class="w"> </span><span class="k">eq</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="nv">%a.addr.2</span><span class="p">,</span><span class="w"> </span><span class="m">10</span><span class="w"></span>
<span class="w">  </span><span class="nv">%inc7</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">sub</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="m">103</span><span class="p">,</span><span class="w"> </span><span class="nv">%b.addr.2</span><span class="w"></span>
<span class="w">  </span><span class="nv">%spec.select</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="kt">i1</span><span class="w"> </span><span class="nv">%cond</span><span class="p">,</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="nv">%inc7</span><span class="p">,</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="nv">%a.addr.2</span><span class="w"></span>
<span class="w">  </span><span class="nv">%add8</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">add</span><span class="w"> </span><span class="k">nsw</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="nv">%spec.select</span><span class="p">,</span><span class="w"> </span><span class="nv">%b.addr.2</span><span class="w"></span>
<span class="w">  </span><span class="k">ret</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="nv">%add8</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>


<span class="nv">!llvm.module.flags</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">!{</span><span class="nv nv-Anonymous">!0</span><span class="p">}</span><span class="w"></span>
<span class="nv">!llvm.ident</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">!{</span><span class="nv nv-Anonymous">!1</span><span class="p">}</span><span class="w"></span>

<span class="nv nv-Anonymous">!0</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">!{</span><span class="kt">i32</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="nv">!&quot;wchar_size&quot;</span><span class="p">,</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="m">4</span><span class="p">}</span><span class="w"></span>
<span class="nv nv-Anonymous">!1</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">!{</span><span class="nv">!&quot;clang version 12.0.1&quot;</span><span class="p">}</span><span class="w"></span>
<span class="nv nv-Anonymous">!2</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">distinct</span><span class="w"> </span><span class="p">!{</span><span class="nv nv-Anonymous">!2</span><span class="p">,</span><span class="w"> </span><span class="nv nv-Anonymous">!3</span><span class="p">}</span><span class="w"></span>
<span class="nv nv-Anonymous">!3</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">!{</span><span class="nv">!&quot;llvm.loop.mustprogress&quot;</span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<figure class="align-default" id="id68">
<span id="cfg-ex"></span><div class="graphviz"><img src="_images/graphviz-33dbdf253a496f9077096534345d816e37d38be1.png" alt="digraph &quot;CFG for '_Z6cfg_exiii' function&quot; {
	label=&quot;CFG for '_Z6cfg_exiii' function&quot;;

	Node0x600001b56240 [shape=record,color=&quot;#3d50c3ff&quot;, style=filled, fillcolor=&quot;#d6dce470&quot;,label=&quot;{entry:\l  %cmp.not23 = icmp slt i32 %n, 0\l  br i1 %cmp.not23, label %cleanup, label %for.body\l|{&lt;s0&gt;T|&lt;s1&gt;F}}&quot;];
	Node0x600001b56240:s0 -&gt; Node0x600001b56280;
	Node0x600001b56240:s1 -&gt; Node0x600001b562c0;
	Node0x600001b56300 [shape=record,color=&quot;#b70d28ff&quot;, style=filled, fillcolor=&quot;#bb1b2c70&quot;,label=&quot;{for.cond:                                         \l  %inc = add nuw i32 %i.026, 1\l  %exitcond.not = icmp eq i32 %i.026, %n\l  br i1 %exitcond.not, label %cleanup, label %for.body, !llvm.loop !2\l|{&lt;s0&gt;T|&lt;s1&gt;F}}&quot;];
	Node0x600001b56300:s0 -&gt; Node0x600001b56280;
	Node0x600001b56300:s1 -&gt; Node0x600001b562c0;
	Node0x600001b562c0 [shape=record,color=&quot;#b70d28ff&quot;, style=filled, fillcolor=&quot;#b70d2870&quot;,label=&quot;{for.body:                                         \l  %i.026 = phi i32 [ %inc, %for.cond ], [ 0, %entry ]\l  %a.addr.025 = phi i32 [ %a.addr.1, %for.cond ], [ %a, %entry ]\l  %b.addr.024 = phi i32 [ %b.addr.1, %for.cond ], [ %b, %entry ]\l  %cmp1 = icmp slt i32 %a.addr.025, %b.addr.024\l  %sub = sext i1 %cmp1 to i32\l  %b.addr.1 = add nsw i32 %b.addr.024, %sub\l  %add = select i1 %cmp1, i32 %i.026, i32 0\l  %a.addr.1 = add nsw i32 %add, %a.addr.025\l  %cmp2 = icmp eq i32 %b.addr.1, 0\l  br i1 %cmp2, label %cleanup, label %for.cond\l|{&lt;s0&gt;T|&lt;s1&gt;F}}&quot;];
	Node0x600001b562c0:s0 -&gt; Node0x600001b56280;
	Node0x600001b562c0:s1 -&gt; Node0x600001b56300;
	Node0x600001b56280 [shape=record,color=&quot;#3d50c3ff&quot;, style=filled, fillcolor=&quot;#d6dce470&quot;,label=&quot;{cleanup:                                          \l  %b.addr.2 = phi i32 [ %b, %entry ], [ 0, %for.body ], [ %b.addr.1, %for.cond\l... ]\l  %a.addr.2 = phi i32 [ %a, %entry ], [ %a.addr.1, %for.body ], [ %a.addr.1,\l... %for.cond ]\l  %cond = icmp eq i32 %a.addr.2, 10\l  %inc7 = sub i32 103, %b.addr.2\l  %spec.select = select i1 %cond, i32 %inc7, i32 %a.addr.2\l  %add8 = add nsw i32 %spec.select, %b.addr.2\l  ret i32 %add8\l}&quot;];
}" class="graphviz" /></div>
<figcaption>
<p><span class="caption-number">Fig. 12 </span><span class="caption-text">CFG for cfg-ex.ll</span><a class="headerlink" href="#id68" title="Permalink to this image">¶</a></p>
</figcaption>
</figure>
</section>
<section id="dag-directed-acyclic-graph">
<h3><a class="toc-backref" href="#id96" role="doc-backlink">DAG (Directed Acyclic Graph)</a><a class="headerlink" href="#dag-directed-acyclic-graph" title="Permalink to this heading">¶</a></h3>
<p>The SSA form within each <strong>Basic Block (BB)</strong> from the <strong>Control Flow Graph
(CFG)</strong>, as discussed in the previous section, can be represented using a
<strong>Directed Acyclic Graph (DAG)</strong>.</p>
<p>Many key <strong>local optimization</strong> techniques begin by transforming a basic block
into a DAG <a class="footnote-reference brackets" href="#dragonbooks-8-5" id="id37" role="doc-noteref"><span class="fn-bracket">[</span>27<span class="fn-bracket">]</span></a>.</p>
<p>For example, the basic block code and its corresponding DAG are illustrated in
<a class="reference internal" href="#llvmstructure-dag-ex"><span class="std std-numref">Fig. 13</span></a>.</p>
<figure class="align-default" id="id69">
<span id="llvmstructure-dag-ex"></span><div class="graphviz"><img src="_images/graphviz-07cb6760fa51dfd8828f1a2b7971e81db32fd691.png" alt="graph {
  subgraph cluster_1
  {
   label = &quot;a,d = b ediv c \nb = a - d \nc = b + c \nd = a - d&quot;; 
   A_c ;
   A_c [label=&quot;c\n+&quot;] ;
   A_c -- A_bd ;
   A_bd [label=&quot;b,d\n-&quot;] ;
   A_bd -- A_a ;
   A_bd -- A_d0 ;
   A_a [label=&quot;a&quot;, shape=none] ;
   A_a -- A_ediv [style=dashed];
   A_d0 [label=&quot;d0&quot;, shape=none] ;
   A_d0 -- A_ediv [style=dashed];
   A_ediv [label=&quot;ediv&quot;] ;
   A_ediv -- A_b0 ;
   A_b0 [label=&quot;b0&quot;, shape=none] ;
   A_ediv -- A_c0 ;
   A_c0 [label=&quot;c0&quot;, shape=none] ;
   A_c -- A_c0;
  }

  subgraph cluster_2
  {
   label = &quot;a = b + c \nb = a - d \nc = b + c \nd = a - d&quot;; 
   B_c ;
   B_c [label=&quot;c\n+&quot;] ;
   B_c -- B_bd ;
   B_bd [label=&quot;b,d\n-&quot;] ;
   B_bd -- B_a ;
   B_bd -- B_d0 ;
   B_a [label=&quot;a\n+&quot;] ;
   B_d0 [label=&quot;d0&quot;, shape=none] ;
   B_a -- B_b0 ;
   B_b0 [label=&quot;b0&quot;, shape=none] ;
   B_a -- B_c0 ;
   B_c0 [label=&quot;c0&quot;, shape=none] ;
   B_c -- B_c0;
 }
}" class="graphviz" /></div>
<figcaption>
<p><span class="caption-number">Fig. 13 </span><span class="caption-text">The left example includes two destination registers, while
the right has only one destination.</span><a class="headerlink" href="#id69" title="Permalink to this image">¶</a></p>
</figcaption>
</figure>
<p>DAG and SSA allow instructions to have two destination virtual registers.</p>
<p>Assume the <cite>ediv</cite> operation performs integer division, storing the <strong>quotient</strong>
in <cite>a</cite> and the <strong>remainder</strong> in <cite>d</cite>.</p>
<p>If only one destination register is used, the DAG may be simplified, as shown
on the right in <a class="reference internal" href="#llvmstructure-dag-ex"><span class="std std-numref">Fig. 13</span></a>.</p>
<p>If <cite>b</cite> is not live at the exit of the block, we can apply <strong>common subexpression
elimination</strong>, as demonstrated in the table below.</p>
<table class="docutils align-default" id="id70">
<caption><span class="caption-number">Table 12 </span><span class="caption-text">Common Subexpression Elimination Process</span><a class="headerlink" href="#id70" title="Permalink to this table">¶</a></caption>
<thead>
<tr class="row-odd"><th class="head"><p>Replace node b with node d</p></th>
<th class="head"><p>Replace b<sub>0</sub>, c<sub>0</sub>, d<sub>0</sub> with b, c, d</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>a = b<sub>0</sub> + c<sub>0</sub></p></td>
<td><p>a = b + c</p></td>
</tr>
<tr class="row-odd"><td><p>d = a – d<sub>0</sub></p></td>
<td><p>d = a – d</p></td>
</tr>
<tr class="row-even"><td><p>c = d + c</p></td>
<td><p>c = d + c</p></td>
</tr>
</tbody>
</table>
<p>After removing <cite>b</cite> and traversing the DAG from bottom to top
(using <strong>Depth-First In-Order Search</strong> in a binary tree),
we obtain the first column of the table above.</p>
<p>As you can imagine, <strong>common subexpression elimination</strong> can be applied
both at the <strong>IR</strong> level and in <strong>machine code</strong>.</p>
<p>A <strong>DAG</strong> resembles a tree where <strong>opcodes</strong> are nodes,
and <strong>operands</strong> (registers, constants, immediates, or offsets) are leaves.
It can also be represented as a <strong>prefix-ordered list</strong> in a tree structure.
For example, <cite>(+ b, c)</cite> and <cite>(+ b, 1)</cite> are IR DAG representations.</p>
<p>In addition to <strong>DAG optimization</strong>, <strong>kill registers</strong> are discussed
in Section 8.5.5 of the compiler book <a class="footnote-reference brackets" href="#dragonbooks-8-5" id="id38" role="doc-noteref"><span class="fn-bracket">[</span>27<span class="fn-bracket">]</span></a>.
This optimization method is also applied in LLVM.</p>
</section>
<section id="instruction-selection">
<h3><a class="toc-backref" href="#id97" role="doc-backlink">Instruction Selection</a><a class="headerlink" href="#instruction-selection" title="Permalink to this heading">¶</a></h3>
<p>A major function of the backend is to <strong>translate IR code into machine code</strong>
during <strong>Instruction Selection</strong>, as illustrated in <a class="reference internal" href="#llvmstructure-f11"><span class="std std-numref">Fig. 14</span></a>.</p>
<figure class="align-center" id="id71">
<span id="llvmstructure-f11"></span><a class="reference internal image-reference" href="_images/111.png"><img alt="_images/111.png" src="_images/111.png" style="width: 346.5px; height: 81.19999999999999px;" /></a>
<figcaption>
<p><span class="caption-number">Fig. 14 </span><span class="caption-text">IR and its corresponding machine instruction</span><a class="headerlink" href="#id71" title="Permalink to this image">¶</a></p>
</figcaption>
</figure>
<p>For <strong>machine instruction selection</strong>, the best approach is to represent both
<strong>IR</strong> and <strong>machine instructions</strong> as a <strong>DAG</strong>.</p>
<p>To simplify visualization, <strong>register leaves</strong> are omitted in
<a class="reference internal" href="#llvmstructure-f12"><span class="std std-numref">Fig. 15</span></a>.</p>
<p>The expression <cite>rₖ + rⱼ</cite> represents an <strong>IR DAG</strong> (used as a symbolic notation,
not in LLVM SSA form). <cite>ADD</cite> is the corresponding machine instruction.</p>
<figure class="align-center" id="id72">
<span id="llvmstructure-f12"></span><a class="reference internal image-reference" href="_images/121.png"><img alt="_images/121.png" src="_images/121.png" style="width: 690.1999999999999px; height: 426.29999999999995px;" /></a>
<figcaption>
<p><span class="caption-number">Fig. 15 </span><span class="caption-text">Instruction DAG representation</span><a class="headerlink" href="#id72" title="Permalink to this image">¶</a></p>
</figcaption>
</figure>
<p>The <strong>IR DAG</strong> and <strong>machine instruction DAG</strong> can also be represented as lists.
For example:</p>
<ul class="simple">
<li><p><strong>IR DAG lists:</strong> <cite>(+ rᵢ, rⱼ)</cite> and <cite>(- rᵢ, 1)</cite></p></li>
<li><p><strong>Machine instruction DAG lists:</strong> <cite>(ADD rᵢ, rⱼ)</cite> and <cite>(SUBI rᵢ, 1)</cite></p></li>
</ul>
<p>Now, let’s examine the <strong>ADDiu</strong> instruction defined in <cite>Cpu0InstrInfo.td</cite>:</p>
<p class="rubric">lbdex/chapters/Chapter2/Cpu0InstrFormats.td</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//===----------------------------------------------------------------------===//</span>
<span class="o">//</span> <span class="n">Format</span> <span class="n">L</span> <span class="n">instruction</span> <span class="k">class</span> <span class="nc">in</span> <span class="n">Cpu0</span> <span class="p">:</span> <span class="o">&lt;|</span><span class="n">opcode</span><span class="o">|</span><span class="n">ra</span><span class="o">|</span><span class="n">rb</span><span class="o">|</span><span class="n">cx</span><span class="o">|&gt;</span>
<span class="o">//===----------------------------------------------------------------------===//</span>

<span class="k">class</span> <span class="nc">FL</span><span class="o">&lt;</span><span class="n">bits</span><span class="o">&lt;</span><span class="mi">8</span><span class="o">&gt;</span> <span class="n">op</span><span class="p">,</span> <span class="n">dag</span> <span class="n">outs</span><span class="p">,</span> <span class="n">dag</span> <span class="n">ins</span><span class="p">,</span> <span class="n">string</span> <span class="n">asmstr</span><span class="p">,</span> <span class="nb">list</span><span class="o">&lt;</span><span class="n">dag</span><span class="o">&gt;</span> <span class="n">pattern</span><span class="p">,</span>
         <span class="n">InstrItinClass</span> <span class="n">itin</span><span class="o">&gt;</span><span class="p">:</span> <span class="n">Cpu0Inst</span><span class="o">&lt;</span><span class="n">outs</span><span class="p">,</span> <span class="n">ins</span><span class="p">,</span> <span class="n">asmstr</span><span class="p">,</span> <span class="n">pattern</span><span class="p">,</span> <span class="n">itin</span><span class="p">,</span> <span class="n">FrmL</span><span class="o">&gt;</span>
<span class="p">{</span>
  <span class="n">bits</span><span class="o">&lt;</span><span class="mi">4</span><span class="o">&gt;</span>  <span class="n">ra</span><span class="p">;</span>
  <span class="n">bits</span><span class="o">&lt;</span><span class="mi">4</span><span class="o">&gt;</span>  <span class="n">rb</span><span class="p">;</span>
  <span class="n">bits</span><span class="o">&lt;</span><span class="mi">16</span><span class="o">&gt;</span> <span class="n">imm16</span><span class="p">;</span>

  <span class="n">let</span> <span class="n">Opcode</span> <span class="o">=</span> <span class="n">op</span><span class="p">;</span>

  <span class="n">let</span> <span class="n">Inst</span><span class="p">{</span><span class="mi">23</span><span class="o">-</span><span class="mi">20</span><span class="p">}</span> <span class="o">=</span> <span class="n">ra</span><span class="p">;</span>
  <span class="n">let</span> <span class="n">Inst</span><span class="p">{</span><span class="mi">19</span><span class="o">-</span><span class="mi">16</span><span class="p">}</span> <span class="o">=</span> <span class="n">rb</span><span class="p">;</span>
  <span class="n">let</span> <span class="n">Inst</span><span class="p">{</span><span class="mi">15</span><span class="o">-</span><span class="mi">0</span><span class="p">}</span>  <span class="o">=</span> <span class="n">imm16</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter2/Cpu0InstrInfo.td</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//</span> <span class="n">Node</span> <span class="n">immediate</span> <span class="n">fits</span> <span class="k">as</span> <span class="mi">16</span><span class="o">-</span><span class="n">bit</span> <span class="n">sign</span> <span class="n">extended</span> <span class="n">on</span> <span class="n">target</span> <span class="n">immediate</span><span class="o">.</span>
<span class="o">//</span> <span class="n">e</span><span class="o">.</span><span class="n">g</span><span class="o">.</span> <span class="n">addi</span><span class="p">,</span> <span class="n">andi</span>
<span class="k">def</span> <span class="nf">immSExt16</span>  <span class="p">:</span> <span class="n">PatLeaf</span><span class="o">&lt;</span><span class="p">(</span><span class="n">imm</span><span class="p">),</span> <span class="p">[{</span> <span class="k">return</span> <span class="n">isInt</span><span class="o">&lt;</span><span class="mi">16</span><span class="o">&gt;</span><span class="p">(</span><span class="n">N</span><span class="o">-&gt;</span><span class="n">getSExtValue</span><span class="p">());</span> <span class="p">}]</span><span class="o">&gt;</span><span class="p">;</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>// Arithmetic and logical instructions with 2 register operands.
class ArithLogicI&lt;bits&lt;8&gt; op, string instr_asm, SDNode OpNode,
                  Operand Od, PatLeaf imm_type, RegisterClass RC&gt; :
  FL&lt;op, (outs GPROut:$ra), (ins RC:$rb, Od:$imm16),
     !strconcat(instr_asm, &quot;\t$ra, $rb, $imm16&quot;),
     [(set GPROut:$ra, (OpNode RC:$rb, imm_type:$imm16))], IIAlu&gt; {
  let isReMaterializable = 1;
}
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//</span> <span class="n">IR</span> <span class="s2">&quot;add&quot;</span> <span class="n">defined</span> <span class="ow">in</span> <span class="n">include</span><span class="o">/</span><span class="n">llvm</span><span class="o">/</span><span class="n">Target</span><span class="o">/</span><span class="n">TargetSelectionDAG</span><span class="o">.</span><span class="n">td</span><span class="p">,</span> <span class="n">line</span> <span class="mi">315</span> <span class="p">(</span><span class="k">def</span> <span class="nf">add</span><span class="p">)</span><span class="o">.</span>
<span class="k">def</span> <span class="nf">ADDiu</span>   <span class="p">:</span> <span class="n">ArithLogicI</span><span class="o">&lt;</span><span class="mh">0x09</span><span class="p">,</span> <span class="s2">&quot;addiu&quot;</span><span class="p">,</span> <span class="n">add</span><span class="p">,</span> <span class="n">simm16</span><span class="p">,</span> <span class="n">immSExt16</span><span class="p">,</span> <span class="n">CPURegs</span><span class="o">&gt;</span><span class="p">;</span>
</pre></div>
</div>
<p><a class="reference internal" href="#llvmstructure-f13"><span class="std std-numref">Fig. 16</span></a> illustrates how pattern matching works between the
<strong>IR node</strong> <cite>add</cite> and the <strong>instruction node</strong> <cite>ADDiu</cite>, both defined in
<cite>Cpu0InstrInfo.td</cite>.</p>
<p>In this example, the IR node <cite>“add %a, 5”</cite> is translated into <cite>“addiu $r1, 5”</cite>
after <cite>%a</cite> is allocated to register <cite>$r1</cite> during the <strong>register allocation</strong>
stage.</p>
<p>This translation occurs because the IR pattern
<cite>(set RC:$ra, (OpNode RC:$rb, imm_type:$imm16))</cite> is defined for <cite>ADDiu</cite>,
where the second operand is a <strong>signed immediate</strong> that matches <cite>%a, 5</cite>.</p>
<p>In addition to pattern matching, the <cite>.td</cite> file specifies the <strong>assembly
mnemonic</strong> <cite>“addiu”</cite> and the <strong>opcode</strong> <cite>0x09</cite>.</p>
<p>Using this information, <strong>LLVM TableGen</strong> automatically generates both assembly
instructions and binary encodings. The resulting <strong>binary instruction</strong> can be
included in an <strong>ELF object file</strong>, which will be explained in a later chapter.</p>
<p>Similarly, <strong>machine instruction DAG nodes</strong> <cite>LD</cite> and <cite>ST</cite> are translated from
the IR DAG nodes <strong>load</strong> and <strong>store</strong>.</p>
<p>Note that in <a class="reference internal" href="#llvmstructure-f13"><span class="std std-numref">Fig. 16</span></a>, <cite>$rb</cite> represents a <strong>virtual register</strong>
rather than a physical machine register. The details are further illustrated
in <a class="reference internal" href="#llvmstructure-dag"><span class="std std-numref">Fig. 17</span></a>.</p>
<figure class="align-center" id="id73">
<span id="llvmstructure-f13"></span><a class="reference internal image-reference" href="_images/131.png"><img alt="_images/131.png" src="_images/131.png" style="width: 514.4px; height: 336.8px;" /></a>
<figcaption>
<p><span class="caption-number">Fig. 16 </span><span class="caption-text">Pattern matching for <cite>ADDiu</cite> instruction and IR node <cite>add</cite></span><a class="headerlink" href="#id73" title="Permalink to this image">¶</a></p>
</figcaption>
</figure>
<figure class="align-default" id="id74">
<span id="llvmstructure-dag"></span><div class="graphviz"><img src="_images/graphviz-4816905b0ecf540eb7738dd0fd22a71c33c2d82a.png" alt="digraph &quot;DAG&quot; {
  rankdir=&quot;TB&quot;;      
//  label = &quot;Figure: Pattern match for ADDiu instruction and IR node add in detail&quot;;
  td [ penwidth = 1, fontname = &quot;Courier New&quot;, shape = &quot;rectangle&quot;, label =&lt;&lt;table border=&quot;0&quot; cellborder=&quot;0&quot; cellpadding=&quot;3&quot; bgcolor=&quot;white&quot;&gt;
    &lt;tr&gt;&lt;td bgcolor=&quot;grey&quot; align=&quot;center&quot; colspan=&quot;2&quot;&gt;&lt;font color=&quot;white&quot;&gt;Cpu0InstrInfo.td&lt;/font&gt;&lt;/td&gt;&lt;/tr&gt;
    &lt;tr&gt;&lt;td align=&quot;left&quot; port=&quot;f0&quot;&gt;def immSExt16  : PatLeaf&amp;#60;(imm), [{ return isInt&amp;#60;16&amp;#62;(N-&amp;#60;getSExtValue()); }]&amp;#62;;&lt;/td&gt;&lt;/tr&gt;
    &lt;tr&gt;&lt;td align=&quot;left&quot;&gt;class ArithLogicI&amp;#60;bits&amp;#60;8&amp;#62; op, string instr_asm, SDNode OpNode&lt;/td&gt;&lt;/tr&gt;
    &lt;tr&gt;&lt;td align=&quot;left&quot; port=&quot;f1&quot;&gt;                  Operand Od, PatLeaf imm_type, RegisterClass RC&amp;#62; &lt;/td&gt;&lt;/tr&gt;
    &lt;tr&gt;&lt;td align=&quot;left&quot; port=&quot;f2&quot;&gt; FL&amp;#60;0op, (outs RC:$ra), (ins RC:$rb, Od:$imm16),&lt;/td&gt;&lt;/tr&gt;
    &lt;tr&gt;&lt;td align=&quot;left&quot; port=&quot;f3&quot;&gt;  !strconcat(instr_asm, &quot;\t$ra, $rb, $imm16&quot;),&lt;/td&gt;&lt;/tr&gt;
    &lt;tr&gt;&lt;td align=&quot;left&quot; port=&quot;f4&quot;&gt; [(set RC:$ra, (OpNode RC:$rb, imm_type:$imm16))], IIAlu&amp;#62; {&lt;/td&gt;&lt;/tr&gt;
    &lt;tr&gt;&lt;td align=&quot;left&quot; port=&quot;f5&quot;&gt; let isReMaterializable = 1;&lt;/td&gt;&lt;/tr&gt;
    &lt;tr&gt;&lt;td align=&quot;left&quot;&gt;}&lt;/td&gt;&lt;/tr&gt;
    &lt;tr&gt;&lt;td align=&quot;left&quot; port=&quot;f6&quot;&gt;def ADDiu   : ArithLogicI&amp;#60;0x09, &quot;addiu&quot;, add, simm16, immSExt16, CPURegs&amp;#62;; &lt;/td&gt;&lt;/tr&gt;
    &lt;/table&gt;&gt; ];
  a [shape=Mrecord,label=&quot;&lt;aa&gt;def ADDiu   : ArithLogicI\&lt;|&lt;a0&gt;0x09, |&lt;a1&gt;\&quot;addiu\&quot;, |&lt;a2&gt;add, |&lt;a3&gt;simm16, |&lt;a4&gt;immSExt16, |&lt;a5&gt;CPURegs\&gt;;&quot;];
  p [shape=Mrecord,label=&quot;&lt;p8&gt;RC:|&lt;p9&gt;$ra|&lt;p0&gt;OpNode|&lt;p1&gt;RC:|&lt;p2&gt;$rb|&lt;p3&gt;imm_type:|&lt;p4&gt;$imm16&quot;];
  q [shape=Mrecord,label=&quot;&lt;q8&gt;CPURegs:|&lt;q9&gt;$ra|&lt;q0&gt;add|&lt;q1&gt;CPURegs:|&lt;q2&gt;$rb|&lt;q3&gt;immSExt16:|&lt;q4&gt;$imm16&quot;];
  asm [shape=Mrecord,label=&quot;&lt;asm0&gt;\!strconcat\(|&lt;asm1&gt;instr_asm, \&quot;\\t|&lt;asm2&gt;$ra, |&lt;asm3&gt;$rb, |&lt;asm4&gt;$imm16\)&quot;];
  mi [shape=Mrecord,label=&quot;&lt;mi0&gt;addiu|&lt;mi1&gt;$r2|&lt;mi2&gt;$r1|&lt;mi3&gt;5&quot;];
  
  td -&gt; a;
  td:f0:e -&gt; q:q3 [label=&quot;%0 = add %a, 5 -- (5 is true for immSExt16, \nso pattern match for ADDiu succeed&quot;];
  a:a2 -&gt; p:p0;
  a:a5 -&gt; p:p1;
  a:a5 -&gt; p:p8;
  a:a4 -&gt; p:p3;
  td:f4:w -&gt; p:w;
  td:f3:w -&gt; asm:w;
  p:p0 -&gt; q:q0;
  p:p1 -&gt; q:q1;
  p:p8 -&gt; q:q8;
  p:p3 -&gt; q:q3;
  p:e -&gt; q:e [label=&quot;expand pattern match rule&quot;];
  q:q0 -&gt; asm:asm0;
  q:q9 -&gt; asm:asm1;
  q:q2 -&gt; asm:asm2;
  q:q4 -&gt; asm:asm4;
  q:e -&gt; asm:e [label=&quot;expand machine asm instruction&quot;];
  asm:asm1 -&gt; mi:mi0 [label=&quot;addiu&quot;];
  asm:asm2 -&gt; mi:mi1 [label=&quot;$r2&quot;];
  asm:asm3 -&gt; mi:mi2 [label=&quot;$r1&quot;];
  asm:asm4 -&gt; mi:mi3 [label=&quot;5&quot;];
  asm:e -&gt; mi:e[label=&quot;When llvm assign $r2 as destination register, $r1 as source 0 register&quot;];
}" class="graphviz" /></div>
<figcaption>
<p><span class="caption-number">Fig. 17 </span><span class="caption-text">Detailed pattern matching for <cite>ADDiu</cite> instruction and IR node <cite>add</cite></span><a class="headerlink" href="#id74" title="Permalink to this image">¶</a></p>
</figcaption>
</figure>
<p>During <strong>DAG instruction selection</strong>, the <strong>leaf node must be a Data Node</strong>.
<cite>ADDiu</cite> follows the <strong>L-type instruction format</strong>, requiring the last operand
to fit within a <strong>16-bit signed range</strong>.</p>
<p>To enforce this constraint, <cite>Cpu0InstrInfo.td</cite> defines a <strong>PatLeaf</strong> type
<cite>immSExt16</cite>, allowing the LLVM system to recognize the valid operand range.</p>
<p>If the immediate value exceeds this range,
<cite>“isInt&lt;16&gt;(N-&gt;getSExtValue())”</cite> returns <cite>false</cite>, and the <strong>`ADDiu` pattern
is not selected</strong> during instruction selection.</p>
<p>Some CPUs and <strong>floating-point units (FPUs)</strong> include a <strong>multiply-and-add</strong>
floating-point instruction, <cite>fmadd</cite>.</p>
<p>This instruction can be represented using a <strong>DAG list</strong> as follows:
<cite>(fadd (fmul ra, rc), rb)</cite>.</p>
<p>To implement this, we define the <strong>fmadd DAG pattern</strong> in the instruction <cite>.td</cite>
file as shown below:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>def FMADDS : AForm_1&lt;59, 29,
          (ops F4RC:$FRT, F4RC:$FRA, F4RC:$FRC, F4RC:$FRB),
          &quot;fmadds $FRT, $FRA, $FRC, $FRB&quot;,
          [(set F4RC:$FRT, (fadd (fmul F4RC:$FRA, F4RC:$FRC),
                       F4RC:$FRB))]&gt;;
</pre></div>
</div>
<p>Similar to <cite>ADDiu</cite>, the pattern
<cite>[(set F4RC:$FRT, (fadd (fmul F4RC:$FRA, F4RC:$FRC), F4RC:$FRB))]</cite>
includes both <strong>fmul</strong> and <strong>fadd</strong> nodes.</p>
<p>Now, consider the following <strong>basic block notation IR</strong> and <strong>LLVM SSA IR</strong> code:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>d = a * c
e = d + b
...
</pre></div>
</div>
<div class="highlight-llvm notranslate"><div class="highlight"><pre><span></span><span class="nv">%d</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">fmul</span><span class="w"> </span><span class="nv">%a</span><span class="p">,</span><span class="w"> </span><span class="nv">%c</span><span class="w"></span>
<span class="nv">%e</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">fadd</span><span class="w"> </span><span class="nv">%d</span><span class="p">,</span><span class="w"> </span><span class="nv">%b</span><span class="w"></span>
<span class="p">...</span><span class="w"></span>
</pre></div>
</div>
<p>The <strong>Instruction Selection Process</strong> will translate these two IR DAG nodes:</p>
<blockquote>
<div><p><cite>(fmul %a, %c)</cite>
<cite>(fadd %d, %b)</cite></p>
</div></blockquote>
<p>into a <strong>single</strong> machine instruction DAG node:</p>
<blockquote>
<div><p><cite>(**fmadd** %a, %c, %b)</cite></p>
</div></blockquote>
<p>instead of translating them into <strong>two separate</strong> machine instruction nodes
(<cite>**fmul**</cite> and <cite>**fadd**</cite>).</p>
<p>This optimization occurs <strong>only if</strong> <cite>FMADDS</cite> appears <strong>before</strong> <cite>FMUL</cite> and
<cite>FADD</cite> in your <cite>.td</cite> file.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">%</span><span class="nv">e</span> <span class="o">=</span> fmadd %a, %c, %b
<span class="go">...</span>
</pre></div>
</div>
<p>As you can see, the <strong>IR notation representation</strong> is easier to read than
the <strong>LLVM SSA IR</strong> form.</p>
<p>For this reason, this notation is occasionally used in this book.</p>
<p>Now, consider the following <strong>basic block code</strong>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">a = b + c   // in notation IR form</span>
<span class="go">d = a – d</span>
<span class="gp">%</span><span class="nv">e</span> <span class="o">=</span> fmadd %a, %c, %b // <span class="k">in</span> llvm SSA IR form
</pre></div>
</div>
<p>We can apply <a class="reference internal" href="#llvmstructure-f8"><span class="std std-numref">Fig. 8</span></a> <strong>Instruction Tree Patterns</strong>
to generate the following <strong>machine code</strong>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">load  rb, M(sp+8); // assume b allocate in sp+8, sp is stack point register</span>
<span class="go">load  rc, M(sp+16);</span>
<span class="go">add ra, rb, rc;</span>
<span class="go">load  rd, M(sp+24);</span>
<span class="go">sub rd, ra, rd;</span>
<span class="go">fmadd re, ra, rc, rb;</span>
</pre></div>
</div>
</section>
<section id="caller-and-callee-saved-registers">
<h3><a class="toc-backref" href="#id98" role="doc-backlink">Caller and Callee Saved Registers</a><a class="headerlink" href="#caller-and-callee-saved-registers" title="Permalink to this heading">¶</a></h3>
<p class="rubric">lbdex/input/ch9_caller_callee_save_registers.cpp</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">extern</span> <span class="nb">int</span> <span class="n">add1</span><span class="p">(</span><span class="nb">int</span> <span class="n">x</span><span class="p">);</span>

<span class="nb">int</span> <span class="n">callee</span><span class="p">()</span>
<span class="p">{</span> 
  <span class="nb">int</span> <span class="n">t1</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
  <span class="nb">int</span> <span class="n">result</span> <span class="o">=</span> <span class="n">add1</span><span class="p">(</span><span class="n">t1</span><span class="p">);</span>  
  <span class="n">result</span> <span class="o">=</span> <span class="n">result</span> <span class="o">-</span> <span class="n">t1</span><span class="p">;</span>
  
  <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Running the <strong>MIPS backend</strong> with the above input will produce the following
result:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">JonathantekiiMac:input Jonathan$ </span>~/llvm/debug/build/bin/llc
<span class="go">-O0 -march=mips -relocation-model=static -filetype=asm</span>
<span class="go">ch9_caller_callee_save_registers.bc -o -</span>
<span class="go">      .text</span>
<span class="go">      .abicalls</span>
<span class="go">      .option pic0</span>
<span class="go">      .section        .mdebug.abi32,&quot;&quot;,@progbits</span>
<span class="go">      .nan    legacy</span>
<span class="go">      .file   &quot;ch9_caller_callee_save_registers.bc&quot;</span>
<span class="go">      .text</span>
<span class="go">      .globl  _Z6calleev</span>
<span class="go">      .align  2</span>
<span class="go">      .type   _Z6calleev,@function</span>
<span class="go">      .set    nomicromips</span>
<span class="go">      .set    nomips16</span>
<span class="go">      .ent    _Z6calleev</span>
<span class="go">_Z6callerv:                             # @_Z6callerv</span>
<span class="go">      .cfi_startproc</span>
<span class="go">      .frame  $fp,32,$ra</span>
<span class="go">      .mask   0xc0000000,-4</span>
<span class="go">      .fmask  0x00000000,0</span>
<span class="go">      .set    noreorder</span>
<span class="go">      .set    nomacro</span>
<span class="go">      .set    noat</span>
<span class="gp"># </span>BB#0:
<span class="go">      addiu   $sp, $sp, -32</span>
<span class="gp">$</span>tmp0:
<span class="go">      .cfi_def_cfa_offset 32</span>
<span class="go">      sw      $ra, 28($sp)            # 4-byte Folded Spill</span>
<span class="go">      sw      $fp, 24($sp)            # 4-byte Folded Spill</span>
<span class="gp">$</span>tmp1:
<span class="go">      .cfi_offset 31, -4</span>
<span class="gp">$</span>tmp2:
<span class="go">      .cfi_offset 30, -8</span>
<span class="go">      move     $fp, $sp</span>
<span class="gp">$</span>tmp3:
<span class="go">      .cfi_def_cfa_register 30</span>
<span class="go">      addiu   $1, $zero, 3</span>
<span class="go">      sw      $1, 20($fp)   # store t1 to 20($fp)</span>
<span class="go">      move     $4, $1</span>
<span class="go">      jal     _Z4add1i</span>
<span class="go">      nop</span>
<span class="go">      sw      $2, 16($fp)   # $2 : the return vaule for fuction add1()</span>
<span class="go">      lw      $1, 20($fp)   # load t1 from 20($fp)</span>
<span class="go">      subu    $1, $2, $1</span>
<span class="go">      sw      $1, 16($fp)</span>
<span class="go">      move     $2, $1     # move result to return register $2</span>
<span class="go">      move     $sp, $fp</span>
<span class="go">      lw      $fp, 24($sp)            # 4-byte Folded Reload</span>
<span class="go">      lw      $ra, 28($sp)            # 4-byte Folded Reload</span>
<span class="go">      addiu   $sp, $sp, 32</span>
<span class="go">      jr      $ra</span>
<span class="go">      nop</span>
<span class="go">      .set    at</span>
<span class="go">      .set    macro</span>
<span class="go">      .set    reorder</span>
<span class="go">      .end    _Z6calleev</span>
<span class="gp">$</span>func_end0:
<span class="go">      .size   _Z6calleev, ($func_end0)-_Z6calleev</span>
<span class="go">      .cfi_endproc</span>
</pre></div>
</div>
<p>Caller and callee saved registers definition as follows,</p>
<ul class="simple">
<li><p>If the <strong>caller</strong> wants to use <strong>caller-saved registers</strong> after calling a
function, it must save their contents to memory before the function call
and restore them afterward.</p></li>
<li><p>If the <strong>callee</strong> wants to use <strong>callee-saved registers</strong>, it must save
their contents to memory before using them and restore them before returning.</p></li>
</ul>
<p>According to the definition above, if a register is <strong>not</strong> callee-saved,
then it must be <strong>caller-saved</strong>, since the callee does not restore it and
its value may change after the function call.</p>
<p>Thus, <strong>MIPS</strong> only defines <strong>callee-saved registers</strong> in <cite>MipsCallingConv.td</cite>,
which can be found in <cite>CSR_O32_SaveList</cite> of <cite>MipsGenRegisterInfo.inc</cite> for the
default ABI.</p>
<p>From the assembly output, MIPS allocates the <strong>t1</strong> variable to register <cite>$1</cite>,
which does <strong>not</strong> need to be spilled because <cite>$1</cite> is a <strong>caller-saved register</strong>.</p>
<p>On the other hand, <cite>$ra</cite> is a <strong>callee-saved register</strong>, so it is spilled at
the beginning of the assembly output, as <cite>jal</cite> uses the <cite>$ra</cite> register.</p>
<p>For <strong>Cpu0</strong>, the <cite>$lr</cite> register corresponds to MIPS <cite>$ra</cite>.
Thus, the function <cite>setAliasRegs(MF, SavedRegs, Cpu0::LR)</cite> is called in
<cite>determineCalleeSaves()</cite> within <cite>Cpu0SEFrameLowering.cpp</cite> when a function
calls another function.</p>
</section>
<section id="live-in-and-live-out-registers">
<h3><a class="toc-backref" href="#id99" role="doc-backlink">Live-In and Live-Out Registers</a><a class="headerlink" href="#live-in-and-live-out-registers" title="Permalink to this heading">¶</a></h3>
<p>As seen in the previous subsection, <cite>$ra</cite> is a <strong>live-in</strong> register because
the return address is determined by the caller.</p>
<p>Similarly, <cite>$2</cite> is a <strong>live-out</strong> register since the function’s return value
is stored in this register. The caller retrieves the result by reading <cite>$2</cite>
directly, as noted in the previous example.</p>
<p>By marking <strong>live-in</strong> and <strong>live-out</strong> registers, the backend provides
LLVM’s <strong>middle layer</strong> with information to eliminate redundant variable
access instructions.</p>
<p>LLVM applies <strong>DAG analysis</strong>, as discussed in the previous subsection,
to perform this optimization.</p>
<p>Since <strong>C supports separate compilation</strong>, the <strong>live-in</strong> and <strong>live-out</strong>
information from the backend offers additional optimization opportunities
to LLVM.</p>
<p>LLVM provides the function <cite>addLiveIn()</cite> to mark a <strong>live-in register</strong>,
but it does <strong>not</strong> offer a corresponding <cite>addLiveOut()</cite> function.</p>
<p>Instead, the <strong>MIPS backend</strong> marks <strong>live-out</strong> registers by using:</p>
<blockquote>
<div><p><cite>DAG = DAG.getCopyToReg(…, $2, …)</cite></p>
</div></blockquote>
<p>and then returning the modified <strong>DAG</strong>, as all local variables cease to exist
after the function exits.</p>
</section>
</section>
<section id="create-cpu0-backend">
<h2><a class="toc-backref" href="#id100" role="doc-backlink">Create Cpu0 Backend</a><a class="headerlink" href="#create-cpu0-backend" title="Permalink to this heading">¶</a></h2>
<p>From this point onward, the <strong>Cpu0 backend</strong> will be created <strong>step by step
from scratch</strong>.</p>
<p>To help readers understand the <strong>backend structure</strong>, the Cpu0 example code
can be generated <strong>chapter by chapter</strong> using the command provided here
<a class="footnote-reference brackets" href="#chapters-ex" id="id39" role="doc-noteref"><span class="fn-bracket">[</span>11<span class="fn-bracket">]</span></a>.</p>
<p>The <strong>Cpu0 example code (`lbdex`)</strong> can be found near the bottom left of
this website or downloaded from:</p>
<blockquote>
<div><p><cite>http://jonathan2251.github.io/lbd/lbdex.tar.gz</cite></p>
</div></blockquote>
<section id="cpu0-backend-machine-id-and-relocation-records">
<h3><a class="toc-backref" href="#id101" role="doc-backlink">Cpu0 Backend Machine ID and Relocation Records</a><a class="headerlink" href="#cpu0-backend-machine-id-and-relocation-records" title="Permalink to this heading">¶</a></h3>
<p>To create a <strong>new backend</strong>, several files in <cite>&lt;&lt;llvm root dir&gt;&gt;</cite> must be
modified.</p>
<p>The required modifications include adding both the <strong>machine ID and name</strong>,
as well as defining <strong>relocation records</strong>.</p>
<p>The <strong>ELF Support</strong> chapter provides an introduction to <strong>relocation records</strong>.</p>
<p>The following files are modified to <strong>add the Cpu0 backend</strong>:</p>
<p class="rubric">lbdex/llvm/modify/llvm/config-ix.cmake</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>...
elseif (LLVM_NATIVE_ARCH MATCHES &quot;cpu0&quot;)
  set(LLVM_NATIVE_ARCH Cpu0)
...
</pre></div>
</div>
<p class="rubric">lbdex/llvm/modify/llvm/CMakeLists.txt</p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="nb">set</span><span class="p">(</span><span class="s">LLVM_ALL_TARGETS</span>
<span class="w">  </span><span class="s">...</span>
<span class="w">  </span><span class="s">Cpu0</span>
<span class="w">  </span><span class="s">...</span>
<span class="w">  </span><span class="p">)</span>
</pre></div>
</div>
<p class="rubric">lbdex/llvm/modify/llvm/include/llvm/ADT/Triple.h</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="p">...</span><span class="w"></span>
<span class="cp">#undef mips</span>
<span class="cp">#undef cpu0</span>
<span class="p">...</span><span class="w"></span>
<span class="k">class</span><span class="w"> </span><span class="nc">Triple</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="k">public</span><span class="o">:</span><span class="w"></span>
<span class="w">  </span><span class="k">enum</span><span class="w"> </span><span class="nc">ArchType</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="p">...</span><span class="w"></span>
<span class="w">    </span><span class="n">cpu0</span><span class="p">,</span><span class="w">       </span><span class="c1">// For Tutorial Backend Cpu0</span>
<span class="w">    </span><span class="n">cpu0el</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="p">...</span><span class="w"></span>
<span class="w">  </span><span class="p">};</span><span class="w"></span>
<span class="w">  </span><span class="p">...</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p class="rubric">lbdex/llvm/modify/llvm/include/llvm/Object/ELFObjectFile.h</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="p">...</span><span class="w"></span>
<span class="k">template</span><span class="w"> </span><span class="o">&lt;</span><span class="k">class</span><span class="w"> </span><span class="nc">ELFT</span><span class="o">&gt;</span><span class="w"></span>
<span class="n">StringRef</span><span class="w"> </span><span class="n">ELFObjectFile</span><span class="o">&lt;</span><span class="n">ELFT</span><span class="o">&gt;::</span><span class="n">getFileFormatName</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">EF</span><span class="p">.</span><span class="n">getHeader</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">e_ident</span><span class="p">[</span><span class="n">ELF</span><span class="o">::</span><span class="n">EI_CLASS</span><span class="p">])</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">case</span><span class="w"> </span><span class="no">ELF</span><span class="o">::</span><span class="no">ELFCLASS32</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">EF</span><span class="p">.</span><span class="n">getHeader</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">e_machine</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="p">...</span><span class="w"></span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="no">ELF</span><span class="o">::</span><span class="no">EM_CPU0</span><span class="p">:</span><span class="w">        </span><span class="c1">// llvm-objdump -t -r</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="s">&quot;ELF32-cpu0&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">...</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">...</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="p">...</span><span class="w"></span>
<span class="k">template</span><span class="w"> </span><span class="o">&lt;</span><span class="k">class</span><span class="w"> </span><span class="nc">ELFT</span><span class="o">&gt;</span><span class="w"></span>
<span class="kt">unsigned</span><span class="w"> </span><span class="n">ELFObjectFile</span><span class="o">&lt;</span><span class="n">ELFT</span><span class="o">&gt;::</span><span class="n">getArch</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kt">bool</span><span class="w"> </span><span class="n">IsLittleEndian</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ELFT</span><span class="o">::</span><span class="n">TargetEndianness</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">support</span><span class="o">::</span><span class="n">little</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">EF</span><span class="p">.</span><span class="n">getHeader</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">e_machine</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="p">...</span><span class="w"></span>
<span class="w">  </span><span class="k">case</span><span class="w"> </span><span class="no">ELF</span><span class="o">::</span><span class="no">EM_CPU0</span><span class="p">:</span><span class="w">  </span><span class="c1">// llvm-objdump -t -r</span>
<span class="w">    </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">EF</span><span class="p">.</span><span class="n">getHeader</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">e_ident</span><span class="p">[</span><span class="n">ELF</span><span class="o">::</span><span class="n">EI_CLASS</span><span class="p">])</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="no">ELF</span><span class="o">::</span><span class="no">ELFCLASS32</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">IsLittleEndian</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">Triple</span><span class="o">::</span><span class="n">cpu0el</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">Triple</span><span class="o">::</span><span class="n">cpu0</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">default</span><span class="o">:</span><span class="w"></span>
<span class="w">      </span><span class="n">report_fatal_error</span><span class="p">(</span><span class="s">&quot;Invalid ELFCLASS!&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">...</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p class="rubric">lbdex/llvm/modify/llvm/include/llvm/Support/ELF.h</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">enum</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="p">...</span><span class="w"></span>
<span class="w">  </span><span class="n">EM_CPU0</span><span class="w">          </span><span class="o">=</span><span class="w"> </span><span class="mi">999</span><span class="w">  </span><span class="c1">// Document LLVM Backend Tutorial Cpu0</span>
<span class="p">};</span><span class="w"></span>
<span class="p">...</span><span class="w"></span>
<span class="c1">// Cpu0 Specific e_flags</span>
<span class="k">enum</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">EF_CPU0_NOREORDER</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x00000001</span><span class="p">,</span><span class="w"> </span><span class="c1">// Don&#39;t reorder instructions</span>
<span class="w">  </span><span class="n">EF_CPU0_PIC</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="mh">0x00000002</span><span class="p">,</span><span class="w"> </span><span class="c1">// Position independent code</span>
<span class="w">  </span><span class="n">EF_CPU0_ARCH_32</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="mh">0x50000000</span><span class="p">,</span><span class="w"> </span><span class="c1">// CPU032 instruction set per linux not elf.h</span>
<span class="w">  </span><span class="n">EF_CPU0_ARCH</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="mh">0xf0000000</span><span class="w">  </span><span class="c1">// Mask for applying EF_CPU0_ARCH_ variant</span>
<span class="p">};</span><span class="w"></span>

<span class="c1">// ELF Relocation types for Mips</span>
<span class="k">enum</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;ELFRelocs/Cpu0.def&quot;</span><span class="cp"></span>
<span class="p">};</span><span class="w"></span>
<span class="p">...</span><span class="w"></span>
</pre></div>
</div>
<p class="rubric">lbdex/llvm/modify/llvm/lib/MC/MCSubtargetInfo.cpp</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="kt">bool</span><span class="w"> </span><span class="n">Cpu0DisableUnreconginizedMessage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>

<span class="kt">void</span><span class="w"> </span><span class="nf">MCSubtargetInfo::InitMCProcessorInfo</span><span class="p">(</span><span class="n">StringRef</span><span class="w"> </span><span class="n">CPU</span><span class="p">,</span><span class="w"> </span><span class="n">StringRef</span><span class="w"> </span><span class="n">FS</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="cp">#if 1 </span><span class="c1">// Disable reconginized processor message. For Cpu0</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">TargetTriple</span><span class="p">.</span><span class="n">getArch</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">llvm</span><span class="o">::</span><span class="n">Triple</span><span class="o">::</span><span class="n">cpu0</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">      </span><span class="n">TargetTriple</span><span class="p">.</span><span class="n">getArch</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">llvm</span><span class="o">::</span><span class="n">Triple</span><span class="o">::</span><span class="n">cpu0el</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">Cpu0DisableUnreconginizedMessage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="cp">#endif</span>
<span class="w">  </span><span class="p">...</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="p">...</span><span class="w"></span>
<span class="k">const</span><span class="w"> </span><span class="n">MCSchedModel</span><span class="w"> </span><span class="o">&amp;</span><span class="n">MCSubtargetInfo</span><span class="o">::</span><span class="n">getSchedModelForCPU</span><span class="p">(</span><span class="n">StringRef</span><span class="w"> </span><span class="n">CPU</span><span class="p">)</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="p">...</span><span class="w"></span>
<span class="w">    </span><span class="cp">#if 1 </span><span class="c1">// Disable reconginized processor message. For Cpu0</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">TargetTriple</span><span class="p">.</span><span class="n">getArch</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">llvm</span><span class="o">::</span><span class="n">Triple</span><span class="o">::</span><span class="n">cpu0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">        </span><span class="n">TargetTriple</span><span class="p">.</span><span class="n">getArch</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">llvm</span><span class="o">::</span><span class="n">Triple</span><span class="o">::</span><span class="n">cpu0el</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="cp">#endif</span>
<span class="w">  </span><span class="p">...</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p class="rubric">lbdex/llvm/modify/llvm/lib/MC/SubtargetFeature.cpp</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">extern</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">Cpu0DisableUnreconginizedMessage</span><span class="p">;</span><span class="w"> </span><span class="c1">// For Cpu0</span>
<span class="p">...</span><span class="w"></span>
<span class="n">FeatureBitset</span><span class="w"></span>
<span class="n">SubtargetFeatures</span><span class="o">::</span><span class="n">ToggleFeature</span><span class="p">(</span><span class="n">FeatureBitset</span><span class="w"> </span><span class="n">Bits</span><span class="p">,</span><span class="w"> </span><span class="n">StringRef</span><span class="w"> </span><span class="n">Feature</span><span class="p">,</span><span class="w"></span>
<span class="w">                                 </span><span class="n">ArrayRef</span><span class="o">&lt;</span><span class="n">SubtargetFeatureKV</span><span class="o">&gt;</span><span class="w"> </span><span class="n">FeatureTable</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="p">...</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">Cpu0DisableUnreconginizedMessage</span><span class="p">)</span><span class="w"> </span><span class="c1">// For Cpu0</span>
<span class="w">  </span><span class="p">...</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="n">FeatureBitset</span><span class="w"></span>
<span class="n">SubtargetFeatures</span><span class="o">::</span><span class="n">ApplyFeatureFlag</span><span class="p">(</span><span class="n">FeatureBitset</span><span class="w"> </span><span class="n">Bits</span><span class="p">,</span><span class="w"> </span><span class="n">StringRef</span><span class="w"> </span><span class="n">Feature</span><span class="p">,</span><span class="w"></span>
<span class="w">                                    </span><span class="n">ArrayRef</span><span class="o">&lt;</span><span class="n">SubtargetFeatureKV</span><span class="o">&gt;</span><span class="w"> </span><span class="n">FeatureTable</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="p">...</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">Cpu0DisableUnreconginizedMessage</span><span class="p">)</span><span class="w"> </span><span class="c1">// For Cpu0</span>
<span class="w">  </span><span class="p">...</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="n">FeatureBitset</span><span class="w"></span>
<span class="n">SubtargetFeatures</span><span class="o">::</span><span class="n">getFeatureBits</span><span class="p">(</span><span class="n">StringRef</span><span class="w"> </span><span class="n">CPU</span><span class="p">,</span><span class="w"></span>
<span class="w">                                  </span><span class="n">ArrayRef</span><span class="o">&lt;</span><span class="n">SubtargetFeatureKV</span><span class="o">&gt;</span><span class="w"> </span><span class="n">CPUTable</span><span class="p">,</span><span class="w"></span>
<span class="w">                                  </span><span class="n">ArrayRef</span><span class="o">&lt;</span><span class="n">SubtargetFeatureKV</span><span class="o">&gt;</span><span class="w"> </span><span class="n">FeatureTable</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="p">...</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">Cpu0DisableUnreconginizedMessage</span><span class="p">)</span><span class="w"> </span><span class="c1">// For Cpu0</span>
<span class="w">  </span><span class="p">...</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p class="rubric">lib/object/ELF.cpp</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="p">...</span><span class="w"></span>

<span class="n">StringRef</span><span class="w"> </span><span class="n">getELFRelocationTypeName</span><span class="p">(</span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">Machine</span><span class="p">,</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">Type</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">Machine</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="p">...</span><span class="w"></span>
<span class="w">  </span><span class="k">case</span><span class="w"> </span><span class="no">ELF</span><span class="o">::</span><span class="no">EM_CPU0</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">Type</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;llvm/Support/ELFRelocs/Cpu0.def&quot;</span><span class="cp"></span>
<span class="w">    </span><span class="k">default</span><span class="o">:</span><span class="w"></span>
<span class="w">      </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">...</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p class="rubric">include/llvm/Support/ELFRelocs/Cpu0.def</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>
<span class="c1">#ifndef ELF_RELOC</span>
<span class="c1">#error &quot;ELF_RELOC must be defined&quot;</span>
<span class="c1">#endif</span>

<span class="n">ELF_RELOC</span><span class="p">(</span><span class="n">R_CPU0_NONE</span><span class="p">,</span>                <span class="mi">0</span><span class="p">)</span>
<span class="n">ELF_RELOC</span><span class="p">(</span><span class="n">R_CPU0_32</span><span class="p">,</span>                  <span class="mi">2</span><span class="p">)</span>
<span class="n">ELF_RELOC</span><span class="p">(</span><span class="n">R_CPU0_HI16</span><span class="p">,</span>                <span class="mi">5</span><span class="p">)</span>
<span class="n">ELF_RELOC</span><span class="p">(</span><span class="n">R_CPU0_LO16</span><span class="p">,</span>                <span class="mi">6</span><span class="p">)</span>
<span class="n">ELF_RELOC</span><span class="p">(</span><span class="n">R_CPU0_GPREL16</span><span class="p">,</span>             <span class="mi">7</span><span class="p">)</span>
<span class="n">ELF_RELOC</span><span class="p">(</span><span class="n">R_CPU0_LITERAL</span><span class="p">,</span>             <span class="mi">8</span><span class="p">)</span>
<span class="n">ELF_RELOC</span><span class="p">(</span><span class="n">R_CPU0_GOT16</span><span class="p">,</span>               <span class="mi">9</span><span class="p">)</span>
<span class="n">ELF_RELOC</span><span class="p">(</span><span class="n">R_CPU0_PC16</span><span class="p">,</span>               <span class="mi">10</span><span class="p">)</span>
<span class="n">ELF_RELOC</span><span class="p">(</span><span class="n">R_CPU0_CALL16</span><span class="p">,</span>             <span class="mi">11</span><span class="p">)</span>
<span class="n">ELF_RELOC</span><span class="p">(</span><span class="n">R_CPU0_GPREL32</span><span class="p">,</span>            <span class="mi">12</span><span class="p">)</span>
<span class="n">ELF_RELOC</span><span class="p">(</span><span class="n">R_CPU0_PC24</span><span class="p">,</span>               <span class="mi">13</span><span class="p">)</span>
<span class="n">ELF_RELOC</span><span class="p">(</span><span class="n">R_CPU0_GOT_HI16</span><span class="p">,</span>           <span class="mi">22</span><span class="p">)</span>
<span class="n">ELF_RELOC</span><span class="p">(</span><span class="n">R_CPU0_GOT_LO16</span><span class="p">,</span>           <span class="mi">23</span><span class="p">)</span>
<span class="n">ELF_RELOC</span><span class="p">(</span><span class="n">R_CPU0_RELGOT</span><span class="p">,</span>             <span class="mi">36</span><span class="p">)</span>
<span class="n">ELF_RELOC</span><span class="p">(</span><span class="n">R_CPU0_TLS_GD</span><span class="p">,</span>             <span class="mi">42</span><span class="p">)</span>
<span class="n">ELF_RELOC</span><span class="p">(</span><span class="n">R_CPU0_TLS_LDM</span><span class="p">,</span>            <span class="mi">43</span><span class="p">)</span>
<span class="n">ELF_RELOC</span><span class="p">(</span><span class="n">R_CPU0_TLS_DTP_HI16</span><span class="p">,</span>       <span class="mi">44</span><span class="p">)</span>
<span class="n">ELF_RELOC</span><span class="p">(</span><span class="n">R_CPU0_TLS_DTP_LO16</span><span class="p">,</span>       <span class="mi">45</span><span class="p">)</span>
<span class="n">ELF_RELOC</span><span class="p">(</span><span class="n">R_CPU0_TLS_GOTTPREL</span><span class="p">,</span>       <span class="mi">46</span><span class="p">)</span>
<span class="n">ELF_RELOC</span><span class="p">(</span><span class="n">R_CPU0_TLS_TPREL32</span><span class="p">,</span>        <span class="mi">47</span><span class="p">)</span>
<span class="n">ELF_RELOC</span><span class="p">(</span><span class="n">R_CPU0_TLS_TP_HI16</span><span class="p">,</span>        <span class="mi">49</span><span class="p">)</span>
<span class="n">ELF_RELOC</span><span class="p">(</span><span class="n">R_CPU0_TLS_TP_LO16</span><span class="p">,</span>        <span class="mi">50</span><span class="p">)</span>
<span class="n">ELF_RELOC</span><span class="p">(</span><span class="n">R_CPU0_GLOB_DAT</span><span class="p">,</span>           <span class="mi">51</span><span class="p">)</span>
<span class="n">ELF_RELOC</span><span class="p">(</span><span class="n">R_CPU0_JUMP_SLOT</span><span class="p">,</span>          <span class="mi">127</span><span class="p">)</span>
</pre></div>
</div>
<p class="rubric">lbdex/llvm/modify/llvm/lib/Support/Triple.cpp</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="nf">Triple::getArchTypeName</span><span class="p">(</span><span class="n">ArchType</span><span class="w"> </span><span class="n">Kind</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">Kind</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="p">...</span><span class="w"></span>
<span class="w">  </span><span class="k">case</span><span class="w"> </span><span class="no">cpu0</span><span class="p">:</span><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="s">&quot;cpu0&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="k">case</span><span class="w"> </span><span class="no">cpu0el</span><span class="p">:</span><span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="s">&quot;cpu0el&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">...</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="p">...</span><span class="w"></span>
<span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">Triple</span><span class="o">::</span><span class="n">getArchTypePrefix</span><span class="p">(</span><span class="n">ArchType</span><span class="w"> </span><span class="n">Kind</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">Kind</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="p">...</span><span class="w"></span>
<span class="w">  </span><span class="k">case</span><span class="w"> </span><span class="no">cpu0</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="k">case</span><span class="w"> </span><span class="no">cpu0el</span><span class="p">:</span><span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="s">&quot;cpu0&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">...</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="p">...</span><span class="w"></span>
<span class="n">Triple</span><span class="o">::</span><span class="n">ArchType</span><span class="w"> </span><span class="n">Triple</span><span class="o">::</span><span class="n">getArchTypeForLLVMName</span><span class="p">(</span><span class="n">StringRef</span><span class="w"> </span><span class="n">Name</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">StringSwitch</span><span class="o">&lt;</span><span class="n">Triple</span><span class="o">::</span><span class="n">ArchType</span><span class="o">&gt;</span><span class="p">(</span><span class="n">Name</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">...</span><span class="w"></span>
<span class="w">    </span><span class="p">.</span><span class="n">Case</span><span class="p">(</span><span class="s">&quot;cpu0&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">cpu0</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">.</span><span class="n">Case</span><span class="p">(</span><span class="s">&quot;cpu0el&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">cpu0el</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">...</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="p">...</span><span class="w"></span>
<span class="k">static</span><span class="w"> </span><span class="n">Triple</span><span class="o">::</span><span class="n">ArchType</span><span class="w"> </span><span class="n">parseArch</span><span class="p">(</span><span class="n">StringRef</span><span class="w"> </span><span class="n">ArchName</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">StringSwitch</span><span class="o">&lt;</span><span class="n">Triple</span><span class="o">::</span><span class="n">ArchType</span><span class="o">&gt;</span><span class="p">(</span><span class="n">ArchName</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">...</span><span class="w"></span>
<span class="w">    </span><span class="p">.</span><span class="n">Cases</span><span class="p">(</span><span class="s">&quot;cpu0&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;cpu0eb&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;cpu0allegrex&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">Triple</span><span class="o">::</span><span class="n">cpu0</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">.</span><span class="n">Cases</span><span class="p">(</span><span class="s">&quot;cpu0el&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;cpu0allegrexel&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">Triple</span><span class="o">::</span><span class="n">cpu0el</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">...</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="p">...</span><span class="w"></span>
<span class="k">static</span><span class="w"> </span><span class="n">Triple</span><span class="o">::</span><span class="n">ObjectFormatType</span><span class="w"> </span><span class="n">getDefaultFormat</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">Triple</span><span class="w"> </span><span class="o">&amp;</span><span class="n">T</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="p">...</span><span class="w"></span>
<span class="w">  </span><span class="k">case</span><span class="w"> </span><span class="no">Triple</span><span class="o">::</span><span class="no">cpu0</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="k">case</span><span class="w"> </span><span class="no">Triple</span><span class="o">::</span><span class="no">cpu0el</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="p">...</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="p">...</span><span class="w"></span>
<span class="k">static</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="n">getArchPointerBitWidth</span><span class="p">(</span><span class="n">llvm</span><span class="o">::</span><span class="n">Triple</span><span class="o">::</span><span class="n">ArchType</span><span class="w"> </span><span class="n">Arch</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">Arch</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="p">...</span><span class="w"></span>
<span class="w">  </span><span class="k">case</span><span class="w"> </span><span class="no">llvm</span><span class="o">::</span><span class="no">Triple</span><span class="o">::</span><span class="no">cpu0</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="k">case</span><span class="w"> </span><span class="no">llvm</span><span class="o">::</span><span class="no">Triple</span><span class="o">::</span><span class="no">cpu0el</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="p">...</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">32</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="p">...</span><span class="w"></span>
<span class="n">Triple</span><span class="w"> </span><span class="n">Triple</span><span class="o">::</span><span class="n">get32BitArchVariant</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">Triple</span><span class="w"> </span><span class="nf">T</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">getArch</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="p">...</span><span class="w"></span>
<span class="w">  </span><span class="k">case</span><span class="w"> </span><span class="no">Triple</span><span class="o">::</span><span class="no">cpu0</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="k">case</span><span class="w"> </span><span class="no">Triple</span><span class="o">::</span><span class="no">cpu0el</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="p">...</span><span class="w"></span>
<span class="w">    </span><span class="c1">// Already 32-bit.</span>
<span class="w">    </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">T</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="creating-the-initial-cpu0-td-files">
<h3><a class="toc-backref" href="#id102" role="doc-backlink">Creating the Initial Cpu0 .td Files</a><a class="headerlink" href="#creating-the-initial-cpu0-td-files" title="Permalink to this heading">¶</a></h3>
<p>As discussed in the previous section, <strong>LLVM</strong> uses <strong>target description files</strong>
(<cite>.td</cite> files) to define various components of a target’s backend.</p>
<p>For example, these <cite>.td</cite> files may describe:
- A target’s <strong>register set</strong>
- Its <strong>instruction set</strong>
- <strong>Instruction scheduling</strong> details
- <strong>Calling conventions</strong></p>
<p>When the backend is compiled, <strong>LLVM’s TableGen tool</strong> translates these <cite>.td</cite>
files into <strong>C++ source code</strong>, which is then written to <cite>.inc</cite> files.</p>
<p>For more details on how to use <strong>TableGen</strong>, please refer to <a class="footnote-reference brackets" href="#tblgen" id="id40" role="doc-noteref"><span class="fn-bracket">[</span>32<span class="fn-bracket">]</span></a>.</p>
<p>Each backend has its own <cite>.td</cite> files to define target-specific information.
These files have a <strong>C++-like syntax</strong>.</p>
<p>For <strong>Cpu0</strong>, the primary target description file is <strong>Cpu0Other.td</strong>,
as shown below:</p>
<p class="rubric">lbdex/chapters/Chapter2/Cpu0.td</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//===--</span> <span class="n">Cpu0</span><span class="o">.</span><span class="n">td</span> <span class="o">-</span> <span class="n">Describe</span> <span class="n">the</span> <span class="n">Cpu0</span> <span class="n">Target</span> <span class="n">Machine</span> <span class="o">---------*-</span> <span class="n">tablegen</span> <span class="o">-*-===//</span>
<span class="o">//</span>
<span class="o">//</span>                     <span class="n">The</span> <span class="n">LLVM</span> <span class="n">Compiler</span> <span class="n">Infrastructure</span>
<span class="o">//</span>
<span class="o">//</span> <span class="n">This</span> <span class="n">file</span> <span class="ow">is</span> <span class="n">distributed</span> <span class="n">under</span> <span class="n">the</span> <span class="n">University</span> <span class="n">of</span> <span class="n">Illinois</span> <span class="n">Open</span> <span class="n">Source</span>
<span class="o">//</span> <span class="n">License</span><span class="o">.</span> <span class="n">See</span> <span class="n">LICENSE</span><span class="o">.</span><span class="n">TXT</span> <span class="k">for</span> <span class="n">details</span><span class="o">.</span>
<span class="o">//</span>
<span class="o">//===----------------------------------------------------------------------===//</span>

<span class="o">//</span> <span class="n">Without</span> <span class="n">this</span> <span class="n">will</span> <span class="n">have</span> <span class="n">error</span><span class="p">:</span> <span class="s1">&#39;cpu032I&#39;</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">a</span> <span class="n">recognized</span> <span class="n">processor</span> <span class="k">for</span> 
<span class="o">//</span>  <span class="n">this</span> <span class="n">target</span> <span class="p">(</span><span class="n">ignoring</span> <span class="n">processor</span><span class="p">)</span>
<span class="o">//===----------------------------------------------------------------------===//</span>
<span class="o">//</span> <span class="n">Cpu0</span> <span class="n">Subtarget</span> <span class="n">features</span>                                                    <span class="o">//</span>
<span class="o">//===----------------------------------------------------------------------===//</span>

<span class="k">def</span> <span class="nf">FeatureChapter3_1</span>  <span class="p">:</span> <span class="n">SubtargetFeature</span><span class="o">&lt;</span><span class="s2">&quot;ch3_1&quot;</span><span class="p">,</span> <span class="s2">&quot;HasChapterDummy&quot;</span><span class="p">,</span> <span class="s2">&quot;true&quot;</span><span class="p">,</span>
                                <span class="s2">&quot;Enable Chapter instructions.&quot;</span><span class="o">&gt;</span><span class="p">;</span>
<span class="k">def</span> <span class="nf">FeatureChapter3_2</span>  <span class="p">:</span> <span class="n">SubtargetFeature</span><span class="o">&lt;</span><span class="s2">&quot;ch3_2&quot;</span><span class="p">,</span> <span class="s2">&quot;HasChapterDummy&quot;</span><span class="p">,</span> <span class="s2">&quot;true&quot;</span><span class="p">,</span>
                                <span class="s2">&quot;Enable Chapter instructions.&quot;</span><span class="o">&gt;</span><span class="p">;</span>
<span class="k">def</span> <span class="nf">FeatureChapter3_3</span>  <span class="p">:</span> <span class="n">SubtargetFeature</span><span class="o">&lt;</span><span class="s2">&quot;ch3_3&quot;</span><span class="p">,</span> <span class="s2">&quot;HasChapterDummy&quot;</span><span class="p">,</span> <span class="s2">&quot;true&quot;</span><span class="p">,</span>
                                <span class="s2">&quot;Enable Chapter instructions.&quot;</span><span class="o">&gt;</span><span class="p">;</span>
<span class="k">def</span> <span class="nf">FeatureChapter3_4</span>  <span class="p">:</span> <span class="n">SubtargetFeature</span><span class="o">&lt;</span><span class="s2">&quot;ch3_4&quot;</span><span class="p">,</span> <span class="s2">&quot;HasChapterDummy&quot;</span><span class="p">,</span> <span class="s2">&quot;true&quot;</span><span class="p">,</span>
                                <span class="s2">&quot;Enable Chapter instructions.&quot;</span><span class="o">&gt;</span><span class="p">;</span>
<span class="k">def</span> <span class="nf">FeatureChapter3_5</span>  <span class="p">:</span> <span class="n">SubtargetFeature</span><span class="o">&lt;</span><span class="s2">&quot;ch3_5&quot;</span><span class="p">,</span> <span class="s2">&quot;HasChapterDummy&quot;</span><span class="p">,</span> <span class="s2">&quot;true&quot;</span><span class="p">,</span>
                                <span class="s2">&quot;Enable Chapter instructions.&quot;</span><span class="o">&gt;</span><span class="p">;</span>
<span class="k">def</span> <span class="nf">FeatureChapter4_1</span>  <span class="p">:</span> <span class="n">SubtargetFeature</span><span class="o">&lt;</span><span class="s2">&quot;ch4_1&quot;</span><span class="p">,</span> <span class="s2">&quot;HasChapterDummy&quot;</span><span class="p">,</span> <span class="s2">&quot;true&quot;</span><span class="p">,</span>
                                <span class="s2">&quot;Enable Chapter instructions.&quot;</span><span class="o">&gt;</span><span class="p">;</span>
<span class="k">def</span> <span class="nf">FeatureChapter4_2</span>  <span class="p">:</span> <span class="n">SubtargetFeature</span><span class="o">&lt;</span><span class="s2">&quot;ch4_2&quot;</span><span class="p">,</span> <span class="s2">&quot;HasChapterDummy&quot;</span><span class="p">,</span> <span class="s2">&quot;true&quot;</span><span class="p">,</span>
                                <span class="s2">&quot;Enable Chapter instructions.&quot;</span><span class="o">&gt;</span><span class="p">;</span>
<span class="k">def</span> <span class="nf">FeatureChapter5_1</span>  <span class="p">:</span> <span class="n">SubtargetFeature</span><span class="o">&lt;</span><span class="s2">&quot;ch5_1&quot;</span><span class="p">,</span> <span class="s2">&quot;HasChapterDummy&quot;</span><span class="p">,</span> <span class="s2">&quot;true&quot;</span><span class="p">,</span>
                                <span class="s2">&quot;Enable Chapter instructions.&quot;</span><span class="o">&gt;</span><span class="p">;</span>
<span class="k">def</span> <span class="nf">FeatureChapter6_1</span>  <span class="p">:</span> <span class="n">SubtargetFeature</span><span class="o">&lt;</span><span class="s2">&quot;ch6_1&quot;</span><span class="p">,</span> <span class="s2">&quot;HasChapterDummy&quot;</span><span class="p">,</span> <span class="s2">&quot;true&quot;</span><span class="p">,</span>
                                <span class="s2">&quot;Enable Chapter instructions.&quot;</span><span class="o">&gt;</span><span class="p">;</span>
<span class="k">def</span> <span class="nf">FeatureChapter7_1</span>  <span class="p">:</span> <span class="n">SubtargetFeature</span><span class="o">&lt;</span><span class="s2">&quot;ch7_1&quot;</span><span class="p">,</span> <span class="s2">&quot;HasChapterDummy&quot;</span><span class="p">,</span> <span class="s2">&quot;true&quot;</span><span class="p">,</span>
                                <span class="s2">&quot;Enable Chapter instructions.&quot;</span><span class="o">&gt;</span><span class="p">;</span>
<span class="k">def</span> <span class="nf">FeatureChapter8_1</span>  <span class="p">:</span> <span class="n">SubtargetFeature</span><span class="o">&lt;</span><span class="s2">&quot;ch8_1&quot;</span><span class="p">,</span> <span class="s2">&quot;HasChapterDummy&quot;</span><span class="p">,</span> <span class="s2">&quot;true&quot;</span><span class="p">,</span>
                                <span class="s2">&quot;Enable Chapter instructions.&quot;</span><span class="o">&gt;</span><span class="p">;</span>
<span class="k">def</span> <span class="nf">FeatureChapter8_2</span>  <span class="p">:</span> <span class="n">SubtargetFeature</span><span class="o">&lt;</span><span class="s2">&quot;ch8_2&quot;</span><span class="p">,</span> <span class="s2">&quot;HasChapterDummy&quot;</span><span class="p">,</span> <span class="s2">&quot;true&quot;</span><span class="p">,</span>
                                <span class="s2">&quot;Enable Chapter instructions.&quot;</span><span class="o">&gt;</span><span class="p">;</span>
<span class="k">def</span> <span class="nf">FeatureChapter9_1</span>  <span class="p">:</span> <span class="n">SubtargetFeature</span><span class="o">&lt;</span><span class="s2">&quot;ch9_1&quot;</span><span class="p">,</span> <span class="s2">&quot;HasChapterDummy&quot;</span><span class="p">,</span> <span class="s2">&quot;true&quot;</span><span class="p">,</span>
                                <span class="s2">&quot;Enable Chapter instructions.&quot;</span><span class="o">&gt;</span><span class="p">;</span>
<span class="k">def</span> <span class="nf">FeatureChapter9_2</span>  <span class="p">:</span> <span class="n">SubtargetFeature</span><span class="o">&lt;</span><span class="s2">&quot;ch9_2&quot;</span><span class="p">,</span> <span class="s2">&quot;HasChapterDummy&quot;</span><span class="p">,</span> <span class="s2">&quot;true&quot;</span><span class="p">,</span>
                                <span class="s2">&quot;Enable Chapter instructions.&quot;</span><span class="o">&gt;</span><span class="p">;</span>
<span class="k">def</span> <span class="nf">FeatureChapter9_3</span>  <span class="p">:</span> <span class="n">SubtargetFeature</span><span class="o">&lt;</span><span class="s2">&quot;ch9_3&quot;</span><span class="p">,</span> <span class="s2">&quot;HasChapterDummy&quot;</span><span class="p">,</span> <span class="s2">&quot;true&quot;</span><span class="p">,</span>
                                <span class="s2">&quot;Enable Chapter instructions.&quot;</span><span class="o">&gt;</span><span class="p">;</span>
<span class="k">def</span> <span class="nf">FeatureChapter10_1</span> <span class="p">:</span> <span class="n">SubtargetFeature</span><span class="o">&lt;</span><span class="s2">&quot;ch10_1&quot;</span><span class="p">,</span> <span class="s2">&quot;HasChapterDummy&quot;</span><span class="p">,</span> <span class="s2">&quot;true&quot;</span><span class="p">,</span>
                                <span class="s2">&quot;Enable Chapter instructions.&quot;</span><span class="o">&gt;</span><span class="p">;</span>
<span class="k">def</span> <span class="nf">FeatureChapter11_1</span> <span class="p">:</span> <span class="n">SubtargetFeature</span><span class="o">&lt;</span><span class="s2">&quot;ch11_1&quot;</span><span class="p">,</span> <span class="s2">&quot;HasChapterDummy&quot;</span><span class="p">,</span> <span class="s2">&quot;true&quot;</span><span class="p">,</span>
                                <span class="s2">&quot;Enable Chapter instructions.&quot;</span><span class="o">&gt;</span><span class="p">;</span>
<span class="k">def</span> <span class="nf">FeatureChapter11_2</span> <span class="p">:</span> <span class="n">SubtargetFeature</span><span class="o">&lt;</span><span class="s2">&quot;ch11_2&quot;</span><span class="p">,</span> <span class="s2">&quot;HasChapterDummy&quot;</span><span class="p">,</span> <span class="s2">&quot;true&quot;</span><span class="p">,</span>
                                <span class="s2">&quot;Enable Chapter instructions.&quot;</span><span class="o">&gt;</span><span class="p">;</span>
<span class="k">def</span> <span class="nf">FeatureChapter12_1</span> <span class="p">:</span> <span class="n">SubtargetFeature</span><span class="o">&lt;</span><span class="s2">&quot;ch12_1&quot;</span><span class="p">,</span> <span class="s2">&quot;HasChapterDummy&quot;</span><span class="p">,</span> <span class="s2">&quot;true&quot;</span><span class="p">,</span>
                                <span class="s2">&quot;Enable Chapter instructions.&quot;</span><span class="o">&gt;</span><span class="p">;</span>
<span class="k">def</span> <span class="nf">FeatureChapterAll</span>  <span class="p">:</span> <span class="n">SubtargetFeature</span><span class="o">&lt;</span><span class="s2">&quot;chall&quot;</span><span class="p">,</span> <span class="s2">&quot;HasChapterDummy&quot;</span><span class="p">,</span> <span class="s2">&quot;true&quot;</span><span class="p">,</span>
                                <span class="s2">&quot;Enable Chapter instructions.&quot;</span><span class="p">,</span>
                                <span class="p">[</span><span class="n">FeatureChapter3_1</span><span class="p">,</span> <span class="n">FeatureChapter3_2</span><span class="p">,</span> 
                                 <span class="n">FeatureChapter3_3</span><span class="p">,</span> <span class="n">FeatureChapter3_4</span><span class="p">,</span> 
                                 <span class="n">FeatureChapter3_5</span><span class="p">,</span> 
                                 <span class="n">FeatureChapter4_1</span><span class="p">,</span> <span class="n">FeatureChapter4_2</span><span class="p">,</span> 
                                 <span class="n">FeatureChapter5_1</span><span class="p">,</span> <span class="n">FeatureChapter6_1</span><span class="p">,</span> 
                                 <span class="n">FeatureChapter7_1</span><span class="p">,</span> <span class="n">FeatureChapter8_1</span><span class="p">,</span> 
                                 <span class="n">FeatureChapter8_2</span><span class="p">,</span> <span class="n">FeatureChapter9_1</span><span class="p">,</span> 
                                 <span class="n">FeatureChapter9_2</span><span class="p">,</span> <span class="n">FeatureChapter9_3</span><span class="p">,</span> 
                                 <span class="n">FeatureChapter10_1</span><span class="p">,</span> 
                                 <span class="n">FeatureChapter11_1</span><span class="p">,</span> <span class="n">FeatureChapter11_2</span><span class="p">,</span> 
                                 <span class="n">FeatureChapter12_1</span><span class="p">]</span><span class="o">&gt;</span><span class="p">;</span>

<span class="k">def</span> <span class="nf">FeatureCmp</span>         <span class="p">:</span> <span class="n">SubtargetFeature</span><span class="o">&lt;</span><span class="s2">&quot;cmp&quot;</span><span class="p">,</span> <span class="s2">&quot;HasCmp&quot;</span><span class="p">,</span> <span class="s2">&quot;true&quot;</span><span class="p">,</span>
                                <span class="s2">&quot;Enable &#39;cmp&#39; instructions.&quot;</span><span class="o">&gt;</span><span class="p">;</span>
<span class="k">def</span> <span class="nf">FeatureSlt</span>         <span class="p">:</span> <span class="n">SubtargetFeature</span><span class="o">&lt;</span><span class="s2">&quot;slt&quot;</span><span class="p">,</span> <span class="s2">&quot;HasSlt&quot;</span><span class="p">,</span> <span class="s2">&quot;true&quot;</span><span class="p">,</span>
                                <span class="s2">&quot;Enable &#39;slt&#39; instructions.&quot;</span><span class="o">&gt;</span><span class="p">;</span>
<span class="k">def</span> <span class="nf">FeatureCpu032I</span>     <span class="p">:</span> <span class="n">SubtargetFeature</span><span class="o">&lt;</span><span class="s2">&quot;cpu032I&quot;</span><span class="p">,</span> <span class="s2">&quot;Cpu0ArchVersion&quot;</span><span class="p">,</span> 
                                <span class="s2">&quot;Cpu032I&quot;</span><span class="p">,</span> <span class="s2">&quot;Cpu032I ISA Support&quot;</span><span class="p">,</span>
                                <span class="p">[</span><span class="n">FeatureCmp</span><span class="p">,</span> <span class="n">FeatureChapterAll</span><span class="p">]</span><span class="o">&gt;</span><span class="p">;</span>
<span class="k">def</span> <span class="nf">FeatureCpu032II</span>    <span class="p">:</span> <span class="n">SubtargetFeature</span><span class="o">&lt;</span><span class="s2">&quot;cpu032II&quot;</span><span class="p">,</span> <span class="s2">&quot;Cpu0ArchVersion&quot;</span><span class="p">,</span>                      
                               <span class="s2">&quot;Cpu032II&quot;</span><span class="p">,</span> <span class="s2">&quot;Cpu032II ISA Support (slt)&quot;</span><span class="p">,</span>
                                <span class="p">[</span><span class="n">FeatureCmp</span><span class="p">,</span> <span class="n">FeatureSlt</span><span class="p">,</span> <span class="n">FeatureChapterAll</span><span class="p">]</span><span class="o">&gt;</span><span class="p">;</span>

<span class="o">//===----------------------------------------------------------------------===//</span>
<span class="o">//</span> <span class="n">Calling</span> <span class="n">Conv</span><span class="p">,</span> <span class="n">Instruction</span> <span class="n">Descriptions</span>
<span class="o">//===----------------------------------------------------------------------===//</span>

<span class="n">include</span> <span class="s2">&quot;Cpu0Schedule.td&quot;</span>
<span class="n">include</span> <span class="s2">&quot;Cpu0InstrInfo.td&quot;</span>

<span class="k">def</span> <span class="nf">Cpu0InstrInfo</span> <span class="p">:</span> <span class="n">InstrInfo</span><span class="p">;</span>
<span class="o">//===----------------------------------------------------------------------===//</span>
<span class="o">//</span> <span class="n">Cpu0</span> <span class="n">processors</span> <span class="n">supported</span><span class="o">.</span>
<span class="o">//===----------------------------------------------------------------------===//</span>

<span class="k">class</span> <span class="nc">Proc</span><span class="o">&lt;</span><span class="n">string</span> <span class="n">Name</span><span class="p">,</span> <span class="nb">list</span><span class="o">&lt;</span><span class="n">SubtargetFeature</span><span class="o">&gt;</span> <span class="n">Features</span><span class="o">&gt;</span>
 <span class="p">:</span> <span class="n">Processor</span><span class="o">&lt;</span><span class="n">Name</span><span class="p">,</span> <span class="n">Cpu0GenericItineraries</span><span class="p">,</span> <span class="n">Features</span><span class="o">&gt;</span><span class="p">;</span>

<span class="k">def</span> <span class="p">:</span> <span class="n">Proc</span><span class="o">&lt;</span><span class="s2">&quot;cpu032I&quot;</span><span class="p">,</span>  <span class="p">[</span><span class="n">FeatureCpu032I</span><span class="p">]</span><span class="o">&gt;</span><span class="p">;</span>
<span class="k">def</span> <span class="p">:</span> <span class="n">Proc</span><span class="o">&lt;</span><span class="s2">&quot;cpu032II&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">FeatureCpu032II</span><span class="p">]</span><span class="o">&gt;</span><span class="p">;</span>
<span class="o">//</span> <span class="n">Above</span> <span class="n">make</span> <span class="n">Cpu0GenSubtargetInfo</span><span class="o">.</span><span class="n">inc</span> <span class="nb">set</span> <span class="n">feature</span> <span class="n">bit</span> <span class="k">as</span> <span class="n">the</span> <span class="n">following</span> <span class="n">order</span>
<span class="o">//</span> <span class="n">enum</span> <span class="p">{</span>
<span class="o">//</span>   <span class="n">FeatureCmp</span> <span class="o">=</span>  <span class="mi">1</span><span class="n">ULL</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">,</span>
<span class="o">//</span>   <span class="n">FeatureCpu032I</span> <span class="o">=</span>  <span class="mi">1</span><span class="n">ULL</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">,</span>
<span class="o">//</span>   <span class="n">FeatureCpu032II</span> <span class="o">=</span>  <span class="mi">1</span><span class="n">ULL</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">,</span>
<span class="o">//</span>   <span class="n">FeatureSlt</span> <span class="o">=</span>  <span class="mi">1</span><span class="n">ULL</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span>
<span class="o">//</span> <span class="p">};</span>

<span class="o">//</span> <span class="n">Will</span> <span class="n">generate</span> <span class="n">Cpu0GenAsmWrite</span><span class="o">.</span><span class="n">inc</span> <span class="n">included</span> <span class="n">by</span> <span class="n">Cpu0InstPrinter</span><span class="o">.</span><span class="n">cpp</span><span class="p">,</span> <span class="n">contents</span> 
<span class="o">//</span>  <span class="k">as</span> <span class="n">follows</span><span class="p">,</span>
<span class="o">//</span> <span class="n">void</span> <span class="n">Cpu0InstPrinter</span><span class="p">::</span><span class="n">printInstruction</span><span class="p">(</span><span class="n">const</span> <span class="n">MCInst</span> <span class="o">*</span><span class="n">MI</span><span class="p">,</span> <span class="n">raw_ostream</span> <span class="o">&amp;</span><span class="n">O</span><span class="p">)</span> <span class="p">{</span><span class="o">...</span><span class="p">}</span>
<span class="o">//</span> <span class="n">const</span> <span class="n">char</span> <span class="o">*</span><span class="n">Cpu0InstPrinter</span><span class="p">::</span><span class="n">getRegisterName</span><span class="p">(</span><span class="n">unsigned</span> <span class="n">RegNo</span><span class="p">)</span> <span class="p">{</span><span class="o">...</span><span class="p">}</span>
<span class="k">def</span> <span class="nf">Cpu0</span> <span class="p">:</span> <span class="n">Target</span> <span class="p">{</span>
<span class="o">//</span> <span class="k">def</span> <span class="nf">Cpu0InstrInfo</span> <span class="p">:</span> <span class="n">InstrInfo</span> <span class="k">as</span> <span class="n">before</span><span class="o">.</span>
  <span class="n">let</span> <span class="n">InstructionSet</span> <span class="o">=</span> <span class="n">Cpu0InstrInfo</span><span class="p">;</span>
<span class="p">}</span>

</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter2/Cpu0Other.td</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//===--</span> <span class="n">Cpu0Other</span><span class="o">.</span><span class="n">td</span> <span class="o">-</span> <span class="n">Describe</span> <span class="n">the</span> <span class="n">Cpu0</span> <span class="n">Target</span> <span class="n">Machine</span> <span class="o">----*-</span> <span class="n">tablegen</span> <span class="o">-*-===//</span>
<span class="o">//</span>
<span class="o">//</span>                     <span class="n">The</span> <span class="n">LLVM</span> <span class="n">Compiler</span> <span class="n">Infrastructure</span>
<span class="o">//</span>
<span class="o">//</span> <span class="n">This</span> <span class="n">file</span> <span class="ow">is</span> <span class="n">distributed</span> <span class="n">under</span> <span class="n">the</span> <span class="n">University</span> <span class="n">of</span> <span class="n">Illinois</span> <span class="n">Open</span> <span class="n">Source</span>
<span class="o">//</span> <span class="n">License</span><span class="o">.</span> <span class="n">See</span> <span class="n">LICENSE</span><span class="o">.</span><span class="n">TXT</span> <span class="k">for</span> <span class="n">details</span><span class="o">.</span>
<span class="o">//</span>
<span class="o">//===----------------------------------------------------------------------===//</span>
<span class="o">//</span> <span class="n">This</span> <span class="ow">is</span> <span class="n">the</span> <span class="n">top</span> <span class="n">level</span> <span class="n">entry</span> <span class="n">point</span> <span class="k">for</span> <span class="n">the</span> <span class="n">Cpu0</span> <span class="n">target</span><span class="o">.</span>
<span class="o">//===----------------------------------------------------------------------===//</span>

<span class="o">//===----------------------------------------------------------------------===//</span>
<span class="o">//</span> <span class="n">Target</span><span class="o">-</span><span class="n">independent</span> <span class="n">interfaces</span>
<span class="o">//===----------------------------------------------------------------------===//</span>

<span class="n">include</span> <span class="s2">&quot;llvm/Target/Target.td&quot;</span>

<span class="o">//===----------------------------------------------------------------------===//</span>
<span class="o">//</span> <span class="n">Target</span><span class="o">-</span><span class="n">dependent</span> <span class="n">interfaces</span>
<span class="o">//===----------------------------------------------------------------------===//</span>

<span class="n">include</span> <span class="s2">&quot;Cpu0RegisterInfo.td&quot;</span>
<span class="n">include</span> <span class="s2">&quot;Cpu0RegisterInfoGPROutForOther.td&quot;</span> <span class="o">//</span> <span class="k">except</span> <span class="n">AsmParser</span>
<span class="n">include</span> <span class="s2">&quot;Cpu0.td&quot;</span>

</pre></div>
</div>
<p><cite>Cpu0Other.td</cite> and <cite>Cpu0.td</cite> include several other <cite>.td</cite> files.</p>
<p><cite>Cpu0RegisterInfo.td</cite> (shown below) describes the <strong>Cpu0 register set</strong>.</p>
<p>In this file, each register is assigned a name.
For example, <strong>`def PC`</strong> defines a register named <strong>PC</strong>.</p>
<p>In addition to <strong>register definitions</strong>, this file also defines <strong>register classes</strong>.
A target may have multiple register classes, such as:
- <strong>CPURegs</strong>
- <strong>SR</strong>
- <strong>C0Regs</strong>
- <strong>GPROut</strong></p>
<p>The <strong>GPROut</strong> register class, defined in <cite>Cpu0RegisterInfoGPROutForOther.td</cite>,
includes all <strong>CPURegs</strong> <strong>except</strong> <cite>SW</cite>, ensuring that <cite>SW</cite> is <strong>not allocated</strong>
as an output register during the <strong>register allocation stage</strong>.</p>
<p class="rubric">lbdex/chapters/Chapter2/Cpu0RegisterInfo.td</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//===--</span> <span class="n">Cpu0RegisterInfo</span><span class="o">.</span><span class="n">td</span> <span class="o">-</span> <span class="n">Cpu0</span> <span class="n">Register</span> <span class="n">defs</span> <span class="o">-----------*-</span> <span class="n">tablegen</span> <span class="o">-*-===//</span>
<span class="o">//</span>
<span class="o">//</span>                     <span class="n">The</span> <span class="n">LLVM</span> <span class="n">Compiler</span> <span class="n">Infrastructure</span>
<span class="o">//</span>
<span class="o">//</span> <span class="n">This</span> <span class="n">file</span> <span class="ow">is</span> <span class="n">distributed</span> <span class="n">under</span> <span class="n">the</span> <span class="n">University</span> <span class="n">of</span> <span class="n">Illinois</span> <span class="n">Open</span> <span class="n">Source</span>
<span class="o">//</span> <span class="n">License</span><span class="o">.</span> <span class="n">See</span> <span class="n">LICENSE</span><span class="o">.</span><span class="n">TXT</span> <span class="k">for</span> <span class="n">details</span><span class="o">.</span>
<span class="o">//</span>
<span class="o">//===----------------------------------------------------------------------===//</span>

<span class="o">//===----------------------------------------------------------------------===//</span>
<span class="o">//</span>  <span class="n">Declarations</span> <span class="n">that</span> <span class="n">describe</span> <span class="n">the</span> <span class="n">CPU0</span> <span class="n">register</span> <span class="n">file</span>
<span class="o">//===----------------------------------------------------------------------===//</span>

<span class="o">//</span> <span class="n">We</span> <span class="n">have</span> <span class="n">banks</span> <span class="n">of</span> <span class="mi">16</span> <span class="n">registers</span> <span class="n">each</span><span class="o">.</span>
<span class="k">class</span> <span class="nc">Cpu0Reg</span><span class="o">&lt;</span><span class="n">bits</span><span class="o">&lt;</span><span class="mi">16</span><span class="o">&gt;</span> <span class="n">Enc</span><span class="p">,</span> <span class="n">string</span> <span class="n">n</span><span class="o">&gt;</span> <span class="p">:</span> <span class="n">Register</span><span class="o">&lt;</span><span class="n">n</span><span class="o">&gt;</span> <span class="p">{</span>
  <span class="o">//</span> <span class="n">For</span> <span class="n">tablegen</span><span class="p">(</span><span class="o">...</span> <span class="o">-</span><span class="n">gen</span><span class="o">-</span><span class="n">emitter</span><span class="p">)</span>  <span class="ow">in</span> <span class="n">CMakeLists</span><span class="o">.</span><span class="n">txt</span>
  <span class="n">let</span> <span class="n">HWEncoding</span> <span class="o">=</span> <span class="n">Enc</span><span class="p">;</span>
  
  <span class="n">let</span> <span class="n">Namespace</span> <span class="o">=</span> <span class="s2">&quot;Cpu0&quot;</span><span class="p">;</span>
<span class="p">}</span>

<span class="o">//</span> <span class="n">Cpu0</span> <span class="n">CPU</span> <span class="n">Registers</span>
<span class="k">class</span> <span class="nc">Cpu0GPRReg</span><span class="o">&lt;</span><span class="n">bits</span><span class="o">&lt;</span><span class="mi">16</span><span class="o">&gt;</span> <span class="n">Enc</span><span class="p">,</span> <span class="n">string</span> <span class="n">n</span><span class="o">&gt;</span> <span class="p">:</span> <span class="n">Cpu0Reg</span><span class="o">&lt;</span><span class="n">Enc</span><span class="p">,</span> <span class="n">n</span><span class="o">&gt;</span><span class="p">;</span>

<span class="o">//</span> <span class="n">Co</span><span class="o">-</span><span class="n">processor</span> <span class="mi">0</span> <span class="n">Registers</span>
<span class="k">class</span> <span class="nc">Cpu0C0Reg</span><span class="o">&lt;</span><span class="n">bits</span><span class="o">&lt;</span><span class="mi">16</span><span class="o">&gt;</span> <span class="n">Enc</span><span class="p">,</span> <span class="n">string</span> <span class="n">n</span><span class="o">&gt;</span> <span class="p">:</span> <span class="n">Cpu0Reg</span><span class="o">&lt;</span><span class="n">Enc</span><span class="p">,</span> <span class="n">n</span><span class="o">&gt;</span><span class="p">;</span>

<span class="o">//===----------------------------------------------------------------------===//</span>
<span class="o">//</span><span class="nd">@Registers</span>
<span class="o">//===----------------------------------------------------------------------===//</span>
<span class="o">//</span> <span class="n">The</span> <span class="n">register</span> <span class="n">string</span><span class="p">,</span> <span class="n">such</span> <span class="k">as</span> <span class="s2">&quot;9&quot;</span> <span class="ow">or</span> <span class="s2">&quot;gp&quot;</span> <span class="n">will</span> <span class="n">show</span> <span class="n">on</span> <span class="s2">&quot;llvm-objdump -d&quot;</span>
<span class="o">//@</span> <span class="n">All</span> <span class="n">registers</span> <span class="n">definition</span>
<span class="n">let</span> <span class="n">Namespace</span> <span class="o">=</span> <span class="s2">&quot;Cpu0&quot;</span> <span class="ow">in</span> <span class="p">{</span>
  <span class="o">//@</span> <span class="n">General</span> <span class="n">Purpose</span> <span class="n">Registers</span>
  <span class="k">def</span> <span class="nf">ZERO</span> <span class="p">:</span> <span class="n">Cpu0GPRReg</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">,</span>  <span class="s2">&quot;zero&quot;</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">DwarfRegNum</span><span class="o">&lt;</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&gt;</span><span class="p">;</span>
  <span class="k">def</span> <span class="nf">AT</span>   <span class="p">:</span> <span class="n">Cpu0GPRReg</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">,</span>  <span class="s2">&quot;1&quot;</span><span class="o">&gt;</span><span class="p">,</span>    <span class="n">DwarfRegNum</span><span class="o">&lt;</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">&gt;</span><span class="p">;</span>
  <span class="k">def</span> <span class="nf">V0</span>   <span class="p">:</span> <span class="n">Cpu0GPRReg</span><span class="o">&lt;</span><span class="mi">2</span><span class="p">,</span>  <span class="s2">&quot;2&quot;</span><span class="o">&gt;</span><span class="p">,</span>    <span class="n">DwarfRegNum</span><span class="o">&lt;</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">&gt;</span><span class="p">;</span>
  <span class="k">def</span> <span class="nf">V1</span>   <span class="p">:</span> <span class="n">Cpu0GPRReg</span><span class="o">&lt;</span><span class="mi">3</span><span class="p">,</span>  <span class="s2">&quot;3&quot;</span><span class="o">&gt;</span><span class="p">,</span>    <span class="n">DwarfRegNum</span><span class="o">&lt;</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">&gt;</span><span class="p">;</span>
  <span class="k">def</span> <span class="nf">A0</span>   <span class="p">:</span> <span class="n">Cpu0GPRReg</span><span class="o">&lt;</span><span class="mi">4</span><span class="p">,</span>  <span class="s2">&quot;4&quot;</span><span class="o">&gt;</span><span class="p">,</span>    <span class="n">DwarfRegNum</span><span class="o">&lt;</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">&gt;</span><span class="p">;</span>
  <span class="k">def</span> <span class="nf">A1</span>   <span class="p">:</span> <span class="n">Cpu0GPRReg</span><span class="o">&lt;</span><span class="mi">5</span><span class="p">,</span>  <span class="s2">&quot;5&quot;</span><span class="o">&gt;</span><span class="p">,</span>    <span class="n">DwarfRegNum</span><span class="o">&lt;</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">&gt;</span><span class="p">;</span>
  <span class="k">def</span> <span class="nf">T9</span>   <span class="p">:</span> <span class="n">Cpu0GPRReg</span><span class="o">&lt;</span><span class="mi">6</span><span class="p">,</span>  <span class="s2">&quot;t9&quot;</span><span class="o">&gt;</span><span class="p">,</span>   <span class="n">DwarfRegNum</span><span class="o">&lt;</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">&gt;</span><span class="p">;</span>
  <span class="k">def</span> <span class="nf">T0</span>   <span class="p">:</span> <span class="n">Cpu0GPRReg</span><span class="o">&lt;</span><span class="mi">7</span><span class="p">,</span>  <span class="s2">&quot;7&quot;</span><span class="o">&gt;</span><span class="p">,</span>    <span class="n">DwarfRegNum</span><span class="o">&lt;</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span><span class="o">&gt;</span><span class="p">;</span>
  <span class="k">def</span> <span class="nf">T1</span>   <span class="p">:</span> <span class="n">Cpu0GPRReg</span><span class="o">&lt;</span><span class="mi">8</span><span class="p">,</span>  <span class="s2">&quot;8&quot;</span><span class="o">&gt;</span><span class="p">,</span>    <span class="n">DwarfRegNum</span><span class="o">&lt;</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span><span class="o">&gt;</span><span class="p">;</span>
  <span class="k">def</span> <span class="nf">S0</span>   <span class="p">:</span> <span class="n">Cpu0GPRReg</span><span class="o">&lt;</span><span class="mi">9</span><span class="p">,</span>  <span class="s2">&quot;9&quot;</span><span class="o">&gt;</span><span class="p">,</span>    <span class="n">DwarfRegNum</span><span class="o">&lt;</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span><span class="o">&gt;</span><span class="p">;</span>
  <span class="k">def</span> <span class="nf">S1</span>   <span class="p">:</span> <span class="n">Cpu0GPRReg</span><span class="o">&lt;</span><span class="mi">10</span><span class="p">,</span> <span class="s2">&quot;10&quot;</span><span class="o">&gt;</span><span class="p">,</span>   <span class="n">DwarfRegNum</span><span class="o">&lt;</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span><span class="o">&gt;</span><span class="p">;</span>
  <span class="k">def</span> <span class="nf">GP</span>   <span class="p">:</span> <span class="n">Cpu0GPRReg</span><span class="o">&lt;</span><span class="mi">11</span><span class="p">,</span> <span class="s2">&quot;gp&quot;</span><span class="o">&gt;</span><span class="p">,</span>   <span class="n">DwarfRegNum</span><span class="o">&lt;</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span><span class="o">&gt;</span><span class="p">;</span>
  <span class="k">def</span> <span class="nf">FP</span>   <span class="p">:</span> <span class="n">Cpu0GPRReg</span><span class="o">&lt;</span><span class="mi">12</span><span class="p">,</span> <span class="s2">&quot;fp&quot;</span><span class="o">&gt;</span><span class="p">,</span>   <span class="n">DwarfRegNum</span><span class="o">&lt;</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span><span class="o">&gt;</span><span class="p">;</span>
  <span class="k">def</span> <span class="nf">SP</span>   <span class="p">:</span> <span class="n">Cpu0GPRReg</span><span class="o">&lt;</span><span class="mi">13</span><span class="p">,</span> <span class="s2">&quot;sp&quot;</span><span class="o">&gt;</span><span class="p">,</span>   <span class="n">DwarfRegNum</span><span class="o">&lt;</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span><span class="o">&gt;</span><span class="p">;</span>
  <span class="k">def</span> <span class="nf">LR</span>   <span class="p">:</span> <span class="n">Cpu0GPRReg</span><span class="o">&lt;</span><span class="mi">14</span><span class="p">,</span> <span class="s2">&quot;lr&quot;</span><span class="o">&gt;</span><span class="p">,</span>   <span class="n">DwarfRegNum</span><span class="o">&lt;</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span><span class="o">&gt;</span><span class="p">;</span>
  <span class="k">def</span> <span class="nf">SW</span>   <span class="p">:</span> <span class="n">Cpu0GPRReg</span><span class="o">&lt;</span><span class="mi">15</span><span class="p">,</span> <span class="s2">&quot;sw&quot;</span><span class="o">&gt;</span><span class="p">,</span>   <span class="n">DwarfRegNum</span><span class="o">&lt;</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span><span class="o">&gt;</span><span class="p">;</span>
<span class="o">//</span>  <span class="k">def</span> <span class="nf">MAR</span>  <span class="p">:</span> <span class="n">Register</span><span class="o">&lt;</span> <span class="mi">16</span><span class="p">,</span> <span class="s2">&quot;mar&quot;</span><span class="o">&gt;</span><span class="p">,</span>  <span class="n">DwarfRegNum</span><span class="o">&lt;</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span><span class="o">&gt;</span><span class="p">;</span>
<span class="o">//</span>  <span class="k">def</span> <span class="nf">MDR</span>  <span class="p">:</span> <span class="n">Register</span><span class="o">&lt;</span> <span class="mi">17</span><span class="p">,</span> <span class="s2">&quot;mdr&quot;</span><span class="o">&gt;</span><span class="p">,</span>  <span class="n">DwarfRegNum</span><span class="o">&lt;</span><span class="p">[</span><span class="mi">17</span><span class="p">]</span><span class="o">&gt;</span><span class="p">;</span>

  <span class="k">def</span> <span class="nf">PC</span>   <span class="p">:</span> <span class="n">Cpu0C0Reg</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;pc&quot;</span><span class="o">&gt;</span><span class="p">,</span>  <span class="n">DwarfRegNum</span><span class="o">&lt;</span><span class="p">[</span><span class="mi">20</span><span class="p">]</span><span class="o">&gt;</span><span class="p">;</span>
  <span class="k">def</span> <span class="nf">EPC</span>  <span class="p">:</span> <span class="n">Cpu0C0Reg</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;epc&quot;</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">DwarfRegNum</span><span class="o">&lt;</span><span class="p">[</span><span class="mi">21</span><span class="p">]</span><span class="o">&gt;</span><span class="p">;</span>
<span class="p">}</span>

<span class="o">//===----------------------------------------------------------------------===//</span>
<span class="o">//</span><span class="nd">@Register</span> <span class="n">Classes</span>
<span class="o">//===----------------------------------------------------------------------===//</span>

<span class="k">def</span> <span class="nf">CPURegs</span> <span class="p">:</span> <span class="n">RegisterClass</span><span class="o">&lt;</span><span class="s2">&quot;Cpu0&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">i32</span><span class="p">],</span> <span class="mi">32</span><span class="p">,</span> <span class="p">(</span><span class="n">add</span>
  <span class="o">//</span> <span class="n">Reserved</span>
  <span class="n">ZERO</span><span class="p">,</span> <span class="n">AT</span><span class="p">,</span> 
  <span class="o">//</span> <span class="n">Return</span> <span class="n">Values</span> <span class="ow">and</span> <span class="n">Arguments</span>
  <span class="n">V0</span><span class="p">,</span> <span class="n">V1</span><span class="p">,</span> <span class="n">A0</span><span class="p">,</span> <span class="n">A1</span><span class="p">,</span> 
  <span class="o">//</span> <span class="n">Not</span> <span class="n">preserved</span> <span class="n">across</span> <span class="n">procedure</span> <span class="n">calls</span>
  <span class="n">T9</span><span class="p">,</span> <span class="n">T0</span><span class="p">,</span> <span class="n">T1</span><span class="p">,</span>
  <span class="o">//</span> <span class="n">Callee</span> <span class="n">save</span>
  <span class="n">S0</span><span class="p">,</span> <span class="n">S1</span><span class="p">,</span>
  <span class="o">//</span> <span class="n">Reserved</span>
  <span class="n">GP</span><span class="p">,</span> <span class="n">FP</span><span class="p">,</span> 
  <span class="n">SP</span><span class="p">,</span> <span class="n">LR</span><span class="p">,</span> <span class="n">SW</span><span class="p">)</span><span class="o">&gt;</span><span class="p">;</span>

<span class="o">//</span><span class="nd">@Status</span> <span class="n">Registers</span> <span class="k">class</span>
<span class="nc">def</span> <span class="n">SR</span>     <span class="p">:</span> <span class="n">RegisterClass</span><span class="o">&lt;</span><span class="s2">&quot;Cpu0&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">i32</span><span class="p">],</span> <span class="mi">32</span><span class="p">,</span> <span class="p">(</span><span class="n">add</span> <span class="n">SW</span><span class="p">)</span><span class="o">&gt;</span><span class="p">;</span>

<span class="o">//</span><span class="nd">@Co</span><span class="o">-</span><span class="n">processor</span> <span class="mi">0</span> <span class="n">Registers</span> <span class="k">class</span>
<span class="nc">def</span> <span class="n">C0Regs</span> <span class="p">:</span> <span class="n">RegisterClass</span><span class="o">&lt;</span><span class="s2">&quot;Cpu0&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">i32</span><span class="p">],</span> <span class="mi">32</span><span class="p">,</span> <span class="p">(</span><span class="n">add</span> <span class="n">PC</span><span class="p">,</span> <span class="n">EPC</span><span class="p">)</span><span class="o">&gt;</span><span class="p">;</span>

</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter2/Cpu0RegisterInfoGPROutForOther.td</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>
<span class="o">//===----------------------------------------------------------------------===//</span>
<span class="o">//</span> <span class="n">Register</span> <span class="n">Classes</span>
<span class="o">//===----------------------------------------------------------------------===//</span>

<span class="k">def</span> <span class="nf">GPROut</span> <span class="p">:</span> <span class="n">RegisterClass</span><span class="o">&lt;</span><span class="s2">&quot;Cpu0&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">i32</span><span class="p">],</span> <span class="mi">32</span><span class="p">,</span> <span class="p">(</span><span class="n">add</span> <span class="p">(</span><span class="n">sub</span> <span class="n">CPURegs</span><span class="p">,</span> <span class="n">SW</span><span class="p">))</span><span class="o">&gt;</span><span class="p">;</span>

</pre></div>
</div>
<p>In C++, a <strong>class</strong> typically defines a structure to organize data and functions,
while <strong>definitions</strong> allocate memory for specific instances of the class.</p>
<p>For example:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Date</span><span class="w"> </span><span class="p">{</span><span class="w">  </span><span class="c1">// declare Date</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">year</span><span class="p">,</span><span class="w"> </span><span class="n">month</span><span class="p">,</span><span class="w"> </span><span class="n">day</span><span class="p">;</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>
<span class="n">Date</span><span class="w"> </span><span class="n">birthday</span><span class="p">;</span><span class="w">  </span><span class="c1">// define birthday, an instance of Date</span>
</pre></div>
</div>
<p>The class <strong>Date</strong> has the members <strong>year</strong>, <strong>month</strong>, and <strong>day</strong>,
but these do not yet belong to an actual object.</p>
<p>By defining an instance of <strong>Date</strong> called <strong>birthday</strong>, memory is allocated
for a specific object, allowing you to set its <strong>year</strong>, <strong>month</strong>, and <strong>day</strong>.</p>
<p>In <cite>.td</cite> files, a <strong>class</strong> describes the <strong>structure</strong> of how data is laid out,
while <strong>definitions</strong> act as <strong>specific instances</strong> of the class.</p>
<p>If you refer back to the <cite>Cpu0RegisterInfo.td</cite> file, you will see a class called
<strong>Cpu0Reg</strong>, which is derived from the <strong>Register</strong> class provided by <strong>LLVM</strong>.
<cite>Cpu0Reg</cite> <strong>inherits all fields</strong> from the <cite>Register</cite> class.</p>
<p>The statement <strong>“let HWEncoding = Enc”</strong> assigns the field <cite>HWEncoding</cite>
from the parameter <cite>Enc</cite>.</p>
<p>Since <strong>Cpu0 reserves 4 bits for 16 registers</strong> in its instruction format,
the assigned value range is <strong>0 to 15</strong>.</p>
<p>Once values between <cite>0</cite> and <cite>15</cite> are assigned to <cite>HWEncoding</cite>, the <strong>backend
register number</strong> is determined using <strong>LLVM’s register class functions</strong>,
as <strong>TableGen</strong> automatically sets this number.</p>
<p>The <strong>`def`</strong> keyword is used to create instances of a class.</p>
<p>In the following line, the <cite>ZERO</cite> register is defined as a member of the
<strong>Cpu0GPRReg</strong> class:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="n">def</span><span class="w"> </span><span class="n">ZERO</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">Cpu0GPRReg</span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;ZERO&quot;</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">DwarfRegNum</span><span class="o">&lt;</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>
</pre></div>
</div>
<p>The <strong>def ZERO</strong> statement defines the name of this register.
The parameters <strong>&lt;0, “ZERO”&gt;</strong> are used to create this specific instance
of the <strong>Cpu0GPRReg</strong> class.</p>
<p>Thus, the field <strong>Enc</strong> is set to <cite>0</cite>, and the string <strong>n</strong> is set to <cite>“ZERO”</cite>.</p>
<p>Since this register exists in the <strong>Cpu0</strong> namespace, it can be referenced in
the backend C++ code using <strong>Cpu0::ZERO</strong>.</p>
<p>### Overriding Values with <cite>let</cite> Expressions</p>
<p>The <strong>`let`</strong> expressions allow overriding values initially defined in a
superclass.</p>
<p>For example, <strong>`let Namespace = “Cpu0”`</strong> in the <strong>Cpu0Reg</strong> class
overrides the default namespace declared in the <strong>Register</strong> class.</p>
<p>Additionally, <cite>Cpu0RegisterInfo.td</cite> defines <strong>CPURegs</strong> as an instance of
the <strong>RegisterClass</strong>, a built-in <strong>LLVM class</strong>.</p>
<p>A <strong>RegisterClass</strong> is essentially a <strong>set of Register instances</strong>,
so <strong>CPURegs</strong> can be described as a set of registers.</p>
<p>### Cpu0 Instruction Definition</p>
<p>The <strong>Cpu0 instruction</strong> description file is named <strong>Cpu0InstrInfo.td</strong>.
Its contents are as follows:</p>
<p class="rubric">lbdex/chapters/Chapter2/Cpu0InstrInfo.td</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>//===- Cpu0InstrInfo.td - Target Description for Cpu0 Target -*- tablegen -*-=//
//
//                     The LLVM Compiler Infrastructure
//
// This file is distributed under the University of Illinois Open Source
// License. See LICENSE.TXT for details.
//
//===----------------------------------------------------------------------===//
//
// This file contains the Cpu0 implementation of the TargetInstrInfo class.
//
//===----------------------------------------------------------------------===//

//===----------------------------------------------------------------------===//
// Cpu0 profiles and nodes
//===----------------------------------------------------------------------===//

def SDT_Cpu0Ret          : SDTypeProfile&lt;0, 1, [SDTCisInt&lt;0&gt;]&gt;;

// Return
def Cpu0Ret : SDNode&lt;&quot;Cpu0ISD::Ret&quot;, SDTNone,
                     [SDNPHasChain, SDNPOptInGlue, SDNPVariadic]&gt;;

//===----------------------------------------------------------------------===//
// Instruction format superclass
//===----------------------------------------------------------------------===//

include &quot;Cpu0InstrFormats.td&quot;

//===----------------------------------------------------------------------===//
// Cpu0 Operand, Complex Patterns and Transformations Definitions.
//===----------------------------------------------------------------------===//
// Instruction operand types

// Signed Operand
def simm16      : Operand&lt;i32&gt; {
  let DecoderMethod= &quot;DecodeSimm16&quot;;
}

// Address operand
def mem : Operand&lt;iPTR&gt; {
  let PrintMethod = &quot;printMemOperand&quot;;
  let MIOperandInfo = (ops GPROut, simm16);
  let EncoderMethod = &quot;getMemEncoding&quot;;
}

// Node immediate fits as 16-bit sign extended on target immediate.
// e.g. addi, andi
def immSExt16  : PatLeaf&lt;(imm), [{ return isInt&lt;16&gt;(N-&gt;getSExtValue()); }]&gt;;

// Cpu0 Address Mode! SDNode frameindex could possibily be a match
// since load and store instructions from stack used it.
def addr : 
  ComplexPattern&lt;iPTR, 2, &quot;SelectAddr&quot;, [frameindex], [SDNPWantParent]&gt;;

//===----------------------------------------------------------------------===//
// Pattern fragment for load/store
//===----------------------------------------------------------------------===//

class AlignedLoad&lt;PatFrag Node&gt; :
  PatFrag&lt;(ops node:$ptr), (Node node:$ptr), [{
  LoadSDNode *LD = cast&lt;LoadSDNode&gt;(N);
  return LD-&gt;getMemoryVT().getSizeInBits()/8 &lt;= LD-&gt;getAlignment();
}]&gt;;

class AlignedStore&lt;PatFrag Node&gt; :
  PatFrag&lt;(ops node:$val, node:$ptr), (Node node:$val, node:$ptr), [{
  StoreSDNode *SD = cast&lt;StoreSDNode&gt;(N);
  return SD-&gt;getMemoryVT().getSizeInBits()/8 &lt;= SD-&gt;getAlignment();
}]&gt;;

// Load/Store PatFrags.
def load_a          : AlignedLoad&lt;load&gt;;
def store_a         : AlignedStore&lt;store&gt;;

//===----------------------------------------------------------------------===//
// Instructions specific format
//===----------------------------------------------------------------------===//

// Arithmetic and logical instructions with 2 register operands.
class ArithLogicI&lt;bits&lt;8&gt; op, string instr_asm, SDNode OpNode,
                  Operand Od, PatLeaf imm_type, RegisterClass RC&gt; :
  FL&lt;op, (outs GPROut:$ra), (ins RC:$rb, Od:$imm16),
     !strconcat(instr_asm, &quot;\t$ra, $rb, $imm16&quot;),
     [(set GPROut:$ra, (OpNode RC:$rb, imm_type:$imm16))], IIAlu&gt; {
  let isReMaterializable = 1;
}

class FMem&lt;bits&lt;8&gt; op, dag outs, dag ins, string asmstr, list&lt;dag&gt; pattern,
          InstrItinClass itin&gt;: FL&lt;op, outs, ins, asmstr, pattern, itin&gt; {
  bits&lt;20&gt; addr;
  let Inst{19-16} = addr{19-16};
  let Inst{15-0}  = addr{15-0};
  let DecoderMethod = &quot;DecodeMem&quot;;
}

// Memory Load/Store
let canFoldAsLoad = 1 in
class LoadM&lt;bits&lt;8&gt; op, string instr_asm, PatFrag OpNode, RegisterClass RC,
            Operand MemOpnd, bit Pseudo&gt;:
  FMem&lt;op, (outs RC:$ra), (ins MemOpnd:$addr),
     !strconcat(instr_asm, &quot;\t$ra, $addr&quot;),
     [(set RC:$ra, (OpNode addr:$addr))], IILoad&gt; {
  let isPseudo = Pseudo;
}

class StoreM&lt;bits&lt;8&gt; op, string instr_asm, PatFrag OpNode, RegisterClass RC,
             Operand MemOpnd, bit Pseudo&gt;:
  FMem&lt;op, (outs), (ins RC:$ra, MemOpnd:$addr),
     !strconcat(instr_asm, &quot;\t$ra, $addr&quot;),
     [(OpNode RC:$ra, addr:$addr)], IIStore&gt; {
  let isPseudo = Pseudo;
}

//@ 32-bit load.
class LoadM32&lt;bits&lt;8&gt; op, string instr_asm, PatFrag OpNode,
                   bit Pseudo = 0&gt;
  : LoadM&lt;op, instr_asm, OpNode, GPROut, mem, Pseudo&gt; {
}

// 32-bit store.
class StoreM32&lt;bits&lt;8&gt; op, string instr_asm, PatFrag OpNode,
                    bit Pseudo = 0&gt;
  : StoreM&lt;op, instr_asm, OpNode, GPROut, mem, Pseudo&gt; {
}

//@JumpFR {
let isBranch=1, isTerminator=1, isBarrier=1, imm16=0, hasDelaySlot = 1,
    isIndirectBranch = 1 in
class JumpFR&lt;bits&lt;8&gt; op, string instr_asm, RegisterClass RC&gt;:
  FL&lt;op, (outs), (ins RC:$ra),
     !strconcat(instr_asm, &quot;\t$ra&quot;), [(brind RC:$ra)], IIBranch&gt; {
  let rb = 0;
  let imm16 = 0;
}
//@JumpFR }

// Return instruction
class RetBase&lt;RegisterClass RC&gt;: JumpFR&lt;0x3c, &quot;ret&quot;, RC&gt; {
  let isReturn = 1;
  let isCodeGenOnly = 1;
  let hasCtrlDep = 1;
  let hasExtraSrcRegAllocReq = 1;
}

  
//===----------------------------------------------------------------------===//
// Instruction definition
//===----------------------------------------------------------------------===//

//===----------------------------------------------------------------------===//
// Cpu0 Instructions
//===----------------------------------------------------------------------===//

/// Load and Store Instructions
///  aligned
def LD     : LoadM32&lt;0x01,  &quot;ld&quot;,  load_a&gt;;
def ST     : StoreM32&lt;0x02, &quot;st&quot;,  store_a&gt;;

/// Arithmetic Instructions (ALU Immediate)
// IR &quot;add&quot; defined in include/llvm/Target/TargetSelectionDAG.td, line 315 (def add).
def ADDiu   : ArithLogicI&lt;0x09, &quot;addiu&quot;, add, simm16, immSExt16, CPURegs&gt;;

/// Arithmetic Instructions (3-Operand, R-Type)

/// Shift Instructions

def JR      : JumpFR&lt;0x3c, &quot;jr&quot;, GPROut&gt;;

def RET     : RetBase&lt;GPROut&gt;;

/// No operation
let addr=0 in
  def NOP   : FJ&lt;0, (outs), (ins), &quot;nop&quot;, [], IIAlu&gt;;

//===----------------------------------------------------------------------===//
//  Arbitrary patterns that map to one or more instructions
//===----------------------------------------------------------------------===//

// Small immediates
def : Pat&lt;(i32 immSExt16:$in),
          (ADDiu ZERO, imm:$in)&gt;;

</pre></div>
</div>
<p>The <cite>Cpu0InstrFormats.td</cite> file is included in <strong>Cpu0InstrInfo.td</strong>, as shown:</p>
<p class="rubric">lbdex/chapters/Chapter2/Cpu0InstrFormats.td</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//===--</span> <span class="n">Cpu0InstrFormats</span><span class="o">.</span><span class="n">td</span> <span class="o">-</span> <span class="n">Cpu0</span> <span class="n">Instruction</span> <span class="n">Formats</span> <span class="o">-----*-</span> <span class="n">tablegen</span> <span class="o">-*-===//</span>
<span class="o">//</span>
<span class="o">//</span>                     <span class="n">The</span> <span class="n">LLVM</span> <span class="n">Compiler</span> <span class="n">Infrastructure</span>
<span class="o">//</span>
<span class="o">//</span> <span class="n">This</span> <span class="n">file</span> <span class="ow">is</span> <span class="n">distributed</span> <span class="n">under</span> <span class="n">the</span> <span class="n">University</span> <span class="n">of</span> <span class="n">Illinois</span> <span class="n">Open</span> <span class="n">Source</span>
<span class="o">//</span> <span class="n">License</span><span class="o">.</span> <span class="n">See</span> <span class="n">LICENSE</span><span class="o">.</span><span class="n">TXT</span> <span class="k">for</span> <span class="n">details</span><span class="o">.</span>
<span class="o">//</span>
<span class="o">//===----------------------------------------------------------------------===//</span>

<span class="o">//===----------------------------------------------------------------------===//</span>
<span class="o">//</span>  <span class="n">Describe</span> <span class="n">CPU0</span> <span class="n">instructions</span> <span class="nb">format</span>
<span class="o">//</span>
<span class="o">//</span>  <span class="n">CPU</span> <span class="n">INSTRUCTION</span> <span class="n">FORMATS</span>
<span class="o">//</span>
<span class="o">//</span>  <span class="n">opcode</span>  <span class="o">-</span> <span class="n">operation</span> <span class="n">code</span><span class="o">.</span>
<span class="o">//</span>  <span class="n">ra</span>      <span class="o">-</span> <span class="n">dst</span> <span class="n">reg</span><span class="p">,</span> <span class="n">only</span> <span class="n">used</span> <span class="n">on</span> <span class="mi">3</span> <span class="n">regs</span> <span class="n">instr</span><span class="o">.</span>
<span class="o">//</span>  <span class="n">rb</span>      <span class="o">-</span> <span class="n">src</span> <span class="n">reg</span><span class="o">.</span>
<span class="o">//</span>  <span class="n">rc</span>      <span class="o">-</span> <span class="n">src</span> <span class="n">reg</span> <span class="p">(</span><span class="n">on</span> <span class="n">a</span> <span class="mi">3</span> <span class="n">reg</span> <span class="n">instr</span><span class="p">)</span><span class="o">.</span>
<span class="o">//</span>  <span class="n">cx</span>      <span class="o">-</span> <span class="n">immediate</span>
<span class="o">//</span>
<span class="o">//===----------------------------------------------------------------------===//</span>

<span class="o">//</span> <span class="n">Format</span> <span class="n">specifies</span> <span class="n">the</span> <span class="n">encoding</span> <span class="n">used</span> <span class="n">by</span> <span class="n">the</span> <span class="n">instruction</span><span class="o">.</span>  <span class="n">This</span> <span class="ow">is</span> <span class="n">part</span> <span class="n">of</span> <span class="n">the</span>
<span class="o">//</span> <span class="n">ad</span><span class="o">-</span><span class="n">hoc</span> <span class="n">solution</span> <span class="n">used</span> <span class="n">to</span> <span class="n">emit</span> <span class="n">machine</span> <span class="n">instruction</span> <span class="n">encodings</span> <span class="n">by</span> <span class="n">our</span> <span class="n">machine</span>
<span class="o">//</span> <span class="n">code</span> <span class="n">emitter</span><span class="o">.</span>
<span class="k">class</span> <span class="nc">Format</span><span class="o">&lt;</span><span class="n">bits</span><span class="o">&lt;</span><span class="mi">4</span><span class="o">&gt;</span> <span class="n">val</span><span class="o">&gt;</span> <span class="p">{</span>
  <span class="n">bits</span><span class="o">&lt;</span><span class="mi">4</span><span class="o">&gt;</span> <span class="n">Value</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">def</span> <span class="nf">Pseudo</span>    <span class="p">:</span> <span class="n">Format</span><span class="o">&lt;</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">;</span>
<span class="k">def</span> <span class="nf">FrmA</span>      <span class="p">:</span> <span class="n">Format</span><span class="o">&lt;</span><span class="mi">1</span><span class="o">&gt;</span><span class="p">;</span>
<span class="k">def</span> <span class="nf">FrmL</span>      <span class="p">:</span> <span class="n">Format</span><span class="o">&lt;</span><span class="mi">2</span><span class="o">&gt;</span><span class="p">;</span>
<span class="k">def</span> <span class="nf">FrmJ</span>      <span class="p">:</span> <span class="n">Format</span><span class="o">&lt;</span><span class="mi">3</span><span class="o">&gt;</span><span class="p">;</span>
<span class="k">def</span> <span class="nf">FrmOther</span>  <span class="p">:</span> <span class="n">Format</span><span class="o">&lt;</span><span class="mi">4</span><span class="o">&gt;</span><span class="p">;</span> <span class="o">//</span> <span class="n">Instruction</span> <span class="n">w</span><span class="o">/</span> <span class="n">a</span> <span class="n">custom</span> <span class="nb">format</span>

<span class="o">//</span> <span class="n">Generic</span> <span class="n">Cpu0</span> <span class="n">Format</span>
<span class="k">class</span> <span class="nc">Cpu0Inst</span><span class="o">&lt;</span><span class="n">dag</span> <span class="n">outs</span><span class="p">,</span> <span class="n">dag</span> <span class="n">ins</span><span class="p">,</span> <span class="n">string</span> <span class="n">asmstr</span><span class="p">,</span> <span class="nb">list</span><span class="o">&lt;</span><span class="n">dag</span><span class="o">&gt;</span> <span class="n">pattern</span><span class="p">,</span>
               <span class="n">InstrItinClass</span> <span class="n">itin</span><span class="p">,</span> <span class="n">Format</span> <span class="n">f</span><span class="o">&gt;</span><span class="p">:</span> <span class="n">Instruction</span>
<span class="p">{</span>
  <span class="o">//</span> <span class="n">Inst</span> <span class="ow">and</span> <span class="n">Size</span><span class="p">:</span> <span class="k">for</span> <span class="n">tablegen</span><span class="p">(</span><span class="o">...</span> <span class="o">-</span><span class="n">gen</span><span class="o">-</span><span class="n">emitter</span><span class="p">)</span> <span class="ow">and</span> 
  <span class="o">//</span> <span class="n">tablegen</span><span class="p">(</span><span class="o">...</span> <span class="o">-</span><span class="n">gen</span><span class="o">-</span><span class="n">disassembler</span><span class="p">)</span> <span class="ow">in</span> <span class="n">CMakeLists</span><span class="o">.</span><span class="n">txt</span>
  <span class="n">field</span> <span class="n">bits</span><span class="o">&lt;</span><span class="mi">32</span><span class="o">&gt;</span> <span class="n">Inst</span><span class="p">;</span>
  <span class="n">Format</span> <span class="n">Form</span> <span class="o">=</span> <span class="n">f</span><span class="p">;</span>

  <span class="n">let</span> <span class="n">Namespace</span> <span class="o">=</span> <span class="s2">&quot;Cpu0&quot;</span><span class="p">;</span>

  <span class="n">let</span> <span class="n">Size</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>

  <span class="n">bits</span><span class="o">&lt;</span><span class="mi">8</span><span class="o">&gt;</span> <span class="n">Opcode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

  <span class="o">//</span> <span class="n">Top</span> <span class="mi">8</span> <span class="n">bits</span> <span class="n">are</span> <span class="n">the</span> <span class="s1">&#39;opcode&#39;</span> <span class="n">field</span>
  <span class="n">let</span> <span class="n">Inst</span><span class="p">{</span><span class="mi">31</span><span class="o">-</span><span class="mi">24</span><span class="p">}</span> <span class="o">=</span> <span class="n">Opcode</span><span class="p">;</span>

  <span class="n">let</span> <span class="n">OutOperandList</span> <span class="o">=</span> <span class="n">outs</span><span class="p">;</span>
  <span class="n">let</span> <span class="n">InOperandList</span>  <span class="o">=</span> <span class="n">ins</span><span class="p">;</span>

  <span class="n">let</span> <span class="n">AsmString</span>   <span class="o">=</span> <span class="n">asmstr</span><span class="p">;</span>
  <span class="n">let</span> <span class="n">Pattern</span>     <span class="o">=</span> <span class="n">pattern</span><span class="p">;</span>
  <span class="n">let</span> <span class="n">Itinerary</span>   <span class="o">=</span> <span class="n">itin</span><span class="p">;</span>

  <span class="o">//</span>
  <span class="o">//</span> <span class="n">Attributes</span> <span class="n">specific</span> <span class="n">to</span> <span class="n">Cpu0</span> <span class="n">instructions</span><span class="o">...</span>
  <span class="o">//</span>
  <span class="n">bits</span><span class="o">&lt;</span><span class="mi">4</span><span class="o">&gt;</span> <span class="n">FormBits</span> <span class="o">=</span> <span class="n">Form</span><span class="o">.</span><span class="n">Value</span><span class="p">;</span>

  <span class="o">//</span> <span class="n">TSFlags</span> <span class="n">layout</span> <span class="n">should</span> <span class="n">be</span> <span class="n">kept</span> <span class="ow">in</span> <span class="n">sync</span> <span class="k">with</span> <span class="n">Cpu0InstrInfo</span><span class="o">.</span><span class="n">h</span><span class="o">.</span>
  <span class="n">let</span> <span class="n">TSFlags</span><span class="p">{</span><span class="mi">3</span><span class="o">-</span><span class="mi">0</span><span class="p">}</span>   <span class="o">=</span> <span class="n">FormBits</span><span class="p">;</span>

  <span class="n">let</span> <span class="n">DecoderNamespace</span> <span class="o">=</span> <span class="s2">&quot;Cpu0&quot;</span><span class="p">;</span>

  <span class="n">field</span> <span class="n">bits</span><span class="o">&lt;</span><span class="mi">32</span><span class="o">&gt;</span> <span class="n">SoftFail</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="o">//===----------------------------------------------------------------------===//</span>
<span class="o">//</span> <span class="n">Format</span> <span class="n">A</span> <span class="n">instruction</span> <span class="k">class</span> <span class="nc">in</span> <span class="n">Cpu0</span> <span class="p">:</span> <span class="o">&lt;|</span><span class="n">opcode</span><span class="o">|</span><span class="n">ra</span><span class="o">|</span><span class="n">rb</span><span class="o">|</span><span class="n">rc</span><span class="o">|</span><span class="n">cx</span><span class="o">|&gt;</span>
<span class="o">//===----------------------------------------------------------------------===//</span>

<span class="k">class</span> <span class="nc">FA</span><span class="o">&lt;</span><span class="n">bits</span><span class="o">&lt;</span><span class="mi">8</span><span class="o">&gt;</span> <span class="n">op</span><span class="p">,</span> <span class="n">dag</span> <span class="n">outs</span><span class="p">,</span> <span class="n">dag</span> <span class="n">ins</span><span class="p">,</span> <span class="n">string</span> <span class="n">asmstr</span><span class="p">,</span>
         <span class="nb">list</span><span class="o">&lt;</span><span class="n">dag</span><span class="o">&gt;</span> <span class="n">pattern</span><span class="p">,</span> <span class="n">InstrItinClass</span> <span class="n">itin</span><span class="o">&gt;</span><span class="p">:</span>
      <span class="n">Cpu0Inst</span><span class="o">&lt;</span><span class="n">outs</span><span class="p">,</span> <span class="n">ins</span><span class="p">,</span> <span class="n">asmstr</span><span class="p">,</span> <span class="n">pattern</span><span class="p">,</span> <span class="n">itin</span><span class="p">,</span> <span class="n">FrmA</span><span class="o">&gt;</span>
<span class="p">{</span>
  <span class="n">bits</span><span class="o">&lt;</span><span class="mi">4</span><span class="o">&gt;</span>  <span class="n">ra</span><span class="p">;</span>
  <span class="n">bits</span><span class="o">&lt;</span><span class="mi">4</span><span class="o">&gt;</span>  <span class="n">rb</span><span class="p">;</span>
  <span class="n">bits</span><span class="o">&lt;</span><span class="mi">4</span><span class="o">&gt;</span>  <span class="n">rc</span><span class="p">;</span>
  <span class="n">bits</span><span class="o">&lt;</span><span class="mi">12</span><span class="o">&gt;</span> <span class="n">shamt</span><span class="p">;</span>

  <span class="n">let</span> <span class="n">Opcode</span> <span class="o">=</span> <span class="n">op</span><span class="p">;</span>

  <span class="n">let</span> <span class="n">Inst</span><span class="p">{</span><span class="mi">23</span><span class="o">-</span><span class="mi">20</span><span class="p">}</span> <span class="o">=</span> <span class="n">ra</span><span class="p">;</span>
  <span class="n">let</span> <span class="n">Inst</span><span class="p">{</span><span class="mi">19</span><span class="o">-</span><span class="mi">16</span><span class="p">}</span> <span class="o">=</span> <span class="n">rb</span><span class="p">;</span>
  <span class="n">let</span> <span class="n">Inst</span><span class="p">{</span><span class="mi">15</span><span class="o">-</span><span class="mi">12</span><span class="p">}</span> <span class="o">=</span> <span class="n">rc</span><span class="p">;</span>
  <span class="n">let</span> <span class="n">Inst</span><span class="p">{</span><span class="mi">11</span><span class="o">-</span><span class="mi">0</span><span class="p">}</span>  <span class="o">=</span> <span class="n">shamt</span><span class="p">;</span>
<span class="p">}</span>

<span class="o">//</span><span class="nd">@class</span> <span class="n">FL</span> <span class="p">{</span>
<span class="o">//===----------------------------------------------------------------------===//</span>
<span class="o">//</span> <span class="n">Format</span> <span class="n">L</span> <span class="n">instruction</span> <span class="k">class</span> <span class="nc">in</span> <span class="n">Cpu0</span> <span class="p">:</span> <span class="o">&lt;|</span><span class="n">opcode</span><span class="o">|</span><span class="n">ra</span><span class="o">|</span><span class="n">rb</span><span class="o">|</span><span class="n">cx</span><span class="o">|&gt;</span>
<span class="o">//===----------------------------------------------------------------------===//</span>

<span class="k">class</span> <span class="nc">FL</span><span class="o">&lt;</span><span class="n">bits</span><span class="o">&lt;</span><span class="mi">8</span><span class="o">&gt;</span> <span class="n">op</span><span class="p">,</span> <span class="n">dag</span> <span class="n">outs</span><span class="p">,</span> <span class="n">dag</span> <span class="n">ins</span><span class="p">,</span> <span class="n">string</span> <span class="n">asmstr</span><span class="p">,</span> <span class="nb">list</span><span class="o">&lt;</span><span class="n">dag</span><span class="o">&gt;</span> <span class="n">pattern</span><span class="p">,</span>
         <span class="n">InstrItinClass</span> <span class="n">itin</span><span class="o">&gt;</span><span class="p">:</span> <span class="n">Cpu0Inst</span><span class="o">&lt;</span><span class="n">outs</span><span class="p">,</span> <span class="n">ins</span><span class="p">,</span> <span class="n">asmstr</span><span class="p">,</span> <span class="n">pattern</span><span class="p">,</span> <span class="n">itin</span><span class="p">,</span> <span class="n">FrmL</span><span class="o">&gt;</span>
<span class="p">{</span>
  <span class="n">bits</span><span class="o">&lt;</span><span class="mi">4</span><span class="o">&gt;</span>  <span class="n">ra</span><span class="p">;</span>
  <span class="n">bits</span><span class="o">&lt;</span><span class="mi">4</span><span class="o">&gt;</span>  <span class="n">rb</span><span class="p">;</span>
  <span class="n">bits</span><span class="o">&lt;</span><span class="mi">16</span><span class="o">&gt;</span> <span class="n">imm16</span><span class="p">;</span>

  <span class="n">let</span> <span class="n">Opcode</span> <span class="o">=</span> <span class="n">op</span><span class="p">;</span>

  <span class="n">let</span> <span class="n">Inst</span><span class="p">{</span><span class="mi">23</span><span class="o">-</span><span class="mi">20</span><span class="p">}</span> <span class="o">=</span> <span class="n">ra</span><span class="p">;</span>
  <span class="n">let</span> <span class="n">Inst</span><span class="p">{</span><span class="mi">19</span><span class="o">-</span><span class="mi">16</span><span class="p">}</span> <span class="o">=</span> <span class="n">rb</span><span class="p">;</span>
  <span class="n">let</span> <span class="n">Inst</span><span class="p">{</span><span class="mi">15</span><span class="o">-</span><span class="mi">0</span><span class="p">}</span>  <span class="o">=</span> <span class="n">imm16</span><span class="p">;</span>
<span class="p">}</span>
<span class="o">//</span><span class="nd">@class</span> <span class="n">FL</span> <span class="p">}</span>

<span class="o">//===----------------------------------------------------------------------===//</span>
<span class="o">//</span> <span class="n">Format</span> <span class="n">J</span> <span class="n">instruction</span> <span class="k">class</span> <span class="nc">in</span> <span class="n">Cpu0</span> <span class="p">:</span> <span class="o">&lt;|</span><span class="n">opcode</span><span class="o">|</span><span class="n">address</span><span class="o">|&gt;</span>
<span class="o">//===----------------------------------------------------------------------===//</span>

<span class="k">class</span> <span class="nc">FJ</span><span class="o">&lt;</span><span class="n">bits</span><span class="o">&lt;</span><span class="mi">8</span><span class="o">&gt;</span> <span class="n">op</span><span class="p">,</span> <span class="n">dag</span> <span class="n">outs</span><span class="p">,</span> <span class="n">dag</span> <span class="n">ins</span><span class="p">,</span> <span class="n">string</span> <span class="n">asmstr</span><span class="p">,</span> <span class="nb">list</span><span class="o">&lt;</span><span class="n">dag</span><span class="o">&gt;</span> <span class="n">pattern</span><span class="p">,</span>
         <span class="n">InstrItinClass</span> <span class="n">itin</span><span class="o">&gt;</span><span class="p">:</span> <span class="n">Cpu0Inst</span><span class="o">&lt;</span><span class="n">outs</span><span class="p">,</span> <span class="n">ins</span><span class="p">,</span> <span class="n">asmstr</span><span class="p">,</span> <span class="n">pattern</span><span class="p">,</span> <span class="n">itin</span><span class="p">,</span> <span class="n">FrmJ</span><span class="o">&gt;</span>
<span class="p">{</span>
  <span class="n">bits</span><span class="o">&lt;</span><span class="mi">24</span><span class="o">&gt;</span> <span class="n">addr</span><span class="p">;</span>

  <span class="n">let</span> <span class="n">Opcode</span> <span class="o">=</span> <span class="n">op</span><span class="p">;</span>

  <span class="n">let</span> <span class="n">Inst</span><span class="p">{</span><span class="mi">23</span><span class="o">-</span><span class="mi">0</span><span class="p">}</span> <span class="o">=</span> <span class="n">addr</span><span class="p">;</span>
<span class="p">}</span>

</pre></div>
</div>
<p>### Expanding <cite>ADDiu</cite></p>
<p><cite>ADDiu</cite> is an instance of the <strong>ArithLogicI</strong> class, which inherits from <cite>FL</cite>.
It can be further expanded to retrieve its member values as follows:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>def ADDiu   : ArithLogicI&lt;0x09, &quot;addiu&quot;, add, simm16, immSExt16, CPURegs&gt;;

/// Arithmetic and logical instructions with 2 register operands.
class ArithLogicI&lt;bits&lt;8&gt; op, string instr_asm, SDNode OpNode,
          Operand Od, PatLeaf imm_type, RegisterClass RC&gt; :
  FL&lt;op, (outs GPROut:$ra), (ins RC:$rb, Od:$imm16),
   !strconcat(instr_asm, &quot;\t$ra, $rb, $imm16&quot;),
   [(set GPROut:$ra, (OpNode RC:$rb, imm_type:$imm16))], IIAlu&gt; {
  let isReMaterializable = 1;
}
</pre></div>
</div>
<p>So,</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">op = 0x09</span>
<span class="go">instr_asm = &quot;addiu&quot;</span>
<span class="go">OpNode = add</span>
<span class="go">Od = simm16</span>
<span class="go">imm_type = immSExt16</span>
<span class="go">RC = CPURegs</span>
</pre></div>
</div>
<p>### Expanding <cite>.td</cite> Files: Key Principles</p>
<ul class="simple">
<li><p><strong>`let`</strong>: Overrides an existing field from the parent class.</p>
<ul>
<li><p>Example: <cite>let isReMaterializable = 1;</cite>
This overrides <cite>isReMaterializable</cite> from the <cite>Instruction</cite> class in <cite>Target.td</cite>.</p></li>
</ul>
</li>
<li><p><strong>Declaration</strong>: Defines a new field for the class.</p>
<ul>
<li><p>Example: <cite>bits&lt;4&gt; ra;</cite>
This declares the <cite>ra</cite> field in the <cite>FL</cite> class.</p></li>
</ul>
</li>
</ul>
<p>### ADDiu Expansion Details</p>
<p>The details of expansion are shown in the following table:</p>
<table class="docutils align-default" id="id75">
<caption><span class="caption-number">Table 13 </span><span class="caption-text">ADDiu Expansion Part I</span><a class="headerlink" href="#id75" title="Permalink to this table">¶</a></caption>
<thead>
<tr class="row-odd"><th class="head"><p>ADDiu</p></th>
<th class="head"><p>ArithLogicI</p></th>
<th class="head"><p>FL</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>0x09</p></td>
<td><p>op = 0x09</p></td>
<td><p>Opcode = 0x09;</p></td>
</tr>
<tr class="row-odd"><td><p>addiu</p></td>
<td><p>instr_asm = “addiu”</p></td>
<td><p>(outs GPROut:$ra);
!strconcat(“addiu”, “t$ra, $rb, $imm16”);</p></td>
</tr>
<tr class="row-even"><td><p>add</p></td>
<td><p>OpNode = add</p></td>
<td><p>[(set GPROut:$ra, (add CPURegs:$rb, immSExt16:$imm16))]</p></td>
</tr>
<tr class="row-odd"><td><p>simm16</p></td>
<td><p>Od = simm16</p></td>
<td><p>(ins CPURegs:$rb, simm16:$imm16);</p></td>
</tr>
<tr class="row-even"><td><p>immSExt16</p></td>
<td><p>imm_type = immSExt16</p></td>
<td><p>Inst{15-0} = imm16;</p></td>
</tr>
<tr class="row-odd"><td><p>CPURegs</p></td>
<td><p>RC = CPURegs
isReMaterializable=1;</p></td>
<td><p>Inst{23-20} = ra;
Inst{19-16} = rb;</p></td>
</tr>
</tbody>
</table>
<table class="docutils align-default" id="id76">
<caption><span class="caption-number">Table 14 </span><span class="caption-text">ADDiu Expansion part II</span><a class="headerlink" href="#id76" title="Permalink to this table">¶</a></caption>
<thead>
<tr class="row-odd"><th class="head"><p>Cpu0Inst</p></th>
<th class="head"><p>instruction</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Namespace = “Cpu0”</p></td>
<td><p>Uses = []; …</p></td>
</tr>
<tr class="row-odd"><td><p>Inst{31-24} = 0x09;</p></td>
<td><p>Size = 0; …</p></td>
</tr>
<tr class="row-even"><td><p>OutOperandList = GPROut:$ra;</p></td>
<td></td>
</tr>
<tr class="row-odd"><td><p>InOperandList  = CPURegs:$rb,simm16:$imm16;</p></td>
<td></td>
</tr>
<tr class="row-even"><td><p>AsmString = “addiut$ra, $rb, $imm16”</p></td>
<td></td>
</tr>
<tr class="row-odd"><td><p>pattern = [(set GPROut:$ra, (add RC:$rb, immSExt16:$imm16))]</p></td>
<td></td>
</tr>
<tr class="row-even"><td><p>Itinerary = IIAlu</p></td>
<td></td>
</tr>
<tr class="row-odd"><td><p>TSFlags{3-0} = FrmL.value</p></td>
<td></td>
</tr>
<tr class="row-even"><td><p>DecoderNamespace = “Cpu0”</p></td>
<td></td>
</tr>
</tbody>
</table>
<p>The <cite>.td</cite> file expansion process can be cumbersome.
Similarly, <strong>LD</strong> and <strong>ST</strong> instruction definitions can be expanded in the
same manner.</p>
<p>Note the <strong>Pattern</strong>:</p>
<blockquote>
<div><p><cite>[(set GPROut:$ra, (add RC:$rb, immSExt16:$imm16))]</cite></p>
</div></blockquote>
<p>which includes the keyword <strong>“add”</strong>.</p>
<p>The <strong>ADDiu</strong> instruction with <strong>“add”</strong> was used in the
<em>Instruction Selection</em> subsection of the previous section.</p>
<p>### Cpu0 Scheduling Information</p>
<p>The <cite>Cpu0Schedule.td</cite> file includes details about <strong>function units</strong> and
<strong>pipeline stages</strong>, as shown below:</p>
<p class="rubric">lbdex/chapters/Chapter2/Cpu0Schedule.td</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//===--</span> <span class="n">Cpu0Schedule</span><span class="o">.</span><span class="n">td</span> <span class="o">-</span> <span class="n">Cpu0</span> <span class="n">Scheduling</span> <span class="n">Definitions</span> <span class="o">------*-</span> <span class="n">tablegen</span> <span class="o">-*-===//</span>
<span class="o">//</span>
<span class="o">//</span>                     <span class="n">The</span> <span class="n">LLVM</span> <span class="n">Compiler</span> <span class="n">Infrastructure</span>
<span class="o">//</span>
<span class="o">//</span> <span class="n">This</span> <span class="n">file</span> <span class="ow">is</span> <span class="n">distributed</span> <span class="n">under</span> <span class="n">the</span> <span class="n">University</span> <span class="n">of</span> <span class="n">Illinois</span> <span class="n">Open</span> <span class="n">Source</span>
<span class="o">//</span> <span class="n">License</span><span class="o">.</span> <span class="n">See</span> <span class="n">LICENSE</span><span class="o">.</span><span class="n">TXT</span> <span class="k">for</span> <span class="n">details</span><span class="o">.</span>
<span class="o">//</span>
<span class="o">//===----------------------------------------------------------------------===//</span>

<span class="o">//===----------------------------------------------------------------------===//</span>
<span class="o">//</span> <span class="n">Functional</span> <span class="n">units</span> <span class="n">across</span> <span class="n">Cpu0</span> <span class="n">chips</span> <span class="n">sets</span><span class="o">.</span> <span class="n">Based</span> <span class="n">on</span> <span class="n">GCC</span><span class="o">/</span><span class="n">Cpu0</span> <span class="n">backend</span> <span class="n">files</span><span class="o">.</span>
<span class="o">//===----------------------------------------------------------------------===//</span>
<span class="k">def</span> <span class="nf">ALU</span>     <span class="p">:</span> <span class="n">FuncUnit</span><span class="p">;</span>
<span class="k">def</span> <span class="nf">IMULDIV</span> <span class="p">:</span> <span class="n">FuncUnit</span><span class="p">;</span>

<span class="o">//===----------------------------------------------------------------------===//</span>
<span class="o">//</span> <span class="n">Instruction</span> <span class="n">Itinerary</span> <span class="n">classes</span> <span class="n">used</span> <span class="k">for</span> <span class="n">Cpu0</span>
<span class="o">//===----------------------------------------------------------------------===//</span>
<span class="k">def</span> <span class="nf">IIAlu</span>              <span class="p">:</span> <span class="n">InstrItinClass</span><span class="p">;</span>
<span class="k">def</span> <span class="nf">II_CLO</span>             <span class="p">:</span> <span class="n">InstrItinClass</span><span class="p">;</span>
<span class="k">def</span> <span class="nf">II_CLZ</span>             <span class="p">:</span> <span class="n">InstrItinClass</span><span class="p">;</span>
<span class="k">def</span> <span class="nf">IILoad</span>             <span class="p">:</span> <span class="n">InstrItinClass</span><span class="p">;</span>
<span class="k">def</span> <span class="nf">IIStore</span>            <span class="p">:</span> <span class="n">InstrItinClass</span><span class="p">;</span>
<span class="k">def</span> <span class="nf">IIBranch</span>           <span class="p">:</span> <span class="n">InstrItinClass</span><span class="p">;</span>

<span class="k">def</span> <span class="nf">IIPseudo</span>           <span class="p">:</span> <span class="n">InstrItinClass</span><span class="p">;</span>

<span class="o">//===----------------------------------------------------------------------===//</span>
<span class="o">//</span> <span class="n">Cpu0</span> <span class="n">Generic</span> <span class="n">instruction</span> <span class="n">itineraries</span><span class="o">.</span>
<span class="o">//===----------------------------------------------------------------------===//</span>
<span class="o">//@</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">llvm</span><span class="o">.</span><span class="n">org</span><span class="o">/</span><span class="n">docs</span><span class="o">/</span><span class="n">doxygen</span><span class="o">/</span><span class="n">html</span><span class="o">/</span><span class="n">structllvm_1_1InstrStage</span><span class="o">.</span><span class="n">html</span>
<span class="k">def</span> <span class="nf">Cpu0GenericItineraries</span> <span class="p">:</span> <span class="n">ProcessorItineraries</span><span class="o">&lt;</span><span class="p">[</span><span class="n">ALU</span><span class="p">,</span> <span class="n">IMULDIV</span><span class="p">],</span> <span class="p">[],</span> <span class="p">[</span>
<span class="o">//@</span><span class="mi">2</span>
  <span class="n">InstrItinData</span><span class="o">&lt;</span><span class="n">IIAlu</span>              <span class="p">,</span> <span class="p">[</span><span class="n">InstrStage</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">,</span>  <span class="p">[</span><span class="n">ALU</span><span class="p">]</span><span class="o">&gt;</span><span class="p">]</span><span class="o">&gt;</span><span class="p">,</span>
  <span class="n">InstrItinData</span><span class="o">&lt;</span><span class="n">II_CLO</span>             <span class="p">,</span> <span class="p">[</span><span class="n">InstrStage</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">,</span>  <span class="p">[</span><span class="n">ALU</span><span class="p">]</span><span class="o">&gt;</span><span class="p">]</span><span class="o">&gt;</span><span class="p">,</span>
  <span class="n">InstrItinData</span><span class="o">&lt;</span><span class="n">II_CLZ</span>             <span class="p">,</span> <span class="p">[</span><span class="n">InstrStage</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">,</span>  <span class="p">[</span><span class="n">ALU</span><span class="p">]</span><span class="o">&gt;</span><span class="p">]</span><span class="o">&gt;</span><span class="p">,</span>
  <span class="n">InstrItinData</span><span class="o">&lt;</span><span class="n">IILoad</span>             <span class="p">,</span> <span class="p">[</span><span class="n">InstrStage</span><span class="o">&lt;</span><span class="mi">3</span><span class="p">,</span>  <span class="p">[</span><span class="n">ALU</span><span class="p">]</span><span class="o">&gt;</span><span class="p">]</span><span class="o">&gt;</span><span class="p">,</span>
  <span class="n">InstrItinData</span><span class="o">&lt;</span><span class="n">IIStore</span>            <span class="p">,</span> <span class="p">[</span><span class="n">InstrStage</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">,</span>  <span class="p">[</span><span class="n">ALU</span><span class="p">]</span><span class="o">&gt;</span><span class="p">]</span><span class="o">&gt;</span><span class="p">,</span>
  <span class="n">InstrItinData</span><span class="o">&lt;</span><span class="n">IIBranch</span>           <span class="p">,</span> <span class="p">[</span><span class="n">InstrStage</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">,</span>  <span class="p">[</span><span class="n">ALU</span><span class="p">]</span><span class="o">&gt;</span><span class="p">]</span><span class="o">&gt;</span>
<span class="p">]</span><span class="o">&gt;</span><span class="p">;</span>

</pre></div>
</div>
<p>### Writing the CMake File</p>
<p>The <cite>Target/Cpu0</cite> directory contains the <cite>CMakeLists.txt</cite> file.
Its contents are as follows:</p>
<p class="rubric">lbdex/chapters/Chapter2/CMakeLists.txt</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">add_llvm_component_group</span><span class="p">(</span><span class="n">Cpu0</span><span class="p">)</span>

<span class="nb">set</span><span class="p">(</span><span class="n">LLVM_TARGET_DEFINITIONS</span> <span class="n">Cpu0Other</span><span class="o">.</span><span class="n">td</span><span class="p">)</span>

<span class="c1"># Generate Cpu0GenRegisterInfo.inc and Cpu0GenInstrInfo.inc which included by </span>
<span class="c1">#  your hand code C++ files. </span>
<span class="c1"># Cpu0GenRegisterInfo.inc came from Cpu0RegisterInfo.td, Cpu0GenInstrInfo.inc </span>
<span class="c1">#  came from Cpu0InstrInfo.td.</span>
<span class="n">tablegen</span><span class="p">(</span><span class="n">LLVM</span> <span class="n">Cpu0GenRegisterInfo</span><span class="o">.</span><span class="n">inc</span> <span class="o">-</span><span class="n">gen</span><span class="o">-</span><span class="n">register</span><span class="o">-</span><span class="n">info</span><span class="p">)</span>
<span class="n">tablegen</span><span class="p">(</span><span class="n">LLVM</span> <span class="n">Cpu0GenInstrInfo</span><span class="o">.</span><span class="n">inc</span> <span class="o">-</span><span class="n">gen</span><span class="o">-</span><span class="n">instr</span><span class="o">-</span><span class="n">info</span><span class="p">)</span>
<span class="n">tablegen</span><span class="p">(</span><span class="n">LLVM</span> <span class="n">Cpu0GenSubtargetInfo</span><span class="o">.</span><span class="n">inc</span> <span class="o">-</span><span class="n">gen</span><span class="o">-</span><span class="n">subtarget</span><span class="p">)</span>
<span class="n">tablegen</span><span class="p">(</span><span class="n">LLVM</span> <span class="n">Cpu0GenMCPseudoLowering</span><span class="o">.</span><span class="n">inc</span> <span class="o">-</span><span class="n">gen</span><span class="o">-</span><span class="n">pseudo</span><span class="o">-</span><span class="n">lowering</span><span class="p">)</span>

<span class="c1"># Cpu0CommonTableGen must be defined</span>
<span class="n">add_public_tablegen_target</span><span class="p">(</span><span class="n">Cpu0CommonTableGen</span><span class="p">)</span>

<span class="c1"># Cpu0CodeGen should match with LLVMBuild.txt Cpu0CodeGen</span>
<span class="n">add_llvm_target</span><span class="p">(</span><span class="n">Cpu0CodeGen</span>
  <span class="n">Cpu0TargetMachine</span><span class="o">.</span><span class="n">cpp</span>

  <span class="n">LINK_COMPONENTS</span>
  <span class="n">Analysis</span>
  <span class="n">AsmPrinter</span>
  <span class="n">CodeGen</span>
  <span class="n">Core</span>
  <span class="n">MC</span>
  <span class="n">Cpu0Desc</span>
  <span class="n">Cpu0Info</span>
  <span class="n">SelectionDAG</span>
  <span class="n">Support</span>
  <span class="n">Target</span>
  <span class="n">GlobalISel</span>

  <span class="n">ADD_TO_COMPONENT</span>
  <span class="n">Cpu0</span>
  <span class="p">)</span>

<span class="c1"># Should match with &quot;subdirectories =  MCTargetDesc TargetInfo&quot; in LLVMBuild.txt</span>
<span class="n">add_subdirectory</span><span class="p">(</span><span class="n">TargetInfo</span><span class="p">)</span>
<span class="n">add_subdirectory</span><span class="p">(</span><span class="n">MCTargetDesc</span><span class="p">)</span>

</pre></div>
</div>
<p><strong>CMakeLists.txt</strong> provides <strong>build instructions</strong> for <strong>CMake</strong>.
Comments in this file are prefixed with <strong>#</strong>.</p>
<p>The <cite>“tablegen(”</cite> function in <cite>CMakeLists.txt</cite> is defined in:</p>
<blockquote>
<div><p><cite>cmake/modules/TableGen.cmake</cite></p>
</div></blockquote>
<p>as shown below:</p>
<p class="rubric">llvm/cmake/modules/TableGen.cmake</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>function(tablegen project ofn)
  ...
  add_custom_command(OUTPUT ${CMAKE_CURRENT_BINARY_DIR}/${ofn}.tmp
    # Generate tablegen output in a temporary file.
    COMMAND ${${project}_TABLEGEN_EXE} ${ARGN} -I ${CMAKE_CURRENT_SOURCE_DIR}
  ...
endfunction()
...
macro(add_tablegen target project)
  ...
  if(LLVM_USE_HOST_TOOLS)
    if( ${${project}_TABLEGEN} STREQUAL &quot;${target}&quot; )
      if (NOT CMAKE_CONFIGURATION_TYPES)
        set(${project}_TABLEGEN_EXE &quot;${LLVM_NATIVE_BUILD}/bin/${target}&quot;)
      else()
        set(${project}_TABLEGEN_EXE &quot;${LLVM_NATIVE_BUILD}/Release/bin/${target}&quot;)
      endif()
  ...
endmacro()
</pre></div>
</div>
<p class="rubric">llvm/utils/TableGen/CMakeLists.txt</p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="nb">add_tablegen</span><span class="p">(</span><span class="s">llvm-tblgen</span><span class="w"> </span><span class="s">LLVM</span>
<span class="w">  </span><span class="s">...</span>
<span class="p">)</span>
</pre></div>
</div>
<p>The <cite>“add_tablegen”</cite> function in <cite>llvm/utils/TableGen/CMakeLists.txt</cite>
makes <cite>“tablegen(”</cite> in <cite>Cpu0 CMakeLists.txt</cite> an alias for <strong>llvm-tblgen</strong>
(where <cite>${project} = LLVM</cite> and <cite>${project}_TABLEGEN_EXE = llvm-tblgen</cite>).</p>
<p>The following elements define the <strong>Cpu0CommonTableGen</strong> target,
which generates the output files <strong>Cpu0Gen*.inc</strong>:</p>
<ul class="simple">
<li><p><cite>“tablegen(”</cite></p></li>
<li><p><cite>“add_public_tablegen_target(Cpu0CommonTableGen)”</cite></p></li>
<li><p>The following additional code</p></li>
</ul>
<p class="rubric">llvm/cmake/modules/TableGen.cmake</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>function(tablegen project ofn)
  ...
  set(TABLEGEN_OUTPUT ${TABLEGEN_OUTPUT} ${CMAKE_CURRENT_BINARY_DIR}/${ofn} PARENT_SCOPE)
  ...
endfunction()

# Creates a target for publicly exporting tablegen dependencies.
function(add_public_tablegen_target target)
  ...
  add_custom_target(${target}
    DEPENDS ${TABLEGEN_OUTPUT})
  ...
endfunction()
</pre></div>
</div>
<p>Since the <strong>llvm-tblgen</strong> executable is built before compiling any LLVM backend
source code, it is always available to handle TableGen requests during the build
process.</p>
<p>This book introduces backend source code <strong>incrementally</strong>, adding code
<strong>chapter by chapter</strong> based on function.</p>
<p>### Understanding Source Code</p>
<ul class="simple">
<li><p><strong>Don’t try to understand everything from the text alone</strong>—
the code added in each chapter serves as <strong>learning material</strong> too.</p></li>
<li><p><strong>Conceptual understanding</strong> of computer-related knowledge can be gained
without reading source code.</p></li>
<li><p>However, <strong>when implementing based on existing open-source software,
reading source code is essential</strong>.</p></li>
<li><p><strong>Documentation cannot fully replace source code</strong> in programming.</p></li>
<li><p><strong>Reading source code is a valuable skill in open-source development</strong>.</p></li>
</ul>
<p>### CMakeLists.txt in Subdirectories</p>
<p>The <cite>CMakeLists.txt</cite> files exist in the <strong>MCTargetDesc</strong> and <strong>TargetInfo</strong>
subdirectories.</p>
<p>These files instruct LLVM to generate the <strong>Cpu0Desc</strong> and <strong>Cpu0Info</strong>
libraries, respectively.</p>
<p>After building, you will find three libraries in the <cite>lib/</cite> directory
of your build folder:</p>
<ul class="simple">
<li><p><strong>libLLVMCpu0CodeGen.a</strong></p></li>
<li><p><strong>libLLVMCpu0Desc.a</strong></p></li>
<li><p><strong>libLLVMCpu0Info.a</strong></p></li>
</ul>
<p>For more details, refer to <em>“Building LLVM with CMake”</em> <a class="footnote-reference brackets" href="#cmake" id="id41" role="doc-noteref"><span class="fn-bracket">[</span>28<span class="fn-bracket">]</span></a>.</p>
</section>
<section id="target-registration">
<h3><a class="toc-backref" href="#id103" role="doc-backlink">Target Registration</a><a class="headerlink" href="#target-registration" title="Permalink to this heading">¶</a></h3>
<p>You must <strong>register your target</strong> with the <strong>TargetRegistry</strong>.
After registration, LLVM tools can <strong>identify and use</strong> your target at runtime.</p>
<p>Although the <strong>TargetRegistry</strong> can be used directly, most targets
utilize <strong>helper templates</strong> to simplify the process.</p>
<p>All targets should declare a <strong>global Target object</strong>, which represents the
target during registration.</p>
<p>Then, in the target’s <strong>TargetInfo library</strong>, the target should define this
object and use the <strong>RegisterTarget</strong> template to register it.</p>
<p>For example, the file <cite>TargetInfo/Cpu0TargetInfo.cpp</cite> registers
<strong>TheCpu0Target</strong> for <strong>big-endian</strong> and <strong>TheCpu0elTarget</strong> for <strong>little-endian</strong>,
as shown below:</p>
<p class="rubric">lbdex/chapters/Chapter2/Cpu0.h</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//===--</span> <span class="n">Cpu0</span><span class="o">.</span><span class="n">h</span> <span class="o">-</span> <span class="n">Top</span><span class="o">-</span><span class="n">level</span> <span class="n">interface</span> <span class="k">for</span> <span class="n">Cpu0</span> <span class="n">representation</span> <span class="o">----*-</span> <span class="n">C</span><span class="o">++</span> <span class="o">-*-===//</span>
<span class="o">//</span>
<span class="o">//</span>                     <span class="n">The</span> <span class="n">LLVM</span> <span class="n">Compiler</span> <span class="n">Infrastructure</span>
<span class="o">//</span>
<span class="o">//</span> <span class="n">This</span> <span class="n">file</span> <span class="ow">is</span> <span class="n">distributed</span> <span class="n">under</span> <span class="n">the</span> <span class="n">University</span> <span class="n">of</span> <span class="n">Illinois</span> <span class="n">Open</span> <span class="n">Source</span>
<span class="o">//</span> <span class="n">License</span><span class="o">.</span> <span class="n">See</span> <span class="n">LICENSE</span><span class="o">.</span><span class="n">TXT</span> <span class="k">for</span> <span class="n">details</span><span class="o">.</span>
<span class="o">//</span>
<span class="o">//===----------------------------------------------------------------------===//</span>
<span class="o">//</span>
<span class="o">//</span> <span class="n">This</span> <span class="n">file</span> <span class="n">contains</span> <span class="n">the</span> <span class="n">entry</span> <span class="n">points</span> <span class="k">for</span> <span class="k">global</span> <span class="n">functions</span> <span class="n">defined</span> <span class="ow">in</span>
<span class="o">//</span> <span class="n">the</span> <span class="n">LLVM</span> <span class="n">Cpu0</span> <span class="n">back</span><span class="o">-</span><span class="n">end</span><span class="o">.</span>
<span class="o">//</span>
<span class="o">//===----------------------------------------------------------------------===//</span>

<span class="c1">#ifndef LLVM_LIB_TARGET_CPU0_CPU0_H</span>
<span class="c1">#define LLVM_LIB_TARGET_CPU0_CPU0_H</span>

<span class="c1">#include &quot;Cpu0Config.h&quot;</span>
<span class="c1">#include &quot;MCTargetDesc/Cpu0MCTargetDesc.h&quot;</span>
<span class="c1">#include &quot;llvm/Target/TargetMachine.h&quot;</span>

<span class="n">namespace</span> <span class="n">llvm</span> <span class="p">{</span>
  <span class="k">class</span> <span class="nc">Cpu0TargetMachine</span><span class="p">;</span>
  <span class="k">class</span> <span class="nc">FunctionPass</span><span class="p">;</span>

<span class="p">}</span> <span class="o">//</span> <span class="n">end</span> <span class="n">namespace</span> <span class="n">llvm</span><span class="p">;</span>

<span class="c1">#endif</span>

</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter2/TargetInfo/Cpu0TargetInfo.cpp</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//===--</span> <span class="n">Cpu0TargetInfo</span><span class="o">.</span><span class="n">cpp</span> <span class="o">-</span> <span class="n">Cpu0</span> <span class="n">Target</span> <span class="n">Implementation</span> <span class="o">-------------------===//</span>
<span class="o">//</span>
<span class="o">//</span>                     <span class="n">The</span> <span class="n">LLVM</span> <span class="n">Compiler</span> <span class="n">Infrastructure</span>
<span class="o">//</span>
<span class="o">//</span> <span class="n">This</span> <span class="n">file</span> <span class="ow">is</span> <span class="n">distributed</span> <span class="n">under</span> <span class="n">the</span> <span class="n">University</span> <span class="n">of</span> <span class="n">Illinois</span> <span class="n">Open</span> <span class="n">Source</span>
<span class="o">//</span> <span class="n">License</span><span class="o">.</span> <span class="n">See</span> <span class="n">LICENSE</span><span class="o">.</span><span class="n">TXT</span> <span class="k">for</span> <span class="n">details</span><span class="o">.</span>
<span class="o">//</span>
<span class="o">//===----------------------------------------------------------------------===//</span>

<span class="c1">#include &quot;Cpu0.h&quot;</span>
<span class="c1">#include &quot;llvm/IR/Module.h&quot;</span>
<span class="c1">#include &quot;llvm/Support/TargetRegistry.h&quot;</span>
<span class="n">using</span> <span class="n">namespace</span> <span class="n">llvm</span><span class="p">;</span>

<span class="n">Target</span> <span class="n">llvm</span><span class="p">::</span><span class="n">TheCpu0Target</span><span class="p">,</span> <span class="n">llvm</span><span class="p">::</span><span class="n">TheCpu0elTarget</span><span class="p">;</span>

<span class="n">extern</span> <span class="s2">&quot;C&quot;</span> <span class="n">void</span> <span class="n">LLVMInitializeCpu0TargetInfo</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">RegisterTarget</span><span class="o">&lt;</span><span class="n">Triple</span><span class="p">::</span><span class="n">cpu0</span><span class="p">,</span>
        <span class="o">/*</span><span class="n">HasJIT</span><span class="o">=*/</span><span class="n">true</span><span class="o">&gt;</span> <span class="n">X</span><span class="p">(</span><span class="n">TheCpu0Target</span><span class="p">,</span> <span class="s2">&quot;cpu0&quot;</span><span class="p">,</span> <span class="s2">&quot;CPU0 (32-bit big endian)&quot;</span><span class="p">,</span> <span class="s2">&quot;Cpu0&quot;</span><span class="p">);</span>

  <span class="n">RegisterTarget</span><span class="o">&lt;</span><span class="n">Triple</span><span class="p">::</span><span class="n">cpu0el</span><span class="p">,</span>
        <span class="o">/*</span><span class="n">HasJIT</span><span class="o">=*/</span><span class="n">true</span><span class="o">&gt;</span> <span class="n">Y</span><span class="p">(</span><span class="n">TheCpu0elTarget</span><span class="p">,</span> <span class="s2">&quot;cpu0el&quot;</span><span class="p">,</span> <span class="s2">&quot;CPU0 (32-bit little endian)&quot;</span><span class="p">,</span> <span class="s2">&quot;Cpu0&quot;</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter2/TargetInfo/CMakeLists.txt</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># llvm 10.0.0 change from add_llvm_library to add_llvm_component_library</span>
<span class="n">add_llvm_component_library</span><span class="p">(</span><span class="n">LLVMCpu0Info</span>
  <span class="n">Cpu0TargetInfo</span><span class="o">.</span><span class="n">cpp</span>

  <span class="n">LINK_COMPONENTS</span>
  <span class="n">Support</span>

  <span class="n">ADD_TO_COMPONENT</span>
  <span class="n">Cpu0</span>
  <span class="p">)</span>
</pre></div>
</div>
<p>The files <strong>Cpu0TargetMachine.cpp</strong> and <strong>MCTargetDesc/Cpu0MCTargetDesc.cpp</strong>
currently define only an <strong>empty initialization function</strong>,
as no components are being registered at this stage.</p>
<p class="rubric">lbdex/chapters/Chapter2/Cpu0TargetMachine.cpp</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//===--</span> <span class="n">Cpu0TargetMachine</span><span class="o">.</span><span class="n">cpp</span> <span class="o">-</span> <span class="n">Define</span> <span class="n">TargetMachine</span> <span class="k">for</span> <span class="n">Cpu0</span> <span class="o">-------------===//</span>
<span class="o">//</span>
<span class="o">//</span>                     <span class="n">The</span> <span class="n">LLVM</span> <span class="n">Compiler</span> <span class="n">Infrastructure</span>
<span class="o">//</span>
<span class="o">//</span> <span class="n">This</span> <span class="n">file</span> <span class="ow">is</span> <span class="n">distributed</span> <span class="n">under</span> <span class="n">the</span> <span class="n">University</span> <span class="n">of</span> <span class="n">Illinois</span> <span class="n">Open</span> <span class="n">Source</span>
<span class="o">//</span> <span class="n">License</span><span class="o">.</span> <span class="n">See</span> <span class="n">LICENSE</span><span class="o">.</span><span class="n">TXT</span> <span class="k">for</span> <span class="n">details</span><span class="o">.</span>
<span class="o">//</span>
<span class="o">//===----------------------------------------------------------------------===//</span>
<span class="o">//</span>
<span class="o">//</span> <span class="n">Implements</span> <span class="n">the</span> <span class="n">info</span> <span class="n">about</span> <span class="n">Cpu0</span> <span class="n">target</span> <span class="n">spec</span><span class="o">.</span>
<span class="o">//</span>
<span class="o">//===----------------------------------------------------------------------===//</span>

<span class="c1">#include &quot;Cpu0TargetMachine.h&quot;</span>
<span class="c1">#include &quot;Cpu0.h&quot;</span>

<span class="c1">#include &quot;llvm/IR/Attributes.h&quot;</span>
<span class="c1">#include &quot;llvm/IR/Function.h&quot;</span>
<span class="c1">#include &quot;llvm/Support/CodeGen.h&quot;</span>
<span class="c1">#include &quot;llvm/CodeGen/Passes.h&quot;</span>
<span class="c1">#include &quot;llvm/CodeGen/TargetPassConfig.h&quot;</span>
<span class="c1">#include &quot;llvm/Support/TargetRegistry.h&quot;</span>
<span class="c1">#include &quot;llvm/Target/TargetOptions.h&quot;</span>

<span class="n">using</span> <span class="n">namespace</span> <span class="n">llvm</span><span class="p">;</span>

<span class="c1">#define DEBUG_TYPE &quot;cpu0&quot;</span>

<span class="n">extern</span> <span class="s2">&quot;C&quot;</span> <span class="n">void</span> <span class="n">LLVMInitializeCpu0Target</span><span class="p">()</span> <span class="p">{</span>
<span class="p">}</span>

</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter2/MCTargetDesc/Cpu0MCTargetDesc.h</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//===--</span> <span class="n">Cpu0MCTargetDesc</span><span class="o">.</span><span class="n">h</span> <span class="o">-</span> <span class="n">Cpu0</span> <span class="n">Target</span> <span class="n">Descriptions</span> <span class="o">-----------*-</span> <span class="n">C</span><span class="o">++</span> <span class="o">-*-===//</span>
<span class="o">//</span>
<span class="o">//</span>                     <span class="n">The</span> <span class="n">LLVM</span> <span class="n">Compiler</span> <span class="n">Infrastructure</span>
<span class="o">//</span>
<span class="o">//</span> <span class="n">This</span> <span class="n">file</span> <span class="ow">is</span> <span class="n">distributed</span> <span class="n">under</span> <span class="n">the</span> <span class="n">University</span> <span class="n">of</span> <span class="n">Illinois</span> <span class="n">Open</span> <span class="n">Source</span>
<span class="o">//</span> <span class="n">License</span><span class="o">.</span> <span class="n">See</span> <span class="n">LICENSE</span><span class="o">.</span><span class="n">TXT</span> <span class="k">for</span> <span class="n">details</span><span class="o">.</span>
<span class="o">//</span>
<span class="o">//===----------------------------------------------------------------------===//</span>
<span class="o">//</span>
<span class="o">//</span> <span class="n">This</span> <span class="n">file</span> <span class="n">provides</span> <span class="n">Cpu0</span> <span class="n">specific</span> <span class="n">target</span> <span class="n">descriptions</span><span class="o">.</span>
<span class="o">//</span>
<span class="o">//===----------------------------------------------------------------------===//</span>

<span class="c1">#ifndef LLVM_LIB_TARGET_CPU0_MCTARGETDESC_CPU0MCTARGETDESC_H</span>
<span class="c1">#define LLVM_LIB_TARGET_CPU0_MCTARGETDESC_CPU0MCTARGETDESC_H</span>

<span class="c1">#include &quot;Cpu0Config.h&quot;</span>
<span class="c1">#include &quot;llvm/Support/DataTypes.h&quot;</span>

<span class="c1">#include &lt;memory&gt;</span>

<span class="n">namespace</span> <span class="n">llvm</span> <span class="p">{</span>
<span class="k">class</span> <span class="nc">Target</span><span class="p">;</span>
<span class="k">class</span> <span class="nc">Triple</span><span class="p">;</span>

<span class="n">extern</span> <span class="n">Target</span> <span class="n">TheCpu0Target</span><span class="p">;</span>
<span class="n">extern</span> <span class="n">Target</span> <span class="n">TheCpu0elTarget</span><span class="p">;</span>

<span class="p">}</span> <span class="o">//</span> <span class="n">End</span> <span class="n">llvm</span> <span class="n">namespace</span>

<span class="o">//</span> <span class="n">Defines</span> <span class="n">symbolic</span> <span class="n">names</span> <span class="k">for</span> <span class="n">Cpu0</span> <span class="n">registers</span><span class="o">.</span>  <span class="n">This</span> <span class="n">defines</span> <span class="n">a</span> <span class="n">mapping</span> <span class="kn">from</span>
<span class="o">//</span> <span class="n">register</span> <span class="n">name</span> <span class="n">to</span> <span class="n">register</span> <span class="n">number</span><span class="o">.</span>
<span class="c1">#define GET_REGINFO_ENUM</span>
<span class="c1">#include &quot;Cpu0GenRegisterInfo.inc&quot;</span>

<span class="o">//</span> <span class="n">Defines</span> <span class="n">symbolic</span> <span class="n">names</span> <span class="k">for</span> <span class="n">the</span> <span class="n">Cpu0</span> <span class="n">instructions</span><span class="o">.</span>
<span class="c1">#define GET_INSTRINFO_ENUM</span>
<span class="c1">#include &quot;Cpu0GenInstrInfo.inc&quot;</span>

<span class="c1">#define GET_SUBTARGETINFO_ENUM</span>
<span class="c1">#include &quot;Cpu0GenSubtargetInfo.inc&quot;</span>

<span class="c1">#endif</span>

</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter2/MCTargetDesc/Cpu0MCTargetDesc.cpp</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//===--</span> <span class="n">Cpu0MCTargetDesc</span><span class="o">.</span><span class="n">cpp</span> <span class="o">-</span> <span class="n">Cpu0</span> <span class="n">Target</span> <span class="n">Descriptions</span> <span class="o">-------------------===//</span>
<span class="o">//</span>
<span class="o">//</span>                     <span class="n">The</span> <span class="n">LLVM</span> <span class="n">Compiler</span> <span class="n">Infrastructure</span>
<span class="o">//</span>
<span class="o">//</span> <span class="n">This</span> <span class="n">file</span> <span class="ow">is</span> <span class="n">distributed</span> <span class="n">under</span> <span class="n">the</span> <span class="n">University</span> <span class="n">of</span> <span class="n">Illinois</span> <span class="n">Open</span> <span class="n">Source</span>
<span class="o">//</span> <span class="n">License</span><span class="o">.</span> <span class="n">See</span> <span class="n">LICENSE</span><span class="o">.</span><span class="n">TXT</span> <span class="k">for</span> <span class="n">details</span><span class="o">.</span>
<span class="o">//</span>
<span class="o">//===----------------------------------------------------------------------===//</span>
<span class="o">//</span>
<span class="o">//</span> <span class="n">This</span> <span class="n">file</span> <span class="n">provides</span> <span class="n">Cpu0</span> <span class="n">specific</span> <span class="n">target</span> <span class="n">descriptions</span><span class="o">.</span>
<span class="o">//</span>
<span class="o">//===----------------------------------------------------------------------===//</span>

<span class="c1">#include &quot;Cpu0MCTargetDesc.h&quot;</span>
<span class="c1">#include &quot;llvm/MC/MachineLocation.h&quot;</span>
<span class="c1">#include &quot;llvm/MC/MCELFStreamer.h&quot;</span>
<span class="c1">#include &quot;llvm/MC/MCInstrAnalysis.h&quot;</span>
<span class="c1">#include &quot;llvm/MC/MCInstPrinter.h&quot;</span>
<span class="c1">#include &quot;llvm/MC/MCInstrInfo.h&quot;</span>
<span class="c1">#include &quot;llvm/MC/MCRegisterInfo.h&quot;</span>
<span class="c1">#include &quot;llvm/MC/MCSubtargetInfo.h&quot;</span>
<span class="c1">#include &quot;llvm/MC/MCSymbol.h&quot;</span>
<span class="c1">#include &quot;llvm/Support/CommandLine.h&quot;</span>
<span class="c1">#include &quot;llvm/Support/ErrorHandling.h&quot;</span>
<span class="c1">#include &quot;llvm/Support/FormattedStream.h&quot;</span>
<span class="c1">#include &quot;llvm/Support/TargetRegistry.h&quot;</span>

<span class="n">using</span> <span class="n">namespace</span> <span class="n">llvm</span><span class="p">;</span>

<span class="c1">#define GET_INSTRINFO_MC_DESC</span>
<span class="c1">#include &quot;Cpu0GenInstrInfo.inc&quot;</span>

<span class="c1">#define GET_SUBTARGETINFO_MC_DESC</span>
<span class="c1">#include &quot;Cpu0GenSubtargetInfo.inc&quot;</span>

<span class="c1">#define GET_REGINFO_MC_DESC</span>
<span class="c1">#include &quot;Cpu0GenRegisterInfo.inc&quot;</span>

<span class="o">//@</span><span class="mi">2</span> <span class="p">{</span>
<span class="n">extern</span> <span class="s2">&quot;C&quot;</span> <span class="n">void</span> <span class="n">LLVMInitializeCpu0TargetMC</span><span class="p">()</span> <span class="p">{</span>

<span class="p">}</span>
<span class="o">//@</span><span class="mi">2</span> <span class="p">}</span>

</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter2/MCTargetDesc/CMakeLists.txt</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># MCTargetDesc/CMakeLists.txt</span>
<span class="n">add_llvm_component_library</span><span class="p">(</span><span class="n">LLVMCpu0Desc</span>
  <span class="n">Cpu0MCTargetDesc</span><span class="o">.</span><span class="n">cpp</span>

  <span class="n">LINK_COMPONENTS</span>
  <span class="n">MC</span>
  <span class="n">Cpu0Info</span>
  <span class="n">Support</span>

  <span class="n">ADD_TO_COMPONENT</span>
  <span class="n">Cpu0</span>
  <span class="p">)</span>

</pre></div>
</div>
<p>For reference, see <em>“Target Registration”</em> <a class="footnote-reference brackets" href="#target-reg" id="id42" role="doc-noteref"><span class="fn-bracket">[</span>29<span class="fn-bracket">]</span></a>.</p>
</section>
<section id="build-libraries-and-td-files">
<h3><a class="toc-backref" href="#id104" role="doc-backlink">Build Libraries and <cite>.td</cite> Files</a><a class="headerlink" href="#build-libraries-and-td-files" title="Permalink to this heading">¶</a></h3>
<p>Build steps: <a class="reference external" href="https://github.com/Jonathan2251/lbd/blob/master/README.md">https://github.com/Jonathan2251/lbd/blob/master/README.md</a></p>
<p>We set the LLVM source code in:</p>
<blockquote>
<div><p><cite>/Users/Jonathan/llvm/debug/llvm</cite></p>
</div></blockquote>
<p>and perform a debug build in:</p>
<blockquote>
<div><p><cite>/Users/Jonathan/llvm/debug/build</cite></p>
</div></blockquote>
<p>For details on how to build LLVM, refer to <a class="footnote-reference brackets" href="#clang" id="id43" role="doc-noteref"><span class="fn-bracket">[</span>30<span class="fn-bracket">]</span></a>.</p>
<p>In <strong>Appendix A</strong>, we create a copy of the LLVM source directory:</p>
<blockquote>
<div><p><cite>/Users/Jonathan/llvm/debug/llvm</cite></p>
</div></blockquote>
<p>to:</p>
<blockquote>
<div><p><cite>/Users/Jonathan/llvm/test/llvm</cite></p>
</div></blockquote>
<p>for developing the <strong>Cpu0 target backend</strong>.</p>
<ul class="simple">
<li><p>The <cite>llvm/</cite> directory contains the <strong>source code</strong>.</p></li>
<li><p>The <cite>build/</cite> directory is used for the <strong>debug build</strong>.</p></li>
</ul>
<p>### Modifying LLVM for Cpu0</p>
<p>Beyond <cite>llvm/lib/Target/Cpu0</cite>, several files have been modified to support
the <strong>new Cpu0 target</strong>. These modifications include:</p>
<ul class="simple">
<li><p><strong>Adding the target’s ID and name</strong></p></li>
<li><p><strong>Defining relocation records</strong> (as discussed in an earlier section)</p></li>
</ul>
<p>To update your LLVM working copy and apply the modifications, use:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">cp -rf lbdex/llvm/modify/llvm/* &lt;yourllvm/workingcopy/sourcedir&gt;/</span>
</pre></div>
</div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">118-165-78-230:lbd Jonathan$ </span><span class="nb">pwd</span>
<span class="go">/Users/Jonathan/git/lbd</span>
<span class="gp">118-165-78-230:lbd Jonathan$ </span>cp -rf lbdex/llvm/modify/llvm/* ~/llvm/test/llvm/.
<span class="gp">118-165-78-230:lbd Jonathan$ </span>grep -R <span class="s2">&quot;cpu0&quot;</span> ~/llvm/test/llvm/include
<span class="go">llvm/cmake/config-ix.cmake:elseif (LLVM_NATIVE_ARCH MATCHES &quot;cpu0&quot;)</span>
<span class="go">llvm/include/llvm/ADT/Triple.h:#undef cpu0</span>
<span class="go">llvm/include/llvm/ADT/Triple.h:    cpu0,       // For Tutorial Backend Cpu0</span>
<span class="go">llvm/include/llvm/ADT/Triple.h:    cpu0el,</span>
<span class="go">llvm/include/llvm/Support/ELF.h:  EF_CPU0_ARCH_32R2 = 0x70000000, // cpu032r2</span>
<span class="go">llvm/include/llvm/Support/ELF.h:  EF_CPU0_ARCH_64R2 = 0x80000000, // cpu064r2</span>
<span class="go">...</span>
</pre></div>
</div>
<p>Next, configure the Cpu0 example code for <strong>Chapter 2</strong> as follows:</p>
<p class="rubric">~/llvm/test/llvm/lib/Target/Cpu0/Cpu0SetChapter.h</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="cp">#define CH       CH2</span>
</pre></div>
</div>
<p>In addition to configuring the chapter as shown above,
I provide <strong>gen-chapters.sh</strong>, which allows you to retrieve
the code for each chapter as follows:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">118-165-78-230:lbdex Jonathan$ </span><span class="nb">pwd</span>
<span class="go">/Users/Jonathan/git/lbd/lbdex</span>
<span class="gp">118-165-78-230:lbdex Jonathan$ </span>bash gen-chapters.sh
<span class="gp">118-165-78-230:lbdex Jonathan$ </span>ls chapters
<span class="go">Chapter10_1   Chapter11_2     Chapter2        Chapter3_2...</span>
<span class="go">Chapter11_1   Chapter12_1     Chapter3_1      Chapter3_3...</span>
</pre></div>
</div>
<p>Now, run the <code class="docutils literal notranslate"><span class="pre">cmake</span></code> and <code class="docutils literal notranslate"><span class="pre">make</span></code> commands to build <cite>.td</cite> files.
(The following <cite>cmake</cite> command is based on my setup.)</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">118-165-78-230:build Jonathan$ </span>cmake -DCMAKE_CXX_COMPILER<span class="o">=</span>clang++
<span class="go">-DCMAKE_C_COMPILER=clang -DCMAKE_BUILD_TYPE=Debug -G &quot;Unix Makefiles&quot; ../llvm/</span>

<span class="go">-- Targeting Cpu0</span>
<span class="go">...</span>
<span class="go">-- Targeting XCore</span>
<span class="go">-- Configuring done</span>
<span class="go">-- Generating done</span>
<span class="go">-- Build files have been written to: /Users/Jonathan/llvm/test/build</span>

<span class="gp">118-165-78-230:build Jonathan$ </span>make -j4

<span class="gp">118-165-78-230:build Jonathan$</span>
</pre></div>
</div>
<p>After building, you can run the command <code class="docutils literal notranslate"><span class="pre">llc</span> <span class="pre">--version</span></code>
to verify that the Cpu0 backend is available.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">118-165-78-230:build Jonathan$ </span>/Users/Jonathan/llvm/test/
<span class="go">build/bin/llc --version</span>
<span class="go">LLVM (http://llvm.org/):</span>
<span class="go">...</span>
<span class="go">  Registered Targets:</span>
<span class="go">  arm      - ARM</span>
<span class="go">  ...</span>
<span class="go">  cpp      - C++ backend</span>
<span class="go">  cpu0     - Cpu0</span>
<span class="go">  cpu0el   - Cpu0el</span>
<span class="go">...</span>
</pre></div>
</div>
<p>The command <code class="docutils literal notranslate"><span class="pre">llc</span> <span class="pre">--version</span></code> will display the registered targets
<strong>“cpu0”</strong> and <strong>“cpu0el”</strong>,
as defined in <cite>TargetInfo/Cpu0TargetInfo.cpp</cite>
from the previous section, <em>Target Registration</em> <a class="footnote-reference brackets" href="#asadasd" id="id44" role="doc-noteref"><span class="fn-bracket">[</span>31<span class="fn-bracket">]</span></a>.</p>
<p>Now, let’s build the <cite>lbdex/chapters/Chapter2</cite> code as follows:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">118-165-75-57:test Jonathan$ </span><span class="nb">pwd</span>
<span class="go">/Users/Jonathan/test</span>
<span class="gp">118-165-75-57:test Jonathan$ </span>cp -rf lbdex/Cpu0 ~/llvm/test/llvm/lib/Target/.

<span class="gp">118-165-75-57:test Jonathan$ </span><span class="nb">cd</span> ~/llvm/test/build
<span class="gp">118-165-75-57:build Jonathan$ </span><span class="nb">pwd</span>
<span class="go">/Users/Jonathan/llvm/test/build</span>
<span class="gp">118-165-75-57:build Jonathan$ </span>rm -rf *
<span class="gp">118-165-75-57:build Jonathan$ </span>cmake -DCMAKE_CXX_COMPILER<span class="o">=</span>clang++
<span class="go">-DCMAKE_C_COMPILER=clang -DCMAKE_BUILD_TYPE=Debug -DLLVM_TARGETS_TO_BUILD=Cpu0</span>
<span class="go">-G &quot;Unix Makefiles&quot; ../llvm/</span>
<span class="go">...</span>
<span class="go">-- Targeting Cpu0</span>
<span class="go">...</span>
<span class="go">-- Configuring done</span>
<span class="go">-- Generating done</span>
<span class="go">-- Build files have been written to: /Users/Jonathan/llvm/test/build</span>
</pre></div>
</div>
<p>To save time, we build only the Cpu0 target using the option:</p>
<p><code class="docutils literal notranslate"><span class="pre">-DLLVM_TARGETS_TO_BUILD=Cpu0</span></code></p>
<p>After the build, you can find the generated <cite>*.inc</cite> files in:</p>
<p><code class="docutils literal notranslate"><span class="pre">/Users/Jonathan/llvm/test/build/lib/Target/Cpu0</span></code></p>
<p>as shown below:</p>
<p class="rubric">build/lib/Target/Cpu0/Cpu0GenRegisterInfo.inc</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">namespace</span><span class="w"> </span><span class="nn">Cpu0</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="k">enum</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">NoRegister</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">AT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">EPC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">FP</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">GP</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">HI</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">LO</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">6</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">LR</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">7</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">PC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">8</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">SP</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">9</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">SW</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">ZERO</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">11</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">A0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">12</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">A1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">13</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">S0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">14</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">S1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">15</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">T0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">16</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">T1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">17</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">T9</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">18</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">V0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">19</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">V1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">20</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">NUM_TARGET_REGS</span><span class="w">     </span><span class="c1">// 21</span>
<span class="p">};</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="p">...</span><span class="w"></span>
</pre></div>
</div>
<p>These <cite>*.inc</cite> files are generated by <cite>llvm-tblgen</cite> in the
<cite>build/lib/Target/Cpu0</cite> directory, using the Cpu0 backend <cite>*.td</cite> files
as input.</p>
<p>The <cite>llvm-tblgen</cite> tool is invoked by <strong>tablegen</strong>
in <cite>/Users/Jonathan/llvm/test/llvm/lib/Target/Cpu0/CMakeLists.txt</cite>.</p>
<p>These <cite>*.inc</cite> files are later included in Cpu0 backend <cite>.cpp</cite> or <cite>.h</cite> files
and compiled into <cite>.o</cite> files.</p>
<p><strong>TableGen</strong> is a crucial tool, as discussed earlier in the
<em>“.td: LLVM’s Target Description Files”</em> section of this chapter.
For reference, the TableGen documentation is available here:
<a class="footnote-reference brackets" href="#tblgen" id="id45" role="doc-noteref"><span class="fn-bracket">[</span>32<span class="fn-bracket">]</span></a> <a class="footnote-reference brackets" href="#tblgen-langintro" id="id46" role="doc-noteref"><span class="fn-bracket">[</span>33<span class="fn-bracket">]</span></a> <a class="footnote-reference brackets" href="#tblgen-langref" id="id47" role="doc-noteref"><span class="fn-bracket">[</span>34<span class="fn-bracket">]</span></a>.</p>
<p>Now, try running the <cite>llc</cite> command to compile the input file <cite>ch3.cpp</cite>:</p>
<p class="rubric">lbdex/input/ch3.cpp</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">int</span> <span class="n">main</span><span class="p">()</span>
<span class="p">{</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

</pre></div>
</div>
<p>First step, compile it with clang and get output ch3.bc as follows,</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">118-165-78-230:input Jonathan$ </span><span class="nb">pwd</span>
<span class="go">/Users/Jonathan/git/lbd/lbdex/input</span>
<span class="gp">118-165-78-230:input Jonathan$ </span>clang -target mips-unknown-linux-gnu -c
<span class="go">ch3.cpp -emit-llvm -o ch3.bc</span>
</pre></div>
</div>
<p>As shown above, compile C to <cite>.bc</cite> using:</p>
<p><code class="docutils literal notranslate"><span class="pre">clang</span> <span class="pre">-target</span> <span class="pre">mips-unknown-linux-gnu</span></code></p>
<p>since Cpu0 borrows its ABI from MIPS.</p>
<p>Next, convert the bitcode (<cite>.bc</cite>) to a human-readable text format as follows:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">118-165-78-230:test Jonathan$ </span>llvm-dis ch3.bc -o -

<span class="go">// ch3.ll</span>
<span class="go">; ModuleID = &#39;ch3.bc&#39;</span>
<span class="go">target datalayout = &quot;e-p:64:64:64-i1:8:8-i8:8:8-i16:16:16-i32:32:32-i64:64:64-f3</span>
<span class="go">2:32:32-f64:64:64-v64:64:64-v128:128:128-a0:0:64-s0:64:64-f80:128:128-n8:16:32:6</span>
<span class="go">4-S128&quot;</span>
<span class="go">target triple = &quot;mips-unknown-linux-gnu&quot;</span>

<span class="go">define i32 @main() nounwind uwtable {</span>
<span class="gp">  %</span><span class="nv">1</span> <span class="o">=</span> alloca i32, align <span class="m">4</span>
<span class="go">  store i32 0, i32* %1</span>
<span class="go">  ret i32 0</span>
<span class="go">}</span>
</pre></div>
</div>
<p>Now, compiling <cite>ch3.bc</cite> will result in the following error message:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">118-165-78-230:input Jonathan$ </span>/Users/Jonathan/llvm/test/build/
<span class="go">bin/llc -march=cpu0 -relocation-model=pic -filetype=asm ch3.bc -o</span>
<span class="go">ch3.cpu0.s</span>
<span class="go">...</span>
<span class="go">... Assertion `target.get() &amp;&amp; &quot;Could not allocate target machine!&quot;&#39; failed</span>
<span class="go">...</span>
</pre></div>
</div>
<p>At this point, we have completed <em>Target Registration</em> for the Cpu0 backend.
The <cite>llc</cite> compiler command now recognizes the Cpu0 backend.</p>
<p>Currently, we have only defined the target <cite>.td</cite> files (<cite>Cpu0.td</cite>,
<cite>Cpu0Other.td</cite>, <cite>Cpu0RegisterInfo.td</cite>, etc.).
According to the LLVM structure, we need to define our target machine
and include these <cite>.td</cite> files.</p>
<p>The error message indicates that the target machine is not yet defined.
This book follows a step-by-step approach to backend development.
You can review the <strong>hundreds</strong> of lines in the Chapter 2 example code
to understand how <em>Target Registration</em> is implemented.</p>
</section>
</section>
<section id="options-for-llc-debugging">
<h2><a class="toc-backref" href="#id105" role="doc-backlink">Options for <cite>llc</cite> Debugging</a><a class="headerlink" href="#options-for-llc-debugging" title="Permalink to this heading">¶</a></h2>
<p>Run the following command to see hidden <cite>llc</cite> options:</p>
<p><code class="docutils literal notranslate"><span class="pre">llc</span> <span class="pre">--help-hidden</span></code></p>
<p>The following <cite>llc</cite> options require an input <cite>.bc</cite> or <cite>.ll</cite> file:</p>
<ul>
<li><p><cite>-debug</cite></p></li>
<li><p><cite>-debug-pass=Structure</cite></p></li>
<li><p><cite>-print-after-all</cite>, <cite>-print-before-all</cite></p></li>
<li><p><cite>-print-before=”pass”</cite> and <cite>-print-after=”pass”</cite></p>
<p>Example:
<code class="docutils literal notranslate"><span class="pre">-print-before=&quot;postra-machine-sink&quot;</span> <span class="pre">-print-after=&quot;postra-machine-sink&quot;</span></code></p>
<p>The pass name can be obtained as follows:</p>
</li>
</ul>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">CodeGen % pwd</span>
<span class="go">~/llvm/debug/llvm/lib/CodeGen</span>
<span class="go">CodeGen % grep -R &quot;INITIALIZE_PASS&quot; |grep sink</span>
<span class="go">./MachineSink.cpp:INITIALIZE_PASS(PostRAMachineSinking, &quot;postra-machine-sink&quot;,</span>
</pre></div>
</div>
<ul class="simple">
<li><p><cite>-view-dag-combine1-dags</cite>
Displays the DAG after being built, before the first optimization pass.</p></li>
<li><p><cite>-view-legalize-dags</cite>
Displays the DAG before legalization.</p></li>
<li><p><cite>-view-dag-combine2-dags</cite>
Displays the DAG before the second optimization pass.</p></li>
<li><p><cite>-view-isel-dags</cite>
Displays the DAG before the Select phase.</p></li>
<li><p><cite>-view-sched-dags</cite>
Displays the DAG before scheduling.</p></li>
<li><p><cite>-march=&lt;string&gt;</cite>
Specifies the target architecture (e.g., <cite>-march=mips</cite>).</p></li>
<li><p><cite>-relocation-model=static/pic</cite>
Sets the relocation model.</p></li>
<li><p><cite>-filetype=asm/obj</cite>
Specifies the output file type (assembly or object).</p></li>
</ul>
<p>You can use <cite>F.dump()</cite> in the code, where <cite>F</cite> is an instance of the <cite>Function</cite>
class, to inspect transformations in <cite>llvm/lib/Transformation</cite>.</p>
</section>
<section id="opt-debugging-options">
<h2><a class="toc-backref" href="#id106" role="doc-backlink"><cite>opt</cite> Debugging Options</a><a class="headerlink" href="#opt-debugging-options" title="Permalink to this heading">¶</a></h2>
<p>Check available options using:</p>
<p><code class="docutils literal notranslate"><span class="pre">opt</span> <span class="pre">--help-hidden</span></code></p>
<p>Refer to LLVM passes documentation <a class="footnote-reference brackets" href="#llvm-passes" id="id48" role="doc-noteref"><span class="fn-bracket">[</span>35<span class="fn-bracket">]</span></a>. Examples:</p>
<ul class="simple">
<li><p><cite>opt -dot-cfg input.ll</cite>
Prints the CFG of a function to a <cite>.dot</cite> file.</p></li>
<li><p><cite>-dot-cfg-only</cite>
Prints the CFG to a <cite>.dot</cite> file without function bodies.</p></li>
</ul>
<aside class="footnote brackets" id="java-cpp" role="note">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id2">1</a><span class="fn-bracket">]</span></span>
<p><a class="reference external" href="https://en.wikipedia.org/wiki/Comparison_of_Java_and_C%2B%2B">https://en.wikipedia.org/wiki/Comparison_of_Java_and_C%2B%2B</a></p>
</aside>
<aside class="footnote brackets" id="cpu0-chinese" role="note">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id3">2</a><span class="fn-bracket">]</span></span>
<p>Original Cpu0 architecture and ISA details (Chinese). <a class="reference external" href="http://ccckmit.wikidot.com/ocs:cpu0">http://ccckmit.wikidot.com/ocs:cpu0</a></p>
</aside>
<aside class="footnote brackets" id="cpu0-english" role="note">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id4">3</a><span class="fn-bracket">]</span></span>
<p>English translation of Cpu0 description. <a class="reference external" href="http://translate.google.com.tw/translate?js=n&amp;prev=_t&amp;hl=zh-TW&amp;ie=UTF-8&amp;layout=2&amp;eotf=1&amp;sl=zh-CN&amp;tl=en&amp;u=http://ccckmit.wikidot.com/ocs:cpu0">http://translate.google.com.tw/translate?js=n&amp;prev=_t&amp;hl=zh-TW&amp;ie=UTF-8&amp;layout=2&amp;eotf=1&amp;sl=zh-CN&amp;tl=en&amp;u=http://ccckmit.wikidot.com/ocs:cpu0</a></p>
</aside>
<aside class="footnote brackets" id="lb-note" role="note">
<span class="label"><span class="fn-bracket">[</span>4<span class="fn-bracket">]</span></span>
<span class="backrefs">(<a role="doc-backlink" href="#id7">1</a>,<a role="doc-backlink" href="#id8">2</a>,<a role="doc-backlink" href="#id9">3</a>,<a role="doc-backlink" href="#id10">4</a>)</span>
<p>The difference between LB and LBu is signed and unsigned byte value expand to a word size. For example, After LB Ra, [Rb+Cx], Ra is 0xffffff80(= -128) if byte [Rb+Cx] is 0x80; Ra is 0x0000007f(= 127) if byte [Rb+Cx] is 0x7f. After LBu Ra, [Rb+Cx], Ra is 0x00000080(= 128) if byte [Rb+Cx] is 0x80; Ra is 0x0000007f(= 127) if byte [Rb+Cx] is 0x7f. Difference between LH and LHu is similar.</p>
</aside>
<aside class="footnote brackets" id="u-note" role="note">
<span class="label"><span class="fn-bracket">[</span>5<span class="fn-bracket">]</span></span>
<span class="backrefs">(<a role="doc-backlink" href="#id11">1</a>,<a role="doc-backlink" href="#id12">2</a>,<a role="doc-backlink" href="#id13">3</a>,<a role="doc-backlink" href="#id14">4</a>)</span>
<p>The only difference between ADDu instruction and the ADD instruction is that the ADDU instruction never causes an Integer Overflow exception. SUBu and SUB is similar.</p>
</aside>
<aside class="footnote brackets" id="cond-note" role="note">
<span class="label"><span class="fn-bracket">[</span>6<span class="fn-bracket">]</span></span>
<span class="backrefs">(<a role="doc-backlink" href="#id17">1</a>,<a role="doc-backlink" href="#id18">2</a>)</span>
<p>CMP is signed-compare while CMPu is unsigned. Conditions include the following comparisons: &gt;, &gt;=, ==, !=, &lt;=, &lt;. SW is actually set by the subtraction of the two register operands, and the flags indicate which conditions are present.</p>
</aside>
<aside class="footnote brackets" id="sra-note" role="note">
<span class="label"><span class="fn-bracket">[</span>7<span class="fn-bracket">]</span></span>
<span class="backrefs">(<a role="doc-backlink" href="#id15">1</a>,<a role="doc-backlink" href="#id16">2</a>)</span>
<p>Rb ‘&gt;&gt; Cx, Rb ‘&gt;&gt; Rc: Shift with signed bit remain.</p>
</aside>
<aside class="footnote brackets" id="call-note" role="note">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id19">8</a><span class="fn-bracket">]</span></span>
<p>jsub cx is direct call for 24 bits value of cx while jalr $rb is indirect call for 32 bits value of register $rb.</p>
</aside>
<aside class="footnote brackets" id="jr-note" role="note">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id20">9</a><span class="fn-bracket">]</span></span>
<p>Both JR and RET has same opcode (actually they are the same instruction for Cpu0 hardware). When user writes “jr $t9” meaning it jumps to address of register $t9; when user writes “jr $lr” meaning it jump back to the caller function (since $lr is the return address). For user read ability, Cpu0 prints “ret $lr” instead of “jr $lr”.</p>
</aside>
<aside class="footnote brackets" id="aosa-book" role="note">
<span class="label"><span class="fn-bracket">[</span>10<span class="fn-bracket">]</span></span>
<span class="backrefs">(<a role="doc-backlink" href="#id1">1</a>,<a role="doc-backlink" href="#id22">2</a>)</span>
<p>Chris Lattner, <strong>LLVM</strong>. Published in The Architecture of Open Source Applications. <a class="reference external" href="http://www.aosabook.org/en/llvm.html">http://www.aosabook.org/en/llvm.html</a></p>
</aside>
<aside class="footnote brackets" id="chapters-ex" role="note">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id39">11</a><span class="fn-bracket">]</span></span>
<p><a class="reference external" href="http://jonathan2251.github.io/lbd/doc.html#generate-cpu0-document">http://jonathan2251.github.io/lbd/doc.html#generate-cpu0-document</a></p>
</aside>
<aside class="footnote brackets" id="codegen" role="note">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id23">12</a><span class="fn-bracket">]</span></span>
<p><a class="reference external" href="http://llvm.org/docs/CodeGenerator.html">http://llvm.org/docs/CodeGenerator.html</a></p>
</aside>
<aside class="footnote brackets" id="langref" role="note">
<span class="label"><span class="fn-bracket">[</span>13<span class="fn-bracket">]</span></span>
<span class="backrefs">(<a role="doc-backlink" href="#id5">1</a>,<a role="doc-backlink" href="#id6">2</a>,<a role="doc-backlink" href="#id24">3</a>)</span>
<p><a class="reference external" href="http://llvm.org/docs/LangRef.html">http://llvm.org/docs/LangRef.html</a></p>
</aside>
<aside class="footnote brackets" id="cmu-rac" role="note">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id25">14</a><span class="fn-bracket">]</span></span>
<p><a class="reference external" href="https://www.cs.cmu.edu/afs/cs/academic/class/15745-s16/www/lectures/L23-Register-Coalescing.pdf">https://www.cs.cmu.edu/afs/cs/academic/class/15745-s16/www/lectures/L23-Register-Coalescing.pdf</a></p>
</aside>
<aside class="footnote brackets" id="ra-wiki" role="note">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id26">15</a><span class="fn-bracket">]</span></span>
<p><a class="reference external" href="https://en.wikipedia.org/wiki/Register_allocation">https://en.wikipedia.org/wiki/Register_allocation</a></p>
</aside>
<aside class="footnote brackets" id="dragonbooks-10-2-3" role="note">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id21">16</a><span class="fn-bracket">]</span></span>
<p>Refer section 10.2.3 of book Compilers: Principles,
Techniques, and Tools (2nd Edition)</p>
</aside>
<aside class="footnote brackets" id="gnu" role="note">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id27">17</a><span class="fn-bracket">]</span></span>
<p><a class="reference external" href="https://en.wikipedia.org/wiki/GNU_Compiler_Collection">https://en.wikipedia.org/wiki/GNU_Compiler_Collection</a></p>
</aside>
<aside class="footnote brackets" id="gcc-frontend" role="note">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id28">18</a><span class="fn-bracket">]</span></span>
<p><a class="reference external" href="https://en.wikipedia.org/wiki/GNU_Compiler_Collection#Front_ends">https://en.wikipedia.org/wiki/GNU_Compiler_Collection#Front_ends</a></p>
</aside>
<aside class="footnote brackets" id="generic" role="note">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id29">19</a><span class="fn-bracket">]</span></span>
<p><a class="reference external" href="https://gcc.gnu.org/onlinedocs/gccint/GENERIC.html">https://gcc.gnu.org/onlinedocs/gccint/GENERIC.html</a></p>
</aside>
<aside class="footnote brackets" id="gimple" role="note">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id30">20</a><span class="fn-bracket">]</span></span>
<p><a class="reference external" href="https://gcc.gnu.org/onlinedocs/gccint/GIMPLE.html">https://gcc.gnu.org/onlinedocs/gccint/GIMPLE.html</a></p>
</aside>
<aside class="footnote brackets" id="rtl" role="note">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id31">21</a><span class="fn-bracket">]</span></span>
<p><a class="reference external" href="https://gcc.gnu.org/onlinedocs/gccint/RTL.html">https://gcc.gnu.org/onlinedocs/gccint/RTL.html</a></p>
</aside>
<aside class="footnote brackets" id="md" role="note">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id32">22</a><span class="fn-bracket">]</span></span>
<p><a class="reference external" href="https://gcc.gnu.org/onlinedocs/gccint/Machine-Desc.html#Machine-Desc">https://gcc.gnu.org/onlinedocs/gccint/Machine-Desc.html#Machine-Desc</a></p>
</aside>
<aside class="footnote brackets" id="llvm-ir-vs-gimple" role="note">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id33">23</a><span class="fn-bracket">]</span></span>
<p><a class="reference external" href="https://stackoverflow.com/questions/40799696/how-is-gcc-ir-different-from-llvm-ir/40802063">https://stackoverflow.com/questions/40799696/how-is-gcc-ir-different-from-llvm-ir/40802063</a></p>
</aside>
<aside class="footnote brackets" id="null-pointer-ex" role="note">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id34">24</a><span class="fn-bracket">]</span></span>
<p><a class="reference external" href="https://github.com/Jonathan2251/lbd/tree/master/References/null_pointer.cpp">https://github.com/Jonathan2251/lbd/tree/master/References/null_pointer.cpp</a> is an example.</p>
</aside>
<aside class="footnote brackets" id="null-pointer" role="note">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id35">25</a><span class="fn-bracket">]</span></span>
<p>Dereferencing a NULL Pointer:
contrary to popular belief, dereferencing a null pointer in C is undefined.
It is not defined to trap, and if you mmap a page at 0, it is not defined to access that page.
This falls out of the rules that forbid dereferencing wild pointers and the use of NULL as a sentinel,
from <a class="reference external" href="http://blog.llvm.org/2011/05/what-every-c-programmer-should-know.html">http://blog.llvm.org/2011/05/what-every-c-programmer-should-know.html</a>.
As link, <a class="reference external" href="https://blog.llvm.org/2011/05/what-every-c-programmer-should-know_14.html">https://blog.llvm.org/2011/05/what-every-c-programmer-should-know_14.html</a>.
In this case, the developer forgot to call “set”, did not crash with a null pointer dereference,
and their code broke when someone else did a debug build.</p>
</aside>
<aside class="footnote brackets" id="cfg-wiki" role="note">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id36">26</a><span class="fn-bracket">]</span></span>
<p><a class="reference external" href="https://en.wikipedia.org/wiki/Control-flow_graph">https://en.wikipedia.org/wiki/Control-flow_graph</a></p>
</aside>
<aside class="footnote brackets" id="dragonbooks-8-5" role="note">
<span class="label"><span class="fn-bracket">[</span>27<span class="fn-bracket">]</span></span>
<span class="backrefs">(<a role="doc-backlink" href="#id37">1</a>,<a role="doc-backlink" href="#id38">2</a>)</span>
<p>Refer section 8.5 of book Compilers: Principles,
Techniques, and Tools (2nd Edition)</p>
</aside>
<aside class="footnote brackets" id="cmake" role="note">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id41">28</a><span class="fn-bracket">]</span></span>
<p><a class="reference external" href="http://llvm.org/docs/CMake.html">http://llvm.org/docs/CMake.html</a></p>
</aside>
<aside class="footnote brackets" id="target-reg" role="note">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id42">29</a><span class="fn-bracket">]</span></span>
<p><a class="reference external" href="http://llvm.org/docs/WritingAnLLVMBackend.html#target-registration">http://llvm.org/docs/WritingAnLLVMBackend.html#target-registration</a></p>
</aside>
<aside class="footnote brackets" id="clang" role="note">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id43">30</a><span class="fn-bracket">]</span></span>
<p><a class="reference external" href="http://clang.llvm.org/get_started.html">http://clang.llvm.org/get_started.html</a></p>
</aside>
<aside class="footnote brackets" id="asadasd" role="note">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id44">31</a><span class="fn-bracket">]</span></span>
<p><a class="reference external" href="http://jonathan2251.github.io/lbd/llvmstructure.html#target-registration">http://jonathan2251.github.io/lbd/llvmstructure.html#target-registration</a></p>
</aside>
<aside class="footnote brackets" id="tblgen" role="note">
<span class="label"><span class="fn-bracket">[</span>32<span class="fn-bracket">]</span></span>
<span class="backrefs">(<a role="doc-backlink" href="#id40">1</a>,<a role="doc-backlink" href="#id45">2</a>)</span>
<p><a class="reference external" href="http://llvm.org/docs/TableGen/index.html">http://llvm.org/docs/TableGen/index.html</a></p>
</aside>
<aside class="footnote brackets" id="tblgen-langintro" role="note">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id46">33</a><span class="fn-bracket">]</span></span>
<p><a class="reference external" href="http://llvm.org/docs/TableGen/LangIntro.html">http://llvm.org/docs/TableGen/LangIntro.html</a></p>
</aside>
<aside class="footnote brackets" id="tblgen-langref" role="note">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id47">34</a><span class="fn-bracket">]</span></span>
<p><a class="reference external" href="http://llvm.org/docs/TableGen/LangRef.html">http://llvm.org/docs/TableGen/LangRef.html</a></p>
</aside>
<aside class="footnote brackets" id="llvm-passes" role="note">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id48">35</a><span class="fn-bracket">]</span></span>
<p><a class="reference external" href="https://llvm.org/docs/Passes.html">https://llvm.org/docs/Passes.html</a></p>
</aside>
</section>
</section>


      </div>
      <div class="bottomnav" role="navigation" aria-label="bottom navigation">
      
        <p>
        «&#160;&#160;<a href="about.html">About</a>
        &#160;&#160;::&#160;&#160;
        <a class="uplink" href="index.html">Contents</a>
        &#160;&#160;::&#160;&#160;
        <a href="backendstructure.html">Backend structure</a>&#160;&#160;»
        </p>

      </div>

    <div class="footer" role="contentinfo">
        &#169; Copyright 2016, Chen Chung-Shu.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 5.0.2.
    </div>
  </body>
</html>