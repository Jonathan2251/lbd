
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>Global Variables &#8212; Tutorial: Creating an LLVM Backend for the Cpu0 Architecture</title>
    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="_static/haiku.css" />
    <link rel="stylesheet" type="text/css" href="_static/graphviz.css" />
    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="_static/doctools.js"></script>
    <link rel="author" title="About these documents" href="about.html" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Other data type" href="othertype.html" />
    <link rel="prev" title="Generating object files" href="genobj.html" /> 
  </head><body>
      <div class="header" role="banner"><h1 class="heading"><a href="index.html">
          <span>Tutorial: Creating an LLVM Backend for the Cpu0 Architecture</span></a></h1>
        <h2 class="heading"><span>Global Variables</span></h2>
      </div>
      <div class="topnav" role="navigation" aria-label="top navigation">
      
        <p>
        «&#160;&#160;<a href="genobj.html">Generating object files</a>
        &#160;&#160;::&#160;&#160;
        <a class="uplink" href="index.html">Contents</a>
        &#160;&#160;::&#160;&#160;
        <a href="othertype.html">Other data type</a>&#160;&#160;»
        </p>

      </div>
      <div class="content" role="main">
        
        
  <section id="global-variables">
<span id="sec-globalvars"></span><h1>Global Variables<a class="headerlink" href="#global-variables" title="Permalink to this heading">¶</a></h1>
<nav class="contents local" id="contents">
<ul class="simple">
<li><p><a class="reference internal" href="#cpu0-global-variable-options" id="id12">Cpu0 Global Variable Options</a></p></li>
<li><p><a class="reference internal" href="#static-mode" id="id13">Static mode</a></p>
<ul>
<li><p><a class="reference internal" href="#data-or-bss" id="id14">data or bss</a></p></li>
<li><p><a class="reference internal" href="#sdata-or-sbss" id="id15">sdata or sbss</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#pic-mode" id="id16">pic mode</a></p>
<ul>
<li><p><a class="reference internal" href="#id2" id="id17">sdata or sbss</a></p></li>
<li><p><a class="reference internal" href="#id4" id="id18">data or bss</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#global-variable-print-support" id="id19">Global variable print support</a></p></li>
<li><p><a class="reference internal" href="#summary" id="id20">Summary</a></p></li>
</ul>
</nav>
<p>In the last three chapters, we accessed only local variables. This chapter
focuses on translating global variable access.</p>
<p>The global variable DAG translation differs from previous DAG translations
discussed so far. It creates IR DAG nodes at runtime in backend C++ code based
on the <code class="docutils literal notranslate"><span class="pre">llc</span> <span class="pre">-relocation-model</span></code> option. In contrast, other DAGs translate IR
DAGs directly to Machine DAGs according to the input IR DAG files (except for
the Pseudo instruction RetLR used in Chapter3_4).</p>
<p>Readers should focus on how to add code for creating DAG nodes at runtime and
how to define pattern matching in <code class="docutils literal notranslate"><span class="pre">.td</span></code> files for these runtime-created DAG
nodes. Additionally, if your backend has assembly directives (macros) related
to global variables, ensure that the machine instruction printing function
handles them correctly.</p>
<p>Chapter6_1/ introduces global variable support. Let’s compile <code class="docutils literal notranslate"><span class="pre">ch6_1.cpp</span></code>
with this version first, then review the code changes.</p>
<p class="rubric">lbdex/input/ch6_1.cpp</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">int</span> <span class="n">gStart</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
<span class="nb">int</span> <span class="n">gI</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
<span class="nb">int</span> <span class="n">test_global</span><span class="p">()</span>
<span class="p">{</span>
  <span class="nb">int</span> <span class="n">c</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

  <span class="n">c</span> <span class="o">=</span> <span class="n">gI</span><span class="p">;</span>

  <span class="k">return</span> <span class="n">c</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">118-165-78-166:input Jonathan$ </span>llvm-dis ch6_1.bc -o -
<span class="go">...</span>
<span class="go">@gStart = global i32 2, align 4</span>
<span class="go">@gI = global i32 100, align 4</span>

<span class="go">define i32 @_Z3funv() nounwind uwtable ssp {</span>
<span class="gp">  %</span><span class="nv">1</span> <span class="o">=</span> alloca i32, align <span class="m">4</span>
<span class="gp">  %</span><span class="nv">c</span> <span class="o">=</span> alloca i32, align <span class="m">4</span>
<span class="go">  store i32 0, i32* %1</span>
<span class="go">  store i32 0, i32* %c, align 4</span>
<span class="gp">  %</span><span class="nv">2</span> <span class="o">=</span> load i32* @gI, align <span class="m">4</span>
<span class="go">  store i32 %2, i32* %c, align 4</span>
<span class="gp">  %</span><span class="nv">3</span> <span class="o">=</span> load i32* %c, align <span class="m">4</span>
<span class="go">  ret i32 %3</span>
<span class="go">}</span>
</pre></div>
</div>
<section id="cpu0-global-variable-options">
<h2><a class="toc-backref" href="#id12" role="doc-backlink">Cpu0 Global Variable Options</a><a class="headerlink" href="#cpu0-global-variable-options" title="Permalink to this heading">¶</a></h2>
<p>Like MIPS, Cpu0 supports both static and PIC modes. There are two different
layouts for global variables in static mode, controlled by the option
<code class="docutils literal notranslate"><span class="pre">cpu0-use-small-section</span></code>.</p>
<p>Chapter6_1/ introduces global variable translation. Let’s run Chapter6_1/
with <code class="docutils literal notranslate"><span class="pre">ch6_1.cpp</span></code> using four different options to trace the DAGs and Cpu0
instructions:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">llc</span> <span class="pre">-relocation-model=static</span> <span class="pre">-cpu0-use-small-section=false</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">llc</span> <span class="pre">-relocation-model=static</span> <span class="pre">-cpu0-use-small-section=true</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">llc</span> <span class="pre">-relocation-model=pic</span> <span class="pre">-cpu0-use-small-section=false</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">llc</span> <span class="pre">-relocation-model=pic</span> <span class="pre">-cpu0-use-small-section=true</span></code></p></li>
</ul>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">118-165-78-166:input Jonathan$ </span>clang -target mips-unknown-linux-gnu -c
<span class="go">ch6_1.cpp -emit-llvm -o ch6_1.bc</span>
<span class="gp">118-165-78-166:input Jonathan$ </span>/Users/Jonathan/llvm/test/build/
<span class="go">bin/llc -march=cpu0 -relocation-model=static -cpu0-use-small-section=false</span>
<span class="go">-filetype=asm -debug ch6_1.bc -o -</span>

<span class="go">...</span>
<span class="go">Type-legalized selection DAG: BB#0 &#39;_Z11test_globalv:&#39;</span>
<span class="go">SelectionDAG has 12 nodes:</span>
<span class="go">  ...</span>
<span class="go">      0x7ffd5902cc10: &lt;multiple use&gt;</span>
<span class="go">    0x7ffd5902cf10: ch = store 0x7ffd5902cd10, 0x7ffd5902ca10, 0x7ffd5902ce10,</span>
<span class="go">    0x7ffd5902cc10&lt;ST4[%c]&gt; [ORD=2] [ID=-3]</span>

<span class="go">    0x7ffd5902d010: i32 = GlobalAddress&lt;i32* @gI&gt; 0 [ORD=3] [ID=-3]</span>

<span class="go">    0x7ffd5902cc10: &lt;multiple use&gt;</span>
<span class="go">  0x7ffd5902d110: i32,ch = load 0x7ffd5902cf10, 0x7ffd5902d010,</span>
<span class="go">  0x7ffd5902cc10&lt;LD4[@gI]&gt; [ORD=3] [ID=-3]</span>
<span class="go">  ...</span>

<span class="go">Legalized selection DAG: BB#0 &#39;_Z11test_globalv:&#39;</span>
<span class="go">SelectionDAG has 16 nodes:</span>
<span class="go">  ...</span>
<span class="go">      0x7ffd5902cc10: &lt;multiple use&gt;</span>
<span class="go">    0x7ffd5902cf10: ch = store 0x7ffd5902cd10, 0x7ffd5902ca10, 0x7ffd5902ce10,</span>
<span class="go">    0x7ffd5902cc10&lt;ST4[%c]&gt; [ORD=2] [ID=8]</span>

<span class="go">        0x7ffd5902d310: i32 = TargetGlobalAddress&lt;i32* @gI&gt; 0 [TF=5]</span>

<span class="go">      0x7ffd5902d710: i32 = Cpu0ISD::Hi 0x7ffd5902d310</span>

<span class="go">        0x7ffd5902d610: i32 = TargetGlobalAddress&lt;i32* @gI&gt; 0 [TF=6]</span>

<span class="go">      0x7ffd5902d810: i32 = Cpu0ISD::Lo 0x7ffd5902d610</span>

<span class="go">    0x7ffd5902fe10: i32 = add 0x7ffd5902d710, 0x7ffd5902d810</span>

<span class="go">    0x7ffd5902cc10: &lt;multiple use&gt;</span>
<span class="go">  0x7ffd5902d110: i32,ch = load 0x7ffd5902cf10, 0x7ffd5902fe10,</span>
<span class="go">  0x7ffd5902cc10&lt;LD4[@gI]&gt; [ORD=3] [ID=9]</span>
<span class="go">  ...</span>
<span class="go">  lui $2, %hi(gI)</span>
<span class="go">  ori $2, $2, %lo(gI)</span>
<span class="go">      ld      $2, 0($2)</span>
<span class="go">      ...</span>
<span class="go">      .type   gStart,@object          # @gStart</span>
<span class="go">      .data</span>
<span class="go">      .globl  gStart</span>
<span class="go">      .align  2</span>
<span class="go">gStart:</span>
<span class="go">      .4byte  2                       # 0x2</span>
<span class="go">      .size   gStart, 4</span>

<span class="go">      .type   gI,@object              # @gI</span>
<span class="go">      .globl  gI</span>
<span class="go">      .align  2</span>
<span class="go">gI:</span>
<span class="go">      .4byte  100                     # 0x64</span>
<span class="go">      .size   gI, 4</span>
</pre></div>
</div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">118-165-78-166:input Jonathan$ </span>/Users/Jonathan/llvm/test/build/
<span class="go">bin/llc -march=cpu0 -relocation-model=static -cpu0-use-small-section=true</span>
<span class="go">-filetype=asm -debug ch6_1.bc -o -</span>

<span class="go">...</span>
<span class="go">Type-legalized selection DAG: BB#0 &#39;_Z11test_globalv:&#39;</span>
<span class="go">SelectionDAG has 12 nodes:</span>
<span class="go">  ...</span>
<span class="go">      0x7fc5f382cc10: &lt;multiple use&gt;</span>
<span class="go">    0x7fc5f382cf10: ch = store 0x7fc5f382cd10, 0x7fc5f382ca10, 0x7fc5f382ce10,</span>
<span class="go">    0x7fc5f382cc10&lt;ST4[%c]&gt; [ORD=2] [ID=-3]</span>

<span class="go">    0x7fc5f382d010: i32 = GlobalAddress&lt;i32* @gI&gt; 0 [ORD=3] [ID=-3]</span>

<span class="go">    0x7fc5f382cc10: &lt;multiple use&gt;</span>
<span class="go">  0x7fc5f382d110: i32,ch = load 0x7fc5f382cf10, 0x7fc5f382d010,</span>
<span class="go">  0x7fc5f382cc10&lt;LD4[@gI]&gt; [ORD=3] [ID=-3]</span>
<span class="go">  ...</span>
<span class="go">Legalized selection DAG: BB#0 &#39;_Z11test_globalv:&#39;</span>
<span class="go">SelectionDAG has 15 nodes:</span>
<span class="go">  ...</span>
<span class="go">      0x7fc5f382cc10: &lt;multiple use&gt;</span>
<span class="go">    0x7fc5f382cf10: ch = store 0x7fc5f382cd10, 0x7fc5f382ca10, 0x7fc5f382ce10,</span>
<span class="go">    0x7fc5f382cc10&lt;ST4[%c]&gt; [ORD=2] [ID=8]</span>

<span class="go">      0x7fc5f382d710: i32 = register %GP</span>

<span class="go">        0x7fc5f382d310: i32 = TargetGlobalAddress&lt;i32* @gI&gt; 0 [TF=4]</span>

<span class="go">      0x7fc5f382d610: i32 = Cpu0ISD::GPRel 0x7fc5f382d310</span>

<span class="go">    0x7fc5f382d810: i32 = add 0x7fc5f382d710, 0x7fc5f382d610</span>

<span class="go">    0x7fc5f382cc10: &lt;multiple use&gt;</span>
<span class="go">  0x7fc5f382d110: i32,ch = load 0x7fc5f382cf10, 0x7fc5f382d810,</span>
<span class="go">  0x7fc5f382cc10&lt;LD4[@gI]&gt; [ORD=3] [ID=9]</span>
<span class="go">  ...</span>

<span class="go">      ori     $2, $gp, %gp_rel(gI)</span>
<span class="go">      ld      $2, 0($2)</span>
<span class="go">      ...</span>
<span class="go">      .type   gStart,@object          # @gStart</span>
<span class="go">      .section        .sdata,&quot;aw&quot;,@progbits</span>
<span class="go">      .globl  gStart</span>
<span class="go">      .align  2</span>
<span class="go">gStart:</span>
<span class="go">      .4byte  2                       # 0x2</span>
<span class="go">      .size   gStart, 4</span>

<span class="go">      .type   gI,@object              # @gI</span>
<span class="go">      .globl  gI</span>
<span class="go">      .align  2</span>
<span class="go">gI:</span>
<span class="go">      .4byte  100                     # 0x64</span>
<span class="go">      .size   gI, 4</span>
</pre></div>
</div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">118-165-78-166:input Jonathan$ </span>/Users/Jonathan/llvm/test/build/
<span class="go">bin/llc -march=cpu0 -relocation-model=pic -cpu0-use-small-section=false</span>
<span class="go">-filetype=asm -debug ch6_1.bc -o -</span>

<span class="go">  ...</span>
<span class="go">Type-legalized selection DAG: BB#0 &#39;_Z11test_globalv:&#39;</span>
<span class="go">SelectionDAG has 11 nodes:</span>
<span class="go">  ...</span>
<span class="go">      0x7fe03c02e010: &lt;multiple use&gt;</span>
<span class="go">    0x7fe03c02e118: ch = store 0x7fe03b50dee0, 0x7fe03c02de00, 0x7fe03c02df08,</span>
<span class="go">    0x7fe03c02e010&lt;ST4[%c]&gt; [ORD=3] [ID=-3]</span>

<span class="go">    0x7fe03c02e220: i32 = GlobalAddress&lt;i32* @gI&gt; 0 [ORD=4] [ID=-3]</span>

<span class="go">    0x7fe03c02e010: &lt;multiple use&gt;</span>
<span class="go">  0x7fe03c02e328: i32,ch = load 0x7fe03c02e118, 0x7fe03c02e220,</span>
<span class="go">  0x7fe03c02e010&lt;LD4[@gI]&gt; [ORD=4] [ID=-3]</span>
<span class="go">  ...</span>
<span class="go">Legalized selection DAG: BB#0 &#39;_Z11test_globalv:&#39;</span>
<span class="go">SelectionDAG has 15 nodes:</span>
<span class="go">  ...</span>
<span class="go">      0x7fe03c02e010: &lt;multiple use&gt;</span>
<span class="go">    0x7fe03c02e118: ch = store 0x7fe03b50dee0, 0x7fe03c02de00, 0x7fe03c02df08,</span>
<span class="go">    0x7fe03c02e010&lt;ST4[%c]&gt; [ORD=3] [ID=6]</span>

<span class="go">        0x7fe03c02e538: i32 = TargetGlobalAddress&lt;i32* @gI&gt; 0 [TF=5] [ORD=4]</span>

<span class="go">      0x7fe03c02ea60: i32 = Cpu0ISD::Hi 0x7fe03c02e538 [ORD=4]</span>

<span class="go">        0x7fe03c02e958: i32 = TargetGlobalAddress&lt;i32* @gI&gt; 0 [TF=6] [ORD=4]</span>

<span class="go">      0x7fe03c02eb68: i32 = Cpu0ISD::Lo 0x7fe03c02e958 [ORD=4]</span>

<span class="go">    0x7fe03c02ec70: i32 = add 0x7fe03c02ea60, 0x7fe03c02eb68 [ORD=4]</span>

<span class="go">    0x7fe03c02e010: &lt;multiple use&gt;</span>
<span class="go">  0x7fe03c02e328: i32,ch = load 0x7fe03c02e118, 0x7fe03c02ec70,</span>
<span class="go">  0x7fe03c02e010&lt;LD4[@gI]&gt; [ORD=4] [ID=7]</span>
<span class="go">  ...</span>
<span class="go">        lui   $2, %got_hi(gI)</span>
<span class="go">        addu  $2, $2, $gp</span>
<span class="go">        ld    $2, %got_lo(gI)($2)</span>
<span class="go">  ...</span>
<span class="go">    .type gStart,@object          # @gStart</span>
<span class="go">  .data</span>
<span class="go">  .globl  gStart</span>
<span class="go">  .align  2</span>
<span class="go">gStart:</span>
<span class="go">  .4byte  3                       # 0x3</span>
<span class="go">  .size gStart, 4</span>

<span class="go">  .type gI,@object              # @gI</span>
<span class="go">  .globl  gI</span>
<span class="go">  .align  2</span>
<span class="go">gI:</span>
<span class="go">  .4byte  100                     # 0x64</span>
<span class="go">  .size gI, 4</span>
</pre></div>
</div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">118-165-78-166:input Jonathan$ </span>/Users/Jonathan/llvm/test/build/
<span class="go">bin/llc -march=cpu0 -relocation-model=pic -cpu0-use-small-section=true</span>
<span class="go">-filetype=asm -debug ch6_1.bc -o -</span>

<span class="go">...</span>
<span class="go">Type-legalized selection DAG: BB#0 &#39;_Z11test_globalv:&#39;</span>
<span class="go">SelectionDAG has 11 nodes:</span>
<span class="go">  ...</span>
<span class="go">      0x7fad7102cc10: &lt;multiple use&gt;</span>
<span class="go">    0x7fad7102cf10: ch = store 0x7fad7102cd10, 0x7fad7102ca10, 0x7fad7102ce10,</span>
<span class="go">    0x7fad7102cc10&lt;ST4[%c]&gt; [ORD=2] [ID=-3]</span>

<span class="go">    0x7fad7102d010: i32 = GlobalAddress&lt;i32* @gI&gt; 0 [ORD=3] [ID=-3]</span>

<span class="go">    0x7fad7102cc10: &lt;multiple use&gt;</span>
<span class="go">  0x7fad7102d110: i32,ch = load 0x7fad7102cf10, 0x7fad7102d010,</span>
<span class="go">  0x7fad7102cc10&lt;LD4[@gI]&gt; [ORD=3] [ID=-3]</span>
<span class="go">  ...</span>
<span class="go">Legalized selection DAG: BB#0 &#39;_Z11test_globalv:&#39;</span>
<span class="go">SelectionDAG has 14 nodes:</span>
<span class="go">  0x7ff3c9c10b98: ch = EntryToken [ORD=1] [ID=0]</span>
<span class="go">  ...</span>
<span class="go">      0x7fad7102cc10: &lt;multiple use&gt;</span>
<span class="go">    0x7fad7102cf10: ch = store 0x7fad7102cd10, 0x7fad7102ca10, 0x7fad7102ce10,</span>
<span class="go">    0x7fad7102cc10&lt;ST4[%c]&gt; [ORD=2] [ID=8]</span>

<span class="go">      0x7fad70c10b98: &lt;multiple use&gt;</span>
<span class="go">        0x7fad7102d610: i32 = Register %GP</span>

<span class="go">        0x7fad7102d310: i32 = TargetGlobalAddress&lt;i32* @gI&gt; 0 [TF=1]</span>

<span class="go">      0x7fad7102d710: i32 = Cpu0ISD::Wrapper 0x7fad7102d610, 0x7fad7102d310</span>

<span class="go">      0x7fad7102cc10: &lt;multiple use&gt;</span>
<span class="go">    0x7fad7102d810: i32,ch = load 0x7fad70c10b98, 0x7fad7102d710,</span>
<span class="go">    0x7fad7102cc10&lt;LD4[&lt;unknown&gt;]&gt;</span>

<span class="go">    0x7ff3ca02cc10: &lt;multiple use&gt;</span>
<span class="go">  0x7ff3ca02d110: i32,ch = load 0x7ff3ca02cf10, 0x7ff3ca02d810,</span>
<span class="go">  0x7ff3ca02cc10&lt;LD4[@gI]&gt; [ORD=3] [ID=9]</span>
<span class="go">  ...</span>
<span class="go">        .set  noreorder</span>
<span class="go">        .cpload       $6</span>
<span class="go">        .set  nomacro</span>
<span class="go">  ...</span>
<span class="go">      ld      $2, %got(gI)($gp)</span>
<span class="go">      ld      $2, 0($2)</span>
<span class="go">  ...</span>
<span class="go">      .type   gStart,@object          # @gStart</span>
<span class="go">      .data</span>
<span class="go">      .globl  gStart</span>
<span class="go">      .align  2</span>
<span class="go">gStart:</span>
<span class="go">      .4byte  2                       # 0x2</span>
<span class="go">      .size   gStart, 4</span>

<span class="go">      .type   gI,@object              # @gI</span>
<span class="go">      .globl  gI</span>
<span class="go">      .align  2</span>
<span class="go">gI:</span>
<span class="go">      .4byte  100                     # 0x64</span>
<span class="go">      .size   gI, 4</span>
</pre></div>
</div>
<p>Summary above information to Table: Cpu0 global variable options.</p>
<table class="docutils align-default" id="id9">
<caption><span class="caption-number">Table 28 </span><span class="caption-text">Cpu0 global variable options</span><a class="headerlink" href="#id9" title="Permalink to this table">¶</a></caption>
<thead>
<tr class="row-odd"><th class="head"><p>option name</p></th>
<th class="head"><p>default</p></th>
<th class="head"><p>other option value</p></th>
<th class="head"><p>discription</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>-relocation-model</p></td>
<td><p>pic</p></td>
<td><p>static</p></td>
<td><ul class="simple">
<li><p>pic: Postion Independent Address</p></li>
<li><p>static: Absolute Address</p></li>
</ul>
</td>
</tr>
<tr class="row-odd"><td><p>-cpu0-use-small-section</p></td>
<td><p>false</p></td>
<td><p>true</p></td>
<td><ul class="simple">
<li><p>false: .data or .bss, 32 bits addressable</p></li>
<li><p>true: .sdata or .sbss, 16 bits addressable</p></li>
</ul>
</td>
</tr>
</tbody>
</table>
<table class="docutils align-default" id="id10">
<caption><span class="caption-number">Table 29 </span><span class="caption-text">Cpu0 DAGs and instructions for -relocation-model=static</span><a class="headerlink" href="#id10" title="Permalink to this table">¶</a></caption>
<colgroup>
<col style="width: 33%" />
<col style="width: 33%" />
<col style="width: 33%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>option: cpu0-use-small-section</p></th>
<th class="head"><p>false</p></th>
<th class="head"><p>true</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>addressing mode</p></td>
<td><p>absolute</p></td>
<td><p>$gp relative</p></td>
</tr>
<tr class="row-odd"><td><p>addressing</p></td>
<td><p>absolute</p></td>
<td><p>$gp+offset</p></td>
</tr>
<tr class="row-even"><td><p>Legalized selection DAG</p></td>
<td><p>(add Cpu0ISD::Hi&lt;gI offset Hi16&gt; Cpu0ISD::Lo&lt;gI offset Lo16&gt;)</p></td>
<td><p>(add register %GP, Cpu0ISD::GPRel&lt;gI offset&gt;)</p></td>
</tr>
<tr class="row-odd"><td><p>Cpu0</p></td>
<td><p>lui $2, %hi(gI); ori $2, $2, %lo(gI);</p></td>
<td><p>ori        $2, $gp, %gp_rel(gI);</p></td>
</tr>
<tr class="row-even"><td><p>relocation records solved</p></td>
<td><p>link time</p></td>
<td><p>link time</p></td>
</tr>
</tbody>
</table>
<ul class="simple">
<li><p>In static mode with <code class="docutils literal notranslate"><span class="pre">cpu0-use-small-section=true</span></code>, the offset between
<code class="docutils literal notranslate"><span class="pre">gI</span></code> and <code class="docutils literal notranslate"><span class="pre">.data</span></code> can be calculated since <code class="docutils literal notranslate"><span class="pre">$gp</span></code> is assigned a fixed
address at the start of the global address table.</p></li>
<li><p>In static mode with <code class="docutils literal notranslate"><span class="pre">cpu0-use-small-section=false</span></code>, the high and low
addresses of <code class="docutils literal notranslate"><span class="pre">gI</span></code> (<code class="docutils literal notranslate"><span class="pre">%hi(gI)</span></code> and <code class="docutils literal notranslate"><span class="pre">%lo(gI)</span></code>) are translated into an
absolute address.</p></li>
</ul>
<table class="docutils align-default" id="id11">
<caption><span class="caption-number">Table 30 </span><span class="caption-text">Cpu0 DAGs and instructions for -relocation-model=pic</span><a class="headerlink" href="#id11" title="Permalink to this table">¶</a></caption>
<colgroup>
<col style="width: 33%" />
<col style="width: 33%" />
<col style="width: 33%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>option: cpu0-use-small-section</p></th>
<th class="head"><p>false</p></th>
<th class="head"><p>true</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>addressing mode</p></td>
<td><p>$gp relative</p></td>
<td><p>$gp relative</p></td>
</tr>
<tr class="row-odd"><td><p>addressing</p></td>
<td><p>$gp+offset</p></td>
<td><p>$gp+offset</p></td>
</tr>
<tr class="row-even"><td><p>Legalized selection DAG</p></td>
<td><p>(load (Cpu0ISD::Wrapper register %GP, &lt;gI offset&gt;))</p></td>
<td><p>(load EntryToken, (Cpu0ISD::Wrapper (add Cpu0ISD::Hi&lt;gI offset Hi16&gt;, Register %GP), Cpu0ISD::Lo&lt;gI offset Lo16&gt;))</p></td>
</tr>
<tr class="row-odd"><td><p>Cpu0</p></td>
<td><p>ld $2, %got(gI)($gp);</p></td>
<td><p>lui        $2, %got_hi(gI); add $2, $2, $gp; ld $2, %got_lo(gI)($2);</p></td>
</tr>
<tr class="row-even"><td><p>relocation records solved</p></td>
<td><p>link/load time</p></td>
<td><p>link/load time</p></td>
</tr>
</tbody>
</table>
<ul class="simple">
<li><p>In PIC mode, the offset between <code class="docutils literal notranslate"><span class="pre">gI</span></code> and <code class="docutils literal notranslate"><span class="pre">.data</span></code> cannot be calculated
if the function is loaded at runtime (dynamic linking). However, the offset
can be determined if static linking is used.</p></li>
<li><p>In C, all variable names are bound statically. In C++, overloaded variables
or functions are bound dynamically.</p></li>
</ul>
<p>According to the system programming book, there are two addressing modes:
<strong>Absolute Addressing Mode</strong> and <strong>Position-Independent Addressing Mode</strong>.
Dynamic functions must be compiled using Position-Independent Addressing Mode.</p>
<p>In general, the <code class="docutils literal notranslate"><span class="pre">-relocation-model</span></code> option is used to generate either
Absolute Addressing or Position-Independent Addressing. However, an exception
occurs when using <code class="docutils literal notranslate"><span class="pre">-relocation-model=static</span></code> with
<code class="docutils literal notranslate"><span class="pre">-cpu0-use-small-section=false</span></code>. In this case, the <code class="docutils literal notranslate"><span class="pre">$gp</span></code> register is
reserved and set at the start address of the global variable area. Cpu0 uses
<code class="docutils literal notranslate"><span class="pre">$gp</span></code>-relative addressing in this mode.</p>
<p>To support global variables, first add the <strong>UseSmallSectionOpt</strong> command
variable to <code class="docutils literal notranslate"><span class="pre">Cpu0Subtarget.cpp</span></code>.</p>
<p>After that, users can run <code class="docutils literal notranslate"><span class="pre">llc</span></code> with the option
<code class="docutils literal notranslate"><span class="pre">llc</span> <span class="pre">-cpu0-use-small-section=false</span></code> to explicitly set
<strong>UseSmallSectionOpt</strong> to <code class="docutils literal notranslate"><span class="pre">false</span></code>. By default, <strong>UseSmallSectionOpt</strong> is
<code class="docutils literal notranslate"><span class="pre">false</span></code> unless specified otherwise.</p>
<p>For more details about the <strong>cl::opt</strong> command-line variable, refer to
the documentation <a class="footnote-reference brackets" href="#id6" id="id1" role="doc-noteref"><span class="fn-bracket">[</span>1<span class="fn-bracket">]</span></a>.</p>
<p class="rubric">lbdex/chapters/Chapter6_1/Cpu0Subtarget.h</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">extern</span> <span class="nb">bool</span> <span class="n">Cpu0ReserveGP</span><span class="p">;</span>
<span class="n">extern</span> <span class="nb">bool</span> <span class="n">Cpu0NoCpload</span><span class="p">;</span>
</pre></div>
</div>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Cpu0Subtarget</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">Cpu0GenSubtargetInfo</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="p">...</span><span class="w"></span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>  <span class="o">//</span> <span class="n">UseSmallSection</span> <span class="o">-</span> <span class="n">Small</span> <span class="n">section</span> <span class="ow">is</span> <span class="n">used</span><span class="o">.</span>
  <span class="nb">bool</span> <span class="n">UseSmallSection</span><span class="p">;</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>  <span class="nb">bool</span> <span class="n">useSmallSection</span><span class="p">()</span> <span class="n">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">UseSmallSection</span><span class="p">;</span> <span class="p">}</span>
</pre></div>
</div>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="p">...</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>
</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter6_1/Cpu0Subtarget.cpp</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">static</span> <span class="n">cl</span><span class="p">::</span><span class="n">opt</span><span class="o">&lt;</span><span class="nb">bool</span><span class="o">&gt;</span> <span class="n">UseSmallSectionOpt</span>
                <span class="p">(</span><span class="s2">&quot;cpu0-use-small-section&quot;</span><span class="p">,</span> <span class="n">cl</span><span class="p">::</span><span class="n">Hidden</span><span class="p">,</span> <span class="n">cl</span><span class="p">::</span><span class="n">init</span><span class="p">(</span><span class="n">false</span><span class="p">),</span>
                 <span class="n">cl</span><span class="p">::</span><span class="n">desc</span><span class="p">(</span><span class="s2">&quot;Use small section. Only work when -relocation-model=&quot;</span>
                 <span class="s2">&quot;static. pic always not use small section.&quot;</span><span class="p">));</span>

<span class="n">static</span> <span class="n">cl</span><span class="p">::</span><span class="n">opt</span><span class="o">&lt;</span><span class="nb">bool</span><span class="o">&gt;</span> <span class="n">ReserveGPOpt</span>
                <span class="p">(</span><span class="s2">&quot;cpu0-reserve-gp&quot;</span><span class="p">,</span> <span class="n">cl</span><span class="p">::</span><span class="n">Hidden</span><span class="p">,</span> <span class="n">cl</span><span class="p">::</span><span class="n">init</span><span class="p">(</span><span class="n">false</span><span class="p">),</span>
                 <span class="n">cl</span><span class="p">::</span><span class="n">desc</span><span class="p">(</span><span class="s2">&quot;Never allocate $gp to variable&quot;</span><span class="p">));</span>

<span class="n">static</span> <span class="n">cl</span><span class="p">::</span><span class="n">opt</span><span class="o">&lt;</span><span class="nb">bool</span><span class="o">&gt;</span> <span class="n">NoCploadOpt</span>
                <span class="p">(</span><span class="s2">&quot;cpu0-no-cpload&quot;</span><span class="p">,</span> <span class="n">cl</span><span class="p">::</span><span class="n">Hidden</span><span class="p">,</span> <span class="n">cl</span><span class="p">::</span><span class="n">init</span><span class="p">(</span><span class="n">false</span><span class="p">),</span>
                 <span class="n">cl</span><span class="p">::</span><span class="n">desc</span><span class="p">(</span><span class="s2">&quot;No issue .cpload&quot;</span><span class="p">));</span>

<span class="nb">bool</span> <span class="n">Cpu0ReserveGP</span><span class="p">;</span>
<span class="nb">bool</span> <span class="n">Cpu0NoCpload</span><span class="p">;</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Cpu0Subtarget</span><span class="p">::</span><span class="n">Cpu0Subtarget</span><span class="p">(</span><span class="n">const</span> <span class="n">Triple</span> <span class="o">&amp;</span><span class="n">TT</span><span class="p">,</span> <span class="n">StringRef</span> <span class="n">CPU</span><span class="p">,</span>
                             <span class="n">StringRef</span> <span class="n">FS</span><span class="p">,</span> <span class="nb">bool</span> <span class="n">little</span><span class="p">,</span> 
                             <span class="n">const</span> <span class="n">Cpu0TargetMachine</span> <span class="o">&amp;</span><span class="n">_TM</span><span class="p">)</span> <span class="p">:</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>  <span class="o">//</span> <span class="n">Set</span> <span class="n">UseSmallSection</span><span class="o">.</span>
  <span class="n">UseSmallSection</span> <span class="o">=</span> <span class="n">UseSmallSectionOpt</span><span class="p">;</span>
  <span class="n">Cpu0ReserveGP</span> <span class="o">=</span> <span class="n">ReserveGPOpt</span><span class="p">;</span>
  <span class="n">Cpu0NoCpload</span> <span class="o">=</span> <span class="n">NoCploadOpt</span><span class="p">;</span>
</pre></div>
</div>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="p">...</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>The options <strong>ReserveGPOpt</strong> and <strong>NoCploadOpt</strong> will be used in the Cpu0
linker in a later chapter.</p>
<p>Next, add the following code to the files:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">Cpu0BaseInfo.h</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Cpu0TargetObjectFile.h</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Cpu0TargetObjectFile.cpp</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Cpu0RegisterInfo.cpp</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Cpu0ISelLowering.cpp</span></code></p></li>
</ul>
<p class="rubric">lbdex/chapters/Chapter6_1/Cpu0BaseInfo.h</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">enum</span><span class="w"> </span><span class="nc">TOF</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="p">...</span><span class="w"></span>
<span class="w">  </span><span class="c1">/// MO_GOT16 - Represents the offset into the global offset table at which</span>
<span class="w">  </span><span class="c1">/// the address the relocation entry symbol resides during execution.</span>
<span class="w">  </span><span class="n">MO_GOT16</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">MO_GOT</span><span class="p">,</span><span class="w"></span>
<span class="p">...</span><span class="w"></span>
<span class="p">};</span><span class="w"> </span><span class="c1">// enum TOF {</span>
</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter6_1/Cpu0TargetObjectFile.h</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>    <span class="nb">bool</span> <span class="n">IsGlobalInSmallSection</span><span class="p">(</span><span class="n">const</span> <span class="n">GlobalObject</span> <span class="o">*</span><span class="n">GO</span><span class="p">,</span> <span class="n">const</span> <span class="n">TargetMachine</span> <span class="o">&amp;</span><span class="n">TM</span><span class="p">,</span>
                                <span class="n">SectionKind</span> <span class="n">Kind</span><span class="p">)</span> <span class="n">const</span><span class="p">;</span>
    <span class="nb">bool</span> <span class="n">IsGlobalInSmallSectionImpl</span><span class="p">(</span><span class="n">const</span> <span class="n">GlobalObject</span> <span class="o">*</span><span class="n">GO</span><span class="p">,</span>
                                    <span class="n">const</span> <span class="n">TargetMachine</span> <span class="o">&amp;</span><span class="n">TM</span><span class="p">)</span> <span class="n">const</span><span class="p">;</span>
</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter6_1/Cpu0TargetObjectFile.cpp</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>// A address must be loaded from a small section if its size is less than the
// small section size threshold. Data in this section must be addressed using
// gp_rel operator.
static bool IsInSmallSection(uint64_t Size) {
  return Size &gt; 0 &amp;&amp; Size &lt;= SSThreshold;
}

bool Cpu0TargetObjectFile::IsGlobalInSmallSection(
    const GlobalObject *GO, const TargetMachine &amp;TM) const {
  // We first check the case where global is a declaration, because finding
  // section kind using getKindForGlobal() is only allowed for global
  // definitions.
  if (GO-&gt;isDeclaration() || GO-&gt;hasAvailableExternallyLinkage())
    return IsGlobalInSmallSectionImpl(GO, TM);

  return IsGlobalInSmallSection(GO, TM, getKindForGlobal(GO, TM));
}

/// IsGlobalInSmallSection - Return true if this global address should be
/// placed into small data/bss section.
bool Cpu0TargetObjectFile::
IsGlobalInSmallSection(const GlobalObject *GO, const TargetMachine &amp;TM,
                       SectionKind Kind) const {
  return IsGlobalInSmallSectionImpl(GO, TM) &amp;&amp;
         (Kind.isData() || Kind.isBSS() || Kind.isCommon() ||
          Kind.isReadOnly());
}

/// Return true if this global address should be placed into small data/bss
/// section. This method does all the work, except for checking the section
/// kind.
bool Cpu0TargetObjectFile::
IsGlobalInSmallSectionImpl(const GlobalObject *GV,
                           const TargetMachine &amp;TM) const {
  const Cpu0Subtarget &amp;Subtarget =
      *static_cast&lt;const Cpu0TargetMachine &amp;&gt;(TM).getSubtargetImpl();

  // Return if small section is not available.
  if (!Subtarget.useSmallSection())
    return false;

  // Only global variables, not functions.
  const GlobalVariable *GVA = dyn_cast&lt;GlobalVariable&gt;(GV);
  if (!GVA)
    return false;

  Type *Ty = GV-&gt;getValueType();
  return IsInSmallSection(
      GV-&gt;getParent()-&gt;getDataLayout().getTypeAllocSize(Ty));
}


MCSection *
Cpu0TargetObjectFile::SelectSectionForGlobal(
    const GlobalObject *GO, SectionKind Kind, const TargetMachine &amp;TM) const {
  // TODO: Could also support &quot;weak&quot; symbols as well with &quot;.gnu.linkonce.s.*&quot;
  // sections?

  // Handle Small Section classification here.
  if (Kind.isBSS() &amp;&amp; IsGlobalInSmallSection(GO, TM, Kind))
    return SmallBSSSection;
  if (Kind.isData() &amp;&amp; IsGlobalInSmallSection(GO, TM, Kind))
    return SmallDataSection;
  if (Kind.isReadOnly() &amp;&amp; IsGlobalInSmallSection(GO, TM, Kind))
    return SmallDataSection;

  // Otherwise, we work the same as ELF.
  return TargetLoweringObjectFileELF::SelectSectionForGlobal(GO, Kind, TM);
}

</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter6_1/Cpu0RegisterInfo.cpp</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="n">BitVector</span><span class="w"> </span><span class="n">Cpu0RegisterInfo</span><span class="o">::</span><span class="w"></span>
<span class="n">getReservedRegs</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">MachineFunction</span><span class="w"> </span><span class="o">&amp;</span><span class="n">MF</span><span class="p">)</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="p">...</span><span class="w"></span>
<span class="w">    </span><span class="n">Reserved</span><span class="p">.</span><span class="n">set</span><span class="p">(</span><span class="n">Cpu0</span><span class="o">::</span><span class="n">GP</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">...</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter6_1/Cpu0ISelLowering.h</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>    SDValue getGlobalReg(SelectionDAG &amp;DAG, EVT Ty) const;

    // This method creates the following nodes, which are necessary for
    // computing a local symbol&#39;s address:
    //
    // (add (load (wrapper $gp, %got(sym)), %lo(sym))
    template&lt;class NodeTy&gt;
    SDValue getAddrLocal(NodeTy *N, EVT Ty, SelectionDAG &amp;DAG) const {
      SDLoc DL(N);
      unsigned GOTFlag = Cpu0II::MO_GOT;
      SDValue GOT = DAG.getNode(Cpu0ISD::Wrapper, DL, Ty, getGlobalReg(DAG, Ty),
                                getTargetNode(N, Ty, DAG, GOTFlag));
      SDValue Load =
          DAG.getLoad(Ty, DL, DAG.getEntryNode(), GOT,
                      MachinePointerInfo::getGOT(DAG.getMachineFunction()));
      unsigned LoFlag = Cpu0II::MO_ABS_LO;
      SDValue Lo = DAG.getNode(Cpu0ISD::Lo, DL, Ty,
                               getTargetNode(N, Ty, DAG, LoFlag));
      return DAG.getNode(ISD::ADD, DL, Ty, Load, Lo);
    }

    //@getAddrGlobal {
    // This method creates the following nodes, which are necessary for
    // computing a global symbol&#39;s address:
    //
    // (load (wrapper $gp, %got(sym)))
    template&lt;class NodeTy&gt;
    SDValue getAddrGlobal(NodeTy *N, EVT Ty, SelectionDAG &amp;DAG,
                          unsigned Flag, SDValue Chain,
                          const MachinePointerInfo &amp;PtrInfo) const {
      SDLoc DL(N);
      SDValue Tgt = DAG.getNode(Cpu0ISD::Wrapper, DL, Ty, getGlobalReg(DAG, Ty),
                                getTargetNode(N, Ty, DAG, Flag));
      return DAG.getLoad(Ty, DL, Chain, Tgt, PtrInfo);
    }
    //@getAddrGlobal }

    //@getAddrGlobalLargeGOT {
    // This method creates the following nodes, which are necessary for
    // computing a global symbol&#39;s address in large-GOT mode:
    //
    // (load (wrapper (add %hi(sym), $gp), %lo(sym)))
    template&lt;class NodeTy&gt;
    SDValue getAddrGlobalLargeGOT(NodeTy *N, EVT Ty, SelectionDAG &amp;DAG,
                                  unsigned HiFlag, unsigned LoFlag,
                                  SDValue Chain,
                                  const MachinePointerInfo &amp;PtrInfo) const {
      SDLoc DL(N);
      SDValue Hi = DAG.getNode(Cpu0ISD::Hi, DL, Ty,
                               getTargetNode(N, Ty, DAG, HiFlag));
      Hi = DAG.getNode(ISD::ADD, DL, Ty, Hi, getGlobalReg(DAG, Ty));
      SDValue Wrapper = DAG.getNode(Cpu0ISD::Wrapper, DL, Ty, Hi,
                                    getTargetNode(N, Ty, DAG, LoFlag));
      return DAG.getLoad(Ty, DL, Chain, Wrapper, PtrInfo);
    }
    //@getAddrGlobalLargeGOT }

    //@getAddrNonPIC
    // This method creates the following nodes, which are necessary for
    // computing a symbol&#39;s address in non-PIC mode:
    //
    // (add %hi(sym), %lo(sym))
    template&lt;class NodeTy&gt;
    SDValue getAddrNonPIC(NodeTy *N, EVT Ty, SelectionDAG &amp;DAG) const {
      SDLoc DL(N);
      SDValue Hi = getTargetNode(N, Ty, DAG, Cpu0II::MO_ABS_HI);
      SDValue Lo = getTargetNode(N, Ty, DAG, Cpu0II::MO_ABS_LO);
      return DAG.getNode(ISD::ADD, DL, Ty,
                         DAG.getNode(Cpu0ISD::Hi, DL, Ty, Hi),
                         DAG.getNode(Cpu0ISD::Lo, DL, Ty, Lo));
    }
</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter6_1/Cpu0ISelLowering.cpp</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SDValue</span> <span class="n">Cpu0TargetLowering</span><span class="p">::</span><span class="n">getGlobalReg</span><span class="p">(</span><span class="n">SelectionDAG</span> <span class="o">&amp;</span><span class="n">DAG</span><span class="p">,</span> <span class="n">EVT</span> <span class="n">Ty</span><span class="p">)</span> <span class="n">const</span> <span class="p">{</span>
  <span class="n">Cpu0FunctionInfo</span> <span class="o">*</span><span class="n">FI</span> <span class="o">=</span> <span class="n">DAG</span><span class="o">.</span><span class="n">getMachineFunction</span><span class="p">()</span><span class="o">.</span><span class="n">getInfo</span><span class="o">&lt;</span><span class="n">Cpu0FunctionInfo</span><span class="o">&gt;</span><span class="p">();</span>
  <span class="k">return</span> <span class="n">DAG</span><span class="o">.</span><span class="n">getRegister</span><span class="p">(</span><span class="n">FI</span><span class="o">-&gt;</span><span class="n">getGlobalBaseReg</span><span class="p">(),</span> <span class="n">Ty</span><span class="p">);</span>
<span class="p">}</span>

<span class="o">//</span><span class="nd">@getTargetNode</span><span class="p">(</span><span class="n">GlobalAddressSDNode</span>
<span class="n">SDValue</span> <span class="n">Cpu0TargetLowering</span><span class="p">::</span><span class="n">getTargetNode</span><span class="p">(</span><span class="n">GlobalAddressSDNode</span> <span class="o">*</span><span class="n">N</span><span class="p">,</span> <span class="n">EVT</span> <span class="n">Ty</span><span class="p">,</span>
                                          <span class="n">SelectionDAG</span> <span class="o">&amp;</span><span class="n">DAG</span><span class="p">,</span>
                                          <span class="n">unsigned</span> <span class="n">Flag</span><span class="p">)</span> <span class="n">const</span> <span class="p">{</span>
  <span class="k">return</span> <span class="n">DAG</span><span class="o">.</span><span class="n">getTargetGlobalAddress</span><span class="p">(</span><span class="n">N</span><span class="o">-&gt;</span><span class="n">getGlobal</span><span class="p">(),</span> <span class="n">SDLoc</span><span class="p">(</span><span class="n">N</span><span class="p">),</span> <span class="n">Ty</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">Flag</span><span class="p">);</span>
<span class="p">}</span>

<span class="o">//</span><span class="nd">@getTargetNode</span><span class="p">(</span><span class="n">ExternalSymbolSDNode</span>
<span class="n">SDValue</span> <span class="n">Cpu0TargetLowering</span><span class="p">::</span><span class="n">getTargetNode</span><span class="p">(</span><span class="n">ExternalSymbolSDNode</span> <span class="o">*</span><span class="n">N</span><span class="p">,</span> <span class="n">EVT</span> <span class="n">Ty</span><span class="p">,</span>
                                          <span class="n">SelectionDAG</span> <span class="o">&amp;</span><span class="n">DAG</span><span class="p">,</span>
                                          <span class="n">unsigned</span> <span class="n">Flag</span><span class="p">)</span> <span class="n">const</span> <span class="p">{</span>
  <span class="k">return</span> <span class="n">DAG</span><span class="o">.</span><span class="n">getTargetExternalSymbol</span><span class="p">(</span><span class="n">N</span><span class="o">-&gt;</span><span class="n">getSymbol</span><span class="p">(),</span> <span class="n">Ty</span><span class="p">,</span> <span class="n">Flag</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Cpu0TargetLowering</span><span class="p">::</span><span class="n">Cpu0TargetLowering</span><span class="p">(</span><span class="n">const</span> <span class="n">Cpu0TargetMachine</span> <span class="o">&amp;</span><span class="n">TM</span><span class="p">,</span>
                                       <span class="n">const</span> <span class="n">Cpu0Subtarget</span> <span class="o">&amp;</span><span class="n">STI</span><span class="p">)</span>
    <span class="p">:</span> <span class="n">TargetLowering</span><span class="p">(</span><span class="n">TM</span><span class="p">),</span> <span class="n">Subtarget</span><span class="p">(</span><span class="n">STI</span><span class="p">),</span> <span class="n">ABI</span><span class="p">(</span><span class="n">TM</span><span class="o">.</span><span class="n">getABI</span><span class="p">())</span> <span class="p">{</span>

</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>  <span class="n">setOperationAction</span><span class="p">(</span><span class="n">ISD</span><span class="p">::</span><span class="n">GlobalAddress</span><span class="p">,</span>      <span class="n">MVT</span><span class="p">::</span><span class="n">i32</span><span class="p">,</span>   <span class="n">Custom</span><span class="p">);</span>
</pre></div>
</div>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SDValue</span> <span class="n">Cpu0TargetLowering</span><span class="p">::</span>
<span class="n">LowerOperation</span><span class="p">(</span><span class="n">SDValue</span> <span class="n">Op</span><span class="p">,</span> <span class="n">SelectionDAG</span> <span class="o">&amp;</span><span class="n">DAG</span><span class="p">)</span> <span class="n">const</span>
<span class="p">{</span>
  <span class="n">switch</span> <span class="p">(</span><span class="n">Op</span><span class="o">.</span><span class="n">getOpcode</span><span class="p">())</span>
  <span class="p">{</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>  <span class="k">case</span> <span class="n">ISD</span><span class="p">::</span><span class="n">GlobalAddress</span><span class="p">:</span>      <span class="k">return</span> <span class="n">lowerGlobalAddress</span><span class="p">(</span><span class="n">Op</span><span class="p">,</span> <span class="n">DAG</span><span class="p">);</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>  <span class="p">}</span>
  <span class="k">return</span> <span class="n">SDValue</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>SDValue Cpu0TargetLowering::lowerGlobalAddress(SDValue Op,
                                               SelectionDAG &amp;DAG) const {
  //@lowerGlobalAddress }
  SDLoc DL(Op);
  const Cpu0TargetObjectFile *TLOF =
        static_cast&lt;const Cpu0TargetObjectFile *&gt;(
            getTargetMachine().getObjFileLowering());
  //@lga 1 {
  EVT Ty = Op.getValueType();
  GlobalAddressSDNode *N = cast&lt;GlobalAddressSDNode&gt;(Op);
  const GlobalValue *GV = N-&gt;getGlobal();
  //@lga 1 }

  if (!isPositionIndependent()) {
    //@ %gp_rel relocation
    const GlobalObject *GO = GV-&gt;getBaseObject();
    if (GO &amp;&amp; TLOF-&gt;IsGlobalInSmallSection(GO, getTargetMachine())) {
      SDValue GA = DAG.getTargetGlobalAddress(GV, DL, MVT::i32, 0,
                                              Cpu0II::MO_GPREL);
      SDValue GPRelNode = DAG.getNode(Cpu0ISD::GPRel, DL,
                                      DAG.getVTList(MVT::i32), GA);
      SDValue GPReg = DAG.getRegister(Cpu0::GP, MVT::i32);
      return DAG.getNode(ISD::ADD, DL, MVT::i32, GPReg, GPRelNode);
    }

    //@ %hi/%lo relocation
    return getAddrNonPIC(N, Ty, DAG);
  }

  if (GV-&gt;hasInternalLinkage() || (GV-&gt;hasLocalLinkage() &amp;&amp; !isa&lt;Function&gt;(GV)))
    return getAddrLocal(N, Ty, DAG);

  //@large section
  const GlobalObject *GO = GV-&gt;getBaseObject();
  if (GO &amp;&amp; !TLOF-&gt;IsGlobalInSmallSection(GO, getTargetMachine()))
    return getAddrGlobalLargeGOT(
        N, Ty, DAG, Cpu0II::MO_GOT_HI16, Cpu0II::MO_GOT_LO16, 
        DAG.getEntryNode(), 
        MachinePointerInfo::getGOT(DAG.getMachineFunction()));
  return getAddrGlobal(
      N, Ty, DAG, Cpu0II::MO_GOT, DAG.getEntryNode(), 
      MachinePointerInfo::getGOT(DAG.getMachineFunction()));
}
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">setOperationAction(ISD::GlobalAddress,</span> <span class="pre">MVT::i32,</span> <span class="pre">Custom)</span></code> directive
informs <code class="docutils literal notranslate"><span class="pre">llc</span></code> that the global address operation is implemented in the C++
function <code class="docutils literal notranslate"><span class="pre">Cpu0TargetLowering::LowerOperation()</span></code>. LLVM will call this function
only when it needs to translate the IR DAG for loading a global variable into
machine code.</p>
<p>Although all custom IR operations set by
<code class="docutils literal notranslate"><span class="pre">setOperationAction(ISD::XXX,</span> <span class="pre">MVT::XXX,</span> <span class="pre">Custom)</span></code> in the constructor
<code class="docutils literal notranslate"><span class="pre">Cpu0TargetLowering()</span></code> trigger calls to
<code class="docutils literal notranslate"><span class="pre">Cpu0TargetLowering::LowerOperation()</span></code> during the “Legalized selection DAG”
stage, the global address access operation can be specifically identified by
checking whether the DAG node’s opcode is <code class="docutils literal notranslate"><span class="pre">ISD::GlobalAddress</span></code>.</p>
<p>Finally, add the following code to <code class="docutils literal notranslate"><span class="pre">Cpu0ISelDAGToDAG.cpp</span></code> and
<code class="docutils literal notranslate"><span class="pre">Cpu0InstrInfo.td</span></code>.</p>
<p class="rubric">lbdex/chapters/Chapter6_1/Cpu0ISelDAGToDAG.h</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>  <span class="n">SDNode</span> <span class="o">*</span><span class="n">getGlobalBaseReg</span><span class="p">();</span>
</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter6_1/Cpu0ISelDAGToDAG.cpp</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">///</span> <span class="n">getGlobalBaseReg</span> <span class="o">-</span> <span class="n">Output</span> <span class="n">the</span> <span class="n">instructions</span> <span class="n">required</span> <span class="n">to</span> <span class="n">put</span> <span class="n">the</span>
<span class="o">///</span> <span class="n">GOT</span> <span class="n">address</span> <span class="n">into</span> <span class="n">a</span> <span class="n">register</span><span class="o">.</span>
<span class="n">SDNode</span> <span class="o">*</span><span class="n">Cpu0DAGToDAGISel</span><span class="p">::</span><span class="n">getGlobalBaseReg</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">unsigned</span> <span class="n">GlobalBaseReg</span> <span class="o">=</span> <span class="n">MF</span><span class="o">-&gt;</span><span class="n">getInfo</span><span class="o">&lt;</span><span class="n">Cpu0FunctionInfo</span><span class="o">&gt;</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getGlobalBaseReg</span><span class="p">();</span>
  <span class="k">return</span> <span class="n">CurDAG</span><span class="o">-&gt;</span><span class="n">getRegister</span><span class="p">(</span><span class="n">GlobalBaseReg</span><span class="p">,</span> <span class="n">getTargetLowering</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getPointerTy</span><span class="p">(</span>
                                                <span class="n">CurDAG</span><span class="o">-&gt;</span><span class="n">getDataLayout</span><span class="p">()))</span>
      <span class="o">.</span><span class="n">getNode</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">///</span> <span class="n">ComplexPattern</span> <span class="n">used</span> <span class="n">on</span> <span class="n">Cpu0InstrInfo</span>
<span class="o">///</span> <span class="n">Used</span> <span class="n">on</span> <span class="n">Cpu0</span> <span class="n">Load</span><span class="o">/</span><span class="n">Store</span> <span class="n">instructions</span>
<span class="nb">bool</span> <span class="n">Cpu0DAGToDAGISel</span><span class="p">::</span>
<span class="n">SelectAddr</span><span class="p">(</span><span class="n">SDNode</span> <span class="o">*</span><span class="n">Parent</span><span class="p">,</span> <span class="n">SDValue</span> <span class="n">Addr</span><span class="p">,</span> <span class="n">SDValue</span> <span class="o">&amp;</span><span class="n">Base</span><span class="p">,</span> <span class="n">SDValue</span> <span class="o">&amp;</span><span class="n">Offset</span><span class="p">)</span> <span class="p">{</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>  <span class="o">//</span> <span class="n">on</span> <span class="n">PIC</span> <span class="n">code</span> <span class="n">Load</span> <span class="n">GA</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">Addr</span><span class="o">.</span><span class="n">getOpcode</span><span class="p">()</span> <span class="o">==</span> <span class="n">Cpu0ISD</span><span class="p">::</span><span class="n">Wrapper</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">Base</span>   <span class="o">=</span> <span class="n">Addr</span><span class="o">.</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
    <span class="n">Offset</span> <span class="o">=</span> <span class="n">Addr</span><span class="o">.</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">true</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="o">//</span><span class="nd">@static</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">TM</span><span class="o">.</span><span class="n">getRelocationModel</span><span class="p">()</span> <span class="o">!=</span> <span class="n">Reloc</span><span class="p">::</span><span class="n">PIC_</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">((</span><span class="n">Addr</span><span class="o">.</span><span class="n">getOpcode</span><span class="p">()</span> <span class="o">==</span> <span class="n">ISD</span><span class="p">::</span><span class="n">TargetExternalSymbol</span> <span class="o">||</span>
        <span class="n">Addr</span><span class="o">.</span><span class="n">getOpcode</span><span class="p">()</span> <span class="o">==</span> <span class="n">ISD</span><span class="p">::</span><span class="n">TargetGlobalAddress</span><span class="p">))</span>
      <span class="k">return</span> <span class="n">false</span><span class="p">;</span>
  <span class="p">}</span>
</pre></div>
</div>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="p">...</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>/// Select instructions not customized! Used for
/// expanded, promoted and normal instructions
void Cpu0DAGToDAGISel::Select(SDNode *Node) {
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>  <span class="o">//</span> <span class="n">Get</span> <span class="n">target</span> <span class="n">GOT</span> <span class="n">address</span><span class="o">.</span>
  <span class="k">case</span> <span class="n">ISD</span><span class="p">::</span><span class="n">GLOBAL_OFFSET_TABLE</span><span class="p">:</span>
    <span class="n">ReplaceNode</span><span class="p">(</span><span class="n">Node</span><span class="p">,</span> <span class="n">getGlobalBaseReg</span><span class="p">());</span>
    <span class="k">return</span><span class="p">;</span>
</pre></div>
</div>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="p">...</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter6_1/Cpu0InstrInfo.td</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//</span> <span class="n">Hi</span> <span class="ow">and</span> <span class="n">Lo</span> <span class="n">nodes</span> <span class="n">are</span> <span class="n">used</span> <span class="n">to</span> <span class="n">handle</span> <span class="k">global</span> <span class="n">addresses</span><span class="o">.</span> <span class="n">Used</span> <span class="n">on</span>
<span class="o">//</span> <span class="n">Cpu0ISelLowering</span> <span class="n">to</span> <span class="n">lower</span> <span class="n">stuff</span> <span class="n">like</span> <span class="n">GlobalAddress</span><span class="p">,</span> <span class="n">ExternalSymbol</span>
<span class="o">//</span> <span class="n">static</span> <span class="n">model</span><span class="o">.</span> <span class="p">(</span><span class="n">nothing</span> <span class="n">to</span> <span class="n">do</span> <span class="k">with</span> <span class="n">Cpu0</span> <span class="n">Registers</span> <span class="n">Hi</span> <span class="ow">and</span> <span class="n">Lo</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">Cpu0Hi</span>    <span class="p">:</span> <span class="n">SDNode</span><span class="o">&lt;</span><span class="s2">&quot;Cpu0ISD::Hi&quot;</span><span class="p">,</span> <span class="n">SDTIntUnaryOp</span><span class="o">&gt;</span><span class="p">;</span>
<span class="k">def</span> <span class="nf">Cpu0Lo</span>    <span class="p">:</span> <span class="n">SDNode</span><span class="o">&lt;</span><span class="s2">&quot;Cpu0ISD::Lo&quot;</span><span class="p">,</span> <span class="n">SDTIntUnaryOp</span><span class="o">&gt;</span><span class="p">;</span>
<span class="k">def</span> <span class="nf">Cpu0GPRel</span> <span class="p">:</span> <span class="n">SDNode</span><span class="o">&lt;</span><span class="s2">&quot;Cpu0ISD::GPRel&quot;</span><span class="p">,</span> <span class="n">SDTIntUnaryOp</span><span class="o">&gt;</span><span class="p">;</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">Cpu0Wrapper</span>    <span class="p">:</span> <span class="n">SDNode</span><span class="o">&lt;</span><span class="s2">&quot;Cpu0ISD::Wrapper&quot;</span><span class="p">,</span> <span class="n">SDTIntBinOp</span><span class="o">&gt;</span><span class="p">;</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">RelocPIC</span>    <span class="p">:</span>     <span class="n">Predicate</span><span class="o">&lt;</span><span class="s2">&quot;TM.getRelocationModel() == Reloc::PIC_&quot;</span><span class="o">&gt;</span><span class="p">;</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>// hi/lo relocs
let Predicates = [Ch6_1] in {
def : Pat&lt;(Cpu0Hi tglobaladdr:$in), (LUi tglobaladdr:$in)&gt;;
}
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>let Predicates = [Ch6_1] in {
def : Pat&lt;(Cpu0Lo tglobaladdr:$in), (ORi ZERO, tglobaladdr:$in)&gt;;
}
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>let Predicates = [Ch6_1] in {
def : Pat&lt;(add CPURegs:$hi, (Cpu0Lo tglobaladdr:$lo)),
          (ORi CPURegs:$hi, tglobaladdr:$lo)&gt;;
}
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>// gp_rel relocs
let Predicates = [Ch6_1] in {
def : Pat&lt;(add CPURegs:$gp, (Cpu0GPRel tglobaladdr:$in)),
          (ORi CPURegs:$gp, tglobaladdr:$in)&gt;;
}

//@ wrapper_pic
let Predicates = [Ch6_1] in {
class WrapperPat&lt;SDNode node, Instruction ORiOp, RegisterClass RC&gt;:
      Pat&lt;(Cpu0Wrapper RC:$gp, node:$in),
              (ORiOp RC:$gp, node:$in)&gt;;

def : WrapperPat&lt;tglobaladdr, ORi, GPROut&gt;;
}
</pre></div>
</div>
</section>
<section id="static-mode">
<h2><a class="toc-backref" href="#id13" role="doc-backlink">Static mode</a><a class="headerlink" href="#static-mode" title="Permalink to this heading">¶</a></h2>
<p>From the table <strong>Cpu0 global variable options</strong>, the option
<code class="docutils literal notranslate"><span class="pre">cpu0-use-small-section=false</span></code> places global variables in <code class="docutils literal notranslate"><span class="pre">.data/.bss</span></code>,
while <code class="docutils literal notranslate"><span class="pre">cpu0-use-small-section=true</span></code> places them in <code class="docutils literal notranslate"><span class="pre">.sdata/.sbss</span></code>.
The <code class="docutils literal notranslate"><span class="pre">.sdata</span></code> section stands for the small data area.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">.data</span></code> and <code class="docutils literal notranslate"><span class="pre">.sdata</span></code> sections store global variables with an initial
value (e.g., <code class="docutils literal notranslate"><span class="pre">int</span> <span class="pre">gI</span> <span class="pre">=</span> <span class="pre">100;</span></code>), while the <code class="docutils literal notranslate"><span class="pre">.bss</span></code> and <code class="docutils literal notranslate"><span class="pre">.sbss</span></code> sections store
global variables without an initial value (e.g., <code class="docutils literal notranslate"><span class="pre">int</span> <span class="pre">gI;</span></code>).</p>
<section id="data-or-bss">
<h3><a class="toc-backref" href="#id14" role="doc-backlink">data or bss</a><a class="headerlink" href="#data-or-bss" title="Permalink to this heading">¶</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">.data/.bss</span></code> sections are 32-bit addressable areas since Cpu0 is a
32-bit architecture. When <code class="docutils literal notranslate"><span class="pre">cpu0-use-small-section=false</span></code> is set, the following
instructions will be generated.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">  ...</span>
<span class="go">  lui $2, %hi(gI)</span>
<span class="go">  ori $2, $2, %lo(gI)</span>
<span class="go">  ld  $2, 0($2)</span>
<span class="go">  ...</span>
<span class="go">  .type       gStart,@object          # @gStart</span>
<span class="go">  .data</span>
<span class="go">  .globl      gStart</span>
<span class="go">  .align      2</span>
<span class="go">gStart:</span>
<span class="go">  .4byte      2                       # 0x2</span>
<span class="go">  .size       gStart, 4</span>

<span class="go">  .type       gI,@object              # @gI</span>
<span class="go">  .globl      gI</span>
<span class="go">  .align      2</span>
<span class="go">gI:</span>
<span class="go">  .4byte      100                     # 0x64</span>
<span class="go">  .size       gI, 4</span>
</pre></div>
</div>
<p>As above code, it loads the high address part of gI PC relative address
(16 bits) to register $2 and shift 16 bits.
Now, the register $2 got it’s high part of gI absolute address.
Next, it adds register $2 and low part of gI absolute address into $2.
At this point, it gets the gI memory address. Finally, it gets the gI content by
instruction “ld $2, 0($2)”.
The <code class="docutils literal notranslate"><span class="pre">llc</span> <span class="pre">-relocation-model=static</span></code> is for absolute address mode which must be
used in static link mode. The dynamic link must be encoded with Position
Independent Addressing.
As you can see, the PC relative address can be solved in static link (
The offset between the address of gI and instruction “lui $2, %hi(gI)” can be
caculated). Since Cpu0 uses PC relative address coding, this program can be
loaded to any address and run correctly there.
If this program uses absolute address and can be loaded at a specific address
known at link stage, the relocation record of gI variable access instruction
such as “lui $2, %hi(gI)” and “ori      $2, $2, %lo(gI)” can be solved
at link time. On the other hand,
if this program use absolute address and the loading address is known at load
time, then this relocation record will be solved by loader at load time.</p>
<p>IsGlobalInSmallSection() returns true or false depends on UseSmallSectionOpt.</p>
<p>The code fragment of lowerGlobalAddress() as the following corresponding option
<code class="docutils literal notranslate"><span class="pre">llc</span> <span class="pre">-relocation-model=static</span> <span class="pre">-cpu0-use-small-section=false</span></code> will translate
DAG (GlobalAddress&lt;i32* &#64;gI&gt; 0) into
(add Cpu0ISD::Hi&lt;gI offset Hi16&gt; Cpu0ISD::Lo&lt;gI offset Lo16&gt;) in
stage “Legalized selection DAG” as below.</p>
<p class="rubric">lbdex/chapters/Chapter6_1/Cpu0ISelLowering.h</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>    <span class="o">//</span> <span class="n">This</span> <span class="n">method</span> <span class="n">creates</span> <span class="n">the</span> <span class="n">following</span> <span class="n">nodes</span><span class="p">,</span> <span class="n">which</span> <span class="n">are</span> <span class="n">necessary</span> <span class="k">for</span>
    <span class="o">//</span> <span class="n">computing</span> <span class="n">a</span> <span class="n">symbol</span><span class="s1">&#39;s address in non-PIC mode:</span>
    <span class="o">//</span>
    <span class="o">//</span> <span class="p">(</span><span class="n">add</span> <span class="o">%</span><span class="n">hi</span><span class="p">(</span><span class="n">sym</span><span class="p">),</span> <span class="o">%</span><span class="n">lo</span><span class="p">(</span><span class="n">sym</span><span class="p">))</span>
    <span class="n">template</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">NodeTy</span><span class="o">&gt;</span>
    <span class="n">SDValue</span> <span class="n">getAddrNonPIC</span><span class="p">(</span><span class="n">NodeTy</span> <span class="o">*</span><span class="n">N</span><span class="p">,</span> <span class="n">EVT</span> <span class="n">Ty</span><span class="p">,</span> <span class="n">SelectionDAG</span> <span class="o">&amp;</span><span class="n">DAG</span><span class="p">)</span> <span class="n">const</span> <span class="p">{</span>
      <span class="n">SDLoc</span> <span class="n">DL</span><span class="p">(</span><span class="n">N</span><span class="p">);</span>
      <span class="n">SDValue</span> <span class="n">Hi</span> <span class="o">=</span> <span class="n">getTargetNode</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">Ty</span><span class="p">,</span> <span class="n">DAG</span><span class="p">,</span> <span class="n">Cpu0II</span><span class="p">::</span><span class="n">MO_ABS_HI</span><span class="p">);</span>
      <span class="n">SDValue</span> <span class="n">Lo</span> <span class="o">=</span> <span class="n">getTargetNode</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">Ty</span><span class="p">,</span> <span class="n">DAG</span><span class="p">,</span> <span class="n">Cpu0II</span><span class="p">::</span><span class="n">MO_ABS_LO</span><span class="p">);</span>
      <span class="k">return</span> <span class="n">DAG</span><span class="o">.</span><span class="n">getNode</span><span class="p">(</span><span class="n">ISD</span><span class="p">::</span><span class="n">ADD</span><span class="p">,</span> <span class="n">DL</span><span class="p">,</span> <span class="n">Ty</span><span class="p">,</span>
                         <span class="n">DAG</span><span class="o">.</span><span class="n">getNode</span><span class="p">(</span><span class="n">Cpu0ISD</span><span class="p">::</span><span class="n">Hi</span><span class="p">,</span> <span class="n">DL</span><span class="p">,</span> <span class="n">Ty</span><span class="p">,</span> <span class="n">Hi</span><span class="p">),</span>
                         <span class="n">DAG</span><span class="o">.</span><span class="n">getNode</span><span class="p">(</span><span class="n">Cpu0ISD</span><span class="p">::</span><span class="n">Lo</span><span class="p">,</span> <span class="n">DL</span><span class="p">,</span> <span class="n">Ty</span><span class="p">,</span> <span class="n">Lo</span><span class="p">));</span>
    <span class="p">}</span>
</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter6_1/Cpu0ISelLowering.cpp</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SDValue</span> <span class="n">Cpu0TargetLowering</span><span class="p">::</span><span class="n">getTargetNode</span><span class="p">(</span><span class="n">GlobalAddressSDNode</span> <span class="o">*</span><span class="n">N</span><span class="p">,</span> <span class="n">EVT</span> <span class="n">Ty</span><span class="p">,</span>
                                          <span class="n">SelectionDAG</span> <span class="o">&amp;</span><span class="n">DAG</span><span class="p">,</span>
                                          <span class="n">unsigned</span> <span class="n">Flag</span><span class="p">)</span> <span class="n">const</span> <span class="p">{</span>
  <span class="k">return</span> <span class="n">DAG</span><span class="o">.</span><span class="n">getTargetGlobalAddress</span><span class="p">(</span><span class="n">N</span><span class="o">-&gt;</span><span class="n">getGlobal</span><span class="p">(),</span> <span class="n">SDLoc</span><span class="p">(</span><span class="n">N</span><span class="p">),</span> <span class="n">Ty</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">Flag</span><span class="p">);</span>
<span class="p">}</span>

</pre></div>
</div>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="n">SDValue</span><span class="w"> </span><span class="nf">Cpu0TargetLowering::lowerGlobalAddress</span><span class="p">(</span><span class="n">SDValue</span><span class="w"> </span><span class="n">Op</span><span class="p">,</span><span class="w"></span>
<span class="w">                                               </span><span class="n">SelectionDAG</span><span class="w"> </span><span class="o">&amp;</span><span class="n">DAG</span><span class="p">)</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="p">...</span><span class="w"></span>
<span class="w">  </span><span class="n">EVT</span><span class="w"> </span><span class="n">Ty</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Op</span><span class="p">.</span><span class="n">getValueType</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="n">GlobalAddressSDNode</span><span class="w"> </span><span class="o">*</span><span class="n">N</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">GlobalAddressSDNode</span><span class="o">&gt;</span><span class="p">(</span><span class="n">Op</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">..</span><span class="w"></span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">getTargetMachine</span><span class="p">().</span><span class="n">getRelocationModel</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">Reloc</span><span class="o">::</span><span class="n">PIC_</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="p">...</span><span class="w"></span>
<span class="w">    </span><span class="c1">// %hi/%lo relocation</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">getAddrNonPIC</span><span class="p">(</span><span class="n">N</span><span class="p">,</span><span class="w"> </span><span class="n">Ty</span><span class="p">,</span><span class="w"> </span><span class="n">DAG</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">...</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">118-165-78-166:input Jonathan$ </span>clang -target mips-unknown-linux-gnu -c
<span class="go">ch6_1.cpp -emit-llvm -o ch6_1.bc</span>
<span class="gp">118-165-78-166:input Jonathan$ </span>~/llvm/test/build/bin/llc
<span class="go">-march=cpu0 -relocation-model=static -cpu0-use-small-section=false</span>
<span class="go">-filetype=asm -debug ch6_1.bc -o -</span>

<span class="go">...</span>
<span class="go">Type-legalized selection DAG: BB#0 &#39;_Z3funv:entry&#39;</span>
<span class="go">SelectionDAG has 12 nodes:</span>
<span class="go">  ...</span>
<span class="go">      0x7ffd5902cc10: &lt;multiple use&gt;</span>
<span class="go">    0x7ffd5902cf10: ch = store 0x7ffd5902cd10, 0x7ffd5902ca10, 0x7ffd5902ce10,</span>
<span class="go">    0x7ffd5902cc10&lt;ST4[%c]&gt; [ORD=2] [ID=-3]</span>

<span class="go">    0x7ffd5902d010: i32 = GlobalAddress&lt;i32* @gI&gt; 0 [ORD=3] [ID=-3]</span>

<span class="go">    0x7ffd5902cc10: &lt;multiple use&gt;</span>
<span class="go">  0x7ffd5902d110: i32,ch = load 0x7ffd5902cf10, 0x7ffd5902d010,</span>
<span class="go">  0x7ffd5902cc10&lt;LD4[@gI]&gt; [ORD=3] [ID=-3]</span>
<span class="go">  ...</span>

<span class="go">Legalized selection DAG: BB#0 &#39;_Z3funv:entry&#39;</span>
<span class="go">SelectionDAG has 16 nodes:</span>
<span class="go">  ...</span>
<span class="go">      0x7ffd5902cc10: &lt;multiple use&gt;</span>
<span class="go">    0x7ffd5902cf10: ch = store 0x7ffd5902cd10, 0x7ffd5902ca10, 0x7ffd5902ce10,</span>
<span class="go">    0x7ffd5902cc10&lt;ST4[%c]&gt; [ORD=2] [ID=8]</span>

<span class="go">        0x7ffd5902d310: i32 = TargetGlobalAddress&lt;i32* @gI&gt; 0 [TF=5]</span>

<span class="go">      0x7ffd5902d710: i32 = Cpu0ISD::Hi 0x7ffd5902d310</span>

<span class="go">        0x7ffd5902d610: i32 = TargetGlobalAddress&lt;i32* @gI&gt; 0 [TF=6]</span>

<span class="go">      0x7ffd5902d810: i32 = Cpu0ISD::Lo 0x7ffd5902d610</span>

<span class="go">    0x7ffd5902fe10: i32 = add 0x7ffd5902d710, 0x7ffd5902d810</span>

<span class="go">    0x7ffd5902cc10: &lt;multiple use&gt;</span>
<span class="go">  0x7ffd5902d110: i32,ch = load 0x7ffd5902cf10, 0x7ffd5902fe10,</span>
<span class="go">  0x7ffd5902cc10&lt;LD4[@gI]&gt; [ORD=3] [ID=9]</span>
</pre></div>
</div>
<p>Finally, the pattern defined in Cpu0InstrInfo.td as the following will translate
DAG (add Cpu0ISD::Hi&lt;gI offset Hi16&gt; Cpu0ISD::Lo&lt;gI offset Lo16&gt;) into Cpu0
instructions as below.</p>
<p class="rubric">lbdex/chapters/Chapter6_1/Cpu0InstrInfo.td</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//</span> <span class="n">Hi</span> <span class="ow">and</span> <span class="n">Lo</span> <span class="n">nodes</span> <span class="n">are</span> <span class="n">used</span> <span class="n">to</span> <span class="n">handle</span> <span class="k">global</span> <span class="n">addresses</span><span class="o">.</span> <span class="n">Used</span> <span class="n">on</span>
<span class="o">//</span> <span class="n">Cpu0ISelLowering</span> <span class="n">to</span> <span class="n">lower</span> <span class="n">stuff</span> <span class="n">like</span> <span class="n">GlobalAddress</span><span class="p">,</span> <span class="n">ExternalSymbol</span>
<span class="o">//</span> <span class="n">static</span> <span class="n">model</span><span class="o">.</span> <span class="p">(</span><span class="n">nothing</span> <span class="n">to</span> <span class="n">do</span> <span class="k">with</span> <span class="n">Cpu0</span> <span class="n">Registers</span> <span class="n">Hi</span> <span class="ow">and</span> <span class="n">Lo</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">Cpu0Hi</span>    <span class="p">:</span> <span class="n">SDNode</span><span class="o">&lt;</span><span class="s2">&quot;Cpu0ISD::Hi&quot;</span><span class="p">,</span> <span class="n">SDTIntUnaryOp</span><span class="o">&gt;</span><span class="p">;</span>
<span class="k">def</span> <span class="nf">Cpu0Lo</span>    <span class="p">:</span> <span class="n">SDNode</span><span class="o">&lt;</span><span class="s2">&quot;Cpu0ISD::Lo&quot;</span><span class="p">,</span> <span class="n">SDTIntUnaryOp</span><span class="o">&gt;</span><span class="p">;</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>// hi/lo relocs
let Predicates = [Ch6_1] in {
def : Pat&lt;(Cpu0Hi tglobaladdr:$in), (LUi tglobaladdr:$in)&gt;;
}
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>let Predicates = [Ch6_1] in {
def : Pat&lt;(Cpu0Lo tglobaladdr:$in), (ORi ZERO, tglobaladdr:$in)&gt;;
}
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>let Predicates = [Ch6_1] in {
def : Pat&lt;(add CPURegs:$hi, (Cpu0Lo tglobaladdr:$lo)),
          (ORi CPURegs:$hi, tglobaladdr:$lo)&gt;;
}
</pre></div>
</div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">...</span>
<span class="go">lui $2, %hi(gI)</span>
<span class="go">ori $2, $2, %lo(gI)</span>
<span class="go">...</span>
</pre></div>
</div>
<p>As above, Pat&lt;(…),(…)&gt; include two lists of DAGs.
The left is IR DAG and the right is machine instruction DAG.
“Pat&lt;(Cpu0Hi tglobaladdr:$in), (LUi, tglobaladdr:$in)&gt;;” will
translate DAG (Cpu0ISD::Hi tglobaladdr) into (lui (ori ZERO, tglobaladdr), 16).
“Pat&lt;(add CPURegs:$hi, (Cpu0Lo tglobaladdr:$lo)), (ORi CPURegs:$hi,
tglobaladdr:$lo)&gt;;” will translate DAG (add Cpu0ISD::Hi, Cpu0ISD::Lo) into Cpu0
instruction (ori Cpu0ISD::Hi, Cpu0ISD::Lo).</p>
</section>
<section id="sdata-or-sbss">
<h3><a class="toc-backref" href="#id15" role="doc-backlink">sdata or sbss</a><a class="headerlink" href="#sdata-or-sbss" title="Permalink to this heading">¶</a></h3>
<p>The sdata/sbss are 16 bits addressable areas which placed in ELF for fast access.
Option cpu0-use-small-section=true will generate the following instructions.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">  ori $2, $gp, %gp_rel(gI)</span>
<span class="go">  ld  $2, 0($2)</span>
<span class="go">  ...</span>
<span class="go">  .type       gStart,@object          # @gStart</span>
<span class="go">  .section    .sdata,&quot;aw&quot;,@progbits</span>
<span class="go">  .globl      gStart</span>
<span class="go">  .align      2</span>
<span class="go">gStart:</span>
<span class="go">  .4byte      2                       # 0x2</span>
<span class="go">  .size       gStart, 4</span>

<span class="go">  .type       gI,@object              # @gI</span>
<span class="go">  .globl      gI</span>
<span class="go">  .align      2</span>
<span class="go">gI:</span>
<span class="go">  .4byte      100                     # 0x64</span>
<span class="go">  .size       gI, 4</span>
</pre></div>
</div>
<p>The code fragment of lowerGlobalAddress() as the following corresponding option
<code class="docutils literal notranslate"><span class="pre">llc</span> <span class="pre">-relocation-model=static</span> <span class="pre">-cpu0-use-small-section=true</span></code> will translate DAG
(GlobalAddress&lt;i32* &#64;gI&gt; 0) into
(add register %GP Cpu0ISD::GPRel&lt;gI offset&gt;) in
stage “Legalized selection DAG” as below.</p>
<p class="rubric">lbdex/chapters/Chapter6_1/Cpu0ISelLowering.cpp</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>SDValue Cpu0TargetLowering::lowerGlobalAddress(SDValue Op,
                                               SelectionDAG &amp;DAG) const {
  //@lowerGlobalAddress }
  SDLoc DL(Op);
  const Cpu0TargetObjectFile *TLOF =
        static_cast&lt;const Cpu0TargetObjectFile *&gt;(
            getTargetMachine().getObjFileLowering());
  //@lga 1 {
  EVT Ty = Op.getValueType();
  GlobalAddressSDNode *N = cast&lt;GlobalAddressSDNode&gt;(Op);
  const GlobalValue *GV = N-&gt;getGlobal();
  //@lga 1 }

  if (!isPositionIndependent()) {
    //@ %gp_rel relocation
    const GlobalObject *GO = GV-&gt;getBaseObject();
    if (GO &amp;&amp; TLOF-&gt;IsGlobalInSmallSection(GO, getTargetMachine())) {
      SDValue GA = DAG.getTargetGlobalAddress(GV, DL, MVT::i32, 0,
                                              Cpu0II::MO_GPREL);
      SDValue GPRelNode = DAG.getNode(Cpu0ISD::GPRel, DL,
                                      DAG.getVTList(MVT::i32), GA);
      SDValue GPReg = DAG.getRegister(Cpu0::GP, MVT::i32);
      return DAG.getNode(ISD::ADD, DL, MVT::i32, GPReg, GPRelNode);
    }

</pre></div>
</div>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="w">    </span><span class="p">...</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">...</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">...</span>
<span class="go">Type-legalized selection DAG: BB#0 &#39;_Z3funv:entry&#39;</span>
<span class="go">SelectionDAG has 12 nodes:</span>
<span class="go">  ...</span>
<span class="go">      0x7fc5f382cc10: &lt;multiple use&gt;</span>
<span class="go">    0x7fc5f382cf10: ch = store 0x7fc5f382cd10, 0x7fc5f382ca10, 0x7fc5f382ce10,</span>
<span class="go">    0x7fc5f382cc10&lt;ST4[%c]&gt; [ORD=2] [ID=-3]</span>

<span class="go">    0x7fc5f382d010: i32 = GlobalAddress&lt;i32* @gI&gt; 0 [ORD=3] [ID=-3]</span>

<span class="go">    0x7fc5f382cc10: &lt;multiple use&gt;</span>
<span class="go">  0x7fc5f382d110: i32,ch = load 0x7fc5f382cf10, 0x7fc5f382d010,</span>
<span class="go">  0x7fc5f382cc10&lt;LD4[@gI]&gt; [ORD=3] [ID=-3]</span>

<span class="go">Legalized selection DAG: BB#0 &#39;_Z3funv:entry&#39;</span>
<span class="go">SelectionDAG has 15 nodes:</span>
<span class="go">  ...</span>
<span class="go">      0x7fc5f382cc10: &lt;multiple use&gt;</span>
<span class="go">    0x7fc5f382cf10: ch = store 0x7fc5f382cd10, 0x7fc5f382ca10, 0x7fc5f382ce10,</span>
<span class="go">    0x7fc5f382cc10&lt;ST4[%c]&gt; [ORD=2] [ID=8]</span>

<span class="go">      0x7fc5f382d710: i32 = register %GP</span>

<span class="go">        0x7fc5f382d310: i32 = TargetGlobalAddress&lt;i32* @gI&gt; 0 [TF=4]</span>

<span class="go">      0x7fc5f382d610: i32 = Cpu0ISD::GPRel 0x7fc5f382d310</span>

<span class="go">    0x7fc5f382d810: i32 = add 0x7fc5f382d710, 0x7fc5f382d610</span>

<span class="go">    0x7fc5f382cc10: &lt;multiple use&gt;</span>
<span class="go">  0x7fc5f382d110: i32,ch = load 0x7fc5f382cf10, 0x7fc5f382d810,</span>
<span class="go">  0x7fc5f382cc10&lt;LD4[@gI]&gt; [ORD=3] [ID=9]</span>
<span class="go">  ...</span>
</pre></div>
</div>
<p>Finally, the pattern defined in Cpu0InstrInfo.td as the following will translate
DAG (add register %GP Cpu0ISD::GPRel&lt;gI offset&gt;) into Cpu0
instruction as below.</p>
<p class="rubric">lbdex/chapters/Chapter6_1/Cpu0InstrInfo.td</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">Cpu0GPRel</span> <span class="p">:</span> <span class="n">SDNode</span><span class="o">&lt;</span><span class="s2">&quot;Cpu0ISD::GPRel&quot;</span><span class="p">,</span> <span class="n">SDTIntUnaryOp</span><span class="o">&gt;</span><span class="p">;</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>// gp_rel relocs
let Predicates = [Ch6_1] in {
def : Pat&lt;(add CPURegs:$gp, (Cpu0GPRel tglobaladdr:$in)),
          (ORi CPURegs:$gp, tglobaladdr:$in)&gt;;
}

</pre></div>
</div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">ori $2, $gp, %gp_rel(gI)</span>
<span class="go">...</span>
</pre></div>
</div>
<p>“Pat&lt;(add CPURegs:$gp, (Cpu0GPRel tglobaladdr:$in)), (ADD CPURegs:$gp, (ORi
ZERO, tglobaladdr:$in))&gt;;” will translate (add register %GP Cpu0ISD::GPRel
tglobaladdr) into (add $gp, (ori ZERO, tglobaladdr)).</p>
<p>In this mode, the $gp content is assigned at compile/link time, changed only at
program be loaded, and is fixed during the program running; on the contrary,
when -relocation-model=pic the $gp can be changed during program running.
For this example code, if $gp is assigned to the start address of .sdata by loader
when program ch6_1.cpu0.s is loaded, then linker can caculate %gp_rel(gI) (=
the relative address distance between gI and start of .sdata section).
Which meaning this relocation record can be solved at link time, that’s why it
is static mode.</p>
<p>In this mode, we reserve $gp to a specfic fixed address of the program is
loaded. As a result, the $gp cannot be allocated as a general purpose for
variables. The following code tells llvm never allocate $gp for variables.</p>
<p class="rubric">lbdex/chapters/Chapter6_1/Cpu0Subtarget.cpp</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Cpu0Subtarget</span><span class="p">::</span><span class="n">Cpu0Subtarget</span><span class="p">(</span><span class="n">const</span> <span class="n">Triple</span> <span class="o">&amp;</span><span class="n">TT</span><span class="p">,</span> <span class="n">StringRef</span> <span class="n">CPU</span><span class="p">,</span>
                             <span class="n">StringRef</span> <span class="n">FS</span><span class="p">,</span> <span class="nb">bool</span> <span class="n">little</span><span class="p">,</span> 
                             <span class="n">const</span> <span class="n">Cpu0TargetMachine</span> <span class="o">&amp;</span><span class="n">_TM</span><span class="p">)</span> <span class="p">:</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>  // Set UseSmallSection.
  UseSmallSection = UseSmallSectionOpt;
  Cpu0ReserveGP = ReserveGPOpt;
  Cpu0NoCpload = NoCploadOpt;
#ifdef ENABLE_GPRESTORE
  if (!TM.isPositionIndependent() &amp;&amp; !UseSmallSection &amp;&amp; !Cpu0ReserveGP)
    FixGlobalBaseReg = false;
  else
#endif
    FixGlobalBaseReg = true;
</pre></div>
</div>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter6_1/Cpu0RegisterInfo.cpp</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">BitVector</span> <span class="n">Cpu0RegisterInfo</span><span class="p">::</span>
<span class="n">getReservedRegs</span><span class="p">(</span><span class="n">const</span> <span class="n">MachineFunction</span> <span class="o">&amp;</span><span class="n">MF</span><span class="p">)</span> <span class="n">const</span> <span class="p">{</span>
<span class="o">//</span><span class="nd">@getReservedRegs</span> <span class="n">body</span> <span class="p">{</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#ifdef ENABLE_GPRESTORE //1</span>
  <span class="n">const</span> <span class="n">Cpu0FunctionInfo</span> <span class="o">*</span><span class="n">Cpu0FI</span> <span class="o">=</span> <span class="n">MF</span><span class="o">.</span><span class="n">getInfo</span><span class="o">&lt;</span><span class="n">Cpu0FunctionInfo</span><span class="o">&gt;</span><span class="p">();</span>
  <span class="o">//</span> <span class="n">Reserve</span> <span class="n">GP</span> <span class="k">if</span> <span class="n">globalBaseRegFixed</span><span class="p">()</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">Cpu0FI</span><span class="o">-&gt;</span><span class="n">globalBaseRegFixed</span><span class="p">())</span>
<span class="c1">#endif</span>
    <span class="n">Reserved</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">Cpu0</span><span class="p">::</span><span class="n">GP</span><span class="p">);</span>
</pre></div>
</div>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="p">...</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
</section>
<section id="pic-mode">
<h2><a class="toc-backref" href="#id16" role="doc-backlink">pic mode</a><a class="headerlink" href="#pic-mode" title="Permalink to this heading">¶</a></h2>
<section id="id2">
<h3><a class="toc-backref" href="#id17" role="doc-backlink">sdata or sbss</a><a class="headerlink" href="#id2" title="Permalink to this heading">¶</a></h3>
<p>Option <code class="docutils literal notranslate"><span class="pre">llc</span> <span class="pre">-relocation-model=pic</span> <span class="pre">-cpu0-use-small-section=true</span></code> will
generate the following instructions.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">  ...</span>
<span class="go">  .set        noreorder</span>
<span class="go">  .cpload     $6</span>
<span class="go">  .set        nomacro</span>
<span class="go">  ...</span>
<span class="go">  ld  $2, %got(gI)($gp)</span>
<span class="go">  ld  $2, 0($2)</span>
<span class="go">  ...</span>
<span class="go">  .type       gStart,@object          # @gStart</span>
<span class="go">  .data</span>
<span class="go">  .globl      gStart</span>
<span class="go">  .align      2</span>
<span class="go">gStart:</span>
<span class="go">  .4byte      2                       # 0x2</span>
<span class="go">  .size       gStart, 4</span>

<span class="go">  .type       gI,@object              # @gI</span>
<span class="go">  .globl      gI</span>
<span class="go">  .align      2</span>
<span class="go">gI:</span>
<span class="go">  .4byte      100                     # 0x64</span>
<span class="go">  .size       gI, 4</span>
</pre></div>
</div>
<p>The following code fragment of Cpu0AsmPrinter.cpp will emit <strong>.cpload</strong> asm
pseudo instruction at function entry point as below.</p>
<p class="rubric">lbdex/chapters/Chapter6_1/Cpu0MachineFunction.h</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">///</span> <span class="n">Cpu0FunctionInfo</span> <span class="o">-</span> <span class="n">This</span> <span class="k">class</span> <span class="nc">is</span> <span class="n">derived</span> <span class="kn">from</span> <span class="nn">MachineFunction</span> <span class="n">private</span>
<span class="o">///</span> <span class="n">Cpu0</span> <span class="n">target</span><span class="o">-</span><span class="n">specific</span> <span class="n">information</span> <span class="k">for</span> <span class="n">each</span> <span class="n">MachineFunction</span><span class="o">.</span>
<span class="k">class</span> <span class="nc">Cpu0FunctionInfo</span> <span class="p">:</span> <span class="n">public</span> <span class="n">MachineFunctionInfo</span> <span class="p">{</span>
<span class="n">public</span><span class="p">:</span>
  <span class="n">Cpu0FunctionInfo</span><span class="p">(</span><span class="n">MachineFunction</span><span class="o">&amp;</span> <span class="n">MF</span><span class="p">)</span>
  <span class="p">:</span> <span class="n">MF</span><span class="p">(</span><span class="n">MF</span><span class="p">),</span> 
    <span class="n">VarArgsFrameIndex</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> 
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>    <span class="n">GlobalBaseReg</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>  <span class="nb">bool</span> <span class="n">globalBaseRegFixed</span><span class="p">()</span> <span class="n">const</span><span class="p">;</span>
  <span class="nb">bool</span> <span class="n">globalBaseRegSet</span><span class="p">()</span> <span class="n">const</span><span class="p">;</span>
  <span class="n">unsigned</span> <span class="n">getGlobalBaseReg</span><span class="p">();</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>  <span class="o">///</span> <span class="n">GlobalBaseReg</span> <span class="o">-</span> <span class="n">keeps</span> <span class="n">track</span> <span class="n">of</span> <span class="n">the</span> <span class="n">virtual</span> <span class="n">register</span> <span class="n">initialized</span> <span class="k">for</span>
  <span class="o">///</span> <span class="n">use</span> <span class="k">as</span> <span class="n">the</span> <span class="k">global</span> <span class="n">base</span> <span class="n">register</span><span class="o">.</span> <span class="n">This</span> <span class="ow">is</span> <span class="n">used</span> <span class="k">for</span> <span class="n">PIC</span> <span class="ow">in</span> <span class="n">some</span> <span class="n">PIC</span>
  <span class="o">///</span> <span class="n">relocation</span> <span class="n">models</span><span class="o">.</span>
  <span class="n">unsigned</span> <span class="n">GlobalBaseReg</span><span class="p">;</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>  int GPFI; // Index of the frame object for restoring $gp
</pre></div>
</div>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="p">...</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>
</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter6_1/Cpu0MachineFunction.cpp</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">bool</span> <span class="n">Cpu0FunctionInfo</span><span class="p">::</span><span class="n">globalBaseRegFixed</span><span class="p">()</span> <span class="n">const</span> <span class="p">{</span>
  <span class="k">return</span> <span class="n">FixGlobalBaseReg</span><span class="p">;</span>
<span class="p">}</span>

<span class="nb">bool</span> <span class="n">Cpu0FunctionInfo</span><span class="p">::</span><span class="n">globalBaseRegSet</span><span class="p">()</span> <span class="n">const</span> <span class="p">{</span>
  <span class="k">return</span> <span class="n">GlobalBaseReg</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">unsigned</span> <span class="n">Cpu0FunctionInfo</span><span class="p">::</span><span class="n">getGlobalBaseReg</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="n">GlobalBaseReg</span> <span class="o">=</span> <span class="n">Cpu0</span><span class="p">::</span><span class="n">GP</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter6_1/Cpu0AsmPrinter.cpp</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">///</span> <span class="n">EmitFunctionBodyStart</span> <span class="o">-</span> <span class="n">Targets</span> <span class="n">can</span> <span class="n">override</span> <span class="n">this</span> <span class="n">to</span> <span class="n">emit</span> <span class="n">stuff</span> <span class="n">before</span>
<span class="o">///</span> <span class="n">the</span> <span class="n">first</span> <span class="n">basic</span> <span class="n">block</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">function</span><span class="o">.</span>
<span class="n">void</span> <span class="n">Cpu0AsmPrinter</span><span class="p">::</span><span class="n">emitFunctionBodyStart</span><span class="p">()</span> <span class="p">{</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>  <span class="nb">bool</span> <span class="n">EmitCPLoad</span> <span class="o">=</span> <span class="p">(</span><span class="n">MF</span><span class="o">-&gt;</span><span class="n">getTarget</span><span class="p">()</span><span class="o">.</span><span class="n">getRelocationModel</span><span class="p">()</span> <span class="o">==</span> <span class="n">Reloc</span><span class="p">::</span><span class="n">PIC_</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
    <span class="n">Cpu0FI</span><span class="o">-&gt;</span><span class="n">globalBaseRegSet</span><span class="p">()</span> <span class="o">&amp;&amp;</span>
    <span class="n">Cpu0FI</span><span class="o">-&gt;</span><span class="n">globalBaseRegFixed</span><span class="p">();</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">Cpu0NoCpload</span><span class="p">)</span>
    <span class="n">EmitCPLoad</span> <span class="o">=</span> <span class="n">false</span><span class="p">;</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>    <span class="o">//</span> <span class="n">Emit</span> <span class="o">.</span><span class="n">cpload</span> <span class="n">directive</span> <span class="k">if</span> <span class="n">needed</span><span class="o">.</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">EmitCPLoad</span><span class="p">)</span>
      <span class="n">OutStreamer</span><span class="o">-&gt;</span><span class="n">emitRawText</span><span class="p">(</span><span class="n">StringRef</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">.cpload</span><span class="se">\t</span><span class="s2">$t9&quot;</span><span class="p">));</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">EmitCPLoad</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">SmallVector</span><span class="o">&lt;</span><span class="n">MCInst</span><span class="p">,</span> <span class="mi">4</span><span class="o">&gt;</span> <span class="n">MCInsts</span><span class="p">;</span>
    <span class="n">MCInstLowering</span><span class="o">.</span><span class="n">LowerCPLOAD</span><span class="p">(</span><span class="n">MCInsts</span><span class="p">);</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">SmallVector</span><span class="o">&lt;</span><span class="n">MCInst</span><span class="p">,</span> <span class="mi">4</span><span class="o">&gt;</span><span class="p">::</span><span class="n">iterator</span> <span class="n">I</span> <span class="o">=</span> <span class="n">MCInsts</span><span class="o">.</span><span class="n">begin</span><span class="p">();</span>
       <span class="n">I</span> <span class="o">!=</span> <span class="n">MCInsts</span><span class="o">.</span><span class="n">end</span><span class="p">();</span> <span class="o">++</span><span class="n">I</span><span class="p">)</span>
      <span class="n">OutStreamer</span><span class="o">-&gt;</span><span class="n">emitInstruction</span><span class="p">(</span><span class="o">*</span><span class="n">I</span><span class="p">,</span> <span class="n">getSubtargetInfo</span><span class="p">());</span>
</pre></div>
</div>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">...</span>
<span class="go">.set        noreorder</span>
<span class="go">.cpload     $6</span>
<span class="go">.set        nomacro</span>
<span class="go">...</span>
</pre></div>
</div>
<p>The <strong>.cpload</strong> is the assembly directive (macro) which
will expand to several instructions.
Issue <strong>.cpload</strong> before <strong>.set nomacro</strong> since the <strong>.set nomacro</strong> option
causes the assembler to print a warning message whenever
an assembler operation generates more than one machine language instruction,
reference Mips ABI <a class="footnote-reference brackets" href="#id7" id="id3" role="doc-noteref"><span class="fn-bracket">[</span>2<span class="fn-bracket">]</span></a>.</p>
<p>Following code will exspand .cpload into machine instructions as below.
“0fa00000 09aa0000 13aa6000” is the <strong>.cpload</strong> machine instructions
displayed in comments of Cpu0MCInstLower.cpp.</p>
<p class="rubric">lbdex/chapters/Chapter6_1/Cpu0MCInstLower.h</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">///</span> <span class="n">This</span> <span class="k">class</span> <span class="nc">is</span> <span class="n">used</span> <span class="n">to</span> <span class="n">lower</span> <span class="n">an</span> <span class="n">MachineInstr</span> <span class="n">into</span> <span class="n">an</span> <span class="n">MCInst</span><span class="o">.</span>
<span class="k">class</span> <span class="nc">LLVM_LIBRARY_VISIBILITY</span> <span class="n">Cpu0MCInstLower</span> <span class="p">{</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>  <span class="n">void</span> <span class="n">LowerCPLOAD</span><span class="p">(</span><span class="n">SmallVector</span><span class="o">&lt;</span><span class="n">MCInst</span><span class="p">,</span> <span class="mi">4</span><span class="o">&gt;&amp;</span> <span class="n">MCInsts</span><span class="p">);</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">private</span><span class="p">:</span>
  <span class="n">MCOperand</span> <span class="n">LowerSymbolOperand</span><span class="p">(</span><span class="n">const</span> <span class="n">MachineOperand</span> <span class="o">&amp;</span><span class="n">MO</span><span class="p">,</span>
                               <span class="n">MachineOperandType</span> <span class="n">MOTy</span><span class="p">,</span> <span class="n">unsigned</span> <span class="n">Offset</span><span class="p">)</span> <span class="n">const</span><span class="p">;</span>
</pre></div>
</div>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="p">...</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter6_1/Cpu0MCInstLower.cpp</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//</span> <span class="n">Lower</span> <span class="s2">&quot;.cpload $reg&quot;</span> <span class="n">to</span>
<span class="o">//</span>  <span class="s2">&quot;lui   $gp, </span><span class="si">%hi</span><span class="s2">(_gp_disp)&quot;</span>
<span class="o">//</span>  <span class="s2">&quot;addiu $gp, $gp, </span><span class="si">%lo</span><span class="s2">(_gp_disp)&quot;</span>
<span class="o">//</span>  <span class="s2">&quot;addu  $gp, $gp, $t9&quot;</span>
<span class="n">void</span> <span class="n">Cpu0MCInstLower</span><span class="p">::</span><span class="n">LowerCPLOAD</span><span class="p">(</span><span class="n">SmallVector</span><span class="o">&lt;</span><span class="n">MCInst</span><span class="p">,</span> <span class="mi">4</span><span class="o">&gt;&amp;</span> <span class="n">MCInsts</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">MCOperand</span> <span class="n">GPReg</span> <span class="o">=</span> <span class="n">MCOperand</span><span class="p">::</span><span class="n">createReg</span><span class="p">(</span><span class="n">Cpu0</span><span class="p">::</span><span class="n">GP</span><span class="p">);</span>
  <span class="n">MCOperand</span> <span class="n">T9Reg</span> <span class="o">=</span> <span class="n">MCOperand</span><span class="p">::</span><span class="n">createReg</span><span class="p">(</span><span class="n">Cpu0</span><span class="p">::</span><span class="n">T9</span><span class="p">);</span>
  <span class="n">StringRef</span> <span class="n">SymName</span><span class="p">(</span><span class="s2">&quot;_gp_disp&quot;</span><span class="p">);</span>
  <span class="n">const</span> <span class="n">MCSymbol</span> <span class="o">*</span><span class="n">Sym</span> <span class="o">=</span> <span class="n">Ctx</span><span class="o">-&gt;</span><span class="n">getOrCreateSymbol</span><span class="p">(</span><span class="n">SymName</span><span class="p">);</span>
  <span class="n">const</span> <span class="n">Cpu0MCExpr</span> <span class="o">*</span><span class="n">MCSym</span><span class="p">;</span>

  <span class="n">MCSym</span> <span class="o">=</span> <span class="n">Cpu0MCExpr</span><span class="p">::</span><span class="n">create</span><span class="p">(</span><span class="n">Sym</span><span class="p">,</span> <span class="n">Cpu0MCExpr</span><span class="p">::</span><span class="n">CEK_ABS_HI</span><span class="p">,</span> <span class="o">*</span><span class="n">Ctx</span><span class="p">);</span>
  <span class="n">MCOperand</span> <span class="n">SymHi</span> <span class="o">=</span> <span class="n">MCOperand</span><span class="p">::</span><span class="n">createExpr</span><span class="p">(</span><span class="n">MCSym</span><span class="p">);</span>
  <span class="n">MCSym</span> <span class="o">=</span> <span class="n">Cpu0MCExpr</span><span class="p">::</span><span class="n">create</span><span class="p">(</span><span class="n">Sym</span><span class="p">,</span> <span class="n">Cpu0MCExpr</span><span class="p">::</span><span class="n">CEK_ABS_LO</span><span class="p">,</span> <span class="o">*</span><span class="n">Ctx</span><span class="p">);</span>
  <span class="n">MCOperand</span> <span class="n">SymLo</span> <span class="o">=</span> <span class="n">MCOperand</span><span class="p">::</span><span class="n">createExpr</span><span class="p">(</span><span class="n">MCSym</span><span class="p">);</span>

  <span class="n">MCInsts</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>

  <span class="n">CreateMCInst</span><span class="p">(</span><span class="n">MCInsts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">Cpu0</span><span class="p">::</span><span class="n">LUi</span><span class="p">,</span> <span class="n">GPReg</span><span class="p">,</span> <span class="n">SymHi</span><span class="p">);</span>
  <span class="n">CreateMCInst</span><span class="p">(</span><span class="n">MCInsts</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">Cpu0</span><span class="p">::</span><span class="n">ORi</span><span class="p">,</span> <span class="n">GPReg</span><span class="p">,</span> <span class="n">GPReg</span><span class="p">,</span> <span class="n">SymLo</span><span class="p">);</span>
  <span class="n">CreateMCInst</span><span class="p">(</span><span class="n">MCInsts</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">Cpu0</span><span class="p">::</span><span class="n">ADD</span><span class="p">,</span> <span class="n">GPReg</span><span class="p">,</span> <span class="n">GPReg</span><span class="p">,</span> <span class="n">T9Reg</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">118-165-76-131:input Jonathan$ </span>/Users/Jonathan/llvm/test/
<span class="go">build/bin/llc -march=cpu0 -relocation-model=pic -filetype=</span>
<span class="go">obj ch6_1.bc -o ch6_1.cpu0.o</span>
<span class="gp">118-165-76-131:input Jonathan$ </span>gobjdump -s ch6_1.cpu0.o

<span class="go">ch6_1.cpu0.o:     file format elf32-big</span>

<span class="go">Contents of section .text:</span>
<span class="go"> 0000 0fa00000 0daa0000 13aa6000  ...</span>
<span class="go">...</span>

<span class="gp">118-165-76-131:input Jonathan$ </span>gobjdump -tr ch6_1.cpu0.o
<span class="go">...</span>
<span class="go">RELOCATION RECORDS FOR [.text]:</span>
<span class="go">OFFSET   TYPE              VALUE</span>
<span class="go">00000000 UNKNOWN           _gp_disp</span>
<span class="go">00000008 UNKNOWN           _gp_disp</span>
<span class="go">00000020 UNKNOWN           gI</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>// <strong>Mips ABI: _gp_disp</strong>
After calculating the gp, a function allocates the local stack space and saves
the gp on the stack, so it can be restored after subsequent function calls.
In other words, the gp is a caller saved register.</p>
<p>…</p>
<p>_gp_disp represents the offset between the beginning of the function and the
global offset table.
Various optimizations are possible in this code example and the others that
follow.
For example, the calculation of gp need not be done for a position-independent
function that is strictly local to an object module.</p>
</div>
<p>The _gp_disp as above is a relocation record, it means both the machine
instructions 0da00000 (offset 0) and 0daa0000 (offset 8) which equal to assembly
“ori $gp, $zero, %hi(_gp_disp)” and assembly “ori $gp, $gp, %lo(_gp_disp)”,
respectively, are relocated records depend on _gp_disp.
The loader or OS can caculate _gp_disp by (x - start address of .data)
when load the dynamic function into memory x, and adjusts these two
instructions offet correctly.
Since shared function is loaded when this function is called, the relocation
record “ld $2, %got(gI)($gp)” cannot be resolved in link time.
In spite of the reloation record is solved on load time, the name binding
is static, since linker deliver the memory address to loader, and loader can solve
this just by caculate the offset directly. The memory reference bind with
the offset of _gp_disp at link time.
The ELF relocation records will be introduced in Chapter ELF Support.
So, don’t worry if you don’t quite understand it at this point.</p>
<p>The code fragment of lowerGlobalAddress() as the following corresponding option
<code class="docutils literal notranslate"><span class="pre">llc</span> <span class="pre">-relocation-model=pic</span></code> will translate DAG (GlobalAddress&lt;i32* &#64;gI&gt; 0) into
(load EntryToken, (Cpu0ISD::Wrapper Register %GP, TargetGlobalAddress&lt;i32* &#64;gI&gt; 0))
in stage “Legalized selection DAG” as below.</p>
<p class="rubric">lbdex/chapters/Chapter6_1/Cpu0ISelLowering.h</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>    // This method creates the following nodes, which are necessary for
    // computing a global symbol&#39;s address:
    //
    // (load (wrapper $gp, %got(sym)))
    template&lt;class NodeTy&gt;
    SDValue getAddrGlobal(NodeTy *N, EVT Ty, SelectionDAG &amp;DAG,
                          unsigned Flag, SDValue Chain,
                          const MachinePointerInfo &amp;PtrInfo) const {
      SDLoc DL(N);
      SDValue Tgt = DAG.getNode(Cpu0ISD::Wrapper, DL, Ty, getGlobalReg(DAG, Ty),
                                getTargetNode(N, Ty, DAG, Flag));
      return DAG.getLoad(Ty, DL, Chain, Tgt, PtrInfo);
    }
</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter6_1/Cpu0ISelLowering.cpp</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SDValue</span> <span class="n">Cpu0TargetLowering</span><span class="p">::</span><span class="n">lowerGlobalAddress</span><span class="p">(</span><span class="n">SDValue</span> <span class="n">Op</span><span class="p">,</span>
                                               <span class="n">SelectionDAG</span> <span class="o">&amp;</span><span class="n">DAG</span><span class="p">)</span> <span class="n">const</span> <span class="p">{</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>  <span class="n">EVT</span> <span class="n">Ty</span> <span class="o">=</span> <span class="n">Op</span><span class="o">.</span><span class="n">getValueType</span><span class="p">();</span>
  <span class="n">GlobalAddressSDNode</span> <span class="o">*</span><span class="n">N</span> <span class="o">=</span> <span class="n">cast</span><span class="o">&lt;</span><span class="n">GlobalAddressSDNode</span><span class="o">&gt;</span><span class="p">(</span><span class="n">Op</span><span class="p">);</span>
  <span class="n">const</span> <span class="n">GlobalValue</span> <span class="o">*</span><span class="n">GV</span> <span class="o">=</span> <span class="n">N</span><span class="o">-&gt;</span><span class="n">getGlobal</span><span class="p">();</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>    <span class="n">const</span> <span class="n">GlobalObject</span> <span class="o">*</span><span class="n">GO</span> <span class="o">=</span> <span class="n">GV</span><span class="o">-&gt;</span><span class="n">getBaseObject</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">GO</span> <span class="o">&amp;&amp;</span> <span class="n">TLOF</span><span class="o">-&gt;</span><span class="n">IsGlobalInSmallSection</span><span class="p">(</span><span class="n">GO</span><span class="p">,</span> <span class="n">getTargetMachine</span><span class="p">()))</span> <span class="p">{</span>
      <span class="n">SDValue</span> <span class="n">GA</span> <span class="o">=</span> <span class="n">DAG</span><span class="o">.</span><span class="n">getTargetGlobalAddress</span><span class="p">(</span><span class="n">GV</span><span class="p">,</span> <span class="n">DL</span><span class="p">,</span> <span class="n">MVT</span><span class="p">::</span><span class="n">i32</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
                                              <span class="n">Cpu0II</span><span class="p">::</span><span class="n">MO_GPREL</span><span class="p">);</span>
      <span class="n">SDValue</span> <span class="n">GPRelNode</span> <span class="o">=</span> <span class="n">DAG</span><span class="o">.</span><span class="n">getNode</span><span class="p">(</span><span class="n">Cpu0ISD</span><span class="p">::</span><span class="n">GPRel</span><span class="p">,</span> <span class="n">DL</span><span class="p">,</span>
                                      <span class="n">DAG</span><span class="o">.</span><span class="n">getVTList</span><span class="p">(</span><span class="n">MVT</span><span class="p">::</span><span class="n">i32</span><span class="p">),</span> <span class="n">GA</span><span class="p">);</span>
      <span class="n">SDValue</span> <span class="n">GPReg</span> <span class="o">=</span> <span class="n">DAG</span><span class="o">.</span><span class="n">getRegister</span><span class="p">(</span><span class="n">Cpu0</span><span class="p">::</span><span class="n">GP</span><span class="p">,</span> <span class="n">MVT</span><span class="p">::</span><span class="n">i32</span><span class="p">);</span>
      <span class="k">return</span> <span class="n">DAG</span><span class="o">.</span><span class="n">getNode</span><span class="p">(</span><span class="n">ISD</span><span class="p">::</span><span class="n">ADD</span><span class="p">,</span> <span class="n">DL</span><span class="p">,</span> <span class="n">MVT</span><span class="p">::</span><span class="n">i32</span><span class="p">,</span> <span class="n">GPReg</span><span class="p">,</span> <span class="n">GPRelNode</span><span class="p">);</span>
    <span class="p">}</span>

</pre></div>
</div>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="p">...</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter6_1/Cpu0ISelDAGToDAG.cpp</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">///</span> <span class="n">ComplexPattern</span> <span class="n">used</span> <span class="n">on</span> <span class="n">Cpu0InstrInfo</span>
<span class="o">///</span> <span class="n">Used</span> <span class="n">on</span> <span class="n">Cpu0</span> <span class="n">Load</span><span class="o">/</span><span class="n">Store</span> <span class="n">instructions</span>
<span class="nb">bool</span> <span class="n">Cpu0DAGToDAGISel</span><span class="p">::</span>
<span class="n">SelectAddr</span><span class="p">(</span><span class="n">SDNode</span> <span class="o">*</span><span class="n">Parent</span><span class="p">,</span> <span class="n">SDValue</span> <span class="n">Addr</span><span class="p">,</span> <span class="n">SDValue</span> <span class="o">&amp;</span><span class="n">Base</span><span class="p">,</span> <span class="n">SDValue</span> <span class="o">&amp;</span><span class="n">Offset</span><span class="p">)</span> <span class="p">{</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>  <span class="o">//</span> <span class="n">on</span> <span class="n">PIC</span> <span class="n">code</span> <span class="n">Load</span> <span class="n">GA</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">Addr</span><span class="o">.</span><span class="n">getOpcode</span><span class="p">()</span> <span class="o">==</span> <span class="n">Cpu0ISD</span><span class="p">::</span><span class="n">Wrapper</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">Base</span>   <span class="o">=</span> <span class="n">Addr</span><span class="o">.</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
    <span class="n">Offset</span> <span class="o">=</span> <span class="n">Addr</span><span class="o">.</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">true</span><span class="p">;</span>
  <span class="p">}</span>

</pre></div>
</div>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="p">...</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">...</span>
<span class="go">Type-legalized selection DAG: BB#0 &#39;_Z3funv:entry&#39;</span>
<span class="go">SelectionDAG has 12 nodes:</span>
<span class="go">  ...</span>
<span class="go">      0x7fad7102cc10: &lt;multiple use&gt;</span>
<span class="go">    0x7fad7102cf10: ch = store 0x7fad7102cd10, 0x7fad7102ca10, 0x7fad7102ce10,</span>
<span class="go">    0x7fad7102cc10&lt;ST4[%c]&gt; [ORD=2] [ID=-3]</span>

<span class="go">    0x7fad7102d010: i32 = GlobalAddress&lt;i32* @gI&gt; 0 [ORD=3] [ID=-3]</span>

<span class="go">    0x7fad7102cc10: &lt;multiple use&gt;</span>
<span class="go">  0x7fad7102d110: i32,ch = load 0x7fad7102cf10, 0x7fad7102d010,</span>
<span class="go">  0x7fad7102cc10&lt;LD4[@gI]&gt; [ORD=3] [ID=-3]</span>
<span class="go">  ...</span>
<span class="go">Legalized selection DAG: BB#0 &#39;_Z3funv:entry&#39;</span>
<span class="go">SelectionDAG has 15 nodes:</span>
<span class="go">  0x7ff3c9c10b98: ch = EntryToken [ORD=1] [ID=0]</span>
<span class="go">  ...</span>
<span class="go">      0x7fad7102cc10: &lt;multiple use&gt;</span>
<span class="go">    0x7fad7102cf10: ch = store 0x7fad7102cd10, 0x7fad7102ca10, 0x7fad7102ce10,</span>
<span class="go">    0x7fad7102cc10&lt;ST4[%c]&gt; [ORD=2] [ID=8]</span>

<span class="go">      0x7fad70c10b98: &lt;multiple use&gt;</span>
<span class="go">        0x7fad7102d610: i32 = Register %GP</span>

<span class="go">        0x7fad7102d310: i32 = TargetGlobalAddress&lt;i32* @gI&gt; 0 [TF=1]</span>

<span class="go">      0x7fad7102d710: i32 = Cpu0ISD::Wrapper 0x7fad7102d610, 0x7fad7102d310</span>

<span class="go">      0x7fad7102cc10: &lt;multiple use&gt;</span>
<span class="go">    0x7fad7102d810: i32,ch = load 0x7fad70c10b98, 0x7fad7102d710,</span>
<span class="go">    0x7fad7102cc10&lt;LD4[&lt;unknown&gt;]&gt;</span>
<span class="go">    0x7ff3ca02cc10: &lt;multiple use&gt;</span>
<span class="go">  0x7ff3ca02d110: i32,ch = load 0x7ff3ca02cf10, 0x7ff3ca02d810,</span>
<span class="go">  0x7ff3ca02cc10&lt;LD4[@gI]&gt; [ORD=3] [ID=9]</span>
<span class="go">  ...</span>
</pre></div>
</div>
<p>Finally, the pattern Cpu0 instruction <strong>ld</strong> defined before in Cpu0InstrInfo.td
will translate DAG (load EntryToken, (Cpu0ISD::Wrapper Register %GP,
TargetGlobalAddress&lt;i32* &#64;gI&gt; 0)) into Cpu0 instruction as follows,</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">...</span>
<span class="go">ld  $2, %got(gI)($gp)</span>
<span class="go">...</span>
</pre></div>
</div>
<p>Remind in pic mode, Cpu0 uses “.cpload” and “ld $2, %got(gI)($gp)” to access
global variable as Mips. It takes 4 instructions in both Cpu0 and Mips.
The cost came from we didn’t assume that register $gp is always assigned to
address .sdata and fixed there. Even we reserve $gp in this function, the $gp
register can be changed at other functions. In last sub-section, the $gp is
assumed to preserved at any function. If $gp is fixed during the run time, then
“.cpload” can be removed here and have only one instruction cost in global
variable access. The advantage of “.cpload” removing come from losing one
general purpose register $gp which can be allocated for variables.
In last sub-section, .sdata mode, we use “.cpload” removing since it is
static link.
In pic mode, the dynamic loading takes too much time.
Romove “.cpload” with the cost of losing one general purpose register at all
functions is not deserved here.
The relocation records of “.cpload” from <code class="docutils literal notranslate"><span class="pre">llc</span> <span class="pre">-relocation-model=pic</span></code> can also
be solved in link stage if we want to link this function by static link.</p>
</section>
<section id="id4">
<h3><a class="toc-backref" href="#id18" role="doc-backlink">data or bss</a><a class="headerlink" href="#id4" title="Permalink to this heading">¶</a></h3>
<p>The code fragment of lowerGlobalAddress() as the following corresponding option
<code class="docutils literal notranslate"><span class="pre">llc</span> <span class="pre">-relocation-model=pic</span></code> will translate DAG (GlobalAddress&lt;i32* &#64;gI&gt; 0) into
(load EntryToken, (Cpu0ISD::Wrapper (add Cpu0ISD::Hi&lt;gI offset Hi16&gt;, Register %GP),
TargetGlobalAddress&lt;i32* &#64;gI&gt; 0))
in stage “Legalized selection DAG” as below.</p>
<p class="rubric">lbdex/chapters/Chapter6_1/Cpu0ISelLowering.h</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>    // This method creates the following nodes, which are necessary for
    // computing a global symbol&#39;s address in large-GOT mode:
    //
    // (load (wrapper (add %hi(sym), $gp), %lo(sym)))
    template&lt;class NodeTy&gt;
    SDValue getAddrGlobalLargeGOT(NodeTy *N, EVT Ty, SelectionDAG &amp;DAG,
                                  unsigned HiFlag, unsigned LoFlag,
                                  SDValue Chain,
                                  const MachinePointerInfo &amp;PtrInfo) const {
      SDLoc DL(N);
      SDValue Hi = DAG.getNode(Cpu0ISD::Hi, DL, Ty,
                               getTargetNode(N, Ty, DAG, HiFlag));
      Hi = DAG.getNode(ISD::ADD, DL, Ty, Hi, getGlobalReg(DAG, Ty));
      SDValue Wrapper = DAG.getNode(Cpu0ISD::Wrapper, DL, Ty, Hi,
                                    getTargetNode(N, Ty, DAG, LoFlag));
      return DAG.getLoad(Ty, DL, Chain, Wrapper, PtrInfo);
    }
</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter6_1/Cpu0ISelLowering.cpp</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SDValue</span> <span class="n">Cpu0TargetLowering</span><span class="p">::</span><span class="n">lowerGlobalAddress</span><span class="p">(</span><span class="n">SDValue</span> <span class="n">Op</span><span class="p">,</span>
                                               <span class="n">SelectionDAG</span> <span class="o">&amp;</span><span class="n">DAG</span><span class="p">)</span> <span class="n">const</span> <span class="p">{</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>  <span class="n">EVT</span> <span class="n">Ty</span> <span class="o">=</span> <span class="n">Op</span><span class="o">.</span><span class="n">getValueType</span><span class="p">();</span>
  <span class="n">GlobalAddressSDNode</span> <span class="o">*</span><span class="n">N</span> <span class="o">=</span> <span class="n">cast</span><span class="o">&lt;</span><span class="n">GlobalAddressSDNode</span><span class="o">&gt;</span><span class="p">(</span><span class="n">Op</span><span class="p">);</span>
  <span class="n">const</span> <span class="n">GlobalValue</span> <span class="o">*</span><span class="n">GV</span> <span class="o">=</span> <span class="n">N</span><span class="o">-&gt;</span><span class="n">getGlobal</span><span class="p">();</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>  const GlobalObject *GO = GV-&gt;getBaseObject();
  if (GO &amp;&amp; !TLOF-&gt;IsGlobalInSmallSection(GO, getTargetMachine()))
    return getAddrGlobalLargeGOT(
        N, Ty, DAG, Cpu0II::MO_GOT_HI16, Cpu0II::MO_GOT_LO16, 
        DAG.getEntryNode(), 
        MachinePointerInfo::getGOT(DAG.getMachineFunction()));
  return getAddrGlobal(
      N, Ty, DAG, Cpu0II::MO_GOT, DAG.getEntryNode(), 
      MachinePointerInfo::getGOT(DAG.getMachineFunction()));
}
</pre></div>
</div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">...</span>
<span class="go">Type-legalized selection DAG: BB#0 &#39;_Z3funv:&#39;</span>
<span class="go">SelectionDAG has 10 nodes:</span>
<span class="go">  ...</span>
<span class="go">    0x7fb77a02cd10: ch = store 0x7fb779c10a08, 0x7fb77a02ca10, 0x7fb77a02cb10,</span>
<span class="go">    0x7fb77a02cc10&lt;ST4[%c]&gt; [ORD=1] [ID=-3]</span>

<span class="go">    0x7fb77a02ce10: i32 = GlobalAddress&lt;i32* @gI&gt; 0 [ORD=2] [ID=-3]</span>

<span class="go">    0x7fb77a02cc10: &lt;multiple use&gt;</span>
<span class="go">  0x7fb77a02cf10: i32,ch = load 0x7fb77a02cd10, 0x7fb77a02ce10,</span>
<span class="go">  0x7fb77a02cc10&lt;LD4[@gI]&gt; [ORD=2] [ID=-3]</span>
<span class="go">  ...</span>

<span class="go">Legalized selection DAG: BB#0 &#39;_Z3funv:&#39;</span>
<span class="go">SelectionDAG has 16 nodes:</span>
<span class="go">  ...</span>
<span class="go">    0x7fb77a02cd10: ch = store 0x7fb779c10a08, 0x7fb77a02ca10, 0x7fb77a02cb10,</span>
<span class="go">    0x7fb77a02cc10&lt;ST4[%c]&gt; [ORD=1] [ID=6]</span>

<span class="go">      0x7fb779c10a08: &lt;multiple use&gt;</span>
<span class="go">            0x7fb77a02d110: i32 = TargetGlobalAddress&lt;i32* @gI&gt; 0 [TF=19]</span>

<span class="go">          0x7fb77a02d410: i32 = Cpu0ISD::Hi 0x7fb77a02d110</span>

<span class="go">          0x7fb77a02d510: i32 = Register %GP</span>

<span class="go">        0x7fb77a02d610: i32 = add 0x7fb77a02d410, 0x7fb77a02d510</span>

<span class="go">        0x7fb77a02d710: i32 = TargetGlobalAddress&lt;i32* @gI&gt; 0 [TF=20]</span>

<span class="go">      0x7fb77a02d810: i32 = Cpu0ISD::Wrapper 0x7fb77a02d610, 0x7fb77a02d710</span>

<span class="go">      0x7fb77a02cc10: &lt;multiple use&gt;</span>
<span class="go">    0x7fb77a02fe10: i32,ch = load 0x7fb779c10a08, 0x7fb77a02d810,</span>
<span class="go">    0x7fb77a02cc10&lt;LD4[GOT]&gt;</span>

<span class="go">    0x7fb77a02cc10: &lt;multiple use&gt;</span>
<span class="go">  0x7fb77a02cf10: i32,ch = load 0x7fb77a02cd10, 0x7fb77a02fe10,</span>
<span class="go">  0x7fb77a02cc10&lt;LD4[@gI]&gt; [ORD=2] [ID=7]</span>
<span class="go">  ...</span>
</pre></div>
</div>
<p>Finally, the pattern Cpu0 instruction <strong>ld</strong> defined before in Cpu0InstrInfo.td
will translate DAG (load EntryToken, (Cpu0ISD::Wrapper (add Cpu0ISD::Hi&lt;gI
offset Hi16&gt;, Register %GP), Cpu0ISD::Lo&lt;gI offset Lo16&gt;)) into Cpu0
instructions as below.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">...</span>
<span class="go">ori $2, $zero, %got_hi(gI)</span>
<span class="gp">shl $</span><span class="m">2</span>, <span class="nv">$2</span>, <span class="m">16</span>
<span class="go">add $2, $2, $gp</span>
<span class="go">ld  $2, %got_lo(gI)($2)</span>
<span class="go">...</span>
</pre></div>
</div>
<p>The following code in Cpu0InstrInfo.td is needed for example input
ch8_2_select_global_pic.cpp.
Since ch8_2_select_global_pic.cpp uses llvm IR <strong>select</strong>, it cannot be run at
this point. It will be run in later Chapter Control flow statements.</p>
<p class="rubric">lbdex/chapters/Chapter6_1/Cpu0InstrInfo.td</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">Cpu0Wrapper</span>    <span class="p">:</span> <span class="n">SDNode</span><span class="o">&lt;</span><span class="s2">&quot;Cpu0ISD::Wrapper&quot;</span><span class="p">,</span> <span class="n">SDTIntBinOp</span><span class="o">&gt;</span><span class="p">;</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>let Predicates = [Ch6_1] in {
class WrapperPat&lt;SDNode node, Instruction ORiOp, RegisterClass RC&gt;:
      Pat&lt;(Cpu0Wrapper RC:$gp, node:$in),
              (ORiOp RC:$gp, node:$in)&gt;;

def : WrapperPat&lt;tglobaladdr, ORi, GPROut&gt;;
}
</pre></div>
</div>
<p class="rubric">lbdex/input/ch8_2_select_global_pic.cpp</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">volatile</span> <span class="nb">int</span> <span class="n">a1</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">volatile</span> <span class="nb">int</span> <span class="n">b1</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>

<span class="nb">int</span> <span class="n">gI1</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
<span class="nb">int</span> <span class="n">gJ1</span> <span class="o">=</span> <span class="mi">50</span><span class="p">;</span>

<span class="nb">int</span> <span class="n">test_select_global_pic</span><span class="p">()</span>
<span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">a1</span> <span class="o">&lt;</span> <span class="n">b1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">gI1</span><span class="p">;</span>
  <span class="k">else</span>
    <span class="k">return</span> <span class="n">gJ1</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
</section>
<section id="global-variable-print-support">
<h2><a class="toc-backref" href="#id19" role="doc-backlink">Global variable print support</a><a class="headerlink" href="#global-variable-print-support" title="Permalink to this heading">¶</a></h2>
<p>Above code is for global address DAG translation.
Next, add the following code to Cpu0MCInstLower.cpp and
Cpu0ISelLowering.cpp for global variable printing operand function.</p>
<p class="rubric">lbdex/chapters/Chapter6_1/Cpu0MCInstLower.cpp</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">MCOperand</span> <span class="n">Cpu0MCInstLower</span><span class="p">::</span><span class="n">LowerSymbolOperand</span><span class="p">(</span><span class="n">const</span> <span class="n">MachineOperand</span> <span class="o">&amp;</span><span class="n">MO</span><span class="p">,</span>
                                              <span class="n">MachineOperandType</span> <span class="n">MOTy</span><span class="p">,</span>
                                              <span class="n">unsigned</span> <span class="n">Offset</span><span class="p">)</span> <span class="n">const</span> <span class="p">{</span>
  <span class="n">MCSymbolRefExpr</span><span class="p">::</span><span class="n">VariantKind</span> <span class="n">Kind</span> <span class="o">=</span> <span class="n">MCSymbolRefExpr</span><span class="p">::</span><span class="n">VK_None</span><span class="p">;</span>
  <span class="n">Cpu0MCExpr</span><span class="p">::</span><span class="n">Cpu0ExprKind</span> <span class="n">TargetKind</span> <span class="o">=</span> <span class="n">Cpu0MCExpr</span><span class="p">::</span><span class="n">CEK_None</span><span class="p">;</span>
  <span class="n">const</span> <span class="n">MCSymbol</span> <span class="o">*</span><span class="n">Symbol</span><span class="p">;</span>

  <span class="n">switch</span><span class="p">(</span><span class="n">MO</span><span class="o">.</span><span class="n">getTargetFlags</span><span class="p">())</span> <span class="p">{</span>
  <span class="n">default</span><span class="p">:</span>                   <span class="n">llvm_unreachable</span><span class="p">(</span><span class="s2">&quot;Invalid target flag!&quot;</span><span class="p">);</span>
  <span class="k">case</span> <span class="n">Cpu0II</span><span class="p">::</span><span class="n">MO_NO_FLAG</span><span class="p">:</span>
    <span class="k">break</span><span class="p">;</span>

<span class="o">//</span> <span class="n">Cpu0_GPREL</span> <span class="ow">is</span> <span class="k">for</span> <span class="n">llc</span> <span class="o">-</span><span class="n">march</span><span class="o">=</span><span class="n">cpu0</span> <span class="o">-</span><span class="n">relocation</span><span class="o">-</span><span class="n">model</span><span class="o">=</span><span class="n">static</span> <span class="o">-</span><span class="n">cpu0</span><span class="o">-</span><span class="n">islinux</span><span class="o">-</span>
<span class="o">//</span>  <span class="nb">format</span><span class="o">=</span><span class="n">false</span> <span class="p">(</span><span class="k">global</span> <span class="n">var</span> <span class="ow">in</span> <span class="o">.</span><span class="n">sdata</span><span class="p">)</span><span class="o">.</span>
  <span class="k">case</span> <span class="n">Cpu0II</span><span class="p">::</span><span class="n">MO_GPREL</span><span class="p">:</span>
    <span class="n">TargetKind</span> <span class="o">=</span> <span class="n">Cpu0MCExpr</span><span class="p">::</span><span class="n">CEK_GPREL</span><span class="p">;</span>
    <span class="k">break</span><span class="p">;</span>

  <span class="k">case</span> <span class="n">Cpu0II</span><span class="p">::</span><span class="n">MO_GOT</span><span class="p">:</span>
    <span class="n">TargetKind</span> <span class="o">=</span> <span class="n">Cpu0MCExpr</span><span class="p">::</span><span class="n">CEK_GOT</span><span class="p">;</span>
    <span class="k">break</span><span class="p">;</span>
<span class="o">//</span> <span class="n">ABS_HI</span> <span class="ow">and</span> <span class="n">ABS_LO</span> <span class="ow">is</span> <span class="k">for</span> <span class="n">llc</span> <span class="o">-</span><span class="n">march</span><span class="o">=</span><span class="n">cpu0</span> <span class="o">-</span><span class="n">relocation</span><span class="o">-</span><span class="n">model</span><span class="o">=</span><span class="n">static</span> <span class="p">(</span><span class="k">global</span> 
<span class="o">//</span>  <span class="n">var</span> <span class="ow">in</span> <span class="o">.</span><span class="n">data</span><span class="p">)</span><span class="o">.</span>
  <span class="k">case</span> <span class="n">Cpu0II</span><span class="p">::</span><span class="n">MO_ABS_HI</span><span class="p">:</span>
    <span class="n">TargetKind</span> <span class="o">=</span> <span class="n">Cpu0MCExpr</span><span class="p">::</span><span class="n">CEK_ABS_HI</span><span class="p">;</span>
    <span class="k">break</span><span class="p">;</span>
  <span class="k">case</span> <span class="n">Cpu0II</span><span class="p">::</span><span class="n">MO_ABS_LO</span><span class="p">:</span>
    <span class="n">TargetKind</span> <span class="o">=</span> <span class="n">Cpu0MCExpr</span><span class="p">::</span><span class="n">CEK_ABS_LO</span><span class="p">;</span>
    <span class="k">break</span><span class="p">;</span>
  <span class="k">case</span> <span class="n">Cpu0II</span><span class="p">::</span><span class="n">MO_GOT_HI16</span><span class="p">:</span>
    <span class="n">TargetKind</span> <span class="o">=</span> <span class="n">Cpu0MCExpr</span><span class="p">::</span><span class="n">CEK_GOT_HI16</span><span class="p">;</span>
    <span class="k">break</span><span class="p">;</span>
  <span class="k">case</span> <span class="n">Cpu0II</span><span class="p">::</span><span class="n">MO_GOT_LO16</span><span class="p">:</span>
    <span class="n">TargetKind</span> <span class="o">=</span> <span class="n">Cpu0MCExpr</span><span class="p">::</span><span class="n">CEK_GOT_LO16</span><span class="p">;</span>
    <span class="k">break</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="n">switch</span> <span class="p">(</span><span class="n">MOTy</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">case</span> <span class="n">MachineOperand</span><span class="p">::</span><span class="n">MO_GlobalAddress</span><span class="p">:</span>
    <span class="n">Symbol</span> <span class="o">=</span> <span class="n">AsmPrinter</span><span class="o">.</span><span class="n">getSymbol</span><span class="p">(</span><span class="n">MO</span><span class="o">.</span><span class="n">getGlobal</span><span class="p">());</span>
    <span class="n">Offset</span> <span class="o">+=</span> <span class="n">MO</span><span class="o">.</span><span class="n">getOffset</span><span class="p">();</span>
    <span class="k">break</span><span class="p">;</span>

  <span class="n">default</span><span class="p">:</span>
    <span class="n">llvm_unreachable</span><span class="p">(</span><span class="s2">&quot;&lt;unknown operand type&gt;&quot;</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="n">const</span> <span class="n">MCExpr</span> <span class="o">*</span><span class="n">Expr</span> <span class="o">=</span> <span class="n">MCSymbolRefExpr</span><span class="p">::</span><span class="n">create</span><span class="p">(</span><span class="n">Symbol</span><span class="p">,</span> <span class="n">Kind</span><span class="p">,</span> <span class="o">*</span><span class="n">Ctx</span><span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">Offset</span><span class="p">)</span> <span class="p">{</span>
    <span class="o">//</span> <span class="n">Assume</span> <span class="n">offset</span> <span class="ow">is</span> <span class="n">never</span> <span class="n">negative</span><span class="o">.</span>
    <span class="k">assert</span><span class="p">(</span><span class="n">Offset</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>
    <span class="n">Expr</span> <span class="o">=</span> <span class="n">MCBinaryExpr</span><span class="p">::</span><span class="n">createAdd</span><span class="p">(</span><span class="n">Expr</span><span class="p">,</span> <span class="n">MCConstantExpr</span><span class="p">::</span><span class="n">create</span><span class="p">(</span><span class="n">Offset</span><span class="p">,</span> <span class="o">*</span><span class="n">Ctx</span><span class="p">),</span>
                                   <span class="o">*</span><span class="n">Ctx</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">TargetKind</span> <span class="o">!=</span> <span class="n">Cpu0MCExpr</span><span class="p">::</span><span class="n">CEK_None</span><span class="p">)</span>
    <span class="n">Expr</span> <span class="o">=</span> <span class="n">Cpu0MCExpr</span><span class="p">::</span><span class="n">create</span><span class="p">(</span><span class="n">TargetKind</span><span class="p">,</span> <span class="n">Expr</span><span class="p">,</span> <span class="o">*</span><span class="n">Ctx</span><span class="p">);</span>

  <span class="k">return</span> <span class="n">MCOperand</span><span class="p">::</span><span class="n">createExpr</span><span class="p">(</span><span class="n">Expr</span><span class="p">);</span>

<span class="p">}</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">MCOperand</span> <span class="n">Cpu0MCInstLower</span><span class="p">::</span><span class="n">LowerOperand</span><span class="p">(</span><span class="n">const</span> <span class="n">MachineOperand</span><span class="o">&amp;</span> <span class="n">MO</span><span class="p">,</span>
                                        <span class="n">unsigned</span> <span class="n">offset</span><span class="p">)</span> <span class="n">const</span> <span class="p">{</span>
  <span class="n">MachineOperandType</span> <span class="n">MOTy</span> <span class="o">=</span> <span class="n">MO</span><span class="o">.</span><span class="n">getType</span><span class="p">();</span>

  <span class="n">switch</span> <span class="p">(</span><span class="n">MOTy</span><span class="p">)</span> <span class="p">{</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>  <span class="k">case</span> <span class="n">MachineOperand</span><span class="p">::</span><span class="n">MO_GlobalAddress</span><span class="p">:</span>
<span class="o">//@</span><span class="mi">1</span>
    <span class="k">return</span> <span class="n">LowerSymbolOperand</span><span class="p">(</span><span class="n">MO</span><span class="p">,</span> <span class="n">MOTy</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>
</pre></div>
</div>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="p">...</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">...</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>The Cpu0MCExpr::printImpl() of Cpu0InstPrinter.cpp in last chapter is
for global variable printing operand function too.</p>
<p>The following function is for <code class="docutils literal notranslate"><span class="pre">llc</span> <span class="pre">-debug</span></code> this chapter DAG node name printing.
It is added at Chapter3_1 already.</p>
<p class="rubric">lbdex/chapters/Chapter3_1/Cpu0ISelLowering.cpp</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="nf">Cpu0TargetLowering::getTargetNodeName</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="n">Opcode</span><span class="p">)</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">Opcode</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="p">..</span><span class="w"></span>
<span class="w">  </span><span class="k">case</span><span class="w"> </span><span class="no">Cpu0ISD</span><span class="o">::</span><span class="no">GPRel</span><span class="p">:</span><span class="w">             </span><span class="k">return</span><span class="w"> </span><span class="s">&quot;Cpu0ISD::GPRel&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">...</span><span class="w"></span>
<span class="w">  </span><span class="k">case</span><span class="w"> </span><span class="no">Cpu0ISD</span><span class="o">::</span><span class="no">Wrapper</span><span class="p">:</span><span class="w">           </span><span class="k">return</span><span class="w"> </span><span class="s">&quot;Cpu0ISD::Wrapper&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">...</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>OS is the output stream which output to the assembly file.</p>
</section>
<section id="summary">
<h2><a class="toc-backref" href="#id20" role="doc-backlink">Summary</a><a class="headerlink" href="#summary" title="Permalink to this heading">¶</a></h2>
<p>The global variable Instruction Selection for DAG translation is not like the
ordinary IR node translation, it has static (absolute address) and pic mode.
Backend deals this translation by create DAG nodes in function
lowerGlobalAddress() which called by LowerOperation().
Function LowerOperation() takes care all Custom type of operation.
Backend set global address as Custom operation by
<strong>”setOperationAction(ISD::GlobalAddress, MVT::i32, Custom);”</strong> in
Cpu0TargetLowering() constructor.
Different address mode create their own DAG list at run time.
By setting the pattern Pat&lt;&gt; in Cpu0InstrInfo.td, the llvm can apply the
compiler mechanism, pattern match, in the Instruction Selection stage.</p>
<p>There are three types for setXXXAction(), Promote, Expand and Custom.
Except Custom, the other two maybe no need to coding.
Here <a class="footnote-reference brackets" href="#id8" id="id5" role="doc-noteref"><span class="fn-bracket">[</span>3<span class="fn-bracket">]</span></a> is the references.</p>
<p>As shown in this chapter, the global variable can be laid in
.sdata/.sbss by option -cpu0-use-small-section=true.
It is possible that the variables of small data section (16 bits
addressable) are full out at link stage. When that happens, linker will
highlights that error and forces the toolchain users to fix it.
As the result, the toolchain user need to reconsider which global variables
should be moved from .sdata/.sbss to .data/.bss by set option
-cpu0-use-small-section=false in Makefile as follows,</p>
<p class="rubric">Makefile</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="cp"># Set the global variables declared in a.cpp to .data/.bss</span>
<span class="n">llc</span><span class="w">  </span><span class="o">-</span><span class="n">march</span><span class="o">=</span><span class="n">cpu0</span><span class="w"> </span><span class="o">-</span><span class="n">relocation</span><span class="o">-</span><span class="n">model</span><span class="o">=</span><span class="k">static</span><span class="w"> </span><span class="o">-</span><span class="n">cpu0</span><span class="o">-</span><span class="n">use</span><span class="o">-</span><span class="n">small</span><span class="o">-</span><span class="n">section</span><span class="o">=</span><span class="nb">false</span><span class="w"> </span>\
<span class="o">-</span><span class="n">filetype</span><span class="o">=</span><span class="n">obj</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">bc</span><span class="w"> </span><span class="o">-</span><span class="n">o</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">cpu0</span><span class="p">.</span><span class="n">o</span><span class="w"></span>
<span class="cp"># Set the global variables declared in b.cpp to .sdata/.sbss</span>
<span class="n">llc</span><span class="w">  </span><span class="o">-</span><span class="n">march</span><span class="o">=</span><span class="n">cpu0</span><span class="w"> </span><span class="o">-</span><span class="n">relocation</span><span class="o">-</span><span class="n">model</span><span class="o">=</span><span class="k">static</span><span class="w"> </span><span class="o">-</span><span class="n">cpu0</span><span class="o">-</span><span class="n">use</span><span class="o">-</span><span class="n">small</span><span class="o">-</span><span class="n">section</span><span class="o">=</span><span class="nb">true</span><span class="w"> </span>\
<span class="o">-</span><span class="n">filetype</span><span class="o">=</span><span class="n">obj</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">bc</span><span class="w"> </span><span class="o">-</span><span class="n">o</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">cpu0</span><span class="p">.</span><span class="n">o</span><span class="w"></span>
</pre></div>
</div>
<p>The rule for global variables allocation is “set the small and frequent
variables in small 16 addressable area”.</p>
<aside class="footnote brackets" id="id6" role="note">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id1">1</a><span class="fn-bracket">]</span></span>
<p><a class="reference external" href="http://llvm.org/docs/CommandLine.html">http://llvm.org/docs/CommandLine.html</a></p>
</aside>
<aside class="footnote brackets" id="id7" role="note">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id3">2</a><span class="fn-bracket">]</span></span>
<p><a class="reference external" href="http://www.linux-mips.org/pub/linux/mips/doc/ABI/mipsabi.pdf">http://www.linux-mips.org/pub/linux/mips/doc/ABI/mipsabi.pdf</a></p>
</aside>
<aside class="footnote brackets" id="id8" role="note">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id5">3</a><span class="fn-bracket">]</span></span>
<p><a class="reference external" href="http://llvm.org/docs/WritingAnLLVMBackend.html#the-selectiondag-legalize-phase">http://llvm.org/docs/WritingAnLLVMBackend.html#the-selectiondag-legalize-phase</a></p>
</aside>
</section>
</section>


      </div>
      <div class="bottomnav" role="navigation" aria-label="bottom navigation">
      
        <p>
        «&#160;&#160;<a href="genobj.html">Generating object files</a>
        &#160;&#160;::&#160;&#160;
        <a class="uplink" href="index.html">Contents</a>
        &#160;&#160;::&#160;&#160;
        <a href="othertype.html">Other data type</a>&#160;&#160;»
        </p>

      </div>

    <div class="footer" role="contentinfo">
        &#169; Copyright 2016, Chen Chung-Shu.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 5.0.2.
    </div>
  </body>
</html>