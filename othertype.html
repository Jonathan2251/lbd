<!DOCTYPE html>

<html lang="en" data-content_root="./">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Other data type &#8212; Tutorial: Creating an LLVM Backend for the Cpu0 Architecture</title>
    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="_static/haiku.css?v=fce32b03" />
    <link rel="stylesheet" type="text/css" href="_static/graphviz.css?v=4ae1632d" />
    <script src="_static/documentation_options.js?v=4745d852"></script>
    <script src="_static/doctools.js?v=fd6eb6e6"></script>
    <script src="_static/sphinx_highlight.js?v=6ffebe34"></script>
    <link rel="author" title="About these documents" href="about.html" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Control flow statements" href="ctrlflow.html" />
    <link rel="prev" title="Global Variables" href="globalvar.html" /> 
  </head><body>
      <div class="header" role="banner"><h1 class="heading"><a href="index.html">
          <span>Tutorial: Creating an LLVM Backend for the Cpu0 Architecture</span></a></h1>
        <h2 class="heading"><span>Other data type</span></h2>
      </div>
      <div class="topnav" role="navigation" aria-label="Top">
      
        <p>
        «&#160;&#160;<a href="globalvar.html">Global Variables</a>
        &#160;&#160;::&#160;&#160;
        <a class="uplink" href="index.html">Contents</a>
        &#160;&#160;::&#160;&#160;
        <a href="ctrlflow.html">Control flow statements</a>&#160;&#160;»
        </p>

      </div>
      <div class="content" role="main">
        
        
  <section id="other-data-type">
<span id="sec-othertypesupport"></span><h1>Other data type<a class="headerlink" href="#other-data-type" title="Link to this heading">¶</a></h1>
<nav class="contents local" id="contents">
<ul class="simple">
<li><p><a class="reference internal" href="#local-variable-pointer" id="id8">Local Variable Pointer</a></p></li>
<li><p><a class="reference internal" href="#char-short-int-and-bool" id="id9">char, short int and bool</a></p></li>
<li><p><a class="reference internal" href="#long-long" id="id10">long long</a></p></li>
<li><p><a class="reference internal" href="#float-and-double" id="id11">float and double</a></p></li>
<li><p><a class="reference internal" href="#array-and-struct-support" id="id12">Array and struct support</a></p></li>
<li><p><a class="reference internal" href="#vector-type-simd-support" id="id13">Vector type (SIMD) support</a></p></li>
</ul>
</nav>
<p>Until now, we have only handled int and long types of 32-bit size.
This chapter introduces other types, such as pointers and types that are not
32-bit, including bool, char, short int, and long long.</p>
<section id="local-variable-pointer">
<h2><a class="toc-backref" href="#id8" role="doc-backlink">Local Variable Pointer</a><a class="headerlink" href="#local-variable-pointer" title="Link to this heading">¶</a></h2>
<p>To support pointers to local variables, add the following code fragment to
Cpu0InstrInfo.td and Cpu0InstPrinter.cpp:</p>
<p class="rubric">lbdex/chapters/Chapter7_1/Cpu0InstrInfo.td</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">mem_ea</span> <span class="p">:</span> <span class="n">Operand</span><span class="o">&lt;</span><span class="n">iPTR</span><span class="o">&gt;</span> <span class="p">{</span>
  <span class="n">let</span> <span class="n">PrintMethod</span> <span class="o">=</span> <span class="s2">&quot;printMemOperandEA&quot;</span><span class="p">;</span>
  <span class="n">let</span> <span class="n">MIOperandInfo</span> <span class="o">=</span> <span class="p">(</span><span class="n">ops</span> <span class="n">GPROut</span><span class="p">,</span> <span class="n">simm16</span><span class="p">);</span>
  <span class="n">let</span> <span class="n">EncoderMethod</span> <span class="o">=</span> <span class="s2">&quot;getMemEncoding&quot;</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>class EffectiveAddress&lt;string instr_asm, RegisterClass RC, Operand Mem&gt; :
  FMem&lt;0x09, (outs RC:$ra), (ins Mem:$addr),
     instr_asm, [(set RC:$ra, addr:$addr)], IIAlu&gt;;
}
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//</span> <span class="n">FrameIndexes</span> <span class="n">are</span> <span class="n">legalized</span> <span class="n">when</span> <span class="n">they</span> <span class="n">are</span> <span class="n">operands</span> <span class="kn">from</span><span class="w"> </span><span class="nn">load</span><span class="o">/</span><span class="n">store</span>
<span class="o">//</span> <span class="n">instructions</span><span class="o">.</span> <span class="n">The</span> <span class="n">same</span> <span class="ow">not</span> <span class="n">happens</span> <span class="k">for</span> <span class="n">stack</span> <span class="n">address</span> <span class="n">copies</span><span class="p">,</span> <span class="n">so</span> <span class="n">an</span>
<span class="o">//</span> <span class="n">add</span> <span class="n">op</span> <span class="k">with</span> <span class="n">mem</span> <span class="n">ComplexPattern</span> <span class="ow">is</span> <span class="n">used</span> <span class="ow">and</span> <span class="n">the</span> <span class="n">stack</span> <span class="n">address</span> <span class="n">copy</span>
<span class="o">//</span> <span class="n">can</span> <span class="n">be</span> <span class="n">matched</span><span class="o">.</span> <span class="n">It</span><span class="s1">&#39;s similar to Sparc LEA_ADDRi</span>
<span class="k">def</span><span class="w"> </span><span class="nf">LEA_ADDiu</span> <span class="p">:</span> <span class="n">EffectiveAddress</span><span class="o">&lt;</span><span class="s2">&quot;addiu</span><span class="se">\t</span><span class="s2">$ra, $addr&quot;</span><span class="p">,</span> <span class="n">CPURegs</span><span class="p">,</span> <span class="n">mem_ea</span><span class="o">&gt;</span> <span class="p">{</span>
  <span class="n">let</span> <span class="n">isCodeGenOnly</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter3_2/InstPrinter/Cpu0InstPrinter.h</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>  <span class="n">void</span> <span class="n">printMemOperandEA</span><span class="p">(</span><span class="n">const</span> <span class="n">MCInst</span> <span class="o">*</span><span class="n">MI</span><span class="p">,</span> <span class="nb">int</span> <span class="n">opNum</span><span class="p">,</span> <span class="n">raw_ostream</span> <span class="o">&amp;</span><span class="n">O</span><span class="p">);</span>
</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter3_2/InstPrinter/Cpu0InstPrinter.cpp</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//</span> <span class="n">The</span> <span class="n">DAG</span> <span class="n">data</span> <span class="n">node</span><span class="p">,</span> <span class="n">mem_ea</span> <span class="n">of</span> <span class="n">Cpu0InstrInfo</span><span class="o">.</span><span class="n">td</span><span class="p">,</span> <span class="n">cannot</span> <span class="n">be</span> <span class="n">disabled</span> <span class="n">by</span>
<span class="o">//</span> <span class="n">ch7_1</span><span class="p">,</span> <span class="n">only</span> <span class="n">opcode</span> <span class="n">node</span> <span class="n">can</span> <span class="n">be</span> <span class="n">disabled</span><span class="o">.</span>
<span class="n">void</span> <span class="n">Cpu0InstPrinter</span><span class="p">::</span>
<span class="n">printMemOperandEA</span><span class="p">(</span><span class="n">const</span> <span class="n">MCInst</span> <span class="o">*</span><span class="n">MI</span><span class="p">,</span> <span class="nb">int</span> <span class="n">opNum</span><span class="p">,</span> <span class="n">raw_ostream</span> <span class="o">&amp;</span><span class="n">O</span><span class="p">)</span> <span class="p">{</span>
  <span class="o">//</span> <span class="n">when</span> <span class="n">using</span> <span class="n">stack</span> <span class="n">locations</span> <span class="k">for</span> <span class="ow">not</span> <span class="n">load</span><span class="o">/</span><span class="n">store</span> <span class="n">instructions</span>
  <span class="o">//</span> <span class="nb">print</span> <span class="n">the</span> <span class="n">same</span> <span class="n">way</span> <span class="k">as</span> <span class="nb">all</span> <span class="n">normal</span> <span class="mi">3</span> <span class="n">operand</span> <span class="n">instructions</span><span class="o">.</span>
  <span class="n">printOperand</span><span class="p">(</span><span class="n">MI</span><span class="p">,</span> <span class="n">opNum</span><span class="p">,</span> <span class="n">O</span><span class="p">);</span>
  <span class="n">O</span> <span class="o">&lt;&lt;</span> <span class="s2">&quot;, &quot;</span><span class="p">;</span>
  <span class="n">printOperand</span><span class="p">(</span><span class="n">MI</span><span class="p">,</span> <span class="n">opNum</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">O</span><span class="p">);</span>
  <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>As noted in Cpu0InstPrinter.cpp, the printMemOperandEA function was added in an
earlier Chapter 3.2 because the DAG data node mem_ea in Cpu0InstrInfo.td cannot
be disabled by ch7_1_localpointer; only the opcode node can be disabled.</p>
<p>Run ch7_1_localpointer.cpp with the Chapter7_1/ directory, which supports
pointers to local variables. The expected result is as follows:</p>
<p class="rubric">lbdex/input/ch7_1_localpointer.cpp</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">int</span> <span class="n">test_local_pointer</span><span class="p">()</span>
<span class="p">{</span>
  <span class="nb">int</span> <span class="n">b</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
  
  <span class="nb">int</span><span class="o">*</span> <span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">b</span><span class="p">;</span>

  <span class="k">return</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">118-165-66-82:input Jonathan$ </span>clang<span class="w"> </span>-target<span class="w"> </span>mips-unknown-linux-gnu<span class="w"> </span>-c
<span class="go">ch7_1_localpointer.cpp -emit-llvm -o ch7_1_localpointer.bc</span>
<span class="gp">118-165-66-82:input Jonathan$ </span>llvm-dis<span class="w"> </span>ch7_1_localpointer.bc<span class="w"> </span>-o<span class="w"> </span>-
<span class="go">...</span>
<span class="go">; Function Attrs: nounwind</span>
<span class="go">define i32 @_Z18test_local_pointerv() #0 {</span>
<span class="gp">  %</span><span class="nv">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>alloca<span class="w"> </span>i32,<span class="w"> </span>align<span class="w"> </span><span class="m">4</span>
<span class="gp">  %</span><span class="nv">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>alloca<span class="w"> </span>i32*,<span class="w"> </span>align<span class="w"> </span><span class="m">4</span>
<span class="go">  store i32 3, i32* %b, align 4</span>
<span class="go">  store i32* %b, i32** %p, align 4</span>
<span class="gp">  %</span><span class="nv">1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>load<span class="w"> </span>i32**<span class="w"> </span>%p,<span class="w"> </span>align<span class="w"> </span><span class="m">4</span>
<span class="gp">  %</span><span class="nv">2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>load<span class="w"> </span>i32*<span class="w"> </span>%1,<span class="w"> </span>align<span class="w"> </span><span class="m">4</span>
<span class="go">  ret i32 %2</span>
<span class="go">}</span>
<span class="go">...</span>

<span class="gp">118-165-66-82:input Jonathan$ </span>/Users/Jonathan/llvm/test/build/bin/llc
<span class="go">-march=cpu0 -relocation-model=pic -filetype=asm</span>
<span class="go">ch7_1_localpointer.bc -o -</span>
<span class="go">  ...</span>
<span class="go">        addiu $sp, $sp, -8</span>
<span class="go">        addiu $2, $zero, 3</span>
<span class="go">        st    $2, 4($fp)</span>
<span class="go">        addiu $2, $fp, 4     // b address is 4($sp)</span>
<span class="go">        st    $2, 0($fp)</span>
<span class="go">        ld    $2, 4($fp)</span>
<span class="go">        addiu $sp, $sp, 8</span>
<span class="go">        ret   $lr</span>
<span class="go">  ...</span>
</pre></div>
</div>
</section>
<section id="char-short-int-and-bool">
<h2><a class="toc-backref" href="#id9" role="doc-backlink">char, short int and bool</a><a class="headerlink" href="#char-short-int-and-bool" title="Link to this heading">¶</a></h2>
<p>To support signed and unsigned char and short int, add the following
code to Chapter7_1/:</p>
<p class="rubric">lbdex/chapters/Chapter7_1/Cpu0InstrInfo.td</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">sextloadi16_a</span>   <span class="p">:</span> <span class="n">AlignedLoad</span><span class="o">&lt;</span><span class="n">sextloadi16</span><span class="o">&gt;</span><span class="p">;</span>
<span class="k">def</span><span class="w"> </span><span class="nf">zextloadi16_a</span>   <span class="p">:</span> <span class="n">AlignedLoad</span><span class="o">&lt;</span><span class="n">zextloadi16</span><span class="o">&gt;</span><span class="p">;</span>
<span class="k">def</span><span class="w"> </span><span class="nf">extloadi16_a</span>    <span class="p">:</span> <span class="n">AlignedLoad</span><span class="o">&lt;</span><span class="n">extloadi16</span><span class="o">&gt;</span><span class="p">;</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">truncstorei16_a</span> <span class="p">:</span> <span class="n">AlignedStore</span><span class="o">&lt;</span><span class="n">truncstorei16</span><span class="o">&gt;</span><span class="p">;</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">let</span> <span class="n">Predicates</span> <span class="o">=</span> <span class="p">[</span><span class="n">Ch7_1</span><span class="p">]</span> <span class="ow">in</span> <span class="p">{</span>
<span class="k">def</span><span class="w"> </span><span class="nf">LB</span>     <span class="p">:</span> <span class="n">LoadM32</span><span class="o">&lt;</span><span class="mh">0x03</span><span class="p">,</span> <span class="s2">&quot;lb&quot;</span><span class="p">,</span>  <span class="n">sextloadi8</span><span class="o">&gt;</span><span class="p">;</span>
<span class="k">def</span><span class="w"> </span><span class="nf">LBu</span>    <span class="p">:</span> <span class="n">LoadM32</span><span class="o">&lt;</span><span class="mh">0x04</span><span class="p">,</span> <span class="s2">&quot;lbu&quot;</span><span class="p">,</span> <span class="n">zextloadi8</span><span class="o">&gt;</span><span class="p">;</span>
<span class="k">def</span><span class="w"> </span><span class="nf">SB</span>     <span class="p">:</span> <span class="n">StoreM32</span><span class="o">&lt;</span><span class="mh">0x05</span><span class="p">,</span> <span class="s2">&quot;sb&quot;</span><span class="p">,</span> <span class="n">truncstorei8</span><span class="o">&gt;</span><span class="p">;</span>
<span class="k">def</span><span class="w"> </span><span class="nf">LH</span>     <span class="p">:</span> <span class="n">LoadM32</span><span class="o">&lt;</span><span class="mh">0x06</span><span class="p">,</span> <span class="s2">&quot;lh&quot;</span><span class="p">,</span>  <span class="n">sextloadi16_a</span><span class="o">&gt;</span><span class="p">;</span>
<span class="k">def</span><span class="w"> </span><span class="nf">LHu</span>    <span class="p">:</span> <span class="n">LoadM32</span><span class="o">&lt;</span><span class="mh">0x07</span><span class="p">,</span> <span class="s2">&quot;lhu&quot;</span><span class="p">,</span> <span class="n">zextloadi16_a</span><span class="o">&gt;</span><span class="p">;</span>
<span class="k">def</span><span class="w"> </span><span class="nf">SH</span>     <span class="p">:</span> <span class="n">StoreM32</span><span class="o">&lt;</span><span class="mh">0x08</span><span class="p">,</span> <span class="s2">&quot;sh&quot;</span><span class="p">,</span> <span class="n">truncstorei16_a</span><span class="o">&gt;</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Run Chapter7_1/ with ch7_1_char_in_struct.cpp to obtain the following result.</p>
<p class="rubric">lbdex/input/ch7_1_char_in_struct.cpp</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">struct</span> <span class="n">Date</span>
<span class="p">{</span>
  <span class="n">short</span> <span class="n">year</span><span class="p">;</span>
  <span class="n">char</span> <span class="n">month</span><span class="p">;</span>
  <span class="n">char</span> <span class="n">day</span><span class="p">;</span>
  <span class="n">char</span> <span class="n">hour</span><span class="p">;</span>
  <span class="n">char</span> <span class="n">minute</span><span class="p">;</span>
  <span class="n">char</span> <span class="n">second</span><span class="p">;</span>
<span class="p">};</span>

<span class="n">unsigned</span> <span class="n">char</span> <span class="n">b</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\0</span><span class="s1">&#39;</span><span class="p">};</span>

<span class="nb">int</span> <span class="n">test_char</span><span class="p">()</span>
<span class="p">{</span>
  <span class="n">unsigned</span> <span class="n">char</span> <span class="n">a</span> <span class="o">=</span> <span class="n">b</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
  <span class="n">char</span> <span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="n">char</span><span class="p">)</span><span class="n">b</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
  <span class="n">Date</span> <span class="n">date1</span> <span class="o">=</span> <span class="p">{</span><span class="mi">2012</span><span class="p">,</span> <span class="p">(</span><span class="n">char</span><span class="p">)</span><span class="mi">11</span><span class="p">,</span> <span class="p">(</span><span class="n">char</span><span class="p">)</span><span class="mi">25</span><span class="p">,</span> <span class="p">(</span><span class="n">char</span><span class="p">)</span><span class="mi">9</span><span class="p">,</span> <span class="p">(</span><span class="n">char</span><span class="p">)</span><span class="mi">40</span><span class="p">,</span> <span class="p">(</span><span class="n">char</span><span class="p">)</span><span class="mi">15</span><span class="p">};</span>
  <span class="n">char</span> <span class="n">m</span> <span class="o">=</span> <span class="n">date1</span><span class="o">.</span><span class="n">month</span><span class="p">;</span>
  <span class="n">char</span> <span class="n">s</span> <span class="o">=</span> <span class="n">date1</span><span class="o">.</span><span class="n">second</span><span class="p">;</span>

  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

</pre></div>
</div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">118-165-64-245:input Jonathan$ </span>/Users/Jonathan/llvm/test/build/
<span class="go">bin/llvm-dis ch7_1_char_in_struct.bc -o -</span>
<span class="go">define i32 @_Z9test_charv() #0 {</span>
<span class="gp">  %</span><span class="nv">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>alloca<span class="w"> </span>i8,<span class="w"> </span>align<span class="w"> </span><span class="m">1</span>
<span class="gp">  %</span><span class="nv">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>alloca<span class="w"> </span>i8,<span class="w"> </span>align<span class="w"> </span><span class="m">1</span>
<span class="gp">  %</span><span class="nv">date1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>alloca<span class="w"> </span>%struct.Date,<span class="w"> </span>align<span class="w"> </span><span class="m">2</span>
<span class="gp">  %</span><span class="nv">m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>alloca<span class="w"> </span>i8,<span class="w"> </span>align<span class="w"> </span><span class="m">1</span>
<span class="gp">  %</span><span class="nv">s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>alloca<span class="w"> </span>i8,<span class="w"> </span>align<span class="w"> </span><span class="m">1</span>
<span class="gp">  %</span><span class="nv">1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>load<span class="w"> </span>i8*<span class="w"> </span>getelementptr<span class="w"> </span>inbounds<span class="w"> </span><span class="o">([</span><span class="m">4</span><span class="w"> </span>x<span class="w"> </span>i8<span class="o">]</span>*<span class="w"> </span>@b,<span class="w"> </span>i32<span class="w"> </span><span class="m">0</span>,<span class="w"> </span>i32<span class="w"> </span><span class="m">1</span><span class="o">)</span>,<span class="w"> </span>align<span class="w"> </span><span class="m">1</span>
<span class="go">  store i8 %1, i8* %a, align 1</span>
<span class="gp">  %</span><span class="nv">2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>load<span class="w"> </span>i8*<span class="w"> </span>getelementptr<span class="w"> </span>inbounds<span class="w"> </span><span class="o">([</span><span class="m">4</span><span class="w"> </span>x<span class="w"> </span>i8<span class="o">]</span>*<span class="w"> </span>@b,<span class="w"> </span>i32<span class="w"> </span><span class="m">0</span>,<span class="w"> </span>i32<span class="w"> </span><span class="m">1</span><span class="o">)</span>,<span class="w"> </span>align<span class="w"> </span><span class="m">1</span>
<span class="go">  store i8 %2, i8* %c, align 1</span>
<span class="gp">  %</span><span class="nv">3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>bitcast<span class="w"> </span>%struct.Date*<span class="w"> </span>%date1<span class="w"> </span>to<span class="w"> </span>i8*
<span class="go">  call void @llvm.memcpy.p0i8.p0i8.i32(i8* %3, i8* bitcast ({ i16, i8, i8, i8,</span>
<span class="go">  i8, i8, i8 }* @_ZZ9test_charvE5date1 to i8*), i32 8, i32 2, i1 false)</span>
<span class="gp">  %</span><span class="nv">4</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>getelementptr<span class="w"> </span>inbounds<span class="w"> </span>%struct.Date*<span class="w"> </span>%date1,<span class="w"> </span>i32<span class="w"> </span><span class="m">0</span>,<span class="w"> </span>i32<span class="w"> </span><span class="m">1</span>
<span class="gp">  %</span><span class="nv">5</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>load<span class="w"> </span>i8*<span class="w"> </span>%4,<span class="w"> </span>align<span class="w"> </span><span class="m">1</span>
<span class="go">  store i8 %5, i8* %m, align 1</span>
<span class="gp">  %</span><span class="nv">6</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>getelementptr<span class="w"> </span>inbounds<span class="w"> </span>%struct.Date*<span class="w"> </span>%date1,<span class="w"> </span>i32<span class="w"> </span><span class="m">0</span>,<span class="w"> </span>i32<span class="w"> </span><span class="m">5</span>
<span class="gp">  %</span><span class="nv">7</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>load<span class="w"> </span>i8*<span class="w"> </span>%6,<span class="w"> </span>align<span class="w"> </span><span class="m">1</span>
<span class="go">  store i8 %7, i8* %s, align 1</span>
<span class="go">  ret i32 0</span>
<span class="go">}</span>

<span class="gp">118-165-64-245:input Jonathan$ </span>clang<span class="w"> </span>-target<span class="w"> </span>mips-unknown-linux-gnu<span class="w"> </span>-c
<span class="go">ch7_1_char_in_struct.cpp -emit-llvm -o ch7_1_char_in_struct.bc</span>
<span class="gp">118-165-64-245:input Jonathan$ </span>/Users/Jonathan/llvm/test/build/
<span class="go">bin/llc -march=cpu0 -relocation-model=pic -filetype=asm</span>
<span class="go">ch7_1_char_in_struct.bc -o -</span>
<span class="go">  ...</span>
<span class="gp"># </span>BB#0:<span class="w">                                 </span><span class="c1"># %entry</span>
<span class="go">  addiu $sp, $sp, -24</span>
<span class="go">  lui $2, %got_hi(b)</span>
<span class="go">  addu  $2, $2, $gp</span>
<span class="go">  ld  $2, %got_lo(b)($2)</span>
<span class="go">  lbu $3, 1($2)</span>
<span class="go">  sb  $3, 20($fp)</span>
<span class="go">  lbu $2, 1($2)</span>
<span class="go">  sb  $2, 16($fp)</span>
<span class="go">  ld  $2, %got($_ZZ9test_charvE5date1)($gp)</span>
<span class="go">  addiu $2, $2, %lo($_ZZ9test_charvE5date1)</span>
<span class="go">  lhu $3, 4($2)</span>
<span class="go">  shl $3, $3, 16</span>
<span class="go">  lhu $4, 6($2)</span>
<span class="go">  or  $3, $3, $4</span>
<span class="go">  st  $3, 12($fp) // store hour, minute and second on 12($sp)</span>
<span class="go">  lhu $3, 2($2)</span>
<span class="go">  lhu $2, 0($2)</span>
<span class="go">  shl $2, $2, 16</span>
<span class="go">  or  $2, $2, $3</span>
<span class="go">  st  $2, 8($fp)    // store year, month and day on 8($sp)</span>
<span class="go">  lbu $2, 10($fp)   // m = date1.month;</span>
<span class="go">  sb  $2, 4($fp)</span>
<span class="go">  lbu $2, 14($fp)   // s = date1.second;</span>
<span class="go">  sb  $2, 0($fp)</span>
<span class="go">  addiu $sp, $sp, 24</span>
<span class="go">  ret $lr</span>
<span class="go">  .set  macro</span>
<span class="go">  .set  reorder</span>
<span class="go">  .end  _Z9test_charv</span>
<span class="gp">$</span>tmp1:
<span class="go">  .size _Z9test_charv, ($tmp1)-_Z9test_charv</span>

<span class="go">  .type b,@object               # @b</span>
<span class="go">  .data</span>
<span class="go">  .globl  b</span>
<span class="go">b:</span>
<span class="go">  .asciz   &quot;abc&quot;</span>
<span class="go">  .size b, 4</span>

<span class="go">  .type $_ZZ9test_charvE5date1,@object # @_ZZ9test_charvE5date1</span>
<span class="go">  .section  .rodata.cst8,&quot;aM&quot;,@progbits,8</span>
<span class="go">  .align  1</span>
<span class="gp">$</span>_ZZ9test_charvE5date1:
<span class="go">  .2byte  2012                    # 0x7dc</span>
<span class="go">  .byte 11                      # 0xb</span>
<span class="go">  .byte 25                      # 0x19</span>
<span class="go">  .byte 9                       # 0x9</span>
<span class="go">  .byte 40                      # 0x28</span>
<span class="go">  .byte 15                      # 0xf</span>
<span class="go">  .space  1</span>
<span class="go">  .size $_ZZ9test_charvE5date1, 8</span>
</pre></div>
</div>
<p>Run Chapter7_1/ with ch7_1_char_short.cpp to obtain the following result.</p>
<p class="rubric">lbdex/input/ch7_1_char_short.cpp</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">int</span> <span class="n">test_signed_char</span><span class="p">()</span>
<span class="p">{</span>
  <span class="n">char</span> <span class="n">a</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span>
  <span class="nb">int</span> <span class="n">i</span> <span class="o">=</span> <span class="p">(</span><span class="n">signed</span> <span class="nb">int</span><span class="p">)</span><span class="n">a</span><span class="p">;</span>
  <span class="n">i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span> <span class="o">//</span> <span class="n">i</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">128</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="mi">126</span>

  <span class="k">return</span> <span class="n">i</span><span class="p">;</span>
<span class="p">}</span>

<span class="nb">int</span> <span class="n">test_unsigned_char</span><span class="p">()</span>
<span class="p">{</span>
  <span class="n">unsigned</span> <span class="n">char</span> <span class="n">c</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span>
  <span class="n">unsigned</span> <span class="nb">int</span> <span class="n">ui</span> <span class="o">=</span> <span class="p">(</span><span class="n">unsigned</span> <span class="nb">int</span><span class="p">)</span><span class="n">c</span><span class="p">;</span>
  <span class="n">ui</span> <span class="o">=</span> <span class="n">ui</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span> <span class="o">//</span> <span class="n">i</span> <span class="o">=</span> <span class="p">(</span><span class="mi">128</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="mi">130</span>

  <span class="k">return</span> <span class="p">(</span><span class="nb">int</span><span class="p">)</span><span class="n">ui</span><span class="p">;</span>
<span class="p">}</span>

<span class="nb">int</span> <span class="n">test_signed_short</span><span class="p">()</span>
<span class="p">{</span>
  <span class="n">short</span> <span class="n">a</span> <span class="o">=</span> <span class="mh">0x8000</span><span class="p">;</span>
  <span class="nb">int</span> <span class="n">i</span> <span class="o">=</span> <span class="p">(</span><span class="n">signed</span> <span class="nb">int</span><span class="p">)</span><span class="n">a</span><span class="p">;</span>
  <span class="n">i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span> <span class="o">//</span> <span class="n">i</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">32768</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="mi">32766</span>

  <span class="k">return</span> <span class="n">i</span><span class="p">;</span>
<span class="p">}</span>

<span class="nb">int</span> <span class="n">test_unsigned_short</span><span class="p">()</span>
<span class="p">{</span>
  <span class="n">unsigned</span> <span class="n">short</span> <span class="n">c</span> <span class="o">=</span> <span class="mh">0x8000</span><span class="p">;</span>
  <span class="n">unsigned</span> <span class="nb">int</span> <span class="n">ui</span> <span class="o">=</span> <span class="p">(</span><span class="n">unsigned</span> <span class="nb">int</span><span class="p">)</span><span class="n">c</span><span class="p">;</span>
  <span class="n">ui</span> <span class="o">=</span> <span class="n">ui</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span> <span class="o">//</span> <span class="n">i</span> <span class="o">=</span> <span class="p">(</span><span class="mi">32768</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="mi">32770</span>
  <span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="n">unsigned</span> <span class="n">short</span><span class="p">)</span><span class="n">ui</span><span class="p">;</span>

  <span class="k">return</span> <span class="p">(</span><span class="nb">int</span><span class="p">)</span><span class="n">ui</span><span class="p">;</span>
<span class="p">}</span>

</pre></div>
</div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">1-160-136-236:input Jonathan$ </span>/Users/Jonathan/llvm/test/build/
<span class="go">bin/llvm-dis ch7_1_char_short.bc -o -</span>
<span class="go">  ...</span>
<span class="go">define i32 @_Z16test_signed_charv() #0 {</span>
<span class="go">  ...</span>
<span class="gp">  %</span><span class="nv">1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>load<span class="w"> </span>i8*<span class="w"> </span>%a,<span class="w"> </span>align<span class="w"> </span><span class="m">1</span>
<span class="gp">  %</span><span class="nv">2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>sext<span class="w"> </span>i8<span class="w"> </span>%1<span class="w"> </span>to<span class="w"> </span>i32
<span class="go">  ...</span>
<span class="go">}</span>

<span class="go">; Function Attrs: nounwind</span>
<span class="go">define i32 @_Z18test_unsigned_charv() #0 {</span>
<span class="go">  ...</span>
<span class="gp">  %</span><span class="nv">1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>load<span class="w"> </span>i8*<span class="w"> </span>%c,<span class="w"> </span>align<span class="w"> </span><span class="m">1</span>
<span class="gp">  %</span><span class="nv">2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>zext<span class="w"> </span>i8<span class="w"> </span>%1<span class="w"> </span>to<span class="w"> </span>i32
<span class="go">  ...</span>
<span class="go">}</span>

<span class="go">; Function Attrs: nounwind</span>
<span class="go">define i32 @_Z17test_signed_shortv() #0 {</span>
<span class="go">  ...</span>
<span class="gp">  %</span><span class="nv">1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>load<span class="w"> </span>i16*<span class="w"> </span>%a,<span class="w"> </span>align<span class="w"> </span><span class="m">2</span>
<span class="gp">  %</span><span class="nv">2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>sext<span class="w"> </span>i16<span class="w"> </span>%1<span class="w"> </span>to<span class="w"> </span>i32
<span class="go">  ...</span>
<span class="go">}</span>

<span class="go">; Function Attrs: nounwind</span>
<span class="go">define i32 @_Z19test_unsigned_shortv() #0 {</span>
<span class="go">  ...</span>
<span class="gp">  %</span><span class="nv">1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>load<span class="w"> </span>i16*<span class="w"> </span>%c,<span class="w"> </span>align<span class="w"> </span><span class="m">2</span>
<span class="gp">  %</span><span class="nv">2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>zext<span class="w"> </span>i16<span class="w"> </span>%1<span class="w"> </span>to<span class="w"> </span>i32
<span class="go">  ...</span>
<span class="go">}</span>

<span class="go">attributes #0 = { nounwind }</span>

<span class="gp">1-160-136-236:input Jonathan$ </span>/Users/Jonathan/llvm/test/build/
<span class="go">bin/llc -march=cpu0 -relocation-model=static -filetype=asm ch7_1_char_short.bc -o -</span>
<span class="go">  ...</span>
<span class="go">  .globl  _Z16test_signed_charv</span>
<span class="go">  ...</span>
<span class="go">  lb  $2, 4($sp)</span>
<span class="go">  ...</span>
<span class="go">  .end  _Z16test_signed_charv</span>

<span class="go">  .globl  _Z18test_unsigned_charv</span>
<span class="go">  ...</span>
<span class="go">  lbu $2, 4($sp)</span>
<span class="go">  ...</span>
<span class="go">  .end  _Z18test_unsigned_charv</span>

<span class="go">  .globl  _Z17test_signed_shortv</span>
<span class="go">  ...</span>
<span class="go">  lh  $2, 4($sp)</span>
<span class="go">  ...</span>
<span class="go">  .end  _Z17test_signed_shortv</span>

<span class="go">  .globl  _Z19test_unsigned_shortv</span>
<span class="go">  ...</span>
<span class="go">  lhu $2, 4($sp)</span>
<span class="go">  ...</span>
<span class="go">  .end  _Z19test_unsigned_shortv</span>
<span class="go">  ...</span>
</pre></div>
</div>
<p>As shown, lb/lh instructions are used for signed byte/short types, while
lbu/lhu are used for unsigned byte/short types.
To efficiently support C type-casting and type-conversion features,
Cpu0 provides the lb instruction, which converts a char to an int with a single
instruction.
The instructions lbu, lh, lhu, sb, and sh are applied to both signed and
unsigned byte and short conversions.
Their differences were explained in Chapter 2.</p>
<p>To support loading the bool type, add the following code:</p>
<p class="rubric">lbdex/chapters/Chapter7_1/Cpu0ISelLowering.cpp</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Cpu0TargetLowering</span><span class="p">::</span><span class="n">Cpu0TargetLowering</span><span class="p">(</span><span class="n">const</span> <span class="n">Cpu0TargetMachine</span> <span class="o">&amp;</span><span class="n">TM</span><span class="p">,</span>
                                       <span class="n">const</span> <span class="n">Cpu0Subtarget</span> <span class="o">&amp;</span><span class="n">STI</span><span class="p">)</span>
    <span class="p">:</span> <span class="n">TargetLowering</span><span class="p">(</span><span class="n">TM</span><span class="p">),</span> <span class="n">Subtarget</span><span class="p">(</span><span class="n">STI</span><span class="p">),</span> <span class="n">ABI</span><span class="p">(</span><span class="n">TM</span><span class="o">.</span><span class="n">getABI</span><span class="p">())</span> <span class="p">{</span>

</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>  <span class="o">//</span> <span class="n">Cpu0</span> <span class="n">does</span> <span class="ow">not</span> <span class="n">have</span> <span class="n">i1</span> <span class="nb">type</span><span class="p">,</span> <span class="n">so</span> <span class="n">use</span> <span class="n">i32</span> <span class="k">for</span>
  <span class="o">//</span> <span class="n">setcc</span> <span class="n">operations</span> <span class="n">results</span> <span class="p">(</span><span class="n">slt</span><span class="p">,</span> <span class="n">sgt</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span><span class="o">.</span>
  <span class="n">setBooleanContents</span><span class="p">(</span><span class="n">ZeroOrOneBooleanContent</span><span class="p">);</span>
  <span class="n">setBooleanVectorContents</span><span class="p">(</span><span class="n">ZeroOrNegativeOneBooleanContent</span><span class="p">);</span>

  <span class="o">//</span> <span class="n">Load</span> <span class="n">extented</span> <span class="n">operations</span> <span class="k">for</span> <span class="n">i1</span> <span class="n">types</span> <span class="n">must</span> <span class="n">be</span> <span class="n">promoted</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">MVT</span> <span class="n">VT</span> <span class="p">:</span> <span class="n">MVT</span><span class="p">::</span><span class="n">integer_valuetypes</span><span class="p">())</span> <span class="p">{</span>
    <span class="n">setLoadExtAction</span><span class="p">(</span><span class="n">ISD</span><span class="p">::</span><span class="n">EXTLOAD</span><span class="p">,</span>  <span class="n">VT</span><span class="p">,</span> <span class="n">MVT</span><span class="p">::</span><span class="n">i1</span><span class="p">,</span>  <span class="n">Promote</span><span class="p">);</span>
    <span class="n">setLoadExtAction</span><span class="p">(</span><span class="n">ISD</span><span class="p">::</span><span class="n">ZEXTLOAD</span><span class="p">,</span> <span class="n">VT</span><span class="p">,</span> <span class="n">MVT</span><span class="p">::</span><span class="n">i1</span><span class="p">,</span>  <span class="n">Promote</span><span class="p">);</span>
    <span class="n">setLoadExtAction</span><span class="p">(</span><span class="n">ISD</span><span class="p">::</span><span class="n">SEXTLOAD</span><span class="p">,</span> <span class="n">VT</span><span class="p">,</span> <span class="n">MVT</span><span class="p">::</span><span class="n">i1</span><span class="p">,</span>  <span class="n">Promote</span><span class="p">);</span>
  <span class="p">}</span>
</pre></div>
</div>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="p">...</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The purpose of setBooleanContents() is as follows, but its details are not well
understood.
Without it, ch7_1_bool2.ll still works as shown below.</p>
<p>The IR input file ch7_1_bool2.ll is used for testing, as the C++ version
requires flow control, which is not supported at this point.
The file ch_run_backend.cpp includes a test fragment for bool, as shown below.</p>
<p class="rubric">include/llvm/Target/TargetLowering.h</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="k">enum</span><span class="w"> </span><span class="nc">BooleanContent</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// How the target represents true/false values.</span>
<span class="w">    </span><span class="n">UndefinedBooleanContent</span><span class="p">,</span><span class="w">    </span><span class="c1">// Only bit 0 counts, the rest can hold garbage.</span>
<span class="w">    </span><span class="n">ZeroOrOneBooleanContent</span><span class="p">,</span><span class="w">        </span><span class="c1">// All bits zero except for bit 0.</span>
<span class="w">    </span><span class="n">ZeroOrNegativeOneBooleanContent</span><span class="w"> </span><span class="c1">// All bits equal to bit 0.</span>
<span class="w">  </span><span class="p">};</span>
<span class="p">...</span>
<span class="k">protected</span><span class="o">:</span>
<span class="w">  </span><span class="c1">/// setBooleanContents - Specify how the target extends the result of a</span>
<span class="w">  </span><span class="c1">/// boolean value from i1 to a wider type.  See getBooleanContents.</span>
<span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="n">setBooleanContents</span><span class="p">(</span><span class="n">BooleanContent</span><span class="w"> </span><span class="n">Ty</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">BooleanContents</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Ty</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<span class="w">  </span><span class="c1">/// setBooleanVectorContents - Specify how the target extends the result</span>
<span class="w">  </span><span class="c1">/// of a vector boolean value from a vector of i1 to a wider type.  See</span>
<span class="w">  </span><span class="c1">/// getBooleanContents.</span>
<span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="n">setBooleanVectorContents</span><span class="p">(</span><span class="n">BooleanContent</span><span class="w"> </span><span class="n">Ty</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">BooleanVectorContents</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Ty</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
</pre></div>
</div>
<p class="rubric">lbdex/input/ch7_1_bool2.ll</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">define</span> <span class="n">zeroext</span> <span class="n">i1</span> <span class="nd">@verify_load_bool</span><span class="p">()</span> <span class="c1">#0 {</span>
<span class="n">entry</span><span class="p">:</span>
  <span class="o">%</span><span class="n">retval</span> <span class="o">=</span> <span class="n">alloca</span> <span class="n">i1</span><span class="p">,</span> <span class="n">align</span> <span class="mi">1</span>
  <span class="n">store</span> <span class="n">i1</span> <span class="mi">1</span><span class="p">,</span> <span class="n">i1</span><span class="o">*</span> <span class="o">%</span><span class="n">retval</span><span class="p">,</span> <span class="n">align</span> <span class="mi">1</span>
  <span class="o">%</span><span class="mi">0</span> <span class="o">=</span> <span class="n">load</span> <span class="n">i1</span><span class="p">,</span> <span class="n">i1</span><span class="o">*</span> <span class="o">%</span><span class="n">retval</span>
  <span class="n">ret</span> <span class="n">i1</span> <span class="o">%</span><span class="mi">0</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">  118-165-64-245:input Jonathan$ /Users/Jonathan/llvm/test/build/</span>
<span class="go">  bin/llc -march=cpu0 -relocation-model=pic -filetype=asm ch7_1_bool2.ll -o -</span>

<span class="go">  .section .mdebug.abi32</span>
<span class="go">  .previous</span>
<span class="go">  .file &quot;ch7_1_bool2.ll&quot;</span>
<span class="go">  .text</span>
<span class="go">  .globl  verify_load_bool</span>
<span class="go">  .align  2</span>
<span class="go">  .type verify_load_bool,@function</span>
<span class="go">  .ent  verify_load_bool        # @verify_load_bool</span>
<span class="go">verify_load_bool:</span>
<span class="go">  .cfi_startproc</span>
<span class="go">  .frame  $sp,8,$lr</span>
<span class="go">  .mask   0x00000000,0</span>
<span class="go">  .set  noreorder</span>
<span class="go">  .set  nomacro</span>
<span class="gp"># </span>BB#0:<span class="w">                                 </span><span class="c1"># %entry</span>
<span class="go">  addiu $sp, $sp, -8</span>
<span class="gp">$</span>tmp1:
<span class="go">  .cfi_def_cfa_offset 8</span>
<span class="go">  addiu $2, $zero, 1</span>
<span class="go">  sb  $2, 7($sp)</span>
<span class="go">  addiu $sp, $sp, 8</span>
<span class="go">  ret $lr</span>
<span class="go">  .set  macro</span>
<span class="go">  .set  reorder</span>
<span class="go">  .end  verify_load_bool</span>
<span class="gp">$</span>tmp2:
<span class="go">  .size verify_load_bool, ($tmp2)-verify_load_bool</span>
<span class="go">  .cfi_endproc</span>
</pre></div>
</div>
<p>The ch7_1_bool.cpp file provides a bool test version for C.
You can run it in Chapter8_1/ to obtain results similar to ch7_1_bool2.ll.</p>
<p class="rubric">lbdex/input/ch7_1_bool.cpp</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">bool</span> <span class="n">test_load_bool</span><span class="p">()</span>
<span class="p">{</span>
  <span class="nb">int</span> <span class="n">a</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">a</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">false</span><span class="p">;</span>

  <span class="k">return</span> <span class="n">true</span><span class="p">;</span>
<span class="p">}</span>

</pre></div>
</div>
<p>Summary Table</p>
<table class="docutils align-default" id="id6">
<caption><span class="caption-number">Table 32 </span><span class="caption-text">The C, IR, and DAG translation for char, short and bool translation (ch7_1_char_short.cpp and ch7_1_bool2.ll).</span><a class="headerlink" href="#id6" title="Link to this table">¶</a></caption>
<thead>
<tr class="row-odd"><th class="head"><p>C</p></th>
<th class="head"><p>.bc</p></th>
<th class="head"><p>Optimized legalized selection DAG</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>char a =0x80;</p></td>
<td><p>%1 = load i8* %a, align 1</p></td>
<td><ul class="simple">
<li></li>
</ul>
</td>
</tr>
<tr class="row-odd"><td><p>int i = (signed int)a;</p></td>
<td><p>%2 = sext i8 %1 to i32</p></td>
<td><p>load …, &lt;…, sext from i8&gt;</p></td>
</tr>
<tr class="row-even"><td><p>unsigned char c = 0x80;</p></td>
<td><p>%1 = load i8* %c, align 1</p></td>
<td><ul class="simple">
<li></li>
</ul>
</td>
</tr>
<tr class="row-odd"><td><p>unsigned int ui = (unsigned int)c;</p></td>
<td><p>%2 = zext i8 %1 to i32</p></td>
<td><p>load …, &lt;…, zext from i8&gt;</p></td>
</tr>
<tr class="row-even"><td><p>short a =0x8000;</p></td>
<td><p>%1 = load i16* %a, align 2</p></td>
<td><ul class="simple">
<li></li>
</ul>
</td>
</tr>
<tr class="row-odd"><td><p>int i = (signed int)a;</p></td>
<td><p>%2 = sext i16 %1 to i32</p></td>
<td><p>load …, &lt;…, sext from i16&gt;</p></td>
</tr>
<tr class="row-even"><td><p>unsigned short c = 0x8000;</p></td>
<td><p>%1 = load i16* %c, align 2</p></td>
<td><ul class="simple">
<li></li>
</ul>
</td>
</tr>
<tr class="row-odd"><td><p>unsigned int ui = (unsigned int)c;</p></td>
<td><p>%2 = zext i16 %1 to i32</p></td>
<td><p>load …, &lt;…, zext from i16&gt;</p></td>
</tr>
<tr class="row-even"><td><p>c = (unsigned short)ui;</p></td>
<td><p>%6 = trunc i32 %5 to i16</p></td>
<td><ul class="simple">
<li></li>
</ul>
</td>
</tr>
<tr class="row-odd"><td><ul class="simple">
<li></li>
</ul>
</td>
<td><p>store i16 %6, i16* %c, align 2</p></td>
<td><p>store …,&lt;…, trunc to i16&gt;</p></td>
</tr>
<tr class="row-even"><td><p>return true;</p></td>
<td><p>store i1 1, i1* %retval, align 1</p></td>
<td><p>store …,&lt;…, trunc to i8&gt;</p></td>
</tr>
</tbody>
</table>
<table class="docutils align-default" id="id7">
<caption><span class="caption-number">Table 33 </span><span class="caption-text">The backend translation for char, short and bool translation (ch7_1_char_short.cpp and ch7_1_bool2.ll).</span><a class="headerlink" href="#id7" title="Link to this table">¶</a></caption>
<thead>
<tr class="row-odd"><th class="head"><p>Optimized legalized selection DAG</p></th>
<th class="head"><p>Cpu0</p></th>
<th class="head"><p>pattern in Cpu0InstrInfo.td</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>load …, &lt;…, sext from i8&gt;</p></td>
<td><p>lb</p></td>
<td><p>LB  : LoadM32&lt;0x03, “lb”,  sextloadi8&gt;;</p></td>
</tr>
<tr class="row-odd"><td><p>load …, &lt;…, zext from i8&gt;</p></td>
<td><p>lbu</p></td>
<td><p>LBu : LoadM32&lt;0x04, “lbu”, zextloadi8&gt;;</p></td>
</tr>
<tr class="row-even"><td><p>load …, &lt;…, sext from i16&gt;</p></td>
<td><p>lh</p></td>
<td><p>LH  : LoadM32&lt;0x06, “lh”,  sextloadi16_a&gt;;</p></td>
</tr>
<tr class="row-odd"><td><p>load …, &lt;…, zext from i16&gt;</p></td>
<td><p>lhu</p></td>
<td><p>LHu : LoadM32&lt;0x07, “lhu”, zextloadi16_a&gt;;</p></td>
</tr>
<tr class="row-even"><td><p>store …,&lt;…, trunc to i16&gt;</p></td>
<td><p>sh</p></td>
<td><p>SH  : StoreM32&lt;0x08, “sh”, truncstorei16_a&gt;;</p></td>
</tr>
<tr class="row-odd"><td><p>store …,&lt;…, trunc to i8&gt;</p></td>
<td><p>sb</p></td>
<td><p>SB  : StoreM32&lt;0x05, “sb”, truncstorei8&gt;;</p></td>
</tr>
</tbody>
</table>
</section>
<section id="long-long">
<h2><a class="toc-backref" href="#id10" role="doc-backlink">long long</a><a class="headerlink" href="#long-long" title="Link to this heading">¶</a></h2>
<p>Like MIPS, the long type in Cpu0 is 32-bit, while long long is 64-bit in C.
To support long long, add the following code to Chapter7_1/:</p>
<p class="rubric">lbdex/chapters/Chapter7_1/Cpu0SEISelDAGToDAG.cpp</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">void</span> <span class="n">Cpu0SEDAGToDAGISel</span><span class="p">::</span><span class="n">selectAddESubE</span><span class="p">(</span><span class="n">unsigned</span> <span class="n">MOp</span><span class="p">,</span> <span class="n">SDValue</span> <span class="n">InFlag</span><span class="p">,</span>
                                           <span class="n">SDValue</span> <span class="n">CmpLHS</span><span class="p">,</span> <span class="n">const</span> <span class="n">SDLoc</span> <span class="o">&amp;</span><span class="n">DL</span><span class="p">,</span>
                                           <span class="n">SDNode</span> <span class="o">*</span><span class="n">Node</span><span class="p">)</span> <span class="n">const</span> <span class="p">{</span>
  <span class="n">unsigned</span> <span class="n">Opc</span> <span class="o">=</span> <span class="n">InFlag</span><span class="o">.</span><span class="n">getOpcode</span><span class="p">();</span> <span class="p">(</span><span class="n">void</span><span class="p">)</span><span class="n">Opc</span><span class="p">;</span>
  <span class="k">assert</span><span class="p">(((</span><span class="n">Opc</span> <span class="o">==</span> <span class="n">ISD</span><span class="p">::</span><span class="n">ADDC</span> <span class="o">||</span> <span class="n">Opc</span> <span class="o">==</span> <span class="n">ISD</span><span class="p">::</span><span class="n">ADDE</span><span class="p">)</span> <span class="o">||</span>
          <span class="p">(</span><span class="n">Opc</span> <span class="o">==</span> <span class="n">ISD</span><span class="p">::</span><span class="n">SUBC</span> <span class="o">||</span> <span class="n">Opc</span> <span class="o">==</span> <span class="n">ISD</span><span class="p">::</span><span class="n">SUBE</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
         <span class="s2">&quot;(ADD|SUB)E flag operand must come from (ADD|SUB)C/E insn&quot;</span><span class="p">);</span>

  <span class="n">SDValue</span> <span class="n">Ops</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">CmpLHS</span><span class="p">,</span> <span class="n">InFlag</span><span class="o">.</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">};</span>
  <span class="n">SDValue</span> <span class="n">LHS</span> <span class="o">=</span> <span class="n">Node</span><span class="o">-&gt;</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">RHS</span> <span class="o">=</span> <span class="n">Node</span><span class="o">-&gt;</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
  <span class="n">EVT</span> <span class="n">VT</span> <span class="o">=</span> <span class="n">LHS</span><span class="o">.</span><span class="n">getValueType</span><span class="p">();</span>

  <span class="n">SDNode</span> <span class="o">*</span><span class="n">Carry</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">Subtarget</span><span class="o">-&gt;</span><span class="n">hasCpu032II</span><span class="p">())</span>
    <span class="n">Carry</span> <span class="o">=</span> <span class="n">CurDAG</span><span class="o">-&gt;</span><span class="n">getMachineNode</span><span class="p">(</span><span class="n">Cpu0</span><span class="p">::</span><span class="n">SLTu</span><span class="p">,</span> <span class="n">DL</span><span class="p">,</span> <span class="n">VT</span><span class="p">,</span> <span class="n">Ops</span><span class="p">);</span>
  <span class="k">else</span> <span class="p">{</span>
    <span class="n">SDNode</span> <span class="o">*</span><span class="n">StatusWord</span> <span class="o">=</span> <span class="n">CurDAG</span><span class="o">-&gt;</span><span class="n">getMachineNode</span><span class="p">(</span><span class="n">Cpu0</span><span class="p">::</span><span class="n">CMP</span><span class="p">,</span> <span class="n">DL</span><span class="p">,</span> <span class="n">VT</span><span class="p">,</span> <span class="n">Ops</span><span class="p">);</span>
    <span class="n">SDValue</span> <span class="n">Constant1</span> <span class="o">=</span> <span class="n">CurDAG</span><span class="o">-&gt;</span><span class="n">getTargetConstant</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">DL</span><span class="p">,</span> <span class="n">VT</span><span class="p">);</span>
    <span class="n">Carry</span> <span class="o">=</span> <span class="n">CurDAG</span><span class="o">-&gt;</span><span class="n">getMachineNode</span><span class="p">(</span><span class="n">Cpu0</span><span class="p">::</span><span class="n">ANDi</span><span class="p">,</span> <span class="n">DL</span><span class="p">,</span> <span class="n">VT</span><span class="p">,</span> 
                                           <span class="n">SDValue</span><span class="p">(</span><span class="n">StatusWord</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="n">Constant1</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="n">SDNode</span> <span class="o">*</span><span class="n">AddCarry</span> <span class="o">=</span> <span class="n">CurDAG</span><span class="o">-&gt;</span><span class="n">getMachineNode</span><span class="p">(</span><span class="n">Cpu0</span><span class="p">::</span><span class="n">ADDu</span><span class="p">,</span> <span class="n">DL</span><span class="p">,</span> <span class="n">VT</span><span class="p">,</span>
                                            <span class="n">SDValue</span><span class="p">(</span><span class="n">Carry</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="n">RHS</span><span class="p">);</span>

  <span class="n">CurDAG</span><span class="o">-&gt;</span><span class="n">SelectNodeTo</span><span class="p">(</span><span class="n">Node</span><span class="p">,</span> <span class="n">MOp</span><span class="p">,</span> <span class="n">VT</span><span class="p">,</span> <span class="n">MVT</span><span class="p">::</span><span class="n">Glue</span><span class="p">,</span> <span class="n">LHS</span><span class="p">,</span> <span class="n">SDValue</span><span class="p">(</span><span class="n">AddCarry</span><span class="p">,</span><span class="mi">0</span><span class="p">));</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">bool</span> <span class="n">Cpu0SEDAGToDAGISel</span><span class="p">::</span><span class="n">trySelect</span><span class="p">(</span><span class="n">SDNode</span> <span class="o">*</span><span class="n">Node</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">unsigned</span> <span class="n">Opcode</span> <span class="o">=</span> <span class="n">Node</span><span class="o">-&gt;</span><span class="n">getOpcode</span><span class="p">();</span>
  <span class="n">SDLoc</span> <span class="n">DL</span><span class="p">(</span><span class="n">Node</span><span class="p">);</span>

  <span class="o">///</span>
  <span class="o">//</span> <span class="n">Instruction</span> <span class="n">Selection</span> <span class="ow">not</span> <span class="n">handled</span> <span class="n">by</span> <span class="n">the</span> <span class="n">auto</span><span class="o">-</span><span class="n">generated</span>
  <span class="o">//</span> <span class="n">tablegen</span> <span class="n">selection</span> <span class="n">should</span> <span class="n">be</span> <span class="n">handled</span> <span class="n">here</span><span class="o">.</span>
  <span class="o">///</span>

  <span class="o">///</span>
  <span class="o">//</span> <span class="n">Instruction</span> <span class="n">Selection</span> <span class="ow">not</span> <span class="n">handled</span> <span class="n">by</span> <span class="n">the</span> <span class="n">auto</span><span class="o">-</span><span class="n">generated</span>
  <span class="o">//</span> <span class="n">tablegen</span> <span class="n">selection</span> <span class="n">should</span> <span class="n">be</span> <span class="n">handled</span> <span class="n">here</span><span class="o">.</span>
  <span class="o">///</span>
  <span class="n">EVT</span> <span class="n">NodeTy</span> <span class="o">=</span> <span class="n">Node</span><span class="o">-&gt;</span><span class="n">getValueType</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
  <span class="n">unsigned</span> <span class="n">MultOpc</span><span class="p">;</span>

  <span class="n">switch</span><span class="p">(</span><span class="n">Opcode</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">default</span><span class="p">:</span> <span class="k">break</span><span class="p">;</span>

</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>  case ISD::SUBE: {
    SDValue InFlag = Node-&gt;getOperand(2);
    selectAddESubE(Cpu0::SUBu, InFlag, InFlag.getOperand(0), DL, Node);
    return true;
  }

  case ISD::ADDE: {
    SDValue InFlag = Node-&gt;getOperand(2);
    selectAddESubE(Cpu0::ADDu, InFlag, InFlag.getValue(0), DL, Node);
    return true;
  }

  /// Mul with two results
  case ISD::SMUL_LOHI:
  case ISD::UMUL_LOHI: {
    MultOpc = (Opcode == ISD::UMUL_LOHI ? Cpu0::MULTu : Cpu0::MULT);

    std::pair&lt;SDNode*, SDNode*&gt; LoHi =
        selectMULT(Node, MultOpc, DL, NodeTy, true, true);

    if (!SDValue(Node, 0).use_empty())
      ReplaceUses(SDValue(Node, 0), SDValue(LoHi.first, 0));

    if (!SDValue(Node, 1).use_empty())
      ReplaceUses(SDValue(Node, 1), SDValue(LoHi.second, 0));

    CurDAG-&gt;RemoveDeadNode(Node);
    return true;
  }
</pre></div>
</div>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="p">...</span>
<span class="p">}</span>
</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter7_1/Cpu0ISelLowering.h</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>  <span class="k">class</span><span class="w"> </span><span class="nc">Cpu0TargetLowering</span> <span class="p">:</span> <span class="n">public</span> <span class="n">TargetLowering</span>  <span class="p">{</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>    <span class="nb">bool</span> <span class="n">isOffsetFoldingLegal</span><span class="p">(</span><span class="n">const</span> <span class="n">GlobalAddressSDNode</span> <span class="o">*</span><span class="n">GA</span><span class="p">)</span> <span class="n">const</span> <span class="n">override</span><span class="p">;</span>
</pre></div>
</div>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="p">...</span>
<span class="p">}</span>
</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter7_1/Cpu0ISelLowering.cpp</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Cpu0TargetLowering</span><span class="p">::</span><span class="n">Cpu0TargetLowering</span><span class="p">(</span><span class="n">const</span> <span class="n">Cpu0TargetMachine</span> <span class="o">&amp;</span><span class="n">TM</span><span class="p">,</span>
                                       <span class="n">const</span> <span class="n">Cpu0Subtarget</span> <span class="o">&amp;</span><span class="n">STI</span><span class="p">)</span>
    <span class="p">:</span> <span class="n">TargetLowering</span><span class="p">(</span><span class="n">TM</span><span class="p">),</span> <span class="n">Subtarget</span><span class="p">(</span><span class="n">STI</span><span class="p">),</span> <span class="n">ABI</span><span class="p">(</span><span class="n">TM</span><span class="o">.</span><span class="n">getABI</span><span class="p">())</span> <span class="p">{</span>

</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>  <span class="o">//</span> <span class="n">Handle</span> <span class="n">i64</span> <span class="n">shl</span>
  <span class="n">setOperationAction</span><span class="p">(</span><span class="n">ISD</span><span class="p">::</span><span class="n">SHL_PARTS</span><span class="p">,</span>          <span class="n">MVT</span><span class="p">::</span><span class="n">i32</span><span class="p">,</span>   <span class="n">Expand</span><span class="p">);</span>
  <span class="n">setOperationAction</span><span class="p">(</span><span class="n">ISD</span><span class="p">::</span><span class="n">SRA_PARTS</span><span class="p">,</span>          <span class="n">MVT</span><span class="p">::</span><span class="n">i32</span><span class="p">,</span>   <span class="n">Expand</span><span class="p">);</span>
  <span class="n">setOperationAction</span><span class="p">(</span><span class="n">ISD</span><span class="p">::</span><span class="n">SRL_PARTS</span><span class="p">,</span>          <span class="n">MVT</span><span class="p">::</span><span class="n">i32</span><span class="p">,</span>   <span class="n">Expand</span><span class="p">);</span>
</pre></div>
</div>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="p">...</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The additional code in Cpu0ISelLowering.cpp handles shift operations for long
long (64-bit).
Using the &lt;&lt; and &gt;&gt; operators on 64-bit variables generates DAG SHL_PARTS,
SRA_PARTS, and SRL_PARTS, which manage 32-bit operands during LLVM DAG
translation.</p>
<p>At this point, ch9_7.cpp, which includes 64-bit shift operations, cannot be
executed.
It will be verified in the later chapter Function Call.</p>
<p>Run Chapter7_1/ with ch7_1_longlong.cpp to obtain the following result.</p>
<p class="rubric">lbdex/input/ch7_1_longlong.cpp</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">long</span> <span class="n">long</span> <span class="n">test_longlong</span><span class="p">()</span>
<span class="p">{</span>
  <span class="n">long</span> <span class="n">long</span> <span class="n">a</span> <span class="o">=</span> <span class="mh">0x300000002</span><span class="p">;</span>
  <span class="n">long</span> <span class="n">long</span> <span class="n">b</span> <span class="o">=</span> <span class="mh">0x100000001</span><span class="p">;</span>
  <span class="nb">int</span> <span class="n">a1</span> <span class="o">=</span> <span class="mh">0x3001000</span><span class="p">;</span>
  <span class="nb">int</span> <span class="n">b1</span> <span class="o">=</span> <span class="mh">0x2001000</span><span class="p">;</span>
  
  <span class="n">long</span> <span class="n">long</span> <span class="n">c</span> <span class="o">=</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="p">;</span>   <span class="o">//</span> <span class="n">c</span> <span class="o">=</span> <span class="mh">0x00000004</span><span class="p">,</span><span class="mi">00000003</span>
  <span class="n">long</span> <span class="n">long</span> <span class="n">d</span> <span class="o">=</span> <span class="n">a</span> <span class="o">-</span> <span class="n">b</span><span class="p">;</span>   <span class="o">//</span> <span class="n">d</span> <span class="o">=</span> <span class="mh">0x00000002</span><span class="p">,</span><span class="mi">00000001</span>
  <span class="n">long</span> <span class="n">long</span> <span class="n">e</span> <span class="o">=</span> <span class="n">a</span> <span class="o">*</span> <span class="n">b</span><span class="p">;</span>   <span class="o">//</span> <span class="n">e</span> <span class="o">=</span> <span class="mh">0x00000005</span><span class="p">,</span><span class="mi">00000002</span>
  <span class="n">long</span> <span class="n">long</span> <span class="n">f</span> <span class="o">=</span> <span class="p">(</span><span class="n">long</span> <span class="n">long</span><span class="p">)</span><span class="n">a1</span> <span class="o">*</span> <span class="p">(</span><span class="n">long</span> <span class="n">long</span><span class="p">)</span><span class="n">b1</span><span class="p">;</span> <span class="o">//</span> <span class="n">f</span> <span class="o">=</span> <span class="mh">0x00060050</span><span class="p">,</span><span class="mi">01000000</span>

  <span class="n">long</span> <span class="n">long</span> <span class="n">g</span> <span class="o">=</span> <span class="p">((</span><span class="o">-</span><span class="mi">7</span> <span class="o">*</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">;</span> <span class="o">//</span> <span class="n">g</span> <span class="o">=</span> <span class="o">-</span><span class="mi">55</span><span class="o">/</span><span class="mi">16</span><span class="o">=-</span><span class="mf">3.4375</span><span class="o">=-</span><span class="mi">4</span>

  <span class="k">return</span> <span class="p">(</span><span class="n">c</span><span class="o">+</span><span class="n">d</span><span class="o">+</span><span class="n">e</span><span class="o">+</span><span class="n">f</span><span class="o">+</span><span class="n">g</span><span class="p">);</span> <span class="o">//</span> <span class="p">(</span><span class="mh">0x0006005b</span><span class="p">,</span><span class="mi">01000002</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="mi">393307</span><span class="p">,</span><span class="mi">16777218</span><span class="p">)</span>
<span class="p">}</span>

</pre></div>
</div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">1-160-134-62:input Jonathan$ </span>clang<span class="w"> </span>-target<span class="w"> </span>mips-unknown-linux-gnu<span class="w"> </span>-c
<span class="go">ch7_1_longlong.cpp -emit-llvm -o ch7_1_longlong.bc</span>
<span class="gp">1-160-134-62:input Jonathan$ </span>/Users/Jonathan/llvm/test/build/
<span class="go">bin/llc -march=cpu0 -mcpu=cpu032I -relocation-model=pic -filetype=asm</span>
<span class="go">ch7_1_longlong.bc -o -</span>
<span class="go">  ...</span>
<span class="gp"># </span>BB#0:
<span class="go">        addiu $sp, $sp, -72</span>
<span class="go">        st    $8, 68($fp)             # 4-byte Folded Spill</span>
<span class="go">        addiu $2, $zero, 2</span>
<span class="go">        st    $2, 60($fp)</span>
<span class="go">        addiu $2, $zero, 3</span>
<span class="go">        st    $2, 56($fp)</span>
<span class="go">        addiu $2, $zero, 1</span>
<span class="go">        st    $2, 52($fp)</span>
<span class="go">        st    $2, 48($fp)</span>
<span class="go">        lui   $2, 768</span>
<span class="go">        ori   $2, $2, 4096</span>
<span class="go">        st    $2, 44($fp)</span>
<span class="go">        lui   $2, 512</span>
<span class="go">        ori   $2, $2, 4096</span>
<span class="go">        st    $2, 40($fp)</span>
<span class="go">        ld    $2, 52($fp)</span>
<span class="go">        ld    $3, 60($fp)</span>
<span class="go">        addu  $3, $3, $2</span>
<span class="go">        ld    $4, 56($fp)</span>
<span class="go">        ld    $5, 48($fp)</span>
<span class="go">        st    $3, 36($fp)</span>
<span class="go">        cmp   $sw, $3, $2</span>
<span class="go">        andi  $2, $sw, 1</span>
<span class="go">        addu  $2, $2, $5</span>
<span class="go">        addu  $2, $4, $2</span>
<span class="go">        st    $2, 32($fp)</span>
<span class="go">        ld    $2, 52($fp)</span>
<span class="go">        ld    $3, 60($fp)</span>
<span class="go">        subu  $4, $3, $2</span>
<span class="go">        ld    $5, 56($fp)</span>
<span class="go">        ld    $t9, 48($fp)</span>
<span class="go">        st    $4, 28($fp)</span>
<span class="go">        cmp   $sw, $3, $2</span>
<span class="go">        andi  $2, $sw, 1</span>
<span class="go">        addu  $2, $2, $t9</span>
<span class="go">        subu  $2, $5, $2</span>
<span class="go">        st    $2, 24($fp)</span>
<span class="go">        ld    $2, 52($fp)</span>
<span class="go">        ld    $3, 60($fp)</span>
<span class="go">        multu $3, $2</span>
<span class="go">        mflo  $4</span>
<span class="go">        mfhi  $5</span>
<span class="go">        ld    $t9, 56($fp)</span>
<span class="go">        ld    $7, 48($fp)</span>
<span class="go">        st    $4, 20($fp)</span>
<span class="go">        mul   $3, $3, $7</span>
<span class="go">        addu  $3, $5, $3</span>
<span class="go">        mul   $2, $t9, $2</span>
<span class="go">        addu  $2, $3, $2</span>
<span class="go">        st    $2, 16($fp)</span>
<span class="go">        ld    $2, 40($fp)</span>
<span class="go">        ld    $3, 44($fp)</span>
<span class="go">        mult  $3, $2</span>
<span class="go">        mflo  $2</span>
<span class="go">        mfhi  $4</span>
<span class="go">        st    $2, 12($fp)</span>
<span class="go">        st    $4, 8($fp)</span>
<span class="go">        ld    $5, 28($fp)</span>
<span class="go">        ld    $3, 36($fp)</span>
<span class="go">        addu  $t9, $3, $5</span>
<span class="go">        ld    $7, 20($fp)</span>
<span class="go">        addu  $8, $t9, $7</span>
<span class="go">        addu  $3, $8, $2</span>
<span class="go">        cmp   $sw, $3, $2</span>
<span class="go">        andi  $2, $sw, 1</span>
<span class="go">        addu  $2, $2, $4</span>
<span class="go">        cmp   $sw, $t9, $5</span>
<span class="go">        st    $sw, 4($fp)             # 4-byte Folded Spill</span>
<span class="go">        cmp   $sw, $8, $7</span>
<span class="go">        andi  $4, $sw, 1</span>
<span class="go">        ld    $5, 16($fp)</span>
<span class="go">        addu  $4, $4, $5</span>
<span class="go">        ld    $sw, 4($fp)             # 4-byte Folded Reload</span>
<span class="go">        andi  $5, $sw, 1</span>
<span class="go">        ld    $t9, 24($fp)</span>
<span class="go">        addu  $5, $5, $t9</span>
<span class="go">        ld    $t9, 32($fp)</span>
<span class="go">        addu  $5, $t9, $5</span>
<span class="go">        addu  $4, $5, $4</span>
<span class="go">        addu  $2, $4, $2</span>
<span class="go">        ld    $8, 68($fp)             # 4-byte Folded Reload</span>
<span class="go">        addiu $sp, $sp, 72</span>
<span class="go">        ret   $lr</span>
<span class="go">  ...</span>
</pre></div>
</div>
</section>
<section id="float-and-double">
<h2><a class="toc-backref" href="#id11" role="doc-backlink">float and double</a><a class="headerlink" href="#float-and-double" title="Link to this heading">¶</a></h2>
<p>At this point, Cpu0 only supports integer instructions.
For floating-point operations, the Cpu0 backend calls library functions
to convert integers to floats, as follows:</p>
<p class="rubric">lbdex/input/ch7_1_fmul.c</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/*</span> 
<span class="o">~/</span><span class="n">llvm</span><span class="o">/</span><span class="n">debug</span><span class="o">/</span><span class="n">build</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">clang</span> <span class="o">-</span><span class="n">target</span> <span class="n">mips</span><span class="o">-</span><span class="n">unknown</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gnu</span> <span class="o">-</span><span class="n">emit</span><span class="o">-</span><span class="n">llvm</span> <span class="o">-</span><span class="n">S</span> <span class="n">ch7_1_fmul</span><span class="o">.</span><span class="n">c</span>
        <span class="o">...</span>
        <span class="o">%</span><span class="n">mul</span> <span class="o">=</span> <span class="n">fmul</span> <span class="nb">float</span> <span class="o">%</span><span class="mi">0</span><span class="p">,</span> <span class="o">%</span><span class="mi">1</span>

<span class="o">~/</span><span class="n">llvm</span><span class="o">/</span><span class="n">debug</span><span class="o">/</span><span class="n">build</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">llc</span> <span class="o">-</span><span class="n">march</span><span class="o">=</span><span class="n">mips</span> <span class="n">ch7_1_fmul</span><span class="o">.</span><span class="n">ll</span> <span class="o">-</span><span class="n">relocation</span><span class="o">-</span><span class="n">model</span><span class="o">=</span><span class="n">static</span> <span class="o">-</span><span class="n">o</span> <span class="o">-</span>
        <span class="o">...</span>
	<span class="n">v_log_f32_e32</span> <span class="n">v1</span><span class="p">,</span> <span class="n">v0</span>
	<span class="n">v_mul_legacy_f32_e32</span> <span class="n">v0</span><span class="p">,</span> <span class="n">v0</span><span class="p">,</span> <span class="n">v1</span>
	<span class="n">v_exp_f32_e32</span> <span class="n">v0</span><span class="p">,</span> <span class="n">v0</span>

<span class="o">~/</span><span class="n">llvm</span><span class="o">/</span><span class="n">test</span><span class="o">/</span><span class="n">build</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">llc</span> <span class="o">-</span><span class="n">march</span><span class="o">=</span><span class="n">cpu0</span> <span class="n">ch7_1_fmul</span><span class="o">.</span><span class="n">ll</span> <span class="o">-</span><span class="n">relocation</span><span class="o">-</span><span class="n">model</span><span class="o">=</span><span class="n">static</span> <span class="o">-</span><span class="n">o</span> <span class="o">-</span>
         <span class="o">...</span>
        <span class="n">jsub</span> <span class="n">__mulsf3</span>
<span class="o">*/</span>

<span class="nb">float</span> <span class="n">ch7_1_fmul</span><span class="p">(</span><span class="nb">float</span> <span class="n">a</span><span class="p">,</span> <span class="nb">float</span> <span class="n">b</span><span class="p">)</span> <span class="p">{</span>
  <span class="nb">float</span> <span class="n">c</span> <span class="o">=</span> <span class="n">a</span> <span class="o">*</span> <span class="n">b</span><span class="p">;</span>
  <span class="k">return</span> <span class="n">c</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Floating-point function calls for Cpu0 will be supported in the Function Call
chapter.
Due to hardware cost constraints, many CPUs do not include floating-point
hardware instructions.
Instead, they rely on library functions.
MIPS separates floating-point operations into a dedicated co-processor for
applications that require floating-point arithmetic.</p>
<p>To support the floating-point library (part of compiler-rt)
<a class="footnote-reference brackets" href="#lbt-compiler-rt" id="id1" role="doc-noteref"><span class="fn-bracket">[</span>2<span class="fn-bracket">]</span></a>, the following code is added to support clz and clo
instructions.
Although these instructions are implemented in compiler-rt, they
are integer operations that improve floating-point application performance.</p>
<p class="rubric">lbdex/chapters/Chapter7_1/Cpu0InstrInfo.td</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>let Predicates = [Ch7_1] in {
// Count Leading Ones/Zeros in Word
class CountLeading0&lt;bits&lt;8&gt; op, string instr_asm, RegisterClass RC&gt;:
  FA&lt;op, (outs GPROut:$ra), (ins RC:$rb),
     !strconcat(instr_asm, &quot;\t$ra, $rb&quot;),
     [(set GPROut:$ra, (ctlz RC:$rb))], II_CLZ&gt; {
  let rc = 0;
  let shamt = 0;
}

class CountLeading1&lt;bits&lt;8&gt; op, string instr_asm, RegisterClass RC&gt;:
  FA&lt;op, (outs GPROut:$ra), (ins RC:$rb),
     !strconcat(instr_asm, &quot;\t$ra, $rb&quot;),
     [(set GPROut:$ra, (ctlz (not RC:$rb)))], II_CLO&gt; {
  let rc = 0;
  let shamt = 0;
}
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">let</span> <span class="n">Predicates</span> <span class="o">=</span> <span class="p">[</span><span class="n">Ch7_1</span><span class="p">]</span> <span class="ow">in</span> <span class="p">{</span>
<span class="o">///</span> <span class="n">Count</span> <span class="n">Leading</span>
<span class="k">def</span><span class="w"> </span><span class="nf">CLZ</span> <span class="p">:</span> <span class="n">CountLeading0</span><span class="o">&lt;</span><span class="mh">0x15</span><span class="p">,</span> <span class="s2">&quot;clz&quot;</span><span class="p">,</span> <span class="n">CPURegs</span><span class="o">&gt;</span><span class="p">;</span>
<span class="k">def</span><span class="w"> </span><span class="nf">CLO</span> <span class="p">:</span> <span class="n">CountLeading1</span><span class="o">&lt;</span><span class="mh">0x16</span><span class="p">,</span> <span class="s2">&quot;clo&quot;</span><span class="p">,</span> <span class="n">CPURegs</span><span class="o">&gt;</span><span class="p">;</span>

</pre></div>
</div>
</section>
<section id="array-and-struct-support">
<h2><a class="toc-backref" href="#id12" role="doc-backlink">Array and struct support</a><a class="headerlink" href="#array-and-struct-support" title="Link to this heading">¶</a></h2>
<p>LLVM uses getelementptr to represent array and struct types in C.
For details, refer to <a class="footnote-reference brackets" href="#id5" id="id2" role="doc-noteref"><span class="fn-bracket">[</span>1<span class="fn-bracket">]</span></a>.</p>
<p>For ch7_1_globalstructoffset.cpp, the LLVM IR is as follows:</p>
<p class="rubric">lbdex/input/ch7_1_globalstructoffset.cpp</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">struct</span> <span class="n">Date</span>
<span class="p">{</span>
  <span class="nb">int</span> <span class="n">year</span><span class="p">;</span>
  <span class="nb">int</span> <span class="n">month</span><span class="p">;</span>
  <span class="nb">int</span> <span class="n">day</span><span class="p">;</span>
<span class="p">};</span>

<span class="n">Date</span> <span class="n">date</span> <span class="o">=</span> <span class="p">{</span><span class="mi">2012</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">12</span><span class="p">};</span>
<span class="nb">int</span> <span class="n">a</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">2012</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">12</span><span class="p">};</span>

<span class="nb">int</span> <span class="n">test_struct</span><span class="p">()</span>
<span class="p">{</span>
  <span class="nb">int</span> <span class="n">day</span> <span class="o">=</span> <span class="n">date</span><span class="o">.</span><span class="n">day</span><span class="p">;</span>
  <span class="nb">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

  <span class="k">return</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="n">day</span><span class="p">);</span> <span class="o">//</span> <span class="mi">10</span><span class="o">+</span><span class="mi">12</span><span class="o">=</span><span class="mi">22</span>
<span class="p">}</span>

</pre></div>
</div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">// ch7_1_globalstructoffset.ll</span>
<span class="go">; ModuleID = &#39;ch7_1_globalstructoffset.bc&#39;</span>
<span class="go">...</span>
<span class="gp">%</span>struct.Date<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">type</span><span class="w"> </span><span class="o">{</span><span class="w"> </span>i32,<span class="w"> </span>i32,<span class="w"> </span>i32<span class="w"> </span><span class="o">}</span>

<span class="go">@date = global %struct.Date { i32 2012, i32 10, i32 12 }, align 4</span>
<span class="go">@a = global [3 x i32] [i32 2012, i32 10, i32 12], align 4</span>

<span class="go">; Function Attrs: nounwind</span>
<span class="go">define i32 @_Z11test_structv() #0 {</span>
<span class="gp">  %</span><span class="nv">day</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>alloca<span class="w"> </span>i32,<span class="w"> </span>align<span class="w"> </span><span class="m">4</span>
<span class="gp">  %</span><span class="nv">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>alloca<span class="w"> </span>i32,<span class="w"> </span>align<span class="w"> </span><span class="m">4</span>
<span class="gp">  %</span><span class="nv">1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>load<span class="w"> </span>i32*<span class="w"> </span>getelementptr<span class="w"> </span>inbounds<span class="w"> </span><span class="o">(</span>%struct.Date*<span class="w"> </span>@date,<span class="w"> </span>i32<span class="w"> </span><span class="m">0</span>,<span class="w"> </span>i32<span class="w"> </span><span class="m">2</span><span class="o">)</span>,<span class="w"> </span>align<span class="w"> </span><span class="m">4</span>
<span class="go">  store i32 %1, i32* %day, align 4</span>
<span class="gp">  %</span><span class="nv">2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>load<span class="w"> </span>i32*<span class="w"> </span>getelementptr<span class="w"> </span>inbounds<span class="w"> </span><span class="o">([</span><span class="m">3</span><span class="w"> </span>x<span class="w"> </span>i32<span class="o">]</span>*<span class="w"> </span>@a,<span class="w"> </span>i32<span class="w"> </span><span class="m">0</span>,<span class="w"> </span>i32<span class="w"> </span><span class="m">1</span><span class="o">)</span>,<span class="w"> </span>align<span class="w"> </span><span class="m">4</span>
<span class="go">  store i32 %2, i32* %i, align 4</span>
<span class="gp">  %</span><span class="nv">3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>load<span class="w"> </span>i32*<span class="w"> </span>%i,<span class="w"> </span>align<span class="w"> </span><span class="m">4</span>
<span class="gp">  %</span><span class="nv">4</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>load<span class="w"> </span>i32*<span class="w"> </span>%day,<span class="w"> </span>align<span class="w"> </span><span class="m">4</span>
<span class="gp">  %</span><span class="nv">5</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>add<span class="w"> </span>nsw<span class="w"> </span>i32<span class="w"> </span>%3,<span class="w"> </span>%4
<span class="go">  ret i32 %5</span>
<span class="go">}</span>
</pre></div>
</div>
<p>Run Chapter6_1/ with ch7_1_globalstructoffset.bc on static mode will get the
incorrect asm file as follows,</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">1-160-134-62:input Jonathan$ </span>/Users/Jonathan/llvm/test/build/bin/
<span class="go">llc -march=cpu0 -relocation-model=static -filetype=asm</span>
<span class="go">ch7_1_globalstructoffset.bc -o -</span>
<span class="go">  ...</span>
<span class="go">  lui $2, %hi(date)</span>
<span class="go">  ori $2, $2, %lo(date)</span>
<span class="go">  ld  $2, 0($2)   // the correct one is   ld  $2, 8($2)</span>
<span class="go">  ...</span>
</pre></div>
</div>
<p>For day = date.day, the correct instruction is
<strong>ld $2, 8($2), not ld $2, 0($2),</strong>
since date.day has an offset of 8 bytes (the date struct contains year and
month before day).
Use the debug option in llc to analyze this:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">jonathantekiimac:input Jonathan$ </span>/Users/Jonathan/llvm/test/
<span class="go">build/bin/llc -march=cpu0 -debug -relocation-model=static</span>
<span class="go">-filetype=asm ch6_2.bc -o ch6_2.cpu0.static.s</span>
<span class="go">...</span>
<span class="go">=== main</span>
<span class="go">Initial selection DAG: BB#0 &#39;main:entry&#39;</span>
<span class="go">SelectionDAG has 20 nodes:</span>
<span class="go">  0x7f7f5b02d210: i32 = undef [ORD=1]</span>

<span class="go">      0x7f7f5ac10590: ch = EntryToken [ORD=1]</span>

<span class="go">      0x7f7f5b02d010: i32 = Constant&lt;0&gt; [ORD=1]</span>

<span class="go">      0x7f7f5b02d110: i32 = FrameIndex&lt;0&gt; [ORD=1]</span>

<span class="go">      0x7f7f5b02d210: &lt;multiple use&gt;</span>
<span class="go">    0x7f7f5b02d310: ch = store 0x7f7f5ac10590, 0x7f7f5b02d010, 0x7f7f5b02d110,</span>
<span class="go">    0x7f7f5b02d210&lt;ST4[%retval]&gt; [ORD=1]</span>

<span class="go">      0x7f7f5b02d410: i32 = GlobalAddress&lt;%struct.Date* @date&gt; 0 [ORD=2]</span>

<span class="go">      0x7f7f5b02d510: i32 = Constant&lt;8&gt; [ORD=2]</span>

<span class="go">    0x7f7f5b02d610: i32 = add 0x7f7f5b02d410, 0x7f7f5b02d510 [ORD=2]</span>

<span class="go">    0x7f7f5b02d210: &lt;multiple use&gt;</span>
<span class="go">  0x7f7f5b02d710: i32,ch = load 0x7f7f5b02d310, 0x7f7f5b02d610, 0x7f7f5b02d210</span>
<span class="go">  &lt;LD4[getelementptr inbounds (%struct.Date* @date, i32 0, i32 2)]&gt; [ORD=3]</span>

<span class="go">  0x7f7f5b02db10: i64 = Constant&lt;4&gt;</span>

<span class="go">      0x7f7f5b02d710: &lt;multiple use&gt;</span>
<span class="go">      0x7f7f5b02d710: &lt;multiple use&gt;</span>
<span class="go">      0x7f7f5b02d810: i32 = FrameIndex&lt;1&gt; [ORD=4]</span>

<span class="go">      0x7f7f5b02d210: &lt;multiple use&gt;</span>
<span class="go">    0x7f7f5b02d910: ch = store 0x7f7f5b02d710:1, 0x7f7f5b02d710, 0x7f7f5b02d810,</span>
<span class="go">     0x7f7f5b02d210&lt;ST4[%day]&gt; [ORD=4]</span>

<span class="go">      0x7f7f5b02da10: i32 = GlobalAddress&lt;[3 x i32]* @a&gt; 0 [ORD=5]</span>

<span class="go">      0x7f7f5b02dc10: i32 = Constant&lt;4&gt; [ORD=5]</span>

<span class="go">    0x7f7f5b02dd10: i32 = add 0x7f7f5b02da10, 0x7f7f5b02dc10 [ORD=5]</span>

<span class="go">    0x7f7f5b02d210: &lt;multiple use&gt;</span>
<span class="go">  0x7f7f5b02de10: i32,ch = load 0x7f7f5b02d910, 0x7f7f5b02dd10, 0x7f7f5b02d210</span>
<span class="go">  &lt;LD4[getelementptr inbounds ([3 x i32]* @a, i32 0, i32 1)]&gt; [ORD=6]</span>

<span class="go">...</span>


<span class="go">Replacing.3 0x7f7f5b02dd10: i32 = add 0x7f7f5b02da10, 0x7f7f5b02dc10 [ORD=5]</span>

<span class="go">With: 0x7f7f5b030010: i32 = GlobalAddress&lt;[3 x i32]* @a&gt; + 4</span>


<span class="go">Replacing.3 0x7f7f5b02d610: i32 = add 0x7f7f5b02d410, 0x7f7f5b02d510 [ORD=2]</span>

<span class="go">With: 0x7f7f5b02db10: i32 = GlobalAddress&lt;%struct.Date* @date&gt; + 8</span>

<span class="go">Optimized lowered selection DAG: BB#0 &#39;main:entry&#39;</span>
<span class="go">SelectionDAG has 15 nodes:</span>
<span class="go">  0x7f7f5b02d210: i32 = undef [ORD=1]</span>

<span class="go">      0x7f7f5ac10590: ch = EntryToken [ORD=1]</span>

<span class="go">      0x7f7f5b02d010: i32 = Constant&lt;0&gt; [ORD=1]</span>

<span class="go">      0x7f7f5b02d110: i32 = FrameIndex&lt;0&gt; [ORD=1]</span>

<span class="go">      0x7f7f5b02d210: &lt;multiple use&gt;</span>
<span class="go">    0x7f7f5b02d310: ch = store 0x7f7f5ac10590, 0x7f7f5b02d010, 0x7f7f5b02d110,</span>
<span class="go">    0x7f7f5b02d210&lt;ST4[%retval]&gt; [ORD=1]</span>

<span class="go">    0x7f7f5b02db10: i32 = GlobalAddress&lt;%struct.Date* @date&gt; + 8</span>

<span class="go">    0x7f7f5b02d210: &lt;multiple use&gt;</span>
<span class="go">  0x7f7f5b02d710: i32,ch = load 0x7f7f5b02d310, 0x7f7f5b02db10, 0x7f7f5b02d210</span>
<span class="go">  &lt;LD4[getelementptr inbounds (%struct.Date* @date, i32 0, i32 2)]&gt; [ORD=3]</span>

<span class="go">      0x7f7f5b02d710: &lt;multiple use&gt;</span>
<span class="go">      0x7f7f5b02d710: &lt;multiple use&gt;</span>
<span class="go">      0x7f7f5b02d810: i32 = FrameIndex&lt;1&gt; [ORD=4]</span>

<span class="go">      0x7f7f5b02d210: &lt;multiple use&gt;</span>
<span class="go">    0x7f7f5b02d910: ch = store 0x7f7f5b02d710:1, 0x7f7f5b02d710, 0x7f7f5b02d810,</span>
<span class="go">     0x7f7f5b02d210&lt;ST4[%day]&gt; [ORD=4]</span>

<span class="go">    0x7f7f5b030010: i32 = GlobalAddress&lt;[3 x i32]* @a&gt; + 4</span>

<span class="go">    0x7f7f5b02d210: &lt;multiple use&gt;</span>
<span class="go">  0x7f7f5b02de10: i32,ch = load 0x7f7f5b02d910, 0x7f7f5b030010, 0x7f7f5b02d210</span>
<span class="go">  &lt;LD4[getelementptr inbounds ([3 x i32]* @a, i32 0, i32 1)]&gt; [ORD=6]</span>

<span class="go">...</span>
</pre></div>
</div>
<p>The output reveals the DAG translation process.
As shown, the DAG node for date.day
(add GlobalAddress&lt;[3 x i32]* &#64;a&gt; 0, Constant&lt;8&gt;) with three nodes is replaced
by a single node GlobalAddress&lt;%struct.Date* &#64;date&gt; + 8.
The same applies to a[1].</p>
<p>This replacement occurs because TargetLowering.cpp::isOffsetFoldingLegal(…)
returns true in <code class="docutils literal notranslate"><span class="pre">llc</span> <span class="pre">-static</span></code> static addressing mode.
In Cpu0, the <strong>ld</strong> instruction format is <strong>ld $r1, offset($r2)</strong>,
meaning it loads the value at address($r2) + offset into $r1.
To correct this, override isOffsetFoldingLegal(…) as follows:</p>
<p class="rubric">lib/CodeGen/SelectionDAG/TargetLowering.cpp</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="kt">bool</span>
<span class="nf">TargetLowering::isOffsetFoldingLegal</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">GlobalAddressSDNode</span><span class="w"> </span><span class="o">*</span><span class="n">GA</span><span class="p">)</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// Assume that everything is safe in static mode.</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">getTargetMachine</span><span class="p">().</span><span class="n">getRelocationModel</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">Reloc</span><span class="o">::</span><span class="n">Static</span><span class="p">)</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>

<span class="w">  </span><span class="c1">// In dynamic-no-pic mode, assume that known defined values are safe.</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">getTargetMachine</span><span class="p">().</span><span class="n">getRelocationModel</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">Reloc</span><span class="o">::</span><span class="n">DynamicNoPIC</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">     </span><span class="n">GA</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">     </span><span class="o">!</span><span class="n">GA</span><span class="o">-&gt;</span><span class="n">getGlobal</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">isDeclaration</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">     </span><span class="o">!</span><span class="n">GA</span><span class="o">-&gt;</span><span class="n">getGlobal</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">isWeakForLinker</span><span class="p">())</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>

<span class="w">  </span><span class="c1">// Otherwise assume nothing is safe.</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter7_1/Cpu0ISelLowering.cpp</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">bool</span>
<span class="n">Cpu0TargetLowering</span><span class="p">::</span><span class="n">isOffsetFoldingLegal</span><span class="p">(</span><span class="n">const</span> <span class="n">GlobalAddressSDNode</span> <span class="o">*</span><span class="n">GA</span><span class="p">)</span> <span class="n">const</span> <span class="p">{</span>
  <span class="o">//</span> <span class="n">The</span> <span class="n">Cpu0</span> <span class="n">target</span> <span class="n">isn</span><span class="s1">&#39;t yet aware of offsets.</span>
  <span class="k">return</span> <span class="n">false</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Additionally, add the following code to Cpu0ISelDAGToDAG.cpp:</p>
<p>When SelectAddr(…) in Cpu0ISelDAGToDAG.cpp is called,
Addr represents the DAG node for date.day:</p>
<p class="rubric">lbdex/chapters/Chapter7_1/Cpu0ISelDAGToDAG.cpp</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">///</span> <span class="n">ComplexPattern</span> <span class="n">used</span> <span class="n">on</span> <span class="n">Cpu0InstrInfo</span>
<span class="o">///</span> <span class="n">Used</span> <span class="n">on</span> <span class="n">Cpu0</span> <span class="n">Load</span><span class="o">/</span><span class="n">Store</span> <span class="n">instructions</span>
<span class="nb">bool</span> <span class="n">Cpu0DAGToDAGISel</span><span class="p">::</span>
<span class="n">SelectAddr</span><span class="p">(</span><span class="n">SDNode</span> <span class="o">*</span><span class="n">Parent</span><span class="p">,</span> <span class="n">SDValue</span> <span class="n">Addr</span><span class="p">,</span> <span class="n">SDValue</span> <span class="o">&amp;</span><span class="n">Base</span><span class="p">,</span> <span class="n">SDValue</span> <span class="o">&amp;</span><span class="n">Offset</span><span class="p">)</span> <span class="p">{</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>  <span class="o">//</span> <span class="n">Addresses</span> <span class="n">of</span> <span class="n">the</span> <span class="n">form</span> <span class="n">FI</span><span class="o">+</span><span class="n">const</span> <span class="ow">or</span> <span class="n">FI</span><span class="o">|</span><span class="n">const</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">CurDAG</span><span class="o">-&gt;</span><span class="n">isBaseWithConstantOffset</span><span class="p">(</span><span class="n">Addr</span><span class="p">))</span> <span class="p">{</span>
    <span class="n">ConstantSDNode</span> <span class="o">*</span><span class="n">CN</span> <span class="o">=</span> <span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">ConstantSDNode</span><span class="o">&gt;</span><span class="p">(</span><span class="n">Addr</span><span class="o">.</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">isInt</span><span class="o">&lt;</span><span class="mi">16</span><span class="o">&gt;</span><span class="p">(</span><span class="n">CN</span><span class="o">-&gt;</span><span class="n">getSExtValue</span><span class="p">()))</span> <span class="p">{</span>

      <span class="o">//</span> <span class="n">If</span> <span class="n">the</span> <span class="n">first</span> <span class="n">operand</span> <span class="ow">is</span> <span class="n">a</span> <span class="n">FI</span><span class="p">,</span> <span class="n">get</span> <span class="n">the</span> <span class="n">TargetFI</span> <span class="n">Node</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">FrameIndexSDNode</span> <span class="o">*</span><span class="n">FIN</span> <span class="o">=</span> <span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">FrameIndexSDNode</span><span class="o">&gt;</span>
                                  <span class="p">(</span><span class="n">Addr</span><span class="o">.</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">)))</span>
        <span class="n">Base</span> <span class="o">=</span> <span class="n">CurDAG</span><span class="o">-&gt;</span><span class="n">getTargetFrameIndex</span><span class="p">(</span><span class="n">FIN</span><span class="o">-&gt;</span><span class="n">getIndex</span><span class="p">(),</span> <span class="n">ValTy</span><span class="p">);</span>
      <span class="k">else</span>
        <span class="n">Base</span> <span class="o">=</span> <span class="n">Addr</span><span class="o">.</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

      <span class="n">Offset</span> <span class="o">=</span> <span class="n">CurDAG</span><span class="o">-&gt;</span><span class="n">getTargetConstant</span><span class="p">(</span><span class="n">CN</span><span class="o">-&gt;</span><span class="n">getZExtValue</span><span class="p">(),</span> <span class="n">DL</span><span class="p">,</span> <span class="n">ValTy</span><span class="p">);</span>
      <span class="k">return</span> <span class="n">true</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
</pre></div>
</div>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="p">...</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Recall that we have translated the DAG list for <code class="docutils literal notranslate"><span class="pre">date.day</span></code>
<code class="docutils literal notranslate"><span class="pre">(add</span> <span class="pre">GlobalAddress&lt;[3</span> <span class="pre">x</span> <span class="pre">i32]*</span> <span class="pre">&#64;a&gt;</span> <span class="pre">0,</span> <span class="pre">Constant&lt;8&gt;)</span></code> into</p>
<p><code class="docutils literal notranslate"><span class="pre">(add</span> <span class="pre">(add</span> <span class="pre">Cpu0ISD::Hi</span> <span class="pre">(Cpu0II::MO_ABS_HI),</span> <span class="pre">Cpu0ISD::Lo(Cpu0II::MO_ABS_LO)),</span></code>
<code class="docutils literal notranslate"><span class="pre">Constant&lt;8&gt;)</span></code></p>
<p>by the following code in <code class="docutils literal notranslate"><span class="pre">Cpu0ISelLowering.h</span></code>.</p>
<p class="rubric">lbdex/chapters/Chapter6_1/Cpu0ISelLowering.h</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>    <span class="o">//</span> <span class="n">This</span> <span class="n">method</span> <span class="n">creates</span> <span class="n">the</span> <span class="n">following</span> <span class="n">nodes</span><span class="p">,</span> <span class="n">which</span> <span class="n">are</span> <span class="n">necessary</span> <span class="k">for</span>
    <span class="o">//</span> <span class="n">computing</span> <span class="n">a</span> <span class="n">symbol</span><span class="s1">&#39;s address in non-PIC mode:</span>
    <span class="o">//</span>
    <span class="o">//</span> <span class="p">(</span><span class="n">add</span> <span class="o">%</span><span class="n">hi</span><span class="p">(</span><span class="n">sym</span><span class="p">),</span> <span class="o">%</span><span class="n">lo</span><span class="p">(</span><span class="n">sym</span><span class="p">))</span>
    <span class="n">template</span><span class="o">&lt;</span><span class="k">class</span><span class="w"> </span><span class="nc">NodeTy</span><span class="o">&gt;</span>
    <span class="n">SDValue</span> <span class="n">getAddrNonPIC</span><span class="p">(</span><span class="n">NodeTy</span> <span class="o">*</span><span class="n">N</span><span class="p">,</span> <span class="n">EVT</span> <span class="n">Ty</span><span class="p">,</span> <span class="n">SelectionDAG</span> <span class="o">&amp;</span><span class="n">DAG</span><span class="p">)</span> <span class="n">const</span> <span class="p">{</span>
      <span class="n">SDLoc</span> <span class="n">DL</span><span class="p">(</span><span class="n">N</span><span class="p">);</span>
      <span class="n">SDValue</span> <span class="n">Hi</span> <span class="o">=</span> <span class="n">getTargetNode</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">Ty</span><span class="p">,</span> <span class="n">DAG</span><span class="p">,</span> <span class="n">Cpu0II</span><span class="p">::</span><span class="n">MO_ABS_HI</span><span class="p">);</span>
      <span class="n">SDValue</span> <span class="n">Lo</span> <span class="o">=</span> <span class="n">getTargetNode</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">Ty</span><span class="p">,</span> <span class="n">DAG</span><span class="p">,</span> <span class="n">Cpu0II</span><span class="p">::</span><span class="n">MO_ABS_LO</span><span class="p">);</span>
      <span class="k">return</span> <span class="n">DAG</span><span class="o">.</span><span class="n">getNode</span><span class="p">(</span><span class="n">ISD</span><span class="p">::</span><span class="n">ADD</span><span class="p">,</span> <span class="n">DL</span><span class="p">,</span> <span class="n">Ty</span><span class="p">,</span>
                         <span class="n">DAG</span><span class="o">.</span><span class="n">getNode</span><span class="p">(</span><span class="n">Cpu0ISD</span><span class="p">::</span><span class="n">Hi</span><span class="p">,</span> <span class="n">DL</span><span class="p">,</span> <span class="n">Ty</span><span class="p">,</span> <span class="n">Hi</span><span class="p">),</span>
                         <span class="n">DAG</span><span class="o">.</span><span class="n">getNode</span><span class="p">(</span><span class="n">Cpu0ISD</span><span class="p">::</span><span class="n">Lo</span><span class="p">,</span> <span class="n">DL</span><span class="p">,</span> <span class="n">Ty</span><span class="p">,</span> <span class="n">Lo</span><span class="p">));</span>
    <span class="p">}</span>
</pre></div>
</div>
<p>add (add Cpu0ISD::Hi (Cpu0II::MO_ABS_HI), Cpu0ISD::Lo(Cpu0II::MO_ABS_LO)), Constant&lt;8&gt;</p>
<p>Since Addr.getOpcode() = ISD:ADD,
Addr.getOperand(0) = (add Cpu0ISD::Hi (Cpu0II::MO_ABS_HI), Cpu0ISD::Lo(Cpu0II::MO_ABS_LO)),
and Addr.getOperand(1).getOpcode() = ISD::Constant,
we set Base to (add Cpu0ISD::Hi (Cpu0II::MO_ABS_HI), Cpu0ISD::Lo(Cpu0II::MO_ABS_LO))
and Offset to Constant&lt;8&gt;.
This ensures ld $r1, 8($r2) is correctly generated in the Instruction Selection stage.</p>
<p>Run Chapter7_1/ with ch7_1_globalstructoffset.cpp to obtain the correct instruction.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">...</span>
<span class="go">      lui   $2, %hi(date)</span>
<span class="go">      ori   $2, $2, %lo(date)</span>
<span class="go">      ld    $2, 8($2)   // correct</span>
<span class="go">...</span>
</pre></div>
</div>
<p>The ch7_1_localarrayinit.cpp is for local variable initialization test.
The result as follows,</p>
<p class="rubric">lbdex/input/ch7_1_localarrayinit.cpp</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">int</span> <span class="n">main</span><span class="p">()</span>
<span class="p">{</span>
  <span class="nb">int</span> <span class="n">a</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">=</span><span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">};</span>
    
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">118-165-79-206:input Jonathan$ </span>clang<span class="w"> </span>-target<span class="w"> </span>mips-unknown-linux-gnu<span class="w"> </span>-c
<span class="go">ch7_1_localarrayinit.cpp -emit-llvm -o ch7_1_localarrayinit.bc</span>
<span class="gp">118-165-79-206:input Jonathan$ </span>llvm-dis<span class="w"> </span>ch7_1_localarrayinit.bc<span class="w"> </span>-o<span class="w"> </span>-
<span class="go">...</span>
</pre></div>
</div>
<div class="highlight-llvm notranslate"><div class="highlight"><pre><span></span><span class="k">define</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="vg">@main</span><span class="p">()</span><span class="w"> </span><span class="k">nounwind</span><span class="w"> </span><span class="k">ssp</span><span class="w"> </span><span class="p">{</span>
<span class="nl">entry:</span>
<span class="w">  </span><span class="nv">%retval</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">alloca</span><span class="w"> </span><span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="k">align</span><span class="w"> </span><span class="m">4</span>
<span class="w">  </span><span class="nv">%a</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">alloca</span><span class="w"> </span><span class="p">[</span><span class="m">3</span><span class="w"> </span><span class="k">x</span><span class="w"> </span><span class="kt">i32</span><span class="p">],</span><span class="w"> </span><span class="k">align</span><span class="w"> </span><span class="m">4</span>
<span class="w">  </span><span class="k">store</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="kt">i32</span><span class="p">*</span><span class="w"> </span><span class="nv">%retval</span>
<span class="w">  </span><span class="nv nv-Anonymous">%0</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">bitcast</span><span class="w"> </span><span class="p">[</span><span class="m">3</span><span class="w"> </span><span class="k">x</span><span class="w"> </span><span class="kt">i32</span><span class="p">]*</span><span class="w"> </span><span class="nv">%a</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="kt">i8</span><span class="p">*</span>
<span class="w">  </span><span class="k">call</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="vg">@llvm.memcpy.p0i8.p0i8.i32</span><span class="p">(</span><span class="kt">i8</span><span class="p">*</span><span class="w"> </span><span class="nv nv-Anonymous">%0</span><span class="p">,</span><span class="w"> </span><span class="kt">i8</span><span class="p">*</span><span class="w"> </span><span class="k">bitcast</span><span class="w"> </span><span class="p">([</span><span class="m">3</span><span class="w"> </span><span class="k">x</span><span class="w"> </span><span class="kt">i32</span><span class="p">]*</span>
<span class="w">    </span><span class="vg">@_ZZ4mainE1a</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="kt">i8</span><span class="p">*),</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="m">12</span><span class="p">,</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="m">4</span><span class="p">,</span><span class="w"> </span><span class="kt">i1</span><span class="w"> </span><span class="k">false</span><span class="p">)</span>
<span class="w">  </span><span class="k">ret</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="m">0</span>
<span class="p">}</span>
<span class="c">; Function Attrs: nounwind</span>
<span class="k">declare</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="vg">@llvm.memcpy.p0i8.p0i8.i32</span><span class="p">(</span><span class="kt">i8</span><span class="p">*</span><span class="w"> </span><span class="k">nocapture</span><span class="p">,</span><span class="w"> </span><span class="kt">i8</span><span class="p">*</span><span class="w"> </span><span class="k">nocapture</span><span class="p">,</span><span class="w"> </span><span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="kt">i1</span><span class="p">)</span><span class="w"> </span><span class="vg">#1</span>
</pre></div>
</div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">118-165-79-206:input Jonathan$ </span>~/llvm/test/build/
<span class="go">bin/llc -march=cpu0 -relocation-model=pic -filetype=asm ch7_1_localarrayinit.bc -o -</span>
<span class="go">        ...</span>
<span class="gp"># </span>BB#0:<span class="w">                                 </span><span class="c1"># %entry</span>
<span class="go">        addiu $sp, $sp, -16</span>
<span class="go">        addiu $2, $zero, 0</span>
<span class="go">        st    $2, 12($fp)</span>
<span class="go">        ld    $2, %got($_ZZ4mainE1a)($gp)</span>
<span class="go">        ori   $2, $2, %lo($_ZZ4mainE1a)</span>
<span class="go">        ld    $3, 8($2)</span>
<span class="go">        st    $3, 8($fp)</span>
<span class="go">        ld    $3, 4($2)</span>
<span class="go">        st    $3, 4($fp)</span>
<span class="go">        ld    $2, 0($2)</span>
<span class="go">        st    $2, 0($fp)</span>
<span class="go">        addiu $sp, $sp, 16</span>
<span class="go">        ret   $lr</span>
<span class="go">        ...</span>
<span class="go">        .type $_ZZ4mainE1a,@object    # @_ZZ4mainE1a</span>
<span class="go">        .section      .rodata,&quot;a&quot;,@progbits</span>
<span class="go">        .align        2</span>
<span class="gp">$</span>_ZZ4mainE1a:
<span class="go">        .4byte        0                       # 0x0</span>
<span class="go">        .4byte        1                       # 0x1</span>
<span class="go">        .4byte        2                       # 0x2</span>
<span class="go">        .size $_ZZ4mainE1a, 12</span>
</pre></div>
</div>
</section>
<section id="vector-type-simd-support">
<h2><a class="toc-backref" href="#id13" role="doc-backlink">Vector type (SIMD) support</a><a class="headerlink" href="#vector-type-simd-support" title="Link to this heading">¶</a></h2>
<p>Vector types are used when multiple primitive data are operated in parallel
using a single instruction (SIMD) <a class="footnote-reference brackets" href="#vector" id="id3" role="doc-noteref"><span class="fn-bracket">[</span>3<span class="fn-bracket">]</span></a>. Mips supports the
following llvm IRs “icmp slt” and “sext” for vector type, Cpu0 supports them
either.</p>
<p>Vector types enable multiple primitive data operations in parallel
using a single instruction (SIMD) <a class="footnote-reference brackets" href="#vector" id="id4" role="doc-noteref"><span class="fn-bracket">[</span>3<span class="fn-bracket">]</span></a>.
MIPS supports <strong>icmp slt</strong> and <strong>sext</strong> LLVM IRs for vector types, which Cpu0
also supports.</p>
<p class="rubric">lbdex/input/ch7_1_vector.cpp</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>
<span class="n">typedef</span> <span class="n">long</span>   <span class="n">vector8long</span>   <span class="n">__attribute__</span><span class="p">((</span><span class="n">__vector_size__</span><span class="p">(</span><span class="mi">32</span><span class="p">)));</span>
<span class="n">typedef</span> <span class="n">long</span>   <span class="n">vector8short</span>   <span class="n">__attribute__</span><span class="p">((</span><span class="n">__vector_size__</span><span class="p">(</span><span class="mi">16</span><span class="p">)));</span>


<span class="nb">int</span> <span class="n">test_cmplt_short</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">volatile</span> <span class="n">vector8short</span> <span class="n">a0</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">};</span>
  <span class="n">volatile</span> <span class="n">vector8short</span> <span class="n">b0</span> <span class="o">=</span> <span class="p">{</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">};</span>
  <span class="n">volatile</span> <span class="n">vector8short</span> <span class="n">c0</span><span class="p">;</span>
  <span class="n">c0</span> <span class="o">=</span> <span class="n">a0</span> <span class="o">&lt;</span> <span class="n">b0</span><span class="p">;</span> <span class="o">//</span> <span class="n">c0</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="p">(</span><span class="n">since</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="ow">is</span> <span class="n">true</span><span class="p">),</span> <span class="n">c0</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">c0</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">(</span><span class="n">since</span> <span class="mi">2</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="ow">is</span> <span class="n">false</span><span class="p">),</span> <span class="n">c0</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
  
  <span class="k">return</span> <span class="p">(</span><span class="nb">int</span><span class="p">)(</span><span class="n">c0</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">c0</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">c0</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="n">c0</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span> <span class="o">//</span> <span class="o">-</span><span class="mi">3</span>
<span class="p">}</span>


<span class="nb">int</span> <span class="n">test_cmplt_long</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">volatile</span> <span class="n">vector8long</span> <span class="n">a0</span> <span class="o">=</span> <span class="p">{</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">};</span>
  <span class="n">volatile</span> <span class="n">vector8long</span> <span class="n">b0</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">};</span>
  <span class="n">volatile</span> <span class="n">vector8long</span> <span class="n">c0</span><span class="p">;</span>
  <span class="n">c0</span> <span class="o">=</span> <span class="n">a0</span> <span class="o">&lt;</span> <span class="n">b0</span><span class="p">;</span> <span class="o">//</span> <span class="n">c0</span><span class="p">[</span><span class="mf">0..3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">...</span><span class="p">},</span> <span class="n">c0</span><span class="p">[</span><span class="mf">4..7</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">...</span><span class="p">}</span>
  
  <span class="k">return</span> <span class="p">(</span><span class="n">c0</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">c0</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">c0</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="n">c0</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">+</span><span class="n">c0</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">+</span><span class="n">c0</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">+</span><span class="n">c0</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">+</span><span class="n">c0</span><span class="p">[</span><span class="mi">7</span><span class="p">]);</span> <span class="o">//-</span><span class="mi">4</span>
<span class="p">}</span>

</pre></div>
</div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">118-165-79-206:input Jonathan$ </span>clang<span class="w"> </span>-target<span class="w"> </span>mips-unknown-linux-gnu<span class="w"> </span>-c
<span class="go">ch7_1_vector.cpp -emit-llvm -o ch7_1_vector.bc</span>
<span class="gp">118-165-79-206:input Jonathan$ </span>~/llvm/test/build/bin/
<span class="go">llvm-dis ch7_1_vector.bc -o -</span>
<span class="go">...</span>
</pre></div>
</div>
<div class="highlight-llvm notranslate"><div class="highlight"><pre><span></span><span class="c">; Function Attrs: nounwind</span>
<span class="k">define</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="vg">@_Z16test_cmplt_shortv</span><span class="p">()</span><span class="w"> </span><span class="vg">#0</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nv">%a0</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">alloca</span><span class="w"> </span><span class="p">&lt;</span><span class="m">4</span><span class="w"> </span><span class="k">x</span><span class="w"> </span><span class="kt">i32</span><span class="p">&gt;,</span><span class="w"> </span><span class="k">align</span><span class="w"> </span><span class="m">16</span>
<span class="w">  </span><span class="nv">%b0</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">alloca</span><span class="w"> </span><span class="p">&lt;</span><span class="m">4</span><span class="w"> </span><span class="k">x</span><span class="w"> </span><span class="kt">i32</span><span class="p">&gt;,</span><span class="w"> </span><span class="k">align</span><span class="w"> </span><span class="m">16</span>
<span class="w">  </span><span class="nv">%c0</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">alloca</span><span class="w"> </span><span class="p">&lt;</span><span class="m">4</span><span class="w"> </span><span class="k">x</span><span class="w"> </span><span class="kt">i32</span><span class="p">&gt;,</span><span class="w"> </span><span class="k">align</span><span class="w"> </span><span class="m">16</span>
<span class="w">  </span><span class="k">store</span><span class="w"> </span><span class="k">volatile</span><span class="w"> </span><span class="p">&lt;</span><span class="m">4</span><span class="w"> </span><span class="k">x</span><span class="w"> </span><span class="kt">i32</span><span class="p">&gt;</span><span class="w"> </span><span class="p">&lt;</span><span class="kt">i32</span><span class="w"> </span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="m">3</span><span class="p">&gt;,</span><span class="w"> </span><span class="p">&lt;</span><span class="m">4</span><span class="w"> </span><span class="k">x</span><span class="w"> </span><span class="kt">i32</span><span class="p">&gt;*</span><span class="w"> </span><span class="nv">%a0</span><span class="p">,</span><span class="w"> </span><span class="k">align</span><span class="w"> </span><span class="m">16</span>
<span class="w">  </span><span class="k">store</span><span class="w"> </span><span class="k">volatile</span><span class="w"> </span><span class="p">&lt;</span><span class="m">4</span><span class="w"> </span><span class="k">x</span><span class="w"> </span><span class="kt">i32</span><span class="p">&gt;</span><span class="w"> </span><span class="p">&lt;</span><span class="kt">i32</span><span class="w"> </span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="m">2</span><span class="p">&gt;,</span><span class="w"> </span><span class="p">&lt;</span><span class="m">4</span><span class="w"> </span><span class="k">x</span><span class="w"> </span><span class="kt">i32</span><span class="p">&gt;*</span><span class="w"> </span><span class="nv">%b0</span><span class="p">,</span><span class="w"> </span><span class="k">align</span><span class="w"> </span><span class="m">16</span>
<span class="w">  </span><span class="nv nv-Anonymous">%1</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">load</span><span class="w"> </span><span class="k">volatile</span><span class="w"> </span><span class="p">&lt;</span><span class="m">4</span><span class="w"> </span><span class="k">x</span><span class="w"> </span><span class="kt">i32</span><span class="p">&gt;,</span><span class="w"> </span><span class="p">&lt;</span><span class="m">4</span><span class="w"> </span><span class="k">x</span><span class="w"> </span><span class="kt">i32</span><span class="p">&gt;*</span><span class="w"> </span><span class="nv">%a0</span><span class="p">,</span><span class="w"> </span><span class="k">align</span><span class="w"> </span><span class="m">16</span>
<span class="w">  </span><span class="nv nv-Anonymous">%2</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">load</span><span class="w"> </span><span class="k">volatile</span><span class="w"> </span><span class="p">&lt;</span><span class="m">4</span><span class="w"> </span><span class="k">x</span><span class="w"> </span><span class="kt">i32</span><span class="p">&gt;,</span><span class="w"> </span><span class="p">&lt;</span><span class="m">4</span><span class="w"> </span><span class="k">x</span><span class="w"> </span><span class="kt">i32</span><span class="p">&gt;*</span><span class="w"> </span><span class="nv">%b0</span><span class="p">,</span><span class="w"> </span><span class="k">align</span><span class="w"> </span><span class="m">16</span>
<span class="w">  </span><span class="nv nv-Anonymous">%3</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">icmp</span><span class="w"> </span><span class="k">slt</span><span class="w"> </span><span class="p">&lt;</span><span class="m">4</span><span class="w"> </span><span class="k">x</span><span class="w"> </span><span class="kt">i32</span><span class="p">&gt;</span><span class="w"> </span><span class="nv nv-Anonymous">%1</span><span class="p">,</span><span class="w"> </span><span class="nv nv-Anonymous">%2</span>
<span class="w">  </span><span class="nv nv-Anonymous">%4</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">sext</span><span class="w"> </span><span class="p">&lt;</span><span class="m">4</span><span class="w"> </span><span class="k">x</span><span class="w"> </span><span class="kt">i1</span><span class="p">&gt;</span><span class="w"> </span><span class="nv nv-Anonymous">%3</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="p">&lt;</span><span class="m">4</span><span class="w"> </span><span class="k">x</span><span class="w"> </span><span class="kt">i32</span><span class="p">&gt;</span>
<span class="w">  </span><span class="k">store</span><span class="w"> </span><span class="k">volatile</span><span class="w"> </span><span class="p">&lt;</span><span class="m">4</span><span class="w"> </span><span class="k">x</span><span class="w"> </span><span class="kt">i32</span><span class="p">&gt;</span><span class="w"> </span><span class="nv nv-Anonymous">%4</span><span class="p">,</span><span class="w"> </span><span class="p">&lt;</span><span class="m">4</span><span class="w"> </span><span class="k">x</span><span class="w"> </span><span class="kt">i32</span><span class="p">&gt;*</span><span class="w"> </span><span class="nv">%c0</span><span class="p">,</span><span class="w"> </span><span class="k">align</span><span class="w"> </span><span class="m">16</span>
<span class="w">  </span><span class="nv nv-Anonymous">%5</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">load</span><span class="w"> </span><span class="k">volatile</span><span class="w"> </span><span class="p">&lt;</span><span class="m">4</span><span class="w"> </span><span class="k">x</span><span class="w"> </span><span class="kt">i32</span><span class="p">&gt;,</span><span class="w"> </span><span class="p">&lt;</span><span class="m">4</span><span class="w"> </span><span class="k">x</span><span class="w"> </span><span class="kt">i32</span><span class="p">&gt;*</span><span class="w"> </span><span class="nv">%c0</span><span class="p">,</span><span class="w"> </span><span class="k">align</span><span class="w"> </span><span class="m">16</span>
<span class="w">  </span><span class="nv nv-Anonymous">%6</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">extractelement</span><span class="w"> </span><span class="p">&lt;</span><span class="m">4</span><span class="w"> </span><span class="k">x</span><span class="w"> </span><span class="kt">i32</span><span class="p">&gt;</span><span class="w"> </span><span class="nv nv-Anonymous">%5</span><span class="p">,</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="m">0</span>
<span class="w">  </span><span class="nv nv-Anonymous">%7</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">load</span><span class="w"> </span><span class="k">volatile</span><span class="w"> </span><span class="p">&lt;</span><span class="m">4</span><span class="w"> </span><span class="k">x</span><span class="w"> </span><span class="kt">i32</span><span class="p">&gt;,</span><span class="w"> </span><span class="p">&lt;</span><span class="m">4</span><span class="w"> </span><span class="k">x</span><span class="w"> </span><span class="kt">i32</span><span class="p">&gt;*</span><span class="w"> </span><span class="nv">%c0</span><span class="p">,</span><span class="w"> </span><span class="k">align</span><span class="w"> </span><span class="m">16</span>
<span class="w">  </span><span class="nv nv-Anonymous">%8</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">extractelement</span><span class="w"> </span><span class="p">&lt;</span><span class="m">4</span><span class="w"> </span><span class="k">x</span><span class="w"> </span><span class="kt">i32</span><span class="p">&gt;</span><span class="w"> </span><span class="nv nv-Anonymous">%7</span><span class="p">,</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="m">1</span>
<span class="w">  </span><span class="nv nv-Anonymous">%9</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">add</span><span class="w"> </span><span class="k">nsw</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="nv nv-Anonymous">%6</span><span class="p">,</span><span class="w"> </span><span class="nv nv-Anonymous">%8</span>
<span class="w">  </span><span class="nv nv-Anonymous">%10</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">load</span><span class="w"> </span><span class="k">volatile</span><span class="w"> </span><span class="p">&lt;</span><span class="m">4</span><span class="w"> </span><span class="k">x</span><span class="w"> </span><span class="kt">i32</span><span class="p">&gt;,</span><span class="w"> </span><span class="p">&lt;</span><span class="m">4</span><span class="w"> </span><span class="k">x</span><span class="w"> </span><span class="kt">i32</span><span class="p">&gt;*</span><span class="w"> </span><span class="nv">%c0</span><span class="p">,</span><span class="w"> </span><span class="k">align</span><span class="w"> </span><span class="m">16</span>
<span class="w">  </span><span class="nv nv-Anonymous">%11</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">extractelement</span><span class="w"> </span><span class="p">&lt;</span><span class="m">4</span><span class="w"> </span><span class="k">x</span><span class="w"> </span><span class="kt">i32</span><span class="p">&gt;</span><span class="w"> </span><span class="nv nv-Anonymous">%10</span><span class="p">,</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="m">2</span>
<span class="w">  </span><span class="nv nv-Anonymous">%12</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">add</span><span class="w"> </span><span class="k">nsw</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="nv nv-Anonymous">%9</span><span class="p">,</span><span class="w"> </span><span class="nv nv-Anonymous">%11</span>
<span class="w">  </span><span class="nv nv-Anonymous">%13</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">load</span><span class="w"> </span><span class="k">volatile</span><span class="w"> </span><span class="p">&lt;</span><span class="m">4</span><span class="w"> </span><span class="k">x</span><span class="w"> </span><span class="kt">i32</span><span class="p">&gt;,</span><span class="w"> </span><span class="p">&lt;</span><span class="m">4</span><span class="w"> </span><span class="k">x</span><span class="w"> </span><span class="kt">i32</span><span class="p">&gt;*</span><span class="w"> </span><span class="nv">%c0</span><span class="p">,</span><span class="w"> </span><span class="k">align</span><span class="w"> </span><span class="m">16</span>
<span class="w">  </span><span class="nv nv-Anonymous">%14</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">extractelement</span><span class="w"> </span><span class="p">&lt;</span><span class="m">4</span><span class="w"> </span><span class="k">x</span><span class="w"> </span><span class="kt">i32</span><span class="p">&gt;</span><span class="w"> </span><span class="nv nv-Anonymous">%13</span><span class="p">,</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="m">3</span>
<span class="w">  </span><span class="nv nv-Anonymous">%15</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">add</span><span class="w"> </span><span class="k">nsw</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="nv nv-Anonymous">%12</span><span class="p">,</span><span class="w"> </span><span class="nv nv-Anonymous">%14</span>
<span class="w">  </span><span class="k">ret</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="nv nv-Anonymous">%15</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">118-165-79-206:input Jonathan$ </span>~/llvm/test/build/bin/llc
<span class="go">  -march=cpu0 -mcpu=cpu032II -relocation-model=pic -filetype=asm ch7_1_vector.bc</span>
<span class="go">  -o -</span>
<span class="go">  .text</span>
<span class="go">  .section .mdebug.abiO32</span>
<span class="go">  .previous</span>
<span class="go">  .file &quot;ch7_1_vector.bc&quot;</span>
<span class="go">  .globl  _Z16test_cmplt_shortv</span>
<span class="go">  .p2align  2</span>
<span class="go">  .type _Z16test_cmplt_shortv,@function</span>
<span class="go">  .ent  _Z16test_cmplt_shortv   # @_Z16test_cmplt_shortv</span>
<span class="go">_Z16test_cmplt_shortv:</span>
<span class="go">  .frame  $fp,48,$lr</span>
<span class="go">  .mask   0x00000000,0</span>
<span class="go">  .set  noreorder</span>
<span class="go">  .set  nomacro</span>
<span class="gp"># </span>BB#0:
<span class="go">  addiu $sp, $sp, -48</span>
<span class="go">  addiu $2, $zero, 3</span>
<span class="go">  st  $2, 44($sp)</span>
<span class="go">  addiu $2, $zero, 1</span>
<span class="go">  st  $2, 36($sp)</span>
<span class="go">  addiu $2, $zero, 0</span>
<span class="go">  st  $2, 32($sp)</span>
<span class="go">  addiu $2, $zero, 2</span>
<span class="go">  st  $2, 40($sp)</span>
<span class="go">  st  $2, 28($sp)</span>
<span class="go">  st  $2, 24($sp)</span>
<span class="go">  st  $2, 20($sp)</span>
<span class="go">  st  $2, 16($sp)</span>
<span class="go">  ld  $2, 32($sp)</span>
<span class="go">  ld  $3, 44($sp)</span>
<span class="go">  ld  $4, 40($sp)</span>
<span class="go">  ld  $5, 36($sp)</span>
<span class="go">  ld  $t9, 20($sp)</span>
<span class="go">  slt $5, $5, $t9</span>
<span class="go">  ld  $t9, 24($sp)</span>
<span class="go">  slt $4, $4, $t9</span>
<span class="go">  ld  $t9, 28($sp)</span>
<span class="go">  slt $3, $3, $t9</span>
<span class="go">  shl $3, $3, 31</span>
<span class="go">  sra $3, $3, 31</span>
<span class="go">  ld  $t9, 16($sp)</span>
<span class="go">  st  $3, 12($sp)</span>
<span class="go">  shl $3, $4, 31</span>
<span class="go">  sra $3, $3, 31</span>
<span class="go">  st  $3, 8($sp)</span>
<span class="go">  shl $3, $5, 31</span>
<span class="go">  sra $3, $3, 31</span>
<span class="go">  st  $3, 4($sp)</span>
<span class="go">  slt $2, $2, $t9</span>
<span class="go">  shl $2, $2, 31</span>
<span class="go">  sra $2, $2, 31</span>
<span class="go">  st  $2, 0($sp)</span>
<span class="go">  ld  $2, 12($sp)</span>
<span class="go">  ld  $2, 8($sp)</span>
<span class="go">  ld  $2, 4($sp)</span>
<span class="go">  ld  $2, 0($sp)</span>
<span class="go">  ld  $3, 4($sp)</span>
<span class="go">  addu  $2, $2, $3</span>
<span class="go">  ld  $3, 12($sp)</span>
<span class="go">  ld  $3, 8($sp)</span>
<span class="go">  ld  $3, 0($sp)</span>
<span class="go">  ld  $3, 8($sp)</span>
<span class="go">  addu  $2, $2, $3</span>
<span class="go">  ld  $3, 12($sp)</span>
<span class="go">  ld  $3, 4($sp)</span>
<span class="go">  ld  $3, 0($sp)</span>
<span class="go">  ld  $3, 12($sp)</span>
<span class="go">  addu  $2, $2, $3</span>
<span class="go">  ld  $3, 8($sp)</span>
<span class="go">  ld  $3, 4($sp)</span>
<span class="go">  ld  $3, 0($sp)</span>
<span class="go">  addiu $sp, $sp, 48</span>
<span class="go">  ret $lr</span>
<span class="go">  .set  macro</span>
<span class="go">  .set  reorder</span>
<span class="go">  .end  _Z16test_cmplt_shortv</span>
<span class="gp">$</span>func_end0:
<span class="go">  .size _Z16test_cmplt_shortv, ($func_end0)-_Z16test_cmplt_shortv</span>


<span class="go">  .ident  &quot;Apple LLVM version 7.0.0 (clang-700.1.76)&quot;</span>
<span class="go">  .section  &quot;.note.GNU-stack&quot;,&quot;&quot;,@progbits</span>
</pre></div>
</div>
<p>Since test_longlong_shift2() in ch7_1_vector.cpp requires storeRegToStack()
in Cpu0SEInstInfo.cpp, it cannot be verified at this point.</p>
<p class="rubric">lbdex/chapters/Chapter7_1/Cpu0ISelLowering.h</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>    <span class="o">///</span> <span class="n">getSetCCResultType</span> <span class="o">-</span> <span class="n">get</span> <span class="n">the</span> <span class="n">ISD</span><span class="p">::</span><span class="n">SETCC</span> <span class="n">result</span> <span class="n">ValueType</span>
    <span class="n">EVT</span> <span class="n">getSetCCResultType</span><span class="p">(</span><span class="n">const</span> <span class="n">DataLayout</span> <span class="o">&amp;</span><span class="n">DL</span><span class="p">,</span> <span class="n">LLVMContext</span> <span class="o">&amp;</span><span class="n">Context</span><span class="p">,</span>
                           <span class="n">EVT</span> <span class="n">VT</span><span class="p">)</span> <span class="n">const</span> <span class="n">override</span><span class="p">;</span>
</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter7_1/Cpu0ISelLowering.cpp</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>EVT Cpu0TargetLowering::getSetCCResultType(const DataLayout &amp;, LLVMContext &amp;,
                                           EVT VT) const {
  if (!VT.isVector())
    return MVT::i32;
  return VT.changeVectorElementTypeToInteger();
}
</pre></div>
</div>
<aside class="footnote-list brackets">
<aside class="footnote brackets" id="id5" role="doc-footnote">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id2">1</a><span class="fn-bracket">]</span></span>
<p><a class="reference external" href="http://llvm.org/docs/LangRef.html#getelementptr-instruction">http://llvm.org/docs/LangRef.html#getelementptr-instruction</a></p>
</aside>
<aside class="footnote brackets" id="lbt-compiler-rt" role="doc-footnote">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id1">2</a><span class="fn-bracket">]</span></span>
<p><a class="reference external" href="http://jonathan2251.github.io/lbt/lib.html#compiler-rt">http://jonathan2251.github.io/lbt/lib.html#compiler-rt</a></p>
</aside>
<aside class="footnote brackets" id="vector" role="doc-footnote">
<span class="label"><span class="fn-bracket">[</span>3<span class="fn-bracket">]</span></span>
<span class="backrefs">(<a role="doc-backlink" href="#id3">1</a>,<a role="doc-backlink" href="#id4">2</a>)</span>
<p><a class="reference external" href="http://llvm.org/docs/LangRef.html#vector-type">http://llvm.org/docs/LangRef.html#vector-type</a></p>
</aside>
</aside>
</section>
</section>


      </div>
      <div class="bottomnav" role="navigation" aria-label="Bottom">
      
        <p>
        «&#160;&#160;<a href="globalvar.html">Global Variables</a>
        &#160;&#160;::&#160;&#160;
        <a class="uplink" href="index.html">Contents</a>
        &#160;&#160;::&#160;&#160;
        <a href="ctrlflow.html">Control flow statements</a>&#160;&#160;»
        </p>

      </div>

    <div class="footer" role="contentinfo">
    &#169; Copyright 2016, Chen Chung-Shu.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 9.1.0.
    </div>
  </body>
</html>