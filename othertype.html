<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Other data type &mdash; Tutorial: Creating an LLVM Backend for the Cpu0 Architecture</title>
    
    <link rel="stylesheet" href="_static/haiku.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '3.9.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="author" title="About these documents" href="about.html" />
    <link rel="top" title="Tutorial: Creating an LLVM Backend for the Cpu0 Architecture" href="index.html" />
    <link rel="next" title="Control flow statements" href="ctrlflow.html" />
    <link rel="prev" title="Global variables" href="globalvar.html" /> 
  </head>
  <body role="document">
      <div class="header" role="banner"><h1 class="heading"><a href="index.html">
          <span>Tutorial: Creating an LLVM Backend for the Cpu0 Architecture</span></a></h1>
        <h2 class="heading"><span>Other data type</span></h2>
      </div>
      <div class="topnav" role="navigation" aria-label="top navigation">
      
        <p>
        «&#160;&#160;<a href="globalvar.html">Global variables</a>
        &#160;&#160;::&#160;&#160;
        <a class="uplink" href="index.html">Contents</a>
        &#160;&#160;::&#160;&#160;
        <a href="ctrlflow.html">Control flow statements</a>&#160;&#160;»
        </p>

      </div>
      <div class="content">
        
        
  <div class="section" id="other-data-type">
<span id="sec-othertypesupport"></span><h1>Other data type<a class="headerlink" href="#other-data-type" title="Permalink to this headline">¶</a></h1>
<div class="contents local topic" id="contents">
<ul class="simple">
<li><a class="reference internal" href="#local-variable-pointer" id="id7">Local variable pointer</a></li>
<li><a class="reference internal" href="#char-short-int-and-bool" id="id8">char, short int and bool</a></li>
<li><a class="reference internal" href="#long-long" id="id9">long long</a></li>
<li><a class="reference internal" href="#float-and-double" id="id10">float and double</a></li>
<li><a class="reference internal" href="#array-and-struct-support" id="id11">Array and struct support</a></li>
<li><a class="reference internal" href="#vector-type-simd-support" id="id12">Vector type (SIMD) support</a></li>
</ul>
</div>
<p>Until now, we only handle both int and long type of 32 bits size.
This chapter introduce other types, such as pointer and those
are not 32-bit size which inlcude bool, char, short int and long long.</p>
<div class="section" id="local-variable-pointer">
<h2><a class="toc-backref" href="#id7">Local variable pointer</a><a class="headerlink" href="#local-variable-pointer" title="Permalink to this headline">¶</a></h2>
<p>To support pointer to local variable, add this code fragment in
Cpu0InstrInfo.td and Cpu0InstPrinter.cpp as follows,</p>
<p class="rubric">lbdex/chapters/Chapter7_1/Cpu0InstrInfo.td</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">mem_ea</span> <span class="p">:</span> <span class="n">Operand</span><span class="o">&lt;</span><span class="n">iPTR</span><span class="o">&gt;</span> <span class="p">{</span>
  <span class="n">let</span> <span class="n">PrintMethod</span> <span class="o">=</span> <span class="s2">&quot;printMemOperandEA&quot;</span><span class="p">;</span>
  <span class="n">let</span> <span class="n">MIOperandInfo</span> <span class="o">=</span> <span class="p">(</span><span class="n">ops</span> <span class="n">CPURegs</span><span class="p">,</span> <span class="n">simm16</span><span class="p">);</span>
  <span class="n">let</span> <span class="n">EncoderMethod</span> <span class="o">=</span> <span class="s2">&quot;getMemEncoding&quot;</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span>class EffectiveAddress&lt;string instr_asm, RegisterClass RC, Operand Mem&gt; :
  FMem&lt;0x09, (outs RC:$ra), (ins Mem:$addr),
     instr_asm, [(set RC:$ra, addr:$addr)], IIAlu&gt;;
}
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">//</span> <span class="n">FrameIndexes</span> <span class="n">are</span> <span class="n">legalized</span> <span class="n">when</span> <span class="n">they</span> <span class="n">are</span> <span class="n">operands</span> <span class="kn">from</span> <span class="nn">load</span><span class="o">/</span><span class="n">store</span>
<span class="o">//</span> <span class="n">instructions</span><span class="o">.</span> <span class="n">The</span> <span class="n">same</span> <span class="ow">not</span> <span class="n">happens</span> <span class="k">for</span> <span class="n">stack</span> <span class="n">address</span> <span class="n">copies</span><span class="p">,</span> <span class="n">so</span> <span class="n">an</span>
<span class="o">//</span> <span class="n">add</span> <span class="n">op</span> <span class="k">with</span> <span class="n">mem</span> <span class="n">ComplexPattern</span> <span class="ow">is</span> <span class="n">used</span> <span class="ow">and</span> <span class="n">the</span> <span class="n">stack</span> <span class="n">address</span> <span class="n">copy</span>
<span class="o">//</span> <span class="n">can</span> <span class="n">be</span> <span class="n">matched</span><span class="o">.</span> <span class="n">It</span><span class="s1">&#39;s similar to Sparc LEA_ADDRi</span>
<span class="k">def</span> <span class="nf">LEA_ADDiu</span> <span class="p">:</span> <span class="n">EffectiveAddress</span><span class="o">&lt;</span><span class="s2">&quot;addiu</span><span class="se">\t</span><span class="s2">$ra, $addr&quot;</span><span class="p">,</span> <span class="n">CPURegs</span><span class="p">,</span> <span class="n">mem_ea</span><span class="o">&gt;</span> <span class="p">{</span>
  <span class="n">let</span> <span class="n">isCodeGenOnly</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter3_2/InstPrinter/Cpu0InstPrinter.h</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>  <span class="n">void</span> <span class="n">printMemOperandEA</span><span class="p">(</span><span class="n">const</span> <span class="n">MCInst</span> <span class="o">*</span><span class="n">MI</span><span class="p">,</span> <span class="nb">int</span> <span class="n">opNum</span><span class="p">,</span> <span class="n">raw_ostream</span> <span class="o">&amp;</span><span class="n">O</span><span class="p">);</span>
</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter3_2/InstPrinter/Cpu0InstPrinter.cpp</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">//</span> <span class="n">The</span> <span class="n">DAG</span> <span class="n">data</span> <span class="n">node</span><span class="p">,</span> <span class="n">mem_ea</span> <span class="n">of</span> <span class="n">Cpu0InstrInfo</span><span class="o">.</span><span class="n">td</span><span class="p">,</span> <span class="n">cannot</span> <span class="n">be</span> <span class="n">disabled</span> <span class="n">by</span>
<span class="o">//</span> <span class="n">ch7_1</span><span class="p">,</span> <span class="n">only</span> <span class="n">opcode</span> <span class="n">node</span> <span class="n">can</span> <span class="n">be</span> <span class="n">disabled</span><span class="o">.</span>
<span class="n">void</span> <span class="n">Cpu0InstPrinter</span><span class="p">::</span>
<span class="n">printMemOperandEA</span><span class="p">(</span><span class="n">const</span> <span class="n">MCInst</span> <span class="o">*</span><span class="n">MI</span><span class="p">,</span> <span class="nb">int</span> <span class="n">opNum</span><span class="p">,</span> <span class="n">raw_ostream</span> <span class="o">&amp;</span><span class="n">O</span><span class="p">)</span> <span class="p">{</span>
  <span class="o">//</span> <span class="n">when</span> <span class="n">using</span> <span class="n">stack</span> <span class="n">locations</span> <span class="k">for</span> <span class="ow">not</span> <span class="n">load</span><span class="o">/</span><span class="n">store</span> <span class="n">instructions</span>
  <span class="o">//</span> <span class="nb">print</span> <span class="n">the</span> <span class="n">same</span> <span class="n">way</span> <span class="k">as</span> <span class="nb">all</span> <span class="n">normal</span> <span class="mi">3</span> <span class="n">operand</span> <span class="n">instructions</span><span class="o">.</span>
  <span class="n">printOperand</span><span class="p">(</span><span class="n">MI</span><span class="p">,</span> <span class="n">opNum</span><span class="p">,</span> <span class="n">O</span><span class="p">);</span>
  <span class="n">O</span> <span class="o">&lt;&lt;</span> <span class="s2">&quot;, &quot;</span><span class="p">;</span>
  <span class="n">printOperand</span><span class="p">(</span><span class="n">MI</span><span class="p">,</span> <span class="n">opNum</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">O</span><span class="p">);</span>
  <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>As comment in Cpu0InstPrinter.cpp, the printMemOperandEA is added at early
chapter 3_2 since the DAG data node, mem_ea of Cpu0InstrInfo.td, cannot be
disabled by ch7_1_localpointer, only opcode node can be disabled.
Run ch7_1_localpointer.cpp with code Chapter7_1/ which support pointer to local
variable, will get result as follows,</p>
<p class="rubric">lbdex/input/ch7_1_localpointer.cpp</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="nb">int</span> <span class="n">test_local_pointer</span><span class="p">()</span>
<span class="p">{</span>
  <span class="nb">int</span> <span class="n">b</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
  
  <span class="nb">int</span><span class="o">*</span> <span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">b</span><span class="p">;</span>

  <span class="k">return</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">118-165-66-82:input Jonathan$</span> clang -target mips-unknown-linux-gnu -c
<span class="go">ch7_1_localpointer.cpp -emit-llvm -o ch7_1_localpointer.bc</span>
<span class="gp">118-165-66-82:input Jonathan$</span> llvm-dis ch7_1_localpointer.bc -o -
<span class="go">...</span>
<span class="go">; Function Attrs: nounwind</span>
<span class="go">define i32 @_Z18test_local_pointerv() #0 {</span>
<span class="gp">  %</span><span class="nv">b</span> <span class="o">=</span> alloca i32, align 4
<span class="gp">  %</span><span class="nv">p</span> <span class="o">=</span> alloca i32*, align 4
<span class="go">  store i32 3, i32* %b, align 4</span>
<span class="go">  store i32* %b, i32** %p, align 4</span>
<span class="gp">  %</span><span class="nv">1</span> <span class="o">=</span> load i32** %p, align 4
<span class="gp">  %</span><span class="nv">2</span> <span class="o">=</span> load i32* %1, align 4
<span class="go">  ret i32 %2</span>
<span class="go">}</span>
<span class="go">...</span>

<span class="gp">118-165-66-82:input Jonathan$</span> /Users/Jonathan/llvm/test/cmake_
<span class="go">debug_build/Debug/bin/llc -march=cpu0 -relocation-model=pic -filetype=asm</span>
<span class="go">ch7_1_localpointer.bc -o -</span>
<span class="go">  ...</span>
<span class="go">        addiu $sp, $sp, -8</span>
<span class="go">        addiu $2, $zero, 3</span>
<span class="go">        st    $2, 4($fp)</span>
<span class="go">        addiu $2, $fp, 4     // b address is 4($sp)</span>
<span class="go">        st    $2, 0($fp)</span>
<span class="go">        ld    $2, 4($fp)</span>
<span class="go">        addiu $sp, $sp, 8</span>
<span class="go">        ret   $lr</span>
<span class="go">  ...</span>
</pre></div>
</div>
</div>
<div class="section" id="char-short-int-and-bool">
<h2><a class="toc-backref" href="#id8">char, short int and bool</a><a class="headerlink" href="#char-short-int-and-bool" title="Permalink to this headline">¶</a></h2>
<p>To support signed/unsigned type of char and short int, adding the following
code to Chapter7_1/.</p>
<p class="rubric">lbdex/chapters/Chapter7_1/Cpu0InstrInfo.td</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">sextloadi16_a</span>   <span class="p">:</span> <span class="n">AlignedLoad</span><span class="o">&lt;</span><span class="n">sextloadi16</span><span class="o">&gt;</span><span class="p">;</span>
<span class="k">def</span> <span class="nf">zextloadi16_a</span>   <span class="p">:</span> <span class="n">AlignedLoad</span><span class="o">&lt;</span><span class="n">zextloadi16</span><span class="o">&gt;</span><span class="p">;</span>
<span class="k">def</span> <span class="nf">extloadi16_a</span>    <span class="p">:</span> <span class="n">AlignedLoad</span><span class="o">&lt;</span><span class="n">extloadi16</span><span class="o">&gt;</span><span class="p">;</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">truncstorei16_a</span> <span class="p">:</span> <span class="n">AlignedStore</span><span class="o">&lt;</span><span class="n">truncstorei16</span><span class="o">&gt;</span><span class="p">;</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">let</span> <span class="n">Predicates</span> <span class="o">=</span> <span class="p">[</span><span class="n">Ch7_1</span><span class="p">]</span> <span class="ow">in</span> <span class="p">{</span>
<span class="n">defm</span> <span class="n">LB</span>     <span class="p">:</span> <span class="n">LoadM32</span><span class="o">&lt;</span><span class="mh">0x03</span><span class="p">,</span> <span class="s2">&quot;lb&quot;</span><span class="p">,</span>  <span class="n">sextloadi8</span><span class="o">&gt;</span><span class="p">;</span>
<span class="n">defm</span> <span class="n">LBu</span>    <span class="p">:</span> <span class="n">LoadM32</span><span class="o">&lt;</span><span class="mh">0x04</span><span class="p">,</span> <span class="s2">&quot;lbu&quot;</span><span class="p">,</span> <span class="n">zextloadi8</span><span class="o">&gt;</span><span class="p">;</span>
<span class="n">defm</span> <span class="n">SB</span>     <span class="p">:</span> <span class="n">StoreM32</span><span class="o">&lt;</span><span class="mh">0x05</span><span class="p">,</span> <span class="s2">&quot;sb&quot;</span><span class="p">,</span> <span class="n">truncstorei8</span><span class="o">&gt;</span><span class="p">;</span>
<span class="n">defm</span> <span class="n">LH</span>     <span class="p">:</span> <span class="n">LoadM32</span><span class="o">&lt;</span><span class="mh">0x06</span><span class="p">,</span> <span class="s2">&quot;lh&quot;</span><span class="p">,</span>  <span class="n">sextloadi16_a</span><span class="o">&gt;</span><span class="p">;</span>
<span class="n">defm</span> <span class="n">LHu</span>    <span class="p">:</span> <span class="n">LoadM32</span><span class="o">&lt;</span><span class="mh">0x07</span><span class="p">,</span> <span class="s2">&quot;lhu&quot;</span><span class="p">,</span> <span class="n">zextloadi16_a</span><span class="o">&gt;</span><span class="p">;</span>
<span class="n">defm</span> <span class="n">SH</span>     <span class="p">:</span> <span class="n">StoreM32</span><span class="o">&lt;</span><span class="mh">0x08</span><span class="p">,</span> <span class="s2">&quot;sh&quot;</span><span class="p">,</span> <span class="n">truncstorei16_a</span><span class="o">&gt;</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Run Chapter7_1/ with ch7_1_char_in_struct.cpp will get the following result.</p>
<p class="rubric">lbdex/input/ch7_1_char_in_struct.cpp</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">struct</span> <span class="n">Date</span>
<span class="p">{</span>
  <span class="n">short</span> <span class="n">year</span><span class="p">;</span>
  <span class="n">char</span> <span class="n">month</span><span class="p">;</span>
  <span class="n">char</span> <span class="n">day</span><span class="p">;</span>
  <span class="n">char</span> <span class="n">hour</span><span class="p">;</span>
  <span class="n">char</span> <span class="n">minute</span><span class="p">;</span>
  <span class="n">char</span> <span class="n">second</span><span class="p">;</span>
<span class="p">};</span>

<span class="n">unsigned</span> <span class="n">char</span> <span class="n">b</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\0</span><span class="s1">&#39;</span><span class="p">};</span>

<span class="nb">int</span> <span class="n">test_char</span><span class="p">()</span>
<span class="p">{</span>
  <span class="n">unsigned</span> <span class="n">char</span> <span class="n">a</span> <span class="o">=</span> <span class="n">b</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
  <span class="n">char</span> <span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="n">char</span><span class="p">)</span><span class="n">b</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
  <span class="n">Date</span> <span class="n">date1</span> <span class="o">=</span> <span class="p">{</span><span class="mi">2012</span><span class="p">,</span> <span class="p">(</span><span class="n">char</span><span class="p">)</span><span class="mi">11</span><span class="p">,</span> <span class="p">(</span><span class="n">char</span><span class="p">)</span><span class="mi">25</span><span class="p">,</span> <span class="p">(</span><span class="n">char</span><span class="p">)</span><span class="mi">9</span><span class="p">,</span> <span class="p">(</span><span class="n">char</span><span class="p">)</span><span class="mi">40</span><span class="p">,</span> <span class="p">(</span><span class="n">char</span><span class="p">)</span><span class="mi">15</span><span class="p">};</span>
  <span class="n">char</span> <span class="n">m</span> <span class="o">=</span> <span class="n">date1</span><span class="o">.</span><span class="n">month</span><span class="p">;</span>
  <span class="n">char</span> <span class="n">s</span> <span class="o">=</span> <span class="n">date1</span><span class="o">.</span><span class="n">second</span><span class="p">;</span>

  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

</pre></div>
</div>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">118-165-64-245:input Jonathan$</span> /Users/Jonathan/llvm/test/cmake_debug_build/
<span class="go">Debug/bin/llvm-dis ch7_1_char_in_struct.bc -o -</span>
<span class="go">define i32 @_Z9test_charv() #0 {</span>
<span class="gp">  %</span><span class="nv">a</span> <span class="o">=</span> alloca i8, align 1
<span class="gp">  %</span><span class="nv">c</span> <span class="o">=</span> alloca i8, align 1
<span class="gp">  %</span><span class="nv">date1</span> <span class="o">=</span> alloca %struct.Date, align 2
<span class="gp">  %</span><span class="nv">m</span> <span class="o">=</span> alloca i8, align 1
<span class="gp">  %</span><span class="nv">s</span> <span class="o">=</span> alloca i8, align 1
<span class="gp">  %</span><span class="nv">1</span> <span class="o">=</span> load i8* getelementptr inbounds <span class="o">([</span><span class="m">4</span> x i8<span class="o">]</span>* @b, i32 0, i32 1<span class="o">)</span>, align 1
<span class="go">  store i8 %1, i8* %a, align 1</span>
<span class="gp">  %</span><span class="nv">2</span> <span class="o">=</span> load i8* getelementptr inbounds <span class="o">([</span><span class="m">4</span> x i8<span class="o">]</span>* @b, i32 0, i32 1<span class="o">)</span>, align 1
<span class="go">  store i8 %2, i8* %c, align 1</span>
<span class="gp">  %</span><span class="nv">3</span> <span class="o">=</span> bitcast %struct.Date* %date1 to i8*
<span class="go">  call void @llvm.memcpy.p0i8.p0i8.i32(i8* %3, i8* bitcast ({ i16, i8, i8, i8,</span>
<span class="go">  i8, i8, i8 }* @_ZZ9test_charvE5date1 to i8*), i32 8, i32 2, i1 false)</span>
<span class="gp">  %</span><span class="nv">4</span> <span class="o">=</span> getelementptr inbounds %struct.Date* %date1, i32 0, i32 1
<span class="gp">  %</span><span class="nv">5</span> <span class="o">=</span> load i8* %4, align 1
<span class="go">  store i8 %5, i8* %m, align 1</span>
<span class="gp">  %</span><span class="nv">6</span> <span class="o">=</span> getelementptr inbounds %struct.Date* %date1, i32 0, i32 5
<span class="gp">  %</span><span class="nv">7</span> <span class="o">=</span> load i8* %6, align 1
<span class="go">  store i8 %7, i8* %s, align 1</span>
<span class="go">  ret i32 0</span>
<span class="go">}</span>

<span class="gp">118-165-64-245:input Jonathan$</span> clang -target mips-unknown-linux-gnu -c
<span class="go">ch7_1_char_in_struct.cpp -emit-llvm -o ch7_1_char_in_struct.bc</span>
<span class="gp">118-165-64-245:input Jonathan$</span> /Users/Jonathan/llvm/test/cmake_debug_build/
<span class="go">Debug/bin/llc -march=cpu0 -relocation-model=pic -filetype=asm</span>
<span class="go">ch7_1_char_in_struct.bc -o -</span>
<span class="go">  ...</span>
<span class="gp">#</span> BB#0:                                 <span class="c1"># %entry</span>
<span class="go">  addiu $sp, $sp, -24</span>
<span class="go">  lui $2, %got_hi(b)</span>
<span class="go">  addu  $2, $2, $gp</span>
<span class="go">  ld  $2, %got_lo(b)($2)</span>
<span class="go">  lbu $3, 1($2)</span>
<span class="go">  sb  $3, 20($fp)</span>
<span class="go">  lbu $2, 1($2)</span>
<span class="go">  sb  $2, 16($fp)</span>
<span class="go">  ld  $2, %got($_ZZ9test_charvE5date1)($gp)</span>
<span class="go">  addiu $2, $2, %lo($_ZZ9test_charvE5date1)</span>
<span class="go">  lhu $3, 4($2)</span>
<span class="go">  shl $3, $3, 16</span>
<span class="go">  lhu $4, 6($2)</span>
<span class="go">  or  $3, $3, $4</span>
<span class="go">  st  $3, 12($fp) // store hour, minute and second on 12($sp)</span>
<span class="go">  lhu $3, 2($2)</span>
<span class="go">  lhu $2, 0($2)</span>
<span class="go">  shl $2, $2, 16</span>
<span class="go">  or  $2, $2, $3</span>
<span class="go">  st  $2, 8($fp)    // store year, month and day on 8($sp)</span>
<span class="go">  lbu $2, 10($fp)   // m = date1.month;</span>
<span class="go">  sb  $2, 4($fp)</span>
<span class="go">  lbu $2, 14($fp)   // s = date1.second;</span>
<span class="go">  sb  $2, 0($fp)</span>
<span class="go">  addiu $sp, $sp, 24</span>
<span class="go">  ret $lr</span>
<span class="go">  .set  macro</span>
<span class="go">  .set  reorder</span>
<span class="go">  .end  _Z9test_charv</span>
<span class="gp">$</span>tmp1:
<span class="go">  .size _Z9test_charv, ($tmp1)-_Z9test_charv</span>

<span class="go">  .type b,@object               # @b</span>
<span class="go">  .data</span>
<span class="go">  .globl  b</span>
<span class="go">b:</span>
<span class="go">  .asciz   &quot;abc&quot;</span>
<span class="go">  .size b, 4</span>

<span class="go">  .type $_ZZ9test_charvE5date1,@object # @_ZZ9test_charvE5date1</span>
<span class="go">  .section  .rodata.cst8,&quot;aM&quot;,@progbits,8</span>
<span class="go">  .align  1</span>
<span class="gp">$</span>_ZZ9test_charvE5date1:
<span class="go">  .2byte  2012                    # 0x7dc</span>
<span class="go">  .byte 11                      # 0xb</span>
<span class="go">  .byte 25                      # 0x19</span>
<span class="go">  .byte 9                       # 0x9</span>
<span class="go">  .byte 40                      # 0x28</span>
<span class="go">  .byte 15                      # 0xf</span>
<span class="go">  .space  1</span>
<span class="go">  .size $_ZZ9test_charvE5date1, 8</span>
</pre></div>
</div>
<p>Run Chapter7_1/ with ch7_1_char_short.cpp will get the following result.</p>
<p class="rubric">lbdex/input/ch7_1_char_short.cpp</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="nb">int</span> <span class="n">test_signed_char</span><span class="p">()</span>
<span class="p">{</span>
  <span class="n">char</span> <span class="n">a</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span>
  <span class="nb">int</span> <span class="n">i</span> <span class="o">=</span> <span class="p">(</span><span class="n">signed</span> <span class="nb">int</span><span class="p">)</span><span class="n">a</span><span class="p">;</span>
  <span class="n">i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span> <span class="o">//</span> <span class="n">i</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">128</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="mi">126</span>

  <span class="k">return</span> <span class="n">i</span><span class="p">;</span>
<span class="p">}</span>

<span class="nb">int</span> <span class="n">test_unsigned_char</span><span class="p">()</span>
<span class="p">{</span>
  <span class="n">unsigned</span> <span class="n">char</span> <span class="n">c</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span>
  <span class="n">unsigned</span> <span class="nb">int</span> <span class="n">ui</span> <span class="o">=</span> <span class="p">(</span><span class="n">unsigned</span> <span class="nb">int</span><span class="p">)</span><span class="n">c</span><span class="p">;</span>
  <span class="n">ui</span> <span class="o">=</span> <span class="n">ui</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span> <span class="o">//</span> <span class="n">i</span> <span class="o">=</span> <span class="p">(</span><span class="mi">128</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="mi">130</span>

  <span class="k">return</span> <span class="p">(</span><span class="nb">int</span><span class="p">)</span><span class="n">ui</span><span class="p">;</span>
<span class="p">}</span>

<span class="nb">int</span> <span class="n">test_signed_short</span><span class="p">()</span>
<span class="p">{</span>
  <span class="n">short</span> <span class="n">a</span> <span class="o">=</span> <span class="mh">0x8000</span><span class="p">;</span>
  <span class="nb">int</span> <span class="n">i</span> <span class="o">=</span> <span class="p">(</span><span class="n">signed</span> <span class="nb">int</span><span class="p">)</span><span class="n">a</span><span class="p">;</span>
  <span class="n">i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span> <span class="o">//</span> <span class="n">i</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">32768</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="mi">32766</span>

  <span class="k">return</span> <span class="n">i</span><span class="p">;</span>
<span class="p">}</span>

<span class="nb">int</span> <span class="n">test_unsigned_short</span><span class="p">()</span>
<span class="p">{</span>
  <span class="n">unsigned</span> <span class="n">short</span> <span class="n">c</span> <span class="o">=</span> <span class="mh">0x8000</span><span class="p">;</span>
  <span class="n">unsigned</span> <span class="nb">int</span> <span class="n">ui</span> <span class="o">=</span> <span class="p">(</span><span class="n">unsigned</span> <span class="nb">int</span><span class="p">)</span><span class="n">c</span><span class="p">;</span>
  <span class="n">ui</span> <span class="o">=</span> <span class="n">ui</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span> <span class="o">//</span> <span class="n">i</span> <span class="o">=</span> <span class="p">(</span><span class="mi">32768</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="mi">32770</span>
  <span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="n">unsigned</span> <span class="n">short</span><span class="p">)</span><span class="n">ui</span><span class="p">;</span>

  <span class="k">return</span> <span class="p">(</span><span class="nb">int</span><span class="p">)</span><span class="n">ui</span><span class="p">;</span>
<span class="p">}</span>

</pre></div>
</div>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">1-160-136-236:input Jonathan$</span> /Users/Jonathan/llvm/test/cmake_debug_build/
<span class="go">Debug/bin/llvm-dis ch7_1_char_short.bc -o -</span>
<span class="go">  ...</span>
<span class="go">define i32 @_Z16test_signed_charv() #0 {</span>
<span class="go">  ...</span>
<span class="gp">  %</span><span class="nv">1</span> <span class="o">=</span> load i8* %a, align 1
<span class="gp">  %</span><span class="nv">2</span> <span class="o">=</span> sext i8 %1 to i32
<span class="go">  ...</span>
<span class="go">}</span>

<span class="go">; Function Attrs: nounwind</span>
<span class="go">define i32 @_Z18test_unsigned_charv() #0 {</span>
<span class="go">  ...</span>
<span class="gp">  %</span><span class="nv">1</span> <span class="o">=</span> load i8* %c, align 1
<span class="gp">  %</span><span class="nv">2</span> <span class="o">=</span> zext i8 %1 to i32
<span class="go">  ...</span>
<span class="go">}</span>

<span class="go">; Function Attrs: nounwind</span>
<span class="go">define i32 @_Z17test_signed_shortv() #0 {</span>
<span class="go">  ...</span>
<span class="gp">  %</span><span class="nv">1</span> <span class="o">=</span> load i16* %a, align 2
<span class="gp">  %</span><span class="nv">2</span> <span class="o">=</span> sext i16 %1 to i32
<span class="go">  ...</span>
<span class="go">}</span>

<span class="go">; Function Attrs: nounwind</span>
<span class="go">define i32 @_Z19test_unsigned_shortv() #0 {</span>
<span class="go">  ...</span>
<span class="gp">  %</span><span class="nv">1</span> <span class="o">=</span> load i16* %c, align 2
<span class="gp">  %</span><span class="nv">2</span> <span class="o">=</span> zext i16 %1 to i32
<span class="go">  ...</span>
<span class="go">}</span>

<span class="go">attributes #0 = { nounwind }</span>

<span class="gp">1-160-136-236:input Jonathan$</span> /Users/Jonathan/llvm/test/cmake_debug_build/
<span class="go">Debug/bin/llc -march=cpu0 -relocation-model=static -filetype=asm ch7_1_char_short.bc -o -</span>
<span class="go">  ...</span>
<span class="go">  .globl  _Z16test_signed_charv</span>
<span class="go">  ...</span>
<span class="go">  lb  $2, 4($sp)</span>
<span class="go">  ...</span>
<span class="go">  .end  _Z16test_signed_charv</span>

<span class="go">  .globl  _Z18test_unsigned_charv</span>
<span class="go">  ...</span>
<span class="go">  lbu $2, 4($sp)</span>
<span class="go">  ...</span>
<span class="go">  .end  _Z18test_unsigned_charv</span>

<span class="go">  .globl  _Z17test_signed_shortv</span>
<span class="go">  ...</span>
<span class="go">  lh  $2, 4($sp)</span>
<span class="go">  ...</span>
<span class="go">  .end  _Z17test_signed_shortv</span>

<span class="go">  .globl  _Z19test_unsigned_shortv</span>
<span class="go">  ...</span>
<span class="go">  lhu $2, 4($sp)</span>
<span class="go">  ...</span>
<span class="go">  .end  _Z19test_unsigned_shortv</span>
<span class="go">  ...</span>
</pre></div>
</div>
<p>As you can see lb/lh are for signed byte/short type while lbu/lhu are for
unsigned byte/short type.
To support C type-cast or type-conversion feature efficiently, Cpu0 provide
instruction &#8220;lb&#8221; to converse type char to int with one single instruction.
The other instructions lbu, lh, lhu, sb and sh are applied in both signed or
unsigned of type byte and short conversion.
Their differences have been explained in Chapter 2.</p>
<p>To support load bool type, the following code added.</p>
<p class="rubric">lbdex/chapters/Chapter7_1/Cpu0ISelLowering.cpp</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">Cpu0TargetLowering</span><span class="p">::</span><span class="n">Cpu0TargetLowering</span><span class="p">(</span><span class="n">const</span> <span class="n">Cpu0TargetMachine</span> <span class="o">&amp;</span><span class="n">TM</span><span class="p">,</span>
                                       <span class="n">const</span> <span class="n">Cpu0Subtarget</span> <span class="o">&amp;</span><span class="n">STI</span><span class="p">)</span>
    <span class="p">:</span> <span class="n">TargetLowering</span><span class="p">(</span><span class="n">TM</span><span class="p">),</span> <span class="n">Subtarget</span><span class="p">(</span><span class="n">STI</span><span class="p">),</span> <span class="n">ABI</span><span class="p">(</span><span class="n">TM</span><span class="o">.</span><span class="n">getABI</span><span class="p">())</span> <span class="p">{</span>

</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span>  <span class="o">//</span> <span class="n">Cpu0</span> <span class="n">does</span> <span class="ow">not</span> <span class="n">have</span> <span class="n">i1</span> <span class="nb">type</span><span class="p">,</span> <span class="n">so</span> <span class="n">use</span> <span class="n">i32</span> <span class="k">for</span>
  <span class="o">//</span> <span class="n">setcc</span> <span class="n">operations</span> <span class="n">results</span> <span class="p">(</span><span class="n">slt</span><span class="p">,</span> <span class="n">sgt</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span><span class="o">.</span>
  <span class="n">setBooleanContents</span><span class="p">(</span><span class="n">ZeroOrOneBooleanContent</span><span class="p">);</span>
  <span class="n">setBooleanVectorContents</span><span class="p">(</span><span class="n">ZeroOrNegativeOneBooleanContent</span><span class="p">);</span>

  <span class="o">//</span> <span class="n">Load</span> <span class="n">extented</span> <span class="n">operations</span> <span class="k">for</span> <span class="n">i1</span> <span class="n">types</span> <span class="n">must</span> <span class="n">be</span> <span class="n">promoted</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">MVT</span> <span class="n">VT</span> <span class="p">:</span> <span class="n">MVT</span><span class="p">::</span><span class="n">integer_valuetypes</span><span class="p">())</span> <span class="p">{</span>
    <span class="n">setLoadExtAction</span><span class="p">(</span><span class="n">ISD</span><span class="p">::</span><span class="n">EXTLOAD</span><span class="p">,</span>  <span class="n">VT</span><span class="p">,</span> <span class="n">MVT</span><span class="p">::</span><span class="n">i1</span><span class="p">,</span>  <span class="n">Promote</span><span class="p">);</span>
    <span class="n">setLoadExtAction</span><span class="p">(</span><span class="n">ISD</span><span class="p">::</span><span class="n">ZEXTLOAD</span><span class="p">,</span> <span class="n">VT</span><span class="p">,</span> <span class="n">MVT</span><span class="p">::</span><span class="n">i1</span><span class="p">,</span>  <span class="n">Promote</span><span class="p">);</span>
    <span class="n">setLoadExtAction</span><span class="p">(</span><span class="n">ISD</span><span class="p">::</span><span class="n">SEXTLOAD</span><span class="p">,</span> <span class="n">VT</span><span class="p">,</span> <span class="n">MVT</span><span class="p">::</span><span class="n">i1</span><span class="p">,</span>  <span class="n">Promote</span><span class="p">);</span>
  <span class="p">}</span>
</pre></div>
</div>
<div class="highlight-c++"><div class="highlight"><pre><span></span>  <span class="p">...</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The setBooleanContents() purpose as following, but I don&#8217;t know it well.
Without it, the ch7_1_bool2.ll still works as below.
The IR input file ch7_1_bool2.ll is used in testing here since the c++ version
need flow control which is not supported at this point.
File ch_run_backend.cpp include the test fragment for bool as below.</p>
<p class="rubric">include/llvm/Target/TargetLowering.h</p>
<div class="highlight-c++"><div class="highlight"><pre><span></span>  <span class="k">enum</span> <span class="n">BooleanContent</span> <span class="p">{</span> <span class="c1">// How the target represents true/false values.</span>
    <span class="n">UndefinedBooleanContent</span><span class="p">,</span>    <span class="c1">// Only bit 0 counts, the rest can hold garbage.</span>
    <span class="n">ZeroOrOneBooleanContent</span><span class="p">,</span>        <span class="c1">// All bits zero except for bit 0.</span>
    <span class="n">ZeroOrNegativeOneBooleanContent</span> <span class="c1">// All bits equal to bit 0.</span>
  <span class="p">};</span>
<span class="p">...</span>
<span class="k">protected</span><span class="o">:</span>
  <span class="c1">/// setBooleanContents - Specify how the target extends the result of a</span>
  <span class="c1">/// boolean value from i1 to a wider type.  See getBooleanContents.</span>
  <span class="kt">void</span> <span class="n">setBooleanContents</span><span class="p">(</span><span class="n">BooleanContent</span> <span class="n">Ty</span><span class="p">)</span> <span class="p">{</span> <span class="n">BooleanContents</span> <span class="o">=</span> <span class="n">Ty</span><span class="p">;</span> <span class="p">}</span>
  <span class="c1">/// setBooleanVectorContents - Specify how the target extends the result</span>
  <span class="c1">/// of a vector boolean value from a vector of i1 to a wider type.  See</span>
  <span class="c1">/// getBooleanContents.</span>
  <span class="kt">void</span> <span class="n">setBooleanVectorContents</span><span class="p">(</span><span class="n">BooleanContent</span> <span class="n">Ty</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">BooleanVectorContents</span> <span class="o">=</span> <span class="n">Ty</span><span class="p">;</span>
  <span class="p">}</span>
</pre></div>
</div>
<p class="rubric">lbdex/input/ch7_1_bool2.ll</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">define</span> <span class="n">zeroext</span> <span class="n">i1</span> <span class="nd">@verify_load_bool</span><span class="p">()</span> <span class="c1">#0 {</span>
<span class="n">entry</span><span class="p">:</span>
  <span class="o">%</span><span class="n">retval</span> <span class="o">=</span> <span class="n">alloca</span> <span class="n">i1</span><span class="p">,</span> <span class="n">align</span> <span class="mi">1</span>
  <span class="n">store</span> <span class="n">i1</span> <span class="mi">1</span><span class="p">,</span> <span class="n">i1</span><span class="o">*</span> <span class="o">%</span><span class="n">retval</span><span class="p">,</span> <span class="n">align</span> <span class="mi">1</span>
  <span class="o">%</span><span class="mi">0</span> <span class="o">=</span> <span class="n">load</span> <span class="n">i1</span><span class="p">,</span> <span class="n">i1</span><span class="o">*</span> <span class="o">%</span><span class="n">retval</span>
  <span class="n">ret</span> <span class="n">i1</span> <span class="o">%</span><span class="mi">0</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="go">  118-165-64-245:input Jonathan$ /Users/Jonathan/llvm/test/cmake_debug_build/</span>
<span class="go">  Debug/bin/llc -march=cpu0 -relocation-model=pic -filetype=asm ch7_1_bool2.ll -o -</span>

<span class="go">  .section .mdebug.abi32</span>
<span class="go">  .previous</span>
<span class="go">  .file &quot;ch7_1_bool2.ll&quot;</span>
<span class="go">  .text</span>
<span class="go">  .globl  verify_load_bool</span>
<span class="go">  .align  2</span>
<span class="go">  .type verify_load_bool,@function</span>
<span class="go">  .ent  verify_load_bool        # @verify_load_bool</span>
<span class="go">verify_load_bool:</span>
<span class="go">  .cfi_startproc</span>
<span class="go">  .frame  $sp,8,$lr</span>
<span class="go">  .mask   0x00000000,0</span>
<span class="go">  .set  noreorder</span>
<span class="go">  .set  nomacro</span>
<span class="gp">#</span> BB#0:                                 <span class="c1"># %entry</span>
<span class="go">  addiu $sp, $sp, -8</span>
<span class="gp">$</span>tmp1:
<span class="go">  .cfi_def_cfa_offset 8</span>
<span class="go">  addiu $2, $zero, 1</span>
<span class="go">  sb  $2, 7($sp)</span>
<span class="go">  addiu $sp, $sp, 8</span>
<span class="go">  ret $lr</span>
<span class="go">  .set  macro</span>
<span class="go">  .set  reorder</span>
<span class="go">  .end  verify_load_bool</span>
<span class="gp">$</span>tmp2:
<span class="go">  .size verify_load_bool, ($tmp2)-verify_load_bool</span>
<span class="go">  .cfi_endproc</span>
</pre></div>
</div>
<p>The ch7_1_bool.cpp is the bool test version for C language.
You can run with it at Chapter8_1 to get the similar result with ch7_1_bool2.ll.</p>
<p class="rubric">lbdex/input/ch7_1_bool.cpp</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="nb">bool</span> <span class="n">test_load_bool</span><span class="p">()</span>
<span class="p">{</span>
  <span class="nb">int</span> <span class="n">a</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">a</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">false</span><span class="p">;</span>

  <span class="k">return</span> <span class="n">true</span><span class="p">;</span>
<span class="p">}</span>

</pre></div>
</div>
<p>Summary as the following table.</p>
<table border="1" class="docutils" id="id5">
<caption><span class="caption-number">Table 26 </span><span class="caption-text">The C, IR, and DAG translation for char, short and bool translation (ch7_1_char_short.cpp and ch7_1_bool2.ll).</span><a class="headerlink" href="#id5" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="33%" />
<col width="32%" />
<col width="35%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">C</th>
<th class="head">.bc</th>
<th class="head">Optimized legalized selection DAG</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>char a =0x80;</td>
<td>%1 = load i8* %a, align 1</td>
<td><ul class="first last simple">
<li></li>
</ul>
</td>
</tr>
<tr class="row-odd"><td>int i = (signed int)a;</td>
<td>%2 = sext i8 %1 to i32</td>
<td>load ..., &lt;..., sext from i8&gt;</td>
</tr>
<tr class="row-even"><td>unsigned char c = 0x80;</td>
<td>%1 = load i8* %c, align 1</td>
<td><ul class="first last simple">
<li></li>
</ul>
</td>
</tr>
<tr class="row-odd"><td>unsigned int ui = (unsigned int)c;</td>
<td>%2 = zext i8 %1 to i32</td>
<td>load ..., &lt;..., zext from i8&gt;</td>
</tr>
<tr class="row-even"><td>short a =0x8000;</td>
<td>%1 = load i16* %a, align 2</td>
<td><ul class="first last simple">
<li></li>
</ul>
</td>
</tr>
<tr class="row-odd"><td>int i = (signed int)a;</td>
<td>%2 = sext i16 %1 to i32</td>
<td>load ..., &lt;..., sext from i16&gt;</td>
</tr>
<tr class="row-even"><td>unsigned short c = 0x8000;</td>
<td>%1 = load i16* %c, align 2</td>
<td><ul class="first last simple">
<li></li>
</ul>
</td>
</tr>
<tr class="row-odd"><td>unsigned int ui = (unsigned int)c;</td>
<td>%2 = zext i16 %1 to i32</td>
<td>load ..., &lt;..., zext from i16&gt;</td>
</tr>
<tr class="row-even"><td>c = (unsigned short)ui;</td>
<td>%6 = trunc i32 %5 to i16</td>
<td><ul class="first last simple">
<li></li>
</ul>
</td>
</tr>
<tr class="row-odd"><td><ul class="first last simple">
<li></li>
</ul>
</td>
<td>store i16 %6, i16* %c, align 2</td>
<td>store ...,&lt;..., trunc to i16&gt;</td>
</tr>
<tr class="row-even"><td>return true;</td>
<td>store i1 1, i1* %retval, align 1</td>
<td>store ...,&lt;..., trunc to i8&gt;</td>
</tr>
</tbody>
</table>
<table border="1" class="docutils" id="id6">
<caption><span class="caption-number">Table 27 </span><span class="caption-text">The backend translation for char, short and bool translation (ch7_1_char_short.cpp and ch7_1_bool2.ll).</span><a class="headerlink" href="#id6" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="41%" />
<col width="8%" />
<col width="51%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Optimized legalized selection DAG</th>
<th class="head">Cpu0</th>
<th class="head">pattern in Cpu0InstrInfo.td</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>load ..., &lt;..., sext from i8&gt;</td>
<td>lb</td>
<td>LB  : LoadM32&lt;0x03, &#8220;lb&#8221;,  sextloadi8&gt;;</td>
</tr>
<tr class="row-odd"><td>load ..., &lt;..., zext from i8&gt;</td>
<td>lbu</td>
<td>LBu : LoadM32&lt;0x04, &#8220;lbu&#8221;, zextloadi8&gt;;</td>
</tr>
<tr class="row-even"><td>load ..., &lt;..., sext from i16&gt;</td>
<td>lh</td>
<td>LH  : LoadM32&lt;0x06, &#8220;lh&#8221;,  sextloadi16_a&gt;;</td>
</tr>
<tr class="row-odd"><td>load ..., &lt;..., zext from i16&gt;</td>
<td>lhu</td>
<td>LHu : LoadM32&lt;0x07, &#8220;lhu&#8221;, zextloadi16_a&gt;;</td>
</tr>
<tr class="row-even"><td>store ...,&lt;..., trunc to i16&gt;</td>
<td>sh</td>
<td>SH  : StoreM32&lt;0x08, &#8220;sh&#8221;, truncstorei16_a&gt;;</td>
</tr>
<tr class="row-odd"><td>store ...,&lt;..., trunc to i8&gt;</td>
<td>sb</td>
<td>SB  : StoreM32&lt;0x05, &#8220;sb&#8221;, truncstorei8&gt;;</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="long-long">
<h2><a class="toc-backref" href="#id9">long long</a><a class="headerlink" href="#long-long" title="Permalink to this headline">¶</a></h2>
<p>Like Mips, the type long of Cpu0 is 32-bit and type long long is 64-bit for C
language. To support type long long, we add the following code to
Chapter7_1/.</p>
<p class="rubric">lbdex/chapters/Chapter7_1/Cpu0SEISelDAGToDAG.cpp</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">void</span> <span class="n">Cpu0SEDAGToDAGISel</span><span class="p">::</span><span class="n">selectAddESubE</span><span class="p">(</span><span class="n">unsigned</span> <span class="n">MOp</span><span class="p">,</span> <span class="n">SDValue</span> <span class="n">InFlag</span><span class="p">,</span>
                                           <span class="n">SDValue</span> <span class="n">CmpLHS</span><span class="p">,</span> <span class="n">const</span> <span class="n">SDLoc</span> <span class="o">&amp;</span><span class="n">DL</span><span class="p">,</span>
                                           <span class="n">SDNode</span> <span class="o">*</span><span class="n">Node</span><span class="p">)</span> <span class="n">const</span> <span class="p">{</span>
  <span class="n">unsigned</span> <span class="n">Opc</span> <span class="o">=</span> <span class="n">InFlag</span><span class="o">.</span><span class="n">getOpcode</span><span class="p">();</span> <span class="p">(</span><span class="n">void</span><span class="p">)</span><span class="n">Opc</span><span class="p">;</span>
  <span class="k">assert</span><span class="p">(((</span><span class="n">Opc</span> <span class="o">==</span> <span class="n">ISD</span><span class="p">::</span><span class="n">ADDC</span> <span class="o">||</span> <span class="n">Opc</span> <span class="o">==</span> <span class="n">ISD</span><span class="p">::</span><span class="n">ADDE</span><span class="p">)</span> <span class="o">||</span>
          <span class="p">(</span><span class="n">Opc</span> <span class="o">==</span> <span class="n">ISD</span><span class="p">::</span><span class="n">SUBC</span> <span class="o">||</span> <span class="n">Opc</span> <span class="o">==</span> <span class="n">ISD</span><span class="p">::</span><span class="n">SUBE</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
         <span class="s2">&quot;(ADD|SUB)E flag operand must come from (ADD|SUB)C/E insn&quot;</span><span class="p">);</span>

  <span class="n">SDValue</span> <span class="n">Ops</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">CmpLHS</span><span class="p">,</span> <span class="n">InFlag</span><span class="o">.</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">};</span>
  <span class="n">SDValue</span> <span class="n">LHS</span> <span class="o">=</span> <span class="n">Node</span><span class="o">-&gt;</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">RHS</span> <span class="o">=</span> <span class="n">Node</span><span class="o">-&gt;</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
  <span class="n">EVT</span> <span class="n">VT</span> <span class="o">=</span> <span class="n">LHS</span><span class="o">.</span><span class="n">getValueType</span><span class="p">();</span>

  <span class="n">SDNode</span> <span class="o">*</span><span class="n">Carry</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">Subtarget</span><span class="o">-&gt;</span><span class="n">hasCpu032II</span><span class="p">())</span>
    <span class="n">Carry</span> <span class="o">=</span> <span class="n">CurDAG</span><span class="o">-&gt;</span><span class="n">getMachineNode</span><span class="p">(</span><span class="n">Cpu0</span><span class="p">::</span><span class="n">SLTu</span><span class="p">,</span> <span class="n">DL</span><span class="p">,</span> <span class="n">VT</span><span class="p">,</span> <span class="n">Ops</span><span class="p">);</span>
  <span class="k">else</span> <span class="p">{</span>
    <span class="n">SDNode</span> <span class="o">*</span><span class="n">StatusWord</span> <span class="o">=</span> <span class="n">CurDAG</span><span class="o">-&gt;</span><span class="n">getMachineNode</span><span class="p">(</span><span class="n">Cpu0</span><span class="p">::</span><span class="n">CMP</span><span class="p">,</span> <span class="n">DL</span><span class="p">,</span> <span class="n">VT</span><span class="p">,</span> <span class="n">Ops</span><span class="p">);</span>
    <span class="n">SDValue</span> <span class="n">Constant1</span> <span class="o">=</span> <span class="n">CurDAG</span><span class="o">-&gt;</span><span class="n">getTargetConstant</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">DL</span><span class="p">,</span> <span class="n">VT</span><span class="p">);</span>
    <span class="n">Carry</span> <span class="o">=</span> <span class="n">CurDAG</span><span class="o">-&gt;</span><span class="n">getMachineNode</span><span class="p">(</span><span class="n">Cpu0</span><span class="p">::</span><span class="n">ANDi</span><span class="p">,</span> <span class="n">DL</span><span class="p">,</span> <span class="n">VT</span><span class="p">,</span> 
                                           <span class="n">SDValue</span><span class="p">(</span><span class="n">StatusWord</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="n">Constant1</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="n">SDNode</span> <span class="o">*</span><span class="n">AddCarry</span> <span class="o">=</span> <span class="n">CurDAG</span><span class="o">-&gt;</span><span class="n">getMachineNode</span><span class="p">(</span><span class="n">Cpu0</span><span class="p">::</span><span class="n">ADDu</span><span class="p">,</span> <span class="n">DL</span><span class="p">,</span> <span class="n">VT</span><span class="p">,</span>
                                            <span class="n">SDValue</span><span class="p">(</span><span class="n">Carry</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="n">RHS</span><span class="p">);</span>

  <span class="n">CurDAG</span><span class="o">-&gt;</span><span class="n">SelectNodeTo</span><span class="p">(</span><span class="n">Node</span><span class="p">,</span> <span class="n">MOp</span><span class="p">,</span> <span class="n">VT</span><span class="p">,</span> <span class="n">MVT</span><span class="p">::</span><span class="n">Glue</span><span class="p">,</span> <span class="n">LHS</span><span class="p">,</span> <span class="n">SDValue</span><span class="p">(</span><span class="n">AddCarry</span><span class="p">,</span><span class="mi">0</span><span class="p">));</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="nb">bool</span> <span class="n">Cpu0SEDAGToDAGISel</span><span class="p">::</span><span class="n">trySelect</span><span class="p">(</span><span class="n">SDNode</span> <span class="o">*</span><span class="n">Node</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">unsigned</span> <span class="n">Opcode</span> <span class="o">=</span> <span class="n">Node</span><span class="o">-&gt;</span><span class="n">getOpcode</span><span class="p">();</span>
  <span class="n">SDLoc</span> <span class="n">DL</span><span class="p">(</span><span class="n">Node</span><span class="p">);</span>

  <span class="o">///</span>
  <span class="o">//</span> <span class="n">Instruction</span> <span class="n">Selection</span> <span class="ow">not</span> <span class="n">handled</span> <span class="n">by</span> <span class="n">the</span> <span class="n">auto</span><span class="o">-</span><span class="n">generated</span>
  <span class="o">//</span> <span class="n">tablegen</span> <span class="n">selection</span> <span class="n">should</span> <span class="n">be</span> <span class="n">handled</span> <span class="n">here</span><span class="o">.</span>
  <span class="o">///</span>

  <span class="o">///</span>
  <span class="o">//</span> <span class="n">Instruction</span> <span class="n">Selection</span> <span class="ow">not</span> <span class="n">handled</span> <span class="n">by</span> <span class="n">the</span> <span class="n">auto</span><span class="o">-</span><span class="n">generated</span>
  <span class="o">//</span> <span class="n">tablegen</span> <span class="n">selection</span> <span class="n">should</span> <span class="n">be</span> <span class="n">handled</span> <span class="n">here</span><span class="o">.</span>
  <span class="o">///</span>
  <span class="n">EVT</span> <span class="n">NodeTy</span> <span class="o">=</span> <span class="n">Node</span><span class="o">-&gt;</span><span class="n">getValueType</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
  <span class="n">unsigned</span> <span class="n">MultOpc</span><span class="p">;</span>

  <span class="n">switch</span><span class="p">(</span><span class="n">Opcode</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">default</span><span class="p">:</span> <span class="k">break</span><span class="p">;</span>

</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span>  case ISD::SUBE: {
    SDValue InFlag = Node-&gt;getOperand(2);
    selectAddESubE(Cpu0::SUBu, InFlag, InFlag.getOperand(0), DL, Node);
    return true;
  }

  case ISD::ADDE: {
    SDValue InFlag = Node-&gt;getOperand(2);
    selectAddESubE(Cpu0::ADDu, InFlag, InFlag.getValue(0), DL, Node);
    return true;
  }

  /// Mul with two results
  case ISD::SMUL_LOHI:
  case ISD::UMUL_LOHI: {
    MultOpc = (Opcode == ISD::UMUL_LOHI ? Cpu0::MULTu : Cpu0::MULT);

    std::pair&lt;SDNode*, SDNode*&gt; LoHi =
        selectMULT(Node, MultOpc, DL, NodeTy, true, true);

    if (!SDValue(Node, 0).use_empty())
      ReplaceUses(SDValue(Node, 0), SDValue(LoHi.first, 0));

    if (!SDValue(Node, 1).use_empty())
      ReplaceUses(SDValue(Node, 1), SDValue(LoHi.second, 0));

    CurDAG-&gt;RemoveDeadNode(Node);
    return true;
  }
</pre></div>
</div>
<div class="highlight-c++"><div class="highlight"><pre><span></span>  <span class="p">...</span>
<span class="p">}</span>
</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter7_1/Cpu0ISelLowering.h</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>  <span class="k">class</span> <span class="nc">Cpu0TargetLowering</span> <span class="p">:</span> <span class="n">public</span> <span class="n">TargetLowering</span>  <span class="p">{</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span>    <span class="nb">bool</span> <span class="n">isOffsetFoldingLegal</span><span class="p">(</span><span class="n">const</span> <span class="n">GlobalAddressSDNode</span> <span class="o">*</span><span class="n">GA</span><span class="p">)</span> <span class="n">const</span> <span class="n">override</span><span class="p">;</span>
</pre></div>
</div>
<div class="highlight-c++"><div class="highlight"><pre><span></span>  <span class="p">...</span>
<span class="p">}</span>
</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter7_1/Cpu0ISelLowering.cpp</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">Cpu0TargetLowering</span><span class="p">::</span><span class="n">Cpu0TargetLowering</span><span class="p">(</span><span class="n">const</span> <span class="n">Cpu0TargetMachine</span> <span class="o">&amp;</span><span class="n">TM</span><span class="p">,</span>
                                       <span class="n">const</span> <span class="n">Cpu0Subtarget</span> <span class="o">&amp;</span><span class="n">STI</span><span class="p">)</span>
    <span class="p">:</span> <span class="n">TargetLowering</span><span class="p">(</span><span class="n">TM</span><span class="p">),</span> <span class="n">Subtarget</span><span class="p">(</span><span class="n">STI</span><span class="p">),</span> <span class="n">ABI</span><span class="p">(</span><span class="n">TM</span><span class="o">.</span><span class="n">getABI</span><span class="p">())</span> <span class="p">{</span>

</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span>  <span class="o">//</span> <span class="n">Handle</span> <span class="n">i64</span> <span class="n">shl</span>
  <span class="n">setOperationAction</span><span class="p">(</span><span class="n">ISD</span><span class="p">::</span><span class="n">SHL_PARTS</span><span class="p">,</span>          <span class="n">MVT</span><span class="p">::</span><span class="n">i32</span><span class="p">,</span>   <span class="n">Expand</span><span class="p">);</span>
  <span class="n">setOperationAction</span><span class="p">(</span><span class="n">ISD</span><span class="p">::</span><span class="n">SRA_PARTS</span><span class="p">,</span>          <span class="n">MVT</span><span class="p">::</span><span class="n">i32</span><span class="p">,</span>   <span class="n">Expand</span><span class="p">);</span>
  <span class="n">setOperationAction</span><span class="p">(</span><span class="n">ISD</span><span class="p">::</span><span class="n">SRL_PARTS</span><span class="p">,</span>          <span class="n">MVT</span><span class="p">::</span><span class="n">i32</span><span class="p">,</span>   <span class="n">Expand</span><span class="p">);</span>
</pre></div>
</div>
<div class="highlight-c++"><div class="highlight"><pre><span></span>  <span class="p">...</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The added code in Cpu0ISelLowering.cpp are for shift operations which support
type long long 64-bit.
When applying operators &lt;&lt; and &gt;&gt; in 64-bit variables will create DAG SHL_PARTS,
SRA_PARTS and SRL_PARTS those which take care the 32 bits operands during llvm
DAGs translation.
File ch9_7.cpp of 64-bit shift operations cannot be run at this
point. It will be verified on later chapter &#8220;Function call&#8221;.</p>
<p>Run Chapter7_1 with ch7_1_longlong.cpp to get the result as follows,</p>
<p class="rubric">lbdex/input/ch7_1_longlong.cpp</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">long</span> <span class="n">long</span> <span class="n">test_longlong</span><span class="p">()</span>
<span class="p">{</span>
  <span class="n">long</span> <span class="n">long</span> <span class="n">a</span> <span class="o">=</span> <span class="mh">0x300000002</span><span class="p">;</span>
  <span class="n">long</span> <span class="n">long</span> <span class="n">b</span> <span class="o">=</span> <span class="mh">0x100000001</span><span class="p">;</span>
  <span class="nb">int</span> <span class="n">a1</span> <span class="o">=</span> <span class="mh">0x3001000</span><span class="p">;</span>
  <span class="nb">int</span> <span class="n">b1</span> <span class="o">=</span> <span class="mh">0x2001000</span><span class="p">;</span>
  
  <span class="n">long</span> <span class="n">long</span> <span class="n">c</span> <span class="o">=</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="p">;</span>   <span class="o">//</span> <span class="n">c</span> <span class="o">=</span> <span class="mh">0x00000004</span><span class="p">,</span><span class="mi">00000003</span>
  <span class="n">long</span> <span class="n">long</span> <span class="n">d</span> <span class="o">=</span> <span class="n">a</span> <span class="o">-</span> <span class="n">b</span><span class="p">;</span>   <span class="o">//</span> <span class="n">d</span> <span class="o">=</span> <span class="mh">0x00000002</span><span class="p">,</span><span class="mi">00000001</span>
  <span class="n">long</span> <span class="n">long</span> <span class="n">e</span> <span class="o">=</span> <span class="n">a</span> <span class="o">*</span> <span class="n">b</span><span class="p">;</span>   <span class="o">//</span> <span class="n">e</span> <span class="o">=</span> <span class="mh">0x00000005</span><span class="p">,</span><span class="mi">00000002</span>
  <span class="n">long</span> <span class="n">long</span> <span class="n">f</span> <span class="o">=</span> <span class="p">(</span><span class="n">long</span> <span class="n">long</span><span class="p">)</span><span class="n">a1</span> <span class="o">*</span> <span class="p">(</span><span class="n">long</span> <span class="n">long</span><span class="p">)</span><span class="n">b1</span><span class="p">;</span> <span class="o">//</span> <span class="n">f</span> <span class="o">=</span> <span class="mh">0x00060050</span><span class="p">,</span><span class="mi">01000000</span>

  <span class="k">return</span> <span class="p">(</span><span class="n">c</span><span class="o">+</span><span class="n">d</span><span class="o">+</span><span class="n">e</span><span class="o">+</span><span class="n">f</span><span class="p">);</span> <span class="o">//</span> <span class="p">(</span><span class="mh">0x0006005b</span><span class="p">,</span><span class="mi">01000006</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="mi">393307</span><span class="p">,</span><span class="mi">16777222</span><span class="p">)</span>
<span class="p">}</span>

</pre></div>
</div>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">1-160-134-62:input Jonathan$</span> clang -target mips-unknown-linux-gnu -c
<span class="go">ch7_1_longlong.cpp -emit-llvm -o ch7_1_longlong.bc</span>
<span class="gp">1-160-134-62:input Jonathan$</span> /Users/Jonathan/llvm/test/cmake_debug_build/
<span class="go">Debug/bin/llc -march=cpu0 -mcpu=cpu032I -relocation-model=pic -filetype=asm</span>
<span class="go">ch7_1_longlong.bc -o -</span>
<span class="go">  ...</span>
<span class="gp">#</span> BB#0:
<span class="go">        addiu $sp, $sp, -72</span>
<span class="go">        st    $8, 68($fp)             # 4-byte Folded Spill</span>
<span class="go">        addiu $2, $zero, 2</span>
<span class="go">        st    $2, 60($fp)</span>
<span class="go">        addiu $2, $zero, 3</span>
<span class="go">        st    $2, 56($fp)</span>
<span class="go">        addiu $2, $zero, 1</span>
<span class="go">        st    $2, 52($fp)</span>
<span class="go">        st    $2, 48($fp)</span>
<span class="go">        lui   $2, 768</span>
<span class="go">        ori   $2, $2, 4096</span>
<span class="go">        st    $2, 44($fp)</span>
<span class="go">        lui   $2, 512</span>
<span class="go">        ori   $2, $2, 4096</span>
<span class="go">        st    $2, 40($fp)</span>
<span class="go">        ld    $2, 52($fp)</span>
<span class="go">        ld    $3, 60($fp)</span>
<span class="go">        addu  $3, $3, $2</span>
<span class="go">        ld    $4, 56($fp)</span>
<span class="go">        ld    $5, 48($fp)</span>
<span class="go">        st    $3, 36($fp)</span>
<span class="go">        cmp   $sw, $3, $2</span>
<span class="go">        andi  $2, $sw, 1</span>
<span class="go">        addu  $2, $2, $5</span>
<span class="go">        addu  $2, $4, $2</span>
<span class="go">        st    $2, 32($fp)</span>
<span class="go">        ld    $2, 52($fp)</span>
<span class="go">        ld    $3, 60($fp)</span>
<span class="go">        subu  $4, $3, $2</span>
<span class="go">        ld    $5, 56($fp)</span>
<span class="go">        ld    $t9, 48($fp)</span>
<span class="go">        st    $4, 28($fp)</span>
<span class="go">        cmp   $sw, $3, $2</span>
<span class="go">        andi  $2, $sw, 1</span>
<span class="go">        addu  $2, $2, $t9</span>
<span class="go">        subu  $2, $5, $2</span>
<span class="go">        st    $2, 24($fp)</span>
<span class="go">        ld    $2, 52($fp)</span>
<span class="go">        ld    $3, 60($fp)</span>
<span class="go">        multu $3, $2</span>
<span class="go">        mflo  $4</span>
<span class="go">        mfhi  $5</span>
<span class="go">        ld    $t9, 56($fp)</span>
<span class="go">        ld    $7, 48($fp)</span>
<span class="go">        st    $4, 20($fp)</span>
<span class="go">        mul   $3, $3, $7</span>
<span class="go">        addu  $3, $5, $3</span>
<span class="go">        mul   $2, $t9, $2</span>
<span class="go">        addu  $2, $3, $2</span>
<span class="go">        st    $2, 16($fp)</span>
<span class="go">        ld    $2, 40($fp)</span>
<span class="go">        ld    $3, 44($fp)</span>
<span class="go">        mult  $3, $2</span>
<span class="go">        mflo  $2</span>
<span class="go">        mfhi  $4</span>
<span class="go">        st    $2, 12($fp)</span>
<span class="go">        st    $4, 8($fp)</span>
<span class="go">        ld    $5, 28($fp)</span>
<span class="go">        ld    $3, 36($fp)</span>
<span class="go">        addu  $t9, $3, $5</span>
<span class="go">        ld    $7, 20($fp)</span>
<span class="go">        addu  $8, $t9, $7</span>
<span class="go">        addu  $3, $8, $2</span>
<span class="go">        cmp   $sw, $3, $2</span>
<span class="go">        andi  $2, $sw, 1</span>
<span class="go">        addu  $2, $2, $4</span>
<span class="go">        cmp   $sw, $t9, $5</span>
<span class="go">        st    $sw, 4($fp)             # 4-byte Folded Spill</span>
<span class="go">        cmp   $sw, $8, $7</span>
<span class="go">        andi  $4, $sw, 1</span>
<span class="go">        ld    $5, 16($fp)</span>
<span class="go">        addu  $4, $4, $5</span>
<span class="go">        ld    $sw, 4($fp)             # 4-byte Folded Reload</span>
<span class="go">        andi  $5, $sw, 1</span>
<span class="go">        ld    $t9, 24($fp)</span>
<span class="go">        addu  $5, $5, $t9</span>
<span class="go">        ld    $t9, 32($fp)</span>
<span class="go">        addu  $5, $t9, $5</span>
<span class="go">        addu  $4, $5, $4</span>
<span class="go">        addu  $2, $4, $2</span>
<span class="go">        ld    $8, 68($fp)             # 4-byte Folded Reload</span>
<span class="go">        addiu $sp, $sp, 72</span>
<span class="go">        ret   $lr</span>
<span class="go">  ...</span>
</pre></div>
</div>
</div>
<div class="section" id="float-and-double">
<h2><a class="toc-backref" href="#id10">float and double</a><a class="headerlink" href="#float-and-double" title="Permalink to this headline">¶</a></h2>
<p>Cpu0 only has integer instructions at this point.
For float operations, Cpu0 backend
will call the library function to translate integer to float. This float (or
double) function call for Cpu0 will be supported after the chapter of function
call. For hardware cost reason, many CPU have no hardware float instructions.
They call library function to finish float operations. Mips sperarate float
operations with a sperarate co-processor for those needing &#8220;float intended&#8221;
application.</p>
<p>In order to support float point library (part of compiler-rt)
<a class="footnote-reference" href="#lbt-compiler-rt" id="id1">[2]</a>, the following code are added to support instructions clz
and clo.</p>
<p class="rubric">lbdex/chapters/Chapter7_1/Cpu0InstrInfo.td</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>let Predicates = [Ch7_1] in {
// Count Leading Ones/Zeros in Word
class CountLeading0&lt;bits&lt;8&gt; op, string instr_asm, RegisterClass RC&gt;:
  FA&lt;op, (outs GPROut:$ra), (ins RC:$rb),
     !strconcat(instr_asm, &quot;\t$ra, $rb&quot;),
     [(set GPROut:$ra, (ctlz RC:$rb))], II_CLZ&gt; {
  let rc = 0;
  let shamt = 0;
}

class CountLeading1&lt;bits&lt;8&gt; op, string instr_asm, RegisterClass RC&gt;:
  FA&lt;op, (outs GPROut:$ra), (ins RC:$rb),
     !strconcat(instr_asm, &quot;\t$ra, $rb&quot;),
     [(set GPROut:$ra, (ctlz (not RC:$rb)))], II_CLO&gt; {
  let rc = 0;
  let shamt = 0;
}
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">let</span> <span class="n">Predicates</span> <span class="o">=</span> <span class="p">[</span><span class="n">Ch7_1</span><span class="p">]</span> <span class="ow">in</span> <span class="p">{</span>
<span class="o">///</span> <span class="n">Count</span> <span class="n">Leading</span>
<span class="k">def</span> <span class="nf">CLZ</span> <span class="p">:</span> <span class="n">CountLeading0</span><span class="o">&lt;</span><span class="mh">0x15</span><span class="p">,</span> <span class="s2">&quot;clz&quot;</span><span class="p">,</span> <span class="n">CPURegs</span><span class="o">&gt;</span><span class="p">;</span>
<span class="k">def</span> <span class="nf">CLO</span> <span class="p">:</span> <span class="n">CountLeading1</span><span class="o">&lt;</span><span class="mh">0x16</span><span class="p">,</span> <span class="s2">&quot;clo&quot;</span><span class="p">,</span> <span class="n">CPURegs</span><span class="o">&gt;</span><span class="p">;</span>

</pre></div>
</div>
</div>
<div class="section" id="array-and-struct-support">
<h2><a class="toc-backref" href="#id11">Array and struct support</a><a class="headerlink" href="#array-and-struct-support" title="Permalink to this headline">¶</a></h2>
<p>LLVM uses getelementptr to represent the array and struct type in C.
Please reference here <a class="footnote-reference" href="#id4" id="id2">[1]</a>.
For ch7_1_globalstructoffset.cpp, the llvm IR as follows,</p>
<p class="rubric">lbdex/input/ch7_1_globalstructoffset.cpp</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">struct</span> <span class="n">Date</span>
<span class="p">{</span>
  <span class="nb">int</span> <span class="n">year</span><span class="p">;</span>
  <span class="nb">int</span> <span class="n">month</span><span class="p">;</span>
  <span class="nb">int</span> <span class="n">day</span><span class="p">;</span>
<span class="p">};</span>

<span class="n">Date</span> <span class="n">date</span> <span class="o">=</span> <span class="p">{</span><span class="mi">2012</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">12</span><span class="p">};</span>
<span class="nb">int</span> <span class="n">a</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">2012</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">12</span><span class="p">};</span>

<span class="nb">int</span> <span class="n">test_struct</span><span class="p">()</span>
<span class="p">{</span>
  <span class="nb">int</span> <span class="n">day</span> <span class="o">=</span> <span class="n">date</span><span class="o">.</span><span class="n">day</span><span class="p">;</span>
  <span class="nb">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

  <span class="k">return</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="n">day</span><span class="p">);</span> <span class="o">//</span> <span class="mi">10</span><span class="o">+</span><span class="mi">12</span><span class="o">=</span><span class="mi">22</span>
<span class="p">}</span>

</pre></div>
</div>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="go">// ch7_1_globalstructoffset.ll</span>
<span class="go">; ModuleID = &#39;ch7_1_globalstructoffset.bc&#39;</span>
<span class="go">...</span>
<span class="gp">%</span>struct.Date <span class="o">=</span> <span class="nb">type</span> <span class="o">{</span> i32, i32, i32 <span class="o">}</span>

<span class="go">@date = global %struct.Date { i32 2012, i32 10, i32 12 }, align 4</span>
<span class="go">@a = global [3 x i32] [i32 2012, i32 10, i32 12], align 4</span>

<span class="go">; Function Attrs: nounwind</span>
<span class="go">define i32 @_Z11test_structv() #0 {</span>
<span class="gp">  %</span><span class="nv">day</span> <span class="o">=</span> alloca i32, align 4
<span class="gp">  %</span><span class="nv">i</span> <span class="o">=</span> alloca i32, align 4
<span class="gp">  %</span><span class="nv">1</span> <span class="o">=</span> load i32* getelementptr inbounds <span class="o">(</span>%struct.Date* @date, i32 0, i32 2<span class="o">)</span>, align 4
<span class="go">  store i32 %1, i32* %day, align 4</span>
<span class="gp">  %</span><span class="nv">2</span> <span class="o">=</span> load i32* getelementptr inbounds <span class="o">([</span><span class="m">3</span> x i32<span class="o">]</span>* @a, i32 0, i32 1<span class="o">)</span>, align 4
<span class="go">  store i32 %2, i32* %i, align 4</span>
<span class="gp">  %</span><span class="nv">3</span> <span class="o">=</span> load i32* %i, align 4
<span class="gp">  %</span><span class="nv">4</span> <span class="o">=</span> load i32* %day, align 4
<span class="gp">  %</span><span class="nv">5</span> <span class="o">=</span> add nsw i32 %3, %4
<span class="go">  ret i32 %5</span>
<span class="go">}</span>
</pre></div>
</div>
<p>Run Chapter6_1/ with ch7_1_globalstructoffset.bc on static mode will get the
incorrect asm file as follows,</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">1-160-134-62:input Jonathan$</span> /Users/Jonathan/llvm/test/cmake_debug_build/bin/
<span class="go">Debug/llc -march=cpu0 -relocation-model=static -filetype=asm</span>
<span class="go">ch7_1_globalstructoffset.bc -o -</span>
<span class="go">  ...</span>
<span class="go">  lui $2, %hi(date)</span>
<span class="go">  ori $2, $2, %lo(date)</span>
<span class="go">  ld  $2, 0($2)   // the correct one is   ld  $2, 8($2)</span>
<span class="go">  ...</span>
</pre></div>
</div>
<p>For <strong>“day = date.day”</strong>, the correct one is <strong>“ld $2, 8($2)”</strong>, not
<strong>“ld $2, 0($2)”</strong>, since date.day is offset 8(date) (
Type int is 4 bytes in Cpu0, and the date.day has fields year and month before
it).
Let&#8217;s use debug option in llc to see what&#8217;s wrong,</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">jonathantekiimac:input Jonathan$</span> /Users/Jonathan/llvm/test/
<span class="go">cmake_debug_build/Debug/bin/llc -march=cpu0 -debug -relocation-model=static</span>
<span class="go">-filetype=asm ch6_2.bc -o ch6_2.cpu0.static.s</span>
<span class="go">...</span>
<span class="go">=== main</span>
<span class="go">Initial selection DAG: BB#0 &#39;main:entry&#39;</span>
<span class="go">SelectionDAG has 20 nodes:</span>
<span class="go">  0x7f7f5b02d210: i32 = undef [ORD=1]</span>

<span class="go">      0x7f7f5ac10590: ch = EntryToken [ORD=1]</span>

<span class="go">      0x7f7f5b02d010: i32 = Constant&lt;0&gt; [ORD=1]</span>

<span class="go">      0x7f7f5b02d110: i32 = FrameIndex&lt;0&gt; [ORD=1]</span>

<span class="go">      0x7f7f5b02d210: &lt;multiple use&gt;</span>
<span class="go">    0x7f7f5b02d310: ch = store 0x7f7f5ac10590, 0x7f7f5b02d010, 0x7f7f5b02d110,</span>
<span class="go">    0x7f7f5b02d210&lt;ST4[%retval]&gt; [ORD=1]</span>

<span class="go">      0x7f7f5b02d410: i32 = GlobalAddress&lt;%struct.Date* @date&gt; 0 [ORD=2]</span>

<span class="go">      0x7f7f5b02d510: i32 = Constant&lt;8&gt; [ORD=2]</span>

<span class="go">    0x7f7f5b02d610: i32 = add 0x7f7f5b02d410, 0x7f7f5b02d510 [ORD=2]</span>

<span class="go">    0x7f7f5b02d210: &lt;multiple use&gt;</span>
<span class="go">  0x7f7f5b02d710: i32,ch = load 0x7f7f5b02d310, 0x7f7f5b02d610, 0x7f7f5b02d210</span>
<span class="go">  &lt;LD4[getelementptr inbounds (%struct.Date* @date, i32 0, i32 2)]&gt; [ORD=3]</span>

<span class="go">  0x7f7f5b02db10: i64 = Constant&lt;4&gt;</span>

<span class="go">      0x7f7f5b02d710: &lt;multiple use&gt;</span>
<span class="go">      0x7f7f5b02d710: &lt;multiple use&gt;</span>
<span class="go">      0x7f7f5b02d810: i32 = FrameIndex&lt;1&gt; [ORD=4]</span>

<span class="go">      0x7f7f5b02d210: &lt;multiple use&gt;</span>
<span class="go">    0x7f7f5b02d910: ch = store 0x7f7f5b02d710:1, 0x7f7f5b02d710, 0x7f7f5b02d810,</span>
<span class="go">     0x7f7f5b02d210&lt;ST4[%day]&gt; [ORD=4]</span>

<span class="go">      0x7f7f5b02da10: i32 = GlobalAddress&lt;[3 x i32]* @a&gt; 0 [ORD=5]</span>

<span class="go">      0x7f7f5b02dc10: i32 = Constant&lt;4&gt; [ORD=5]</span>

<span class="go">    0x7f7f5b02dd10: i32 = add 0x7f7f5b02da10, 0x7f7f5b02dc10 [ORD=5]</span>

<span class="go">    0x7f7f5b02d210: &lt;multiple use&gt;</span>
<span class="go">  0x7f7f5b02de10: i32,ch = load 0x7f7f5b02d910, 0x7f7f5b02dd10, 0x7f7f5b02d210</span>
<span class="go">  &lt;LD4[getelementptr inbounds ([3 x i32]* @a, i32 0, i32 1)]&gt; [ORD=6]</span>

<span class="go">...</span>


<span class="go">Replacing.3 0x7f7f5b02dd10: i32 = add 0x7f7f5b02da10, 0x7f7f5b02dc10 [ORD=5]</span>

<span class="go">With: 0x7f7f5b030010: i32 = GlobalAddress&lt;[3 x i32]* @a&gt; + 4</span>


<span class="go">Replacing.3 0x7f7f5b02d610: i32 = add 0x7f7f5b02d410, 0x7f7f5b02d510 [ORD=2]</span>

<span class="go">With: 0x7f7f5b02db10: i32 = GlobalAddress&lt;%struct.Date* @date&gt; + 8</span>

<span class="go">Optimized lowered selection DAG: BB#0 &#39;main:entry&#39;</span>
<span class="go">SelectionDAG has 15 nodes:</span>
<span class="go">  0x7f7f5b02d210: i32 = undef [ORD=1]</span>

<span class="go">      0x7f7f5ac10590: ch = EntryToken [ORD=1]</span>

<span class="go">      0x7f7f5b02d010: i32 = Constant&lt;0&gt; [ORD=1]</span>

<span class="go">      0x7f7f5b02d110: i32 = FrameIndex&lt;0&gt; [ORD=1]</span>

<span class="go">      0x7f7f5b02d210: &lt;multiple use&gt;</span>
<span class="go">    0x7f7f5b02d310: ch = store 0x7f7f5ac10590, 0x7f7f5b02d010, 0x7f7f5b02d110,</span>
<span class="go">    0x7f7f5b02d210&lt;ST4[%retval]&gt; [ORD=1]</span>

<span class="go">    0x7f7f5b02db10: i32 = GlobalAddress&lt;%struct.Date* @date&gt; + 8</span>

<span class="go">    0x7f7f5b02d210: &lt;multiple use&gt;</span>
<span class="go">  0x7f7f5b02d710: i32,ch = load 0x7f7f5b02d310, 0x7f7f5b02db10, 0x7f7f5b02d210</span>
<span class="go">  &lt;LD4[getelementptr inbounds (%struct.Date* @date, i32 0, i32 2)]&gt; [ORD=3]</span>

<span class="go">      0x7f7f5b02d710: &lt;multiple use&gt;</span>
<span class="go">      0x7f7f5b02d710: &lt;multiple use&gt;</span>
<span class="go">      0x7f7f5b02d810: i32 = FrameIndex&lt;1&gt; [ORD=4]</span>

<span class="go">      0x7f7f5b02d210: &lt;multiple use&gt;</span>
<span class="go">    0x7f7f5b02d910: ch = store 0x7f7f5b02d710:1, 0x7f7f5b02d710, 0x7f7f5b02d810,</span>
<span class="go">     0x7f7f5b02d210&lt;ST4[%day]&gt; [ORD=4]</span>

<span class="go">    0x7f7f5b030010: i32 = GlobalAddress&lt;[3 x i32]* @a&gt; + 4</span>

<span class="go">    0x7f7f5b02d210: &lt;multiple use&gt;</span>
<span class="go">  0x7f7f5b02de10: i32,ch = load 0x7f7f5b02d910, 0x7f7f5b030010, 0x7f7f5b02d210</span>
<span class="go">  &lt;LD4[getelementptr inbounds ([3 x i32]* @a, i32 0, i32 1)]&gt; [ORD=6]</span>

<span class="go">...</span>
</pre></div>
</div>
<p>Through <code class="docutils literal"><span class="pre">llc</span> <span class="pre">-debug</span></code>, you can see the DAG translation process.
As above, the DAG list
for date.day (add GlobalAddress&lt;[3 x i32]* &#64;a&gt; 0, Constant&lt;8&gt;) with 3 nodes is
replaced by 1 node GlobalAddress&lt;%struct.Date* &#64;date&gt; + 8.
The DAG list for a[1] is same.
The replacement occurs since TargetLowering.cpp::isOffsetFoldingLegal(...)
return true in <code class="docutils literal"><span class="pre">llc</span> <span class="pre">-static</span></code> static addressing mode as below.
In Cpu0 the <strong>ld</strong> instruction format is <strong>“ld $r1, offset($r2)”</strong> which
meaning load $r2 address+offset to $r1.
So, we just replace the isOffsetFoldingLegal(...) function by override
mechanism as below.</p>
<p class="rubric">lib/CodeGen/SelectionDAG/TargetLowering.cpp</p>
<div class="highlight-c++"><div class="highlight"><pre><span></span><span class="kt">bool</span>
<span class="n">TargetLowering</span><span class="o">::</span><span class="n">isOffsetFoldingLegal</span><span class="p">(</span><span class="k">const</span> <span class="n">GlobalAddressSDNode</span> <span class="o">*</span><span class="n">GA</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
  <span class="c1">// Assume that everything is safe in static mode.</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">getTargetMachine</span><span class="p">().</span><span class="n">getRelocationModel</span><span class="p">()</span> <span class="o">==</span> <span class="n">Reloc</span><span class="o">::</span><span class="n">Static</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>

  <span class="c1">// In dynamic-no-pic mode, assume that known defined values are safe.</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">getTargetMachine</span><span class="p">().</span><span class="n">getRelocationModel</span><span class="p">()</span> <span class="o">==</span> <span class="n">Reloc</span><span class="o">::</span><span class="n">DynamicNoPIC</span> <span class="o">&amp;&amp;</span>
     <span class="n">GA</span> <span class="o">&amp;&amp;</span>
     <span class="o">!</span><span class="n">GA</span><span class="o">-&gt;</span><span class="n">getGlobal</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">isDeclaration</span><span class="p">()</span> <span class="o">&amp;&amp;</span>
     <span class="o">!</span><span class="n">GA</span><span class="o">-&gt;</span><span class="n">getGlobal</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">isWeakForLinker</span><span class="p">())</span>
  <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>

  <span class="c1">// Otherwise assume nothing is safe.</span>
  <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter7_1/Cpu0ISelLowering.cpp</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="nb">bool</span>
<span class="n">Cpu0TargetLowering</span><span class="p">::</span><span class="n">isOffsetFoldingLegal</span><span class="p">(</span><span class="n">const</span> <span class="n">GlobalAddressSDNode</span> <span class="o">*</span><span class="n">GA</span><span class="p">)</span> <span class="n">const</span> <span class="p">{</span>
  <span class="o">//</span> <span class="n">The</span> <span class="n">Cpu0</span> <span class="n">target</span> <span class="n">isn</span><span class="s1">&#39;t yet aware of offsets.</span>
  <span class="k">return</span> <span class="n">false</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Beyond that, we need to add the following code fragment to Cpu0ISelDAGToDAG.cpp,</p>
<p class="rubric">lbdex/chapters/Chapter7_1/Cpu0ISelDAGToDAG.cpp</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">///</span> <span class="n">ComplexPattern</span> <span class="n">used</span> <span class="n">on</span> <span class="n">Cpu0InstrInfo</span>
<span class="o">///</span> <span class="n">Used</span> <span class="n">on</span> <span class="n">Cpu0</span> <span class="n">Load</span><span class="o">/</span><span class="n">Store</span> <span class="n">instructions</span>
<span class="nb">bool</span> <span class="n">Cpu0DAGToDAGISel</span><span class="p">::</span>
<span class="n">SelectAddr</span><span class="p">(</span><span class="n">SDNode</span> <span class="o">*</span><span class="n">Parent</span><span class="p">,</span> <span class="n">SDValue</span> <span class="n">Addr</span><span class="p">,</span> <span class="n">SDValue</span> <span class="o">&amp;</span><span class="n">Base</span><span class="p">,</span> <span class="n">SDValue</span> <span class="o">&amp;</span><span class="n">Offset</span><span class="p">)</span> <span class="p">{</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span>  <span class="o">//</span> <span class="n">Addresses</span> <span class="n">of</span> <span class="n">the</span> <span class="n">form</span> <span class="n">FI</span><span class="o">+</span><span class="n">const</span> <span class="ow">or</span> <span class="n">FI</span><span class="o">|</span><span class="n">const</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">CurDAG</span><span class="o">-&gt;</span><span class="n">isBaseWithConstantOffset</span><span class="p">(</span><span class="n">Addr</span><span class="p">))</span> <span class="p">{</span>
    <span class="n">ConstantSDNode</span> <span class="o">*</span><span class="n">CN</span> <span class="o">=</span> <span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">ConstantSDNode</span><span class="o">&gt;</span><span class="p">(</span><span class="n">Addr</span><span class="o">.</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">isInt</span><span class="o">&lt;</span><span class="mi">16</span><span class="o">&gt;</span><span class="p">(</span><span class="n">CN</span><span class="o">-&gt;</span><span class="n">getSExtValue</span><span class="p">()))</span> <span class="p">{</span>

      <span class="o">//</span> <span class="n">If</span> <span class="n">the</span> <span class="n">first</span> <span class="n">operand</span> <span class="ow">is</span> <span class="n">a</span> <span class="n">FI</span><span class="p">,</span> <span class="n">get</span> <span class="n">the</span> <span class="n">TargetFI</span> <span class="n">Node</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">FrameIndexSDNode</span> <span class="o">*</span><span class="n">FIN</span> <span class="o">=</span> <span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">FrameIndexSDNode</span><span class="o">&gt;</span>
                                  <span class="p">(</span><span class="n">Addr</span><span class="o">.</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">)))</span>
        <span class="n">Base</span> <span class="o">=</span> <span class="n">CurDAG</span><span class="o">-&gt;</span><span class="n">getTargetFrameIndex</span><span class="p">(</span><span class="n">FIN</span><span class="o">-&gt;</span><span class="n">getIndex</span><span class="p">(),</span> <span class="n">ValTy</span><span class="p">);</span>
      <span class="k">else</span>
        <span class="n">Base</span> <span class="o">=</span> <span class="n">Addr</span><span class="o">.</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

      <span class="n">Offset</span> <span class="o">=</span> <span class="n">CurDAG</span><span class="o">-&gt;</span><span class="n">getTargetConstant</span><span class="p">(</span><span class="n">CN</span><span class="o">-&gt;</span><span class="n">getZExtValue</span><span class="p">(),</span> <span class="n">DL</span><span class="p">,</span> <span class="n">ValTy</span><span class="p">);</span>
      <span class="k">return</span> <span class="n">true</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
</pre></div>
</div>
<div class="highlight-c++"><div class="highlight"><pre><span></span>  <span class="p">...</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Recall we have translated DAG list for date.day
(add GlobalAddress&lt;[3 x i32]* &#64;a&gt; 0, Constant&lt;8&gt;) into
(add (add Cpu0ISD::Hi (Cpu0II::MO_ABS_HI), Cpu0ISD::Lo(Cpu0II::MO_ABS_LO)),
Constant&lt;8&gt;) by the following code in Cpu0ISelLowering.cpp.</p>
<p class="rubric">lbdex/chapters/Chapter6_1/Cpu0ISelLowering.h</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>    <span class="o">//</span> <span class="n">This</span> <span class="n">method</span> <span class="n">creates</span> <span class="n">the</span> <span class="n">following</span> <span class="n">nodes</span><span class="p">,</span> <span class="n">which</span> <span class="n">are</span> <span class="n">necessary</span> <span class="k">for</span>
    <span class="o">//</span> <span class="n">computing</span> <span class="n">a</span> <span class="n">symbol</span><span class="s1">&#39;s address in non-PIC mode:</span>
    <span class="o">//</span>
    <span class="o">//</span> <span class="p">(</span><span class="n">add</span> <span class="o">%</span><span class="n">hi</span><span class="p">(</span><span class="n">sym</span><span class="p">),</span> <span class="o">%</span><span class="n">lo</span><span class="p">(</span><span class="n">sym</span><span class="p">))</span>
    <span class="n">template</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">NodeTy</span><span class="o">&gt;</span>
    <span class="n">SDValue</span> <span class="n">getAddrNonPIC</span><span class="p">(</span><span class="n">NodeTy</span> <span class="o">*</span><span class="n">N</span><span class="p">,</span> <span class="n">EVT</span> <span class="n">Ty</span><span class="p">,</span> <span class="n">SelectionDAG</span> <span class="o">&amp;</span><span class="n">DAG</span><span class="p">)</span> <span class="n">const</span> <span class="p">{</span>
      <span class="n">SDLoc</span> <span class="n">DL</span><span class="p">(</span><span class="n">N</span><span class="p">);</span>
      <span class="n">SDValue</span> <span class="n">Hi</span> <span class="o">=</span> <span class="n">getTargetNode</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">Ty</span><span class="p">,</span> <span class="n">DAG</span><span class="p">,</span> <span class="n">Cpu0II</span><span class="p">::</span><span class="n">MO_ABS_HI</span><span class="p">);</span>
      <span class="n">SDValue</span> <span class="n">Lo</span> <span class="o">=</span> <span class="n">getTargetNode</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">Ty</span><span class="p">,</span> <span class="n">DAG</span><span class="p">,</span> <span class="n">Cpu0II</span><span class="p">::</span><span class="n">MO_ABS_LO</span><span class="p">);</span>
      <span class="k">return</span> <span class="n">DAG</span><span class="o">.</span><span class="n">getNode</span><span class="p">(</span><span class="n">ISD</span><span class="p">::</span><span class="n">ADD</span><span class="p">,</span> <span class="n">DL</span><span class="p">,</span> <span class="n">Ty</span><span class="p">,</span>
                         <span class="n">DAG</span><span class="o">.</span><span class="n">getNode</span><span class="p">(</span><span class="n">Cpu0ISD</span><span class="p">::</span><span class="n">Hi</span><span class="p">,</span> <span class="n">DL</span><span class="p">,</span> <span class="n">Ty</span><span class="p">,</span> <span class="n">Hi</span><span class="p">),</span>
                         <span class="n">DAG</span><span class="o">.</span><span class="n">getNode</span><span class="p">(</span><span class="n">Cpu0ISD</span><span class="p">::</span><span class="n">Lo</span><span class="p">,</span> <span class="n">DL</span><span class="p">,</span> <span class="n">Ty</span><span class="p">,</span> <span class="n">Lo</span><span class="p">));</span>
    <span class="p">}</span>
</pre></div>
</div>
<p>So, when the SelectAddr(...) of Cpu0ISelDAGToDAG.cpp is called.
The Addr SDValue in SelectAddr(..., Addr, ...) is DAG list for date.day
(add (add Cpu0ISD::Hi (Cpu0II::MO_ABS_HI), Cpu0ISD::Lo(Cpu0II::MO_ABS_LO)),
Constant&lt;8&gt;).
Since Addr.getOpcode() = ISD:ADD, Addr.getOperand(0) =
(add Cpu0ISD::Hi (Cpu0II::MO_ABS_HI), Cpu0ISD::Lo(Cpu0II::MO_ABS_LO)) and
Addr.getOperand(1).getOpcode() = ISD::Constant, the Base = SDValue
(add Cpu0ISD::Hi (Cpu0II::MO_ABS_HI), Cpu0ISD::Lo(Cpu0II::MO_ABS_LO)) and
Offset = Constant&lt;8&gt;.
After set Base and Offset, the load DAG will translate the global address
date.day into machine instruction <strong>“ld $r1, 8($r2)”</strong> in Instruction Selection
stage.</p>
<p>Chapter7_1/ include these changes as above, you can run it with
ch7_1_globalstructoffset.cpp to get the correct generated instruction
<strong>“ld $r1, 8($r2)”</strong> for date.day access, as follows.</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="go">...</span>
<span class="go">      lui   $2, %hi(date)</span>
<span class="go">      ori   $2, $2, %lo(date)</span>
<span class="go">      ld    $2, 8($2)   // correct</span>
<span class="go">...</span>
</pre></div>
</div>
<p>The ch7_1_localarrayinit.cpp is for local variable initialization test.
The result as follows,</p>
<p class="rubric">lbdex/input/ch7_1_localarrayinit.cpp</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="nb">int</span> <span class="n">main</span><span class="p">()</span>
<span class="p">{</span>
  <span class="nb">int</span> <span class="n">a</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">=</span><span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">};</span>
    
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">118-165-79-206:input Jonathan$</span> clang -target mips-unknown-linux-gnu -c
<span class="go">ch7_1_localarrayinit.cpp -emit-llvm -o ch7_1_localarrayinit.bc</span>
<span class="gp">118-165-79-206:input Jonathan$</span> llvm-dis ch7_1_localarrayinit.bc -o -
<span class="go">...</span>
</pre></div>
</div>
<div class="highlight-llvm"><div class="highlight"><pre><span></span><span class="k">define</span> <span class="k">i32</span> <span class="vg">@main</span><span class="p">()</span> <span class="k">nounwind</span> <span class="k">ssp</span> <span class="p">{</span>
<span class="nl">entry:</span>
  <span class="nv">%retval</span> <span class="p">=</span> <span class="k">alloca</span> <span class="k">i32</span><span class="p">,</span> <span class="k">align</span> <span class="m">4</span>
  <span class="nv">%a</span> <span class="p">=</span> <span class="k">alloca</span> <span class="p">[</span><span class="m">3</span> <span class="k">x</span> <span class="k">i32</span><span class="p">],</span> <span class="k">align</span> <span class="m">4</span>
  <span class="k">store</span> <span class="k">i32</span> <span class="m">0</span><span class="p">,</span> <span class="k">i32</span><span class="p">*</span> <span class="nv">%retval</span>
  <span class="nv nv-Anonymous">%0</span> <span class="p">=</span> <span class="k">bitcast</span> <span class="p">[</span><span class="m">3</span> <span class="k">x</span> <span class="k">i32</span><span class="p">]*</span> <span class="nv">%a</span> <span class="k">to</span> <span class="k">i8</span><span class="p">*</span>
  <span class="k">call</span> <span class="kt">void</span> <span class="vg">@llvm.memcpy.p0i8.p0i8.i32</span><span class="p">(</span><span class="k">i8</span><span class="p">*</span> <span class="nv nv-Anonymous">%0</span><span class="p">,</span> <span class="k">i8</span><span class="p">*</span> <span class="k">bitcast</span> <span class="p">([</span><span class="m">3</span> <span class="k">x</span> <span class="k">i32</span><span class="p">]*</span>
    <span class="vg">@_ZZ4mainE1a</span> <span class="k">to</span> <span class="k">i8</span><span class="p">*),</span> <span class="k">i32</span> <span class="m">12</span><span class="p">,</span> <span class="k">i32</span> <span class="m">4</span><span class="p">,</span> <span class="k">i1</span> <span class="k">false</span><span class="p">)</span>
  <span class="k">ret</span> <span class="k">i32</span> <span class="m">0</span>
<span class="p">}</span>
<span class="c">; Function Attrs: nounwind</span>
<span class="k">declare</span> <span class="kt">void</span> <span class="vg">@llvm.memcpy.p0i8.p0i8.i32</span><span class="p">(</span><span class="k">i8</span><span class="p">*</span> <span class="k">nocapture</span><span class="p">,</span> <span class="k">i8</span><span class="p">*</span> <span class="k">nocapture</span><span class="p">,</span> <span class="k">i32</span><span class="p">,</span> <span class="k">i32</span><span class="p">,</span> <span class="k">i1</span><span class="p">)</span> <span class="vg">#1</span>
</pre></div>
</div>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">118-165-79-206:input Jonathan$</span> ~/llvm/test/cmake_debug_build/
<span class="go">bin/llc -march=cpu0 -relocation-model=pic -filetype=asm ch7_1_localarrayinit.bc -o -</span>
<span class="go">        ...</span>
<span class="gp">#</span> BB#0:                                 <span class="c1"># %entry</span>
<span class="go">        addiu $sp, $sp, -16</span>
<span class="go">        addiu $2, $zero, 0</span>
<span class="go">        st    $2, 12($fp)</span>
<span class="go">        ld    $2, %got($_ZZ4mainE1a)($gp)</span>
<span class="go">        ori   $2, $2, %lo($_ZZ4mainE1a)</span>
<span class="go">        ld    $3, 8($2)</span>
<span class="go">        st    $3, 8($fp)</span>
<span class="go">        ld    $3, 4($2)</span>
<span class="go">        st    $3, 4($fp)</span>
<span class="go">        ld    $2, 0($2)</span>
<span class="go">        st    $2, 0($fp)</span>
<span class="go">        addiu $sp, $sp, 16</span>
<span class="go">        ret   $lr</span>
<span class="go">        ...</span>
<span class="go">        .type $_ZZ4mainE1a,@object    # @_ZZ4mainE1a</span>
<span class="go">        .section      .rodata,&quot;a&quot;,@progbits</span>
<span class="go">        .align        2</span>
<span class="gp">$</span>_ZZ4mainE1a:
<span class="go">        .4byte        0                       # 0x0</span>
<span class="go">        .4byte        1                       # 0x1</span>
<span class="go">        .4byte        2                       # 0x2</span>
<span class="go">        .size $_ZZ4mainE1a, 12</span>
</pre></div>
</div>
</div>
<div class="section" id="vector-type-simd-support">
<h2><a class="toc-backref" href="#id12">Vector type (SIMD) support</a><a class="headerlink" href="#vector-type-simd-support" title="Permalink to this headline">¶</a></h2>
<p>Vector types are used when multiple primitive data are operated in parallel
using a single instruction (SIMD) <a class="footnote-reference" href="#vector" id="id3">[3]</a>. Mips supports the
following llvm IRs &#8220;icmp slt&#8221; and &#8220;sext&#8221; for vector type, Cpu0 supports them
either.</p>
<p class="rubric">lbdex/input/ch7_1_vector.cpp</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>
<span class="n">typedef</span> <span class="n">long</span>   <span class="n">vector8long</span>   <span class="n">__attribute__</span><span class="p">((</span><span class="n">__vector_size__</span><span class="p">(</span><span class="mi">32</span><span class="p">)));</span>
<span class="n">typedef</span> <span class="n">long</span>   <span class="n">vector8short</span>   <span class="n">__attribute__</span><span class="p">((</span><span class="n">__vector_size__</span><span class="p">(</span><span class="mi">16</span><span class="p">)));</span>


<span class="nb">int</span> <span class="n">test_cmplt_short</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">volatile</span> <span class="n">vector8short</span> <span class="n">a0</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">};</span>
  <span class="n">volatile</span> <span class="n">vector8short</span> <span class="n">b0</span> <span class="o">=</span> <span class="p">{</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">};</span>
  <span class="n">volatile</span> <span class="n">vector8short</span> <span class="n">c0</span><span class="p">;</span>
  <span class="n">c0</span> <span class="o">=</span> <span class="n">a0</span> <span class="o">&lt;</span> <span class="n">b0</span><span class="p">;</span> <span class="o">//</span> <span class="n">c0</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="p">(</span><span class="n">since</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="ow">is</span> <span class="n">true</span><span class="p">),</span> <span class="n">c0</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">c0</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">(</span><span class="n">since</span> <span class="mi">2</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="ow">is</span> <span class="n">false</span><span class="p">),</span> <span class="n">c0</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
  
  <span class="k">return</span> <span class="p">(</span><span class="nb">int</span><span class="p">)(</span><span class="n">c0</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">c0</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">c0</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="n">c0</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span> <span class="o">//</span> <span class="mi">2</span>
<span class="p">}</span>


<span class="nb">int</span> <span class="n">test_cmplt_long</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">volatile</span> <span class="n">vector8long</span> <span class="n">a0</span> <span class="o">=</span> <span class="p">{</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">};</span>
  <span class="n">volatile</span> <span class="n">vector8long</span> <span class="n">b0</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">};</span>
  <span class="n">volatile</span> <span class="n">vector8long</span> <span class="n">c0</span><span class="p">;</span>
  <span class="n">c0</span> <span class="o">=</span> <span class="n">a0</span> <span class="o">&lt;</span> <span class="n">b0</span><span class="p">;</span> <span class="o">//</span> <span class="n">c0</span><span class="p">[</span><span class="mf">0.</span><span class="o">.</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">...</span><span class="p">},</span> <span class="n">c0</span><span class="p">[</span><span class="mf">4.</span><span class="o">.</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="o">...</span><span class="p">}</span>
  
  <span class="k">return</span> <span class="p">(</span><span class="n">c0</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">c0</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">c0</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="n">c0</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">+</span><span class="n">c0</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">+</span><span class="n">c0</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">+</span><span class="n">c0</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">+</span><span class="n">c0</span><span class="p">[</span><span class="mi">7</span><span class="p">]);</span> <span class="o">//</span><span class="mi">4</span>
<span class="p">}</span>

</pre></div>
</div>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">118-165-79-206:input Jonathan$</span> clang -target mips-unknown-linux-gnu -c
<span class="go">ch7_1_vector.cpp -emit-llvm -o ch7_1_vector.bc</span>
<span class="gp">118-165-79-206:input Jonathan$</span> ~/llvm/test/cmake_debug_build/Debug/bin/
<span class="go">llvm-dis ch7_1_vector.bc -o -</span>
<span class="go">...</span>
</pre></div>
</div>
<div class="highlight-llvm"><div class="highlight"><pre><span></span><span class="c">; Function Attrs: nounwind</span>
<span class="k">define</span> <span class="k">i32</span> <span class="vg">@_Z16test_cmplt_shortv</span><span class="p">()</span> <span class="vg">#0</span> <span class="p">{</span>
  <span class="nv">%a0</span> <span class="p">=</span> <span class="k">alloca</span> <span class="p">&lt;</span><span class="m">4</span> <span class="k">x</span> <span class="k">i32</span><span class="p">&gt;,</span> <span class="k">align</span> <span class="m">16</span>
  <span class="nv">%b0</span> <span class="p">=</span> <span class="k">alloca</span> <span class="p">&lt;</span><span class="m">4</span> <span class="k">x</span> <span class="k">i32</span><span class="p">&gt;,</span> <span class="k">align</span> <span class="m">16</span>
  <span class="nv">%c0</span> <span class="p">=</span> <span class="k">alloca</span> <span class="p">&lt;</span><span class="m">4</span> <span class="k">x</span> <span class="k">i32</span><span class="p">&gt;,</span> <span class="k">align</span> <span class="m">16</span>
  <span class="k">store</span> <span class="k">volatile</span> <span class="p">&lt;</span><span class="m">4</span> <span class="k">x</span> <span class="k">i32</span><span class="p">&gt;</span> <span class="p">&lt;</span><span class="k">i32</span> <span class="m">0</span><span class="p">,</span> <span class="k">i32</span> <span class="m">1</span><span class="p">,</span> <span class="k">i32</span> <span class="m">2</span><span class="p">,</span> <span class="k">i32</span> <span class="m">3</span><span class="p">&gt;,</span> <span class="p">&lt;</span><span class="m">4</span> <span class="k">x</span> <span class="k">i32</span><span class="p">&gt;*</span> <span class="nv">%a0</span><span class="p">,</span> <span class="k">align</span> <span class="m">16</span>
  <span class="k">store</span> <span class="k">volatile</span> <span class="p">&lt;</span><span class="m">4</span> <span class="k">x</span> <span class="k">i32</span><span class="p">&gt;</span> <span class="p">&lt;</span><span class="k">i32</span> <span class="m">2</span><span class="p">,</span> <span class="k">i32</span> <span class="m">2</span><span class="p">,</span> <span class="k">i32</span> <span class="m">2</span><span class="p">,</span> <span class="k">i32</span> <span class="m">2</span><span class="p">&gt;,</span> <span class="p">&lt;</span><span class="m">4</span> <span class="k">x</span> <span class="k">i32</span><span class="p">&gt;*</span> <span class="nv">%b0</span><span class="p">,</span> <span class="k">align</span> <span class="m">16</span>
  <span class="nv nv-Anonymous">%1</span> <span class="p">=</span> <span class="k">load</span> <span class="k">volatile</span> <span class="p">&lt;</span><span class="m">4</span> <span class="k">x</span> <span class="k">i32</span><span class="p">&gt;,</span> <span class="p">&lt;</span><span class="m">4</span> <span class="k">x</span> <span class="k">i32</span><span class="p">&gt;*</span> <span class="nv">%a0</span><span class="p">,</span> <span class="k">align</span> <span class="m">16</span>
  <span class="nv nv-Anonymous">%2</span> <span class="p">=</span> <span class="k">load</span> <span class="k">volatile</span> <span class="p">&lt;</span><span class="m">4</span> <span class="k">x</span> <span class="k">i32</span><span class="p">&gt;,</span> <span class="p">&lt;</span><span class="m">4</span> <span class="k">x</span> <span class="k">i32</span><span class="p">&gt;*</span> <span class="nv">%b0</span><span class="p">,</span> <span class="k">align</span> <span class="m">16</span>
  <span class="nv nv-Anonymous">%3</span> <span class="p">=</span> <span class="k">icmp</span> <span class="k">slt</span> <span class="p">&lt;</span><span class="m">4</span> <span class="k">x</span> <span class="k">i32</span><span class="p">&gt;</span> <span class="nv nv-Anonymous">%1</span><span class="p">,</span> <span class="nv nv-Anonymous">%2</span>
  <span class="nv nv-Anonymous">%4</span> <span class="p">=</span> <span class="k">sext</span> <span class="p">&lt;</span><span class="m">4</span> <span class="k">x</span> <span class="k">i1</span><span class="p">&gt;</span> <span class="nv nv-Anonymous">%3</span> <span class="k">to</span> <span class="p">&lt;</span><span class="m">4</span> <span class="k">x</span> <span class="k">i32</span><span class="p">&gt;</span>
  <span class="k">store</span> <span class="k">volatile</span> <span class="p">&lt;</span><span class="m">4</span> <span class="k">x</span> <span class="k">i32</span><span class="p">&gt;</span> <span class="nv nv-Anonymous">%4</span><span class="p">,</span> <span class="p">&lt;</span><span class="m">4</span> <span class="k">x</span> <span class="k">i32</span><span class="p">&gt;*</span> <span class="nv">%c0</span><span class="p">,</span> <span class="k">align</span> <span class="m">16</span>
  <span class="nv nv-Anonymous">%5</span> <span class="p">=</span> <span class="k">load</span> <span class="k">volatile</span> <span class="p">&lt;</span><span class="m">4</span> <span class="k">x</span> <span class="k">i32</span><span class="p">&gt;,</span> <span class="p">&lt;</span><span class="m">4</span> <span class="k">x</span> <span class="k">i32</span><span class="p">&gt;*</span> <span class="nv">%c0</span><span class="p">,</span> <span class="k">align</span> <span class="m">16</span>
  <span class="nv nv-Anonymous">%6</span> <span class="p">=</span> <span class="k">extractelement</span> <span class="p">&lt;</span><span class="m">4</span> <span class="k">x</span> <span class="k">i32</span><span class="p">&gt;</span> <span class="nv nv-Anonymous">%5</span><span class="p">,</span> <span class="k">i32</span> <span class="m">0</span>
  <span class="nv nv-Anonymous">%7</span> <span class="p">=</span> <span class="k">load</span> <span class="k">volatile</span> <span class="p">&lt;</span><span class="m">4</span> <span class="k">x</span> <span class="k">i32</span><span class="p">&gt;,</span> <span class="p">&lt;</span><span class="m">4</span> <span class="k">x</span> <span class="k">i32</span><span class="p">&gt;*</span> <span class="nv">%c0</span><span class="p">,</span> <span class="k">align</span> <span class="m">16</span>
  <span class="nv nv-Anonymous">%8</span> <span class="p">=</span> <span class="k">extractelement</span> <span class="p">&lt;</span><span class="m">4</span> <span class="k">x</span> <span class="k">i32</span><span class="p">&gt;</span> <span class="nv nv-Anonymous">%7</span><span class="p">,</span> <span class="k">i32</span> <span class="m">1</span>
  <span class="nv nv-Anonymous">%9</span> <span class="p">=</span> <span class="k">add</span> <span class="k">nsw</span> <span class="k">i32</span> <span class="nv nv-Anonymous">%6</span><span class="p">,</span> <span class="nv nv-Anonymous">%8</span>
  <span class="nv nv-Anonymous">%10</span> <span class="p">=</span> <span class="k">load</span> <span class="k">volatile</span> <span class="p">&lt;</span><span class="m">4</span> <span class="k">x</span> <span class="k">i32</span><span class="p">&gt;,</span> <span class="p">&lt;</span><span class="m">4</span> <span class="k">x</span> <span class="k">i32</span><span class="p">&gt;*</span> <span class="nv">%c0</span><span class="p">,</span> <span class="k">align</span> <span class="m">16</span>
  <span class="nv nv-Anonymous">%11</span> <span class="p">=</span> <span class="k">extractelement</span> <span class="p">&lt;</span><span class="m">4</span> <span class="k">x</span> <span class="k">i32</span><span class="p">&gt;</span> <span class="nv nv-Anonymous">%10</span><span class="p">,</span> <span class="k">i32</span> <span class="m">2</span>
  <span class="nv nv-Anonymous">%12</span> <span class="p">=</span> <span class="k">add</span> <span class="k">nsw</span> <span class="k">i32</span> <span class="nv nv-Anonymous">%9</span><span class="p">,</span> <span class="nv nv-Anonymous">%11</span>
  <span class="nv nv-Anonymous">%13</span> <span class="p">=</span> <span class="k">load</span> <span class="k">volatile</span> <span class="p">&lt;</span><span class="m">4</span> <span class="k">x</span> <span class="k">i32</span><span class="p">&gt;,</span> <span class="p">&lt;</span><span class="m">4</span> <span class="k">x</span> <span class="k">i32</span><span class="p">&gt;*</span> <span class="nv">%c0</span><span class="p">,</span> <span class="k">align</span> <span class="m">16</span>
  <span class="nv nv-Anonymous">%14</span> <span class="p">=</span> <span class="k">extractelement</span> <span class="p">&lt;</span><span class="m">4</span> <span class="k">x</span> <span class="k">i32</span><span class="p">&gt;</span> <span class="nv nv-Anonymous">%13</span><span class="p">,</span> <span class="k">i32</span> <span class="m">3</span>
  <span class="nv nv-Anonymous">%15</span> <span class="p">=</span> <span class="k">add</span> <span class="k">nsw</span> <span class="k">i32</span> <span class="nv nv-Anonymous">%12</span><span class="p">,</span> <span class="nv nv-Anonymous">%14</span>
  <span class="k">ret</span> <span class="k">i32</span> <span class="nv nv-Anonymous">%15</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">118-165-79-206:input Jonathan$</span> ~/llvm/test/cmake_debug_build/Debug/bin/llc
<span class="go">  -march=cpu0 -mcpu=cpu032II -relocation-model=pic -filetype=asm ch7_1_vector.bc</span>
<span class="go">  -o -</span>
<span class="go">  .text</span>
<span class="go">  .section .mdebug.abiO32</span>
<span class="go">  .previous</span>
<span class="go">  .file &quot;ch7_1_vector.bc&quot;</span>
<span class="go">  .globl  _Z16test_cmplt_shortv</span>
<span class="go">  .p2align  2</span>
<span class="go">  .type _Z16test_cmplt_shortv,@function</span>
<span class="go">  .ent  _Z16test_cmplt_shortv   # @_Z16test_cmplt_shortv</span>
<span class="go">_Z16test_cmplt_shortv:</span>
<span class="go">  .frame  $fp,48,$lr</span>
<span class="go">  .mask   0x00000000,0</span>
<span class="go">  .set  noreorder</span>
<span class="go">  .set  nomacro</span>
<span class="gp">#</span> BB#0:
<span class="go">  addiu $sp, $sp, -48</span>
<span class="go">  addiu $2, $zero, 3</span>
<span class="go">  st  $2, 44($sp)</span>
<span class="go">  addiu $2, $zero, 1</span>
<span class="go">  st  $2, 36($sp)</span>
<span class="go">  addiu $2, $zero, 0</span>
<span class="go">  st  $2, 32($sp)</span>
<span class="go">  addiu $2, $zero, 2</span>
<span class="go">  st  $2, 40($sp)</span>
<span class="go">  st  $2, 28($sp)</span>
<span class="go">  st  $2, 24($sp)</span>
<span class="go">  st  $2, 20($sp)</span>
<span class="go">  st  $2, 16($sp)</span>
<span class="go">  ld  $2, 32($sp)</span>
<span class="go">  ld  $3, 44($sp)</span>
<span class="go">  ld  $4, 40($sp)</span>
<span class="go">  ld  $5, 36($sp)</span>
<span class="go">  ld  $t9, 20($sp)</span>
<span class="go">  slt $5, $5, $t9</span>
<span class="go">  ld  $t9, 24($sp)</span>
<span class="go">  slt $4, $4, $t9</span>
<span class="go">  ld  $t9, 28($sp)</span>
<span class="go">  slt $3, $3, $t9</span>
<span class="go">  shl $3, $3, 31</span>
<span class="go">  sra $3, $3, 31</span>
<span class="go">  ld  $t9, 16($sp)</span>
<span class="go">  st  $3, 12($sp)</span>
<span class="go">  shl $3, $4, 31</span>
<span class="go">  sra $3, $3, 31</span>
<span class="go">  st  $3, 8($sp)</span>
<span class="go">  shl $3, $5, 31</span>
<span class="go">  sra $3, $3, 31</span>
<span class="go">  st  $3, 4($sp)</span>
<span class="go">  slt $2, $2, $t9</span>
<span class="go">  shl $2, $2, 31</span>
<span class="go">  sra $2, $2, 31</span>
<span class="go">  st  $2, 0($sp)</span>
<span class="go">  ld  $2, 12($sp)</span>
<span class="go">  ld  $2, 8($sp)</span>
<span class="go">  ld  $2, 4($sp)</span>
<span class="go">  ld  $2, 0($sp)</span>
<span class="go">  ld  $3, 4($sp)</span>
<span class="go">  addu  $2, $2, $3</span>
<span class="go">  ld  $3, 12($sp)</span>
<span class="go">  ld  $3, 8($sp)</span>
<span class="go">  ld  $3, 0($sp)</span>
<span class="go">  ld  $3, 8($sp)</span>
<span class="go">  addu  $2, $2, $3</span>
<span class="go">  ld  $3, 12($sp)</span>
<span class="go">  ld  $3, 4($sp)</span>
<span class="go">  ld  $3, 0($sp)</span>
<span class="go">  ld  $3, 12($sp)</span>
<span class="go">  addu  $2, $2, $3</span>
<span class="go">  ld  $3, 8($sp)</span>
<span class="go">  ld  $3, 4($sp)</span>
<span class="go">  ld  $3, 0($sp)</span>
<span class="go">  addiu $sp, $sp, 48</span>
<span class="go">  ret $lr</span>
<span class="go">  .set  macro</span>
<span class="go">  .set  reorder</span>
<span class="go">  .end  _Z16test_cmplt_shortv</span>
<span class="gp">$</span>func_end0:
<span class="go">  .size _Z16test_cmplt_shortv, ($func_end0)-_Z16test_cmplt_shortv</span>


<span class="go">  .ident  &quot;Apple LLVM version 7.0.0 (clang-700.1.76)&quot;</span>
<span class="go">  .section  &quot;.note.GNU-stack&quot;,&quot;&quot;,@progbits</span>
</pre></div>
</div>
<p>Since test_longlong_shift2() of ch7_1_vector.cpp needs implementation
storeRegToStack() of Cpu0SEInstInfo.cpp, at this point it cannot be verified.</p>
<p class="rubric">lbdex/chapters/Chapter7_1/Cpu0ISelLowering.h</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>    <span class="o">///</span> <span class="n">getSetCCResultType</span> <span class="o">-</span> <span class="n">get</span> <span class="n">the</span> <span class="n">ISD</span><span class="p">::</span><span class="n">SETCC</span> <span class="n">result</span> <span class="n">ValueType</span>
    <span class="n">EVT</span> <span class="n">getSetCCResultType</span><span class="p">(</span><span class="n">const</span> <span class="n">DataLayout</span> <span class="o">&amp;</span><span class="n">DL</span><span class="p">,</span> <span class="n">LLVMContext</span> <span class="o">&amp;</span><span class="n">Context</span><span class="p">,</span>
                           <span class="n">EVT</span> <span class="n">VT</span><span class="p">)</span> <span class="n">const</span> <span class="n">override</span><span class="p">;</span>
</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter7_1/Cpu0ISelLowering.cpp</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>EVT Cpu0TargetLowering::getSetCCResultType(const DataLayout &amp;, LLVMContext &amp;,
                                           EVT VT) const {
  if (!VT.isVector())
    return MVT::i32;
  return VT.changeVectorElementTypeToInteger();
}
</pre></div>
</div>
<table class="docutils footnote" frame="void" id="id4" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id2">[1]</a></td><td><a class="reference external" href="http://llvm.org/docs/LangRef.html#getelementptr-instruction">http://llvm.org/docs/LangRef.html#getelementptr-instruction</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="lbt-compiler-rt" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id1">[2]</a></td><td><a class="reference external" href="http://jonathan2251.github.io/lbt/lib.html#compiler-rt">http://jonathan2251.github.io/lbt/lib.html#compiler-rt</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="vector" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id3">[3]</a></td><td><a class="reference external" href="http://llvm.org/docs/LangRef.html#vector-type">http://llvm.org/docs/LangRef.html#vector-type</a></td></tr>
</tbody>
</table>
</div>
</div>


      </div>
      <div class="bottomnav" role="navigation" aria-label="bottom navigation">
      
        <p>
        «&#160;&#160;<a href="globalvar.html">Global variables</a>
        &#160;&#160;::&#160;&#160;
        <a class="uplink" href="index.html">Contents</a>
        &#160;&#160;::&#160;&#160;
        <a href="ctrlflow.html">Control flow statements</a>&#160;&#160;»
        </p>

      </div>

    <div class="footer" role="contentinfo">
        &copy; Copyright 2016, Chen Chung-Shu.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.4.4.
    </div>
  </body>
</html>